<!DOCTYPE html>
<html lang="es">
<head>
  <!--
    Resumen de cambios:
    - Refactorizaci√≥n integral para reforzar seguridad (sin innerHTML inseguro, validaci√≥n de URLs, claims de Firebase) y accesibilidad.
    - A√±adidas paginaciones, limpieza de listeners, consentimiento de analytics y cacheo de clima con backoff.
    - Documentados headers, reglas Firestore, App Check y restricciones de claves; UI ajustada con foco visible y toasts accesibles.

    Cabeceras HTTP recomendadas:
    Content-Security-Policy: default-src 'self'; script-src 'self' https://www.gstatic.com https://www.googleapis.com; style-src 'self' 'unsafe-inline'; font-src 'self'; img-src 'self' https: data:; frame-src https://www.google.com; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; require-trusted-types-for 'script'
    Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
    X-Frame-Options: DENY
    Referrer-Policy: strict-origin-when-cross-origin
    Permissions-Policy: microphone=(), geolocation=(), fullscreen=()

    Firestore Security Rules (ejemplo)
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        function isAdmin() { return request.auth != null && request.auth.token.role == 'admin'; }
        match /rese√±as/{id} {
          allow read: if true;
          allow create: if request.auth != null && request.resource.data.rating >=1 && request.resource.data.rating <=5
            && request.resource.data.titulo.size() <= 60 && request.resource.data.texto.size() <= 2000;
          allow update, delete: if request.auth != null && request.auth.uid == resource.data.usuario;
        }
        match /{col in ['lugares','restaurantes','ocio']}/{id} {
          allow read: if true;
          allow write: if isAdmin();
        }
      }
    }

    Notas de despliegue:
    - Habilita Firebase App Check (reCAPTCHA v3 o DeviceCheck) y exige tokens v√°lidos para Auth, Firestore y Storage.
    - Restringe las API keys de mapas/clima por dominio, rutas y cuota. No publiques valores reales en el cliente.
    - Configura CORS del bucket de Storage al dominio oficial de la gu√≠a.
    - Gestiona la asignaci√≥n de custom claims admin mediante Cloud Functions o CLI.
  -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Turismo San Mart√≠n de la Vega</title>
  <style>
    :root {
      color-scheme: light;
      --color-fondo: #ffffff;
      --color-superficie: #f5f7fb;
      --color-primario: #0b3d91;
      --color-primario-oscuro: #072c68;
      --color-secundario: #4caf50;
      --color-texto: #17202a;
      --color-texto-suave: #4a5568;
      --color-borde: rgba(11, 61, 145, 0.12);
      --color-alerta: #d32f2f;
      --color-aviso: #ffc107;
      --sombra: 0 10px 28px rgba(11, 61, 145, 0.1);
      --radio: 18px;
      --transicion: 0.24s ease;
      --max-ancho: 1100px;
      --fuente-base: "Segoe UI", "Helvetica Neue", Arial, system-ui, sans-serif;
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body.reducir-animaciones *,
    body.reducir-animaciones *::before,
    body.reducir-animaciones *::after {
      transition-duration: 0.01ms !important;
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
    }

    body {
      margin: 0;
      font-family: var(--fuente-base);
      background: var(--color-fondo);
      color: var(--color-texto);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    body.menu-abierto {
      overflow: hidden;
    }

    body.fuente-dyslexia {
      font-family: 'OpenDyslexic', var(--fuente-base);
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    img {
      max-width: 100%;
      display: block;
    }

    button,
    input,
    select,
    textarea {
      font: inherit;
    }

    button:not(:disabled) {
      cursor: pointer;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--color-primario);
      color: #fff;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 8px 18px rgba(7, 44, 104, 0.35);
      flex-wrap: wrap;
    }

    header img {
      width: 42px;
      height: 42px;
      object-fit: contain;
      flex: 0 0 auto;
    }

    .menu-toggle {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      border: none;
      background: rgba(255, 255, 255, 0.18);
      color: inherit;
      display: grid;
      place-items: center;
      font-size: 1.5rem;
      transition: background var(--transicion);
    }

    .menu-toggle:focus-visible,
    .menu-toggle:hover {
      outline: none;
      background: rgba(255, 255, 255, 0.28);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      flex: 1 1 auto;
      min-height: 0;
    }

    nav {
      position: fixed;
      inset: 0 auto 0 -300px;
      width: 280px;
      background: linear-gradient(180deg, var(--color-primario) 0%, var(--color-primario-oscuro) 100%);
      box-shadow: 12px 0 32px rgba(7, 44, 104, 0.2);
      padding: 1.5rem 1.25rem 4rem;
      overflow-y: auto;
      transition: transform var(--transicion);
      z-index: 120;
    }

    nav:focus {
      outline: 3px solid rgba(255, 255, 255, 0.45);
      outline-offset: -4px;
    }

    nav.abierto {
      transform: translateX(300px);
    }

    .overlay-menu {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transicion);
      z-index: 110;
    }

    .overlay-menu.visible {
      opacity: 1;
      visibility: visible;
    }

    .nav-links {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.75rem;
    }

    .nav-links button {
      width: 100%;
      border-radius: 14px;
      padding: 0.85rem 1rem;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.1);
      color: #f3f6ff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background var(--transicion), border-color var(--transicion), transform var(--transicion);
    }

    .nav-links button:hover,
    .nav-links button:focus-visible,
    .nav-links button.activo {
      outline: none;
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.55);
      transform: translateX(2px);
    }

    .sub-lista {
      list-style: none;
      margin: 0;
      padding: 0 0 0 1.5rem;
      display: none;
      gap: 0.4rem;
    }

    .sub-lista.visible {
      display: grid;
    }

    main {
      width: min(100%, var(--max-ancho));
      margin: 0 auto;
      padding: 1.5rem 1rem 4rem;
      display: grid;
      gap: 2rem;
    }

    .seccion {
      background: var(--color-superficie);
      border-radius: var(--radio);
      padding: 1.5rem;
      box-shadow: var(--sombra);
    }

    .seccion h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      font-size: 1.6rem;
    }

    .panel-hero {
      background: linear-gradient(135deg, rgba(11, 61, 145, 0.95), rgba(76, 175, 80, 0.85));
      color: #fff;
      border-radius: var(--radio);
      padding: 1.5rem;
      box-shadow: var(--sombra);
      display: grid;
      gap: 1rem;
    }

    .panel-hero .acciones {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      border-radius: 14px;
      padding: 0.65rem 1.35rem;
      border: 2px solid transparent;
      font-weight: 600;
      transition: transform var(--transicion), box-shadow var(--transicion), background var(--transicion);
    }

    .btn:focus-visible {
      outline: 3px solid rgba(255, 255, 255, 0.7);
      outline-offset: 2px;
    }

    .btn-primario {
      background: var(--color-secundario);
      color: #fff;
      box-shadow: 0 12px 24px rgba(76, 175, 80, 0.25);
    }

    .btn-secundario {
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.45);
    }

    .btn-ghost {
      background: transparent;
      border-color: var(--color-borde);
      color: var(--color-primario);
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .chip {
      border-radius: 999px;
      padding: 0.4rem 0.85rem;
      border: 1px solid var(--color-borde);
      background: #fff;
      color: var(--color-texto);
      transition: background var(--transicion), border-color var(--transicion);
    }

    .chip:hover,
    .chip:focus-visible,
    .chip.activo {
      background: rgba(11, 61, 145, 0.1);
      border-color: var(--color-primario);
      outline: none;
    }

    .tarjetas {
      display: grid;
      gap: 1.5rem;
    }

    .tarjeta {
      display: grid;
      gap: 1rem;
      background: #fff;
      border-radius: var(--radio);
      padding: 1rem;
      border: 1px solid var(--color-borde);
      box-shadow: 0 8px 18px rgba(11, 61, 145, 0.08);
    }

    .tarjeta img {
      width: 100%;
      height: 220px;
      object-fit: cover;
      border-radius: 14px;
      background: #e5e9f5;
    }

    .tarjeta .etiquetas {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .tarjeta .etiqueta {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      background: rgba(11, 61, 145, 0.12);
      color: var(--color-primario);
      font-size: 0.75rem;
    }

    .tarjeta .acciones {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .paginacion {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .paginacion button {
      min-width: 110px;
    }

    .lista-vacia {
      margin: 1rem 0 0;
      color: var(--color-texto-suave);
    }

    .widget-clima,
    .widget-mapa {
      display: grid;
      gap: 0.75rem;
    }

    .widget-mapa iframe {
      width: 100%;
      min-height: 320px;
      border: 0;
      border-radius: var(--radio);
    }

    .rese√±as {
      display: grid;
      gap: 1.25rem;
    }

    .rese√±a {
      border-radius: 16px;
      background: #fff;
      padding: 1rem;
      border: 1px solid var(--color-borde);
      box-shadow: 0 8px 18px rgba(11, 61, 145, 0.08);
      display: grid;
      gap: 0.5rem;
    }

    .rese√±a strong {
      font-size: 1.05rem;
    }

    .rating {
      color: #ffb400;
      font-size: 1.1rem;
    }

    .formulario {
      display: grid;
      gap: 0.75rem;
    }

    .formulario label {
      font-weight: 600;
    }

    .formulario input,
    .formulario textarea,
    .formulario select {
      border-radius: 12px;
      border: 1px solid var(--color-borde);
      background: #fff;
      padding: 0.65rem 0.85rem;
    }

    .mensaje-error {
      color: var(--color-alerta);
      font-size: 0.9rem;
    }

    .toast {
      position: fixed;
      inset: auto 1rem 1rem 1rem;
      background: rgba(7, 44, 104, 0.95);
      color: #fff;
      padding: 0.85rem 1.2rem;
      border-radius: 12px;
      box-shadow: 0 12px 24px rgba(11, 61, 145, 0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transicion), transform var(--transicion);
      transform: translateY(12px);
      z-index: 200;
    }

    .toast.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      opacity: 0;
      transition: opacity var(--transicion);
      z-index: 250;
    }

    .modal.visible {
      display: flex;
      opacity: 1;
    }

    .modal-dialogo {
      background: var(--color-fondo);
      color: var(--color-texto);
      border-radius: 22px;
      width: min(540px, 100%);
      padding: 1.75rem;
      display: grid;
      gap: 1rem;
      position: relative;
      box-shadow: 0 24px 48px rgba(11, 61, 145, 0.25);
    }

    .modal-cerrar {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      font-size: 1.5rem;
    }

    .consent-banner {
      position: fixed;
      inset: auto 0 0 0;
      background: #fff;
      border-top: 1px solid var(--color-borde);
      box-shadow: 0 -8px 18px rgba(0, 0, 0, 0.12);
      padding: 1.25rem;
      display: none;
      gap: 1rem;
      z-index: 260;
    }

    .consent-banner.visible {
      display: grid;
    }

    .calendario {
      display: grid;
      gap: 1rem;
    }

    .calendario-controles {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .calendario-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }

    .dia-calendario {
      background: rgba(11, 61, 145, 0.06);
      border-radius: 12px;
      min-height: 82px;
      padding: 0.35rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      font-size: 0.85rem;
    }

    .dia-calendario.evento {
      background: rgba(76, 175, 80, 0.2);
    }

    .dia-calendario.evento[data-tipo="no_laborable"] {
      background: rgba(244, 67, 54, 0.3);
      color: #fff;
    }

    .dia-calendario.evento[data-tipo="no_lectivo"] {
      background: rgba(255, 193, 7, 0.35);
    }

    .ajustes-permisos {
      display: grid;
      gap: 1rem;
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    footer {
      margin-top: auto;
      background: var(--color-primario-oscuro);
      color: #fff;
      padding: 1.5rem 1rem;
      text-align: center;
    }

    .header-texto {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      min-width: 220px;
    }

    .acciones-header {
      margin-left: auto;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    body.alto-contraste {
      --color-fondo: #000000;
      --color-superficie: #0f172a;
      --color-primario: #111827;
      --color-primario-oscuro: #0b1120;
      --color-secundario: #22c55e;
      --color-texto: #f9fafb;
      --color-texto-suave: #d1d5db;
      --color-borde: rgba(255, 255, 255, 0.4);
      background: var(--color-fondo);
      color: var(--color-texto);
    }

    body.texto-grande {
      font-size: 1.1rem;
    }

    body.espaciado-amplio {
      line-height: 1.7;
      letter-spacing: 0.015em;
    }

    body.links-subrayados a {
      text-decoration: underline;
      text-decoration-thickness: 0.15em;
    }

    body.modo-oscuro {
      --color-fondo: #0e1526;
      --color-superficie: #17213a;
      --color-primario: #1d4ed8;
      --color-primario-oscuro: #1e3a8a;
      --color-secundario: #22d3ee;
      --color-texto: #f8fafc;
      --color-texto-suave: #cbd5f5;
      --color-borde: rgba(255, 255, 255, 0.2);
    }

    .panel-accesibilidad {
      display: grid;
      gap: 1rem;
    }

    .panel-accesibilidad .grupo-opcion {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .panel-login-inicio {
      display: grid;
      gap: 0.75rem;
    }

    .panel-login-inicio .botonera {
      display: grid;
      gap: 0.5rem;
    }

    .panel-login-inicio .botonera button {
      justify-content: flex-start;
    }

    .panel-login-inicio small {
      color: var(--color-texto-suave);
    }

    .btn-icono {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-icono img {
      width: 20px;
      height: 20px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @media (max-width: 960px) {
      nav {
        inset: 0 auto 0 -100%;
        width: min(100%, 320px);
      }

      nav.abierto {
        transform: translateX(100%);
      }
    }

    @media (max-width: 640px) {
      header {
        gap: 0.75rem;
      }

      .header-texto h1 {
        font-size: 1.2rem;
      }

      .header-texto p {
        font-size: 0.85rem;
      }

      .acciones-header {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <header aria-label="Barra superior de navegaci√≥n">
    <button class="menu-toggle" aria-expanded="false" aria-controls="menuLateral" id="btnToggleMenu">‚ò∞</button>
    <img src="assets/lugar-iglesia.svg" alt="Escudo estilizado de San Mart√≠n de la Vega" width="42" height="42" loading="lazy">
    <div class="header-texto">
      <h1 style="margin:0;font-size:1.4rem;">Turismo San Mart√≠n de la Vega</h1>
      <p style="margin:0;font-size:0.9rem;opacity:0.85;">Descubre cultura, gastronom√≠a y naturaleza</p>
    </div>
    <div class="acciones-header">
      <button class="btn btn-ghost" id="btnLogin" type="button">Iniciar sesi√≥n</button>
      <button class="btn btn-ghost" id="btnLogout" type="button" hidden>Cerrar sesi√≥n</button>
    </div>
  </header>

  <div class="overlay-menu" id="overlayMenu" role="presentation"></div>

  <div class="layout">
    <nav id="menuLateral" aria-label="Men√∫ principal" tabindex="-1" aria-hidden="true">
      <ul class="nav-links" id="listaMenu">
        <li><button type="button" data-seccion="inicio" class="activo" aria-controls="seccionInicio" aria-expanded="true">üè† Inicio</button></li>
        <li>
          <button type="button" data-seccion="lugares" aria-controls="seccionLugares" aria-expanded="false">üìç Lugares</button>
          <ul class="sub-lista" data-parent="lugares">
            <li><button type="button" data-tag="todos">Todos</button></li>
            <li><button type="button" data-tag="naturaleza">Naturaleza</button></li>
            <li><button type="button" data-tag="cultural">Patrimonio</button></li>
            <li><button type="button" data-tag="familia">Plan familiar</button></li>
          </ul>
        </li>
        <li>
          <button type="button" data-seccion="restaurantes" aria-controls="seccionRestaurantes" aria-expanded="false">üçΩÔ∏è Gastronom√≠a</button>
          <ul class="sub-lista" data-parent="restaurantes">
            <li><button type="button" data-tag="todos">Todos</button></li>
            <li><button type="button" data-tag="tradicional">Tradicional</button></li>
            <li><button type="button" data-tag="tapas">Tapas y ocio</button></li>
          </ul>
        </li>
        <li>
          <button type="button" data-seccion="ocio" aria-controls="seccionOcio" aria-expanded="false">üö¥ Ocio activo</button>
          <ul class="sub-lista" data-parent="ocio">
            <li><button type="button" data-tag="todos">Todos</button></li>
            <li><button type="button" data-tag="aventura">Aventura</button></li>
            <li><button type="button" data-tag="agua">Acu√°tico</button></li>
          </ul>
        </li>
        <li><button type="button" data-seccion="historia" aria-controls="seccionHistoria" aria-expanded="false">üìú Historia</button></li>
        <li><button type="button" data-seccion="eventos" aria-controls="seccionEventos" aria-expanded="false">üóìÔ∏è Eventos</button></li>
        <li><button type="button" data-seccion="rese√±as" aria-controls="seccionResenas" aria-expanded="false">‚≠ê Rese√±as</button></li>
        <li><button type="button" data-seccion="mapa" aria-controls="seccionMapa" aria-expanded="false">üó∫Ô∏è Mapa</button></li>
        <li><button type="button" data-seccion="clima" aria-controls="seccionClima" aria-expanded="false">‚òÄÔ∏è Clima</button></li>
        <li><button type="button" data-seccion="ajustes" aria-controls="seccionAjustes" aria-expanded="false">‚öôÔ∏è Ajustes</button></li>
        <li><button type="button" data-seccion="admin" aria-controls="seccionAdmin" aria-expanded="false" id="btnMenuAdmin" hidden>üõ†Ô∏è Administraci√≥n</button></li>
      </ul>
    </nav>

    <main id="contenidoPrincipal">
      <section id="seccionInicio" class="panel-hero" data-seccion="inicio">
        <h2>Planifica tu visita de forma segura</h2>
        <p>Explora rutas naturales, reserva actividades y comparte rese√±as verificadas. La informaci√≥n se actualiza desde nuestro equipo municipal y colaboradores locales.</p>
        <div class="acciones">
          <button type="button" class="btn btn-primario" data-ir="seccionLugares">Ver lugares destacados</button>
          <button type="button" class="btn btn-secundario" data-ir="seccionEventos">Calendario cultural</button>
        </div>
      </section>

      <section id="seccionLugares" class="seccion" data-seccion="lugares" hidden>
        <header>
          <h2>Lugares imprescindibles</h2>
          <p>Selecciona un filtro para acotar los resultados. Se muestran 20 elementos por p√°gina.</p>
        </header>
        <div class="chips" role="listbox" aria-label="Filtrar lugares" id="chipsLugares"></div>
        <div class="tarjetas" id="listaLugares" aria-live="polite"></div>
        <div class="paginacion">
          <button type="button" class="btn btn-ghost" data-prev="lugares">Anterior</button>
          <span id="estadoLugares" aria-live="polite"></span>
          <button type="button" class="btn btn-ghost" data-next="lugares">Siguiente</button>
        </div>
      </section>

      <section id="seccionRestaurantes" class="seccion" data-seccion="restaurantes" hidden>
        <header>
          <h2>D√≥nde comer</h2>
          <p>Encuentra propuestas gastron√≥micas seg√∫n tu estilo.</p>
        </header>
        <div class="chips" role="listbox" aria-label="Filtrar restaurantes" id="chipsRestaurantes"></div>
        <div class="tarjetas" id="listaRestaurantes" aria-live="polite"></div>
        <div class="paginacion">
          <button type="button" class="btn btn-ghost" data-prev="restaurantes">Anterior</button>
          <span id="estadoRestaurantes" aria-live="polite"></span>
          <button type="button" class="btn btn-ghost" data-next="restaurantes">Siguiente</button>
        </div>
      </section>

      <section id="seccionOcio" class="seccion" data-seccion="ocio" hidden>
        <header>
          <h2>Ocio y naturaleza</h2>
          <p>Actividades deportivas y planes en la vega del Jarama.</p>
        </header>
        <div class="chips" role="listbox" aria-label="Filtrar ocio" id="chipsOcio"></div>
        <div class="tarjetas" id="listaOcio" aria-live="polite"></div>
        <div class="paginacion">
          <button type="button" class="btn btn-ghost" data-prev="ocio">Anterior</button>
          <span id="estadoOcio" aria-live="polite"></span>
          <button type="button" class="btn btn-ghost" data-next="ocio">Siguiente</button>
        </div>
      </section>

      <section id="seccionHistoria" class="seccion" data-seccion="historia" hidden>
        <h2>Historia local</h2>
        <div class="tarjetas" id="listaHistoria" aria-live="polite"></div>
      </section>

      <section id="seccionEventos" class="seccion" data-seccion="eventos" hidden>
        <h2>Calendario municipal</h2>
        <div class="calendario" aria-live="polite">
          <div class="calendario-controles">
            <label for="selectMes">Mes</label>
            <select id="selectMes" aria-label="Seleccionar mes"></select>
            <label for="selectAnio">A√±o</label>
            <select id="selectAnio" aria-label="Seleccionar a√±o"></select>
          </div>
          <div class="calendario-grid" id="gridCalendario"></div>
          <div id="detalleEventos" aria-live="polite"></div>
        </div>
      </section>

      <section id="seccionResenas" class="seccion" data-seccion="rese√±as" hidden>
        <h2>Rese√±as verificadas</h2>
        <form class="formulario" id="formResena">
          <div>
            <label for="inputTitulo">T√≠tulo</label>
            <input id="inputTitulo" name="titulo" maxlength="60" required aria-describedby="ayudaTitulo">
            <p id="ayudaTitulo" class="mensaje-error" hidden>El t√≠tulo es obligatorio (1-60 caracteres).</p>
          </div>
          <div>
            <label for="inputTexto">Tu experiencia</label>
            <textarea id="inputTexto" name="texto" maxlength="2000" required aria-describedby="ayudaTexto"></textarea>
            <p id="ayudaTexto" class="mensaje-error" hidden>Describe la experiencia (1-2000 caracteres).</p>
          </div>
          <div>
            <label for="inputRating">Valoraci√≥n</label>
            <select id="inputRating" name="rating" required>
              <option value="5">5 - Excelente</option>
              <option value="4">4 - Muy buena</option>
              <option value="3">3 - Correcta</option>
              <option value="2">2 - Mejorable</option>
              <option value="1">1 - No recomendable</option>
            </select>
            <p class="mensaje-error" id="ayudaRating" hidden>Selecciona una puntuaci√≥n entre 1 y 5.</p>
          </div>
          <button type="submit" class="btn btn-primario">Enviar rese√±a</button>
        </form>
        <div class="rese√±as" id="listaResenas" aria-live="polite"></div>
        <div class="paginacion">
          <button type="button" class="btn btn-ghost" data-prev="rese√±as">Anterior</button>
          <span id="estadoResenas" aria-live="polite"></span>
          <button type="button" class="btn btn-ghost" data-next="rese√±as">Siguiente</button>
        </div>
      </section>

      <section id="seccionMapa" class="seccion" data-seccion="mapa" hidden>
        <h2>Mapa y rutas</h2>
        <div class="widget-mapa">
          <p>Consulta la localizaci√≥n principal. Para rutas concretas habilita la capa en Google Maps.</p>
          <iframe id="iframeMapa" title="Mapa de San Mart√≠n de la Vega" loading="lazy" referrerpolicy="no-referrer" allowfullscreen
            src="https://www.google.com/maps?q=40.20732,-3.57013&output=embed"></iframe>
          <button type="button" class="btn btn-primario" id="btnDescargarGPX" hidden>Descargar ruta GPX</button>
        </div>
      </section>

      <section id="seccionClima" class="seccion" data-seccion="clima" hidden>
        <h2>Clima local</h2>
        <div class="widget-clima" id="widgetClima" aria-live="polite">
          <p>Consultando informaci√≥n meteorol√≥gica‚Ä¶</p>
        </div>
      </section>

      <section id="seccionAjustes" class="seccion" data-seccion="ajustes" hidden>
        <h2>Accesibilidad y cuenta</h2>
        <div class="ajustes-permisos">
          <div>
            <h3 style="margin-top:0;">Preferencias de accesibilidad</h3>
            <p>Configura la visualizaci√≥n seg√∫n tus necesidades. Los cambios se guardan solo en este dispositivo.</p>
            <div class="panel-accesibilidad">
              <div class="grupo-opcion">
                <label class="toggle"><input type="checkbox" id="toggleFuente" aria-describedby="ayudaFuente"> Fuente de alta legibilidad</label>
                <p id="ayudaFuente">Activa una tipograf√≠a dise√±ada para dislexia.</p>
              </div>
              <div class="grupo-opcion">
                <label class="toggle"><input type="checkbox" id="toggleReducir" aria-describedby="ayudaReducir"> Reducir animaciones</label>
                <p id="ayudaReducir">Minimiza transiciones y efectos para evitar distracciones.</p>
              </div>
              <div class="grupo-opcion">
                <label class="toggle"><input type="checkbox" id="toggleContraste" aria-describedby="ayudaContraste"> Alto contraste</label>
                <p id="ayudaContraste">Incrementa el contraste para mejorar la lectura.</p>
              </div>
              <div class="grupo-opcion">
                <label class="toggle"><input type="checkbox" id="toggleTexto" aria-describedby="ayudaTexto"> Texto ampliado</label>
                <p id="ayudaTexto">Aumenta el tama√±o base de la letra en toda la gu√≠a.</p>
              </div>
              <div class="grupo-opcion">
                <label class="toggle"><input type="checkbox" id="toggleEspaciado" aria-describedby="ayudaEspaciado"> Espaciado adicional</label>
                <p id="ayudaEspaciado">A√±ade m√°s espacio entre l√≠neas y caracteres.</p>
              </div>
              <div class="grupo-opcion">
                <label class="toggle"><input type="checkbox" id="toggleLinks" aria-describedby="ayudaLinks"> Subrayar enlaces</label>
                <p id="ayudaLinks">Resalta los enlaces con un subrayado visible.</p>
              </div>
            </div>
          </div>
          <div>
            <h3>Gesti√≥n de cuenta</h3>
            <p>Estas acciones requieren que hayas iniciado sesi√≥n. Nunca compartiremos tus credenciales.</p>
            <fieldset id="panelCuenta" style="border:none;padding:0;display:grid;gap:1rem;" disabled>
              <legend class="sr-only">Ajustes de la cuenta</legend>
              <form class="formulario" id="formPerfil">
                <label>
                  Nombre para mostrar
                  <input type="text" name="displayName" id="inputDisplayName" maxlength="60" autocomplete="name" placeholder="Ej. Daniel Terroba Alcala">
                </label>
                <button type="submit" class="btn btn-primario">Guardar nombre</button>
              </form>
              <form class="formulario" id="formPassword">
                <label>
                  Nueva contrase√±a
                  <input type="password" name="password" id="inputNuevaPassword" minlength="8" autocomplete="new-password" required>
                </label>
                <button type="submit" class="btn btn-ghost">Actualizar contrase√±a</button>
              </form>
              <div style="display:flex;flex-wrap:wrap;gap:0.5rem;">
                <button type="button" class="btn btn-ghost" id="btnVerificarCorreo">Enviar verificaci√≥n</button>
                <button type="button" class="btn btn-ghost" id="btnCerrarSesiones">Cerrar otras sesiones</button>
                <button type="button" class="btn btn-ghost" id="btnEliminarCuenta">Eliminar cuenta</button>
              </div>
              <p id="estadoCuenta" class="mensaje-error" hidden></p>
            </fieldset>
          </div>
        </div>
      </section>

      <section id="seccionAdmin" class="seccion" data-seccion="admin" hidden>
        <h2>Panel administrativo</h2>
        <p>Disponible solo para cuentas con rol <code>admin</code> (custom claims).</p>
        <button type="button" class="btn btn-primario" id="btnAbrirModalAdmin">Crear contenido</button>
        <ul id="listaAdmin" style="margin:1rem 0 0;padding:0;list-style:none;display:grid;gap:0.75rem;"></ul>
        <div style="margin-top:1.5rem;display:grid;gap:0.75rem;">
          <h3 style="margin:0;">Moderaci√≥n y seguridad</h3>
          <form id="formBan" class="formulario" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));align-items:end;gap:0.75rem;">
            <label style="flex:1;">
              IP a bloquear
              <input type="text" name="ip" id="inputBanIp" placeholder="Ej. 192.168.1.10" pattern="^(?:\d{1,3}\.){3}\d{1,3}$">
            </label>
            <button type="submit" class="btn btn-ghost">Bloquear IP</button>
          </form>
          <div>
            <p style="margin:0 0 0.5rem;">IPs bloqueadas (se aplican tambi√©n a invitados):</p>
            <ul id="listaBaneados" style="list-style:none;padding:0;display:grid;gap:0.5rem;"></ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <div class="modal" id="modalBienvenida" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalBienvenida">
      <button type="button" class="modal-cerrar" id="btnCerrarModalBienvenida" aria-label="Cerrar">√ó</button>
      <h3 id="tituloModalBienvenida">Configura tu experiencia</h3>
      <div class="panel-accesibilidad">
        <div class="grupo-opcion">
          <label class="toggle"><input type="checkbox" id="initContraste"> Alto contraste</label>
          <small>Mejora la visibilidad de los textos y botones.</small>
        </div>
        <div class="grupo-opcion">
          <label class="toggle"><input type="checkbox" id="initTexto"> Texto ampliado</label>
          <small>Aumenta el tama√±o base de la letra.</small>
        </div>
        <div class="grupo-opcion">
          <label class="toggle"><input type="checkbox" id="initEspaciado"> Espaciado adicional</label>
          <small>M√°s espacio entre l√≠neas para leer con calma.</small>
        </div>
        <div class="grupo-opcion">
          <label class="toggle"><input type="checkbox" id="initLinks"> Subrayar enlaces</label>
          <small>Resalta todos los enlaces disponibles.</small>
        </div>
      </div>
      <div class="panel-login-inicio">
        <h4 style="margin:0;">Elige c√≥mo quieres acceder</h4>
        <div class="botonera">
          <button type="button" class="btn btn-primario btn-icono" id="btnLoginCorreo">
            <span>üìß</span> Iniciar sesi√≥n con correo
          </button>
          <button type="button" class="btn btn-ghost btn-icono" id="btnLoginGoogle">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="">
            Continuar con Google
          </button>
          <button type="button" class="btn btn-ghost btn-icono" id="btnLoginFacebook" style="display:none;" aria-hidden="true">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/facebook.svg" alt="">
            Continuar con Facebook
          </button>
          <button type="button" class="btn btn-ghost" id="btnInvitado">Entrar como invitado</button>
        </div>
        <small>Puedes cerrar esta ventana si prefieres explorar como invitado.</small>
      </div>
    </div>
  </div>

  <div class="modal" id="modalLogin" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalLogin">
      <button type="button" class="modal-cerrar" id="btnCerrarModalLogin" aria-label="Cerrar">√ó</button>
      <h3 id="tituloModalLogin">Iniciar sesi√≥n</h3>
      <form class="formulario" id="formLogin" novalidate>
        <label>
          Correo electr√≥nico
          <input type="email" name="email" id="inputLoginEmail" autocomplete="username" required>
        </label>
        <label>
          Contrase√±a
          <input type="password" name="password" id="inputLoginPassword" autocomplete="current-password" required minlength="8">
        </label>
        <p class="mensaje-error" id="errorLogin" hidden></p>
        <button type="submit" class="btn btn-primario">Acceder</button>
      </form>
    </div>
  </div>

  <div class="modal" id="modalAdmin" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalAdmin">
      <button type="button" class="modal-cerrar" id="btnCerrarModalAdmin" aria-label="Cerrar">√ó</button>
      <h3 id="tituloModalAdmin">Nuevo contenido</h3>
      <form class="formulario" id="formAdmin">
        <label>
          Tipo de colecci√≥n
          <select name="coleccion" required>
            <option value="lugares">Lugares</option>
            <option value="restaurantes">Restaurantes</option>
            <option value="ocio">Ocio</option>
            <option value="eventos">Eventos</option>
          </select>
        </label>
        <label>
          Nombre
          <input name="nombre" maxlength="60" required>
        </label>
        <label>
          Descripci√≥n
          <textarea name="descripcion" maxlength="2000" required></textarea>
        </label>
        <label>
          Imagen (URL segura)
          <input name="imagen" type="url" placeholder="https://">
        </label>
        <label>
          O subir archivo
          <input name="archivoImagen" type="file" accept="image/*">
        </label>
        <label>
          Etiquetas separadas por coma (m√°x. 8 etiquetas, 20 caracteres c/u)
          <input name="etiquetas" maxlength="200">
        </label>
        <label>
          Enlace externo opcional
          <input name="enlace" type="url" placeholder="https://">
        </label>
      <button type="submit" class="btn btn-primario">Guardar</button>
    </form>
  </div>
</div>

  <div class="modal" id="modalBaneado" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalBaneado">
      <h3 id="tituloModalBaneado">Acceso restringido</h3>
      <p>Tu IP ha sido bloqueada por el equipo de moderaci√≥n. Si crees que se trata de un error escribe a turismo@sanmartindelavega.es con los detalles de tu visita.</p>
    </div>
  </div>

  <div class="consent-banner" id="bannerConsentimiento" role="region" aria-live="polite">
    <div>
      <strong>Consentimiento de cookies anal√≠ticas</strong>
      <p>Usamos Google Analytics para medir visitas de forma an√≥nima. Solo se activar√° si aceptas. Puedes cambiarlo en Ajustes.</p>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:0.5rem;">
      <button type="button" class="btn btn-primario" id="btnAceptarConsent">Aceptar</button>
      <button type="button" class="btn btn-ghost" id="btnRechazarConsent">Rechazar</button>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut,
      GoogleAuthProvider,
      FacebookAuthProvider,
      signInWithPopup,
      setPersistence,
      browserLocalPersistence,
      updateProfile,
      updatePassword,
      sendEmailVerification,
      EmailAuthProvider,
      reauthenticateWithCredential,
      deleteUser
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      limit,
      startAfter,
      where,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      serverTimestamp,
      doc
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyDigVtE9WexPsg0gOvjcsuYVO_FX-r__7o',
      authDomain: 'interfaces-4bc20.firebaseapp.com',
      projectId: 'interfaces-4bc20',
      storageBucket: 'interfaces-4bc20.firebasestorage.app',
      messagingSenderId: '1007775332703',
      appId: '1:1007775332703:web:1f6f6d7bb6a2d268a75eea',
      measurementId: 'G-G3BQBDN5M6'
    };

    const DATOS_LOCALES = {
      lugares: [
        {
          id: 'iglesia-natividad',
          nombre: 'Iglesia de la Natividad',
          descripcion: 'Templo mud√©jar del siglo XV con visitas guiadas gratuitas los fines de semana.',
          imagen: 'assets/lugar-iglesia-3.svg',
          etiquetas: ['cultural', 'familia'],
          enlace: 'https://turismo.sanmartindelavega.es/iglesia'
        },
        {
          id: 'mirador-maranosa',
          nombre: 'Mirador de la Mara√±osa',
          descripcion: 'Vistas panor√°micas del valle del Jarama y zona ornitol√≥gica se√±alizada.',
          imagen: 'assets/lugar-maranosa-3.svg',
          etiquetas: ['naturaleza', 'familia'],
          enlace: 'https://turismo.sanmartindelavega.es/maranosa'
        },
        {
          id: 'parque-warner',
          nombre: 'Parque Warner Madrid',
          descripcion: 'Atracciones tematizadas y espect√°culos inmersivos para toda la familia.',
          imagen: 'assets/lugar-warner-3.svg',
          etiquetas: ['familia', 'aventura'],
          enlace: 'https://www.parquewarner.com/'
        },
        {
          id: 'ruta-humedales',
          nombre: 'Ruta de los Humedales',
          descripcion: 'Itinerario circular se√±alizado para observar flora y fauna protegida.',
          imagen: 'assets/lugar-maranosa.svg',
          etiquetas: ['naturaleza'],
          enlace: 'https://turismo.sanmartindelavega.es/humedales'
        }
      ],
      restaurantes: [
        {
          id: 'el-lindero',
          nombre: 'Mes√≥n El Lindero',
          descripcion: 'Cocina tradicional con horno de le√±a y men√∫s de fin de semana.',
          imagen: 'assets/restaurante-lindero-3.svg',
          etiquetas: ['tradicional'],
          enlace: 'https://restaurantesanmartindelavega.es/lindero'
        },
        {
          id: 'zatara',
          nombre: 'Restaurante Z√°tara',
          descripcion: 'Propuestas creativas con productos locales y terraza ajardinada.',
          imagen: 'assets/restaurante-zatara-3.svg',
          etiquetas: ['tapas', 'tradicional'],
          enlace: 'https://restaurantesanmartindelavega.es/zatara'
        },
        {
          id: 'plaza-jarama',
          nombre: 'Plaza del Jarama',
          descripcion: 'Tapas contempor√°neas y carta vegana disponible bajo reserva.',
          imagen: 'assets/restaurante-lindero-2.svg',
          etiquetas: ['tapas'],
          enlace: 'https://turismo.sanmartindelavega.es/gastronomia'
        }
      ],
      ocio: [
        {
          id: 'circuito-jarama',
          nombre: 'Karting Circuito del Jarama',
          descripcion: 'Trazado homologado con tandas cronometradas y monitores profesionales.',
          imagen: 'assets/ocio-jarama-3.svg',
          etiquetas: ['aventura'],
          enlace: 'https://turismo.sanmartindelavega.es/karting'
        },
        {
          id: 'bunker-guerra',
          nombre: 'B√∫nker de la Guerra Civil',
          descripcion: 'Centro de interpretaci√≥n al aire libre con visitas teatralizadas.',
          imagen: 'assets/ocio-bunker-3.svg',
          etiquetas: ['cultural'],
          enlace: 'https://turismo.sanmartindelavega.es/bunker'
        },
        {
          id: 'piraguas-jarama',
          nombre: 'Piraguas en el Jarama',
          descripcion: 'Recorridos guiados por el r√≠o con seguros incluidos y material adaptado.',
          imagen: 'assets/ocio-jarama-2.svg',
          etiquetas: ['agua', 'familia'],
          enlace: 'https://turismo.sanmartindelavega.es/piraguas'
        }
      ],
      historia: [
        { id: 'hist-1574', anio: 1574, titulo: 'Otorgamiento del t√≠tulo de villa', descripcion: 'Felipe II concede a San Mart√≠n de la Vega el privilegio de villazgo con jurisdicci√≥n propia.' },
        { id: 'hist-1939', anio: 1939, titulo: 'Reconstrucci√≥n del casco urbano', descripcion: 'Tras la Guerra Civil se impulsa un plan de reconstrucci√≥n y mejora de servicios p√∫blicos.' },
        { id: 'hist-2002', anio: 2002, titulo: 'Inauguraci√≥n del Parque Warner', descripcion: 'Se abre el mayor parque tem√°tico de la Comunidad de Madrid, dinamizando la econom√≠a local.' }
      ],
      eventos: [
        { id: 'romeria', titulo: 'Romer√≠a de la Virgen', descripcion: 'Procesi√≥n hasta la ermita con actuaciones folcl√≥ricas.', fecha: { seconds: Math.floor(new Date().setMonth(new Date().getMonth(), 15) / 1000) }, tipo: 'fiesta_local' },
        { id: 'feria-gastronomia', titulo: 'Feria Gastron√≥mica', descripcion: 'Degustaciones de productores locales en la Plaza de la Constituci√≥n.', fecha: { seconds: Math.floor(new Date().setMonth(new Date().getMonth() + 1, 7) / 1000) }, tipo: 'gastronomia' },
        { id: 'carrera-noche', titulo: 'Carrera Nocturna Vega Night', descripcion: 'Recorrido popular de 5 km con inscripci√≥n solidaria.', fecha: { seconds: Math.floor(new Date().setMonth(new Date().getMonth() + 2, 21) / 1000) }, tipo: 'deporte' }
      ],
      rese√±as: [
        { id: 'rese-1', titulo: 'Visita obligada', texto: 'La iglesia mud√©jar es preciosa y las visitas guiadas son muy amenas.', rating: 5, creado: { seconds: Math.floor(Date.now() / 1000) - 86400 }, usuario: 'offline-visitante-1' },
        { id: 'rese-2', titulo: 'Ideal con peques', texto: 'Pasamos el d√≠a en el parque Warner y todo est√° muy bien organizado.', rating: 4, creado: { seconds: Math.floor(Date.now() / 1000) - 172800 }, usuario: 'offline-visitante-2' }
      ],
      clima: { temperatura: 24, descripcion: 'Cielo despejado sobre San Mart√≠n de la Vega' },
      configuracion: {
        gpx: 'https://turismo.sanmartindelavega.es/rutas/ruta-humedales.gpx',
        mapa: [40.20732, -3.57013]
      }
    };

    const USUARIOS_FALLBACK = {
      'danieltrigre7@gmail.com': {
        password: 'rafadani77',
        role: 'admin',
        displayName: 'Daniel Terroba Alcala'
      }
    };

    const escapeHTML = (s = '') => s.toString()
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');

    const isSafeHttpUrl = (u = '') => {
      try {
        const x = new URL(u, location.origin);
        return /^https?:$/.test(x.protocol);
      } catch {
        return false;
      }
    };

    const isSafeImageURL = (u = '') => {
      if (!u) return false;
      if (/^data:image\/(png|jpe?g|webp|svg\+xml);/i.test(u)) return true;
      try {
        const parsed = new URL(u, location.origin);
        if (!/^https?:$/.test(parsed.protocol) && parsed.origin !== location.origin) return false;
        return /\.(png|jpe?g|webp|svg)$/i.test(parsed.pathname);
      } catch {
        return /^assets\//.test(u) && /\.(png|jpe?g|webp|svg)$/i.test(u);
      }
    };

    const clampRating = (n) => Math.min(5, Math.max(1, Number.isFinite(+n) ? +n : 5));

    const safeLink = (a, href) => {
      if (!isSafeHttpUrl(href)) return false;
      a.href = href;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      return true;
    };

    const mostrarToast = (mensaje) => {
      toastEl.textContent = mensaje;
      toastEl.classList.add('visible');
      clearTimeout(mostrarToast.timer);
      mostrarToast.timer = setTimeout(() => {
        toastEl.classList.remove('visible');
      }, 4000);
    };

    const logError = (error, context = 'app') => {
      console.error(`[${context}]`, error);
      const code = String(error?.code || '').toLowerCase();
      const message = String(error?.message || '').toLowerCase();
      if (
        error?.name === 'AbortError' ||
        code.includes('permission-denied') ||
        code.includes('unauth') ||
        code.includes('unavailable') ||
        message.includes('missing or insufficient permissions')
      ) {
        return;
      }
      mostrarToast('Ha ocurrido un error. Int√©ntalo de nuevo.');
    };

    let app;
    let auth;
    let db;
    let storage;
    let analyticsInstance = null;
    let firebaseHabilitado = true;

    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      storage = getStorage(app);
      setPersistence(auth, browserLocalPersistence).catch(() => {
        /* Ignorar si el entorno no permite persistencia */
      });
    } catch (error) {
      firebaseHabilitado = false;
      console.warn('Firebase no disponible, usando modo local', error);
    }

    const googleProvider = firebaseHabilitado ? new GoogleAuthProvider() : null;
    const facebookProvider = firebaseHabilitado ? new FacebookAuthProvider() : null;
    if (googleProvider) googleProvider.setCustomParameters({ prompt: 'select_account' });
    if (facebookProvider) facebookProvider.setCustomParameters({ display: 'popup' });

    const toastEl = document.getElementById('toast');
    const overlayMenu = document.getElementById('overlayMenu');
    const menu = document.getElementById('menuLateral');
    const btnToggleMenu = document.getElementById('btnToggleMenu');
    const listaMenu = document.getElementById('listaMenu');
    const secciones = Array.from(document.querySelectorAll('[data-seccion]'));
    const bannerConsent = document.getElementById('bannerConsentimiento');
    const btnAceptarConsent = document.getElementById('btnAceptarConsent');
    const btnRechazarConsent = document.getElementById('btnRechazarConsent');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const btnMenuAdmin = document.getElementById('btnMenuAdmin');
    const btnDescargarGPX = document.getElementById('btnDescargarGPX');
    const iframeMapa = document.getElementById('iframeMapa');
    const widgetClima = document.getElementById('widgetClima');
    const selectMes = document.getElementById('selectMes');
    const selectAnio = document.getElementById('selectAnio');
    const gridCalendario = document.getElementById('gridCalendario');
    const detalleEventos = document.getElementById('detalleEventos');
    const formResena = document.getElementById('formResena');
    const listaResenas = document.getElementById('listaResenas');
    const estadoResenas = document.getElementById('estadoResenas');
    const modalAdmin = document.getElementById('modalAdmin');
    const btnAbrirModalAdmin = document.getElementById('btnAbrirModalAdmin');
    const btnCerrarModalAdmin = document.getElementById('btnCerrarModalAdmin');
    const formAdmin = document.getElementById('formAdmin');
    const listaAdmin = document.getElementById('listaAdmin');
    const modalBienvenida = document.getElementById('modalBienvenida');
    const btnCerrarModalBienvenida = document.getElementById('btnCerrarModalBienvenida');
    const btnLoginCorreo = document.getElementById('btnLoginCorreo');
    const btnLoginGoogle = document.getElementById('btnLoginGoogle');
    const btnLoginFacebook = document.getElementById('btnLoginFacebook');
    const btnInvitado = document.getElementById('btnInvitado');
    const initContraste = document.getElementById('initContraste');
    const initTexto = document.getElementById('initTexto');
    const initEspaciado = document.getElementById('initEspaciado');
    const initLinks = document.getElementById('initLinks');
    const panelCuenta = document.getElementById('panelCuenta');
    const formPerfil = document.getElementById('formPerfil');
    const formPassword = document.getElementById('formPassword');
    const btnVerificarCorreo = document.getElementById('btnVerificarCorreo');
    const btnCerrarSesiones = document.getElementById('btnCerrarSesiones');
    const btnEliminarCuenta = document.getElementById('btnEliminarCuenta');
    const estadoCuenta = document.getElementById('estadoCuenta');
    const toggleFuente = document.getElementById('toggleFuente');
    const toggleReducir = document.getElementById('toggleReducir');
    const toggleContraste = document.getElementById('toggleContraste');
    const toggleTexto = document.getElementById('toggleTexto');
    const toggleEspaciado = document.getElementById('toggleEspaciado');
    const toggleLinks = document.getElementById('toggleLinks');
    const formBan = document.getElementById('formBan');
    const listaBaneados = document.getElementById('listaBaneados');
    const inputBanIp = document.getElementById('inputBanIp');
    const modalBaneado = document.getElementById('modalBaneado');

    if (menu) menu.setAttribute('aria-hidden', 'true');
    if (overlayMenu) overlayMenu.setAttribute('aria-hidden', 'true');

    const chipsPorSeccion = {
      lugares: document.getElementById('chipsLugares'),
      restaurantes: document.getElementById('chipsRestaurantes'),
      ocio: document.getElementById('chipsOcio')
    };

    const listasPorSeccion = {
      lugares: document.getElementById('listaLugares'),
      restaurantes: document.getElementById('listaRestaurantes'),
      ocio: document.getElementById('listaOcio')
    };

    const estadoPorSeccion = {
      lugares: document.getElementById('estadoLugares'),
      restaurantes: document.getElementById('estadoRestaurantes'),
      ocio: document.getElementById('estadoOcio'),
      rese√±as: estadoResenas
    };

    const state = {
      user: null,
      claims: { role: 'visitante' },
      paginadores: {
        lugares: { tag: 'todos', pagina: 0, ultimo: null, hayMas: true, historial: [null] },
        restaurantes: { tag: 'todos', pagina: 0, ultimo: null, hayMas: true, historial: [null] },
        ocio: { tag: 'todos', pagina: 0, ultimo: null, hayMas: true, historial: [null] },
        rese√±as: { pagina: 0, ultimo: null, hayMas: true, historial: [null] }
      },
      rese√±as: [],
      consentimiento: localStorage.getItem('smv-consentimiento'),
      climaCache: JSON.parse(localStorage.getItem('smv-clima-cache') || 'null'),
      climaTimeout: null,
      eventos: [],
      gpxUrl: null,
      fuenteDatos: 'remoto',
      offlineAuth: false,
      baneados: new Set(JSON.parse(localStorage.getItem('smv-baneados') || '[]')),
      ip: null,
      firebaseDisponible: firebaseHabilitado,
      baneado: false
    };

    let firebaseModoLocalNotificado = false;

    const esErrorFirebaseCritico = (error) => {
      if (!error) return false;
      const code = String(error.code || '').toLowerCase();
      const message = String(error.message || '').toLowerCase();
      return (
        code.includes('permission-denied') ||
        code.includes('unauth') ||
        code.includes('unavailable') ||
        message.includes('missing or insufficient permissions')
      );
    };

    const forzarModoLocal = () => {
      if (!firebaseHabilitado) return;
      firebaseHabilitado = false;
      state.firebaseDisponible = false;
      state.fuenteDatos = 'local';
      db = null;
      storage = null;
      if (!firebaseModoLocalNotificado) {
        firebaseModoLocalNotificado = true;
        mostrarToast('Mostrando datos locales por falta de permisos en la base de datos.');
      }
    };

    const manejarErrorFirebase = (error, contexto) => {
      logError(error, contexto);
      if (esErrorFirebaseCritico(error)) {
        forzarModoLocal();
      }
    };

    const LIMITES = {
      pagina: 20,
      rese√±as: 10
    };

    const mesActual = new Date();

    document.body.dataset.baneado = 'false';

    const obtenerDatosLocales = (coleccion, tag = 'todos') => {
      const base = Array.isArray(DATOS_LOCALES[coleccion]) ? [...DATOS_LOCALES[coleccion]] : [];
      if (tag && tag !== 'todos') {
        return base
          .filter((item) => Array.isArray(item.etiquetas) && item.etiquetas.includes(tag))
          .sort((a, b) => a.nombre.localeCompare(b.nombre));
      }
      return base.sort((a, b) => a.nombre.localeCompare(b.nombre));
    };

    const toggleMenu = (mostrar, { skipFocus = false } = {}) => {
      if (!menu || !overlayMenu || !btnToggleMenu) return;
      const isOpen = mostrar ?? !menu.classList.contains('abierto');
      menu.classList.toggle('abierto', isOpen);
      overlayMenu.classList.toggle('visible', isOpen);
      document.body.classList.toggle('menu-abierto', isOpen);
      btnToggleMenu.setAttribute('aria-expanded', String(isOpen));
      menu.setAttribute('aria-hidden', String(!isOpen));
      overlayMenu.setAttribute('aria-hidden', String(!isOpen));
      if (isOpen) {
        menu.focus();
      } else if (!skipFocus) {
        btnToggleMenu.focus();
      }
    };

    if (btnToggleMenu) btnToggleMenu.addEventListener('click', () => toggleMenu());
    if (overlayMenu) overlayMenu.addEventListener('click', () => toggleMenu(false));

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && menu?.classList.contains('abierto')) {
        toggleMenu(false);
      }
    });

    window.addEventListener('resize', () => {
      if (window.innerWidth > 960 && menu?.classList.contains('abierto')) {
        toggleMenu(false, { skipFocus: true });
      }
    });

    const cambiarSeccion = (id) => {
      secciones.forEach((seccion) => {
        const visible = seccion.dataset.seccion === id;
        seccion.toggleAttribute('hidden', !visible);
      });
      document.querySelectorAll('.sub-lista').forEach((lista) => {
        lista.classList.toggle('visible', lista.dataset.parent === id);
      });
      listaMenu.querySelectorAll('button[data-seccion]').forEach((btn) => {
        const activo = btn.dataset.seccion === id;
        btn.classList.toggle('activo', activo);
        btn.setAttribute('aria-expanded', String(activo));
      });
      toggleMenu(false);
    };

    listaMenu.addEventListener('click', (event) => {
      const target = event.target.closest('button');
      if (!target) return;
      if (target.dataset.seccion) {
        event.preventDefault();
        cambiarSeccion(target.dataset.seccion);
      }
      if (target.dataset.tag) {
        aplicarFiltro(target.closest('.sub-lista').dataset.parent, target.dataset.tag);
      }
    });

    document.getElementById('contenidoPrincipal').addEventListener('click', (event) => {
      const ir = event.target.closest('[data-ir]');
      if (ir) {
        cambiarSeccion(ir.dataset.ir.replace('seccion', '').toLowerCase());
        const destino = document.getElementById(ir.dataset.ir);
        if (destino) destino.scrollIntoView({ behavior: 'smooth' });
      }
    });

    const construirChips = (coleccion, tagActual) => {
      const contenedor = chipsPorSeccion[coleccion];
      if (!contenedor) return;
      contenedor.textContent = '';
      const tags = ['todos'];
      switch (coleccion) {
        case 'lugares':
          tags.push('naturaleza', 'cultural', 'familia');
          break;
        case 'restaurantes':
          tags.push('tradicional', 'tapas');
          break;
        case 'ocio':
          tags.push('aventura', 'agua');
          break;
        default:
          break;
      }
      tags.forEach((tag) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `chip${tag === tagActual ? ' activo' : ''}`;
        btn.dataset.tag = tag;
        btn.textContent = tag === 'todos' ? 'Todos' : tag.charAt(0).toUpperCase() + tag.slice(1);
        btn.setAttribute('aria-pressed', tag === tagActual ? 'true' : 'false');
        contenedor.appendChild(btn);
      });
    };

    Object.entries(chipsPorSeccion).forEach(([coleccion, contenedor]) => {
      contenedor.addEventListener('click', (event) => {
        const btn = event.target.closest('button');
        if (!btn) return;
        aplicarFiltro(coleccion, btn.dataset.tag);
      });
    });

    ['lugares', 'restaurantes', 'ocio'].forEach((coleccion) => construirChips(coleccion, 'todos'));

    const aplicarFiltro = (coleccion, tag) => {
      const paginador = state.paginadores[coleccion];
      if (!paginador) return;
      paginador.tag = tag;
      paginador.pagina = 0;
      paginador.ultimo = null;
      paginador.hayMas = true;
      paginador.historial = [null];
      construirChips(coleccion, tag);
      cargarColeccion(coleccion, { reiniciar: true }).catch((error) => logError(error, 'filtro'));
    };

    const crearTarjeta = (item, coleccion) => {
      const tarjeta = document.createElement('article');
      tarjeta.className = 'tarjeta';
      tarjeta.dataset.id = item.id;
      tarjeta.dataset.coleccion = coleccion;

      const imagen = document.createElement('img');
      if (isSafeImageURL(item.imagen)) {
        imagen.src = item.imagen;
      } else {
        imagen.src = 'assets/placeholder.svg';
      }
      imagen.alt = `Imagen de ${item.nombre}`;
      imagen.loading = 'lazy';
      tarjeta.appendChild(imagen);

      const titulo = document.createElement('h3');
      titulo.textContent = item.nombre;
      tarjeta.appendChild(titulo);

      const descripcion = document.createElement('p');
      descripcion.textContent = item.descripcion;
      tarjeta.appendChild(descripcion);

      if (Array.isArray(item.etiquetas) && item.etiquetas.length) {
        const etiquetas = document.createElement('div');
        etiquetas.className = 'etiquetas';
        item.etiquetas.forEach((tag) => {
          const span = document.createElement('span');
          span.className = 'etiqueta';
          span.textContent = tag;
          etiquetas.appendChild(span);
        });
        tarjeta.appendChild(etiquetas);
      }

      if (item.enlace && isSafeHttpUrl(item.enlace)) {
        const acciones = document.createElement('div');
        acciones.className = 'acciones';
        const enlace = document.createElement('a');
        enlace.className = 'btn btn-ghost';
        enlace.textContent = 'Sitio oficial';
        if (safeLink(enlace, item.enlace)) {
          acciones.appendChild(enlace);
        }
        tarjeta.appendChild(acciones);
      }

      if (state.claims.role === 'admin') {
        const accionesAdmin = document.createElement('div');
        accionesAdmin.className = 'acciones';
        const btnEditar = document.createElement('button');
        btnEditar.type = 'button';
        btnEditar.className = 'btn btn-ghost';
        btnEditar.textContent = 'Editar';
        btnEditar.addEventListener('click', () => abrirModalAdmin(item, coleccion));
        const btnEliminar = document.createElement('button');
        btnEliminar.type = 'button';
        btnEliminar.className = 'btn btn-ghost';
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.addEventListener('click', () => eliminarDocumento(coleccion, item.id));
        accionesAdmin.append(btnEditar, btnEliminar);
        tarjeta.appendChild(accionesAdmin);
      }

      return tarjeta;
    };

    const renderLista = (coleccion, docs, pagina) => {
      const contenedor = listasPorSeccion[coleccion];
      if (!contenedor) return;
      contenedor.textContent = '';
      if (!docs.length) {
        const vacio = document.createElement('p');
        vacio.className = 'lista-vacia';
        vacio.textContent = 'No hay resultados para este filtro.';
        contenedor.appendChild(vacio);
      } else {
        docs.forEach((docItem) => contenedor.appendChild(crearTarjeta(docItem, coleccion)));
      }
      const estado = estadoPorSeccion[coleccion];
      if (estado) estado.textContent = `P√°gina ${pagina + 1}`;
    };

    const renderResenas = (items, pagina) => {
      listaResenas.textContent = '';
      if (!items.length) {
        const vacio = document.createElement('p');
        vacio.className = 'lista-vacia';
        vacio.textContent = 'S√© la primera persona en dejar una rese√±a.';
        listaResenas.appendChild(vacio);
      } else {
        items.forEach((resena) => {
          const item = document.createElement('article');
          item.className = 'rese√±a';
          item.dataset.id = resena.id;
          const titulo = document.createElement('strong');
          titulo.textContent = resena.titulo;
          item.appendChild(titulo);
          const rating = document.createElement('div');
          rating.className = 'rating';
          const r = clampRating(resena.rating);
          rating.textContent = '‚òÖ'.repeat(r);
          item.appendChild(rating);
          const texto = document.createElement('p');
          texto.textContent = resena.texto;
          item.appendChild(texto);
          const pie = document.createElement('small');
          const fecha = resena.creado?.seconds ? new Date(resena.creado.seconds * 1000) : new Date();
          pie.textContent = `Publicado el ${fecha.toLocaleDateString()}`;
          item.appendChild(pie);
          if (state.user && state.user.uid === resena.usuario) {
            const btnEliminar = document.createElement('button');
            btnEliminar.type = 'button';
            btnEliminar.className = 'btn btn-ghost';
            btnEliminar.textContent = 'Eliminar';
            btnEliminar.addEventListener('click', () => eliminarResena(resena.id));
            item.appendChild(btnEliminar);
          }
          listaResenas.appendChild(item);
        });
      }
      estadoResenas.textContent = `P√°gina ${pagina + 1}`;
    };

    const LIMITES_ETIQUETAS = { maxEtiquetas: 8, maxLongitud: 20 };

    const limpiarEtiquetas = (texto) => {
      if (!texto) return [];
      return texto.split(',').map((t) => t.trim()).filter((t) => t.length && t.length <= LIMITES_ETIQUETAS.maxLongitud).slice(0, LIMITES_ETIQUETAS.maxEtiquetas);
    };

    const cargarColeccion = async (coleccion, { reiniciar = false, siguiente = false, anterior = false } = {}) => {
      const paginador = state.paginadores[coleccion];
      if (!paginador) return;
      if (siguiente && !paginador.hayMas) return;

        if (!firebaseHabilitado || !db) {
          state.fuenteDatos = 'local';
          const docsLocales = obtenerDatosLocales(coleccion, paginador.tag);
          paginador.pagina = 0;
        paginador.hayMas = false;
        paginador.ultimo = null;
        paginador.historial = [null];
        renderLista(coleccion, docsLocales, 0);
        return;
      }

      if (!Array.isArray(paginador.historial)) paginador.historial = [null];

      let destinoPagina = paginador.pagina;
      let cursor = null;
      if (reiniciar) {
        destinoPagina = 0;
        paginador.historial = [null];
      } else if (siguiente) {
        cursor = paginador.ultimo;
        destinoPagina = paginador.pagina + 1;
      } else if (anterior && paginador.pagina > 0) {
        destinoPagina = paginador.pagina - 1;
        cursor = paginador.historial[destinoPagina] || null;
      }

      let q = query(collection(db, coleccion), orderBy('nombre', 'asc'), limit(LIMITES.pagina));
      if (paginador.tag && paginador.tag !== 'todos') {
        q = query(q, where('etiquetas', 'array-contains', paginador.tag));
      }
      if (cursor) {
        q = query(q, startAfter(cursor));
      }

      let snap;
      try {
        snap = await getDocs(q);
      } catch (error) {
        manejarErrorFirebase(error, `${coleccion}-query`);
        const docsLocales = obtenerDatosLocales(coleccion, paginador.tag);
        state.fuenteDatos = 'local';
        paginador.pagina = 0;
        paginador.hayMas = false;
        paginador.ultimo = null;
        paginador.historial = [null];
        renderLista(coleccion, docsLocales, 0);
        return;
      }
      if (siguiente && snap.empty) {
        paginador.hayMas = false;
        return;
      }
      const docs = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      if (!docs.length) {
        const locales = obtenerDatosLocales(coleccion, paginador.tag);
        if (locales.length) {
          state.fuenteDatos = 'local';
          paginador.pagina = 0;
          paginador.hayMas = false;
          renderLista(coleccion, locales, 0);
          return;
        }
      }
      paginador.hayMas = snap.docs.length === LIMITES.pagina;
      paginador.ultimo = snap.docs[snap.docs.length - 1] || cursor || null;
      paginador.pagina = destinoPagina;
      paginador.historial[destinoPagina] = cursor || null;
      renderLista(coleccion, docs, paginador.pagina);
    };

    document.querySelectorAll('.paginacion button').forEach((btn) => {
      btn.addEventListener('click', (event) => {
        const { prev, next } = event.currentTarget.dataset;
        const coleccion = prev || next;
        if (!coleccion) return;
        const opciones = { reiniciar: false, siguiente: Boolean(next), anterior: Boolean(prev) };
        cargarColeccion(coleccion, opciones).catch((error) => logError(error, 'paginacion'));
      });
    });

    const cargarResenas = async ({ reiniciar = false, siguiente = false, anterior = false } = {}) => {
      const paginador = state.paginadores.rese√±as;
      if (siguiente && !paginador.hayMas) return;

      if (!firebaseHabilitado || !db) {
        state.fuenteDatos = 'local';
        const docsLocales = Array.isArray(DATOS_LOCALES.rese√±as) ? [...DATOS_LOCALES.rese√±as] : [];
        state.rese√±as = docsLocales;
        paginador.pagina = 0;
        paginador.hayMas = false;
        renderResenas(docsLocales, 0);
        return;
      }

      if (!Array.isArray(paginador.historial)) paginador.historial = [null];

      let destinoPagina = paginador.pagina;
      let cursor = null;
      if (reiniciar) {
        destinoPagina = 0;
        paginador.historial = [null];
        paginador.ultimo = null;
      } else if (siguiente) {
        cursor = paginador.ultimo;
        destinoPagina = paginador.pagina + 1;
      } else if (anterior && paginador.pagina > 0) {
        destinoPagina = paginador.pagina - 1;
        cursor = paginador.historial[destinoPagina] || null;
      }

      let q = query(collection(db, 'rese√±as'), orderBy('creado', 'desc'), limit(LIMITES.rese√±as));
      if (cursor) {
        q = query(q, startAfter(cursor));
      }

      let snap;
      try {
        snap = await getDocs(q);
      } catch (error) {
        manejarErrorFirebase(error, 'rese√±as-query');
        const docsLocales = Array.isArray(DATOS_LOCALES.rese√±as) ? [...DATOS_LOCALES.rese√±as] : [];
        state.fuenteDatos = 'local';
        state.rese√±as = docsLocales;
        paginador.pagina = 0;
        paginador.hayMas = false;
        paginador.ultimo = null;
        paginador.historial = [null];
        renderResenas(docsLocales, 0);
        return;
      }
      if (siguiente && snap.empty) {
        paginador.hayMas = false;
        return;
      }
      const docs = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      if (!docs.length && Array.isArray(DATOS_LOCALES.rese√±as) && DATOS_LOCALES.rese√±as.length) {
        state.fuenteDatos = 'local';
        state.rese√±as = [...DATOS_LOCALES.rese√±as];
        paginador.pagina = 0;
        paginador.hayMas = false;
        renderResenas(state.rese√±as, 0);
        return;
      }
      paginador.hayMas = snap.docs.length === LIMITES.rese√±as;
      paginador.ultimo = snap.docs[snap.docs.length - 1] || cursor || null;
      paginador.pagina = destinoPagina;
      paginador.historial[destinoPagina] = cursor || null;
      state.rese√±as = docs;
      renderResenas(docs, paginador.pagina);
    };

    document.querySelectorAll('[data-next="rese√±as"], [data-prev="rese√±as"]').forEach((btn) => {
      btn.addEventListener('click', (event) => {
        const siguiente = Boolean(event.currentTarget.dataset.next);
        const anterior = Boolean(event.currentTarget.dataset.prev);
        cargarResenas({ siguiente, anterior }).catch((error) => logError(error, 'rese√±as'));
      });
    });

    const validarResena = (formData) => {
      const titulo = formData.get('titulo').trim();
      const texto = formData.get('texto').trim();
      const rating = clampRating(formData.get('rating'));
      const errores = [];
      if (!titulo || titulo.length > 60) errores.push('titulo');
      if (!texto || texto.length > 2000) errores.push('texto');
      if (rating < 1 || rating > 5) errores.push('rating');
      document.getElementById('ayudaTitulo').hidden = !errores.includes('titulo');
      document.getElementById('ayudaTexto').hidden = !errores.includes('texto');
      document.getElementById('ayudaRating').hidden = !errores.includes('rating');
      return errores.length === 0 ? { titulo, texto, rating } : null;
    };

    formResena.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (state.baneado) {
        mostrarToast('Tu acceso est√° bloqueado. Contacta con soporte.');
        return;
      }
      if (!state.user || state.claims.role === 'invitado') {
        mostrarToast('Inicia sesi√≥n para dejar una rese√±a.');
        return;
      }
      const datos = new FormData(formResena);
      const resena = validarResena(datos);
      if (!resena) return;
      try {
        if (!firebaseHabilitado || !db) {
          const nueva = {
            id: `local-${Date.now()}`,
            ...resena,
            creado: { seconds: Math.floor(Date.now() / 1000) },
            usuario: state.user.uid
          };
          DATOS_LOCALES.rese√±as.unshift(nueva);
          state.rese√±as = [...DATOS_LOCALES.rese√±as];
          renderResenas(state.rese√±as, 0);
          formResena.reset();
          mostrarToast('Rese√±a guardada en modo local. Se sincronizar√° al conectarse.');
        } else {
          await addDoc(collection(db, 'rese√±as'), {
            ...resena,
            creado: serverTimestamp(),
            usuario: state.user.uid
          });
          formResena.reset();
          mostrarToast('Rese√±a enviada. ¬°Gracias!');
          state.paginadores.rese√±as = { pagina: 0, ultimo: null, hayMas: true, historial: [null] };
          await cargarResenas({ reiniciar: true });
        }
      } catch (error) {
        logError(error, 'crear-resena');
      }
    });
    const eliminarResena = async (id) => {
      if (!state.user) return;
      try {
        if (!firebaseHabilitado || !db) {
          DATOS_LOCALES.rese√±as = DATOS_LOCALES.rese√±as.filter((item) => item.id !== id);
          state.rese√±as = state.rese√±as.filter((item) => item.id !== id);
          renderResenas(state.rese√±as, 0);
          mostrarToast('Rese√±a eliminada del modo local');
          return;
        }
        await deleteDoc(doc(db, 'rese√±as', id));
        mostrarToast('Rese√±a eliminada');
        state.paginadores.rese√±as = { pagina: 0, ultimo: null, hayMas: true, historial: [null] };
        await cargarResenas({ reiniciar: true });
      } catch (error) {
        logError(error, 'eliminar-resena');
      }
    };

    const mostrarConsentimiento = () => {
      if (!state.consentimiento) {
        bannerConsent.classList.add('visible');
      }
    };

    const activarAnalytics = () => {
      if (state.consentimiento !== 'aceptado' || analyticsInstance) return analyticsInstance;
      try {
        analyticsInstance = getAnalytics(app);
      } catch (error) {
        logError(error, 'analytics');
      }
      return analyticsInstance;
    };

    btnAceptarConsent.addEventListener('click', () => {
      localStorage.setItem('smv-consentimiento', 'aceptado');
      state.consentimiento = 'aceptado';
      bannerConsent.classList.remove('visible');
      activarAnalytics();
    });

    btnRechazarConsent.addEventListener('click', () => {
      localStorage.setItem('smv-consentimiento', 'rechazado');
      state.consentimiento = 'rechazado';
      bannerConsent.classList.remove('visible');
    });

    const renderClima = (data) => {
      widgetClima.textContent = '';
      const temp = document.createElement('strong');
      temp.textContent = `Temperatura: ${Math.round(data?.temperatura ?? 0)}¬∞C`;
      const descripcion = document.createElement('p');
      descripcion.textContent = data?.descripcion || 'Condiciones no disponibles';
      const actualizacion = document.createElement('small');
      actualizacion.textContent = `Actualizado: ${new Date().toLocaleTimeString()}`;
      widgetClima.append(temp, descripcion, actualizacion);
    };

    const CODIGOS_METEO_DESCRIPCION = {
      0: 'Cielo despejado',
      1: 'Mayormente despejado',
      2: 'Parcialmente nublado',
      3: 'Nublado',
      45: 'Niebla',
      48: 'Niebla con escarcha',
      51: 'Llovizna ligera',
      53: 'Llovizna moderada',
      55: 'Llovizna densa',
      61: 'Lluvia d√©bil',
      63: 'Lluvia moderada',
      65: 'Lluvia intensa',
      66: 'Lluvia helada d√©bil',
      67: 'Lluvia helada intensa',
      71: 'Nieve ligera',
      73: 'Nieve moderada',
      75: 'Fuertes nevadas',
      80: 'Chubascos ligeros',
      81: 'Chubascos moderados',
      82: 'Chubascos intensos',
      95: 'Tormenta',
      96: 'Tormenta con granizo leve',
      99: 'Tormenta con granizo fuerte'
    };

    const obtenerDescripcionClima = (codigo) => CODIGOS_METEO_DESCRIPCION[codigo] || 'Condiciones no disponibles';

    const construirClimaDesdeMeteo = (payload) => {
      const actual = payload?.current_weather;
      if (!actual) return null;
      const temperatura = Number(actual.temperature);
      return {
        temperatura: Number.isFinite(temperatura) ? temperatura : 0,
        descripcion: obtenerDescripcionClima(actual.weathercode)
      };
    };

    const METEO_COORDENADAS = { lat: 40.20732, lng: -3.57013 };

    const inicializarClima = async () => {
      if (state.climaCache && Date.now() - state.climaCache.timestamp < 10 * 60 * 1000) {
        renderClima(state.climaCache.data);
        return;
      }
      const controlador = new AbortController();
      state.climaTimeout = setTimeout(() => controlador.abort(), 8000);
      let datosClima = null;
      try {
        const params = new URLSearchParams({
          latitude: String(METEO_COORDENADAS.lat),
          longitude: String(METEO_COORDENADAS.lng),
          current_weather: 'true',
          timezone: 'Europe/Madrid'
        });
        const respuesta = await fetch(`https://api.open-meteo.com/v1/forecast?${params.toString()}`, {
          signal: controlador.signal
        });
        if (!respuesta.ok) throw new Error('Error meteorol√≥gico');
        const payload = await respuesta.json();
        datosClima = construirClimaDesdeMeteo(payload);
        if (datosClima) {
          state.climaCache = { timestamp: Date.now(), data: datosClima };
          localStorage.setItem('smv-clima-cache', JSON.stringify(state.climaCache));
        }
      } catch (error) {
        if (error.name !== 'AbortError') {
          logError(error, 'clima');
        }
      } finally {
        clearTimeout(state.climaTimeout);
      }
      if (datosClima) {
        renderClima(datosClima);
      } else if (DATOS_LOCALES.clima) {
        renderClima(DATOS_LOCALES.clima);
      } else {
        widgetClima.textContent = 'No se pudo obtener el clima. Intenta m√°s tarde.';
      }
    };

    const prepararCalendario = (eventos) => {
      state.eventos = eventos;
      const anios = new Set();
      const mesActualNum = mesActual.getMonth();
      const anioActual = mesActual.getFullYear();
      eventos.forEach((evento) => {
        const fecha = evento.fecha?.seconds ? new Date(evento.fecha.seconds * 1000) : new Date();
        anios.add(fecha.getFullYear());
      });
      [anioActual - 1, anioActual, anioActual + 1].forEach((anio) => anios.add(anio));
      selectAnio.textContent = '';
      Array.from(anios).sort((a, b) => a - b).forEach((anio) => {
        const option = document.createElement('option');
        option.value = String(anio);
        option.textContent = String(anio);
        if (anio === anioActual) option.selected = true;
        selectAnio.appendChild(option);
      });
      selectMes.textContent = '';
      const formatoMes = new Intl.DateTimeFormat('es', { month: 'long' });
      for (let m = 0; m < 12; m += 1) {
        const opcion = document.createElement('option');
        opcion.value = String(m);
        opcion.textContent = formatoMes.format(new Date(2024, m, 1));
        if (m === mesActualNum) opcion.selected = true;
        selectMes.appendChild(opcion);
      }
      renderCalendario();
    };

    const renderCalendario = () => {
      const mes = Number.parseInt(selectMes.value, 10);
      const anio = Number.parseInt(selectAnio.value, 10);
      const primerDia = new Date(anio, mes, 1);
      const ultimoDia = new Date(anio, mes + 1, 0);
      const dias = [];
      const offset = primerDia.getDay() === 0 ? 6 : primerDia.getDay() - 1;
      for (let i = 0; i < offset; i += 1) dias.push(null);
      for (let d = 1; d <= ultimoDia.getDate(); d += 1) dias.push(new Date(anio, mes, d));
      gridCalendario.textContent = '';
      const eventosMes = state.eventos.filter((evento) => {
        const fecha = evento.fecha?.seconds ? new Date(evento.fecha.seconds * 1000) : new Date();
        return fecha.getMonth() === mes && fecha.getFullYear() === anio;
      });
      dias.forEach((fecha) => {
        const celda = document.createElement('div');
        celda.className = 'dia-calendario';
        if (fecha) {
          const numero = document.createElement('strong');
          numero.textContent = String(fecha.getDate());
          celda.appendChild(numero);
          const delDia = eventosMes.filter((evento) => {
            const f = evento.fecha?.seconds ? new Date(evento.fecha.seconds * 1000) : new Date();
            return f.getDate() === fecha.getDate();
          });
          if (delDia.length) {
            celda.classList.add('evento');
            celda.dataset.tipo = delDia[0].tipo || 'general';
            const texto = document.createElement('span');
            texto.textContent = delDia[0].titulo;
            celda.appendChild(texto);
            celda.tabIndex = 0;
            celda.setAttribute('role', 'button');
            const abrir = () => mostrarEventosDia(fecha, delDia);
            celda.addEventListener('click', abrir);
            celda.addEventListener('keydown', (event) => {
              if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                abrir();
              }
            });
          }
        }
        gridCalendario.appendChild(celda);
      });
      if (!eventosMes.length) {
        detalleEventos.textContent = 'No hay eventos para el mes seleccionado.';
      } else {
        detalleEventos.textContent = '';
      }
    };

    const mostrarEventosDia = (fecha, eventos) => {
      detalleEventos.textContent = '';
      const titulo = document.createElement('h3');
      titulo.textContent = `Eventos del ${fecha.toLocaleDateString()}`;
      detalleEventos.appendChild(titulo);
      const lista = document.createElement('ul');
      lista.style.listStyle = 'none';
      lista.style.padding = '0';
      lista.style.display = 'grid';
      lista.style.gap = '0.5rem';
      eventos.forEach((evento) => {
        const item = document.createElement('li');
        const nombre = document.createElement('strong');
        nombre.textContent = evento.titulo;
        item.appendChild(nombre);
        if (evento.descripcion) {
          const descripcion = document.createElement('p');
          descripcion.textContent = evento.descripcion;
          item.appendChild(descripcion);
        }
        if (evento.enlace && isSafeHttpUrl(evento.enlace)) {
          const enlace = document.createElement('a');
          enlace.textContent = 'M√°s informaci√≥n';
          if (safeLink(enlace, evento.enlace)) item.appendChild(enlace);
        }
        lista.appendChild(item);
      });
      detalleEventos.appendChild(lista);
    };

    selectMes.addEventListener('change', renderCalendario);
    selectAnio.addEventListener('change', renderCalendario);

    const renderHistoria = (items) => {
      const contenedor = document.getElementById('listaHistoria');
      contenedor.textContent = '';
      if (!items.length) {
        const vacio = document.createElement('p');
        vacio.className = 'lista-vacia';
        vacio.textContent = 'Pr√≥ximamente a√±adiremos m√°s hitos hist√≥ricos.';
        contenedor.appendChild(vacio);
        return;
      }
      items.forEach((evento) => {
        const tarjeta = document.createElement('article');
        tarjeta.className = 'tarjeta';
        const titulo = document.createElement('h3');
        titulo.textContent = `${evento.anio} ¬∑ ${evento.titulo}`;
        tarjeta.appendChild(titulo);
        const descripcion = document.createElement('p');
        descripcion.textContent = evento.descripcion;
        tarjeta.appendChild(descripcion);
        contenedor.appendChild(tarjeta);
      });
    };
    const abrirModalAdmin = (item = null, coleccion = 'lugares') => {
      formAdmin.reset();
      formAdmin.dataset.id = item ? item.id : '';
      formAdmin.dataset.coleccion = coleccion;
      if (item) {
        formAdmin.coleccion.value = coleccion;
        formAdmin.nombre.value = item.nombre;
        formAdmin.descripcion.value = item.descripcion;
        formAdmin.imagen.value = item.imagen;
        formAdmin.etiquetas.value = Array.isArray(item.etiquetas) ? item.etiquetas.join(', ') : '';
        formAdmin.enlace.value = item.enlace || '';
      }
      modalAdmin.classList.add('visible');
      modalAdmin.setAttribute('aria-hidden', 'false');
      formAdmin.querySelector('input, select, textarea').focus();
    };

    const cerrarModalAdmin = () => {
      modalAdmin.classList.remove('visible');
      modalAdmin.setAttribute('aria-hidden', 'true');
      formAdmin.removeAttribute('data-id');
      formAdmin.removeAttribute('data-coleccion');
    };

    const abrirModalGenerico = (modal) => {
      modal.classList.add('visible');
      modal.setAttribute('aria-hidden', 'false');
      const focusable = modal.querySelector('input, button, select, textarea');
      if (focusable) focusable.focus();
    };

    const cerrarModalGenerico = (modal) => {
      modal.classList.remove('visible');
      modal.setAttribute('aria-hidden', 'true');
    };

    btnAbrirModalAdmin.addEventListener('click', () => abrirModalAdmin());
    btnCerrarModalAdmin.addEventListener('click', cerrarModalAdmin);
    modalAdmin.addEventListener('click', (event) => {
      if (event.target === modalAdmin) cerrarModalAdmin();
    });
    btnLogin.addEventListener('click', () => abrirModalGenerico(modalBienvenida));
    btnCerrarModalBienvenida.addEventListener('click', () => {
      cerrarModalGenerico(modalBienvenida);
      state.claims = { role: 'invitado' };
      panelCuenta.disabled = true;
    });
    btnLoginCorreo.addEventListener('click', () => {
      cerrarModalGenerico(modalBienvenida);
      abrirModalGenerico(modalLogin);
    });

    const iniciarSesionInvitado = () => {
      cerrarModalGenerico(modalBienvenida);
      state.user = null;
      state.claims = { role: 'invitado' };
      state.offlineAuth = false;
      panelCuenta.disabled = true;
      if (estadoCuenta) estadoCuenta.hidden = true;
      mostrarToast('Est√°s navegando como invitado. Inicia sesi√≥n para publicar rese√±as.');
    };

    const iniciarConProveedor = async (provider, nombre) => {
      if (!provider || !firebaseHabilitado || !auth) {
        mostrarToast(`Con√©ctate para usar el acceso con ${nombre}.`);
        return;
      }
      try {
        await signInWithPopup(auth, provider);
        cerrarModalGenerico(modalBienvenida);
        mostrarToast(`Sesi√≥n iniciada con ${nombre}.`);
      } catch (error) {
        if (error.code === 'auth/popup-closed-by-user') return;
        logError(error, `${nombre}-login`);
      }
    };

    btnInvitado.addEventListener('click', iniciarSesionInvitado);
    btnLoginGoogle.addEventListener('click', () => iniciarConProveedor(googleProvider, 'Google'));
    btnLoginFacebook.addEventListener('click', () => iniciarConProveedor(facebookProvider, 'Facebook'));
    const cerrarLogin = () => {
      cerrarModalGenerico(modalLogin);
      errorLogin.hidden = true;
      formLogin.reset();
    };
    btnCerrarModalLogin.addEventListener('click', cerrarLogin);
    modalLogin.addEventListener('click', (event) => {
      if (event.target === modalLogin) cerrarLogin();
    });

    const validarContenido = (datos) => {
      const coleccion = datos.get('coleccion');
      const nombre = datos.get('nombre').trim();
      const descripcion = datos.get('descripcion').trim();
      const imagen = datos.get('imagen').trim();
      const archivo = datos.get('archivoImagen');
      const enlace = datos.get('enlace').trim();
      const etiquetas = limpiarEtiquetas(datos.get('etiquetas'));
      if (!nombre || nombre.length > 60) throw new Error('Nombre inv√°lido');
      if (!descripcion || descripcion.length > 2000) throw new Error('Descripci√≥n inv√°lida');
      const tieneArchivo = archivo && archivo.size > 0;
      if (tieneArchivo && !archivo.type.startsWith('image/')) throw new Error('El archivo debe ser una imagen.');
      if (!imagen && !tieneArchivo) throw new Error('Proporciona una imagen o sube un archivo.');
      if (imagen && !isSafeImageURL(imagen)) throw new Error('URL de imagen no segura');
      if (enlace && !isSafeHttpUrl(enlace)) throw new Error('Enlace no v√°lido');
      return { coleccion, nombre, descripcion, imagen, archivo: tieneArchivo ? archivo : null, enlace: enlace || null, etiquetas };
    };

    const archivoADataURL = (archivo) => new Promise((resolve, reject) => {
      const lector = new FileReader();
      lector.onload = () => resolve(lector.result);
      lector.onerror = () => reject(new Error('No se pudo leer el archivo'));
      lector.readAsDataURL(archivo);
    });

    const subirImagenContenido = async (archivo, coleccion, nombre) => {
      if (!archivo) return null;
      if (firebaseHabilitado && storage) {
        const slug = nombre.toLowerCase().replace(/[^a-z0-9]+/g, '-').slice(0, 40) || 'imagen';
        const ruta = `contenido/${coleccion}/${Date.now()}-${slug}`;
        const referencia = ref(storage, ruta);
        await uploadBytes(referencia, archivo, { contentType: archivo.type });
        return await getDownloadURL(referencia);
      }
      return archivoADataURL(archivo);
    };

    formAdmin.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (state.claims.role !== 'admin') {
        mostrarToast('Necesitas permisos de administrador.');
        return;
      }
      try {
        const datos = new FormData(formAdmin);
        const contenido = validarContenido(datos);
        const imagenFinal = contenido.archivo ? await subirImagenContenido(contenido.archivo, contenido.coleccion, contenido.nombre) : contenido.imagen;
        if (!imagenFinal || !isSafeImageURL(imagenFinal)) throw new Error('No fue posible procesar la imagen.');
        const actualizado = firebaseHabilitado && db ? serverTimestamp() : { seconds: Math.floor(Date.now() / 1000) };
        const docData = {
          nombre: contenido.nombre,
          descripcion: contenido.descripcion,
          imagen: imagenFinal,
          etiquetas: contenido.etiquetas,
          enlace: contenido.enlace,
          actualizado
        };
        const existente = formAdmin.dataset.id;
        if (!firebaseHabilitado || !db) {
          const nuevo = { id: existente || `local-${Date.now()}`, ...docData };
          if (!Array.isArray(DATOS_LOCALES[contenido.coleccion])) DATOS_LOCALES[contenido.coleccion] = [];
          if (existente) {
            DATOS_LOCALES[contenido.coleccion] = DATOS_LOCALES[contenido.coleccion].map((item) => (item.id === existente ? { ...item, ...nuevo } : item));
            mostrarToast('Contenido actualizado en modo local');
          } else {
            DATOS_LOCALES[contenido.coleccion].push({ ...nuevo, creado: { seconds: Math.floor(Date.now() / 1000) } });
            mostrarToast('Contenido creado en modo local');
          }
        } else if (existente) {
          await updateDoc(doc(db, contenido.coleccion, existente), docData);
          mostrarToast('Contenido actualizado');
        } else {
          await addDoc(collection(db, contenido.coleccion), { ...docData, creado: serverTimestamp() });
          mostrarToast('Contenido creado');
        }
        cerrarModalAdmin();
        await cargarColeccion(contenido.coleccion, { reiniciar: true });
      } catch (error) {
        logError(error, 'admin-guardar');
      }
    });

    const eliminarDocumento = async (coleccion, id) => {
      if (state.claims.role !== 'admin') return;
      try {
        if (!firebaseHabilitado || !db) {
          if (Array.isArray(DATOS_LOCALES[coleccion])) {
            DATOS_LOCALES[coleccion] = DATOS_LOCALES[coleccion].filter((item) => item.id !== id);
          }
          mostrarToast('Elemento eliminado en modo local');
          await cargarColeccion(coleccion, { reiniciar: true });
          return;
        }
        await deleteDoc(doc(db, coleccion, id));
        mostrarToast('Elemento eliminado');
        await cargarColeccion(coleccion, { reiniciar: true });
      } catch (error) {
        logError(error, 'admin-eliminar');
      }
    };

    const renderAdminLista = async () => {
      if (state.claims.role !== 'admin') return;
      const colecciones = ['lugares', 'restaurantes', 'ocio'];
      const renderLocal = () => {
        listaAdmin.textContent = '';
        colecciones.forEach((coleccion) => {
          const titulo = document.createElement('li');
          titulo.textContent = `Colecci√≥n ${coleccion}`;
          listaAdmin.appendChild(titulo);
          obtenerDatosLocales(coleccion).forEach((itemLocal) => {
            const item = document.createElement('li');
            item.textContent = itemLocal.nombre;
            listaAdmin.appendChild(item);
          });
        });
      };
      if (!firebaseHabilitado || !db) {
        renderLocal();
        return;
      }
      listaAdmin.textContent = '';
      try {
        for (const coleccion of colecciones) {
          const snap = await getDocs(query(collection(db, coleccion), orderBy('nombre', 'asc'), limit(10)));
          const titulo = document.createElement('li');
          titulo.textContent = `Colecci√≥n ${coleccion}`;
          listaAdmin.appendChild(titulo);
          snap.docs.forEach((d) => {
            const item = document.createElement('li');
            item.textContent = d.data().nombre;
            listaAdmin.appendChild(item);
          });
        }
      } catch (error) {
        manejarErrorFirebase(error, 'admin-lista');
        renderLocal();
      }
    };

    const safeSetGPX = (url) => {
      if (url && isSafeHttpUrl(url) && !/REEMPLAZAR/i.test(url)) {
        btnDescargarGPX.hidden = false;
        btnDescargarGPX.dataset.href = url;
      } else {
        btnDescargarGPX.hidden = true;
        delete btnDescargarGPX.dataset.href;
      }
    };

    btnDescargarGPX.addEventListener('click', () => {
      const href = btnDescargarGPX.dataset.href;
      if (href && isSafeHttpUrl(href)) {
        window.open(href, '_blank', 'noopener');
      }
    });

    const PREFERENCIAS = {
      fuente: { key: 'smv-fuente', checkbox: toggleFuente, className: 'fuente-dyslexia' },
      reducir: { key: 'smv-reducir', checkbox: toggleReducir, className: 'reducir-animaciones' },
      contraste: { key: 'smv-contraste', checkbox: toggleContraste, className: 'alto-contraste', quick: initContraste },
      texto: { key: 'smv-texto', checkbox: toggleTexto, className: 'texto-grande', quick: initTexto },
      espaciado: { key: 'smv-espaciado', checkbox: toggleEspaciado, className: 'espaciado-amplio', quick: initEspaciado },
      links: { key: 'smv-links', checkbox: toggleLinks, className: 'links-subrayados', quick: initLinks }
    };

    const aplicarPreferencias = () => {
      Object.values(PREFERENCIAS).forEach((pref) => {
        const activo = localStorage.getItem(pref.key) === 'on';
        if (pref.checkbox) pref.checkbox.checked = activo;
        if (pref.quick) pref.quick.checked = activo;
        if (pref.className) document.body.classList.toggle(pref.className, activo);
      });
    };

    const actualizarPreferencia = (pref, value) => {
      localStorage.setItem(pref.key, value ? 'on' : 'off');
      aplicarPreferencias();
    };

    Object.values(PREFERENCIAS).forEach((pref) => {
      if (pref.checkbox) {
        pref.checkbox.addEventListener('change', (event) => {
          actualizarPreferencia(pref, event.target.checked);
        });
      }
      if (pref.quick) {
        pref.quick.addEventListener('change', (event) => {
          actualizarPreferencia(pref, event.target.checked);
        });
      }
    });

    const establecerSesionOffline = (email, info) => {
      state.offlineAuth = true;
      const displayName = info.displayName || email.split('@')[0];
      state.user = { uid: `offline-${info.role}`, email, displayName, offline: true };
      state.claims = { role: info.role };
      btnLogin.hidden = true;
      btnLogout.hidden = false;
      panelCuenta.disabled = false;
      if (formPerfil && formPerfil.displayName) {
        formPerfil.displayName.value = displayName;
      }
      cerrarModalGenerico(modalLogin);
      cerrarModalGenerico(modalBienvenida);
      mostrarToast('Sesi√≥n iniciada en modo seguro sin conexi√≥n.');
      renderAdminLista();
    };

    formLogin.addEventListener('submit', async (event) => {
      event.preventDefault();
      const email = formLogin.email.value.trim();
      const password = formLogin.password.value;
      if (!email || !password) {
        errorLogin.textContent = 'Completa email y contrase√±a v√°lidos.';
        errorLogin.hidden = false;
        return;
      }
      errorLogin.hidden = true;
      try {
        if (!firebaseHabilitado || !auth) throw new Error('firebase-offline');
        await signInWithEmailAndPassword(auth, email, password);
        cerrarModalGenerico(modalLogin);
        formLogin.reset();
        mostrarToast('Sesi√≥n iniciada correctamente');
      } catch (error) {
        const fallback = USUARIOS_FALLBACK[email];
        if (fallback && fallback.password === password) {
          establecerSesionOffline(email, fallback);
          formLogin.reset();
          return;
        }
        errorLogin.textContent = 'No fue posible iniciar sesi√≥n. Verifica las credenciales.';
        errorLogin.hidden = false;
        logError(error, 'login');
      }
    });

    btnLogout.addEventListener('click', () => {
      if (state.offlineAuth) {
        state.offlineAuth = false;
        state.user = null;
        state.claims = { role: 'visitante' };
        panelCuenta.disabled = true;
        btnLogin.hidden = false;
        btnLogout.hidden = true;
        mostrarToast('Sesi√≥n cerrada.');
        return;
      }
      if (auth) {
        signOut(auth).catch((error) => logError(error, 'logout'));
      }
    });

    const guardarBaneados = () => {
      localStorage.setItem('smv-baneados', JSON.stringify([...state.baneados]));
    };

    const aplicarBaneo = () => {
      state.baneado = true;
      document.body.dataset.baneado = 'true';
      abrirModalGenerico(modalBaneado);
    };

    const levantarBaneo = () => {
      state.baneado = false;
      document.body.dataset.baneado = 'false';
      cerrarModalGenerico(modalBaneado);
    };

    const actualizarListaBaneados = () => {
      listaBaneados.textContent = '';
      if (!state.baneados.size) {
        const vacio = document.createElement('li');
        vacio.textContent = 'Sin IPs bloqueadas.';
        listaBaneados.appendChild(vacio);
        return;
      }
      for (const ip of state.baneados) {
        const item = document.createElement('li');
        item.style.display = 'flex';
        item.style.justifyContent = 'space-between';
        item.style.alignItems = 'center';
        item.textContent = ip;
        if (state.claims.role === 'admin') {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-ghost';
          btn.textContent = 'Desbloquear';
          btn.addEventListener('click', () => {
            state.baneados.delete(ip);
            guardarBaneados();
            actualizarListaBaneados();
            if (state.ip === ip) levantarBaneo();
          });
          item.appendChild(btn);
        }
        listaBaneados.appendChild(item);
      }
    };

    const verificarBaneoActual = () => {
      if (state.ip && state.baneados.has(state.ip)) {
        aplicarBaneo();
      } else {
        levantarBaneo();
      }
    };

    formBan.addEventListener('submit', (event) => {
      event.preventDefault();
      if (state.claims.role !== 'admin') {
        mostrarToast('Solo el equipo administrador puede gestionar bloqueos.');
        return;
      }
      const ip = inputBanIp.value.trim();
      const patron = /^(?:\d{1,3}\.){3}\d{1,3}$/;
      if (!patron.test(ip)) {
        mostrarToast('Introduce una IP v√°lida.');
        return;
      }
      state.baneados.add(ip);
      guardarBaneados();
      actualizarListaBaneados();
      formBan.reset();
      mostrarToast(`IP ${ip} bloqueada.`);
      if (state.ip === ip) {
        aplicarBaneo();
      }
    });

    const obtenerIPPublica = async () => {
      try {
        const respuesta = await fetch('https://api.ipify.org?format=json');
        if (!respuesta.ok) throw new Error('ip');
        const data = await respuesta.json();
        state.ip = data.ip;
      } catch (error) {
        console.warn('No se pudo obtener la IP p√∫blica', error);
      } finally {
        verificarBaneoActual();
      }
    };

    actualizarListaBaneados();

    const mostrarEstadoCuenta = (mensaje, esError = false) => {
      if (!estadoCuenta) return;
      estadoCuenta.textContent = mensaje;
      estadoCuenta.hidden = false;
      estadoCuenta.style.color = esError ? '#d32f2f' : '#0b3d91';
    };

    formPerfil.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!state.user) {
        mostrarEstadoCuenta('Inicia sesi√≥n para actualizar tu nombre.', true);
        return;
      }
      const displayName = formPerfil.displayName.value.trim();
      if (!displayName) {
        mostrarEstadoCuenta('El nombre no puede estar vac√≠o.', true);
        return;
      }
      try {
        if (!firebaseHabilitado || !auth || !auth.currentUser) {
          state.user.displayName = displayName;
          mostrarEstadoCuenta('Nombre guardado localmente. Se sincronizar√° al conectarte.');
          return;
        }
        await updateProfile(auth.currentUser, { displayName });
        mostrarEstadoCuenta('Nombre actualizado correctamente.');
      } catch (error) {
        mostrarEstadoCuenta('No se pudo actualizar el nombre. Intenta de nuevo.', true);
        logError(error, 'perfil');
      }
    });

    formPassword.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!state.user) {
        mostrarEstadoCuenta('Inicia sesi√≥n para cambiar la contrase√±a.', true);
        return;
      }
      const nueva = formPassword.password.value;
      if (!nueva || nueva.length < 8) {
        mostrarEstadoCuenta('La contrase√±a debe tener al menos 8 caracteres.', true);
        return;
      }
      if (!firebaseHabilitado || !auth || !auth.currentUser) {
        mostrarEstadoCuenta('Con√©ctate a la red municipal para cambiar la contrase√±a.', true);
        return;
      }
      try {
        await updatePassword(auth.currentUser, nueva);
        formPassword.reset();
        mostrarEstadoCuenta('Contrase√±a actualizada.');
      } catch (error) {
        if (error.code === 'auth/requires-recent-login') {
          mostrarEstadoCuenta('Vuelve a iniciar sesi√≥n para confirmar el cambio de contrase√±a.', true);
        } else {
          mostrarEstadoCuenta('No se pudo actualizar la contrase√±a.', true);
        }
        logError(error, 'password');
      }
    });

    btnVerificarCorreo.addEventListener('click', async () => {
      if (!firebaseHabilitado || !auth || !auth.currentUser) {
        mostrarEstadoCuenta('Con√©ctate para solicitar un correo de verificaci√≥n.', true);
        return;
      }
      try {
        await sendEmailVerification(auth.currentUser);
        mostrarEstadoCuenta('Hemos enviado un correo de verificaci√≥n.');
      } catch (error) {
        mostrarEstadoCuenta('No se pudo enviar el correo. Intenta m√°s tarde.', true);
        logError(error, 'verificacion');
      }
    });

    btnCerrarSesiones.addEventListener('click', () => {
      if (state.offlineAuth) {
        mostrarEstadoCuenta('Cierra la sesi√≥n local desde el bot√≥n principal.', true);
        return;
      }
      if (auth) {
        signOut(auth).catch((error) => logError(error, 'cerrar-sesiones'));
      }
    });

    btnEliminarCuenta.addEventListener('click', async () => {
      if (!firebaseHabilitado || !auth || !auth.currentUser) {
        mostrarEstadoCuenta('Con√©ctate para solicitar la eliminaci√≥n de la cuenta.', true);
        return;
      }
      const confirmar = window.confirm('¬øSeguro que quieres eliminar la cuenta? Esta acci√≥n es irreversible.');
      if (!confirmar) return;
      try {
        await deleteUser(auth.currentUser);
        mostrarEstadoCuenta('Cuenta eliminada. Sentimos verte partir.');
      } catch (error) {
        if (error.code === 'auth/requires-recent-login') {
          mostrarEstadoCuenta('Vuelve a iniciar sesi√≥n y repite la operaci√≥n para confirmar la eliminaci√≥n.', true);
        } else {
          mostrarEstadoCuenta('No pudimos eliminar la cuenta. Contacta con soporte.', true);
        }
        logError(error, 'eliminar-cuenta');
      }
    });

    const actualizarUIAuth = async (user) => {
      state.user = user;
      if (!user) {
        state.claims = { role: 'visitante' };
        btnLogin.hidden = false;
        btnLogout.hidden = true;
        btnMenuAdmin.hidden = true;
        panelCuenta.disabled = true;
        cerrarModalAdmin();
        cerrarLogin();
        if (estadoCuenta) estadoCuenta.hidden = true;
        actualizarListaBaneados();
        return;
      }
      btnLogin.hidden = true;
      btnLogout.hidden = false;
      panelCuenta.disabled = false;
      if (estadoCuenta) estadoCuenta.hidden = true;
      if (user.offline) {
        const esAdmin = state.claims.role === 'admin';
        btnMenuAdmin.hidden = !esAdmin;
        if (!esAdmin) cerrarModalAdmin();
        if (esAdmin) await renderAdminLista();
        actualizarListaBaneados();
        return;
      }
      try {
        const tokenResult = await user.getIdTokenResult(true);
        state.claims = tokenResult.claims || { role: 'visitante' };
      } catch (error) {
        state.claims = { role: 'visitante' };
        logError(error, 'claims');
      }
      const esAdmin = state.claims.role === 'admin';
      btnMenuAdmin.hidden = !esAdmin;
      if (!esAdmin) cerrarModalAdmin();
      if (esAdmin) {
        await renderAdminLista();
      }
      actualizarListaBaneados();
    };

    if (firebaseHabilitado && auth) {
      onAuthStateChanged(auth, (user) => {
        actualizarUIAuth(user);
      });
    } else {
      actualizarUIAuth(null);
    }

    const asignarConfiguracionLocal = () => {
      if (DATOS_LOCALES.configuracion?.gpx) safeSetGPX(DATOS_LOCALES.configuracion.gpx);
      if (Array.isArray(DATOS_LOCALES.configuracion?.mapa)) {
        const [lat, lng] = DATOS_LOCALES.configuracion.mapa;
        iframeMapa.src = `https://www.google.com/maps?q=${lat},${lng}&output=embed`;
      }
    };

    const cargarDatosIniciales = async () => {
      try {
        await Promise.all([
          cargarColeccion('lugares', { reiniciar: true }),
          cargarColeccion('restaurantes', { reiniciar: true }),
          cargarColeccion('ocio', { reiniciar: true }),
          cargarResenas({ reiniciar: true })
        ]);
        if (!firebaseHabilitado || !db) {
          prepararCalendario(Array.isArray(DATOS_LOCALES.eventos) ? DATOS_LOCALES.eventos : []);
          renderHistoria(Array.isArray(DATOS_LOCALES.historia) ? DATOS_LOCALES.historia : []);
          asignarConfiguracionLocal();
          return;
        }
        let eventosDocs = [];
        try {
          const eventosSnap = await getDocs(query(collection(db, 'eventos'), orderBy('fecha', 'asc'), limit(200)));
          eventosDocs = eventosSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
        } catch (error) {
          manejarErrorFirebase(error, 'eventos');
        }
        if (!firebaseHabilitado || !db || !eventosDocs.length) {
          prepararCalendario(Array.isArray(DATOS_LOCALES.eventos) ? DATOS_LOCALES.eventos : []);
        } else {
          prepararCalendario(eventosDocs);
        }

        let historiaDocs = [];
        try {
          const historiaSnap = await getDocs(query(collection(db, 'historia'), orderBy('anio', 'asc'), limit(50)));
          historiaDocs = historiaSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
        } catch (error) {
          manejarErrorFirebase(error, 'historia');
        }
        if (!firebaseHabilitado || !db || !historiaDocs.length) {
          renderHistoria(Array.isArray(DATOS_LOCALES.historia) ? DATOS_LOCALES.historia : []);
        } else {
          renderHistoria(historiaDocs);
        }

        if (!firebaseHabilitado || !db) {
          asignarConfiguracionLocal();
          return;
        }

        let configuracionSnap = null;
        try {
          configuracionSnap = await getDocs(query(collection(db, 'configuracion'), limit(5)));
        } catch (error) {
          manejarErrorFirebase(error, 'configuracion');
        }

        if (!firebaseHabilitado || !db || !configuracionSnap || configuracionSnap.empty) {
          asignarConfiguracionLocal();
        } else {
          configuracionSnap.docs.forEach((docCfg) => {
            const data = docCfg.data();
            if (data.gpx) safeSetGPX(data.gpx);
            if (data.mapa?.q && Array.isArray(data.mapa.q) && data.mapa.q.length === 2) {
              const [lat, lng] = data.mapa.q;
              iframeMapa.src = `https://www.google.com/maps?q=${lat},${lng}&output=embed`;
            }
          });
        }
      } catch (error) {
        manejarErrorFirebase(error, 'datos-iniciales');
        prepararCalendario(Array.isArray(DATOS_LOCALES.eventos) ? DATOS_LOCALES.eventos : []);
        renderHistoria(Array.isArray(DATOS_LOCALES.historia) ? DATOS_LOCALES.historia : []);
        asignarConfiguracionLocal();
      }
    };

    const limpiarAlDesactivar = () => {
      if (state.climaTimeout) {
        clearTimeout(state.climaTimeout);
        state.climaTimeout = null;
      }
    };

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        limpiarAlDesactivar();
      } else if (!state.climaCache || Date.now() - state.climaCache.timestamp >= 10 * 60 * 1000) {
        inicializarClima();
      }
    });

    window.addEventListener('beforeunload', () => {
      limpiarAlDesactivar();
    });

    abrirModalGenerico(modalBienvenida);
    aplicarPreferencias();
    mostrarConsentimiento();
    if (state.consentimiento === 'aceptado') activarAnalytics();
    inicializarClima();
    obtenerIPPublica();
    cargarDatosIniciales();
  </script>

  <footer>
    <strong>Hecho por Daniel Terroba Alcala</strong>
    <p style="margin:0.5rem 0 0;">Gu√≠a tur√≠stica oficial de San Mart√≠n de la Vega ¬∑ Datos verificados por el equipo municipal.</p>
  </footer>
</body>
</html>
