<!DOCTYPE html>
<html lang="es">
<head>
  <!--
    Resumen de cambios:
    - Refactorizaci√≥n integral para reforzar seguridad (sin innerHTML inseguro, validaci√≥n de URLs, claims de Firebase) y accesibilidad.
    - A√±adidas paginaciones, limpieza de listeners, consentimiento de analytics y cacheo de clima con backoff.
    - Documentados headers, reglas Firestore, App Check y restricciones de claves; UI ajustada con foco visible y toasts accesibles.

    Cabeceras HTTP recomendadas:
    Content-Security-Policy: default-src 'self'; script-src 'self' https://www.gstatic.com https://www.googleapis.com; style-src 'self' 'unsafe-inline'; font-src 'self'; img-src 'self' https: data:; frame-src https://www.google.com; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; require-trusted-types-for 'script'
    Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
    X-Frame-Options: DENY
    Referrer-Policy: strict-origin-when-cross-origin
    Permissions-Policy: microphone=(), geolocation=(), fullscreen=()

    Firestore Security Rules (ejemplo)
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        function isAdmin() { return request.auth != null && request.auth.token.role == 'admin'; }
        match /rese√±as/{id} {
          allow read: if true;
          allow create: if request.auth != null && request.resource.data.rating >=1 && request.resource.data.rating <=5
            && request.resource.data.titulo.size() <= 60 && request.resource.data.texto.size() <= 2000;
          allow update, delete: if request.auth != null && request.auth.uid == resource.data.usuario;
        }
        match /{col in ['lugares','restaurantes','ocio']}/{id} {
          allow read: if true;
          allow write: if isAdmin();
        }
      }
    }

    Notas de despliegue:
    - Habilita Firebase App Check (reCAPTCHA v3 o DeviceCheck) y exige tokens v√°lidos para Auth, Firestore y Storage.
    - Restringe las API keys de mapas/clima por dominio, rutas y cuota. No publiques valores reales en el cliente.
    - Configura CORS del bucket de Storage al dominio oficial de la gu√≠a.
    - Gestiona la asignaci√≥n de custom claims admin mediante Cloud Functions o CLI.
  -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Turismo San Mart√≠n de la Vega</title>
  <style>
    @font-face {
      font-family: 'OpenDyslexic';
      src: url('https://fonts.cdnfonts.com/s/19709/OpenDyslexic3-Regular.woff') format('woff');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    :root {
      color-scheme: light;
      --color-fondo: #ffffff;
      --color-superficie: #f5f7fb;
      --color-primario: #0b3d91;
      --color-primario-oscuro: #072c68;
      --color-secundario: #4caf50;
      --color-texto: #17202a;
      --color-texto-suave: #4a5568;
      --color-borde: rgba(11, 61, 145, 0.12);
      --color-alerta: #d32f2f;
      --color-aviso: #ffc107;
      --sombra: 0 10px 28px rgba(11, 61, 145, 0.1);
      --radio: 18px;
      --transicion: 0.24s ease;
      --max-ancho: 1100px;
      --fuente-base: "Segoe UI", "Helvetica Neue", Arial, system-ui, sans-serif;
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body.reducir-animaciones *,
    body.reducir-animaciones *::before,
    body.reducir-animaciones *::after {
      transition-duration: 0.01ms !important;
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
    }

    body {
      margin: 0;
      font-family: var(--fuente-base);
      background: var(--color-fondo);
      color: var(--color-texto);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    body.menu-abierto {
      overflow: hidden;
    }

    body.fuente-dyslexia {
      font-family: 'OpenDyslexic', var(--fuente-base);
      letter-spacing: 0.03em;
      word-spacing: 0.05em;
    }

    body.visor-tarjeta-abierto {
      overflow: hidden;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    img {
      max-width: 100%;
      display: block;
    }

    button,
    input,
    select,
    textarea {
      font: inherit;
    }

    button:not(:disabled) {
      cursor: pointer;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--color-primario);
      color: #fff;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 8px 18px rgba(7, 44, 104, 0.35);
      flex-wrap: wrap;
    }

    header img {
      width: 42px;
      height: 42px;
      object-fit: contain;
      flex: 0 0 auto;
    }

    .menu-toggle {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      border: none;
      background: rgba(255, 255, 255, 0.18);
      color: inherit;
      display: grid;
      place-items: center;
      font-size: 1.5rem;
      transition: background var(--transicion);
    }

    .menu-toggle:focus-visible,
    .menu-toggle:hover {
      outline: none;
      background: rgba(255, 255, 255, 0.28);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      flex: 1 1 auto;
      min-height: 0;
    }

    nav {
      position: fixed;
      inset: 0 auto 0 0;
      width: min(320px, 92vw);
      background: linear-gradient(180deg, var(--color-primario) 0%, var(--color-primario-oscuro) 100%);
      box-shadow: 12px 0 32px rgba(7, 44, 104, 0.2);
      padding: 1.5rem 1.25rem 4rem;
      overflow-y: auto;
      transition: transform var(--transicion);
      z-index: 120;
      transform: translateX(-110%);
    }

    nav:focus {
      outline: 3px solid rgba(255, 255, 255, 0.45);
      outline-offset: -4px;
    }

    nav.abierto {
      transform: translateX(0);
    }

    .overlay-menu {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transicion);
      z-index: 110;
    }

    .overlay-menu.visible {
      opacity: 1;
      visibility: visible;
    }

    .nav-links {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.75rem;
    }

    .nav-links button {
      width: 100%;
      border-radius: 14px;
      padding: 0.85rem 1rem;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.1);
      color: #f3f6ff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background var(--transicion), border-color var(--transicion), transform var(--transicion);
    }

    .nav-links button:hover,
    .nav-links button:focus-visible,
    .nav-links button.activo {
      outline: none;
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.55);
      transform: translateX(2px);
    }

    .sub-lista {
      list-style: none;
      margin: 0;
      padding: 0 0 0 1.5rem;
      display: none;
      gap: 0.4rem;
    }

    .sub-lista.visible {
      display: grid;
    }

    main {
      width: min(100%, var(--max-ancho));
      margin: 0 auto;
      padding: 1.5rem 1rem 4rem;
      display: grid;
      gap: 2rem;
    }

    .seccion {
      background: var(--color-superficie);
      border-radius: var(--radio);
      padding: 1.5rem;
      box-shadow: var(--sombra);
    }

    .seccion h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      font-size: 1.6rem;
    }

    .panel-hero {
      background: linear-gradient(135deg, rgba(11, 61, 145, 0.95), rgba(76, 175, 80, 0.85));
      color: #fff;
      border-radius: var(--radio);
      padding: 1.25rem 1.5rem;
      box-shadow: var(--sombra);
      display: grid;
      gap: 1.25rem;
      grid-template-columns: minmax(0, 1fr);
      align-items: start;
    }

    .panel-hero .hero-contenido {
      display: grid;
      gap: 0.75rem;
      max-width: 52ch;
    }

    .panel-hero .hero-complementos {
      display: grid;
      gap: 1rem;
      align-self: stretch;
      align-content: start;
    }

    .panel-hero .acciones {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      border-radius: 14px;
      padding: 0.65rem 1.35rem;
      border: 2px solid transparent;
      font-weight: 600;
      transition: transform var(--transicion), box-shadow var(--transicion), background var(--transicion);
    }

    .btn:focus-visible {
      outline: 3px solid rgba(255, 255, 255, 0.7);
      outline-offset: 2px;
    }

    .btn-primario {
      background: var(--color-secundario);
      color: #fff;
      box-shadow: 0 12px 24px rgba(76, 175, 80, 0.25);
    }

    .btn-secundario {
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.45);
    }

    .btn-ghost {
      background: transparent;
      border-color: var(--color-borde);
      color: var(--color-primario);
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn.activo {
      background: var(--color-primario);
      color: #fff;
      border-color: var(--color-primario);
    }

    .btn.btn-sm {
      padding: 0.45rem 1rem;
      font-size: 0.9rem;
    }

    @media (min-width: 900px) {
      .panel-hero {
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
        align-items: stretch;
        padding: 1.5rem 1.75rem;
      }

      .panel-hero .hero-complementos {
        grid-template-rows: repeat(2, minmax(0, 1fr));
      }

      .hero-widget {
        min-height: 100%;
      }
    }

    .ideas-widget {
      display: grid;
      gap: 0.85rem;
      position: relative;
      background: linear-gradient(140deg, rgba(11, 61, 145, 0.92), rgba(76, 175, 80, 0.88));
      color: #fff;
      border-radius: var(--radio);
      padding: 1.25rem;
      box-shadow: var(--sombra);
      overflow: hidden;
    }

    .ideas-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .ideas-controles {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .ideas-controles button {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.45);
      background: rgba(255, 255, 255, 0.15);
      color: inherit;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background var(--transicion), transform var(--transicion);
    }

    .ideas-controles button:disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    .ideas-controles button:hover,
    .ideas-controles button:focus-visible {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
      outline: none;
    }

    .ideas-contenido {
      display: grid;
      gap: 0.85rem;
    }

    .ideas-imagen {
      border-radius: calc(var(--radio) - 6px);
      min-height: 160px;
      background: rgba(255, 255, 255, 0.12);
      background-size: cover;
      background-position: center;
      position: relative;
      overflow: hidden;
    }

    .ideas-imagen::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(5, 24, 68, 0) 0%, rgba(5, 24, 68, 0.55) 100%);
    }

    .ideas-texto {
      display: grid;
      gap: 0.5rem;
    }

    .ideas-texto h3 {
      margin: 0;
      font-size: 1.25rem;
    }

    .ideas-texto p {
      margin: 0;
      line-height: 1.4;
      color: rgba(255, 255, 255, 0.9);
    }

    .ideas-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .ideas-meta .tarjeta-valoracion {
      background: rgba(11, 61, 145, 0.55);
    }

    .ideas-progreso {
      position: absolute;
      left: 1.25rem;
      right: 1.25rem;
      bottom: 1.1rem;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 999px;
      overflow: hidden;
    }

    .ideas-progreso span {
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1), #fff);
      border-radius: inherit;
      transition: width 0.2s ease;
    }

    .seccion > header {
      margin-bottom: 1.25rem;
      display: grid;
      gap: 0.35rem;
    }

    .filtros-acciones {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 1rem;
    }

    .seccion-contenido {
      display: grid;
      gap: 1.5rem;
    }

    .panel-resultados {
      display: grid;
      gap: 1.5rem;
    }

    .panel-filtros {
      display: none;
    }

    .panel-filtros[data-abierto="true"] {
      display: grid;
    }

    .panel-filtros {
      position: fixed;
      inset: 0;
      z-index: 140;
      padding: 1.25rem;
      background: rgba(11, 22, 48, 0.55);
      backdrop-filter: blur(6px);
    }

    .panel-filtros .panel-filtros-contenido {
      background: var(--color-superficie);
      border-radius: var(--radio);
      margin: 0 auto;
      max-width: min(420px, 96vw);
      padding: 1.25rem;
      box-shadow: var(--sombra);
      display: grid;
      gap: 1.25rem;
      max-height: min(85vh, 560px);
      overflow-y: auto;
    }

    .panel-filtros-cabecera {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .panel-filtros-cabecera h3 {
      margin: 0;
      font-size: 1.1rem;
    }

    .panel-filtros-cerrar {
      border: none;
      background: transparent;
      color: var(--color-texto);
      font-size: 1.5rem;
      line-height: 1;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
    }

    .panel-filtros-cerrar:focus-visible,
    .panel-filtros-cerrar:hover {
      background: rgba(11, 61, 145, 0.12);
      outline: none;
    }

    .filtro-grupo {
      display: grid;
      gap: 0.5rem;
    }

    .filtro-grupo h4 {
      margin: 0;
      font-size: 1rem;
      color: var(--color-primario);
    }

    .filtro-grupo small {
      color: var(--color-texto-suave);
    }

    .filtro-estado {
      margin: 0;
      color: var(--color-texto-suave);
      font-size: 0.9rem;
    }

    .filtro-rating button,
    .filtro-cercania .btn {
      font-size: 0.85rem;
    }

    body.panel-filtros-abierto {
      overflow: hidden;
    }

    @media (min-width: 900px) {
      .filtros-acciones {
        display: none;
      }

      .seccion-contenido {
        grid-template-columns: minmax(240px, 300px) minmax(0, 1fr);
        align-items: start;
      }

      .panel-filtros {
        position: sticky;
        top: 6.5rem;
        display: grid;
        padding: 0;
        background: transparent;
        backdrop-filter: none;
        z-index: auto;
      }

      .panel-filtros[data-abierto="true"] {
        display: grid;
      }

      .panel-filtros .panel-filtros-contenido {
        margin: 0;
        max-width: none;
        max-height: none;
      }

      .panel-filtros-cerrar {
        display: none;
      }
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .chip {
      border-radius: 999px;
      padding: 0.4rem 0.85rem;
      border: 1px solid var(--color-borde);
      background: #fff;
      color: var(--color-texto);
      transition: background var(--transicion), border-color var(--transicion), color var(--transicion);
    }

    .chip:hover,
    .chip:focus-visible,
    .chip.activo {
      background: rgba(11, 61, 145, 0.12);
      border-color: var(--color-primario);
      color: var(--color-primario);
      outline: none;
    }

    .tarjetas {
      display: grid;
      gap: 1.25rem;
    }

    .tarjeta {
      background: #fff;
      border-radius: var(--radio);
      border: 1px solid var(--color-borde);
      box-shadow: 0 8px 18px rgba(11, 61, 145, 0.08);
      overflow: hidden;
      display: grid;
      gap: 0;
      position: relative;
    }

    .tarjeta.expanded {
      position: fixed;
      inset: 0;
      z-index: 150;
      max-width: none;
      border-radius: 0;
      box-shadow: 0 24px 48px rgba(7, 44, 104, 0.35);
      background: var(--color-superficie);
      grid-template-rows: minmax(0, 1fr);
    }

    .tarjeta.expanded .tarjeta-resumen {
      display: none;
    }

    .tarjeta.expanded .tarjeta-detalle {
      padding: min(4vw, 2rem);
      overflow-y: auto;
      max-height: 100vh;
      display: grid;
      gap: 1.25rem;
    }

    @media (min-width: 768px) {
      .tarjeta.expanded {
        inset: 1.5rem;
        border-radius: calc(var(--radio) + 8px);
      }
    }

    .tarjeta-resumen {
      display: block;
      border: none;
      background: none;
      padding: 0;
      cursor: pointer;
      text-align: left;
      position: relative;
    }

    .tarjeta-resumen:focus-visible {
      outline: 3px solid var(--color-secundario);
      outline-offset: -3px;
    }

    .tarjeta-resumen-imagen {
      position: relative;
      aspect-ratio: 16 / 10;
      background: #e5e9f5;
    }

    .tarjeta-resumen-imagen img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .tarjeta-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      background: linear-gradient(180deg, rgba(8, 26, 74, 0) 30%, rgba(8, 26, 74, 0.85) 100%);
      color: #fff;
      padding: 1rem;
      gap: 0.35rem;
    }

    .tarjeta-overlay h3 {
      margin: 0;
      font-size: 1.05rem;
    }

    .tarjeta-valoracion {
      display: inline-flex;
      gap: 0.4rem;
      align-items: center;
      font-weight: 600;
      color: #ffe082;
      background: rgba(8, 26, 74, 0.4);
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.95rem;
    }

    .tarjeta-valoracion small {
      font-weight: 500;
      color: rgba(255, 255, 255, 0.85);
    }

    .tarjeta-boton-editar {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.95);
      color: var(--color-primario);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      box-shadow: 0 10px 24px rgba(11, 61, 145, 0.18);
      transition: background var(--transicion), color var(--transicion), transform var(--transicion);
    }

    .tarjeta-boton-editar:hover,
    .tarjeta-boton-editar:focus-visible {
      background: var(--color-primario);
      color: #fff;
      transform: translateY(-1px);
      outline: none;
    }

    .tarjeta.expanded .tarjeta-boton-editar {
      display: none;
    }

    .tarjeta-detalle {
      display: grid;
      gap: 1rem;
      padding: 1.2rem;
      background: var(--color-superficie);
    }

    .tarjeta-detalle[hidden] {
      display: none;
    }

    .tarjeta-detalle header {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .tarjeta-detalle .tarjeta-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: var(--color-texto-suave);
    }

    .tarjeta-detalle .tarjeta-meta-direccion {
      font-weight: 600;
      color: var(--color-texto);
    }

    .tarjeta-detalle .tarjeta-meta-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      background: rgba(11, 61, 145, 0.12);
      color: var(--color-primario);
      font-weight: 600;
    }

    .tarjeta-detalle .tarjeta-descripcion {
      margin: 0;
      line-height: 1.6;
    }

    .tarjeta-detalle .etiquetas {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .tarjeta-detalle .etiqueta {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      background: rgba(11, 61, 145, 0.12);
      color: var(--color-primario);
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .tarjeta-galeria {
      display: grid;
      gap: 0.65rem;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .tarjeta-galeria img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 14px;
      background: #fff;
    }

    .tarjeta-volver {
      position: sticky;
      top: 0;
      left: 0;
      width: 48px;
      height: 48px;
      border-radius: 14px;
      border: none;
      background: var(--color-primario);
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.35rem;
      box-shadow: 0 12px 28px rgba(7, 44, 104, 0.35);
      margin-bottom: 0.5rem;
      z-index: 2;
    }

    .tarjeta-volver:focus-visible {
      outline: 3px solid rgba(255, 255, 255, 0.75);
      outline-offset: 2px;
    }

    .tarjeta-mapa iframe {
      width: 100%;
      min-height: 260px;
      border: 0;
      border-radius: 14px;
    }

    .tarjeta-acciones {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .tarjeta-navegacion {
      display: grid;
      gap: 0.75rem;
      align-items: start;
    }

    .navegacion-opciones {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .navegacion-opciones button {
      border-radius: 999px;
      border: 1px solid var(--color-borde);
      background: rgba(11, 61, 145, 0.06);
      color: var(--color-primario);
      padding: 0.3rem 0.9rem;
      font-size: 0.85rem;
      font-weight: 600;
      transition: background var(--transicion), color var(--transicion), border-color var(--transicion);
    }

    .navegacion-opciones button.activo {
      background: var(--color-primario);
      color: #fff;
      border-color: var(--color-primario);
    }

    .tarjeta-resenas {
      display: grid;
      gap: 0.75rem;
    }

    .detalle-reviews-controles {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: space-between;
    }

    .detalle-reviews-controles .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .orden-opciones {
      display: inline-flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .orden-opciones button {
      border-radius: 999px;
      border: 1px solid var(--color-borde);
      background: #fff;
      color: var(--color-texto);
      padding: 0.35rem 0.9rem;
      font-weight: 600;
      font-size: 0.9rem;
      transition: background var(--transicion), color var(--transicion), border-color var(--transicion);
    }

    .orden-opciones button.activo {
      background: var(--color-primario);
      border-color: var(--color-primario);
      color: #fff;
    }

    .detalle-reviews-lista {
      display: grid;
      gap: 0.75rem;
    }

    .detalle-resena {
      background: #fff;
      border-radius: 12px;
      border: 1px solid var(--color-borde);
      padding: 0.85rem 1rem;
      display: grid;
      gap: 0.45rem;
    }

    .detalle-resena figure {
      margin: 0;
      display: grid;
      gap: 0.5rem;
    }

    .detalle-resena img {
      width: 100%;
      max-height: 220px;
      object-fit: cover;
      border-radius: 12px;
    }

    .detalle-resena .rating {
      color: #ffb400;
      font-weight: 600;
    }

    .stars-selector {
      display: inline-flex;
      gap: 0.25rem;
      align-items: center;
    }

    .stars-selector button {
      border: none;
      background: none;
      font-size: 1.2rem;
      color: #d0d5e8;
      padding: 0.15rem;
      cursor: pointer;
      transition: color var(--transicion), transform var(--transicion);
    }

    .stars-selector button:hover,
    .stars-selector button:focus-visible {
      color: #ffb400;
      transform: scale(1.05);
      outline: none;
    }

    .stars-selector button.activo {
      color: #ffb400;
    }

    .rating-selector {
      display: inline-flex;
      gap: 0.35rem;
      align-items: center;
    }

    .rating-selector button {
      border: none;
      background: none;
      font-size: 1.6rem;
      color: #d0d5e8;
      padding: 0.2rem;
      cursor: pointer;
      transition: color var(--transicion), transform var(--transicion);
    }

    .rating-selector button:hover,
    .rating-selector button:focus-visible {
      color: #ffb400;
      transform: scale(1.1);
      outline: none;
    }

    .rating-selector button.activo {
      color: #ffb400;
    }

    .mensaje-ayuda {
      display: block;
      font-size: 0.85rem;
      color: var(--color-texto-suave);
      margin: 0.35rem 0;
    }

    .resena-imagenes {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .resena-imagenes img {
      width: 110px;
      height: 110px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid var(--color-borde);
    }

    .controles-rese√±as {
      margin: 1.5rem 0 1rem;
    }

    .controles-rese√±as .filtros {
      gap: 0.85rem;
    }

    .paginacion {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .paginacion button {
      min-width: 110px;
    }

    .lista-vacia {
      margin: 1rem 0 0;
      color: var(--color-texto-suave);
    }

    .eventos-lista {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.75rem;
    }

    .evento-item {
      background: rgba(11, 61, 145, 0.08);
      border-radius: 12px;
      padding: 0.75rem 0.85rem;
      display: grid;
      gap: 0.35rem;
    }

    .evento-item.destacado {
      border: 2px solid rgba(76, 175, 80, 0.5);
    }

    .evento-item strong {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.75rem;
    }

    .evento-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 999px;
      padding: 0.2rem 0.65rem;
      font-size: 0.75rem;
      background: rgba(255, 255, 255, 0.85);
      color: var(--color-primario);
      font-weight: 600;
    }

    .evento-badge[data-tipo="fiesta_local"] {
      background: rgba(76, 175, 80, 0.2);
      color: #1b5e20;
    }

    .evento-badge[data-tipo="no_laborable"] {
      background: rgba(244, 67, 54, 0.25);
      color: #7f0000;
    }

    .evento-badge[data-tipo="no_lectivo"] {
      background: rgba(255, 193, 7, 0.25);
      color: #7c4a03;
    }

    .widget-clima,
    .widget-mapa {
      display: grid;
      gap: 0.75rem;
    }

    .hero-widget {
      background: rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      padding: 1rem;
      backdrop-filter: blur(4px);
      display: grid;
      gap: 0.65rem;
    }

    .hero-widget strong {
      font-size: 1.05rem;
    }

    .widget-clima .clima-actual {
      display: grid;
      gap: 0.35rem;
    }

    .clima-pronostico {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.4rem;
    }

    .clima-pronostico li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.9rem;
    }

    .clima-pronostico span {
      opacity: 0.9;
    }

    .widget-mapa iframe {
      width: 100%;
      min-height: 320px;
      border: 0;
      border-radius: var(--radio);
    }

    .rese√±as {
      display: grid;
      gap: 1.25rem;
    }

    .rese√±a {
      border-radius: 16px;
      background: #fff;
      padding: 1rem;
      border: 1px solid var(--color-borde);
      box-shadow: 0 8px 18px rgba(11, 61, 145, 0.08);
      display: grid;
      gap: 0.5rem;
    }

    .rese√±a strong {
      font-size: 1.05rem;
    }

    .rating {
      color: #ffb400;
      font-size: 1.1rem;
    }

    .formulario {
      display: grid;
      gap: 0.75rem;
    }

    .formulario label {
      font-weight: 600;
    }

    .formulario input,
    .formulario textarea,
    .formulario select {
      border-radius: 12px;
      border: 1px solid var(--color-borde);
      background: #fff;
      padding: 0.65rem 0.85rem;
    }

    .mensaje-error {
      color: var(--color-alerta);
      font-size: 0.9rem;
    }

    .toast {
      position: fixed;
      inset: auto 1rem 1rem 1rem;
      background: rgba(7, 44, 104, 0.95);
      color: #fff;
      padding: 0.85rem 1.2rem;
      border-radius: 12px;
      box-shadow: 0 12px 24px rgba(11, 61, 145, 0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transicion), transform var(--transicion);
      transform: translateY(12px);
      z-index: 200;
    }

    .toast.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      opacity: 0;
      transition: opacity var(--transicion);
      z-index: 250;
    }

    .modal.visible {
      display: flex;
      opacity: 1;
    }

    .modal-dialogo {
      background: var(--color-fondo);
      color: var(--color-texto);
      border-radius: 22px;
      width: min(540px, 100%);
      padding: 1.75rem;
      display: grid;
      gap: 1rem;
      position: relative;
      box-shadow: 0 24px 48px rgba(11, 61, 145, 0.25);
    }

    .modal-cerrar {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      font-size: 1.5rem;
    }

    .consent-banner {
      position: fixed;
      inset: auto 0 0 0;
      background: #fff;
      border-top: 1px solid var(--color-borde);
      box-shadow: 0 -8px 18px rgba(0, 0, 0, 0.12);
      padding: 1.25rem;
      display: none;
      gap: 1rem;
      z-index: 260;
    }

    .consent-banner.visible {
      display: grid;
    }

    .calendario {
      display: grid;
      gap: 1rem;
    }

    .calendario-controles {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .calendario-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }

    .dia-calendario {
      background: rgba(11, 61, 145, 0.06);
      border-radius: 12px;
      min-height: 82px;
      padding: 0.35rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      font-size: 0.85rem;
    }

    .dia-calendario.evento {
      background: rgba(76, 175, 80, 0.2);
    }

    .dia-calendario.evento[data-tipo="no_laborable"] {
      background: rgba(244, 67, 54, 0.3);
      color: #fff;
    }

    .dia-calendario.evento[data-tipo="no_lectivo"] {
      background: rgba(255, 193, 7, 0.35);
    }

    .ajustes-permisos {
      display: grid;
      gap: 1rem;
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    footer {
      margin-top: auto;
      background: var(--color-primario-oscuro);
      color: #fff;
      padding: 1.5rem 1rem;
      text-align: center;
    }

    .header-texto {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      min-width: 220px;
    }

    .acciones-header {
      margin-left: auto;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    body.alto-contraste {
      --color-fondo: #000000;
      --color-superficie: #0f172a;
      --color-primario: #111827;
      --color-primario-oscuro: #0b1120;
      --color-secundario: #22c55e;
      --color-texto: #f9fafb;
      --color-texto-suave: #d1d5db;
      --color-borde: rgba(255, 255, 255, 0.4);
      background: var(--color-fondo);
      color: var(--color-texto);
    }

    body.texto-grande {
      font-size: 1.1rem;
    }

    body.espaciado-amplio {
      line-height: 1.7;
      letter-spacing: 0.015em;
    }

    body.modo-senior {
      font-size: 1.08rem;
    }

    body.botones-amplios .btn {
      padding: 0.85rem 1.65rem;
      font-size: 1.05rem;
    }

    body.lectura-facil p {
      font-size: 1.02rem;
      line-height: 1.7;
    }

    body.modo-visibilidad *:focus-visible {
      outline: 3px solid var(--color-aviso) !important;
      outline-offset: 2px;
    }

    body.modo-visibilidad .btn {
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.35);
    }

    .grupo-opcion.is-disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .toggle.is-disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    body.links-subrayados a {
      text-decoration: underline;
      text-decoration-thickness: 0.15em;
    }

    body.modo-oscuro {
      --color-fondo: #0e1526;
      --color-superficie: #17213a;
      --color-primario: #1d4ed8;
      --color-primario-oscuro: #1e3a8a;
      --color-secundario: #22d3ee;
      --color-texto: #f8fafc;
      --color-texto-suave: #cbd5f5;
      --color-borde: rgba(255, 255, 255, 0.2);
    }

    .panel-accesibilidad {
      display: grid;
      gap: 1rem;
    }

    .panel-accesibilidad .grupo-opcion {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .panel-login-inicio {
      display: grid;
      gap: 0.75rem;
    }

    .panel-login-inicio .botonera {
      display: grid;
      gap: 0.5rem;
    }

    .panel-login-inicio .botonera button {
      justify-content: flex-start;
    }

    .panel-login-inicio small {
      color: var(--color-texto-suave);
    }

    .btn-icono {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .grupo-coordenadas {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      align-items: end;
    }

    .grupo-coordenadas .btn {
      align-self: stretch;
    }

    .btn-icono img {
      width: 20px;
      height: 20px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @media (max-width: 960px) {
      nav {
        width: min(360px, 100vw);
      }
    }

    @media (min-width: 900px) {
      .panel-hero {
        grid-template-columns: 3fr 2fr;
      }

      .panel-hero .hero-complementos {
        align-self: stretch;
      }
    }

    @media (max-width: 640px) {
      header {
        gap: 0.75rem;
      }

      .header-texto h1 {
        font-size: 1.2rem;
      }

      .header-texto p {
        font-size: 0.85rem;
      }

      .acciones-header {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <header aria-label="Barra superior de navegaci√≥n">
    <button class="menu-toggle" aria-expanded="false" aria-controls="menuLateral" id="btnToggleMenu">‚ò∞</button>
    <img src="assets/lugar-iglesia.svg" alt="Escudo estilizado de San Mart√≠n de la Vega" width="42" height="42" loading="lazy">
    <div class="header-texto">
      <h1 style="margin:0;font-size:1.4rem;">Turismo San Mart√≠n de la Vega</h1>
      <p style="margin:0;font-size:0.9rem;opacity:0.85;">Descubre cultura, gastronom√≠a y naturaleza</p>
    </div>
    <div class="acciones-header">
      <button class="btn btn-ghost" id="btnLogin" type="button">Iniciar sesi√≥n</button>
      <button class="btn btn-ghost" id="btnLogout" type="button" hidden>Cerrar sesi√≥n</button>
    </div>
  </header>

  <div class="overlay-menu" id="overlayMenu" role="presentation"></div>

  <div class="layout">
    <nav id="menuLateral" aria-label="Men√∫ principal" tabindex="-1" aria-hidden="true">
      <ul class="nav-links" id="listaMenu">
        <li><button type="button" data-seccion="inicio" class="activo" aria-controls="seccionInicio" aria-expanded="true">üè† Inicio</button></li>
        <li>
          <button type="button" data-seccion="lugares" aria-controls="seccionLugares" aria-expanded="false">üìç Lugares</button>
          <ul class="sub-lista" data-parent="lugares">
            <li><button type="button" data-tag="todos">Todos</button></li>
            <li><button type="button" data-tag="naturaleza">Naturaleza</button></li>
            <li><button type="button" data-tag="cultural">Patrimonio</button></li>
            <li><button type="button" data-tag="familia">Plan familiar</button></li>
          </ul>
        </li>
        <li>
          <button type="button" data-seccion="restaurantes" aria-controls="seccionRestaurantes" aria-expanded="false">üçΩÔ∏è Gastronom√≠a</button>
          <ul class="sub-lista" data-parent="restaurantes">
            <li><button type="button" data-tag="todos">Todos</button></li>
            <li><button type="button" data-tag="tradicional">Tradicional</button></li>
            <li><button type="button" data-tag="tapas">Tapas y ocio</button></li>
            <li><button type="button" data-tag="asador">Asador</button></li>
            <li><button type="button" data-tag="terraza">Terraza</button></li>
            <li><button type="button" data-tag="veg-friendly">Opci√≥n veg-friendly</button></li>
            <li><button type="button" data-tag="sin-gluten">Sin gluten</button></li>
            <li><button type="button" data-tag="km0">Producto local</button></li>
          </ul>
        </li>
        <li>
          <button type="button" data-seccion="ocio" aria-controls="seccionOcio" aria-expanded="false">üö¥ Ocio activo</button>
          <ul class="sub-lista" data-parent="ocio">
            <li><button type="button" data-tag="todos">Todos</button></li>
            <li><button type="button" data-tag="aventura">Aventura</button></li>
            <li><button type="button" data-tag="agua">Acu√°tico</button></li>
          </ul>
        </li>
        <li><button type="button" data-seccion="historia" aria-controls="seccionHistoria" aria-expanded="false">üìú Historia</button></li>
        <li><button type="button" data-seccion="eventos" aria-controls="seccionEventos" aria-expanded="false">üóìÔ∏è Eventos</button></li>
        <li><button type="button" data-seccion="rese√±as" aria-controls="seccionResenas" aria-expanded="false">‚≠ê Rese√±as</button></li>
        <li><button type="button" data-seccion="mapa" aria-controls="seccionMapa" aria-expanded="false">üó∫Ô∏è Mapa</button></li>
        <li><button type="button" data-seccion="clima" aria-controls="seccionClima" aria-expanded="false">‚òÄÔ∏è Clima</button></li>
        <li><button type="button" data-seccion="ajustes" aria-controls="seccionAjustes" aria-expanded="false">‚öôÔ∏è Ajustes</button></li>
        <li><button type="button" data-seccion="admin" aria-controls="seccionAdmin" aria-expanded="false" id="btnMenuAdmin" hidden>üõ†Ô∏è Administraci√≥n</button></li>
      </ul>
    </nav>

    <main id="contenidoPrincipal">
      <section id="seccionInicio" class="panel-hero" data-seccion="inicio">
        <div class="hero-contenido">
          <h2>Planifica tu visita de forma segura</h2>
          <p>Explora rutas naturales, reserva actividades y comparte rese√±as verificadas. La informaci√≥n se actualiza desde nuestro equipo municipal y colaboradores locales.</p>
          <div class="acciones">
            <button type="button" class="btn btn-primario" data-ir="seccionLugares">Ver lugares destacados</button>
            <button type="button" class="btn btn-secundario" data-ir="seccionEventos">Calendario cultural</button>
          </div>
        </div>
        <div class="hero-complementos">
          <aside class="widget-clima hero-widget" aria-live="polite" id="widgetClimaHero">
            <strong>Clima local</strong>
            <div class="clima-actual" id="climaContenido">
              <p>Consultando informaci√≥n meteorol√≥gica‚Ä¶</p>
            </div>
            <ul class="clima-pronostico" id="climaPronostico"></ul>
            <button type="button" class="btn btn-ghost btn-sm" id="btnActualizarClima">Actualizar clima</button>
          </aside>
          <aside class="hero-widget ideas-widget" id="widgetDestacado" aria-live="polite">
            <div class="ideas-header">
              <strong>Ideas</strong>
              <div class="ideas-controles" aria-hidden="true">
                <button type="button" disabled aria-label="Idea anterior">‚óÄ</button>
                <button type="button" disabled aria-label="Idea siguiente">‚ñ∂</button>
              </div>
            </div>
            <p>Reuniremos aqu√≠ las mejores propuestas en cuanto tengamos suficientes valoraciones.</p>
            <div class="ideas-progreso" aria-hidden="true"><span></span></div>
          </aside>
        </div>
      </section>

      <section id="seccionLugares" class="seccion" data-seccion="lugares" hidden>
        <header>
          <h2>Lugares imprescindibles</h2>
          <p>Selecciona un filtro para acotar los resultados. Se muestran 20 elementos por p√°gina.</p>
        </header>
        <div class="filtros-acciones">
          <button type="button" class="btn btn-ghost btn-filtros" data-filtro-toggle="lugares">üéØ Filtros</button>
        </div>
        <div class="seccion-contenido">
          <aside class="panel-filtros" data-filtros-panel="lugares" aria-label="Filtros para lugares">
            <div class="panel-filtros-contenido">
              <div class="panel-filtros-cabecera">
                <h3>Personaliza tu b√∫squeda</h3>
                <button type="button" class="panel-filtros-cerrar" data-filtro-close="lugares" aria-label="Cerrar filtros">√ó</button>
              </div>
              <div class="filtro-grupo">
                <h4>Etiquetas</h4>
                <div class="chips" role="listbox" aria-label="Filtrar lugares" id="chipsLugares"></div>
              </div>
              <div class="filtro-grupo">
                <h4>Puntuaci√≥n m√≠nima</h4>
                <div class="orden-opciones filtro-rating" data-filtro-rating="lugares" role="group" aria-label="Filtrar por valoraci√≥n">
                  <button type="button" data-valor="0" class="activo">Todas</button>
                  <button type="button" data-valor="4">4+</button>
                  <button type="button" data-valor="4.5">4.5+</button>
                  <button type="button" data-valor="5">5</button>
                </div>
              </div>
              <div class="filtro-grupo">
                <h4>Cercan√≠a</h4>
                <p class="filtro-estado" data-estado-cercania="lugares">Ubicaci√≥n no solicitada.</p>
                <div class="orden-opciones filtro-cercania">
                  <button type="button" class="btn btn-ghost btn-sm" data-filtro-cercania="lugares">Usar mi ubicaci√≥n</button>
                  <button type="button" class="btn btn-ghost btn-sm" data-filtro-cercania-off="lugares">Quitar</button>
                </div>
                <small>Mostramos lugares a menos de 15 km de tu posici√≥n.</small>
              </div>
              <div class="filtro-grupo">
                <h4>Ordenar por</h4>
                <div class="orden-opciones" data-filtro-orden="lugares" role="group" aria-label="Ordenar resultados">
                  <button type="button" data-orden="nombre" class="activo">Nombre</button>
                  <button type="button" data-orden="valoracion">Mejor valoraci√≥n</button>
                  <button type="button" data-orden="cercania">M√°s cercanos</button>
                </div>
              </div>
            </div>
          </aside>
          <div class="panel-resultados">
            <div class="tarjetas" id="listaLugares" aria-live="polite"></div>
          </div>
        </div>
        <div class="paginacion">
          <button type="button" class="btn btn-ghost" data-prev="lugares">Anterior</button>
          <span id="estadoLugares" aria-live="polite"></span>
          <button type="button" class="btn btn-ghost" data-next="lugares">Siguiente</button>
        </div>
      </section>

      <section id="seccionRestaurantes" class="seccion" data-seccion="restaurantes" hidden>
        <header>
          <h2>D√≥nde comer</h2>
          <p>Encuentra propuestas gastron√≥micas seg√∫n tu estilo.</p>
        </header>
        <div class="filtros-acciones">
          <button type="button" class="btn btn-ghost btn-filtros" data-filtro-toggle="restaurantes">üéØ Filtros</button>
        </div>
        <div class="seccion-contenido">
          <aside class="panel-filtros" data-filtros-panel="restaurantes" aria-label="Filtros para restaurantes">
            <div class="panel-filtros-contenido">
              <div class="panel-filtros-cabecera">
                <h3>Elige tus preferencias</h3>
                <button type="button" class="panel-filtros-cerrar" data-filtro-close="restaurantes" aria-label="Cerrar filtros">√ó</button>
              </div>
              <div class="filtro-grupo">
                <h4>Etiquetas</h4>
                <div class="chips" role="listbox" aria-label="Filtrar restaurantes" id="chipsRestaurantes"></div>
              </div>
              <div class="filtro-grupo">
                <h4>Puntuaci√≥n m√≠nima</h4>
                <div class="orden-opciones filtro-rating" data-filtro-rating="restaurantes" role="group" aria-label="Filtrar por valoraci√≥n">
                  <button type="button" data-valor="0" class="activo">Todas</button>
                  <button type="button" data-valor="4">4+</button>
                  <button type="button" data-valor="4.5">4.5+</button>
                  <button type="button" data-valor="5">5</button>
                </div>
              </div>
              <div class="filtro-grupo">
                <h4>Cercan√≠a</h4>
                <p class="filtro-estado" data-estado-cercania="restaurantes">Ubicaci√≥n no solicitada.</p>
                <div class="orden-opciones filtro-cercania">
                  <button type="button" class="btn btn-ghost btn-sm" data-filtro-cercania="restaurantes">Usar mi ubicaci√≥n</button>
                  <button type="button" class="btn btn-ghost btn-sm" data-filtro-cercania-off="restaurantes">Quitar</button>
                </div>
                <small>Te proponemos mesas a menos de 15 km cuando activas la cercan√≠a.</small>
              </div>
              <div class="filtro-grupo">
                <h4>Ordenar por</h4>
                <div class="orden-opciones" data-filtro-orden="restaurantes" role="group" aria-label="Ordenar resultados">
                  <button type="button" data-orden="nombre" class="activo">Nombre</button>
                  <button type="button" data-orden="valoracion">Mejor valoraci√≥n</button>
                  <button type="button" data-orden="cercania">M√°s cercanos</button>
                </div>
              </div>
            </div>
          </aside>
          <div class="panel-resultados">
            <div class="tarjetas" id="listaRestaurantes" aria-live="polite"></div>
          </div>
        </div>
        <div class="paginacion">
          <button type="button" class="btn btn-ghost" data-prev="restaurantes">Anterior</button>
          <span id="estadoRestaurantes" aria-live="polite"></span>
          <button type="button" class="btn btn-ghost" data-next="restaurantes">Siguiente</button>
        </div>
      </section>

      <section id="seccionOcio" class="seccion" data-seccion="ocio" hidden>
        <header>
          <h2>Ocio y naturaleza</h2>
          <p>Actividades deportivas y planes en la vega del Jarama.</p>
        </header>
        <div class="filtros-acciones">
          <button type="button" class="btn btn-ghost btn-filtros" data-filtro-toggle="ocio">üéØ Filtros</button>
        </div>
        <div class="seccion-contenido">
          <aside class="panel-filtros" data-filtros-panel="ocio" aria-label="Filtros para ocio">
            <div class="panel-filtros-contenido">
              <div class="panel-filtros-cabecera">
                <h3>Refina tus planes</h3>
                <button type="button" class="panel-filtros-cerrar" data-filtro-close="ocio" aria-label="Cerrar filtros">√ó</button>
              </div>
              <div class="filtro-grupo">
                <h4>Etiquetas</h4>
                <div class="chips" role="listbox" aria-label="Filtrar ocio" id="chipsOcio"></div>
              </div>
              <div class="filtro-grupo">
                <h4>Puntuaci√≥n m√≠nima</h4>
                <div class="orden-opciones filtro-rating" data-filtro-rating="ocio" role="group" aria-label="Filtrar por valoraci√≥n">
                  <button type="button" data-valor="0" class="activo">Todas</button>
                  <button type="button" data-valor="4">4+</button>
                  <button type="button" data-valor="4.5">4.5+</button>
                  <button type="button" data-valor="5">5</button>
                </div>
              </div>
              <div class="filtro-grupo">
                <h4>Cercan√≠a</h4>
                <p class="filtro-estado" data-estado-cercania="ocio">Ubicaci√≥n no solicitada.</p>
                <div class="orden-opciones filtro-cercania">
                  <button type="button" class="btn btn-ghost btn-sm" data-filtro-cercania="ocio">Usar mi ubicaci√≥n</button>
                  <button type="button" class="btn btn-ghost btn-sm" data-filtro-cercania-off="ocio">Quitar</button>
                </div>
                <small>Mostramos experiencias a menos de 15 km de donde te encuentras.</small>
              </div>
              <div class="filtro-grupo">
                <h4>Ordenar por</h4>
                <div class="orden-opciones" data-filtro-orden="ocio" role="group" aria-label="Ordenar resultados">
                  <button type="button" data-orden="nombre" class="activo">Nombre</button>
                  <button type="button" data-orden="valoracion">Mejor valoraci√≥n</button>
                  <button type="button" data-orden="cercania">M√°s cercanos</button>
                </div>
              </div>
            </div>
          </aside>
          <div class="panel-resultados">
            <div class="tarjetas" id="listaOcio" aria-live="polite"></div>
          </div>
        </div>
        <div class="paginacion">
          <button type="button" class="btn btn-ghost" data-prev="ocio">Anterior</button>
          <span id="estadoOcio" aria-live="polite"></span>
          <button type="button" class="btn btn-ghost" data-next="ocio">Siguiente</button>
        </div>
      </section>

      <section id="seccionHistoria" class="seccion" data-seccion="historia" hidden>
        <h2>Historia local</h2>
        <div class="tarjetas" id="listaHistoria" aria-live="polite"></div>
      </section>

      <section id="seccionEventos" class="seccion" data-seccion="eventos" hidden>
        <h2>Calendario municipal</h2>
        <div class="calendario" aria-live="polite">
          <div class="calendario-controles">
            <label for="selectMes">Mes</label>
            <select id="selectMes" aria-label="Seleccionar mes"></select>
            <label for="selectAnio">A√±o</label>
            <select id="selectAnio" aria-label="Seleccionar a√±o"></select>
          </div>
          <div class="calendario-grid" id="gridCalendario"></div>
          <div id="detalleEventos" aria-live="polite"></div>
        </div>
      </section>

      <section id="seccionResenas" class="seccion" data-seccion="rese√±as" hidden>
        <h2>Rese√±as verificadas</h2>
        <form class="formulario" id="formResena">
          <div>
            <label for="inputTitulo">T√≠tulo</label>
            <input id="inputTitulo" name="titulo" maxlength="60" required aria-describedby="ayudaTitulo">
            <p id="ayudaTitulo" class="mensaje-error" hidden>El t√≠tulo es obligatorio (1-60 caracteres).</p>
          </div>
          <div>
            <label for="inputTexto">Tu experiencia</label>
            <textarea id="inputTexto" name="texto" maxlength="2000" required aria-describedby="ayudaTexto"></textarea>
            <p id="ayudaTexto" class="mensaje-error" hidden>Describe la experiencia (1-2000 caracteres).</p>
          </div>
          <div>
            <span id="labelRating">Valoraci√≥n</span>
            <div class="rating-selector" id="ratingSelector" role="radiogroup" aria-labelledby="labelRating">
              <button type="button" data-valor="1" aria-label="1 estrella">‚òÖ</button>
              <button type="button" data-valor="2" aria-label="2 estrellas">‚òÖ</button>
              <button type="button" data-valor="3" aria-label="3 estrellas">‚òÖ</button>
              <button type="button" data-valor="4" aria-label="4 estrellas">‚òÖ</button>
              <button type="button" data-valor="5" aria-label="5 estrellas">‚òÖ</button>
            </div>
            <input type="hidden" id="inputRating" name="rating" value="5">
            <p class="mensaje-error" id="ayudaRating" hidden>Selecciona una puntuaci√≥n entre 1 y 5.</p>
          </div>
          <div>
            <label for="inputFotos">A√±ade fotos (opcional)</label>
            <input id="inputFotos" name="imagenes" type="file" accept="image/*" capture="environment" multiple aria-describedby="ayudaFotos">
            <small class="mensaje-ayuda">Puedes adjuntar hasta 3 im√°genes JPG o PNG.</small>
            <p id="ayudaFotos" class="mensaje-error" hidden>Las im√°genes deben respetar las normas de contenido.</p>
            <div class="resena-imagenes" id="previewFotos" aria-live="polite"></div>
          </div>
          <button type="submit" class="btn btn-primario">Enviar rese√±a</button>
        </form>
        <div class="detalle-reviews-controles controles-rese√±as">
          <div class="filtros">
            <div class="orden-opciones" id="ordenResenas" role="group" aria-label="Ordenar rese√±as">
              <button type="button" data-orden="recomendadas" class="activo">Recomendadas</button>
              <button type="button" data-orden="recientes">M√°s recientes</button>
              <button type="button" data-orden="mejores">Mejor valoradas</button>
              <button type="button" data-orden="peores">Peor valoradas</button>
              <button type="button" data-orden="imagenes">Solo con im√°genes</button>
            </div>
            <div class="stars-selector" id="filtroEstrellasGlobal" aria-label="Filtrar rese√±as por estrellas">
              <button type="button" data-valor="1" aria-label="1 estrella">‚òÖ</button>
              <button type="button" data-valor="2" aria-label="2 estrellas">‚òÖ</button>
              <button type="button" data-valor="3" aria-label="3 estrellas">‚òÖ</button>
              <button type="button" data-valor="4" aria-label="4 estrellas">‚òÖ</button>
              <button type="button" data-valor="5" aria-label="5 estrellas">‚òÖ</button>
            </div>
            <label class="toggle"><input type="checkbox" id="toggleSoloImagenes"> Solo rese√±as con fotos</label>
          </div>
          <span id="resumenResenasGlobal">Sin filtros aplicados</span>
        </div>
        <div class="rese√±as" id="listaResenas" aria-live="polite"></div>
        <div class="paginacion">
          <button type="button" class="btn btn-ghost" data-prev="rese√±as">Anterior</button>
          <span id="estadoResenas" aria-live="polite"></span>
          <button type="button" class="btn btn-ghost" data-next="rese√±as">Siguiente</button>
        </div>
      </section>

      <section id="seccionMapa" class="seccion" data-seccion="mapa" hidden>
        <h2>Mapa y rutas</h2>
        <div class="widget-mapa">
          <p>Consulta la localizaci√≥n principal. Para rutas concretas habilita la capa en Google Maps.</p>
          <iframe id="iframeMapa" title="Mapa de San Mart√≠n de la Vega" loading="lazy" referrerpolicy="no-referrer" allowfullscreen
            src="https://www.google.com/maps?q=40.20732,-3.57013&output=embed"></iframe>
          <button type="button" class="btn btn-primario" id="btnDescargarGPX" hidden>Descargar ruta GPX</button>
        </div>
      </section>

      <section id="seccionClima" class="seccion" data-seccion="clima" hidden>
        <h2>Clima local</h2>
        <div class="widget-clima" id="widgetClimaDetalle" aria-live="polite">
          <div class="clima-actual" id="climaContenidoDetalle">
            <p>Consultando informaci√≥n meteorol√≥gica‚Ä¶</p>
          </div>
          <ul class="clima-pronostico" id="climaPronosticoDetalle"></ul>
          <button type="button" class="btn btn-ghost btn-sm" id="btnActualizarClimaDetalle">Actualizar clima</button>
        </div>
      </section>

      <section id="seccionAjustes" class="seccion" data-seccion="ajustes" hidden>
        <h2>Accesibilidad y cuenta</h2>
        <div class="ajustes-permisos">
          <div>
            <p>Configura la visualizaci√≥n seg√∫n tus necesidades. Los cambios se guardan solo en este dispositivo.</p>
            <div class="panel-accesibilidad">
              <article class="grupo-opcion">
                <h3>Temas y animaciones</h3>
                <p>Adapta la gu√≠a seg√∫n la iluminaci√≥n del entorno o si prefieres minimizar efectos.</p>
                <label class="toggle"><input type="checkbox" id="toggleModoOscuro"> Activar tema oscuro</label>
                <label class="toggle"><input type="checkbox" id="toggleContraste"> Alto contraste</label>
                <label class="toggle"><input type="checkbox" id="toggleReducir"> Reducir animaciones</label>
              </article>
              <article class="grupo-opcion">
                <h3>Modo tercera edad</h3>
                <p>Incrementa fuentes, contraste y tama√±o de botones para mejorar la legibilidad.</p>
                <label class="toggle"><input type="checkbox" id="toggleModoSenior"> Activar modo tercera edad</label>
                <div id="panelSeniorOpciones" style="display:grid;gap:0.35rem;margin-top:0.65rem;">
                  <label class="toggle"><input type="checkbox" id="toggleTexto" data-senior-control> Texto ampliado</label>
                  <label class="toggle"><input type="checkbox" id="toggleEspaciado" data-senior-control> Espaciado adicional</label>
                  <label class="toggle"><input type="checkbox" id="toggleBotones" data-senior-control> Botones m√°s grandes</label>
                </div>
              </article>
              <article class="grupo-opcion">
                <h3>Accesibilidad lectora</h3>
                <p>Personaliza la tipograf√≠a y simplifica los contenidos para una lectura relajada.</p>
                <label class="toggle"><input type="checkbox" id="toggleFuente"> Fuente adaptada para dislexia</label>
                <label class="toggle"><input type="checkbox" id="toggleLecturaFacil"> Activar modo lectura f√°cil</label>
              </article>
              <article class="grupo-opcion">
                <h3>Apoyos de visibilidad</h3>
                <p>Resalta enlaces y elementos interactivos para identificarlos r√°pidamente.</p>
                <label class="toggle"><input type="checkbox" id="toggleLinks"> Subrayar enlaces</label>
                <label class="toggle"><input type="checkbox" id="toggleVisibilidad"> Resaltar elementos interactivos</label>
              </article>
            </div>
          </div>
          <div>
            <h3>Gesti√≥n de cuenta</h3>
            <p>Estas acciones requieren que hayas iniciado sesi√≥n. Nunca compartiremos tus credenciales.</p>
            <fieldset id="panelCuenta" style="border:none;padding:0;display:grid;gap:1rem;" disabled>
              <legend class="sr-only">Ajustes de la cuenta</legend>
              <form class="formulario" id="formPerfil">
                <label>
                  Nombre para mostrar
                  <input type="text" name="displayName" id="inputDisplayName" maxlength="60" autocomplete="name" placeholder="Ej. Daniel Terroba Alcala">
                </label>
                <button type="submit" class="btn btn-primario">Guardar nombre</button>
              </form>
              <form class="formulario" id="formPassword">
                <label>
                  Nueva contrase√±a
                  <input type="password" name="password" id="inputNuevaPassword" minlength="8" autocomplete="new-password" required>
                </label>
                <button type="submit" class="btn btn-ghost">Actualizar contrase√±a</button>
              </form>
              <div style="display:flex;flex-wrap:wrap;gap:0.5rem;">
                <button type="button" class="btn btn-ghost" id="btnVerificarCorreo">Enviar verificaci√≥n</button>
                <button type="button" class="btn btn-ghost" id="btnCerrarSesiones">Cerrar otras sesiones</button>
                <button type="button" class="btn btn-ghost" id="btnEliminarCuenta">Eliminar cuenta</button>
              </div>
              <p id="estadoCuenta" class="mensaje-error" hidden></p>
            </fieldset>
          </div>
        </div>
      </section>

      <section id="seccionAdmin" class="seccion" data-seccion="admin" hidden>
        <h2>Panel administrativo</h2>
        <p>Disponible solo para cuentas con rol <code>admin</code> (custom claims).</p>
        <button type="button" class="btn btn-primario" id="btnAbrirModalAdmin">Crear contenido</button>
        <ul id="listaAdmin" style="margin:1rem 0 0;padding:0;list-style:none;display:grid;gap:0.75rem;"></ul>
        <div style="margin-top:1.5rem;display:grid;gap:0.75rem;">
          <h3 style="margin:0;">Moderaci√≥n y seguridad</h3>
          <form id="formBan" class="formulario" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));align-items:end;gap:0.75rem;">
            <label style="flex:1;">
              IP a bloquear
              <input type="text" name="ip" id="inputBanIp" placeholder="Ej. 192.168.1.10" pattern="^(?:\d{1,3}\.){3}\d{1,3}$">
            </label>
            <button type="submit" class="btn btn-ghost">Bloquear IP</button>
          </form>
          <div>
            <p style="margin:0 0 0.5rem;">IPs bloqueadas (se aplican tambi√©n a invitados):</p>
            <ul id="listaBaneados" style="list-style:none;padding:0;display:grid;gap:0.5rem;"></ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <div class="modal" id="modalBienvenida" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalBienvenida">
      <button type="button" class="modal-cerrar" id="btnCerrarModalBienvenida" aria-label="Cerrar">√ó</button>
      <h3 id="tituloModalBienvenida">Configura tu experiencia</h3>
      <div class="panel-accesibilidad">
        <div class="grupo-opcion">
          <label class="toggle"><input type="checkbox" id="initContraste"> Alto contraste</label>
          <small>Mejora la visibilidad de los textos y botones.</small>
        </div>
        <div class="grupo-opcion">
          <label class="toggle"><input type="checkbox" id="initTexto"> Texto ampliado</label>
          <small>Aumenta el tama√±o base de la letra.</small>
        </div>
        <div class="grupo-opcion">
          <label class="toggle"><input type="checkbox" id="initEspaciado"> Espaciado adicional</label>
          <small>M√°s espacio entre l√≠neas para leer con calma.</small>
        </div>
        <div class="grupo-opcion">
          <label class="toggle"><input type="checkbox" id="initLinks"> Subrayar enlaces</label>
          <small>Resalta todos los enlaces disponibles.</small>
        </div>
      </div>
      <div class="panel-login-inicio">
        <h4 style="margin:0;">Elige c√≥mo quieres acceder</h4>
        <div class="botonera">
          <button type="button" class="btn btn-primario btn-icono" id="btnLoginCorreo">
            <span>üìß</span> Iniciar sesi√≥n con correo
          </button>
          <button type="button" class="btn btn-ghost btn-icono" id="btnLoginGoogle">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="">
            Continuar con Google
          </button>
          <button type="button" class="btn btn-ghost btn-icono" id="btnLoginFacebook" style="display:none;" aria-hidden="true">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/facebook.svg" alt="">
            Continuar con Facebook
          </button>
          <button type="button" class="btn btn-ghost" id="btnInvitado">Entrar como invitado</button>
        </div>
        <small>Puedes cerrar esta ventana si prefieres explorar como invitado.</small>
      </div>
    </div>
  </div>

  <div class="modal" id="modalLogin" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalLogin">
      <button type="button" class="modal-cerrar" id="btnCerrarModalLogin" aria-label="Cerrar">√ó</button>
      <h3 id="tituloModalLogin">Iniciar sesi√≥n</h3>
      <form class="formulario" id="formLogin" novalidate>
        <label>
          Correo electr√≥nico
          <input type="email" name="email" id="inputLoginEmail" autocomplete="username" required>
        </label>
        <label>
          Contrase√±a
          <input type="password" name="password" id="inputLoginPassword" autocomplete="current-password" required minlength="8">
        </label>
        <p class="mensaje-error" id="errorLogin" hidden></p>
        <button type="submit" class="btn btn-primario">Acceder</button>
      </form>
    </div>
  </div>

  <div class="modal" id="modalAdmin" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalAdmin">
      <button type="button" class="modal-cerrar" id="btnCerrarModalAdmin" aria-label="Cerrar">√ó</button>
      <h3 id="tituloModalAdmin">Nuevo contenido</h3>
      <form class="formulario" id="formAdmin">
        <label>
          Tipo de colecci√≥n
          <select name="coleccion" required>
            <option value="lugares">Lugares</option>
            <option value="restaurantes">Restaurantes</option>
            <option value="ocio">Ocio</option>
            <option value="eventos">Eventos</option>
          </select>
        </label>
        <label>
          Nombre
          <input name="nombre" maxlength="60" required>
        </label>
        <label>
          Descripci√≥n
          <textarea name="descripcion" maxlength="2000" required></textarea>
        </label>
        <label>
          Imagen (URL segura)
          <input name="imagen" type="url" placeholder="https://">
        </label>
        <label>
          O subir archivo
          <input name="archivoImagen" type="file" accept="image/*">
        </label>
        <label>
          Etiquetas separadas por coma (m√°x. 8 etiquetas, 20 caracteres c/u)
          <input name="etiquetas" maxlength="200">
        </label>
        <label>
          Enlace externo opcional
          <input name="enlace" type="url" placeholder="https://">
        </label>
        <label>
          Direcci√≥n f√≠sica
          <input name="direccion" id="inputDireccion" maxlength="160" placeholder="Ej. C/ Mayor, 24">
        </label>
        <div class="grupo-coordenadas">
          <label>
            Latitud
            <input name="latitud" id="inputLatitud" type="number" step="0.000001" placeholder="40.20648">
          </label>
          <label>
            Longitud
            <input name="longitud" id="inputLongitud" type="number" step="0.000001" placeholder="-3.56776">
          </label>
          <button type="button" class="btn btn-ghost btn-sm" id="btnAutoCoordenadas">Usar mi ubicaci√≥n</button>
        </div>
        <small>Las coordenadas ayudan a ubicar el mapa y calcular distancias para las personas que buscan cercan√≠a.</small>
        <label>
          Galer√≠a (una URL por l√≠nea)
          <textarea name="galeria" id="inputGaleria" rows="3" placeholder="https://ejemplo.com/foto1.jpg&#10;https://ejemplo.com/foto2.jpg"></textarea>
        </label>
        <label>
          Subir fotos para la galer√≠a
          <input name="archivosGaleria" id="inputArchivosGaleria" type="file" accept="image/*" multiple>
        </label>
        <button type="submit" class="btn btn-primario">Guardar</button>
      </form>
    </div>
  </div>

  <div class="modal" id="modalBaneado" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalBaneado">
      <h3 id="tituloModalBaneado">Acceso restringido</h3>
      <p>Tu IP ha sido bloqueada por el equipo de moderaci√≥n. Si crees que se trata de un error escribe a turismo@sanmartindelavega.es con los detalles de tu visita.</p>
    </div>
  </div>

  <div class="consent-banner" id="bannerConsentimiento" role="region" aria-live="polite">
    <div>
      <strong>Consentimiento de cookies anal√≠ticas</strong>
      <p>Usamos Google Analytics para medir visitas de forma an√≥nima. Solo se activar√° si aceptas. Puedes cambiarlo en Ajustes.</p>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:0.5rem;">
      <button type="button" class="btn btn-primario" id="btnAceptarConsent">Aceptar</button>
      <button type="button" class="btn btn-ghost" id="btnRechazarConsent">Rechazar</button>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      signOut,
      GoogleAuthProvider,
      FacebookAuthProvider,
      signInWithPopup,
      setPersistence,
      browserLocalPersistence,
      updateProfile,
      updatePassword,
      sendEmailVerification,
      EmailAuthProvider,
      reauthenticateWithCredential,
      deleteUser
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      limit,
      startAfter,
      where,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      serverTimestamp,
      doc
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyDigVtE9WexPsg0gOvjcsuYVO_FX-r__7o',
      authDomain: 'interfaces-4bc20.firebaseapp.com',
      projectId: 'interfaces-4bc20',
      storageBucket: 'interfaces-4bc20.firebasestorage.app',
      messagingSenderId: '1007775332703',
      appId: '1:1007775332703:web:1f6f6d7bb6a2d268a75eea',
      measurementId: 'G-G3BQBDN5M6'
    };

    const DATOS_LOCALES = {
      lugares: [
        {
          id: 'iglesia-natividad',
          nombre: 'Iglesia de la Natividad',
          descripcion: 'Templo mud√©jar del siglo XV con visitas guiadas gratuitas los fines de semana.',
          imagen: 'assets/lugar-iglesia-3.svg',
          etiquetas: ['cultural', 'familia'],
          enlace: 'https://turismo.sanmartindelavega.es/iglesia',
          direccion: 'Plaza de la Constituci√≥n, 1',
          coordenadas: [40.20648, -3.56776]
        },
        {
          id: 'mirador-maranosa',
          nombre: 'Mirador de la Mara√±osa',
          descripcion: 'Vistas panor√°micas del valle del Jarama y zona ornitol√≥gica se√±alizada.',
          imagen: 'assets/lugar-maranosa-3.svg',
          etiquetas: ['naturaleza', 'familia'],
          enlace: 'https://turismo.sanmartindelavega.es/maranosa',
          direccion: 'Camino de la Mara√±osa s/n',
          coordenadas: [40.29294, -3.56374]
        },
        {
          id: 'parque-warner',
          nombre: 'Parque Warner Madrid',
          descripcion: 'Atracciones tematizadas y espect√°culos inmersivos para toda la familia.',
          imagen: 'assets/lugar-warner-3.svg',
          etiquetas: ['familia', 'aventura'],
          enlace: 'https://www.parquewarner.com/',
          direccion: 'Carretera M-506, salida Parque Warner',
          coordenadas: [40.23432, -3.58723]
        },
        {
          id: 'ruta-humedales',
          nombre: 'Ruta de los Humedales',
          descripcion: 'Itinerario circular se√±alizado para observar flora y fauna protegida.',
          imagen: 'assets/lugar-maranosa.svg',
          etiquetas: ['naturaleza'],
          enlace: 'https://turismo.sanmartindelavega.es/humedales',
          direccion: 'Centro de visitantes Lagunas de la Mara√±osa',
          coordenadas: [40.18417, -3.56453]
        }
      ],
      restaurantes: [
        {
          id: 'el-lindero',
          nombre: 'Mes√≥n El Lindero',
          descripcion: 'Cocina tradicional con horno de le√±a y men√∫s de fin de semana.',
          imagen: 'assets/restaurante-lindero-3.svg',
          etiquetas: ['tradicional', 'asador', 'terraza', 'km0'],
          enlace: 'https://restaurantesanmartindelavega.es/lindero',
          direccion: 'Calle Mayor, 24',
          coordenadas: [40.20596, -3.56824]
        },
        {
          id: 'zatara',
          nombre: 'Restaurante Z√°tara',
          descripcion: 'Propuestas creativas con productos locales y terraza ajardinada.',
          imagen: 'assets/restaurante-zatara-3.svg',
          etiquetas: ['tapas', 'tradicional', 'veg-friendly', 'terraza', 'sin-gluten', 'km0'],
          enlace: 'https://restaurantesanmartindelavega.es/zatara',
          direccion: 'Avenida de la Vega, 18',
          coordenadas: [40.20546, -3.57112]
        },
        {
          id: 'plaza-jarama',
          nombre: 'Plaza del Jarama',
          descripcion: 'Tapas contempor√°neas y carta vegana disponible bajo reserva.',
          imagen: 'assets/restaurante-lindero-2.svg',
          etiquetas: ['tapas', 'veg-friendly', 'sin-gluten', 'terraza'],
          enlace: 'https://turismo.sanmartindelavega.es/gastronomia',
          direccion: 'Plaza de la Constituci√≥n, 3',
          coordenadas: [40.20698, -3.56794]
        }
      ],
      ocio: [
        {
          id: 'circuito-jarama',
          nombre: 'Karting Circuito del Jarama',
          descripcion: 'Trazado homologado con tandas cronometradas y monitores profesionales.',
          imagen: 'assets/ocio-jarama-3.svg',
          etiquetas: ['aventura'],
          enlace: 'https://turismo.sanmartindelavega.es/karting',
          direccion: 'Camino del R√≠o Jarama',
          coordenadas: [40.2124, -3.5733]
        },
        {
          id: 'bunker-guerra',
          nombre: 'B√∫nker de la Guerra Civil',
          descripcion: 'Centro de interpretaci√≥n al aire libre con visitas teatralizadas.',
          imagen: 'assets/ocio-bunker-3.svg',
          etiquetas: ['cultural'],
          enlace: 'https://turismo.sanmartindelavega.es/bunker',
          direccion: 'Camino de Ciempozuelos km 1',
          coordenadas: [40.2268, -3.5752]
        },
        {
          id: 'piraguas-jarama',
          nombre: 'Piraguas en el Jarama',
          descripcion: 'Recorridos guiados por el r√≠o con seguros incluidos y material adaptado.',
          imagen: 'assets/ocio-jarama-2.svg',
          etiquetas: ['agua', 'familia'],
          enlace: 'https://turismo.sanmartindelavega.es/piraguas',
          direccion: 'Embarcadero municipal del Jarama',
          coordenadas: [40.1995, -3.5691]
        }
      ],
      historia: [
        { id: 'hist-1574', anio: 1574, titulo: 'Otorgamiento del t√≠tulo de villa', descripcion: 'Felipe II concede a San Mart√≠n de la Vega el privilegio de villazgo con jurisdicci√≥n propia.' },
        { id: 'hist-1939', anio: 1939, titulo: 'Reconstrucci√≥n del casco urbano', descripcion: 'Tras la Guerra Civil se impulsa un plan de reconstrucci√≥n y mejora de servicios p√∫blicos.' },
        { id: 'hist-2002', anio: 2002, titulo: 'Inauguraci√≥n del Parque Warner', descripcion: 'Se abre el mayor parque tem√°tico de la Comunidad de Madrid, dinamizando la econom√≠a local.' }
      ],
      eventos: [
        { id: 'romeria', titulo: 'Romer√≠a de la Virgen', descripcion: 'Procesi√≥n hasta la ermita con actuaciones folcl√≥ricas.', fecha: { seconds: Math.floor(new Date().setMonth(new Date().getMonth(), 15) / 1000) }, tipo: 'fiesta_local', enlace: 'https://turismo.sanmartindelavega.es/romeria' },
        { id: 'feria-gastronomia', titulo: 'Feria Gastron√≥mica', descripcion: 'Degustaciones de productores locales en la Plaza de la Constituci√≥n.', fecha: { seconds: Math.floor(new Date().setMonth(new Date().getMonth() + 1, 7) / 1000) }, tipo: 'gastronomia', enlace: 'https://turismo.sanmartindelavega.es/feria' },
        { id: 'carrera-noche', titulo: 'Carrera Nocturna Vega Night', descripcion: 'Recorrido popular de 5 km con inscripci√≥n solidaria.', fecha: { seconds: Math.floor(new Date().setMonth(new Date().getMonth() + 2, 21) / 1000) }, tipo: 'deporte' },
        { id: 'fiestas-patronales', titulo: 'Fiestas patronales de San Mart√≠n', descripcion: 'Conciertos, encierros y fuegos artificiales durante todo el fin de semana.', fecha: { seconds: Math.floor(new Date().setMonth(new Date().getMonth() + 3, 3) / 1000) }, tipo: 'no_laborable', enlace: 'https://turismo.sanmartindelavega.es/fiestas' },
        { id: 'jornada-puertas', titulo: 'Jornada sin clases en colegios', descripcion: 'Actividades culturales para escolares y familias.', fecha: { seconds: Math.floor(new Date().setMonth(new Date().getMonth() + 1, 25) / 1000) }, tipo: 'no_lectivo' }
      ],
      rese√±as: [
        { id: 'rese-1', itemId: 'iglesia-natividad', titulo: 'Visita obligada', texto: 'La iglesia mud√©jar es preciosa y las visitas guiadas son muy amenas.', rating: 5, autor: 'Mar√≠a G.', tipoSeccion: 'lugares', creado: { seconds: Math.floor(Date.now() / 1000) - 86400 }, usuario: 'offline-visitante-1' },
        { id: 'rese-2', itemId: 'parque-warner', titulo: 'Ideal con peques', texto: 'Pasamos el d√≠a en el parque Warner y todo est√° muy bien organizado.', rating: 4, autor: 'Javier P.', tipoSeccion: 'lugares', creado: { seconds: Math.floor(Date.now() / 1000) - 172800 }, usuario: 'offline-visitante-2' },
        { id: 'rese-3', itemId: 'el-lindero', titulo: 'Cocido espectacular', texto: 'El men√∫ de fin de semana es abundante y con producto local.', rating: 5, autor: 'Luc√≠a R.', tipoSeccion: 'restaurantes', creado: { seconds: Math.floor(Date.now() / 1000) - 432000 }, usuario: 'offline-visitante-3' },
        { id: 'rese-4', itemId: 'piraguas-jarama', titulo: 'Experiencia tranquila', texto: 'Ideal para desconectar y disfrutar del r√≠o con monitores atentos.', rating: 4, autor: 'Diego L.', tipoSeccion: 'ocio', creado: { seconds: Math.floor(Date.now() / 1000) - 259200 }, usuario: 'offline-visitante-4' }
      ],
      clima: {
        temperatura: 24,
        descripcion: 'Cielo despejado sobre San Mart√≠n de la Vega',
        pronostico: [
          { fecha: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), max: 27, min: 15, descripcion: 'Intervalos nubosos' },
          { fecha: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(), max: 26, min: 14, descripcion: 'Cielo despejado' },
          { fecha: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(), max: 25, min: 13, descripcion: 'Posibles chubascos' }
        ]
      },
      configuracion: {
        gpx: 'https://turismo.sanmartindelavega.es/rutas/ruta-humedales.gpx',
        mapa: [40.20732, -3.57013]
      }
    };

    const USUARIOS_FALLBACK = {
      'danieltrigre7@gmail.com': {
        password: 'rafadani77',
        role: 'admin',
        displayName: 'Daniel Terroba Alcala'
      }
    };

    const escapeHTML = (s = '') => s.toString()
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');

    const isSafeHttpUrl = (u = '') => {
      try {
        const x = new URL(u, location.origin);
        return /^https?:$/.test(x.protocol);
      } catch {
        return false;
      }
    };

    const isSafeImageURL = (u = '') => {
      if (!u) return false;
      if (/^data:image\/(png|jpe?g|webp|svg\+xml);/i.test(u)) return true;
      try {
        const parsed = new URL(u, location.origin);
        if (!/^https?:$/.test(parsed.protocol) && parsed.origin !== location.origin) return false;
        return /\.(png|jpe?g|webp|svg)$/i.test(parsed.pathname);
      } catch {
        return /^assets\//.test(u) && /\.(png|jpe?g|webp|svg)$/i.test(u);
      }
    };

    const clampRating = (n) => Math.min(5, Math.max(1, Number.isFinite(+n) ? +n : 5));

    const safeLink = (a, href) => {
      if (!isSafeHttpUrl(href)) return false;
      a.href = href;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      return true;
    };

    const obtenerCoordenadas = (item) => {
      if (!item) return null;
      const coords = Array.isArray(item.coordenadas)
        ? item.coordenadas
        : Array.isArray(item.coordenadas?.q)
          ? item.coordenadas.q
          : null;
      if (Array.isArray(coords) && coords.length === 2) {
        const lat = Number(coords[0]);
        const lng = Number(coords[1]);
        if (Number.isFinite(lat) && Number.isFinite(lng)) {
          return { lat, lng };
        }
      }
      if (item.ubicacion?.lat != null && item.ubicacion?.lng != null) {
        const lat = Number(item.ubicacion.lat);
        const lng = Number(item.ubicacion.lng);
        if (Number.isFinite(lat) && Number.isFinite(lng)) {
          return { lat, lng };
        }
      }
      return null;
    };

    const construirUrlMapa = (item) => {
      if (!item) return null;
      if (item.mapa && isSafeHttpUrl(item.mapa)) return item.mapa;
      if (item.maps && isSafeHttpUrl(item.maps)) return item.maps;
      const coords = obtenerCoordenadas(item);
      if (coords) {
        return `https://maps.google.com/?q=${coords.lat},${coords.lng}`;
      }
      if (item.direccion) {
        return `https://maps.google.com/?q=${encodeURIComponent(item.direccion)}`;
      }
      return null;
    };

    const construirMapaEmbed = (item) => {
      const coords = obtenerCoordenadas(item);
      if (coords) {
        return `https://maps.google.com/maps?q=${coords.lat},${coords.lng}&z=15&output=embed`;
      }
      if (item?.direccion) {
        return `https://maps.google.com/maps?q=${encodeURIComponent(item.direccion)}&output=embed`;
      }
      return null;
    };

    const solicitarUbicacion = () =>
      new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('geolocalizacion-no-disponible'));
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (position) => {
            resolve({
              lat: Number(position.coords.latitude),
              lng: Number(position.coords.longitude)
            });
          },
          (error) => reject(error),
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 600000 }
        );
      });

    const calcularDistanciaKm = (origen, destino) => {
      if (!origen || !destino) return null;
      const toRad = (grados) => (Number(grados) * Math.PI) / 180;
      const radioTierra = 6371;
      const dLat = toRad(destino.lat - origen.lat);
      const dLng = toRad(destino.lng - origen.lng);
      const lat1 = toRad(origen.lat);
      const lat2 = toRad(destino.lat);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.sin(dLng / 2) ** 2 * Math.cos(lat1) * Math.cos(lat2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(Math.max(0, 1 - a)));
      return radioTierra * c;
    };

    const obtenerDistanciaAUsuario = (item) => {
      if (!item || !state.ubicacionUsuario) return null;
      const coords = obtenerCoordenadas(item);
      if (!coords) return null;
      const clave = item.id;
      if (clave && state.distancias.has(clave)) return state.distancias.get(clave);
      const distancia = calcularDistanciaKm(state.ubicacionUsuario, coords);
      if (Number.isFinite(distancia) && clave) {
        state.distancias.set(clave, distancia);
      }
      return Number.isFinite(distancia) ? distancia : null;
    };

    const formatearDistancia = (distanciaKm) => {
      if (!Number.isFinite(distanciaKm)) return null;
      if (distanciaKm < 1) {
        return `${Math.round(distanciaKm * 1000)} m`;
      }
      return `${distanciaKm.toFixed(distanciaKm < 10 ? 1 : 0)} km`;
    };

    const NAV_PREFERENCIAS_KEY = 'smv-nav-preferencia';
    const NAV_OPCIONES = [
      { value: 'auto', label: 'Auto' },
      { value: 'google', label: 'Google' },
      { value: 'apple', label: 'Apple' },
      { value: 'waze', label: 'Waze' },
      { value: 'bing', label: 'Bing' }
    ];

    const detectarPreferenciaNavegacion = () => {
      const agente = navigator.userAgent || '';
      if (/iPad|iPhone|iPod/i.test(agente)) return 'apple';
      if (/Macintosh/i.test(agente) && 'ontouchend' in document) return 'apple';
      if (/Android/i.test(agente)) return 'google';
      return 'auto';
    };

    const obtenerPreferenciaNavegacion = () => {
      const actual = state.navegacionPreferencias.get('global');
      if (actual && NAV_OPCIONES.some((op) => op.value === actual)) {
        return actual;
      }
      let almacenada = null;
      try {
        almacenada = localStorage.getItem(NAV_PREFERENCIAS_KEY);
      } catch (error) {
        console.warn('No se pudo leer la preferencia de navegaci√≥n almacenada', error);
      }
      const valida = NAV_OPCIONES.some((op) => op.value === almacenada) ? almacenada : 'auto';
      state.navegacionPreferencias.set('global', valida);
      return valida;
    };

    const actualizarNavVisual = (contenedor, preferencia = obtenerPreferenciaNavegacion()) => {
      if (!contenedor) return;
      const actual = NAV_OPCIONES.some((op) => op.value === preferencia) ? preferencia : 'auto';
      contenedor.querySelectorAll('button').forEach((btn) => {
        const valor = btn.dataset.navValor || 'auto';
        const activo = valor === actual;
        btn.classList.toggle('activo', activo);
        btn.setAttribute('aria-pressed', String(activo));
      });
    };

    const establecerPreferenciaNavegacion = (valor) => {
      const preferencia = NAV_OPCIONES.some((op) => op.value === valor) ? valor : 'auto';
      state.navegacionPreferencias.set('global', preferencia);
      try {
        localStorage.setItem(NAV_PREFERENCIAS_KEY, preferencia);
      } catch (error) {
        console.warn('No se pudo guardar la preferencia de navegaci√≥n', error);
      }
      document.querySelectorAll('[data-nav-opciones]').forEach((contenedor) => {
        actualizarNavVisual(contenedor, preferencia);
      });
    };

    const construirDestinoNavegacion = (item, preferencia = obtenerPreferenciaNavegacion()) => {
      if (!item) return null;
      const coords = obtenerCoordenadas(item);
      const tieneCoords = coords && Number.isFinite(coords.lat) && Number.isFinite(coords.lng);
      const lat = tieneCoords ? coords.lat : null;
      const lng = tieneCoords ? coords.lng : null;
      const direccion = item.direccion ? encodeURIComponent(item.direccion) : '';
      const preferida = preferencia === 'auto' ? detectarPreferenciaNavegacion() : preferencia;
      if (preferida === 'google') {
        if (tieneCoords) {
          return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
        }
        if (direccion) {
          return `https://www.google.com/maps/dir/?api=1&destination=${direccion}`;
        }
      } else if (preferida === 'apple') {
        if (tieneCoords) {
          return `https://maps.apple.com/?daddr=${lat},${lng}`;
        }
        if (direccion) {
          return `https://maps.apple.com/?daddr=${direccion}`;
        }
      } else if (preferida === 'waze') {
        if (tieneCoords) {
          return `https://www.waze.com/ul?ll=${lat},${lng}&navigate=yes`;
        }
        if (direccion) {
          return `https://www.waze.com/ul?q=${direccion}&navigate=yes`;
        }
      } else if (preferida === 'bing') {
        if (tieneCoords) {
          return `https://www.bing.com/maps?rtp=~pos.${lat}_${lng}`;
        }
        if (direccion) {
          return `https://www.bing.com/maps?q=${direccion}`;
        }
      }
      return construirUrlMapa(item);
    };

    const mostrarToast = (mensaje) => {
      toastEl.textContent = mensaje;
      toastEl.classList.add('visible');
      clearTimeout(mostrarToast.timer);
      mostrarToast.timer = setTimeout(() => {
        toastEl.classList.remove('visible');
      }, 4000);
    };


    let modeloModeracion = null;
    let cargaModeracion = null;

    const obtenerModeloModeracion = async () => {
      if (modeloModeracion) return modeloModeracion;
      if (!cargaModeracion) {
        cargaModeracion = (async () => {
          const tf = await import('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js');
          if (tf?.default && !globalThis.tf) {
            globalThis.tf = tf.default;
          }
          const nsfw = await import('https://cdn.jsdelivr.net/npm/nsfwjs@2.4.1/dist/browser.esm.js');
          modeloModeracion = await nsfw.load();
          return modeloModeracion;
        })();
      }
      return cargaModeracion;
    };

    const leerArchivoComoDataURL = (file) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = () => reject(reader.error);
      reader.readAsDataURL(file);
    });

    const esImagenSegura = async (dataUrl) => {
      try {
        const modelo = await obtenerModeloModeracion();
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.src = dataUrl;
        await new Promise((resolve, reject) => {
          img.onload = () => resolve();
          img.onerror = () => reject(new Error('error-carga-imagen'));
        });
        const predicciones = await modelo.classify(img);
        img.remove();
        const prohibida = predicciones.some((pred) => {
          const clase = String(pred.className || '').toLowerCase();
          if (['porn', 'hentai', 'sexy', 'explicit'].some((clave) => clase.includes(clave))) {
            return pred.probability >= 0.5;
          }
          if (['violence', 'gore'].some((clave) => clase.includes(clave))) {
            return pred.probability >= 0.4;
          }
          return false;
        });
        return !prohibida;
      } catch (error) {
        console.warn('moderacion-imagen', error);
        return false;
      }
    };

    const logError = (error, context = 'app') => {
      console.error(`[${context}]`, error);
      const code = String(error?.code || '').toLowerCase();
      const message = String(error?.message || '').toLowerCase();
      if (
        error?.name === 'AbortError' ||
        code.includes('permission-denied') ||
        code.includes('unauth') ||
        code.includes('unavailable') ||
        message.includes('missing or insufficient permissions')
      ) {
        return;
      }
      mostrarToast('Ha ocurrido un error. Int√©ntalo de nuevo.');
    };

    let app;
    let auth;
    let db;
    let storage;
    let analyticsInstance = null;
    let firebaseHabilitado = true;

    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getFirestore(app);
      storage = getStorage(app);
      setPersistence(auth, browserLocalPersistence).catch(() => {
        /* Ignorar si el entorno no permite persistencia */
      });
    } catch (error) {
      firebaseHabilitado = false;
      console.warn('Firebase no disponible, usando modo local', error);
    }

    const googleProvider = firebaseHabilitado ? new GoogleAuthProvider() : null;
    const facebookProvider = firebaseHabilitado ? new FacebookAuthProvider() : null;
    if (googleProvider) googleProvider.setCustomParameters({ prompt: 'select_account' });
    if (facebookProvider) facebookProvider.setCustomParameters({ display: 'popup' });

    const toastEl = document.getElementById('toast');
    const overlayMenu = document.getElementById('overlayMenu');
    const menu = document.getElementById('menuLateral');
    const btnToggleMenu = document.getElementById('btnToggleMenu');
    const listaMenu = document.getElementById('listaMenu');
    const secciones = Array.from(document.querySelectorAll('[data-seccion]'));
    const contenidoPrincipal = document.getElementById('contenidoPrincipal');
    const bannerConsent = document.getElementById('bannerConsentimiento');
    const btnAceptarConsent = document.getElementById('btnAceptarConsent');
    const btnRechazarConsent = document.getElementById('btnRechazarConsent');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const btnMenuAdmin = document.getElementById('btnMenuAdmin');
    const btnDescargarGPX = document.getElementById('btnDescargarGPX');
    const iframeMapa = document.getElementById('iframeMapa');
    const widgetClimaHero = document.getElementById('widgetClimaHero');
    const widgetClimaDetalle = document.getElementById('widgetClimaDetalle');
    const climaContenido = document.getElementById('climaContenido');
    const climaPronostico = document.getElementById('climaPronostico');
    const climaContenidoDetalle = document.getElementById('climaContenidoDetalle');
    const climaPronosticoDetalle = document.getElementById('climaPronosticoDetalle');
    const btnActualizarClima = document.getElementById('btnActualizarClima');
    const btnActualizarClimaDetalle = document.getElementById('btnActualizarClimaDetalle');
    const widgetDestacado = document.getElementById('widgetDestacado');
    const selectMes = document.getElementById('selectMes');
    const selectAnio = document.getElementById('selectAnio');
    const gridCalendario = document.getElementById('gridCalendario');
    const detalleEventos = document.getElementById('detalleEventos');
    const formResena = document.getElementById('formResena');
    const listaResenas = document.getElementById('listaResenas');
    const estadoResenas = document.getElementById('estadoResenas');
    const ratingSelector = document.getElementById('ratingSelector');
    const inputRating = document.getElementById('inputRating');
    const inputFotos = document.getElementById('inputFotos');
    const previewFotos = document.getElementById('previewFotos');
    const ayudaFotos = document.getElementById('ayudaFotos');
    const ordenResenasGrupo = document.getElementById('ordenResenas');
    const filtroEstrellasGlobal = document.getElementById('filtroEstrellasGlobal');
    const toggleSoloImagenes = document.getElementById('toggleSoloImagenes');
    const resumenResenasGlobal = document.getElementById('resumenResenasGlobal');
    const panelFiltrosMap = {
      lugares: document.querySelector('[data-filtros-panel="lugares"]'),
      restaurantes: document.querySelector('[data-filtros-panel="restaurantes"]'),
      ocio: document.querySelector('[data-filtros-panel="ocio"]')
    };
    const panelFiltrosAcciones = document.querySelectorAll('[data-filtro-toggle]');
    const panelFiltrosCerrar = document.querySelectorAll('[data-filtro-close]');
    const gruposFiltroRating = {
      lugares: document.querySelector('[data-filtro-rating="lugares"]'),
      restaurantes: document.querySelector('[data-filtro-rating="restaurantes"]'),
      ocio: document.querySelector('[data-filtro-rating="ocio"]')
    };
    const gruposFiltroOrden = {
      lugares: document.querySelector('[data-filtro-orden="lugares"]'),
      restaurantes: document.querySelector('[data-filtro-orden="restaurantes"]'),
      ocio: document.querySelector('[data-filtro-orden="ocio"]')
    };
    const botonesFiltroCercania = {
      lugares: document.querySelector('[data-filtro-cercania="lugares"]'),
      restaurantes: document.querySelector('[data-filtro-cercania="restaurantes"]'),
      ocio: document.querySelector('[data-filtro-cercania="ocio"]')
    };
    const botonesFiltroCercaniaOff = {
      lugares: document.querySelector('[data-filtro-cercania-off="lugares"]'),
      restaurantes: document.querySelector('[data-filtro-cercania-off="restaurantes"]'),
      ocio: document.querySelector('[data-filtro-cercania-off="ocio"]')
    };
    const estadoCercania = {
      lugares: document.querySelector('[data-estado-cercania="lugares"]'),
      restaurantes: document.querySelector('[data-estado-cercania="restaurantes"]'),
      ocio: document.querySelector('[data-estado-cercania="ocio"]')
    };
    const btnAutoCoordenadas = document.getElementById('btnAutoCoordenadas');
    const inputDireccion = document.getElementById('inputDireccion');
    const inputLatitud = document.getElementById('inputLatitud');
    const inputLongitud = document.getElementById('inputLongitud');
    const inputGaleria = document.getElementById('inputGaleria');
    const inputArchivosGaleria = document.getElementById('inputArchivosGaleria');

    const state = {
      user: null,
      claims: { role: 'visitante' },
      paginadores: {
        lugares: { tag: 'todos', pagina: 0, ultimo: null, hayMas: true, historial: [null] },
        restaurantes: { tag: 'todos', pagina: 0, ultimo: null, hayMas: true, historial: [null] },
        ocio: { tag: 'todos', pagina: 0, ultimo: null, hayMas: true, historial: [null] },
        rese√±as: { pagina: 0, ultimo: null, hayMas: true, historial: [null] }
      },
      rese√±as: [],
      filtrosResenas: { orden: 'recomendadas', estrellas: 0, soloImagenes: false },
      detalleResenas: new Map(),
      imagenesResena: [],
      consentimiento: localStorage.getItem('smv-consentimiento'),
      climaCache: JSON.parse(localStorage.getItem('smv-clima-cache') || 'null'),
      climaTimeout: null,
      eventos: [],
      items: new Map(),
      valoraciones: new Map(),
      resenasPorItem: new Map(),
      gpxUrl: null,
      filtrosExploracion: {
        lugares: { rating: 0, orden: 'nombre', cercania: false },
        restaurantes: { rating: 0, orden: 'nombre', cercania: false },
        ocio: { rating: 0, orden: 'nombre', cercania: false }
      },
      colecciones: { lugares: [], restaurantes: [], ocio: [] },
      ubicacionUsuario: null,
      distancias: new Map(),
      navegacionPreferencias: new Map(),
      tarjetaAbierta: null,
      destacado: { lista: [], indice: 0, animFrame: null, inicio: 0, barra: null },
      panelFiltrosActivo: null,
      fuenteDatos: 'remoto',
      offlineAuth: false,
      baneados: new Set(JSON.parse(localStorage.getItem('smv-baneados') || '[]')),
      ip: null,
      firebaseDisponible: firebaseHabilitado,
      baneado: false
    };

    const DESTACADO_CONFIG = { duracion: 10000 };
    const RADIO_CERCANIA_KM = 15;

    const actualizarSelectorRating = (valor) => {
      if (!ratingSelector) return;
      const activo = Number(valor) || 0;
      ratingSelector.querySelectorAll('button').forEach((btn) => {
        const v = Number(btn.dataset.valor);
        btn.classList.toggle('activo', v <= activo);
      });
    };

    if (ratingSelector && inputRating) {
      actualizarSelectorRating(Number(inputRating.value));
      ratingSelector.querySelectorAll('button').forEach((btn) => {
        const valor = Number(btn.dataset.valor);
        btn.addEventListener('mouseenter', () => actualizarSelectorRating(valor));
        btn.addEventListener('focus', () => actualizarSelectorRating(valor));
        btn.addEventListener('mouseleave', () => actualizarSelectorRating(Number(inputRating.value)));
        btn.addEventListener('blur', () => actualizarSelectorRating(Number(inputRating.value)));
        btn.addEventListener('click', () => {
          inputRating.value = String(valor);
          actualizarSelectorRating(valor);
        });
      });
    }

    if (inputFotos && previewFotos) {
      inputFotos.addEventListener('change', async () => {
        ayudaFotos.hidden = true;
        previewFotos.textContent = '';
        state.imagenesResena = [];
        const archivos = Array.from(inputFotos.files || []).filter((file) => file.type.startsWith('image/')).slice(0, 3);
        if (!archivos.length) return;
        try {
          const procesadas = [];
          for (const archivo of archivos) {
            const dataUrl = await leerArchivoComoDataURL(archivo);
            const segura = await esImagenSegura(dataUrl);
            if (!segura) {
              throw new Error('imagen-no-segura');
            }
            procesadas.push({ file: archivo, dataUrl });
          }
          procesadas.forEach(({ dataUrl }, index) => {
            const img = document.createElement('img');
            img.src = dataUrl;
            img.alt = `Vista previa ${index + 1}`;
            img.loading = 'lazy';
            previewFotos.appendChild(img);
          });
          state.imagenesResena = procesadas;
        } catch (error) {
          console.warn('resena-imagen', error);
          ayudaFotos.hidden = false;
          previewFotos.textContent = '';
          inputFotos.value = '';
          state.imagenesResena = [];
          mostrarToast('Alguna imagen incumple las normas de contenido.');
        }
      });
    }

    const renderResenasFiltradas = () => {
      renderResenas(state.rese√±as || [], state.paginadores.rese√±as?.pagina || 0);
    };

    const actualizarOrdenResenasGlobal = () => {
      if (!ordenResenasGrupo) return;
      const actual = state.filtrosResenas.orden;
      ordenResenasGrupo.querySelectorAll('button').forEach((btn) => {
        btn.classList.toggle('activo', btn.dataset.orden === actual);
      });
    };

    if (ordenResenasGrupo) {
      ordenResenasGrupo.addEventListener('click', (event) => {
        const btn = event.target.closest('button[data-orden]');
        if (!btn) return;
        const valor = btn.dataset.orden;
        state.filtrosResenas.orden = valor;
        if (valor === 'imagenes') {
          state.filtrosResenas.soloImagenes = true;
          if (toggleSoloImagenes) toggleSoloImagenes.checked = true;
        } else if (!toggleSoloImagenes || !toggleSoloImagenes.checked) {
          state.filtrosResenas.soloImagenes = false;
        }
        actualizarOrdenResenasGlobal();
        renderResenasFiltradas();
      });
      actualizarOrdenResenasGlobal();
    }

    if (toggleSoloImagenes) {
      toggleSoloImagenes.addEventListener('change', (event) => {
        state.filtrosResenas.soloImagenes = event.target.checked;
        if (!event.target.checked && state.filtrosResenas.orden === 'imagenes') {
          state.filtrosResenas.orden = 'recomendadas';
          actualizarOrdenResenasGlobal();
        }
        renderResenasFiltradas();
      });
    }

    if (filtroEstrellasGlobal) {
      actualizarEstrellasVisual(filtroEstrellasGlobal, state.filtrosResenas.estrellas || 0);
      filtroEstrellasGlobal.addEventListener('mouseleave', () => {
        actualizarEstrellasVisual(filtroEstrellasGlobal, state.filtrosResenas.estrellas || 0);
      });
      filtroEstrellasGlobal.querySelectorAll('button').forEach((btn) => {
        const valor = Number(btn.dataset.valor);
        btn.addEventListener('mouseenter', () => actualizarEstrellasVisual(filtroEstrellasGlobal, state.filtrosResenas.estrellas || 0, valor));
        btn.addEventListener('focus', () => actualizarEstrellasVisual(filtroEstrellasGlobal, state.filtrosResenas.estrellas || 0, valor));
        btn.addEventListener('mouseleave', () => actualizarEstrellasVisual(filtroEstrellasGlobal, state.filtrosResenas.estrellas || 0));
        btn.addEventListener('blur', () => actualizarEstrellasVisual(filtroEstrellasGlobal, state.filtrosResenas.estrellas || 0));
        btn.addEventListener('click', () => {
          state.filtrosResenas.estrellas = state.filtrosResenas.estrellas === valor ? 0 : valor;
          renderResenasFiltradas();
        });
      });
    }
    const modalAdmin = document.getElementById('modalAdmin');
    const btnAbrirModalAdmin = document.getElementById('btnAbrirModalAdmin');
    const btnCerrarModalAdmin = document.getElementById('btnCerrarModalAdmin');
    const formAdmin = document.getElementById('formAdmin');
    const listaAdmin = document.getElementById('listaAdmin');
    const modalBienvenida = document.getElementById('modalBienvenida');
    const btnCerrarModalBienvenida = document.getElementById('btnCerrarModalBienvenida');
    const btnLoginCorreo = document.getElementById('btnLoginCorreo');
    const btnLoginGoogle = document.getElementById('btnLoginGoogle');
    const btnLoginFacebook = document.getElementById('btnLoginFacebook');
    const btnInvitado = document.getElementById('btnInvitado');
    const initContraste = document.getElementById('initContraste');
    const initTexto = document.getElementById('initTexto');
    const initEspaciado = document.getElementById('initEspaciado');
    const initLinks = document.getElementById('initLinks');
    const panelCuenta = document.getElementById('panelCuenta');
    const formPerfil = document.getElementById('formPerfil');
    const formPassword = document.getElementById('formPassword');
    const btnVerificarCorreo = document.getElementById('btnVerificarCorreo');
    const btnCerrarSesiones = document.getElementById('btnCerrarSesiones');
    const btnEliminarCuenta = document.getElementById('btnEliminarCuenta');
    const estadoCuenta = document.getElementById('estadoCuenta');
    const toggleModoOscuro = document.getElementById('toggleModoOscuro');
    const toggleModoSenior = document.getElementById('toggleModoSenior');
    const toggleBotones = document.getElementById('toggleBotones');
    const toggleFuente = document.getElementById('toggleFuente');
    const toggleReducir = document.getElementById('toggleReducir');
    const toggleContraste = document.getElementById('toggleContraste');
    const toggleTexto = document.getElementById('toggleTexto');
    const toggleEspaciado = document.getElementById('toggleEspaciado');
    const toggleLinks = document.getElementById('toggleLinks');
    const toggleLecturaFacil = document.getElementById('toggleLecturaFacil');
    const toggleVisibilidad = document.getElementById('toggleVisibilidad');
    const formBan = document.getElementById('formBan');
    const listaBaneados = document.getElementById('listaBaneados');
    const inputBanIp = document.getElementById('inputBanIp');
    const modalBaneado = document.getElementById('modalBaneado');

    if (menu) menu.setAttribute('aria-hidden', 'true');
    if (overlayMenu) overlayMenu.setAttribute('aria-hidden', 'true');

    const chipsPorSeccion = {
      lugares: document.getElementById('chipsLugares'),
      restaurantes: document.getElementById('chipsRestaurantes'),
      ocio: document.getElementById('chipsOcio')
    };

    const listasPorSeccion = {
      lugares: document.getElementById('listaLugares'),
      restaurantes: document.getElementById('listaRestaurantes'),
      ocio: document.getElementById('listaOcio')
    };

    const TAGS_PREDEFINIDOS = {
      lugares: ['naturaleza', 'cultural', 'familia'],
      restaurantes: ['tradicional', 'tapas', 'asador', 'terraza', 'veg-friendly', 'sin-gluten', 'km0'],
      ocio: ['aventura', 'agua']
    };

    const estadoPorSeccion = {
      lugares: document.getElementById('estadoLugares'),
      restaurantes: document.getElementById('estadoRestaurantes'),
      ocio: document.getElementById('estadoOcio'),
      rese√±as: estadoResenas
    };

    const obtenerFiltrosColeccion = (coleccion) => {
      if (!state.filtrosExploracion[coleccion]) {
        state.filtrosExploracion[coleccion] = { rating: 0, orden: 'nombre', cercania: false };
      }
      return state.filtrosExploracion[coleccion];
    };

    const actualizarEstadoCercaniaUI = () => {
      Object.entries(estadoCercania).forEach(([coleccion, nodo]) => {
        if (!nodo) return;
        const filtros = obtenerFiltrosColeccion(coleccion);
        if (!state.ubicacionUsuario) {
          nodo.textContent = 'Ubicaci√≥n no solicitada.';
        } else if (filtros.cercania) {
          nodo.textContent = `Mostrando resultados a menos de ${RADIO_CERCANIA_KM} km.`;
        } else {
          nodo.textContent = 'Ubicaci√≥n guardada. Activa la cercan√≠a para priorizar resultados pr√≥ximos.';
        }
      });
      Object.entries(botonesFiltroCercania).forEach(([coleccion, boton]) => {
        if (!boton) return;
        const filtros = obtenerFiltrosColeccion(coleccion);
        boton.classList.toggle('activo', Boolean(filtros.cercania));
      });
    };

    const aplicarFiltrosColeccion = (coleccion, docs) => {
      const lista = Array.isArray(docs) ? docs : [];
      const filtros = obtenerFiltrosColeccion(coleccion);
      const conMetadatos = lista.map((item) => {
        const valoracion = state.valoraciones.get(item.id)?.promedio || 0;
        const distancia = obtenerDistanciaAUsuario(item);
        return { item, valoracion, distancia };
      });
      const filtrados = conMetadatos.filter(({ valoracion, distancia }) => {
        if (filtros.rating && valoracion + 1e-6 < filtros.rating) return false;
        if (filtros.cercania && state.ubicacionUsuario) {
          if (distancia == null || distancia > RADIO_CERCANIA_KM) return false;
        }
        return true;
      });
      const compararNombre = (a, b) => a.item.nombre.localeCompare(b.item.nombre);
      const compararValoracion = (a, b) => b.valoracion - a.valoracion || compararNombre(a, b);
      const compararDistancia = (a, b) => {
        if (a.distancia == null && b.distancia == null) return compararValoracion(a, b);
        if (a.distancia == null) return 1;
        if (b.distancia == null) return -1;
        return a.distancia - b.distancia || compararValoracion(a, b);
      };
      switch (filtros.orden) {
        case 'valoracion':
          filtrados.sort(compararValoracion);
          break;
        case 'cercania':
          filtrados.sort(compararDistancia);
          break;
        case 'nombre':
        default:
          filtrados.sort(compararNombre);
          break;
      }
      return filtrados.map(({ item }) => item);
    };

    const actualizarColeccionView = (coleccion) => {
      const contenedor = listasPorSeccion[coleccion];
      if (!contenedor) return;
      contenedor.textContent = '';
      const docs = Array.isArray(state.colecciones[coleccion]) ? [...state.colecciones[coleccion]] : [];
      docs.forEach((docItem) => {
        state.items.set(docItem.id, { ...docItem, coleccion });
      });
      const filtrados = aplicarFiltrosColeccion(coleccion, docs);
      if (!filtrados.length) {
        const vacio = document.createElement('p');
        vacio.className = 'lista-vacia';
        vacio.textContent = 'No hay resultados para este filtro.';
        contenedor.appendChild(vacio);
      } else {
        filtrados.forEach((docItem) => {
          contenedor.appendChild(crearTarjeta(docItem, coleccion));
        });
      }
      const estado = estadoPorSeccion[coleccion];
      if (estado) {
        const paginaActual = state.paginadores[coleccion]?.pagina ?? 0;
        estado.textContent = `P√°gina ${paginaActual + 1} ¬∑ ${filtrados.length} resultado${filtrados.length === 1 ? '' : 's'}`;
      }
    };

    const togglePanelFiltros = (coleccion, abrir = false) => {
      const panel = panelFiltrosMap[coleccion];
      if (!panel) return;
      if (window.matchMedia('(min-width: 900px)').matches) {
        panel.dataset.abierto = 'true';
        document.body.classList.remove('panel-filtros-abierto');
        return;
      }
      if (abrir) {
        panel.dataset.abierto = 'true';
        document.body.classList.add('panel-filtros-abierto');
        state.panelFiltrosActivo = coleccion;
      } else {
        panel.dataset.abierto = 'false';
        document.body.classList.remove('panel-filtros-abierto');
        if (state.panelFiltrosActivo === coleccion) {
          state.panelFiltrosActivo = null;
        }
      }
    };

    panelFiltrosAcciones.forEach((boton) => {
      boton.addEventListener('click', () => {
        const coleccion = boton.dataset.filtroToggle;
        if (!coleccion) return;
        const panel = panelFiltrosMap[coleccion];
        const abierto = panel?.dataset.abierto === 'true';
        togglePanelFiltros(coleccion, !abierto);
      });
    });

    panelFiltrosCerrar.forEach((boton) => {
      boton.addEventListener('click', () => {
        const coleccion = boton.dataset.filtroClose;
        if (!coleccion) return;
        togglePanelFiltros(coleccion, false);
      });
    });

    Object.entries(gruposFiltroRating).forEach(([coleccion, grupo]) => {
      if (!grupo) return;
      grupo.addEventListener('click', (event) => {
        const boton = event.target.closest('button[data-valor]');
        if (!boton) return;
        const filtros = obtenerFiltrosColeccion(coleccion);
        filtros.rating = Number(boton.dataset.valor) || 0;
        grupo.querySelectorAll('button').forEach((btn) => {
          btn.classList.toggle('activo', btn === boton);
        });
        actualizarColeccionView(coleccion);
      });
    });

    Object.entries(gruposFiltroOrden).forEach(([coleccion, grupo]) => {
      if (!grupo) return;
      grupo.addEventListener('click', (event) => {
        const boton = event.target.closest('button[data-orden]');
        if (!boton) return;
        const filtros = obtenerFiltrosColeccion(coleccion);
        filtros.orden = boton.dataset.orden || 'nombre';
        grupo.querySelectorAll('button').forEach((btn) => {
          btn.classList.toggle('activo', btn === boton);
        });
        actualizarColeccionView(coleccion);
      });
    });

    Object.entries(botonesFiltroCercania).forEach(([coleccion, boton]) => {
      if (!boton) return;
      boton.addEventListener('click', async () => {
        boton.disabled = true;
        try {
          const ubicacion = await solicitarUbicacion();
          if (ubicacion) {
            state.ubicacionUsuario = ubicacion;
            state.distancias.clear();
            const filtros = obtenerFiltrosColeccion(coleccion);
            filtros.cercania = true;
            actualizarEstadoCercaniaUI();
            actualizarColeccionView(coleccion);
            ['lugares', 'restaurantes', 'ocio'].forEach((col) => {
              if (col !== coleccion && obtenerFiltrosColeccion(col).cercania) {
                actualizarColeccionView(col);
              }
            });
            togglePanelFiltros(coleccion, false);
          }
        } catch (error) {
          mostrarToast('No pudimos obtener tu ubicaci√≥n.');
          logError(error, 'filtro-cercania');
        } finally {
          boton.disabled = false;
        }
      });
    });

    Object.entries(botonesFiltroCercaniaOff).forEach(([coleccion, boton]) => {
      if (!boton) return;
      boton.addEventListener('click', () => {
        const filtros = obtenerFiltrosColeccion(coleccion);
        filtros.cercania = false;
        actualizarEstadoCercaniaUI();
        actualizarColeccionView(coleccion);
      });
    });

    if (btnAutoCoordenadas) {
      btnAutoCoordenadas.addEventListener('click', async () => {
        const textoOriginal = btnAutoCoordenadas.textContent;
        btnAutoCoordenadas.disabled = true;
        btnAutoCoordenadas.textContent = 'Obteniendo‚Ä¶';
        try {
          const ubicacion = await solicitarUbicacion();
          if (ubicacion && Number.isFinite(ubicacion.lat) && Number.isFinite(ubicacion.lng)) {
            if (inputLatitud) inputLatitud.value = Number(ubicacion.lat).toFixed(6);
            if (inputLongitud) inputLongitud.value = Number(ubicacion.lng).toFixed(6);
            mostrarToast('Coordenadas sugeridas a partir de tu ubicaci√≥n.');
          } else {
            throw new Error('ubicacion-no-disponible');
          }
        } catch (error) {
          mostrarToast('No pudimos obtener tu ubicaci√≥n autom√°ticamente.');
          logError(error, 'admin-auto-coordenadas');
        } finally {
          btnAutoCoordenadas.disabled = false;
          btnAutoCoordenadas.textContent = textoOriginal;
        }
      });
    }

    let firebaseModoLocalNotificado = false;

    const esErrorFirebaseCritico = (error) => {
      if (!error) return false;
      const code = String(error.code || '').toLowerCase();
      const message = String(error.message || '').toLowerCase();
      return (
        code.includes('permission-denied') ||
        code.includes('unauth') ||
        code.includes('unavailable') ||
        message.includes('missing or insufficient permissions')
      );
    };

    const forzarModoLocal = () => {
      if (!firebaseHabilitado) return;
      firebaseHabilitado = false;
      state.firebaseDisponible = false;
      state.fuenteDatos = 'local';
      db = null;
      storage = null;
      if (!firebaseModoLocalNotificado) {
        firebaseModoLocalNotificado = true;
        mostrarToast('Mostrando datos locales por falta de permisos en la base de datos.');
      }
    };

    const manejarErrorFirebase = (error, contexto) => {
      logError(error, contexto);
      if (esErrorFirebaseCritico(error)) {
        forzarModoLocal();
      }
    };

    const LIMITES = {
      pagina: 20,
      rese√±as: 10
    };

    const mesActual = new Date();

    document.body.dataset.baneado = 'false';

    const obtenerDatosLocales = (coleccion, tag = 'todos') => {
      const base = Array.isArray(DATOS_LOCALES[coleccion]) ? [...DATOS_LOCALES[coleccion]] : [];
      if (tag && tag !== 'todos') {
        return base
          .filter((item) => Array.isArray(item.etiquetas) && item.etiquetas.includes(tag))
          .sort((a, b) => a.nombre.localeCompare(b.nombre));
      }
      return base.sort((a, b) => a.nombre.localeCompare(b.nombre));
    };

    const toggleMenu = (mostrar, { skipFocus = false } = {}) => {
      if (!menu || !overlayMenu || !btnToggleMenu) return;
      const isOpen = mostrar ?? !menu.classList.contains('abierto');
      menu.classList.toggle('abierto', isOpen);
      overlayMenu.classList.toggle('visible', isOpen);
      document.body.classList.toggle('menu-abierto', isOpen);
      btnToggleMenu.setAttribute('aria-expanded', String(isOpen));
      menu.setAttribute('aria-hidden', String(!isOpen));
      overlayMenu.setAttribute('aria-hidden', String(!isOpen));
      if (isOpen) {
        menu.focus();
      } else if (!skipFocus) {
        btnToggleMenu.focus();
      }
    };

    if (btnToggleMenu) btnToggleMenu.addEventListener('click', () => toggleMenu());
    if (overlayMenu) overlayMenu.addEventListener('click', () => toggleMenu(false));

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && menu?.classList.contains('abierto')) {
        toggleMenu(false);
      }
    });

    window.addEventListener('resize', () => {
      if (window.innerWidth > 960 && menu?.classList.contains('abierto')) {
        toggleMenu(false, { skipFocus: true });
      }
    });

    const cambiarSeccion = (id) => {
      secciones.forEach((seccion) => {
        const visible = seccion.dataset.seccion === id;
        seccion.toggleAttribute('hidden', !visible);
      });
      document.querySelectorAll('.sub-lista').forEach((lista) => {
        lista.classList.toggle('visible', lista.dataset.parent === id);
      });
      if (listaMenu) {
        listaMenu.querySelectorAll('button[data-seccion]').forEach((btn) => {
          const activo = btn.dataset.seccion === id;
          btn.classList.toggle('activo', activo);
          btn.setAttribute('aria-expanded', String(activo));
        });
      }
      toggleMenu(false);
    };

    if (listaMenu) {
      listaMenu.addEventListener('click', (event) => {
        const target = event.target.closest('button');
        if (!target) return;
        if (target.dataset.seccion) {
          event.preventDefault();
          cambiarSeccion(target.dataset.seccion);
        }
        if (target.dataset.tag) {
          const parent = target.closest('.sub-lista');
          if (parent?.dataset.parent) {
            aplicarFiltro(parent.dataset.parent, target.dataset.tag);
          }
        }
      });
    }

    if (contenidoPrincipal) {
      contenidoPrincipal.addEventListener('click', (event) => {
        const ir = event.target.closest('[data-ir]');
        if (ir) {
          cambiarSeccion(ir.dataset.ir.replace('seccion', '').toLowerCase());
          const destino = document.getElementById(ir.dataset.ir);
          if (destino) destino.scrollIntoView({ behavior: 'smooth' });
        }
      });
    }

    widgetDestacado?.addEventListener('click', (event) => {
      const destino = event.target.closest('button[data-destacado-seccion]');
      if (!destino) return;
      const { destacadoSeccion: seccion, destacadoId: itemId } = destino.dataset;
      if (!seccion) return;
      cambiarSeccion(seccion);
      requestAnimationFrame(() => {
        const tarjeta = document.querySelector(`[data-id="${itemId}"]`);
        if (tarjeta) tarjeta.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
    });

    const obtenerEtiquetasDisponibles = (coleccion) => {
      const conjunto = new Set(TAGS_PREDEFINIDOS[coleccion] || []);
      const locales = Array.isArray(DATOS_LOCALES[coleccion]) ? DATOS_LOCALES[coleccion] : [];
      locales.forEach((item) => {
        if (Array.isArray(item.etiquetas)) {
          item.etiquetas.forEach((etiqueta) => conjunto.add(etiqueta));
        }
      });
      state.items.forEach((item) => {
        if (item?.coleccion === coleccion && Array.isArray(item.etiquetas)) {
          item.etiquetas.forEach((etiqueta) => conjunto.add(etiqueta));
        }
      });
      return Array.from(conjunto).filter(Boolean).sort((a, b) => a.localeCompare(b));
    };

    const construirChips = (coleccion, tagActual) => {
      const contenedor = chipsPorSeccion[coleccion];
      if (!contenedor) return;
      contenedor.textContent = '';
      const tags = ['todos', ...obtenerEtiquetasDisponibles(coleccion)];
      tags.forEach((tag) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `chip${tag === tagActual ? ' activo' : ''}`;
        btn.dataset.tag = tag;
        btn.textContent = tag === 'todos' ? 'Todos' : tag.charAt(0).toUpperCase() + tag.slice(1);
        btn.setAttribute('aria-pressed', tag === tagActual ? 'true' : 'false');
        contenedor.appendChild(btn);
      });
    };

    Object.entries(chipsPorSeccion).forEach(([coleccion, contenedor]) => {
      contenedor.addEventListener('click', (event) => {
        const btn = event.target.closest('button');
        if (!btn) return;
        aplicarFiltro(coleccion, btn.dataset.tag);
      });
    });

    ['lugares', 'restaurantes', 'ocio'].forEach((coleccion) => construirChips(coleccion, 'todos'));

    const aplicarFiltro = (coleccion, tag) => {
      const paginador = state.paginadores[coleccion];
      if (!paginador) return;
      paginador.tag = tag;
      paginador.pagina = 0;
      paginador.ultimo = null;
      paginador.hayMas = true;
      paginador.historial = [null];
      construirChips(coleccion, tag);
      cargarColeccion(coleccion, { reiniciar: true }).catch((error) => logError(error, 'filtro'));
    };

    const obtenerFechaResena = (resena) => {
      if (!resena) return new Date(0);
      if (resena.creado?.seconds) return new Date(resena.creado.seconds * 1000);
      if (resena.fechaCreacion) return new Date(resena.fechaCreacion);
      if (resena.creado instanceof Date) return resena.creado;
      return new Date(0);
    };

    const buscarItemPorId = (id) => {
      if (!id) return null;
      if (state.items.has(id)) return state.items.get(id);
      const colecciones = ['lugares', 'restaurantes', 'ocio'];
      for (const coleccion of colecciones) {
        const lista = DATOS_LOCALES[coleccion];
        if (Array.isArray(lista)) {
          const encontrado = lista.find((elemento) => elemento.id === id);
          if (encontrado) return { ...encontrado, coleccion };
        }
      }
      return null;
    };

    const actualizarTarjetaConResenas = (itemId, lista) => {
      const entradas = Array.isArray(lista) ? lista : [];
      const valoracion = state.valoraciones.get(itemId);
      document.querySelectorAll(`[data-valoracion-id="${itemId}"]`).forEach((nodo) => {
        const span = nodo.querySelector('span') || nodo;
        const small = nodo.querySelector('small');
        if (!valoracion || !valoracion.total) {
          if (span) span.textContent = '‚≠ê ‚Äî';
          if (small) small.textContent = 'Sin rese√±as todav√≠a';
        } else {
          if (span) span.textContent = `‚≠ê ${valoracion.promedio.toFixed(1)}`;
          if (small) small.textContent = `${valoracion.total} rese√±a${valoracion.total === 1 ? '' : 's'}`;
        }
      });
      document.querySelectorAll(`[data-resena-preview="${itemId}"]`).forEach((nodo) => {
        if (!entradas.length) {
          nodo.textContent = 'A√∫n no hay rese√±as para este lugar.';
          return;
        }
        const ordenadas = [...entradas].sort((a, b) => obtenerFechaResena(b) - obtenerFechaResena(a));
        const destacada = ordenadas[0];
        const texto = (destacada.texto || '').trim();
        const fragmento = texto.length > 140 ? `${texto.slice(0, 137)}‚Ä¶` : texto;
        nodo.textContent = '';
        const cita = document.createElement('span');
        cita.textContent = fragmento ? `‚Äú${fragmento}‚Äù` : '‚ÄúSin comentarios disponibles.‚Äù';
        nodo.appendChild(cita);
        const autor = document.createElement('strong');
        autor.textContent = `‚Äî ${destacada.autor || 'Visitante'}`;
        nodo.appendChild(autor);
      });
      document.querySelectorAll(`[data-resenas-item="${itemId}"]`).forEach((seccion) => {
        const filtros = obtenerFiltrosDetalle(itemId);
        actualizarListaDetalleResenas(seccion, entradas, filtros);
      });
    };

    const detenerIdeasAuto = () => {
      if (state.destacado.animFrame) {
        cancelAnimationFrame(state.destacado.animFrame);
        state.destacado.animFrame = null;
      }
      state.destacado.inicio = 0;
      if (state.destacado.barra) {
        state.destacado.barra.style.width = '0%';
      }
    };

    const iniciarIdeasAuto = () => {
      detenerIdeasAuto();
      if (!widgetDestacado || state.destacado.lista.length <= 1) return;
      const animar = (timestamp) => {
        if (!state.destacado.inicio) state.destacado.inicio = timestamp;
        const progreso = Math.min(1, (timestamp - state.destacado.inicio) / DESTACADO_CONFIG.duracion);
        if (state.destacado.barra) {
          state.destacado.barra.style.width = `${(progreso * 100).toFixed(2)}%`;
        }
        if (progreso >= 1) {
          cambiarIdea(1);
          return;
        }
        state.destacado.animFrame = requestAnimationFrame(animar);
      };
      state.destacado.animFrame = requestAnimationFrame(animar);
    };

    const obtenerIdeasCandidatas = () => {
      const candidatos = [];
      state.valoraciones.forEach((info, itemId) => {
        if (info.promedio > 4) {
          const item = buscarItemPorId(itemId);
          if (item) {
            candidatos.push({ itemId, item, info });
          }
        }
      });
      candidatos.sort((a, b) => {
        const diff = b.info.promedio - a.info.promedio;
        if (Math.abs(diff) > 1e-3) return diff;
        const total = (b.info.total || 0) - (a.info.total || 0);
        if (total !== 0) return total;
        return a.item.nombre.localeCompare(b.item.nombre);
      });
      return candidatos.slice(0, 10);
    };

    const renderIdeasWidget = () => {
      if (!widgetDestacado) return;
      detenerIdeasAuto();
      widgetDestacado.textContent = '';
      const cabecera = document.createElement('div');
      cabecera.className = 'ideas-header';
      const titulo = document.createElement('strong');
      titulo.textContent = 'Ideas';
      cabecera.appendChild(titulo);
      const controles = document.createElement('div');
      controles.className = 'ideas-controles';
      const btnPrev = document.createElement('button');
      btnPrev.type = 'button';
      btnPrev.setAttribute('aria-label', 'Idea anterior');
      btnPrev.textContent = '‚óÄ';
      const btnNext = document.createElement('button');
      btnNext.type = 'button';
      btnNext.setAttribute('aria-label', 'Idea siguiente');
      btnNext.textContent = '‚ñ∂';
      controles.append(btnPrev, btnNext);
      cabecera.appendChild(controles);
      widgetDestacado.appendChild(cabecera);

      if (!state.destacado.lista.length) {
        btnPrev.disabled = true;
        btnNext.disabled = true;
        const mensaje = document.createElement('p');
        mensaje.textContent = 'Reuniremos aqu√≠ las mejores propuestas en cuanto tengamos suficientes valoraciones.';
        widgetDestacado.appendChild(mensaje);
        const progreso = document.createElement('div');
        progreso.className = 'ideas-progreso';
        const barra = document.createElement('span');
        progreso.appendChild(barra);
        widgetDestacado.appendChild(progreso);
        state.destacado.barra = barra;
        return;
      }

      btnPrev.disabled = state.destacado.lista.length <= 1;
      btnNext.disabled = state.destacado.lista.length <= 1;
      const actual = state.destacado.lista[state.destacado.indice];

      const contenido = document.createElement('div');
      contenido.className = 'ideas-contenido';
      const figura = document.createElement('div');
      figura.className = 'ideas-imagen';
      if (isSafeImageURL(actual.item.imagen)) {
        figura.style.backgroundImage = `url(${actual.item.imagen})`;
      }
      contenido.appendChild(figura);

      const texto = document.createElement('div');
      texto.className = 'ideas-texto';
      const nombre = document.createElement('h3');
      nombre.textContent = actual.item.nombre;
      texto.appendChild(nombre);
      const descripcion = document.createElement('p');
      descripcion.textContent = actual.item.descripcion || 'Descubre este plan muy bien valorado por la comunidad.';
      texto.appendChild(descripcion);
      const meta = document.createElement('div');
      meta.className = 'ideas-meta';
      const nota = document.createElement('div');
      nota.className = 'tarjeta-valoracion';
      const spanNota = document.createElement('span');
      spanNota.textContent = `‚≠ê ${actual.info.promedio.toFixed(1)}`;
      const detalle = document.createElement('small');
      detalle.textContent = `${actual.info.total} rese√±a${actual.info.total === 1 ? '' : 's'}`;
      nota.append(spanNota, detalle);
      meta.appendChild(nota);
      const distancia = obtenerDistanciaAUsuario(actual.item);
      if (Number.isFinite(distancia)) {
        const badgeDistancia = document.createElement('div');
        badgeDistancia.className = 'tarjeta-valoracion';
        badgeDistancia.textContent = `üß≠ ${formatearDistancia(distancia)} de ti`;
        meta.appendChild(badgeDistancia);
      }
      texto.appendChild(meta);
      if (actual.item.coleccion) {
        const boton = document.createElement('button');
        boton.type = 'button';
        boton.className = 'btn btn-ghost btn-sm';
        boton.dataset.destacadoSeccion = actual.item.coleccion;
        boton.dataset.destacadoId = actual.itemId;
        const nombreSeccion = actual.item.coleccion.charAt(0).toUpperCase() + actual.item.coleccion.slice(1);
        boton.textContent = `Ver en ${nombreSeccion}`;
        texto.appendChild(boton);
      }
      contenido.appendChild(texto);
      widgetDestacado.appendChild(contenido);

      const progreso = document.createElement('div');
      progreso.className = 'ideas-progreso';
      const barra = document.createElement('span');
      progreso.appendChild(barra);
      widgetDestacado.appendChild(progreso);
      state.destacado.barra = barra;

      btnPrev.addEventListener('click', (event) => {
        event.stopPropagation();
        cambiarIdea(-1);
      });
      btnNext.addEventListener('click', (event) => {
        event.stopPropagation();
        cambiarIdea(1);
      });
    };

    const actualizarIdeas = () => {
      state.destacado.lista = obtenerIdeasCandidatas();
      if (state.destacado.indice >= state.destacado.lista.length) {
        state.destacado.indice = 0;
      }
      renderIdeasWidget();
      iniciarIdeasAuto();
    };

    const cambiarIdea = (incremento) => {
      if (!state.destacado.lista.length) {
        renderIdeasWidget();
        return;
      }
      const total = state.destacado.lista.length;
      state.destacado.indice = (state.destacado.indice + incremento + total) % total;
      renderIdeasWidget();
      iniciarIdeasAuto();
    };

    const refrescarValoracionesGlobales = () => {
      const todas = [];
      const registro = new Set();
      const agregar = (resena) => {
        if (!resena || !resena.itemId) return;
        const key = resena.id || `${resena.itemId}-${resena.usuario || ''}-${resena.titulo || ''}`;
        if (registro.has(key)) return;
        registro.add(key);
        todas.push(resena);
      };
      (Array.isArray(state.rese√±as) ? state.rese√±as : []).forEach(agregar);
      (Array.isArray(DATOS_LOCALES.rese√±as) ? DATOS_LOCALES.rese√±as : []).forEach(agregar);
      const agrupadas = new Map();
      todas.forEach((resena) => {
        const lista = agrupadas.get(resena.itemId) || [];
        lista.push(resena);
        agrupadas.set(resena.itemId, lista);
      });
      state.resenasPorItem = agrupadas;
      state.valoraciones = new Map();
      agrupadas.forEach((lista, itemId) => {
        const total = lista.length;
        const suma = lista.reduce((acc, res) => acc + clampRating(res.rating), 0);
        state.valoraciones.set(itemId, { total, promedio: total ? suma / total : 0 });
      });
      agrupadas.forEach((lista, itemId) => actualizarTarjetaConResenas(itemId, lista));
      document.querySelectorAll('[data-valoracion-id]').forEach((nodo) => {
        const itemId = nodo.dataset.valoracionId;
        if (!agrupadas.has(itemId)) {
          actualizarTarjetaConResenas(itemId, []);
        }
      });
      ['lugares', 'restaurantes', 'ocio'].forEach((coleccion) => {
        if (state.colecciones[coleccion]) {
          actualizarColeccionView(coleccion);
        }
      });
      actualizarIdeas();
      actualizarEstadoCercaniaUI();
    };

    const crearTarjeta = (item, coleccion) => {
      const tarjeta = document.createElement('article');
      tarjeta.className = 'tarjeta';
      tarjeta.dataset.id = item.id;
      tarjeta.dataset.coleccion = coleccion;

      if (state.claims.role === 'admin') {
        const btnEditarOverlay = document.createElement('button');
        btnEditarOverlay.type = 'button';
        btnEditarOverlay.className = 'tarjeta-boton-editar';
        btnEditarOverlay.setAttribute('aria-label', `Editar ${item.nombre}`);
        btnEditarOverlay.textContent = '‚úèÔ∏è';
        btnEditarOverlay.addEventListener('click', (event) => {
          event.stopPropagation();
          abrirModalAdmin(item, coleccion);
        });
        tarjeta.appendChild(btnEditarOverlay);
      }

      const resumen = document.createElement('button');
      resumen.type = 'button';
      resumen.className = 'tarjeta-resumen';
      resumen.setAttribute('aria-expanded', 'false');

      const contenedorImagen = document.createElement('div');
      contenedorImagen.className = 'tarjeta-resumen-imagen';
      const imagen = document.createElement('img');
      if (isSafeImageURL(item.imagen)) {
        imagen.src = item.imagen;
      } else {
        imagen.src = 'assets/placeholder.svg';
      }
      imagen.alt = `Imagen de ${item.nombre}`;
      imagen.loading = 'lazy';
      contenedorImagen.appendChild(imagen);

      const overlay = document.createElement('div');
      overlay.className = 'tarjeta-overlay';
      const tituloOverlay = document.createElement('h3');
      tituloOverlay.textContent = item.nombre;
      overlay.appendChild(tituloOverlay);
      const valoracionOverlay = document.createElement('div');
      valoracionOverlay.className = 'tarjeta-valoracion';
      valoracionOverlay.dataset.valoracionId = item.id;
      const notaOverlay = document.createElement('span');
      notaOverlay.textContent = '‚≠ê ‚Äî';
      const detalleOverlay = document.createElement('small');
      detalleOverlay.textContent = 'Sin rese√±as todav√≠a';
      valoracionOverlay.append(notaOverlay, detalleOverlay);
      overlay.appendChild(valoracionOverlay);
      contenedorImagen.appendChild(overlay);
      resumen.appendChild(contenedorImagen);
      tarjeta.appendChild(resumen);

      const detalle = document.createElement('div');
      detalle.className = 'tarjeta-detalle';
      detalle.hidden = true;
      detalle.dataset.itemId = item.id;
      const detalleId = `detalle-${item.id}`;
      detalle.id = detalleId;
      resumen.setAttribute('aria-controls', detalleId);

      const cabecera = document.createElement('header');
      const tituloDetalle = document.createElement('h3');
      tituloDetalle.textContent = item.nombre;
      cabecera.appendChild(tituloDetalle);
      const meta = document.createElement('div');
      meta.className = 'tarjeta-meta';
      if (item.direccion) {
        const direccion = document.createElement('span');
        direccion.className = 'tarjeta-meta-direccion';
        direccion.textContent = `üìç ${item.direccion}`;
        meta.appendChild(direccion);
      }
      const distanciaUsuario = obtenerDistanciaAUsuario(item);
      if (Number.isFinite(distanciaUsuario)) {
        const badge = document.createElement('span');
        badge.className = 'tarjeta-meta-badge';
        badge.textContent = `üß≠ ${formatearDistancia(distanciaUsuario)} de ti`;
        meta.appendChild(badge);
      }
      if (meta.childElementCount) {
        cabecera.appendChild(meta);
      }
      detalle.appendChild(cabecera);

      if (item.descripcion) {
        const descripcion = document.createElement('p');
        descripcion.className = 'tarjeta-descripcion';
        descripcion.textContent = item.descripcion;
        detalle.appendChild(descripcion);
      }

      if (Array.isArray(item.etiquetas) && item.etiquetas.length) {
        const etiquetas = document.createElement('div');
        etiquetas.className = 'etiquetas';
        item.etiquetas.forEach((tag) => {
          const span = document.createElement('span');
          span.className = 'etiqueta';
          span.textContent = tag;
          etiquetas.appendChild(span);
        });
        detalle.appendChild(etiquetas);
      }

      const fuentesGaleria = Array.isArray(item.galeria) ? item.galeria.filter((url) => isSafeImageURL(url)) : [];
      if (!fuentesGaleria.length && isSafeImageURL(item.imagen)) {
        fuentesGaleria.push(item.imagen);
      }
      if (fuentesGaleria.length) {
        const galeria = document.createElement('div');
        galeria.className = 'tarjeta-galeria';
        fuentesGaleria.forEach((src, indice) => {
          const img = document.createElement('img');
          img.src = src;
          img.alt = `Galer√≠a de ${item.nombre} (${indice + 1})`;
          img.loading = 'lazy';
          galeria.appendChild(img);
        });
        detalle.appendChild(galeria);
      }

      const acciones = document.createElement('div');
      acciones.className = 'tarjeta-acciones';
      let tieneAcciones = false;
      if (item.enlace && isSafeHttpUrl(item.enlace)) {
        const enlace = document.createElement('a');
        enlace.className = 'btn btn-ghost';
        enlace.textContent = 'Sitio oficial';
        if (safeLink(enlace, item.enlace)) {
          acciones.appendChild(enlace);
          tieneAcciones = true;
        }
      }
      const mapaUrl = construirUrlMapa(item);
      if (mapaUrl && isSafeHttpUrl(mapaUrl)) {
        const mapaBtn = document.createElement('a');
        mapaBtn.className = 'btn btn-ghost';
        mapaBtn.textContent = 'Ver en Google Maps';
        if (safeLink(mapaBtn, mapaUrl)) {
          acciones.appendChild(mapaBtn);
          tieneAcciones = true;
        }
      }
      if (tieneAcciones) {
        detalle.appendChild(acciones);
      }

      const mapaEmbed = construirMapaEmbed(item);
      if (mapaEmbed) {
        const mapaContenedor = document.createElement('div');
        mapaContenedor.className = 'tarjeta-mapa';
        const iframe = document.createElement('iframe');
        iframe.title = `Mapa de ${item.nombre}`;
        iframe.loading = 'lazy';
        iframe.referrerPolicy = 'no-referrer-when-downgrade';
        iframe.dataset.mapSrc = mapaEmbed;
        mapaContenedor.appendChild(iframe);
        detalle.appendChild(mapaContenedor);
      }

      if (mapaUrl) {
        const navegacion = document.createElement('div');
        navegacion.className = 'tarjeta-navegacion';
        navegacion.dataset.navegacionId = item.id;
        const labelNav = document.createElement('span');
        labelNav.className = 'sr-only';
        labelNav.textContent = 'Elige la aplicaci√≥n de navegaci√≥n';
        navegacion.appendChild(labelNav);
        const opcionesNav = document.createElement('div');
        opcionesNav.className = 'navegacion-opciones';
        opcionesNav.dataset.navOpciones = item.id;
        NAV_OPCIONES.forEach((opcion) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.dataset.navValor = opcion.value;
          btn.textContent = opcion.label;
          btn.setAttribute('aria-pressed', 'false');
          opcionesNav.appendChild(btn);
        });
        actualizarNavVisual(opcionesNav, obtenerPreferenciaNavegacion());
        navegacion.appendChild(opcionesNav);
        const boton = document.createElement('button');
        boton.type = 'button';
        boton.className = 'btn btn-primario';
        boton.dataset.abrirNavegador = item.id;
        boton.textContent = 'Abrir navegador';
        navegacion.appendChild(boton);
        detalle.appendChild(navegacion);
      }

      const seccionResenas = document.createElement('section');
      seccionResenas.className = 'tarjeta-resenas';
      seccionResenas.dataset.resenasItem = item.id;
      const controles = document.createElement('div');
      controles.className = 'detalle-reviews-controles';
      const filtros = document.createElement('div');
      filtros.className = 'filtros';
      const ordenId = `orden-${item.id}`;
      const labelOrden = document.createElement('label');
      labelOrden.textContent = 'Ordenar por';
      labelOrden.setAttribute('for', ordenId);
      filtros.appendChild(labelOrden);
      const selectOrden = document.createElement('select');
      selectOrden.id = ordenId;
      selectOrden.dataset.ordenResenas = item.id;
      [
        { value: 'recomendadas', label: 'Recomendadas' },
        { value: 'recientes', label: 'M√°s recientes' },
        { value: 'mejores', label: 'Mejor valoradas' },
        { value: 'peores', label: 'Peor valoradas' },
        { value: 'imagenes', label: 'Solo con im√°genes' }
      ].forEach((opcion) => {
        const option = document.createElement('option');
        option.value = opcion.value;
        option.textContent = opcion.label;
        selectOrden.appendChild(option);
      });
      filtros.appendChild(selectOrden);
      const filtroEstrellas = document.createElement('div');
      const textoFiltro = document.createElement('span');
      textoFiltro.textContent = 'Filtrar por estrellas:';
      filtroEstrellas.appendChild(textoFiltro);
      const selectorEstrellas = document.createElement('div');
      selectorEstrellas.className = 'stars-selector';
      selectorEstrellas.dataset.selectorEstrellas = item.id;
      for (let i = 1; i <= 5; i += 1) {
        const estrella = document.createElement('button');
        estrella.type = 'button';
        estrella.dataset.valor = String(i);
        estrella.setAttribute('aria-label', `${i} estrella${i === 1 ? '' : 's'}`);
        estrella.textContent = '‚òÖ';
        selectorEstrellas.appendChild(estrella);
      }
      filtroEstrellas.appendChild(selectorEstrellas);
      filtros.appendChild(filtroEstrellas);
      controles.appendChild(filtros);
      const resumenResenas = document.createElement('span');
      resumenResenas.dataset.detalleResumen = item.id;
      resumenResenas.textContent = 'Sin rese√±as todav√≠a';
      controles.appendChild(resumenResenas);
      seccionResenas.appendChild(controles);
      const estadoDetalle = document.createElement('p');
      estadoDetalle.className = 'lista-vacia';
      estadoDetalle.dataset.detalleEstado = item.id;
      estadoDetalle.textContent = 'A√∫n no hay rese√±as para este lugar.';
      seccionResenas.appendChild(estadoDetalle);
      const listaDetalle = document.createElement('div');
      listaDetalle.className = 'detalle-reviews-lista';
      listaDetalle.dataset.detalleLista = item.id;
      seccionResenas.appendChild(listaDetalle);
      detalle.appendChild(seccionResenas);

      if (state.claims.role === 'admin') {
        const accionesAdmin = document.createElement('div');
        accionesAdmin.className = 'tarjeta-acciones';
        const btnEliminar = document.createElement('button');
        btnEliminar.type = 'button';
        btnEliminar.className = 'btn btn-ghost';
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.addEventListener('click', () => eliminarDocumento(coleccion, item.id));
        accionesAdmin.appendChild(btnEliminar);
        detalle.appendChild(accionesAdmin);
      }

      tarjeta.appendChild(detalle);

      const alternarDetalle = (mostrar) => {
        const abierto = mostrar ?? detalle.hidden;
        tarjeta.classList.toggle('expanded', abierto);
        detalle.hidden = !abierto;
        resumen.setAttribute('aria-expanded', String(abierto));
        if (abierto) {
          prepararDetalleTarjeta(tarjeta, item, detalle);
        }
      };

      resumen.addEventListener('click', () => alternarDetalle());

      return tarjeta;
    };


    const obtenerResenasDeItem = (itemId) => {
      if (!itemId) return [];
      const lista = state.resenasPorItem.get(itemId);
      return Array.isArray(lista) ? [...lista] : [];
    };

    const tieneImagenAdjunta = (resena = {}) => {
      if (Array.isArray(resena.imagenes) && resena.imagenes.length) return true;
      return Boolean(resena.imagenUrl);
    };

    const obtenerFiltrosDetalle = (itemId) => {
      if (!state.detalleResenas.has(itemId)) {
        state.detalleResenas.set(itemId, { orden: 'recomendadas', estrellas: 0 });
      }
      return state.detalleResenas.get(itemId);
    };

    const filtrarYOrdenarResenas = (lista, filtros = {}) => {
      const { orden = 'recomendadas', estrellas = 0 } = filtros;
      const soloImagenes = orden === 'imagenes' || Boolean(filtros.soloImagenes);
      const base = Array.isArray(lista) ? [...lista] : [];
      const filtradas = base.filter((entrada) => {
        if (!entrada) return false;
        if (estrellas > 0 && Math.round(clampRating(entrada.rating)) !== estrellas) {
          return false;
        }
        if (soloImagenes && !tieneImagenAdjunta(entrada)) {
          return false;
        }
        return true;
      });
      const compararRecientes = (a, b) => obtenerFechaResena(b) - obtenerFechaResena(a);
      const compararMejores = (a, b) => clampRating(b.rating) - clampRating(a.rating) || compararRecientes(a, b);
      const compararPeores = (a, b) => clampRating(a.rating) - clampRating(b.rating) || compararRecientes(a, b);
      switch (orden) {
        case 'recientes':
          filtradas.sort(compararRecientes);
          break;
        case 'mejores':
          filtradas.sort(compararMejores);
          break;
        case 'peores':
          filtradas.sort(compararPeores);
          break;
        case 'imagenes':
          filtradas.sort(compararRecientes);
          break;
        case 'recomendadas':
        default:
          filtradas.sort(compararMejores);
          break;
      }
      return filtradas;
    };

    function actualizarEstrellasVisual(contenedor, activa = 0, hover = 0) {
      if (!contenedor) return;
      const objetivo = hover || activa;
      contenedor.querySelectorAll('button').forEach((btn) => {
        const valor = Number(btn.dataset.valor);
        btn.classList.toggle('activo', objetivo > 0 && valor <= objetivo);
      });
    }

    const actualizarListaDetalleResenas = (seccion, lista, filtros = {}) => {
      if (!seccion) return;
      const listaNodo = seccion.querySelector('.detalle-reviews-lista');
      const estadoNodo = seccion.querySelector('[data-detalle-estado]');
      const resumenNodo = seccion.querySelector('[data-detalle-resumen]');
      const selectOrden = seccion.querySelector('select[data-orden-resenas]');
      const selectorEstrellas = seccion.querySelector('.stars-selector');
      if (selectOrden && selectOrden.value !== filtros.orden) {
        selectOrden.value = filtros.orden;
      }
      if (selectorEstrellas) {
        actualizarEstrellasVisual(selectorEstrellas, filtros.estrellas || 0);
      }
      if (resumenNodo) {
        const total = Array.isArray(lista) ? lista.length : 0;
        resumenNodo.textContent = total
          ? `${total} rese√±a${total === 1 ? '' : 's'}`
          : 'Sin rese√±as todav√≠a';
      }
      if (!listaNodo || !estadoNodo) return;
      const preparadas = filtrarYOrdenarResenas(lista, filtros);
      listaNodo.textContent = '';
      if (!preparadas.length) {
        estadoNodo.textContent = filtros.estrellas
          ? `No hay rese√±as con ${filtros.estrellas} estrella${filtros.estrellas === 1 ? '' : 's'}.`
          : 'A√∫n no hay rese√±as que coincidan con los filtros seleccionados.';
        estadoNodo.hidden = false;
        return;
      }
      estadoNodo.hidden = true;
      preparadas.forEach((resena) => {
        const articulo = document.createElement('article');
        articulo.className = 'detalle-resena';
        articulo.dataset.id = resena.id;
        const titulo = document.createElement('strong');
        titulo.textContent = resena.titulo || 'Rese√±a';
        articulo.appendChild(titulo);
        const rating = document.createElement('div');
        rating.className = 'rating';
        const nota = clampRating(resena.rating);
        const estrellas = Math.round(nota);
        const estrellasTexto = `${'‚òÖ'.repeat(estrellas)}${'‚òÜ'.repeat(Math.max(0, 5 - estrellas))}`;
        rating.textContent = `${estrellasTexto} (${nota.toFixed(1)})`;
        articulo.appendChild(rating);
        if (resena.texto) {
          const texto = document.createElement('p');
          texto.textContent = resena.texto;
          articulo.appendChild(texto);
        }
        if (tieneImagenAdjunta(resena)) {
          const figure = document.createElement('figure');
          const imagenes = Array.isArray(resena.imagenes) ? resena.imagenes : [resena.imagenUrl].filter(Boolean);
          imagenes.slice(0, 3).forEach((url, indice) => {
            if (!isSafeImageURL(url)) return;
            const img = document.createElement('img');
            img.src = url;
            img.alt = `Imagen ${indice + 1} de la rese√±a ${resena.titulo || ''}`.trim();
            img.loading = 'lazy';
            figure.appendChild(img);
          });
          if (figure.childElementCount) {
            articulo.appendChild(figure);
          }
        }
        const autor = document.createElement('small');
        const fecha = obtenerFechaResena(resena);
        const autorNombre = resena.autor || 'Visitante';
        autor.textContent = `${autorNombre} ¬∑ ${fecha.toLocaleDateString()}`;
        articulo.appendChild(autor);
        listaNodo.appendChild(articulo);
      });
    };

    const prepararDetalleTarjeta = (tarjeta, item, detalle) => {
      if (!detalle || detalle.dataset.preparado === 'true') return;
      detalle.dataset.preparado = 'true';
      const seccionResenas = detalle.querySelector('.tarjeta-resenas');
      const filtros = obtenerFiltrosDetalle(item.id);
      const selectOrden = seccionResenas?.querySelector('select[data-orden-resenas]');
      if (selectOrden) {
        selectOrden.value = filtros.orden;
        selectOrden.addEventListener('change', (event) => {
          const datos = obtenerFiltrosDetalle(item.id);
          datos.orden = event.target.value;
          actualizarListaDetalleResenas(seccionResenas, obtenerResenasDeItem(item.id), datos);
        });
      }
      const selectorEstrellas = seccionResenas?.querySelector('.stars-selector');
      if (selectorEstrellas) {
        selectorEstrellas.addEventListener('mouseleave', () => {
          const datos = obtenerFiltrosDetalle(item.id);
          actualizarEstrellasVisual(selectorEstrellas, datos.estrellas);
        });
        selectorEstrellas.querySelectorAll('button').forEach((btn) => {
          const valor = Number(btn.dataset.valor);
          btn.addEventListener('mouseenter', () => {
            const datos = obtenerFiltrosDetalle(item.id);
            actualizarEstrellasVisual(selectorEstrellas, datos.estrellas, valor);
          });
          btn.addEventListener('focus', () => {
            const datos = obtenerFiltrosDetalle(item.id);
            actualizarEstrellasVisual(selectorEstrellas, datos.estrellas, valor);
          });
          btn.addEventListener('mouseleave', () => {
            const datos = obtenerFiltrosDetalle(item.id);
            actualizarEstrellasVisual(selectorEstrellas, datos.estrellas);
          });
          btn.addEventListener('blur', () => {
            const datos = obtenerFiltrosDetalle(item.id);
            actualizarEstrellasVisual(selectorEstrellas, datos.estrellas);
          });
          btn.addEventListener('click', () => {
            const datos = obtenerFiltrosDetalle(item.id);
            datos.estrellas = datos.estrellas === valor ? 0 : valor;
            actualizarEstrellasVisual(selectorEstrellas, datos.estrellas);
            actualizarListaDetalleResenas(seccionResenas, obtenerResenasDeItem(item.id), datos);
          });
        });
      }
      const mapaIframe = detalle.querySelector('.tarjeta-mapa iframe');
      if (mapaIframe && !mapaIframe.src && mapaIframe.dataset.mapSrc) {
        mapaIframe.src = mapaIframe.dataset.mapSrc;
      }
      const navOpciones = detalle.querySelector('[data-nav-opciones]');
      if (navOpciones) {
        actualizarNavVisual(navOpciones, obtenerPreferenciaNavegacion());
        navOpciones.querySelectorAll('button').forEach((btn) => {
          btn.addEventListener('click', () => {
            establecerPreferenciaNavegacion(btn.dataset.navValor || 'auto');
          });
        });
      }
      const botonNavegar = detalle.querySelector('[data-abrir-navegador]');
      if (botonNavegar) {
        botonNavegar.addEventListener('click', () => {
          const destino = construirDestinoNavegacion(item, obtenerPreferenciaNavegacion());
          if (destino && isSafeHttpUrl(destino)) {
            window.open(destino, '_blank', 'noopener');
          } else {
            mostrarToast('No fue posible abrir la ubicaci√≥n seleccionada.');
          }
        });
      }
      actualizarListaDetalleResenas(seccionResenas, obtenerResenasDeItem(item.id), filtros);
    };

    const renderLista = (coleccion, docs, pagina) => {
      state.colecciones[coleccion] = Array.isArray(docs) ? docs : [];
      if (state.paginadores[coleccion]) {
        state.paginadores[coleccion].pagina = pagina;
      }
      actualizarColeccionView(coleccion);
      actualizarEstadoCercaniaUI();
    };

    const renderResenas = (items, pagina) => {
      const base = Array.isArray(items) ? items : [];
      const filtros = state.filtrosResenas || { orden: 'recomendadas', estrellas: 0, soloImagenes: false };
      const filtradas = filtrarYOrdenarResenas(base, filtros);
      listaResenas.textContent = '';
      if (resumenResenasGlobal) {
        const total = base.length;
        const visibles = filtradas.length;
        const detalles = [];
        if (filtros.estrellas) detalles.push(`${filtros.estrellas}‚òÖ`);
        if (filtros.soloImagenes || filtros.orden === 'imagenes') detalles.push('con fotos');
        resumenResenasGlobal.textContent = detalles.length
          ? `Mostrando ${visibles} de ${total} rese√±as ¬∑ ${detalles.join(' ¬∑ ')}`
          : `Mostrando ${visibles} de ${total} rese√±as`;
      }
      if (!filtradas.length) {
        const vacio = document.createElement('p');
        vacio.className = 'lista-vacia';
        vacio.textContent = 'S√© la primera persona en dejar una rese√±a.';
        listaResenas.appendChild(vacio);
      } else {
        filtradas.forEach((resena) => {
          const item = document.createElement('article');
          item.className = 'rese√±a';
          item.dataset.id = resena.id;
          const titulo = document.createElement('strong');
          titulo.textContent = resena.titulo;
          item.appendChild(titulo);
          const rating = document.createElement('div');
          rating.className = 'rating';
          const nota = clampRating(resena.rating);
          const estrellas = Math.round(nota);
          rating.textContent = `${'‚òÖ'.repeat(estrellas)}${'‚òÜ'.repeat(Math.max(0, 5 - estrellas))} (${nota.toFixed(1)})`;
          item.appendChild(rating);
          if (resena.itemId) {
            const destino = buscarItemPorId(resena.itemId);
            if (destino?.nombre) {
              const referencia = document.createElement('small');
              referencia.textContent = `Destino: ${destino.nombre}`;
              item.appendChild(referencia);
            }
          }
          if (resena.texto) {
            const texto = document.createElement('p');
            texto.textContent = resena.texto;
            item.appendChild(texto);
          }
          if (tieneImagenAdjunta(resena)) {
            const galeria = document.createElement('div');
            galeria.className = 'resena-imagenes';
            const imagenes = Array.isArray(resena.imagenes) ? resena.imagenes : [resena.imagenUrl].filter(Boolean);
            imagenes.slice(0, 3).forEach((url, index) => {
              if (!isSafeImageURL(url)) return;
              const img = document.createElement('img');
              img.src = url;
              img.alt = `Imagen ${index + 1} de la rese√±a ${resena.titulo || ''}`.trim();
              img.loading = 'lazy';
              galeria.appendChild(img);
            });
            if (galeria.childElementCount) {
              item.appendChild(galeria);
            }
          }
          const pie = document.createElement('small');
          const fecha = resena.creado?.seconds ? new Date(resena.creado.seconds * 1000) : new Date();
          pie.textContent = `Publicado el ${fecha.toLocaleDateString()}`;
          item.appendChild(pie);
          if (state.user && state.user.uid === resena.usuario) {
            const btnEliminar = document.createElement('button');
            btnEliminar.type = 'button';
            btnEliminar.className = 'btn btn-ghost';
            btnEliminar.textContent = 'Eliminar';
            btnEliminar.addEventListener('click', () => eliminarResena(resena.id));
            item.appendChild(btnEliminar);
          }
          listaResenas.appendChild(item);
        });
      }
      estadoResenas.textContent = `P√°gina ${pagina + 1} ¬∑ ${filtradas.length}/${base.length} rese√±as`;
      refrescarValoracionesGlobales();
    };

    const LIMITES_ETIQUETAS = { maxEtiquetas: 8, maxLongitud: 20 };

    const limpiarEtiquetas = (texto) => {
      if (!texto) return [];
      return texto.split(',').map((t) => t.trim()).filter((t) => t.length && t.length <= LIMITES_ETIQUETAS.maxLongitud).slice(0, LIMITES_ETIQUETAS.maxEtiquetas);
    };

    const cargarColeccion = async (coleccion, { reiniciar = false, siguiente = false, anterior = false } = {}) => {
      const paginador = state.paginadores[coleccion];
      if (!paginador) return;
      if (siguiente && !paginador.hayMas) return;

        if (!firebaseHabilitado || !db) {
          state.fuenteDatos = 'local';
          const docsLocales = obtenerDatosLocales(coleccion, paginador.tag);
          paginador.pagina = 0;
        paginador.hayMas = false;
        paginador.ultimo = null;
        paginador.historial = [null];
        renderLista(coleccion, docsLocales, 0);
        refrescarValoracionesGlobales();
        return;
      }

      if (!Array.isArray(paginador.historial)) paginador.historial = [null];

      let destinoPagina = paginador.pagina;
      let cursor = null;
      if (reiniciar) {
        destinoPagina = 0;
        paginador.historial = [null];
      } else if (siguiente) {
        cursor = paginador.ultimo;
        destinoPagina = paginador.pagina + 1;
      } else if (anterior && paginador.pagina > 0) {
        destinoPagina = paginador.pagina - 1;
        cursor = paginador.historial[destinoPagina] || null;
      }

      let q = query(collection(db, coleccion), orderBy('nombre', 'asc'), limit(LIMITES.pagina));
      if (paginador.tag && paginador.tag !== 'todos') {
        q = query(q, where('etiquetas', 'array-contains', paginador.tag));
      }
      if (cursor) {
        q = query(q, startAfter(cursor));
      }

      let snap;
      try {
        snap = await getDocs(q);
      } catch (error) {
        manejarErrorFirebase(error, `${coleccion}-query`);
        const docsLocales = obtenerDatosLocales(coleccion, paginador.tag);
        state.fuenteDatos = 'local';
        paginador.pagina = 0;
        paginador.hayMas = false;
        paginador.ultimo = null;
        paginador.historial = [null];
        renderLista(coleccion, docsLocales, 0);
        refrescarValoracionesGlobales();
        return;
      }
      if (siguiente && snap.empty) {
        paginador.hayMas = false;
        return;
      }
      const docs = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      if (!docs.length) {
        const locales = obtenerDatosLocales(coleccion, paginador.tag);
        if (locales.length) {
          state.fuenteDatos = 'local';
          paginador.pagina = 0;
          paginador.hayMas = false;
          renderLista(coleccion, locales, 0);
          refrescarValoracionesGlobales();
          return;
        }
      }
      paginador.hayMas = snap.docs.length === LIMITES.pagina;
      paginador.ultimo = snap.docs[snap.docs.length - 1] || cursor || null;
      paginador.pagina = destinoPagina;
      paginador.historial[destinoPagina] = cursor || null;
      renderLista(coleccion, docs, paginador.pagina);
      refrescarValoracionesGlobales();
    };

    document.querySelectorAll('.paginacion button').forEach((btn) => {
      btn.addEventListener('click', (event) => {
        const { prev, next } = event.currentTarget.dataset;
        const coleccion = prev || next;
        if (!coleccion) return;
        const opciones = { reiniciar: false, siguiente: Boolean(next), anterior: Boolean(prev) };
        cargarColeccion(coleccion, opciones).catch((error) => logError(error, 'paginacion'));
      });
    });

    const cargarResenas = async ({ reiniciar = false, siguiente = false, anterior = false } = {}) => {
      const paginador = state.paginadores.rese√±as;
      if (siguiente && !paginador.hayMas) return;

      if (!firebaseHabilitado || !db) {
        state.fuenteDatos = 'local';
        const docsLocales = Array.isArray(DATOS_LOCALES.rese√±as) ? [...DATOS_LOCALES.rese√±as] : [];
        state.rese√±as = docsLocales;
        paginador.pagina = 0;
        paginador.hayMas = false;
        renderResenas(docsLocales, 0);
        return;
      }

      if (!Array.isArray(paginador.historial)) paginador.historial = [null];

      let destinoPagina = paginador.pagina;
      let cursor = null;
      if (reiniciar) {
        destinoPagina = 0;
        paginador.historial = [null];
        paginador.ultimo = null;
      } else if (siguiente) {
        cursor = paginador.ultimo;
        destinoPagina = paginador.pagina + 1;
      } else if (anterior && paginador.pagina > 0) {
        destinoPagina = paginador.pagina - 1;
        cursor = paginador.historial[destinoPagina] || null;
      }

      let q = query(collection(db, 'rese√±as'), orderBy('creado', 'desc'), limit(LIMITES.rese√±as));
      if (cursor) {
        q = query(q, startAfter(cursor));
      }

      let snap;
      try {
        snap = await getDocs(q);
      } catch (error) {
        manejarErrorFirebase(error, 'rese√±as-query');
        const docsLocales = Array.isArray(DATOS_LOCALES.rese√±as) ? [...DATOS_LOCALES.rese√±as] : [];
        state.fuenteDatos = 'local';
        state.rese√±as = docsLocales;
        paginador.pagina = 0;
        paginador.hayMas = false;
        paginador.ultimo = null;
        paginador.historial = [null];
        renderResenas(docsLocales, 0);
        return;
      }
      if (siguiente && snap.empty) {
        paginador.hayMas = false;
        return;
      }
      const docs = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      if (!docs.length && Array.isArray(DATOS_LOCALES.rese√±as) && DATOS_LOCALES.rese√±as.length) {
        state.fuenteDatos = 'local';
        state.rese√±as = [...DATOS_LOCALES.rese√±as];
        paginador.pagina = 0;
        paginador.hayMas = false;
        renderResenas(state.rese√±as, 0);
        return;
      }
      paginador.hayMas = snap.docs.length === LIMITES.rese√±as;
      paginador.ultimo = snap.docs[snap.docs.length - 1] || cursor || null;
      paginador.pagina = destinoPagina;
      paginador.historial[destinoPagina] = cursor || null;
      state.rese√±as = docs;
      renderResenas(docs, paginador.pagina);
    };

    document.querySelectorAll('[data-next="rese√±as"], [data-prev="rese√±as"]').forEach((btn) => {
      btn.addEventListener('click', (event) => {
        const siguiente = Boolean(event.currentTarget.dataset.next);
        const anterior = Boolean(event.currentTarget.dataset.prev);
        cargarResenas({ siguiente, anterior }).catch((error) => logError(error, 'rese√±as'));
      });
    });

    const validarResena = (formData) => {
      const titulo = formData.get('titulo').trim();
      const texto = formData.get('texto').trim();
      const rating = clampRating(formData.get('rating'));
      const errores = [];
      if (!titulo || titulo.length > 60) errores.push('titulo');
      if (!texto || texto.length > 2000) errores.push('texto');
      if (rating < 1 || rating > 5) errores.push('rating');
      document.getElementById('ayudaTitulo').hidden = !errores.includes('titulo');
      document.getElementById('ayudaTexto').hidden = !errores.includes('texto');
      document.getElementById('ayudaRating').hidden = !errores.includes('rating');
      return errores.length === 0 ? { titulo, texto, rating } : null;
    };

    formResena.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (state.baneado) {
        mostrarToast('Tu acceso est√° bloqueado. Contacta con soporte.');
        return;
      }
      if (!state.user || state.claims.role === 'invitado') {
        mostrarToast('Inicia sesi√≥n para dejar una rese√±a.');
        return;
      }
      const datos = new FormData(formResena);
      const resena = validarResena(datos);
      if (!resena) return;
      const imagenesSeleccionadas = Array.isArray(state.imagenesResena) ? state.imagenesResena.slice(0, 3) : [];
      try {
        if (!firebaseHabilitado || !db) {
          const nueva = {
            id: `local-${Date.now()}`,
            ...resena,
            creado: { seconds: Math.floor(Date.now() / 1000) },
            usuario: state.user.uid,
            imagenes: imagenesSeleccionadas.map((img) => img.dataUrl)
          };
          DATOS_LOCALES.rese√±as.unshift(nueva);
          state.rese√±as = [...DATOS_LOCALES.rese√±as];
          renderResenas(state.rese√±as, 0);
          formResena.reset();
          state.imagenesResena = [];
          if (inputFotos) inputFotos.value = '';
          if (previewFotos) previewFotos.textContent = '';
          if (inputRating) {
            inputRating.value = '5';
            actualizarSelectorRating(5);
          }
          mostrarToast('Rese√±a guardada en modo local. Se sincronizar√° al conectarse.');
        } else {
          let imagenesSubidas = [];
          if (imagenesSeleccionadas.length) {
            if (!storage) {
              imagenesSubidas = imagenesSeleccionadas.map((img) => img.dataUrl);
            } else {
              for (let i = 0; i < imagenesSeleccionadas.length; i += 1) {
                const elemento = imagenesSeleccionadas[i];
                const extension = (elemento.file?.type || '').toLowerCase().includes('png') ? 'png' : 'jpg';
                const referencia = ref(storage, `rese√±as/${state.user.uid}/${Date.now()}-${i}.${extension}`);
                await uploadBytes(referencia, elemento.file, { contentType: elemento.file?.type || 'image/jpeg' });
                const url = await getDownloadURL(referencia);
                imagenesSubidas.push(url);
              }
            }
          }
          await addDoc(collection(db, 'rese√±as'), {
            ...resena,
            imagenes: imagenesSubidas,
            creado: serverTimestamp(),
            usuario: state.user.uid
          });
          formResena.reset();
          state.imagenesResena = [];
          if (inputFotos) inputFotos.value = '';
          if (previewFotos) previewFotos.textContent = '';
          if (inputRating) {
            inputRating.value = '5';
            actualizarSelectorRating(5);
          }
          mostrarToast('Rese√±a enviada. ¬°Gracias!');
          state.paginadores.rese√±as = { pagina: 0, ultimo: null, hayMas: true, historial: [null] };
          await cargarResenas({ reiniciar: true });
        }
      } catch (error) {
        logError(error, 'crear-resena');
      }
    });
    const eliminarResena = async (id) => {
      if (!state.user) return;
      try {
        if (!firebaseHabilitado || !db) {
          DATOS_LOCALES.rese√±as = DATOS_LOCALES.rese√±as.filter((item) => item.id !== id);
          state.rese√±as = state.rese√±as.filter((item) => item.id !== id);
          renderResenas(state.rese√±as, 0);
          mostrarToast('Rese√±a eliminada del modo local');
          return;
        }
        await deleteDoc(doc(db, 'rese√±as', id));
        mostrarToast('Rese√±a eliminada');
        state.paginadores.rese√±as = { pagina: 0, ultimo: null, hayMas: true, historial: [null] };
        await cargarResenas({ reiniciar: true });
      } catch (error) {
        logError(error, 'eliminar-resena');
      }
    };

    const mostrarConsentimiento = () => {
      if (!state.consentimiento) {
        bannerConsent.classList.add('visible');
      }
    };

    const activarAnalytics = () => {
      if (state.consentimiento !== 'aceptado' || analyticsInstance) return analyticsInstance;
      try {
        analyticsInstance = getAnalytics(app);
      } catch (error) {
        logError(error, 'analytics');
      }
      return analyticsInstance;
    };

    btnAceptarConsent.addEventListener('click', () => {
      localStorage.setItem('smv-consentimiento', 'aceptado');
      state.consentimiento = 'aceptado';
      bannerConsent.classList.remove('visible');
      activarAnalytics();
    });

    btnRechazarConsent.addEventListener('click', () => {
      localStorage.setItem('smv-consentimiento', 'rechazado');
      state.consentimiento = 'rechazado';
      bannerConsent.classList.remove('visible');
    });

    const setClimaBusy = (isBusy) => {
      const widgets = [widgetClimaHero, widgetClimaDetalle];
      widgets.forEach((widget) => {
        if (!widget) return;
        if (isBusy) {
          widget.setAttribute('aria-busy', 'true');
        } else {
          widget.removeAttribute('aria-busy');
        }
      });
    };

    const renderClimaWidget = (contenedor, listaPronostico, data) => {
      if (!contenedor) return;
      contenedor.textContent = '';
      const temp = document.createElement('strong');
      temp.textContent = `Temperatura: ${Math.round(data?.temperatura ?? 0)}¬∞C`;
      const descripcion = document.createElement('p');
      descripcion.textContent = data?.descripcion || 'Condiciones no disponibles';
      const actualizacion = document.createElement('small');
      actualizacion.textContent = `Actualizado: ${new Date().toLocaleTimeString()}`;
      contenedor.append(temp, descripcion, actualizacion);
      if (listaPronostico) {
        listaPronostico.textContent = '';
        if (Array.isArray(data?.pronostico) && data.pronostico.length) {
          data.pronostico.slice(0, 4).forEach((dia) => {
            const li = document.createElement('li');
            const fecha = dia?.fecha ? new Date(dia.fecha) : null;
            const etiqueta = fecha
              ? fecha.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' })
              : 'Pr√≥x.';
            const max = Number.isFinite(Number(dia?.max)) ? Math.round(dia.max) : null;
            const min = Number.isFinite(Number(dia?.min)) ? Math.round(dia.min) : null;
            const partes = [etiqueta];
            if (min !== null && max !== null) partes.push(`${min}¬∞ / ${max}¬∞`);
            if (dia?.descripcion) partes.push(dia.descripcion);
            li.textContent = partes.join(' ¬∑ ');
            listaPronostico.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.textContent = 'Sin pron√≥stico ampliado disponible.';
          listaPronostico.appendChild(li);
        }
      }
    };

    const renderClima = (data) => {
      renderClimaWidget(climaContenido, climaPronostico, data);
      renderClimaWidget(climaContenidoDetalle, climaPronosticoDetalle, data);
      setClimaBusy(false);
    };

    const CODIGOS_METEO_DESCRIPCION = {
      0: 'Cielo despejado',
      1: 'Mayormente despejado',
      2: 'Parcialmente nublado',
      3: 'Nublado',
      45: 'Niebla',
      48: 'Niebla con escarcha',
      51: 'Llovizna ligera',
      53: 'Llovizna moderada',
      55: 'Llovizna densa',
      61: 'Lluvia d√©bil',
      63: 'Lluvia moderada',
      65: 'Lluvia intensa',
      66: 'Lluvia helada d√©bil',
      67: 'Lluvia helada intensa',
      71: 'Nieve ligera',
      73: 'Nieve moderada',
      75: 'Fuertes nevadas',
      80: 'Chubascos ligeros',
      81: 'Chubascos moderados',
      82: 'Chubascos intensos',
      95: 'Tormenta',
      96: 'Tormenta con granizo leve',
      99: 'Tormenta con granizo fuerte'
    };

    const obtenerDescripcionClima = (codigo) => CODIGOS_METEO_DESCRIPCION[codigo] || 'Condiciones no disponibles';

    const construirClimaDesdeMeteo = (payload) => {
      const actual = payload?.current_weather;
      if (!actual) return null;
      const temperatura = Number(actual.temperature);
      const pronostico = [];
      const daily = payload?.daily;
      if (daily?.time && Array.isArray(daily.time)) {
        for (let i = 1; i < Math.min(daily.time.length, 5); i += 1) {
          pronostico.push({
            fecha: daily.time[i],
            max: daily.temperature_2m_max?.[i],
            min: daily.temperature_2m_min?.[i],
            descripcion: obtenerDescripcionClima(daily.weathercode?.[i])
          });
        }
      }
      return {
        temperatura: Number.isFinite(temperatura) ? temperatura : 0,
        descripcion: obtenerDescripcionClima(actual.weathercode),
        pronostico
      };
    };

    const METEO_COORDENADAS = { lat: 40.20732, lng: -3.57013 };

    const TIPOS_EVENTO_TEXTO = {
      fiesta_local: 'Festivo local',
      no_laborable: 'No laborable',
      no_lectivo: 'No lectivo',
      gastronomia: 'Gastronom√≠a',
      deporte: 'Deporte',
      cultura: 'Cultura',
      general: 'Agenda'
    };

    const obtenerEtiquetaTipo = (tipo) => {
      const clave = tipo || 'general';
      const texto = TIPOS_EVENTO_TEXTO[clave] || clave.replace(/_/g, ' ');
      return { texto, tipo: clave };
    };

    const inicializarClima = async () => {
      if (state.climaCache && Date.now() - state.climaCache.timestamp < 10 * 60 * 1000) {
        renderClima(state.climaCache.data);
        return;
      }
      setClimaBusy(true);
      const controlador = new AbortController();
      state.climaTimeout = setTimeout(() => controlador.abort(), 8000);
      let datosClima = null;
      try {
        const params = new URLSearchParams({
          latitude: String(METEO_COORDENADAS.lat),
          longitude: String(METEO_COORDENADAS.lng),
          current_weather: 'true',
          timezone: 'Europe/Madrid'
        });
        const respuesta = await fetch(`https://api.open-meteo.com/v1/forecast?${params.toString()}`, {
          signal: controlador.signal
        });
        if (!respuesta.ok) throw new Error('Error meteorol√≥gico');
        const payload = await respuesta.json();
        datosClima = construirClimaDesdeMeteo(payload);
        if (datosClima) {
          state.climaCache = { timestamp: Date.now(), data: datosClima };
          localStorage.setItem('smv-clima-cache', JSON.stringify(state.climaCache));
        }
      } catch (error) {
        if (error.name !== 'AbortError') {
          logError(error, 'clima');
        }
      } finally {
        clearTimeout(state.climaTimeout);
      }
      if (datosClima) {
        renderClima(datosClima);
      } else if (DATOS_LOCALES.clima) {
        renderClima(DATOS_LOCALES.clima);
      } else {
        if (climaContenido) climaContenido.textContent = 'No se pudo obtener el clima. Intenta m√°s tarde.';
        if (climaPronostico) climaPronostico.textContent = '';
        if (climaContenidoDetalle) climaContenidoDetalle.textContent = 'No se pudo obtener el clima. Intenta m√°s tarde.';
        if (climaPronosticoDetalle) climaPronosticoDetalle.textContent = '';
        setClimaBusy(false);
      }
    };

    const solicitarActualizacionClima = () => {
      state.climaCache = null;
      inicializarClima();
    };

    if (btnActualizarClima) {
      btnActualizarClima.addEventListener('click', solicitarActualizacionClima);
    }

    if (btnActualizarClimaDetalle) {
      btnActualizarClimaDetalle.addEventListener('click', solicitarActualizacionClima);
    }

    const renderEventosResumen = (eventos, { mes, anio, seleccion = null, eventosDelDia = [] } = {}) => {
      if (!detalleEventos) return;
      const fechaBase = new Date(typeof anio === 'number' ? anio : new Date().getFullYear(), typeof mes === 'number' ? mes : new Date().getMonth(), 1);
      detalleEventos.textContent = '';
      const titulo = document.createElement('h3');
      titulo.textContent = `Agenda de ${fechaBase.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}`;
      detalleEventos.appendChild(titulo);
      if (seleccion && eventosDelDia.length) {
        const destacado = document.createElement('p');
        destacado.textContent = `Eventos del ${seleccion.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' })}`;
        detalleEventos.appendChild(destacado);
      }
      if (!eventos.length) {
        const vacio = document.createElement('p');
        vacio.textContent = 'No hay eventos para el mes seleccionado.';
        detalleEventos.appendChild(vacio);
        return;
      }
      const lista = document.createElement('ul');
      lista.className = 'eventos-lista';
      eventos
        .slice()
        .sort((a, b) => {
          const fechaA = a.fecha?.seconds ? new Date(a.fecha.seconds * 1000) : new Date(a.fecha);
          const fechaB = b.fecha?.seconds ? new Date(b.fecha.seconds * 1000) : new Date(b.fecha);
          return fechaA - fechaB;
        })
        .forEach((evento) => {
          const item = document.createElement('li');
          item.className = 'evento-item';
          const fechaEvento = evento.fecha?.seconds ? new Date(evento.fecha.seconds * 1000) : new Date(evento.fecha);
          if (seleccion && fechaEvento.toDateString() === seleccion.toDateString()) {
            item.classList.add('destacado');
          }
          const cabecera = document.createElement('strong');
          const tituloEvento = document.createElement('span');
          tituloEvento.textContent = evento.titulo;
          const badge = document.createElement('span');
          const infoTipo = obtenerEtiquetaTipo(evento.tipo);
          badge.className = 'evento-badge';
          badge.dataset.tipo = infoTipo.tipo;
          badge.textContent = infoTipo.texto;
          cabecera.append(tituloEvento, badge);
          const descripcion = document.createElement('p');
          descripcion.textContent = evento.descripcion || 'Sin descripci√≥n disponible.';
          const fechaTexto = document.createElement('small');
          fechaTexto.textContent = fechaEvento.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' });
          item.append(cabecera, descripcion, fechaTexto);
          if (evento.enlace && isSafeHttpUrl(evento.enlace)) {
            const enlace = document.createElement('a');
            enlace.className = 'btn btn-ghost btn-sm';
            enlace.textContent = 'M√°s informaci√≥n';
            if (safeLink(enlace, evento.enlace)) item.appendChild(enlace);
          }
          lista.appendChild(item);
        });
      detalleEventos.appendChild(lista);
    };

    const prepararCalendario = (eventos) => {
      state.eventos = eventos;
      const anios = new Set();
      const mesActualNum = mesActual.getMonth();
      const anioActual = mesActual.getFullYear();
      eventos.forEach((evento) => {
        const fecha = evento.fecha?.seconds ? new Date(evento.fecha.seconds * 1000) : new Date();
        anios.add(fecha.getFullYear());
      });
      [anioActual - 1, anioActual, anioActual + 1].forEach((anio) => anios.add(anio));
      selectAnio.textContent = '';
      Array.from(anios).sort((a, b) => a - b).forEach((anio) => {
        const option = document.createElement('option');
        option.value = String(anio);
        option.textContent = String(anio);
        if (anio === anioActual) option.selected = true;
        selectAnio.appendChild(option);
      });
      selectMes.textContent = '';
      const formatoMes = new Intl.DateTimeFormat('es', { month: 'long' });
      for (let m = 0; m < 12; m += 1) {
        const opcion = document.createElement('option');
        opcion.value = String(m);
        opcion.textContent = formatoMes.format(new Date(2024, m, 1));
        if (m === mesActualNum) opcion.selected = true;
        selectMes.appendChild(opcion);
      }
      renderCalendario();
    };

    const renderCalendario = () => {
      const mes = Number.parseInt(selectMes.value, 10);
      const anio = Number.parseInt(selectAnio.value, 10);
      const primerDia = new Date(anio, mes, 1);
      const ultimoDia = new Date(anio, mes + 1, 0);
      const dias = [];
      const offset = primerDia.getDay() === 0 ? 6 : primerDia.getDay() - 1;
      for (let i = 0; i < offset; i += 1) dias.push(null);
      for (let d = 1; d <= ultimoDia.getDate(); d += 1) dias.push(new Date(anio, mes, d));
      gridCalendario.textContent = '';
      const eventosMes = state.eventos.filter((evento) => {
        const fecha = evento.fecha?.seconds ? new Date(evento.fecha.seconds * 1000) : new Date();
        return fecha.getMonth() === mes && fecha.getFullYear() === anio;
      });
      dias.forEach((fecha) => {
        const celda = document.createElement('div');
        celda.className = 'dia-calendario';
        if (fecha) {
          const numero = document.createElement('strong');
          numero.textContent = String(fecha.getDate());
          celda.appendChild(numero);
          const delDia = eventosMes.filter((evento) => {
            const f = evento.fecha?.seconds ? new Date(evento.fecha.seconds * 1000) : new Date();
            return f.getDate() === fecha.getDate();
          });
          if (delDia.length) {
            celda.classList.add('evento');
            celda.dataset.tipo = delDia[0].tipo || 'general';
            const texto = document.createElement('span');
            texto.textContent = delDia[0].titulo;
            celda.appendChild(texto);
            celda.tabIndex = 0;
            celda.setAttribute('role', 'button');
            const abrir = () => mostrarEventosDia(fecha, delDia, eventosMes, mes, anio);
            celda.addEventListener('click', abrir);
            celda.addEventListener('keydown', (event) => {
              if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                abrir();
              }
            });
          }
        }
        gridCalendario.appendChild(celda);
      });
      renderEventosResumen(eventosMes, { mes, anio });
    };

    const mostrarEventosDia = (fecha, eventos, eventosMes, mes, anio) => {
      renderEventosResumen(eventosMes, { mes, anio, seleccion: fecha, eventosDelDia: eventos });
    };

    selectMes.addEventListener('change', renderCalendario);
    selectAnio.addEventListener('change', renderCalendario);

    const renderHistoria = (items) => {
      const contenedor = document.getElementById('listaHistoria');
      contenedor.textContent = '';
      if (!items.length) {
        const vacio = document.createElement('p');
        vacio.className = 'lista-vacia';
        vacio.textContent = 'Pr√≥ximamente a√±adiremos m√°s hitos hist√≥ricos.';
        contenedor.appendChild(vacio);
        return;
      }
      items.forEach((evento) => {
        const tarjeta = document.createElement('article');
        tarjeta.className = 'tarjeta';
        const titulo = document.createElement('h3');
        titulo.textContent = `${evento.anio} ¬∑ ${evento.titulo}`;
        tarjeta.appendChild(titulo);
        const descripcion = document.createElement('p');
        descripcion.textContent = evento.descripcion;
        tarjeta.appendChild(descripcion);
        contenedor.appendChild(tarjeta);
      });
    };
    const abrirModalAdmin = (item = null, coleccion = 'lugares') => {
      formAdmin.reset();
      formAdmin.dataset.id = item ? item.id : '';
      formAdmin.dataset.coleccion = coleccion;
      const coleccionActual = item?.coleccion || coleccion;
      if (formAdmin.coleccion) formAdmin.coleccion.value = coleccionActual;
      if (item) {
        if (formAdmin.nombre) formAdmin.nombre.value = item.nombre || '';
        if (formAdmin.descripcion) formAdmin.descripcion.value = item.descripcion || '';
        if (formAdmin.imagen) formAdmin.imagen.value = item.imagen || '';
        if (formAdmin.etiquetas) {
          formAdmin.etiquetas.value = Array.isArray(item.etiquetas) ? item.etiquetas.join(', ') : '';
        }
        if (formAdmin.enlace) formAdmin.enlace.value = item.enlace || '';
      }
      if (inputDireccion) inputDireccion.value = item?.direccion || '';
      if (inputLatitud) inputLatitud.value = '';
      if (inputLongitud) inputLongitud.value = '';
      const coordsExistentes = item ? obtenerCoordenadas(item) : null;
      if (coordsExistentes) {
        if (inputLatitud) inputLatitud.value = Number(coordsExistentes.lat).toFixed(6);
        if (inputLongitud) inputLongitud.value = Number(coordsExistentes.lng).toFixed(6);
      }
      if (inputGaleria) {
        const urlsGaleria = Array.isArray(item?.galeria) ? item.galeria.filter((url) => typeof url === 'string') : [];
        inputGaleria.value = urlsGaleria.join('\n');
      }
      if (inputArchivosGaleria) inputArchivosGaleria.value = '';
      modalAdmin.classList.add('visible');
      modalAdmin.setAttribute('aria-hidden', 'false');
      formAdmin.querySelector('input, select, textarea').focus();
    };

    const cerrarModalAdmin = () => {
      modalAdmin.classList.remove('visible');
      modalAdmin.setAttribute('aria-hidden', 'true');
      formAdmin.removeAttribute('data-id');
      formAdmin.removeAttribute('data-coleccion');
    };

    const abrirModalGenerico = (modal) => {
      modal.classList.add('visible');
      modal.setAttribute('aria-hidden', 'false');
      const focusable = modal.querySelector('input, button, select, textarea');
      if (focusable) focusable.focus();
    };

    const cerrarModalGenerico = (modal) => {
      modal.classList.remove('visible');
      modal.setAttribute('aria-hidden', 'true');
    };

    btnAbrirModalAdmin.addEventListener('click', () => abrirModalAdmin());
    btnCerrarModalAdmin.addEventListener('click', cerrarModalAdmin);
    modalAdmin.addEventListener('click', (event) => {
      if (event.target === modalAdmin) cerrarModalAdmin();
    });
    btnLogin.addEventListener('click', () => abrirModalGenerico(modalBienvenida));
    btnCerrarModalBienvenida.addEventListener('click', () => {
      cerrarModalGenerico(modalBienvenida);
      state.claims = { role: 'invitado' };
      panelCuenta.disabled = true;
    });
    btnLoginCorreo.addEventListener('click', () => {
      cerrarModalGenerico(modalBienvenida);
      abrirModalGenerico(modalLogin);
    });

    const iniciarSesionInvitado = () => {
      cerrarModalGenerico(modalBienvenida);
      state.user = null;
      state.claims = { role: 'invitado' };
      state.offlineAuth = false;
      panelCuenta.disabled = true;
      if (estadoCuenta) estadoCuenta.hidden = true;
      mostrarToast('Est√°s navegando como invitado. Inicia sesi√≥n para publicar rese√±as.');
    };

    const iniciarConProveedor = async (provider, nombre) => {
      if (!provider || !firebaseHabilitado || !auth) {
        mostrarToast(`Con√©ctate para usar el acceso con ${nombre}.`);
        return;
      }
      try {
        await signInWithPopup(auth, provider);
        cerrarModalGenerico(modalBienvenida);
        mostrarToast(`Sesi√≥n iniciada con ${nombre}.`);
      } catch (error) {
        if (error.code === 'auth/popup-closed-by-user') return;
        logError(error, `${nombre}-login`);
      }
    };

    btnInvitado.addEventListener('click', iniciarSesionInvitado);
    btnLoginGoogle.addEventListener('click', () => iniciarConProveedor(googleProvider, 'Google'));
    btnLoginFacebook.addEventListener('click', () => iniciarConProveedor(facebookProvider, 'Facebook'));
    const cerrarLogin = () => {
      cerrarModalGenerico(modalLogin);
      errorLogin.hidden = true;
      formLogin.reset();
    };
    btnCerrarModalLogin.addEventListener('click', cerrarLogin);
    modalLogin.addEventListener('click', (event) => {
      if (event.target === modalLogin) cerrarLogin();
    });

    const validarContenido = (datos) => {
      const coleccion = (datos.get('coleccion') || '').toString().trim();
      if (!coleccion) throw new Error('Colecci√≥n inv√°lida');
      const nombre = (datos.get('nombre') || '').toString().trim();
      const descripcion = (datos.get('descripcion') || '').toString().trim();
      const imagen = (datos.get('imagen') || '').toString().trim();
      const archivo = datos.get('archivoImagen');
      const enlace = (datos.get('enlace') || '').toString().trim();
      const etiquetas = limpiarEtiquetas(datos.get('etiquetas'));
      const direccion = (datos.get('direccion') || '').toString().trim();
      const latitudTexto = (datos.get('latitud') || '').toString().trim();
      const longitudTexto = (datos.get('longitud') || '').toString().trim();
      const galeriaTexto = (datos.get('galeria') || '').toString();
      const galeria = galeriaTexto
        .split(/\r?\n/)
        .map((linea) => linea.trim())
        .filter((linea) => linea.length);
      const archivosGaleria = (datos.getAll('archivosGaleria') || []).filter(
        (file) => file instanceof File && file.size > 0
      );
      if (!nombre || nombre.length > 60) throw new Error('Nombre inv√°lido');
      if (!descripcion || descripcion.length > 2000) throw new Error('Descripci√≥n inv√°lida');
      const tieneArchivo = archivo && archivo.size > 0;
      if (tieneArchivo && !archivo.type.startsWith('image/')) throw new Error('El archivo debe ser una imagen.');
      if (!imagen && !tieneArchivo) throw new Error('Proporciona una imagen o sube un archivo.');
      if (imagen && !isSafeImageURL(imagen)) throw new Error('URL de imagen no segura');
      if (enlace && !isSafeHttpUrl(enlace)) throw new Error('Enlace no v√°lido');
      if (direccion.length > 160) throw new Error('La direcci√≥n es demasiado larga.');
      galeria.forEach((url) => {
        if (!isSafeImageURL(url)) throw new Error('Una URL de la galer√≠a no es segura.');
      });
      archivosGaleria.forEach((file) => {
        if (!file.type.startsWith('image/')) throw new Error('Los archivos de la galer√≠a deben ser im√°genes.');
      });
      if (galeria.length + archivosGaleria.length > 10) {
        throw new Error('La galer√≠a admite como m√°ximo 10 im√°genes.');
      }
      const latitud = latitudTexto ? Number(latitudTexto) : null;
      const longitud = longitudTexto ? Number(longitudTexto) : null;
      if (latitud != null && (!Number.isFinite(latitud) || latitud < -90 || latitud > 90)) {
        throw new Error('Latitud inv√°lida');
      }
      if (longitud != null && (!Number.isFinite(longitud) || longitud < -180 || longitud > 180)) {
        throw new Error('Longitud inv√°lida');
      }
      if ((latitud != null) !== (longitud != null)) {
        throw new Error('Indica latitud y longitud para fijar la ubicaci√≥n.');
      }
      return {
        coleccion,
        nombre,
        descripcion,
        imagen,
        archivo: tieneArchivo ? archivo : null,
        enlace: enlace || null,
        etiquetas,
        direccion,
        coordenadas: latitud != null && longitud != null ? [latitud, longitud] : null,
        galeria,
        archivosGaleria
      };
    };

    const archivoADataURL = (archivo) => new Promise((resolve, reject) => {
      const lector = new FileReader();
      lector.onload = () => resolve(lector.result);
      lector.onerror = () => reject(new Error('No se pudo leer el archivo'));
      lector.readAsDataURL(archivo);
    });

    const subirImagenContenido = async (archivo, coleccion, nombre) => {
      if (!archivo) return null;
      if (firebaseHabilitado && storage) {
        const slug = nombre.toLowerCase().replace(/[^a-z0-9]+/g, '-').slice(0, 40) || 'imagen';
        const ruta = `contenido/${coleccion}/${Date.now()}-${slug}`;
        const referencia = ref(storage, ruta);
        await uploadBytes(referencia, archivo, { contentType: archivo.type });
        return await getDownloadURL(referencia);
      }
      return archivoADataURL(archivo);
    };

    const procesarArchivosGaleria = async (archivos, coleccion, nombre) => {
      if (!Array.isArray(archivos) || !archivos.length) return [];
      const resultados = [];
      for (let i = 0; i < archivos.length; i += 1) {
        const archivo = archivos[i];
        try {
          const url = await subirImagenContenido(archivo, coleccion, `${nombre}-galeria-${i + 1}`);
          if (url && isSafeImageURL(url)) {
            resultados.push(url);
          }
        } catch (error) {
          logError(error, 'admin-galeria');
        }
      }
      return resultados;
    };

    formAdmin.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (state.claims.role !== 'admin') {
        mostrarToast('Necesitas permisos de administrador.');
        return;
      }
      try {
        const datos = new FormData(formAdmin);
        const contenido = validarContenido(datos);
        const imagenFinal = contenido.archivo ? await subirImagenContenido(contenido.archivo, contenido.coleccion, contenido.nombre) : contenido.imagen;
        if (!imagenFinal || !isSafeImageURL(imagenFinal)) throw new Error('No fue posible procesar la imagen.');
        const nuevasGalerias = await procesarArchivosGaleria(
          contenido.archivosGaleria,
          contenido.coleccion,
          contenido.nombre
        );
        const galeriaFinal = [...contenido.galeria, ...nuevasGalerias]
          .filter((url, indice, arr) => url && arr.indexOf(url) === indice);
        const actualizado = firebaseHabilitado && db ? serverTimestamp() : { seconds: Math.floor(Date.now() / 1000) };
        const docData = {
          nombre: contenido.nombre,
          descripcion: contenido.descripcion,
          imagen: imagenFinal,
          etiquetas: contenido.etiquetas,
          enlace: contenido.enlace,
          direccion: contenido.direccion || null,
          coordenadas: contenido.coordenadas || null,
          galeria: galeriaFinal,
          actualizado
        };
        const existente = formAdmin.dataset.id;
        if (!firebaseHabilitado || !db) {
          const nuevo = { id: existente || `local-${Date.now()}`, ...docData };
          if (!Array.isArray(DATOS_LOCALES[contenido.coleccion])) DATOS_LOCALES[contenido.coleccion] = [];
          if (existente) {
            DATOS_LOCALES[contenido.coleccion] = DATOS_LOCALES[contenido.coleccion].map((item) => (item.id === existente ? { ...item, ...nuevo } : item));
            mostrarToast('Contenido actualizado en modo local');
          } else {
            DATOS_LOCALES[contenido.coleccion].push({ ...nuevo, creado: { seconds: Math.floor(Date.now() / 1000) } });
            mostrarToast('Contenido creado en modo local');
          }
        } else if (existente) {
          await updateDoc(doc(db, contenido.coleccion, existente), docData);
          mostrarToast('Contenido actualizado');
        } else {
          await addDoc(collection(db, contenido.coleccion), { ...docData, creado: serverTimestamp() });
          mostrarToast('Contenido creado');
        }
        cerrarModalAdmin();
        await cargarColeccion(contenido.coleccion, { reiniciar: true });
      } catch (error) {
        logError(error, 'admin-guardar');
      }
    });

    const eliminarDocumento = async (coleccion, id) => {
      if (state.claims.role !== 'admin') return;
      try {
        if (!firebaseHabilitado || !db) {
          if (Array.isArray(DATOS_LOCALES[coleccion])) {
            DATOS_LOCALES[coleccion] = DATOS_LOCALES[coleccion].filter((item) => item.id !== id);
          }
          mostrarToast('Elemento eliminado en modo local');
          await cargarColeccion(coleccion, { reiniciar: true });
          return;
        }
        await deleteDoc(doc(db, coleccion, id));
        mostrarToast('Elemento eliminado');
        await cargarColeccion(coleccion, { reiniciar: true });
      } catch (error) {
        logError(error, 'admin-eliminar');
      }
    };

    const renderAdminLista = async () => {
      if (state.claims.role !== 'admin') return;
      const colecciones = ['lugares', 'restaurantes', 'ocio'];
      const renderLocal = () => {
        listaAdmin.textContent = '';
        colecciones.forEach((coleccion) => {
          const titulo = document.createElement('li');
          titulo.textContent = `Colecci√≥n ${coleccion}`;
          listaAdmin.appendChild(titulo);
          obtenerDatosLocales(coleccion).forEach((itemLocal) => {
            const item = document.createElement('li');
            item.textContent = itemLocal.nombre;
            listaAdmin.appendChild(item);
          });
        });
      };
      if (!firebaseHabilitado || !db) {
        renderLocal();
        return;
      }
      listaAdmin.textContent = '';
      try {
        for (const coleccion of colecciones) {
          const snap = await getDocs(query(collection(db, coleccion), orderBy('nombre', 'asc'), limit(10)));
          const titulo = document.createElement('li');
          titulo.textContent = `Colecci√≥n ${coleccion}`;
          listaAdmin.appendChild(titulo);
          snap.docs.forEach((d) => {
            const item = document.createElement('li');
            item.textContent = d.data().nombre;
            listaAdmin.appendChild(item);
          });
        }
      } catch (error) {
        manejarErrorFirebase(error, 'admin-lista');
        renderLocal();
      }
    };

    const safeSetGPX = (url) => {
      if (url && isSafeHttpUrl(url) && !/REEMPLAZAR/i.test(url)) {
        btnDescargarGPX.hidden = false;
        btnDescargarGPX.dataset.href = url;
      } else {
        btnDescargarGPX.hidden = true;
        delete btnDescargarGPX.dataset.href;
      }
    };

    btnDescargarGPX.addEventListener('click', () => {
      const href = btnDescargarGPX.dataset.href;
      if (href && isSafeHttpUrl(href)) {
        window.open(href, '_blank', 'noopener');
      }
    });

    const PREFERENCIAS = {
      modoOscuro: { key: 'smv-oscuro', checkbox: toggleModoOscuro, className: 'modo-oscuro' },
      modoSenior: { key: 'smv-senior', checkbox: toggleModoSenior, className: 'modo-senior' },
      fuente: { key: 'smv-fuente', checkbox: toggleFuente, className: 'fuente-dyslexia' },
      reducir: { key: 'smv-reducir', checkbox: toggleReducir, className: 'reducir-animaciones' },
      contraste: { key: 'smv-contraste', checkbox: toggleContraste, className: 'alto-contraste', quick: initContraste },
      texto: { key: 'smv-texto', checkbox: toggleTexto, className: 'texto-grande', quick: initTexto },
      espaciado: { key: 'smv-espaciado', checkbox: toggleEspaciado, className: 'espaciado-amplio', quick: initEspaciado },
      botones: { key: 'smv-botones', checkbox: toggleBotones, className: 'botones-amplios' },
      links: { key: 'smv-links', checkbox: toggleLinks, className: 'links-subrayados', quick: initLinks },
      lectura: { key: 'smv-lectura', checkbox: toggleLecturaFacil, className: 'lectura-facil' },
      visibilidad: { key: 'smv-visibilidad', checkbox: toggleVisibilidad, className: 'modo-visibilidad' }
    };

    const actualizarOpcionesSenior = () => {
      const activo = Boolean(toggleModoSenior?.checked);
      document.querySelectorAll('[data-senior-control]').forEach((input) => {
        input.disabled = !activo;
        const etiqueta = input.closest('.toggle');
        if (etiqueta) etiqueta.classList.toggle('is-disabled', !activo);
      });
    };

    const aplicarPreferencias = () => {
      Object.values(PREFERENCIAS).forEach((pref) => {
        const activo = localStorage.getItem(pref.key) === 'on';
        if (pref.checkbox) pref.checkbox.checked = activo;
        if (pref.quick) pref.quick.checked = activo;
        if (pref.className) document.body.classList.toggle(pref.className, activo);
      });
      actualizarOpcionesSenior();
    };

    const actualizarPreferencia = (pref, value) => {
      localStorage.setItem(pref.key, value ? 'on' : 'off');
      aplicarPreferencias();
    };

    Object.values(PREFERENCIAS).forEach((pref) => {
      if (pref.checkbox) {
        pref.checkbox.addEventListener('change', (event) => {
          actualizarPreferencia(pref, event.target.checked);
          if (pref.checkbox === toggleModoSenior) {
            actualizarOpcionesSenior();
            if (event.target.checked) {
              ['texto', 'espaciado', 'botones'].forEach((clave) => {
                const objetivo = PREFERENCIAS[clave];
                if (objetivo?.checkbox && !objetivo.checkbox.checked) {
                  objetivo.checkbox.checked = true;
                  actualizarPreferencia(objetivo, true);
                }
              });
            }
          }
        });
      }
      if (pref.quick) {
        pref.quick.addEventListener('change', (event) => {
          actualizarPreferencia(pref, event.target.checked);
        });
      }
    });

    const establecerSesionOffline = (email, info) => {
      state.offlineAuth = true;
      const displayName = info.displayName || email.split('@')[0];
      state.user = { uid: `offline-${info.role}`, email, displayName, offline: true };
      state.claims = { role: info.role };
      btnLogin.hidden = true;
      btnLogout.hidden = false;
      panelCuenta.disabled = false;
      if (formPerfil && formPerfil.displayName) {
        formPerfil.displayName.value = displayName;
      }
      cerrarModalGenerico(modalLogin);
      cerrarModalGenerico(modalBienvenida);
      mostrarToast('Sesi√≥n iniciada en modo seguro sin conexi√≥n.');
      renderAdminLista();
    };

    formLogin.addEventListener('submit', async (event) => {
      event.preventDefault();
      const email = formLogin.email.value.trim();
      const password = formLogin.password.value;
      if (!email || !password) {
        errorLogin.textContent = 'Completa email y contrase√±a v√°lidos.';
        errorLogin.hidden = false;
        return;
      }
      errorLogin.hidden = true;
      try {
        if (!firebaseHabilitado || !auth) throw new Error('firebase-offline');
        await signInWithEmailAndPassword(auth, email, password);
        cerrarModalGenerico(modalLogin);
        formLogin.reset();
        mostrarToast('Sesi√≥n iniciada correctamente');
      } catch (error) {
        const fallback = USUARIOS_FALLBACK[email];
        if (fallback && fallback.password === password) {
          establecerSesionOffline(email, fallback);
          formLogin.reset();
          return;
        }
        errorLogin.textContent = 'No fue posible iniciar sesi√≥n. Verifica las credenciales.';
        errorLogin.hidden = false;
        logError(error, 'login');
      }
    });

    btnLogout.addEventListener('click', () => {
      if (state.offlineAuth) {
        state.offlineAuth = false;
        state.user = null;
        state.claims = { role: 'visitante' };
        panelCuenta.disabled = true;
        btnLogin.hidden = false;
        btnLogout.hidden = true;
        mostrarToast('Sesi√≥n cerrada.');
        return;
      }
      if (auth) {
        signOut(auth).catch((error) => logError(error, 'logout'));
      }
    });

    const guardarBaneados = () => {
      localStorage.setItem('smv-baneados', JSON.stringify([...state.baneados]));
    };

    const aplicarBaneo = () => {
      state.baneado = true;
      document.body.dataset.baneado = 'true';
      abrirModalGenerico(modalBaneado);
    };

    const levantarBaneo = () => {
      state.baneado = false;
      document.body.dataset.baneado = 'false';
      cerrarModalGenerico(modalBaneado);
    };

    const actualizarListaBaneados = () => {
      listaBaneados.textContent = '';
      if (!state.baneados.size) {
        const vacio = document.createElement('li');
        vacio.textContent = 'Sin IPs bloqueadas.';
        listaBaneados.appendChild(vacio);
        return;
      }
      for (const ip of state.baneados) {
        const item = document.createElement('li');
        item.style.display = 'flex';
        item.style.justifyContent = 'space-between';
        item.style.alignItems = 'center';
        item.textContent = ip;
        if (state.claims.role === 'admin') {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-ghost';
          btn.textContent = 'Desbloquear';
          btn.addEventListener('click', () => {
            state.baneados.delete(ip);
            guardarBaneados();
            actualizarListaBaneados();
            if (state.ip === ip) levantarBaneo();
          });
          item.appendChild(btn);
        }
        listaBaneados.appendChild(item);
      }
    };

    const verificarBaneoActual = () => {
      if (state.ip && state.baneados.has(state.ip)) {
        aplicarBaneo();
      } else {
        levantarBaneo();
      }
    };

    formBan.addEventListener('submit', (event) => {
      event.preventDefault();
      if (state.claims.role !== 'admin') {
        mostrarToast('Solo el equipo administrador puede gestionar bloqueos.');
        return;
      }
      const ip = inputBanIp.value.trim();
      const patron = /^(?:\d{1,3}\.){3}\d{1,3}$/;
      if (!patron.test(ip)) {
        mostrarToast('Introduce una IP v√°lida.');
        return;
      }
      state.baneados.add(ip);
      guardarBaneados();
      actualizarListaBaneados();
      formBan.reset();
      mostrarToast(`IP ${ip} bloqueada.`);
      if (state.ip === ip) {
        aplicarBaneo();
      }
    });

    const obtenerIPPublica = async () => {
      try {
        const respuesta = await fetch('https://api.ipify.org?format=json');
        if (!respuesta.ok) throw new Error('ip');
        const data = await respuesta.json();
        state.ip = data.ip;
      } catch (error) {
        console.warn('No se pudo obtener la IP p√∫blica', error);
      } finally {
        verificarBaneoActual();
      }
    };

    actualizarListaBaneados();

    const mostrarEstadoCuenta = (mensaje, esError = false) => {
      if (!estadoCuenta) return;
      estadoCuenta.textContent = mensaje;
      estadoCuenta.hidden = false;
      estadoCuenta.style.color = esError ? '#d32f2f' : '#0b3d91';
    };

    formPerfil.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!state.user) {
        mostrarEstadoCuenta('Inicia sesi√≥n para actualizar tu nombre.', true);
        return;
      }
      const displayName = formPerfil.displayName.value.trim();
      if (!displayName) {
        mostrarEstadoCuenta('El nombre no puede estar vac√≠o.', true);
        return;
      }
      try {
        if (!firebaseHabilitado || !auth || !auth.currentUser) {
          state.user.displayName = displayName;
          mostrarEstadoCuenta('Nombre guardado localmente. Se sincronizar√° al conectarte.');
          return;
        }
        await updateProfile(auth.currentUser, { displayName });
        mostrarEstadoCuenta('Nombre actualizado correctamente.');
      } catch (error) {
        mostrarEstadoCuenta('No se pudo actualizar el nombre. Intenta de nuevo.', true);
        logError(error, 'perfil');
      }
    });

    formPassword.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!state.user) {
        mostrarEstadoCuenta('Inicia sesi√≥n para cambiar la contrase√±a.', true);
        return;
      }
      const nueva = formPassword.password.value;
      if (!nueva || nueva.length < 8) {
        mostrarEstadoCuenta('La contrase√±a debe tener al menos 8 caracteres.', true);
        return;
      }
      if (!firebaseHabilitado || !auth || !auth.currentUser) {
        mostrarEstadoCuenta('Con√©ctate a la red municipal para cambiar la contrase√±a.', true);
        return;
      }
      try {
        await updatePassword(auth.currentUser, nueva);
        formPassword.reset();
        mostrarEstadoCuenta('Contrase√±a actualizada.');
      } catch (error) {
        if (error.code === 'auth/requires-recent-login') {
          mostrarEstadoCuenta('Vuelve a iniciar sesi√≥n para confirmar el cambio de contrase√±a.', true);
        } else {
          mostrarEstadoCuenta('No se pudo actualizar la contrase√±a.', true);
        }
        logError(error, 'password');
      }
    });

    btnVerificarCorreo.addEventListener('click', async () => {
      if (!firebaseHabilitado || !auth || !auth.currentUser) {
        mostrarEstadoCuenta('Con√©ctate para solicitar un correo de verificaci√≥n.', true);
        return;
      }
      try {
        await sendEmailVerification(auth.currentUser);
        mostrarEstadoCuenta('Hemos enviado un correo de verificaci√≥n.');
      } catch (error) {
        mostrarEstadoCuenta('No se pudo enviar el correo. Intenta m√°s tarde.', true);
        logError(error, 'verificacion');
      }
    });

    btnCerrarSesiones.addEventListener('click', () => {
      if (state.offlineAuth) {
        mostrarEstadoCuenta('Cierra la sesi√≥n local desde el bot√≥n principal.', true);
        return;
      }
      if (auth) {
        signOut(auth).catch((error) => logError(error, 'cerrar-sesiones'));
      }
    });

    btnEliminarCuenta.addEventListener('click', async () => {
      if (!firebaseHabilitado || !auth || !auth.currentUser) {
        mostrarEstadoCuenta('Con√©ctate para solicitar la eliminaci√≥n de la cuenta.', true);
        return;
      }
      const confirmar = window.confirm('¬øSeguro que quieres eliminar la cuenta? Esta acci√≥n es irreversible.');
      if (!confirmar) return;
      try {
        await deleteUser(auth.currentUser);
        mostrarEstadoCuenta('Cuenta eliminada. Sentimos verte partir.');
      } catch (error) {
        if (error.code === 'auth/requires-recent-login') {
          mostrarEstadoCuenta('Vuelve a iniciar sesi√≥n y repite la operaci√≥n para confirmar la eliminaci√≥n.', true);
        } else {
          mostrarEstadoCuenta('No pudimos eliminar la cuenta. Contacta con soporte.', true);
        }
        logError(error, 'eliminar-cuenta');
      }
    });

    const actualizarUIAuth = async (user) => {
      state.user = user;
      if (!user) {
        state.claims = { role: 'visitante' };
        btnLogin.hidden = false;
        btnLogout.hidden = true;
        btnMenuAdmin.hidden = true;
        panelCuenta.disabled = true;
        cerrarModalAdmin();
        cerrarLogin();
        if (estadoCuenta) estadoCuenta.hidden = true;
        actualizarListaBaneados();
        return;
      }
      btnLogin.hidden = true;
      btnLogout.hidden = false;
      panelCuenta.disabled = false;
      if (estadoCuenta) estadoCuenta.hidden = true;
      if (user.offline) {
        const esAdmin = state.claims.role === 'admin';
        btnMenuAdmin.hidden = !esAdmin;
        if (!esAdmin) cerrarModalAdmin();
        if (esAdmin) await renderAdminLista();
        actualizarListaBaneados();
        return;
      }
      try {
        const tokenResult = await user.getIdTokenResult(true);
        state.claims = tokenResult.claims || { role: 'visitante' };
      } catch (error) {
        state.claims = { role: 'visitante' };
        logError(error, 'claims');
      }
      const esAdmin = state.claims.role === 'admin';
      btnMenuAdmin.hidden = !esAdmin;
      if (!esAdmin) cerrarModalAdmin();
      if (esAdmin) {
        await renderAdminLista();
      }
      actualizarListaBaneados();
    };

    if (firebaseHabilitado && auth) {
      onAuthStateChanged(auth, (user) => {
        actualizarUIAuth(user);
      });
    } else {
      actualizarUIAuth(null);
    }

    const asignarConfiguracionLocal = () => {
      if (DATOS_LOCALES.configuracion?.gpx) safeSetGPX(DATOS_LOCALES.configuracion.gpx);
      if (Array.isArray(DATOS_LOCALES.configuracion?.mapa)) {
        const [lat, lng] = DATOS_LOCALES.configuracion.mapa;
        iframeMapa.src = `https://www.google.com/maps?q=${lat},${lng}&output=embed`;
      }
    };

    const cargarDatosIniciales = async () => {
      try {
        await Promise.all([
          cargarColeccion('lugares', { reiniciar: true }),
          cargarColeccion('restaurantes', { reiniciar: true }),
          cargarColeccion('ocio', { reiniciar: true }),
          cargarResenas({ reiniciar: true })
        ]);
        actualizarIdeas();
        if (!firebaseHabilitado || !db) {
          prepararCalendario(Array.isArray(DATOS_LOCALES.eventos) ? DATOS_LOCALES.eventos : []);
          renderHistoria(Array.isArray(DATOS_LOCALES.historia) ? DATOS_LOCALES.historia : []);
          asignarConfiguracionLocal();
          return;
        }
        let eventosDocs = [];
        try {
          const eventosSnap = await getDocs(query(collection(db, 'eventos'), orderBy('fecha', 'asc'), limit(200)));
          eventosDocs = eventosSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
        } catch (error) {
          manejarErrorFirebase(error, 'eventos');
        }
        if (!firebaseHabilitado || !db || !eventosDocs.length) {
          prepararCalendario(Array.isArray(DATOS_LOCALES.eventos) ? DATOS_LOCALES.eventos : []);
        } else {
          prepararCalendario(eventosDocs);
        }

        let historiaDocs = [];
        try {
          const historiaSnap = await getDocs(query(collection(db, 'historia'), orderBy('anio', 'asc'), limit(50)));
          historiaDocs = historiaSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
        } catch (error) {
          manejarErrorFirebase(error, 'historia');
        }
        if (!firebaseHabilitado || !db || !historiaDocs.length) {
          renderHistoria(Array.isArray(DATOS_LOCALES.historia) ? DATOS_LOCALES.historia : []);
        } else {
          renderHistoria(historiaDocs);
        }

        if (!firebaseHabilitado || !db) {
          asignarConfiguracionLocal();
          return;
        }

        let configuracionSnap = null;
        try {
          configuracionSnap = await getDocs(query(collection(db, 'configuracion'), limit(5)));
        } catch (error) {
          manejarErrorFirebase(error, 'configuracion');
        }

        if (!firebaseHabilitado || !db || !configuracionSnap || configuracionSnap.empty) {
          asignarConfiguracionLocal();
        } else {
          configuracionSnap.docs.forEach((docCfg) => {
            const data = docCfg.data();
            if (data.gpx) safeSetGPX(data.gpx);
            if (data.mapa?.q && Array.isArray(data.mapa.q) && data.mapa.q.length === 2) {
              const [lat, lng] = data.mapa.q;
              iframeMapa.src = `https://www.google.com/maps?q=${lat},${lng}&output=embed`;
            }
          });
        }
      } catch (error) {
        manejarErrorFirebase(error, 'datos-iniciales');
        prepararCalendario(Array.isArray(DATOS_LOCALES.eventos) ? DATOS_LOCALES.eventos : []);
        renderHistoria(Array.isArray(DATOS_LOCALES.historia) ? DATOS_LOCALES.historia : []);
        asignarConfiguracionLocal();
      }
    };

    const limpiarAlDesactivar = () => {
      if (state.climaTimeout) {
        clearTimeout(state.climaTimeout);
        state.climaTimeout = null;
      }
    };

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        limpiarAlDesactivar();
      } else if (!state.climaCache || Date.now() - state.climaCache.timestamp >= 10 * 60 * 1000) {
        inicializarClima();
      }
    });

    window.addEventListener('beforeunload', () => {
      limpiarAlDesactivar();
    });

    abrirModalGenerico(modalBienvenida);
    aplicarPreferencias();
    mostrarConsentimiento();
    if (state.consentimiento === 'aceptado') activarAnalytics();
    inicializarClima();
    obtenerIPPublica();
    cargarDatosIniciales();
  </script>

  <footer>
    <strong>Hecho por Daniel Terroba Alcala</strong>
    <p style="margin:0.5rem 0 0;">Gu√≠a tur√≠stica oficial de San Mart√≠n de la Vega ¬∑ Datos no verificados por el equipo municipal.</p>
  </footer>
</body>
</html>
