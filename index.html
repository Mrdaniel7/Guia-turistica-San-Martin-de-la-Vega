<!DOCTYPE html>
<html lang="es">
<head>
  <!--
    Resumen de cambios:
    - Refactorización integral para reforzar seguridad (sin innerHTML inseguro, validación de URLs, claims de Firebase) y accesibilidad.
    - Añadidas paginaciones, limpieza de listeners, consentimiento de analytics y cacheo de clima con backoff.
    - Documentados headers, reglas Firestore, App Check y restricciones de claves; UI ajustada con foco visible y toasts accesibles.

    Cabeceras HTTP recomendadas:
    Content-Security-Policy: default-src 'self'; script-src 'self' https://www.gstatic.com https://www.googleapis.com; style-src 'self' 'unsafe-inline'; font-src 'self'; img-src 'self' https: data:; frame-src https://www.google.com; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; require-trusted-types-for 'script'
    Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
    X-Frame-Options: DENY
    Referrer-Policy: strict-origin-when-cross-origin
    Permissions-Policy: microphone=(), geolocation=(), fullscreen=()

    Firestore Security Rules (ejemplo)
    rules_version = '2';
    service cloud.firestore {
      match /databases/{database}/documents {
        function isAdmin() {
          return request.auth != null &&
            get(/databases/$(database)/documents/usuarios/$(request.auth.uid)).data.role == 'admin';
        }
        match /resenas/{id} {
          allow read: if true;
          allow create: if request.auth != null && request.resource.data.rating >=1 && request.resource.data.rating <=5
            && request.resource.data.titulo.size() <= 60 && request.resource.data.texto.size() <= 2000;
          allow update, delete: if request.auth != null && request.auth.uid == resource.data.usuarioId;
        }
        match /{col in ['lugares','restaurantes','ocio']}/{id} {
          allow read: if true;
          allow write: if isAdmin();
        }
      }
    }

    Notas de despliegue:
    - Habilita Firebase App Check (reCAPTCHA v3 o DeviceCheck) y exige tokens válidos para Auth, Firestore y Storage.
    - Restringe las API keys de mapas/clima por dominio, rutas y cuota. No publiques valores reales en el cliente.
    - Configura CORS del bucket de Storage al dominio oficial de la guía.
    - Gestiona la colección /usuarios/{uid} y el campo role para otorgar permisos administrativos.
  -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Turismo San Martín de la Vega</title>
  <!-- Favicon JPEG incrustado para evitar archivos binarios en el repositorio -->
  <link rel="icon" type="image/jpeg"
    href="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCABAAEADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwDwyiiiv1A+MCiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKAP/Z">
  <style>
    @font-face {
      /* Comentar hasta tener archivos válidos
      font-family: 'OpenDyslexic';
      src: url('assets/OpenDyslexic3-Regular.woff') format('woff'),
        url('assets/OpenDyslexic3-Regular.otf') format('opentype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
      */
    }

    :root {
      color-scheme: light;
      --color-fondo: #ffffff;
      --color-superficie: #f5f7fb;
      --color-primario: #0b3d91;
      --color-primario-oscuro: #072c68;
      --color-secundario: #4caf50;
      --color-texto: #17202a;
      --color-texto-suave: #4a5568;
      --color-header-texto: #ffffff;
      --color-header-texto-suave: rgba(255, 255, 255, 0.85);
      --color-borde: rgba(11, 61, 145, 0.12);
      --color-alerta: #d32f2f;
      --color-aviso: #ffc107;
      --sombra: 0 10px 28px rgba(11, 61, 145, 0.1);
      --radio: 18px;
      --transicion: 0.24s ease;
      --max-ancho: 1100px;
      --fuente-base: "Segoe UI", "Helvetica Neue", Arial, system-ui, sans-serif;
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body.reducir-animaciones *,
    body.reducir-animaciones *::before,
    body.reducir-animaciones *::after {
      transition-duration: 0.01ms !important;
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
    }

    body {
      margin: 0;
      font-family: var(--fuente-base);
      background: var(--color-fondo);
      color: var(--color-texto);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    body.menu-abierto {
      overflow: hidden;
    }

    body.fuente-dyslexia {
      font-family: 'OpenDyslexic', var(--fuente-base);
      letter-spacing: 0.03em;
      word-spacing: 0.05em;
    }

    body.visor-tarjeta-abierto {
      overflow: hidden;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    img {
      max-width: 100%;
      display: block;
    }

    button,
    input,
    select,
    textarea {
      font: inherit;
    }

    input:not([type='checkbox']):not([type='radio']),
    select,
    textarea {
      min-height: 44px;
    }

    button:not(:disabled) {
      cursor: pointer;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--color-primario);
      color: var(--color-header-texto);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 8px 18px rgba(7, 44, 104, 0.35);
      flex-wrap: wrap;
    }

    header img {
      width: 42px;
      height: 42px;
      object-fit: contain;
      flex: 0 0 auto;
    }

    .menu-toggle {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      border: none;
      background: rgba(255, 255, 255, 0.18);
      color: inherit;
      display: grid;
      place-items: center;
      font-size: 1.5rem;
      transition: background var(--transicion);
    }

    .menu-toggle:focus-visible,
    .menu-toggle:hover {
      outline: none;
      background: rgba(255, 255, 255, 0.28);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      flex: 1 1 auto;
      min-height: 0;
    }

    nav {
      position: fixed;
      inset: 0 auto 0 0;
      width: min(320px, 92vw);
      background: linear-gradient(180deg, var(--color-primario) 0%, var(--color-primario-oscuro) 100%);
      box-shadow: 12px 0 32px rgba(7, 44, 104, 0.2);
      padding: 1.5rem 1.25rem 4rem;
      overflow-y: auto;
      transition: transform var(--transicion);
      z-index: 120;
      transform: translateX(-110%);
    }

    nav:focus {
      outline: 3px solid rgba(255, 255, 255, 0.45);
      outline-offset: -4px;
    }

    nav.abierto {
      transform: translateX(0);
    }

    .overlay-menu {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transicion);
      z-index: 110;
    }

    .overlay-menu.visible {
      opacity: 1;
      visibility: visible;
    }

    .nav-links {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.75rem;
    }

    .nav-links button {
      width: 100%;
      border-radius: 14px;
      padding: 0.85rem 1rem;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.1);
      color: #f3f6ff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background var(--transicion), border-color var(--transicion), transform var(--transicion);
    }

    .nav-links button:hover,
    .nav-links button:focus-visible,
    .nav-links button.activo {
      outline: none;
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.55);
      transform: translateX(2px);
    }

    .sub-lista {
      list-style: none;
      margin: 0;
      padding: 0 0 0 1.5rem;
      display: none;
      gap: 0.4rem;
    }

    .sub-lista.visible {
      display: grid;
    }

    main {
      width: min(100%, var(--max-ancho));
      margin: 0 auto;
      padding: 1.5rem 1rem 4rem;
      display: grid;
      gap: 2rem;
    }

    .seccion {
      background: var(--color-superficie);
      border-radius: var(--radio);
      padding: 1.5rem;
      box-shadow: var(--sombra);
    }

    .seccion h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      font-size: 1.6rem;
    }

    .panel-hero {
      background: linear-gradient(135deg, rgba(11, 61, 145, 0.95), rgba(76, 175, 80, 0.85));
      color: #fff;
      border-radius: var(--radio);
      padding: 1.25rem 1.5rem;
      box-shadow: var(--sombra);
      display: grid;
      gap: 1.25rem;
      grid-template-columns: minmax(0, 1fr);
      align-items: start;
    }

    .panel-hero .hero-contenido {
      display: grid;
      gap: 0.75rem;
      max-width: 52ch;
    }

    .panel-hero .hero-complementos {
      display: grid;
      gap: 1rem;
      align-self: stretch;
      align-content: start;
    }

    .panel-hero .acciones {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      border-radius: 14px;
      padding: 0.65rem 1.35rem;
      border: 2px solid transparent;
      font-weight: 600;
      min-height: 44px;
      transition: transform var(--transicion), box-shadow var(--transicion), background var(--transicion);
    }

    .btn.btn-cargando {
      pointer-events: none;
      cursor: wait !important;
    }

    .spinner {
      width: 1rem;
      height: 1rem;
      border-radius: 50%;
      border: 2px solid currentColor;
      border-top-color: transparent;
      display: inline-block;
      animation: girar 0.8s linear infinite;
    }

    .btn:focus-visible {
      outline: 3px solid rgba(255, 255, 255, 0.7);
      outline-offset: 2px;
    }

    .btn-primario {
      background: var(--color-secundario);
      color: #fff;
      box-shadow: 0 12px 24px rgba(76, 175, 80, 0.25);
    }

    .btn-secundario {
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.45);
    }

    .btn-ghost {
      background: transparent;
      border-color: var(--color-borde);
      color: var(--color-primario);
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn.activo {
      background: var(--color-primario);
      color: #fff;
      border-color: var(--color-primario);
    }

    .btn.btn-sm {
      padding: 0.45rem 1rem;
      font-size: 0.9rem;
    }

    @media (min-width: 900px) {
      .panel-hero {
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
        align-items: stretch;
        padding: 1.5rem 1.75rem;
      }

      .panel-hero .hero-complementos {
        grid-template-rows: repeat(2, minmax(0, 1fr));
      }

      .hero-widget {
        min-height: 100%;
      }
    }

    .ideas-widget {
      display: grid;
      gap: 0.85rem;
      position: relative;
      background: linear-gradient(140deg, rgba(11, 61, 145, 0.92), rgba(76, 175, 80, 0.88));
      color: #fff;
      border-radius: var(--radio);
      padding: 1.25rem;
      box-shadow: var(--sombra);
      overflow: hidden;
    }

    .ideas-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .ideas-controles {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    .ideas-controles button {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.45);
      background: rgba(255, 255, 255, 0.15);
      color: inherit;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background var(--transicion), transform var(--transicion);
    }

    .ideas-controles button:disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    .ideas-controles button:hover,
    .ideas-controles button:focus-visible {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
      outline: none;
    }

    .ideas-contenido {
      display: grid;
      gap: 0.85rem;
    }

    .ideas-imagen {
      border-radius: calc(var(--radio) - 6px);
      min-height: 160px;
      background: rgba(255, 255, 255, 0.12);
      background-size: cover;
      background-position: center;
      position: relative;
      overflow: hidden;
    }

    .ideas-imagen::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(5, 24, 68, 0) 0%, rgba(5, 24, 68, 0.55) 100%);
    }

    .ideas-texto {
      display: grid;
      gap: 0.5rem;
    }

    .ideas-texto h3 {
      margin: 0;
      font-size: 1.25rem;
    }

    .ideas-texto p {
      margin: 0;
      line-height: 1.4;
      color: rgba(255, 255, 255, 0.9);
    }

    .ideas-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }

    .ideas-meta .tarjeta-valoracion {
      background: rgba(11, 61, 145, 0.55);
    }

    .ideas-progreso {
      position: absolute;
      left: 1.25rem;
      right: 1.25rem;
      bottom: 1.1rem;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 999px;
      overflow: hidden;
    }

    .ideas-progreso span {
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.1), #fff);
      border-radius: inherit;
      transition: width 0.2s ease;
    }

    .seccion > header {
      margin-bottom: 1.25rem;
      display: grid;
      gap: 0.35rem;
    }

    .filtros-acciones {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 1rem;
    }

    .seccion-contenido {
      display: grid;
      gap: 1.5rem;
    }

    .panel-resultados {
      display: grid;
      gap: 1.5rem;
    }

    .panel-filtros {
      display: none;
    }

    .panel-filtros[data-abierto="true"] {
      display: grid;
    }

    .panel-filtros {
      position: fixed;
      inset: 0;
      z-index: 140;
      padding: 1.25rem;
      background: rgba(11, 22, 48, 0.55);
      backdrop-filter: blur(6px);
    }

    .panel-filtros .panel-filtros-contenido {
      background: var(--color-superficie);
      border-radius: var(--radio);
      margin: 0 auto;
      max-width: min(420px, 96vw);
      padding: 1.25rem;
      box-shadow: var(--sombra);
      display: grid;
      gap: 1.25rem;
      max-height: min(85vh, 560px);
      overflow-y: auto;
    }

    .panel-filtros-cabecera {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .panel-filtros-cabecera h3 {
      margin: 0;
      font-size: 1.1rem;
    }

    .panel-filtros-cerrar {
      border: none;
      background: transparent;
      color: var(--color-texto);
      font-size: 1.5rem;
      line-height: 1;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
    }

    .panel-filtros-cerrar:focus-visible,
    .panel-filtros-cerrar:hover {
      background: rgba(11, 61, 145, 0.12);
      outline: none;
    }

    .filtro-grupo {
      display: grid;
      gap: 0.5rem;
    }

    .filtro-grupo h4 {
      margin: 0;
      font-size: 1rem;
      color: var(--color-primario);
    }

    .filtro-grupo small {
      color: var(--color-texto-suave);
    }

    .filtro-estado {
      margin: 0;
      color: var(--color-texto-suave);
      font-size: 0.9rem;
    }

    .filtro-rating button,
    .filtro-cercania .btn {
      font-size: 0.85rem;
    }

    body.panel-filtros-abierto {
      overflow: hidden;
    }

    @media (min-width: 900px) {
      .filtros-acciones {
        display: none;
      }

      .seccion-contenido {
        grid-template-columns: minmax(240px, 300px) minmax(0, 1fr);
        align-items: start;
      }

      .panel-filtros {
        position: sticky;
        top: 6.5rem;
        display: grid;
        padding: 0;
        background: transparent;
        backdrop-filter: none;
        z-index: auto;
      }

      .panel-filtros[data-abierto="true"] {
        display: grid;
      }

      .panel-filtros .panel-filtros-contenido {
        margin: 0;
        max-width: none;
        max-height: none;
      }

      .panel-filtros-cerrar {
        display: none;
      }
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .chip {
      border-radius: 999px;
      padding: 0.4rem 0.85rem;
      border: 1px solid var(--color-borde);
      background: #fff;
      color: var(--color-texto);
      transition: background var(--transicion), border-color var(--transicion), color var(--transicion);
    }

    .chip:hover,
    .chip:focus-visible,
    .chip.activo {
      background: rgba(11, 61, 145, 0.12);
      border-color: var(--color-primario);
      color: var(--color-primario);
      outline: none;
    }

    .tarjetas {
      display: grid;
      gap: 1.25rem;
    }

    .tarjeta {
      background: #fff;
      border-radius: var(--radio);
      border: 1px solid var(--color-borde);
      box-shadow: 0 8px 18px rgba(11, 61, 145, 0.08);
      overflow: hidden;
      display: grid;
      gap: 0;
      position: relative;
    }

    .tarjeta.expanded {
      position: fixed;
      inset: 0;
      z-index: 150;
      max-width: none;
      border-radius: 0;
      box-shadow: 0 24px 48px rgba(7, 44, 104, 0.35);
      background: var(--color-superficie);
      grid-template-rows: minmax(0, 1fr);
    }

    .tarjeta.expanded .tarjeta-resumen {
      display: none;
    }

    .tarjeta.expanded .tarjeta-detalle {
      padding: min(4vw, 2rem);
      overflow-y: auto;
      max-height: 100vh;
      display: grid;
      gap: 1.25rem;
    }

    @media (min-width: 768px) {
      .tarjeta.expanded {
        inset: 1.5rem;
        border-radius: calc(var(--radio) + 8px);
      }
    }

    .tarjeta-resumen {
      display: block;
      border: none;
      background: none;
      padding: 0;
      cursor: pointer;
      text-align: left;
      position: relative;
    }

    .tarjeta-resumen:focus-visible {
      outline: 3px solid var(--color-secundario);
      outline-offset: -3px;
    }

    .tarjeta-resumen-imagen {
      position: relative;
      aspect-ratio: 16 / 10;
      background: #e5e9f5;
    }

    .tarjeta-resumen-imagen img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .tarjeta-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      background: linear-gradient(180deg, rgba(8, 26, 74, 0) 30%, rgba(8, 26, 74, 0.85) 100%);
      color: #fff;
      padding: 1rem;
      gap: 0.35rem;
    }

    .tarjeta-overlay h3 {
      margin: 0;
      font-size: 1.05rem;
    }

    .tarjeta-valoracion {
      display: inline-flex;
      gap: 0.4rem;
      align-items: center;
      font-weight: 600;
      color: #ffe082;
      background: rgba(8, 26, 74, 0.4);
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.95rem;
    }

    .tarjeta-valoracion small {
      font-weight: 500;
      color: rgba(255, 255, 255, 0.85);
    }

    .tarjeta-boton-editar {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      background: rgba(255, 255, 255, 0.95);
      color: var(--color-primario);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      box-shadow: 0 10px 24px rgba(11, 61, 145, 0.18);
      transition: background var(--transicion), color var(--transicion), transform var(--transicion);
    }

    .tarjeta-boton-editar:hover,
    .tarjeta-boton-editar:focus-visible {
      background: var(--color-primario);
      color: #fff;
      transform: translateY(-1px);
      outline: none;
    }

    .tarjeta.expanded .tarjeta-boton-editar {
      display: none;
    }

    .tarjeta-detalle {
      display: grid;
      gap: 1rem;
      padding: 1.2rem;
      background: var(--color-superficie);
      position: relative;
    }

    .tarjeta-detalle[hidden] {
      display: none;
    }

    .tarjeta-detalle header {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      padding-right: 2.5rem;
    }

    .tarjeta-cerrar {
      position: absolute;
      top: 0.65rem;
      right: 0.65rem;
      width: 42px;
      height: 42px;
      border-radius: 50%;
      border: none;
      background: rgba(11, 61, 145, 0.08);
      color: var(--color-primario);
      font-size: 1.35rem;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background var(--transicion), color var(--transicion), transform var(--transicion);
      z-index: 2;
    }

    .tarjeta-cerrar:hover,
    .tarjeta-cerrar:focus-visible {
      background: var(--color-primario);
      color: #fff;
      outline: none;
      transform: translateY(-1px);
    }

    .tarjeta-detalle .tarjeta-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      font-size: 0.9rem;
      color: var(--color-texto-suave);
    }

    .tarjeta-detalle .tarjeta-meta-direccion {
      font-weight: 600;
      color: var(--color-texto);
    }

    .tarjeta-detalle .tarjeta-meta-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      background: rgba(11, 61, 145, 0.12);
      color: var(--color-primario);
      font-weight: 600;
    }

    .tarjeta-detalle .tarjeta-descripcion {
      margin: 0;
      line-height: 1.6;
    }

    .tarjeta-detalle .etiquetas {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .tarjeta-detalle .etiqueta {
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      background: rgba(11, 61, 145, 0.12);
      color: var(--color-primario);
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .tarjeta-galeria {
      display: grid;
      gap: 0.65rem;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .tarjeta-galeria img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 14px;
      background: #fff;
    }

    .tarjeta-volver {
      position: sticky;
      top: 0;
      left: 0;
      width: 48px;
      height: 48px;
      border-radius: 14px;
      border: none;
      background: var(--color-primario);
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.35rem;
      box-shadow: 0 12px 28px rgba(7, 44, 104, 0.35);
      margin-bottom: 0.5rem;
      z-index: 2;
    }

    .tarjeta-volver:focus-visible {
      outline: 3px solid rgba(255, 255, 255, 0.75);
      outline-offset: 2px;
    }

    .tarjeta-mapa iframe {
      width: 100%;
      min-height: 260px;
      border: 0;
      border-radius: 14px;
    }

    .tarjeta-acciones {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .tarjeta-navegacion {
      display: grid;
      gap: 0.75rem;
      align-items: start;
    }

    .navegacion-opciones {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .navegacion-opciones button {
      border-radius: 999px;
      border: 1px solid var(--color-borde);
      background: rgba(11, 61, 145, 0.06);
      color: var(--color-primario);
      padding: 0.3rem 0.9rem;
      font-size: 0.85rem;
      font-weight: 600;
      transition: background var(--transicion), color var(--transicion), border-color var(--transicion);
    }

    .navegacion-opciones button.activo {
      background: var(--color-primario);
      color: #fff;
      border-color: var(--color-primario);
    }

    .tarjeta-resenas {
      display: grid;
      gap: 0.75rem;
      border-top: 1px solid var(--color-borde);
      padding-top: 0.75rem;
    }

    .detalle-reviews-controles {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: space-between;
    }

    .detalle-reviews-controles .filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .orden-opciones {
      display: inline-flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .orden-opciones button {
      border-radius: 999px;
      border: 1px solid var(--color-borde);
      background: #fff;
      color: var(--color-texto);
      padding: 0.35rem 0.9rem;
      font-weight: 600;
      font-size: 0.9rem;
      transition: background var(--transicion), color var(--transicion), border-color var(--transicion);
    }

    .orden-opciones button.activo {
      background: var(--color-primario);
      border-color: var(--color-primario);
      color: #fff;
    }

    .detalle-reviews-lista {
      display: grid;
      gap: 0.75rem;
    }

    .detalle-resena {
      background: #fff;
      border-radius: 12px;
      border: 1px solid var(--color-borde);
      padding: 0.85rem 1rem;
      display: grid;
      gap: 0.45rem;
    }

    .historia-timeline {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 1.5rem;
      position: relative;
    }

    .historia-timeline::before {
      content: '';
      position: absolute;
      left: 12px;
      top: 0;
      bottom: 0;
      width: 4px;
      background: rgba(11, 61, 145, 0.15);
      border-radius: 999px;
    }

    .historia-item {
      position: relative;
      padding-left: 2.5rem;
    }

    .historia-item::before {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--color-primario);
      top: 0.65rem;
      left: 6px;
      box-shadow: 0 0 0 4px rgba(11, 61, 145, 0.15);
    }

    .historia-card {
      background: #fff;
      border: 1px solid var(--color-borde);
      border-radius: var(--radio);
      padding: 1.25rem;
      box-shadow: 0 10px 24px rgba(11, 61, 145, 0.08);
      display: grid;
      gap: 0.75rem;
    }

    .historia-card header {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 0.75rem;
    }

    .historia-periodo {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--color-primario);
      background: rgba(11, 61, 145, 0.1);
      padding: 0.2rem 0.75rem;
      border-radius: 999px;
    }

    .historia-media img {
      width: 100%;
      border-radius: calc(var(--radio) - 4px);
      max-height: 260px;
      object-fit: cover;
      background: #e3e8f8;
    }

    .historia-galeria {
      display: grid;
      gap: 0.5rem;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    .historia-galeria img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 12px;
      background: #f3f5fb;
    }

    .historia-etiquetas {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .historia-etiquetas span {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: rgba(11, 61, 145, 0.12);
      color: var(--color-primario);
      font-size: 0.75rem;
      font-weight: 600;
    }

    .historia-acciones {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    .admin-coleccion {
      border: 1px solid var(--color-borde);
      border-radius: var(--radio);
      padding: 1rem;
      background: #fff;
      box-shadow: 0 6px 14px rgba(11, 61, 145, 0.08);
      display: grid;
      gap: 0.65rem;
    }

    .admin-coleccion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .admin-items {
      display: grid;
      gap: 0.4rem;
    }

    .admin-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      padding: 0.45rem 0.25rem;
      border-bottom: 1px dashed rgba(11, 61, 145, 0.2);
    }

    .admin-item:last-child {
      border-bottom: none;
    }

    .admin-item strong {
      font-size: 0.95rem;
    }

    .admin-item small {
      color: var(--color-texto-suave);
      display: block;
      font-size: 0.8rem;
    }

    .admin-item-acciones {
      display: flex;
      gap: 0.35rem;
      flex-wrap: wrap;
    }

    .detalle-resena figure {
      margin: 0;
      display: grid;
      gap: 0.5rem;
    }

    .detalle-resena img {
      width: 100%;
      max-height: 220px;
      object-fit: cover;
      border-radius: 12px;
    }

    .detalle-resena .rating {
      color: #ffb400;
      font-weight: 600;
    }

    .stars-selector {
      display: inline-flex;
      gap: 0.25rem;
      align-items: center;
    }

    .stars-selector button {
      border: none;
      background: none;
      font-size: 1.2rem;
      color: #d0d5e8;
      padding: 0.15rem;
      cursor: pointer;
      transition: color var(--transicion), transform var(--transicion);
    }

    .stars-selector button:hover,
    .stars-selector button:focus-visible {
      color: #ffb400;
      transform: scale(1.05);
      outline: none;
    }

    .stars-selector button.activo {
      color: #ffb400;
    }

    .rating-selector {
      display: inline-flex;
      gap: 0.35rem;
      align-items: center;
    }

    .rating-selector button {
      border: none;
      background: none;
      font-size: 1.6rem;
      color: #d0d5e8;
      padding: 0.2rem;
      cursor: pointer;
      transition: color var(--transicion), transform var(--transicion);
    }

    .rating-selector button:hover,
    .rating-selector button:focus-visible {
      color: #ffb400;
      transform: scale(1.1);
      outline: none;
    }

    .rating-selector button.activo {
      color: #ffb400;
    }

    .mensaje-ayuda {
      display: block;
      font-size: 0.85rem;
      color: var(--color-texto-suave);
      margin: 0.35rem 0;
    }

    .resena-imagenes {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .resena-imagenes img {
      width: 110px;
      height: 110px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid var(--color-borde);
    }

    .controles-resenas {
      margin: 1.5rem 0 1rem;
    }

    .controles-resenas .filtros {
      gap: 0.85rem;
    }

    .paginacion {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .paginacion button {
      min-width: 110px;
    }

    .lista-vacia {
      margin: 1rem 0 0;
      color: var(--color-texto-suave);
    }

    .eventos-lista {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.75rem;
    }

    .evento-item {
      background: rgba(11, 61, 145, 0.08);
      border-radius: 12px;
      padding: 0.75rem 0.85rem;
      display: grid;
      gap: 0.35rem;
    }

    .evento-item.destacado {
      border: 2px solid rgba(76, 175, 80, 0.5);
    }

    .evento-item strong {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.75rem;
    }

    .evento-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      border-radius: 999px;
      padding: 0.2rem 0.65rem;
      font-size: 0.75rem;
      background: rgba(255, 255, 255, 0.85);
      color: var(--color-primario);
      font-weight: 600;
    }

    .evento-badge[data-tipo="fiesta_local"] {
      background: rgba(76, 175, 80, 0.2);
      color: #1b5e20;
    }

    .evento-badge[data-tipo="no_laborable"] {
      background: rgba(244, 67, 54, 0.25);
      color: #7f0000;
    }

    .evento-badge[data-tipo="no_lectivo"] {
      background: rgba(255, 193, 7, 0.25);
      color: #7c4a03;
    }

    .widget-clima,
    .widget-mapa {
      display: grid;
      gap: 0.75rem;
    }

    .hero-widget {
      background: rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      padding: 1rem;
      backdrop-filter: blur(4px);
      display: grid;
      gap: 0.65rem;
    }

    .widget-clima-compacta {
      max-width: 220px;
      background: linear-gradient(135deg, rgba(11, 61, 145, 0.92), rgba(76, 175, 80, 0.82));
      color: #fff;
      padding: 0.75rem 0.9rem;
      box-shadow: 0 15px 35px rgba(7, 44, 104, 0.3);
      gap: 0.5rem;
    }

    .widget-clima-compacta .btn {
      border-color: rgba(255, 255, 255, 0.6);
      color: #fff;
    }

    .widget-clima-compacta .btn:hover,
    .widget-clima-compacta .btn:focus-visible {
      background: rgba(255, 255, 255, 0.15);
    }

    .hero-widget strong {
      font-size: 1.05rem;
    }

    .widget-clima .clima-actual {
      display: grid;
      gap: 0.35rem;
    }

    .clima-visual {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .widget-clima-compacta .clima-visual {
      flex-direction: column;
      text-align: center;
      gap: 0.35rem;
    }

    .clima-icono {
      font-size: 2.75rem;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 72px;
      height: 72px;
      margin: 0 auto;
    }

    .clima-icono img {
      width: 72px;
      height: 72px;
      object-fit: contain;
      display: block;
    }

    .widget-clima-compacta .clima-icono {
      width: 56px;
      height: 56px;
    }

    .widget-clima-compacta .clima-icono img {
      width: 56px;
      height: 56px;
    }

    .clima-datos strong {
      font-size: 1.35rem;
      display: block;
    }

    .widget-clima-compacta .clima-datos strong {
      font-size: 1.2rem;
    }

    .clima-datos p {
      margin: 0.15rem 0 0;
      font-size: 0.95rem;
    }

    .clima-pronostico {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.4rem;
    }

    .clima-pronostico li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.9rem;
    }

    .widget-clima-compacta .clima-pronostico li {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.9);
    }

    .clima-pronostico span {
      opacity: 0.9;
    }

    .widget-mapa iframe {
      width: 100%;
      min-height: 320px;
      border: 0;
      border-radius: var(--radio);
    }

    .resenas {
      display: grid;
      gap: 1.25rem;
    }

    .resena {
      border-radius: 16px;
      background: #fff;
      padding: 1rem;
      border: 1px solid var(--color-borde);
      box-shadow: 0 8px 18px rgba(11, 61, 145, 0.08);
      display: grid;
      gap: 0.5rem;
    }

    .resena strong {
      font-size: 1.05rem;
    }

    .rating {
      color: #ffb400;
      font-size: 1.1rem;
    }

    .formulario {
      display: grid;
      gap: 0.75rem;
    }

    .formulario label {
      font-weight: 600;
    }

    .formulario input,
    .formulario textarea,
    .formulario select {
      border-radius: 12px;
      border: 1px solid var(--color-borde);
      background: #fff;
      padding: 0.65rem 0.85rem;
      transition: border-color var(--transicion), box-shadow var(--transicion);
    }

    .mensaje-error {
      color: var(--color-alerta);
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .mensaje-validacion,
    .mensaje-exito,
    .nota-ayuda {
      font-size: 0.9rem;
      color: var(--color-texto-suave);
      margin: 0;
    }

    .mensaje-exito {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .mensaje-error::before,
    .mensaje-exito::before {
      content: none;
    }

    .captcha-simulacion {
      border: 1px solid var(--color-borde);
      border-radius: 12px;
      padding: 0.75rem;
      background: rgba(11, 61, 145, 0.04);
    }

    .mensaje-exito {
      color: var(--color-secundario);
    }

    .aviso-login {
      border: 1px dashed var(--color-borde);
      border-radius: var(--radio);
      padding: 1rem;
      background: rgba(11, 61, 145, 0.05);
      display: grid;
      gap: 0.5rem;
      align-content: start;
    }

    .aviso-login p {
      margin: 0;
    }

    .aviso-login .btn {
      justify-self: start;
    }

    .campo-validado {
      display: grid;
      gap: 0.35rem;
    }

    .input-con-icono {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-con-icono input {
      flex: 1;
      padding-right: 3rem;
    }

    .indicador-validacion {
      display: none;
    }

    .toggle-password {
      position: absolute;
      right: 0.35rem;
      background: transparent;
      border: none;
      color: inherit;
      padding: 0.35rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .toggle-password:focus-visible {
      outline: 2px solid var(--color-primario);
      border-radius: 50%;
    }

    .alerta-secundaria {
      background: rgba(255, 193, 7, 0.15);
      border: 1px solid rgba(255, 193, 7, 0.45);
      padding: 0.75rem;
      border-radius: 12px;
      font-size: 0.95rem;
      display: grid;
      gap: 0.5rem;
    }

    .btn-link {
      background: none;
      border: none;
      padding: 0;
      color: var(--color-primario);
      text-decoration: underline;
      font-weight: 600;
    }

    .btn[aria-busy='true'] {
      opacity: 0.85;
      pointer-events: none;
    }

    @keyframes parpadeo {
      0%, 100% {
        opacity: 0.3;
      }
      50% {
        opacity: 1;
      }
    }

    @keyframes girar {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .barra-fuerza {
      height: 6px;
      border-radius: 999px;
      background: rgba(11, 61, 145, 0.12);
      overflow: hidden;
    }

    .barra-fuerza span {
      display: block;
      height: 100%;
      width: var(--porcentaje, 0%);
      background: var(--color-alerta);
      transition: width 0.25s ease;
    }

    .barra-fuerza[data-nivel='medio'] span {
      background: #ffb400;
    }

    .barra-fuerza[data-nivel='fuerte'] span {
      background: var(--color-secundario);
    }

    .requisitos-password {
      margin: 0;
      padding-left: 1.1rem;
      font-size: 0.85rem;
      color: var(--color-texto-suave);
    }

    .banner-verificacion {
      display: none;
      background: rgba(255, 193, 7, 0.15);
      border-bottom: 1px solid rgba(255, 193, 7, 0.45);
      padding: 0.85rem 1rem;
      gap: 0.75rem;
      align-items: center;
    }

    .banner-verificacion.visible {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }

    .toast {
      position: fixed;
      inset: auto 1rem 1rem 1rem;
      background: rgba(7, 44, 104, 0.95);
      color: #fff;
      padding: 0.85rem 1.2rem;
      border-radius: 12px;
      box-shadow: 0 12px 24px rgba(11, 61, 145, 0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transicion), transform var(--transicion);
      transform: translateY(12px);
      z-index: 200;
    }

    .toast.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .log-semilla {
      background: rgba(11, 61, 145, 0.05);
      padding: 0.75rem;
      border-radius: var(--radio);
      border: 1px solid var(--color-borde);
      font-size: 0.9rem;
    }

    .log-semilla p {
      margin: 0;
    }

    .log-semilla p[data-tipo='ok'] {
      color: var(--color-secundario);
    }

    .log-semilla p[data-tipo='error'] {
      color: var(--color-alerta);
    }

    .log-semilla p[data-tipo='aviso'] {
      color: var(--color-aviso);
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      opacity: 0;
      transition: opacity var(--transicion);
      z-index: 250;
      backdrop-filter: blur(2px);
    }

    .modal.visible {
      display: flex;
      opacity: 1;
    }

    .modal-dialogo {
      background: var(--color-fondo);
      color: var(--color-texto);
      border-radius: 22px;
      width: min(540px, 100%);
      padding: 1.75rem;
      display: grid;
      gap: 1rem;
      position: relative;
      box-shadow: 0 24px 48px rgba(11, 61, 145, 0.25);
      transform: translateY(20px);
      opacity: 0;
      transition: transform var(--transicion), opacity var(--transicion);
    }

    .modal.visible .modal-dialogo {
      transform: translateY(0);
      opacity: 1;
    }

    .modal-cerrar {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      font-size: 1.5rem;
    }

    #modalLogin .modal-dialogo,
    #modalRegistro .modal-dialogo,
    #modalRecuperacion .modal-dialogo,
    #modalCambioEmail .modal-dialogo {
      max-width: 420px;
    }

    #modalEliminarCuenta .modal-dialogo {
      max-width: 480px;
    }

    #modalInactividad .modal-dialogo {
      max-width: 360px;
    }

    .modal-dialogo.modal-peligro {
      border: 2px solid rgba(211, 47, 47, 0.2);
    }

    .modal-dialogo.modal-aviso {
      border: 2px solid rgba(255, 193, 7, 0.3);
    }

    .alerta-peligro {
      background: rgba(211, 47, 47, 0.08);
      border: 1px solid rgba(211, 47, 47, 0.35);
      padding: 1rem;
      border-radius: 16px;
      color: var(--color-texto);
    }

    .paso-eliminar[hidden] {
      display: none;
    }

    @media (max-width: 520px) {
      .modal {
        padding: 1rem;
      }

      .modal-dialogo {
        padding: 1.25rem;
      }
    }

    .consent-banner {
      position: fixed;
      inset: auto 0 0 0;
      background: #fff;
      border-top: 1px solid var(--color-borde);
      box-shadow: 0 -8px 18px rgba(0, 0, 0, 0.12);
      padding: 1.25rem;
      display: none;
      gap: 1rem;
      z-index: 260;
    }

    .consent-banner.visible {
      display: grid;
    }

    .calendario {
      display: grid;
      gap: 1rem;
    }

    .calendario-controles {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    .calendario-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }

    .dia-calendario {
      background: rgba(11, 61, 145, 0.06);
      border-radius: 12px;
      min-height: 82px;
      padding: 0.35rem;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      font-size: 0.85rem;
    }

    .dia-calendario.evento {
      background: rgba(76, 175, 80, 0.2);
    }

    .dia-calendario.evento[data-tipo="no_laborable"] {
      background: rgba(244, 67, 54, 0.3);
      color: #fff;
    }

    .dia-calendario.evento[data-tipo="no_lectivo"] {
      background: rgba(255, 193, 7, 0.35);
    }

    .ajustes-permisos {
      display: grid;
      gap: 1rem;
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    footer {
      margin-top: auto;
      background: var(--color-primario-oscuro);
      color: #fff;
      padding: 1.5rem 1rem;
      text-align: center;
    }

    .header-texto {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      min-width: 220px;
    }

    .header-texto h1,
    .header-texto p {
      color: var(--color-header-texto);
    }

    .acciones-header {
      margin-left: auto;
      display: flex;
      gap: 0.5rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .indicador-actividad {
      font-size: 0.85rem;
      color: var(--color-header-texto-suave);
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }

    body.alto-contraste {
      --color-fondo: #000000;
      --color-superficie: #0f172a;
      --color-primario: #111827;
      --color-primario-oscuro: #0b1120;
      --color-secundario: #22c55e;
      --color-texto: #f9fafb;
      --color-texto-suave: #d1d5db;
      --color-borde: rgba(255, 255, 255, 0.4);
      background: var(--color-fondo);
      color: var(--color-texto);
    }

    body.texto-grande {
      font-size: 1.1rem;
    }

    body.espaciado-amplio {
      line-height: 1.7;
      letter-spacing: 0.015em;
    }

    body.modo-senior {
      font-size: 1.08rem;
    }

    body.botones-amplios .btn {
      padding: 0.85rem 1.65rem;
      font-size: 1.05rem;
    }

    body.lectura-facil p {
      font-size: 1.02rem;
      line-height: 1.7;
    }

    body.modo-visibilidad *:focus-visible {
      outline: 3px solid var(--color-aviso) !important;
      outline-offset: 2px;
    }

    body.modo-visibilidad .btn {
      box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.35);
    }

    .grupo-opcion.is-disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .toggle.is-disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    body.links-subrayados a {
      text-decoration: underline;
      text-decoration-thickness: 0.15em;
    }

    body.modo-oscuro {
      --color-fondo: #0e1526;
      --color-superficie: #17213a;
      --color-primario: #1d4ed8;
      --color-primario-oscuro: #1e3a8a;
      --color-secundario: #22d3ee;
      --color-texto: #f8fafc;
      --color-texto-suave: #cbd5f5;
      --color-header-texto: #f8fafc;
      --color-header-texto-suave: rgba(248, 250, 252, 0.85);
      --color-borde: rgba(255, 255, 255, 0.2);
    }

    .panel-accesibilidad {
      display: grid;
      gap: 1rem;
    }

    .panel-accesibilidad .grupo-opcion {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .panel-login-inicio {
      display: grid;
      gap: 0.75rem;
    }

    .panel-login-inicio .botonera {
      display: grid;
      gap: 0.5rem;
    }

    .panel-login-inicio .botonera button {
      justify-content: flex-start;
    }

    .panel-login-inicio small {
      color: var(--color-texto-suave);
    }

    .btn-icono {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .grupo-coordenadas {
      display: grid;
      gap: 0.75rem;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      align-items: end;
    }

    .grupo-coordenadas .btn {
      align-self: stretch;
    }

    .btn-icono img {
      width: 20px;
      height: 20px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    @media (max-width: 960px) {
      nav {
        width: min(360px, 100vw);
      }
    }

    @media (min-width: 900px) {
      .panel-hero {
        grid-template-columns: 3fr 2fr;
      }

      .panel-hero .hero-complementos {
        align-self: stretch;
      }
    }

    @media (max-width: 640px) {
      header {
        gap: 0.75rem;
      }

      .header-texto h1 {
        font-size: 1.2rem;
      }

      .header-texto p {
        font-size: 0.85rem;
      }

      .acciones-header {
        width: 100%;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <header aria-label="Barra superior de navegación">
    <button class="menu-toggle" aria-expanded="false" aria-controls="menuLateral" id="btnToggleMenu">☰</button>
    <img src="assets/lugar-iglesia.svg" alt="Escudo estilizado de San Martín de la Vega" width="42" height="42" loading="lazy">
    <div class="header-texto">
      <h1 style="margin:0;font-size:1.4rem;">Turismo San Martín de la Vega</h1>
      <p style="margin:0;font-size:0.9rem;opacity:0.85;">Descubre cultura, gastronomía y naturaleza</p>
    </div>
    <div class="acciones-header">
      <div class="indicador-actividad" id="indicadorActividad" aria-live="polite" hidden>
        ⏳ <span id="textoActividad">Última actividad: ahora</span>
      </div>
      <button class="btn btn-ghost" id="btnLogin" type="button">Iniciar sesión</button>
      <button class="btn btn-ghost" id="btnLogout" type="button" hidden>Cerrar sesión</button>
    </div>
  </header>

  <div class="banner-verificacion" id="bannerVerificacion" role="status" aria-live="polite" hidden>
    <div>
      <strong>Tu email no está verificado</strong>
      <p class="mensaje-validacion" style="margin-top:0.25rem;">Verifica tu cuenta para acceder a todas las funciones disponibles.</p>
    </div>
    <button type="button" class="btn btn-primario" id="btnReenviarVerificacionBanner">Reenviar email de verificación</button>
  </div>

  <div class="overlay-menu" id="overlayMenu" role="presentation"></div>

  <div class="layout">
    <nav id="menuLateral" aria-label="Menú principal" tabindex="-1" aria-hidden="true">
      <ul class="nav-links" id="listaMenu">
        <li><button type="button" data-seccion="inicio" class="activo" aria-controls="seccionInicio" aria-expanded="true">🏠 Inicio</button></li>
        <li>
          <button type="button" data-seccion="lugares" aria-controls="seccionLugares" aria-expanded="false">📍 Lugares</button>
          <ul class="sub-lista" data-parent="lugares">
            <li><button type="button" data-tag="todos">Todos</button></li>
            <li><button type="button" data-tag="naturaleza">Naturaleza</button></li>
            <li><button type="button" data-tag="cultural">Patrimonio</button></li>
            <li><button type="button" data-tag="familia">Plan familiar</button></li>
          </ul>
        </li>
        <li>
          <button type="button" data-seccion="restaurantes" aria-controls="seccionRestaurantes" aria-expanded="false">🍽️ Gastronomía</button>
          <ul class="sub-lista" data-parent="restaurantes">
            <li><button type="button" data-tag="todos">Todos</button></li>
            <li><button type="button" data-tag="tradicional">Tradicional</button></li>
            <li><button type="button" data-tag="tapas">Tapas y ocio</button></li>
            <li><button type="button" data-tag="asador">Asador</button></li>
            <li><button type="button" data-tag="terraza">Terraza</button></li>
            <li><button type="button" data-tag="veg-friendly">Opción veg-friendly</button></li>
            <li><button type="button" data-tag="sin-gluten">Sin gluten</button></li>
            <li><button type="button" data-tag="km0">Producto local</button></li>
          </ul>
        </li>
        <li>
          <button type="button" data-seccion="ocio" aria-controls="seccionOcio" aria-expanded="false">🚴 Ocio activo</button>
          <ul class="sub-lista" data-parent="ocio">
            <li><button type="button" data-tag="todos">Todos</button></li>
            <li><button type="button" data-tag="aventura">Aventura</button></li>
            <li><button type="button" data-tag="agua">Acuático</button></li>
          </ul>
        </li>
        <li><button type="button" data-seccion="historia" aria-controls="seccionHistoria" aria-expanded="false">📜 Historia</button></li>
        <li><button type="button" data-seccion="eventos" aria-controls="seccionEventos" aria-expanded="false">🗓️ Eventos</button></li>
        <li><button type="button" data-seccion="resenas" aria-controls="seccionResenas" aria-expanded="false">⭐ Resenas</button></li>
        <li><button type="button" data-seccion="mapa" aria-controls="seccionMapa" aria-expanded="false">🗺️ Mapa</button></li>
        <li><button type="button" data-seccion="clima" aria-controls="seccionClima" aria-expanded="false">☀️ Clima</button></li>
        <li><button type="button" data-seccion="ajustes" aria-controls="seccionAjustes" aria-expanded="false">⚙️ Ajustes</button></li>
        <li><button type="button" data-seccion="admin" aria-controls="seccionAdmin" aria-expanded="false" id="btnMenuAdmin" hidden>🛠️ Administración</button></li>
      </ul>
    </nav>

    <main id="contenidoPrincipal">
      <section id="seccionInicio" class="panel-hero" data-seccion="inicio">
        <div class="hero-contenido">
          <h2>Planifica tu visita de forma segura</h2>
          <p>Explora rutas naturales, reserva actividades y comparte resenas verificadas. La información se actualiza desde nuestro equipo municipal y colaboradores locales.</p>
          <div class="acciones">
            <button type="button" class="btn btn-primario" data-ir="seccionLugares">Ver lugares destacados</button>
            <button type="button" class="btn btn-secundario" data-ir="seccionEventos">Calendario cultural</button>
          </div>
        </div>
        <div class="hero-complementos">
          <aside class="widget-clima hero-widget widget-clima-compacta" aria-live="polite" id="widgetClimaHero">
            <strong>Clima local</strong>
            <div class="clima-actual" id="climaContenido">
              <p>Consultando información meteorológica…</p>
            </div>
            <ul class="clima-pronostico" id="climaPronostico"></ul>
            <button type="button" class="btn btn-ghost btn-sm" id="btnActualizarClima">Actualizar clima</button>
          </aside>
          <aside class="hero-widget ideas-widget" id="widgetDestacado" aria-live="polite">
            <div class="ideas-header">
              <strong>Ideas</strong>
              <div class="ideas-controles" aria-hidden="true">
                <button type="button" disabled aria-label="Idea anterior">◀</button>
                <button type="button" disabled aria-label="Idea siguiente">▶</button>
              </div>
            </div>
            <p>Reuniremos aquí las mejores propuestas en cuanto tengamos suficientes valoraciones.</p>
            <div class="ideas-progreso" aria-hidden="true"><span></span></div>
          </aside>
        </div>
      </section>

      <section id="seccionLugares" class="seccion" data-seccion="lugares" hidden>
        <header>
          <h2>Lugares imprescindibles</h2>
          <p>Selecciona un filtro para acotar los resultados. Se muestran 20 elementos por página.</p>
        </header>
        <div class="filtros-acciones">
          <button type="button" class="btn btn-ghost btn-filtros" data-filtro-toggle="lugares">🎯 Filtros</button>
        </div>
        <div class="seccion-contenido">
          <aside class="panel-filtros" data-filtros-panel="lugares" aria-label="Filtros para lugares">
            <div class="panel-filtros-contenido">
              <div class="panel-filtros-cabecera">
                <h3>Personaliza tu búsqueda</h3>
                <button type="button" class="panel-filtros-cerrar" data-filtro-close="lugares" aria-label="Cerrar filtros">×</button>
              </div>
              <div class="filtro-grupo">
                <h4>Etiquetas</h4>
                <div class="chips" role="listbox" aria-label="Filtrar lugares" id="chipsLugares"></div>
              </div>
              <div class="filtro-grupo">
                <h4>Puntuación mínima</h4>
                <div class="orden-opciones filtro-rating" data-filtro-rating="lugares" role="group" aria-label="Filtrar por valoración">
                  <button type="button" data-valor="0" class="activo">Todas</button>
                  <button type="button" data-valor="4">4+</button>
                  <button type="button" data-valor="4.5">4.5+</button>
                  <button type="button" data-valor="5">5</button>
                </div>
              </div>
              <div class="filtro-grupo">
                <h4>Cercanía</h4>
                <p class="filtro-estado" data-estado-cercania="lugares">Ubicación no solicitada.</p>
                <div class="orden-opciones filtro-cercania">
                  <button type="button" class="btn btn-ghost btn-sm" data-filtro-cercania="lugares">Usar mi ubicación</button>
                  <button type="button" class="btn btn-ghost btn-sm" data-filtro-cercania-off="lugares">Quitar</button>
                </div>
                <small>Mostramos lugares a menos de 15 km de tu posición.</small>
              </div>
              <div class="filtro-grupo">
                <h4>Ordenar por</h4>
                <div class="orden-opciones" data-filtro-orden="lugares" role="group" aria-label="Ordenar resultados">
                  <button type="button" data-orden="nombre" class="activo">Nombre</button>
                  <button type="button" data-orden="valoracion">Mejor valoración</button>
                  <button type="button" data-orden="cercania">Más cercanos</button>
                </div>
              </div>
            </div>
          </aside>
          <div class="panel-resultados">
            <div class="tarjetas" id="listaLugares" aria-live="polite"></div>
          </div>
        </div>
        <div class="paginacion">
          <button type="button" class="btn btn-ghost" data-prev="lugares">Anterior</button>
          <span id="estadoLugares" aria-live="polite"></span>
          <button type="button" class="btn btn-ghost" data-next="lugares">Siguiente</button>
        </div>
      </section>

      <section id="seccionRestaurantes" class="seccion" data-seccion="restaurantes" hidden>
        <header>
          <h2>Dónde comer</h2>
          <p>Encuentra propuestas gastronómicas según tu estilo.</p>
        </header>
        <div class="filtros-acciones">
          <button type="button" class="btn btn-ghost btn-filtros" data-filtro-toggle="restaurantes">🎯 Filtros</button>
        </div>
        <div class="seccion-contenido">
          <aside class="panel-filtros" data-filtros-panel="restaurantes" aria-label="Filtros para restaurantes">
            <div class="panel-filtros-contenido">
              <div class="panel-filtros-cabecera">
                <h3>Elige tus preferencias</h3>
                <button type="button" class="panel-filtros-cerrar" data-filtro-close="restaurantes" aria-label="Cerrar filtros">×</button>
              </div>
              <div class="filtro-grupo">
                <h4>Etiquetas</h4>
                <div class="chips" role="listbox" aria-label="Filtrar restaurantes" id="chipsRestaurantes"></div>
              </div>
              <div class="filtro-grupo">
                <h4>Puntuación mínima</h4>
                <div class="orden-opciones filtro-rating" data-filtro-rating="restaurantes" role="group" aria-label="Filtrar por valoración">
                  <button type="button" data-valor="0" class="activo">Todas</button>
                  <button type="button" data-valor="4">4+</button>
                  <button type="button" data-valor="4.5">4.5+</button>
                  <button type="button" data-valor="5">5</button>
                </div>
              </div>
              <div class="filtro-grupo">
                <h4>Cercanía</h4>
                <p class="filtro-estado" data-estado-cercania="restaurantes">Ubicación no solicitada.</p>
                <div class="orden-opciones filtro-cercania">
                  <button type="button" class="btn btn-ghost btn-sm" data-filtro-cercania="restaurantes">Usar mi ubicación</button>
                  <button type="button" class="btn btn-ghost btn-sm" data-filtro-cercania-off="restaurantes">Quitar</button>
                </div>
                <small>Te proponemos mesas a menos de 15 km cuando activas la cercanía.</small>
              </div>
              <div class="filtro-grupo">
                <h4>Ordenar por</h4>
                <div class="orden-opciones" data-filtro-orden="restaurantes" role="group" aria-label="Ordenar resultados">
                  <button type="button" data-orden="nombre" class="activo">Nombre</button>
                  <button type="button" data-orden="valoracion">Mejor valoración</button>
                  <button type="button" data-orden="cercania">Más cercanos</button>
                </div>
              </div>
            </div>
          </aside>
          <div class="panel-resultados">
            <div class="tarjetas" id="listaRestaurantes" aria-live="polite"></div>
          </div>
        </div>
        <div class="paginacion">
          <button type="button" class="btn btn-ghost" data-prev="restaurantes">Anterior</button>
          <span id="estadoRestaurantes" aria-live="polite"></span>
          <button type="button" class="btn btn-ghost" data-next="restaurantes">Siguiente</button>
        </div>
      </section>

      <section id="seccionOcio" class="seccion" data-seccion="ocio" hidden>
        <header>
          <h2>Ocio y naturaleza</h2>
          <p>Actividades deportivas y planes en la vega del Jarama.</p>
        </header>
        <div class="filtros-acciones">
          <button type="button" class="btn btn-ghost btn-filtros" data-filtro-toggle="ocio">🎯 Filtros</button>
        </div>
        <div class="seccion-contenido">
          <aside class="panel-filtros" data-filtros-panel="ocio" aria-label="Filtros para ocio">
            <div class="panel-filtros-contenido">
              <div class="panel-filtros-cabecera">
                <h3>Refina tus planes</h3>
                <button type="button" class="panel-filtros-cerrar" data-filtro-close="ocio" aria-label="Cerrar filtros">×</button>
              </div>
              <div class="filtro-grupo">
                <h4>Etiquetas</h4>
                <div class="chips" role="listbox" aria-label="Filtrar ocio" id="chipsOcio"></div>
              </div>
              <div class="filtro-grupo">
                <h4>Puntuación mínima</h4>
                <div class="orden-opciones filtro-rating" data-filtro-rating="ocio" role="group" aria-label="Filtrar por valoración">
                  <button type="button" data-valor="0" class="activo">Todas</button>
                  <button type="button" data-valor="4">4+</button>
                  <button type="button" data-valor="4.5">4.5+</button>
                  <button type="button" data-valor="5">5</button>
                </div>
              </div>
              <div class="filtro-grupo">
                <h4>Cercanía</h4>
                <p class="filtro-estado" data-estado-cercania="ocio">Ubicación no solicitada.</p>
                <div class="orden-opciones filtro-cercania">
                  <button type="button" class="btn btn-ghost btn-sm" data-filtro-cercania="ocio">Usar mi ubicación</button>
                  <button type="button" class="btn btn-ghost btn-sm" data-filtro-cercania-off="ocio">Quitar</button>
                </div>
                <small>Mostramos experiencias a menos de 15 km de donde te encuentras.</small>
              </div>
              <div class="filtro-grupo">
                <h4>Ordenar por</h4>
                <div class="orden-opciones" data-filtro-orden="ocio" role="group" aria-label="Ordenar resultados">
                  <button type="button" data-orden="nombre" class="activo">Nombre</button>
                  <button type="button" data-orden="valoracion">Mejor valoración</button>
                  <button type="button" data-orden="cercania">Más cercanos</button>
                </div>
              </div>
            </div>
          </aside>
          <div class="panel-resultados">
            <div class="tarjetas" id="listaOcio" aria-live="polite"></div>
          </div>
        </div>
        <div class="paginacion">
          <button type="button" class="btn btn-ghost" data-prev="ocio">Anterior</button>
          <span id="estadoOcio" aria-live="polite"></span>
          <button type="button" class="btn btn-ghost" data-next="ocio">Siguiente</button>
        </div>
      </section>

      <section id="seccionHistoria" class="seccion" data-seccion="historia" hidden>
        <h2>Historia local</h2>
        <div class="tarjetas" id="listaHistoria" aria-live="polite"></div>
      </section>

      <section id="seccionEventos" class="seccion" data-seccion="eventos" hidden>
        <h2>Calendario municipal</h2>
        <div class="calendario" aria-live="polite">
          <div class="calendario-controles">
            <label for="selectMes">Mes</label>
            <select id="selectMes" aria-label="Seleccionar mes"></select>
            <label for="selectAnio">Año</label>
            <select id="selectAnio" aria-label="Seleccionar año"></select>
          </div>
          <div class="calendario-grid" id="gridCalendario"></div>
          <div id="detalleEventos" aria-live="polite"></div>
        </div>
      </section>

      <section id="seccionResenas" class="seccion" data-seccion="resenas" hidden>
        <h2>Resenas verificadas</h2>
        <form class="formulario" id="formResena" hidden>
          <div>
            <label for="inputTitulo">Título</label>
            <input id="inputTitulo" name="titulo" maxlength="60" required aria-describedby="ayudaTitulo">
            <p id="ayudaTitulo" class="mensaje-error" hidden>El título es obligatorio (1-60 caracteres).</p>
          </div>
          <div>
            <label for="inputTexto">Tu experiencia</label>
            <textarea id="inputTexto" name="texto" maxlength="2000" required aria-describedby="ayudaTexto"></textarea>
            <p id="ayudaTexto" class="mensaje-error" hidden>Describe la experiencia (1-2000 caracteres).</p>
          </div>
          <div>
            <span id="labelRating">Valoración</span>
            <div class="rating-selector" id="ratingSelector" role="radiogroup" aria-labelledby="labelRating">
              <button type="button" data-valor="1" aria-label="1 estrella">★</button>
              <button type="button" data-valor="2" aria-label="2 estrellas">★</button>
              <button type="button" data-valor="3" aria-label="3 estrellas">★</button>
              <button type="button" data-valor="4" aria-label="4 estrellas">★</button>
              <button type="button" data-valor="5" aria-label="5 estrellas">★</button>
            </div>
            <input type="hidden" id="inputRating" name="rating" value="5">
            <p class="mensaje-error" id="ayudaRating" hidden>Selecciona una puntuación entre 1 y 5.</p>
          </div>
          <div>
            <label for="inputFotos">Añade fotos (opcional)</label>
            <input id="inputFotos" name="imagenes" type="file" accept="image/*" capture="environment" multiple aria-describedby="ayudaFotos">
            <small class="mensaje-ayuda">Puedes adjuntar hasta 3 imágenes JPG o PNG.</small>
            <p id="ayudaFotos" class="mensaje-error" hidden>Las imágenes deben respetar las normas de contenido.</p>
            <div class="resena-imagenes" id="previewFotos" aria-live="polite"></div>
          </div>
          <button type="submit" class="btn btn-primario">Enviar resena</button>
        </form>
        <div class="aviso-login" id="avisoResenaInvitado">
          <p id="textoResenaProtegida">Inicia sesión para escribir una reseña y compartir tu experiencia.</p>
          <button type="button" class="btn btn-primario" id="btnLoginResena">Iniciar sesión</button>
        </div>
        <div class="detalle-reviews-controles controles-resenas">
          <div class="filtros">
            <div class="orden-opciones" id="ordenResenas" role="group" aria-label="Ordenar resenas">
              <button type="button" data-orden="recomendadas" class="activo">Recomendadas</button>
              <button type="button" data-orden="recientes">Más recientes</button>
              <button type="button" data-orden="mejores">Mejor valoradas</button>
              <button type="button" data-orden="peores">Peor valoradas</button>
              <button type="button" data-orden="imagenes">Solo con imágenes</button>
            </div>
            <div class="stars-selector" id="filtroEstrellasGlobal" aria-label="Filtrar resenas por estrellas">
              <button type="button" data-valor="1" aria-label="1 estrella">★</button>
              <button type="button" data-valor="2" aria-label="2 estrellas">★</button>
              <button type="button" data-valor="3" aria-label="3 estrellas">★</button>
              <button type="button" data-valor="4" aria-label="4 estrellas">★</button>
              <button type="button" data-valor="5" aria-label="5 estrellas">★</button>
            </div>
            <label class="toggle"><input type="checkbox" id="toggleSoloImagenes"> Solo resenas con fotos</label>
          </div>
          <span id="resumenResenasGlobal">Sin filtros aplicados</span>
        </div>
        <div class="resenas" id="listaResenas" aria-live="polite"></div>
        <div class="paginacion">
          <button type="button" class="btn btn-ghost" data-prev="resenas">Anterior</button>
          <span id="estadoResenas" aria-live="polite"></span>
          <button type="button" class="btn btn-ghost" data-next="resenas">Siguiente</button>
        </div>
      </section>

      <section id="seccionMapa" class="seccion" data-seccion="mapa" hidden>
        <h2>Mapa y rutas</h2>
        <div class="widget-mapa">
          <p>Consulta la localización principal. Para rutas concretas habilita la capa en Google Maps.</p>
          <iframe id="iframeMapa" title="Mapa de San Martín de la Vega" loading="lazy" referrerpolicy="no-referrer" allowfullscreen
            src="https://www.google.com/maps?q=40.20732,-3.57013&output=embed"></iframe>
          <button type="button" class="btn btn-primario" id="btnDescargarGPX" hidden>Descargar ruta GPX</button>
        </div>
      </section>

      <section id="seccionClima" class="seccion" data-seccion="clima" hidden>
        <h2>Clima local</h2>
        <div class="widget-clima" id="widgetClimaDetalle" aria-live="polite">
          <div class="clima-actual" id="climaContenidoDetalle">
            <p>Consultando información meteorológica…</p>
          </div>
          <ul class="clima-pronostico" id="climaPronosticoDetalle"></ul>
          <button type="button" class="btn btn-ghost btn-sm" id="btnActualizarClimaDetalle">Actualizar clima</button>
        </div>
      </section>

      <section id="seccionAjustes" class="seccion" data-seccion="ajustes" hidden>
        <h2>Accesibilidad y cuenta</h2>
        <div class="ajustes-permisos">
          <div>
            <p>Configura la visualización según tus necesidades. Los cambios se guardan solo en este dispositivo.</p>
            <div class="panel-accesibilidad">
              <article class="grupo-opcion">
                <h3>Temas y animaciones</h3>
                <p>Adapta la guía según la iluminación del entorno o si prefieres minimizar efectos.</p>
                <label class="toggle"><input type="checkbox" id="toggleModoOscuro"> Activar tema oscuro</label>
                <label class="toggle"><input type="checkbox" id="toggleContraste"> Alto contraste</label>
                <label class="toggle"><input type="checkbox" id="toggleReducir"> Reducir animaciones</label>
              </article>
              <article class="grupo-opcion">
                <h3>Modo tercera edad</h3>
                <p>Incrementa fuentes, contraste y tamaño de botones para mejorar la legibilidad.</p>
                <label class="toggle"><input type="checkbox" id="toggleModoSenior"> Activar modo tercera edad</label>
                <div id="panelSeniorOpciones" style="display:grid;gap:0.35rem;margin-top:0.65rem;">
                  <label class="toggle"><input type="checkbox" id="toggleTexto" data-senior-control> Texto ampliado</label>
                  <label class="toggle"><input type="checkbox" id="toggleEspaciado" data-senior-control> Espaciado adicional</label>
                  <label class="toggle"><input type="checkbox" id="toggleBotones" data-senior-control> Botones más grandes</label>
                </div>
              </article>
              <article class="grupo-opcion">
                <h3>Accesibilidad lectora</h3>
                <p>Personaliza la tipografía y simplifica los contenidos para una lectura relajada.</p>
                <label class="toggle"><input type="checkbox" id="toggleFuente"> Fuente adaptada para dislexia</label>
                <label class="toggle"><input type="checkbox" id="toggleLecturaFacil"> Activar modo lectura fácil</label>
              </article>
              <article class="grupo-opcion">
                <h3>Apoyos de visibilidad</h3>
                <p>Resalta enlaces y elementos interactivos para identificarlos rápidamente.</p>
                <label class="toggle"><input type="checkbox" id="toggleLinks"> Subrayar enlaces</label>
                <label class="toggle"><input type="checkbox" id="toggleVisibilidad"> Resaltar elementos interactivos</label>
              </article>
            </div>
          </div>
          <div>
            <h3>Gestión de cuenta</h3>
            <p>Estas acciones requieren que hayas iniciado sesión. Nunca compartiremos tus credenciales.</p>
            <div class="aviso-login" id="avisoCuentaInvitado">
              <p>Inicia sesión para gestionar tu perfil, verificar tu correo y acceder a opciones avanzadas.</p>
              <button type="button" class="btn btn-primario" id="btnLoginAjustes">Iniciar sesión</button>
            </div>
            <fieldset id="panelCuenta" style="border:none;padding:0;display:grid;gap:1rem;" disabled hidden>
              <legend class="sr-only">Ajustes de la cuenta</legend>
              <div style="display:flex;flex-wrap:wrap;gap:0.5rem;align-items:center;justify-content:space-between;">
                <p class="mensaje-validacion" style="margin:0;">Correo actual: <strong id="textoEmailActual">—</strong></p>
                <button type="button" class="btn btn-ghost" id="btnAbrirCambioEmail">Cambiar email</button>
              </div>
              <form class="formulario" id="formPerfil">
                <label>
                  Nombre para mostrar
                  <input type="text" name="displayName" id="inputDisplayName" maxlength="60" autocomplete="name" placeholder="Ej. Viajero Aventurero">
                </label>
                <button type="submit" class="btn btn-primario">Guardar nombre</button>
              </form>
              <button type="button" class="btn btn-ghost" id="btnAbrirCambioPassword">Cambiar contraseña</button>
              <div style="display:grid;gap:0.35rem;">
                <div>
                  <button type="button" class="btn btn-ghost" id="btnVerificarCorreo">Reenviar email de verificación</button>
                  <p class="nota-ayuda">Solo se puede solicitar un correo cada 5 minutos.</p>
                </div>
                <div>
                  <button type="button" class="btn btn-ghost" id="btnCerrarSesiones">Cerrar sesión en todos los dispositivos</button>
                  <p class="nota-ayuda">Esto te desconectará de todos los dispositivos excepto este.</p>
                </div>
                <button type="button" class="btn btn-ghost" id="btnEliminarCuenta">Eliminar cuenta</button>
              </div>
              <p class="nota-ayuda">Las reseñas y el panel administrativo solo están disponibles para correos verificados.</p>
              <p id="estadoCuenta" class="mensaje-error" hidden aria-live="polite" role="status"></p>
            </fieldset>
          </div>
        </div>
      </section>

      <section id="seccionAdmin" class="seccion" data-seccion="admin" hidden>
        <h2>Panel administrativo</h2>
        <p>Disponible solo para cuentas con rol <code>admin</code> registrado en <code>usuarios/{uid}</code>.</p>
        <button type="button" class="btn btn-primario" id="btnAbrirModalAdmin">Crear contenido</button>
        <button type="button" class="btn btn-ghost" id="btnInicializarSemilla" hidden>Inicializar datos semilla</button>
        <div id="logSemilla" class="log-semilla" aria-live="polite" hidden style="margin-top:0.75rem;display:none;gap:0.35rem;"></div>
        <ul id="listaAdmin" style="margin:1rem 0 0;padding:0;list-style:none;display:grid;gap:0.75rem;"></ul>
        <div style="margin-top:1.5rem;display:grid;gap:0.75rem;">
          <h3 style="margin:0;">Moderación y seguridad</h3>
          <form id="formBan" class="formulario" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));align-items:end;gap:0.75rem;">
            <label style="flex:1;">
              IP a bloquear
              <input type="text" name="ip" id="inputBanIp" placeholder="Ej. 192.168.1.10" pattern="^(?:\d{1,3}\.){3}\d{1,3}$">
            </label>
            <button type="submit" class="btn btn-ghost">Bloquear IP</button>
          </form>
          <div>
            <p style="margin:0 0 0.5rem;">IPs bloqueadas (se aplican también a invitados):</p>
            <ul id="listaBaneados" style="list-style:none;padding:0;display:grid;gap:0.5rem;"></ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <div class="modal" id="modalBienvenida" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalBienvenida">
      <button type="button" class="modal-cerrar" id="btnCerrarModalBienvenida" aria-label="Cerrar">×</button>
      <h3 id="tituloModalBienvenida">Configura tu experiencia</h3>
      <div class="panel-accesibilidad">
        <div class="grupo-opcion">
          <label class="toggle"><input type="checkbox" id="initContraste"> Alto contraste</label>
          <small>Mejora la visibilidad de los textos y botones.</small>
        </div>
        <div class="grupo-opcion">
          <label class="toggle"><input type="checkbox" id="initTexto"> Texto ampliado</label>
          <small>Aumenta el tamaño base de la letra.</small>
        </div>
        <div class="grupo-opcion">
          <label class="toggle"><input type="checkbox" id="initEspaciado"> Espaciado adicional</label>
          <small>Más espacio entre líneas para leer con calma.</small>
        </div>
        <div class="grupo-opcion">
          <label class="toggle"><input type="checkbox" id="initLinks"> Subrayar enlaces</label>
          <small>Resalta todos los enlaces disponibles.</small>
        </div>
      </div>
      <div class="panel-login-inicio">
        <h4 style="margin:0;">Elige cómo quieres acceder</h4>
        <div class="botonera">
          <button type="button" class="btn btn-primario btn-icono" id="btnLoginCorreo">
            <span>📧</span> Iniciar sesión con correo
          </button>
          <button type="button" class="btn btn-ghost btn-icono" id="btnLoginGoogle">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="">
            Continuar con Google
          </button>
          <button type="button" class="btn btn-ghost btn-icono" id="btnLoginFacebook" style="display:none;" aria-hidden="true">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/facebook.svg" alt="">
            Continuar con Facebook
          </button>
          <button type="button" class="btn btn-ghost" id="btnInvitado">Entrar como invitado</button>
        </div>
        <small>Puedes cerrar esta ventana si prefieres explorar como invitado.</small>
      </div>
    </div>
  </div>

  <div class="modal" id="modalLogin" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalLogin">
      <button type="button" class="modal-cerrar" id="btnCerrarModalLogin" aria-label="Cerrar">×</button>
      <h3 id="tituloModalLogin">Iniciar sesión</h3>
      <form class="formulario" id="formLogin" novalidate>
        <div class="campo-validado">
          <label for="inputLoginEmail">Correo electrónico</label>
          <div class="input-con-icono">
            <input type="email" name="email" id="inputLoginEmail" autocomplete="username" required aria-describedby="errorLoginEmail" aria-label="Correo electrónico" data-focus-inicial>
            <span class="indicador-validacion" id="indicadorLoginEmail" aria-hidden="true">•</span>
          </div>
          <p class="mensaje-error" id="errorLoginEmail" hidden aria-live="polite"></p>
        </div>
        <div class="campo-validado">
          <label for="inputLoginPassword">Contraseña</label>
          <div class="input-con-icono">
            <input type="password" name="password" id="inputLoginPassword" autocomplete="current-password" required minlength="8" aria-describedby="errorLoginPassword" aria-label="Contraseña">
            <button type="button" class="toggle-password" data-target="inputLoginPassword" aria-label="Mostrar contraseña">👁</button>
            <span class="indicador-validacion" id="indicadorLoginPassword" aria-hidden="true" style="right:2.5rem;">•</span>
          </div>
          <p class="mensaje-error" id="errorLoginPassword" hidden aria-live="polite"></p>
        </div>
        <button type="button" class="btn-link" id="btnOlvidoPassword">¿Olvidaste tu contraseña?</button>
        <div class="alerta-secundaria" id="alertaCuentaInexistente" hidden>
          <span>Esta cuenta no existe. ¿Quieres crear una cuenta?</span>
          <button type="button" class="btn btn-ghost" id="btnIrRegistroDesdeLogin">Crear cuenta nueva</button>
        </div>
        <div class="captcha-simulacion" id="captchaLogin" hidden>
          <label for="checkCaptchaLogin" style="display:flex;align-items:center;gap:0.5rem;">
            <input type="checkbox" id="checkCaptchaLogin" aria-describedby="ayudaCaptchaLogin">
            <span>Confirmo que soy una persona real</span>
          </label>
          <small class="nota-ayuda" id="ayudaCaptchaLogin">Verificación adicional tras varios intentos fallidos.</small>
        </div>
        <button type="submit" class="btn btn-primario" id="btnSubmitLogin">Acceder</button>
        <p class="mensaje-validacion">¿No tienes cuenta? <button type="button" class="btn-link" id="btnAbrirRegistroDesdeLogin">Crear cuenta nueva</button></p>
      </form>
    </div>
  </div>

  <div class="modal" id="modalRegistro" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalRegistro">
      <button type="button" class="modal-cerrar" id="btnCerrarModalRegistro" aria-label="Cerrar">×</button>
      <h3 id="tituloModalRegistro">Crear cuenta</h3>
      <form class="formulario" id="formRegistro" novalidate>
        <div class="campo-validado">
          <label for="inputRegistroEmail">Correo electrónico</label>
          <div class="input-con-icono">
            <input type="email" id="inputRegistroEmail" name="email" required autocomplete="email" aria-describedby="errorRegistroEmail" aria-label="Correo electrónico" data-focus-inicial>
            <span class="indicador-validacion" id="indicadorRegistroEmail" aria-hidden="true">•</span>
          </div>
          <p class="mensaje-error" id="errorRegistroEmail" hidden aria-live="polite"></p>
        </div>
        <div class="campo-validado">
          <label for="inputRegistroPassword">Contraseña</label>
          <div class="input-con-icono">
            <input type="password" id="inputRegistroPassword" name="password" autocomplete="new-password" required minlength="8" aria-describedby="errorRegistroPassword listaRequisitosPassword" aria-label="Contraseña">
            <button type="button" class="toggle-password" data-target="inputRegistroPassword" aria-label="Mostrar contraseña">👁</button>
          </div>
          <div class="barra-fuerza" id="barraFuerzaRegistro"><span></span></div>
          <ul class="requisitos-password" id="listaRequisitosPassword">
            <li>Mínimo 8 caracteres</li>
            <li>Una mayúscula</li>
            <li>Un número</li>
            <li>Un carácter especial (@$!%*?&)</li>
          </ul>
          <p class="mensaje-error" id="errorRegistroPassword" hidden aria-live="polite"></p>
        </div>
        <div class="campo-validado">
          <label for="inputRegistroPasswordConfirm">Confirmar contraseña</label>
          <div class="input-con-icono">
            <input type="password" id="inputRegistroPasswordConfirm" name="passwordConfirm" autocomplete="new-password" required aria-describedby="errorRegistroConfirm" aria-label="Confirmar contraseña">
            <button type="button" class="toggle-password" data-target="inputRegistroPasswordConfirm" aria-label="Mostrar confirmación">👁</button>
          </div>
          <p class="mensaje-error" id="errorRegistroConfirm" hidden aria-live="polite"></p>
        </div>
        <label>
          Nombre para mostrar (opcional)
          <input type="text" id="inputRegistroDisplayName" name="displayName" maxlength="60" aria-label="Nombre para mostrar">
        </label>
        <label style="display:flex;align-items:center;gap:0.5rem;">
          <input type="checkbox" id="checkTerminos" required>
          <span>Acepto los <a href="#" target="_blank" rel="noopener">términos y condiciones</a></span>
        </label>
        <p class="mensaje-error" id="errorRegistroTerminos" hidden aria-live="polite"></p>
        <p class="mensaje-exito" id="mensajeRegistroExito" hidden aria-live="polite"></p>
        <button type="submit" class="btn btn-primario" id="btnSubmitRegistro">Crear cuenta</button>
      </form>
    </div>
  </div>

    <div class="modal" id="modalRecuperacion" aria-hidden="true">
      <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalRecuperacion">
        <button type="button" class="modal-cerrar" id="btnCerrarModalRecuperacion" aria-label="Cerrar">×</button>
        <h3 id="tituloModalRecuperacion">Recuperar contraseña</h3>
        <form class="formulario" id="formRecuperacion" novalidate>
          <p>Introduce el correo asociado a tu cuenta y te enviaremos un enlace para restablecer tu contraseña.</p>
          <label for="inputRecuperacionEmail">
            Correo electrónico
            <input type="email" id="inputRecuperacionEmail" autocomplete="email" required aria-describedby="errorRecuperacion" aria-label="Correo electrónico" data-focus-inicial>
          </label>
          <p class="mensaje-error" id="errorRecuperacion" hidden aria-live="polite"></p>
          <p class="mensaje-exito" id="exitoRecuperacion" hidden aria-live="polite"></p>
          <button type="submit" class="btn btn-primario" id="btnEnviarRecuperacion">Enviar instrucciones</button>
        </form>
      </div>
    </div>

  <div class="modal" id="modalCambioEmail" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalCambioEmail">
      <button type="button" class="modal-cerrar" id="btnCerrarModalCambioEmail" aria-label="Cerrar">×</button>
      <h3 id="tituloModalCambioEmail">Actualizar email</h3>
      <form class="formulario" id="formCambioEmail" novalidate>
        <div class="campo-validado">
          <label for="inputNuevoEmail">Nuevo email</label>
          <div class="input-con-icono">
            <input type="email" id="inputNuevoEmail" autocomplete="email" required aria-describedby="errorCambioEmail" aria-label="Nuevo email" data-focus-inicial>
            <span class="indicador-validacion" id="indicadorNuevoEmail">•</span>
          </div>
        </div>
        <div class="campo-validado">
          <label for="inputPasswordEmail">Contraseña actual</label>
          <div class="input-con-icono">
            <input type="password" id="inputPasswordEmail" autocomplete="current-password" required aria-describedby="errorCambioEmail" aria-label="Contraseña actual">
            <button type="button" class="toggle-password" data-target="inputPasswordEmail" aria-label="Mostrar contraseña">👁</button>
          </div>
        </div>
        <p class="mensaje-error" id="errorCambioEmail" hidden aria-live="polite"></p>
        <button type="submit" class="btn btn-primario" id="btnSubmitCambioEmail">Actualizar email</button>
      </form>
    </div>
  </div>

  <div class="modal" id="modalCambioPassword" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalCambioPassword">
      <button type="button" class="modal-cerrar" id="btnCerrarModalCambioPassword" aria-label="Cerrar">×</button>
      <h3 id="tituloModalCambioPassword">Actualizar contraseña</h3>
      <form class="formulario" id="formPassword" novalidate>
        <div class="campo-validado">
          <label for="inputPasswordActual">Contraseña actual</label>
          <div class="input-con-icono">
            <input type="password" name="passwordActual" id="inputPasswordActual" autocomplete="current-password" required aria-describedby="errorPasswordActual" aria-label="Contraseña actual">
            <button type="button" class="toggle-password" data-target="inputPasswordActual" aria-label="Mostrar contraseña actual">👁</button>
          </div>
          <p class="mensaje-error" id="errorPasswordActual" hidden aria-live="polite"></p>
        </div>
        <div class="campo-validado">
          <label for="inputNuevaPassword">Nueva contraseña</label>
          <div class="input-con-icono">
            <input type="password" name="password" id="inputNuevaPassword" minlength="8" autocomplete="new-password" required aria-describedby="errorNuevaPassword" aria-label="Nueva contraseña">
            <button type="button" class="toggle-password" data-target="inputNuevaPassword" aria-label="Mostrar nueva contraseña">👁</button>
          </div>
          <div class="barra-fuerza" id="barraFuerzaPassword" aria-hidden="true"><span></span></div>
          <ul class="requisitos-password">
            <li>Mínimo 8 caracteres</li>
            <li>Al menos una mayúscula, un número y un símbolo</li>
          </ul>
          <p class="mensaje-error" id="errorNuevaPassword" hidden aria-live="polite"></p>
        </div>
        <div class="campo-validado">
          <label for="inputConfirmarPassword">Confirmar nueva contraseña</label>
          <div class="input-con-icono">
            <input type="password" name="passwordConfirm" id="inputConfirmarPassword" autocomplete="new-password" required aria-describedby="errorConfirmarPassword" aria-label="Confirmar contraseña">
            <button type="button" class="toggle-password" data-target="inputConfirmarPassword" aria-label="Mostrar confirmación de contraseña">👁</button>
          </div>
          <p class="mensaje-error" id="errorConfirmarPassword" hidden aria-live="polite"></p>
        </div>
        <button type="submit" class="btn btn-primario">Guardar contraseña</button>
      </form>
    </div>
  </div>

  <div class="modal" id="modalCerrarSesiones" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalCerrarSesiones">
      <button type="button" class="modal-cerrar" id="btnCerrarModalCerrarSesiones" aria-label="Cerrar">×</button>
      <h3 id="tituloModalCerrarSesiones">¿Cerrar sesión en todos los dispositivos?</h3>
      <p>Esto cerrará la sesión en cualquier dispositivo donde hayas iniciado sesión. Podrás volver a acceder aquí inmediatamente.</p>
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap;justify-content:flex-end;">
        <button type="button" class="btn btn-ghost" id="btnCancelarCerrarSesiones">Cancelar</button>
        <button type="button" class="btn btn-primario" id="btnConfirmarCerrarSesiones">Cerrar sesiones</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modalEliminarCuenta" aria-hidden="true">
    <div class="modal-dialogo modal-peligro" role="alertdialog" aria-modal="true" aria-labelledby="tituloModalEliminar" aria-describedby="descripcionModalEliminar">
      <button type="button" class="modal-cerrar" id="btnCerrarModalEliminar" aria-label="Cerrar">×</button>
      <div class="paso-eliminar" data-paso="aviso">
        <h3 id="tituloModalEliminar">Eliminar cuenta</h3>
        <p id="descripcionModalEliminar" class="alerta-peligro">Esta acción eliminará tu perfil, reseñas y cualquier dato asociado. No podrás recuperarlos.</p>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;justify-content:flex-end;">
          <button type="button" class="btn btn-ghost" id="btnCancelarEliminarCuenta">Cancelar</button>
          <button type="button" class="btn btn-primario" id="btnContinuarEliminar" data-focus-inicial>Comprendo los riesgos</button>
        </div>
      </div>
      <form class="formulario paso-eliminar" id="formEliminarCuenta" data-paso="confirmacion" hidden>
        <h3>Confirma tu identidad</h3>
        <div class="campo-validado">
          <label for="inputPasswordEliminar">Contraseña actual</label>
          <div class="input-con-icono">
            <input type="password" id="inputPasswordEliminar" autocomplete="current-password" required aria-describedby="errorPasswordEliminar" aria-label="Contraseña actual">
            <button type="button" class="toggle-password" data-target="inputPasswordEliminar" aria-label="Mostrar contraseña">👁</button>
          </div>
          <p class="mensaje-error" id="errorPasswordEliminar" hidden aria-live="polite"></p>
        </div>
        <div class="campo-validado">
          <label for="inputConfirmacionEliminar">Escribe ELIMINAR para continuar</label>
          <input type="text" id="inputConfirmacionEliminar" autocomplete="off" autocapitalize="characters" required aria-describedby="ayudaConfirmacionEliminar errorConfirmacionEliminar" aria-label="Confirmación definitiva">
          <p class="nota-ayuda" id="ayudaConfirmacionEliminar">Debes escribir la palabra ELIMINAR con mayúsculas para desbloquear el botón.</p>
          <p class="mensaje-error" id="errorConfirmacionEliminar" hidden aria-live="polite"></p>
        </div>
        <p class="mensaje-error" id="errorEliminarCuenta" hidden aria-live="polite"></p>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;justify-content:flex-end;">
          <button type="button" class="btn btn-ghost" id="btnVolverPasoEliminar">Atrás</button>
          <button type="submit" class="btn btn-primario" id="btnConfirmarEliminarCuenta">Eliminar definitivamente</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="modalInactividad" aria-hidden="true">
    <div class="modal-dialogo modal-aviso" role="alertdialog" aria-modal="true" aria-labelledby="tituloModalInactividad" aria-describedby="descripcionModalInactividad">
      <button type="button" class="modal-cerrar" id="btnCerrarModalInactividad" aria-label="Cerrar">×</button>
      <h3 id="tituloModalInactividad">Sesión a punto de expirar</h3>
      <p id="descripcionModalInactividad">Tu sesión expirará en <strong id="tiempoRestanteInactividad">2 minutos</strong> por inactividad.</p>
      <button type="button" class="btn btn-primario" id="btnMantenerSesion">Mantener sesión activa</button>
    </div>
  </div>

  <div class="modal" id="modalAdmin" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalAdmin">
      <button type="button" class="modal-cerrar" id="btnCerrarModalAdmin" aria-label="Cerrar">×</button>
      <h3 id="tituloModalAdmin">Nuevo contenido</h3>
      <form class="formulario" id="formAdmin">
        <label>
          Tipo de colección
          <select name="coleccion" required>
            <option value="lugares">Lugares</option>
            <option value="restaurantes">Restaurantes</option>
            <option value="ocio">Ocio</option>
            <option value="historia">Historia</option>
            <option value="eventos">Eventos</option>
          </select>
        </label>
        <label>
          Nombre
          <input name="nombre" maxlength="60" required>
        </label>
        <label>
          Descripción
          <textarea name="descripcion" maxlength="2000" required></textarea>
        </label>
        <label>
          Imagen (URL segura)
          <input name="imagen" type="url" placeholder="https://">
        </label>
        <label>
          O subir archivo
          <input name="archivoImagen" type="file" accept="image/*">
        </label>
        <label>
          Etiquetas separadas por coma (máx. 8 etiquetas, 20 caracteres c/u)
          <input name="etiquetas" maxlength="200">
        </label>
        <label>
          Enlace externo opcional
          <input name="enlace" type="url" placeholder="https://">
        </label>
        <label data-admin-ubicacion>
          Dirección física
          <input name="direccion" id="inputDireccion" maxlength="160" placeholder="Ej. C/ Mayor, 24">
        </label>
        <div class="grupo-coordenadas" data-admin-ubicacion>
          <label>
            Latitud
            <input name="latitud" id="inputLatitud" type="number" step="0.000001" placeholder="40.20648">
          </label>
          <label>
            Longitud
            <input name="longitud" id="inputLongitud" type="number" step="0.000001" placeholder="-3.56776">
          </label>
          <button type="button" class="btn btn-ghost btn-sm" id="btnAutoCoordenadas">Usar mi ubicación</button>
        </div>
        <small data-admin-ubicacion>Las coordenadas ayudan a ubicar el mapa y calcular distancias para las personas que buscan cercanía.</small>
        <label data-admin-historia hidden>
          Año del hito histórico
          <input name="anioHistoria" id="inputAnioHistoria" type="number" min="0" max="9999" placeholder="1574" disabled>
        </label>
        <small class="nota-ayuda" data-admin-historia hidden>Los apartados de historia se ordenan automáticamente por el año indicado y se muestran sin reseñas ni ubicación.</small>
        <label>
          Galería (una URL por línea)
          <textarea name="galeria" id="inputGaleria" rows="3" placeholder="https://ejemplo.com/foto1.jpg&#10;https://ejemplo.com/foto2.jpg"></textarea>
        </label>
        <label>
          Subir fotos para la galería
          <input name="archivosGaleria" id="inputArchivosGaleria" type="file" accept="image/*" multiple>
        </label>
        <button type="submit" class="btn btn-primario">Guardar</button>
      </form>
    </div>
  </div>

  <div class="modal" id="modalBaneado" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="tituloModalBaneado">
      <h3 id="tituloModalBaneado">Acceso restringido</h3>
      <p>Tu IP ha sido bloqueada por el equipo de moderación. Si crees que se trata de un error escribe a turismo@sanmartindelavega.es con los detalles de tu visita.</p>
    </div>
  </div>

  <div class="consent-banner" id="bannerConsentimiento" role="region" aria-live="polite">
    <div>
      <strong>Consentimiento de cookies analíticas</strong>
      <p>Usamos Google Analytics para medir visitas de forma anónima. Solo se activará si aceptas. Puedes cambiarlo en Ajustes.</p>
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:0.5rem;">
      <button type="button" class="btn btn-primario" id="btnAceptarConsent">Aceptar</button>
      <button type="button" class="btn btn-ghost" id="btnRechazarConsent">Rechazar</button>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      GoogleAuthProvider,
      FacebookAuthProvider,
      signInWithPopup,
      signInWithRedirect,
      getRedirectResult,
      setPersistence,
      browserLocalPersistence,
      updateProfile,
      updatePassword,
      updateEmail,
      sendEmailVerification,
      sendPasswordResetEmail,
      EmailAuthProvider,
      reauthenticateWithCredential,
      fetchSignInMethodsForEmail,
      getIdToken,
      deleteUser
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      limit,
      startAfter,
      where,
      getDocs,
      getDoc,
      addDoc,
      updateDoc,
      setDoc,
      deleteDoc,
      serverTimestamp,
      doc,
      deleteField
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    let ultimoEnvioEmail = 0;
    const COOLDOWN_EMAIL = 60000; // 60 segundos
    let monitoreoVerificacionInterval = null;
    let intentosVerificacion = 0;
    let verificacionEnCurso = false;
    const INTERVALO_VERIFICACION_MS = 5000;
    const MAX_INTENTOS_VERIFICACION = Math.ceil((10 * 60 * 1000) / INTERVALO_VERIFICACION_MS);

    const firebaseConfig = {
      apiKey: 'AIzaSyDigVtE9WexPsg0gOvjcsuYVO_FX-r__7o',
      authDomain: 'interfaces-4bc20.firebaseapp.com',
      projectId: 'interfaces-4bc20',
      // Bucket oficial proporcionado por el proyecto de Firebase Storage.
      storageBucket: 'interfaces-4bc20.firebasestorage.app',
      messagingSenderId: '1007775332703',
      appId: '1:1007775332703:web:1f6f6d7bb6a2d268a75eea',
      measurementId: 'G-G3BQBDN5M6'
    };

    const DOMINIOS_ANALYTICS = ['turismo.sanmartindelavega.es', 'sanmartindelavega.es'];
    const DOMINIOS_FIREBASE_STORAGE = ['turismo.sanmartindelavega.es', 'sanmartindelavega.es'];
    const hostActual = (() => {
      if (typeof window === 'undefined' || !window.location?.hostname) return '';
      return window.location.hostname.toLowerCase();
    })();
    const coincideDominio = (lista) =>
      !!hostActual && lista.some((dominio) => hostActual === dominio || hostActual.endsWith(`.${dominio}`));
    const puedeEjecutarAnalyticsEnDominio = coincideDominio(DOMINIOS_ANALYTICS);
    // Control de dominios autorizados para subidas a Firebase Storage. Añade un nuevo dominio
    // extendiendo las condiciones siguientes y documenta el motivo para mantener la seguridad.
    // Este check protege las credenciales de Storage impidiendo su uso desde orígenes no aprobados.
    const puedeUsarFirebaseStorage = (() => {
      if (typeof window === 'undefined' || !window.location) return false;
      const { origin, hostname, protocol, pathname } = window.location;
      const origen = (origin || '').toLowerCase();
      const host = (hostname || '').toLowerCase();
      const ruta = pathname || '';
      const rutaGithub = '/Guia-turistica-San-Martin-de-la-Vega/';
      if (coincideDominio(DOMINIOS_FIREBASE_STORAGE)) return true;
      if (protocol === 'file:') return true;
      if (host === 'localhost' || host === '127.0.0.1') return true;
      if (origen === 'https://mrdaniel7.github.io') {
        if (!ruta || ruta === '/' || ruta.startsWith(rutaGithub)) return true;
      }
      return false;
    })();

    const obtenerUrlAccionEmail = () => {
      if (typeof window !== 'undefined' && window.location) {
        const { protocol, origin } = window.location;
        if (protocol === 'http:' || protocol === 'https:') {
          return `${origin}/`;
        }
      }
      if (firebaseConfig?.authDomain) {
        return `https://${firebaseConfig.authDomain}`;
      }
      return 'https://interfaces-4bc20.firebaseapp.com';
    };

    const emailActionSettings = {
      url: obtenerUrlAccionEmail(),
      handleCodeInApp: false
    };

    const DATOS_SEMILLA = {
      lugares: [
        {
          id: 'iglesia-natividad',
          nombre: 'Iglesia de la Natividad',
          descripcion: 'Templo mudéjar del siglo XV con visitas guiadas gratuitas los fines de semana.',
          imagen: 'assets/lugar-iglesia-3.svg',
          etiquetas: ['cultural', 'familia'],
          enlace: 'https://turismo.sanmartindelavega.es/iglesia',
          direccion: 'Plaza de la Constitución, 1',
          coordenadas: [40.20648, -3.56776]
        },
        {
          id: 'mirador-maranosa',
          nombre: 'Mirador de la Marañosa',
          descripcion: 'Vistas panorámicas del valle del Jarama y zona ornitológica señalizada.',
          imagen: 'assets/lugar-maranosa-3.svg',
          etiquetas: ['naturaleza', 'familia'],
          enlace: 'https://turismo.sanmartindelavega.es/maranosa',
          direccion: 'Camino de la Marañosa s/n',
          coordenadas: [40.29294, -3.56374]
        },
        {
          id: 'parque-warner',
          nombre: 'Parque Warner Madrid',
          descripcion: 'Atracciones tematizadas y espectáculos inmersivos para toda la familia.',
          imagen: 'assets/lugar-warner-3.svg',
          etiquetas: ['familia', 'aventura'],
          enlace: 'https://www.parquewarner.com/',
          direccion: 'Carretera M-506, salida Parque Warner',
          coordenadas: [40.23432, -3.58723]
        },
        {
          id: 'ruta-humedales',
          nombre: 'Ruta de los Humedales',
          descripcion: 'Itinerario circular señalizado para observar flora y fauna protegida.',
          imagen: 'assets/lugar-maranosa.svg',
          etiquetas: ['naturaleza'],
          enlace: 'https://turismo.sanmartindelavega.es/humedales',
          direccion: 'Centro de visitantes Lagunas de la Marañosa',
          coordenadas: [40.18417, -3.56453]
        }
      ],
      restaurantes: [
        {
          id: 'el-lindero',
          nombre: 'Mesón El Lindero',
          descripcion: 'Cocina tradicional con horno de leña y menús de fin de semana.',
          imagen: 'assets/restaurante-lindero-3.svg',
          etiquetas: ['tradicional', 'asador', 'terraza', 'km0'],
          enlace: 'https://restaurantesanmartindelavega.es/lindero',
          direccion: 'Calle Mayor, 24',
          coordenadas: [40.20596, -3.56824]
        },
        {
          id: 'zatara',
          nombre: 'Restaurante Zátara',
          descripcion: 'Propuestas creativas con productos locales y terraza ajardinada.',
          imagen: 'assets/restaurante-zatara-3.svg',
          etiquetas: ['tapas', 'tradicional', 'veg-friendly', 'terraza', 'sin-gluten', 'km0'],
          enlace: 'https://restaurantesanmartindelavega.es/zatara',
          direccion: 'Avenida de la Vega, 18',
          coordenadas: [40.20546, -3.57112]
        },
        {
          id: 'plaza-jarama',
          nombre: 'Plaza del Jarama',
          descripcion: 'Tapas contemporáneas y carta vegana disponible bajo reserva.',
          imagen: 'assets/restaurante-lindero-2.svg',
          etiquetas: ['tapas', 'veg-friendly', 'sin-gluten', 'terraza'],
          enlace: 'https://turismo.sanmartindelavega.es/gastronomia',
          direccion: 'Plaza de la Constitución, 3',
          coordenadas: [40.20698, -3.56794]
        }
      ],
      ocio: [
        {
          id: 'circuito-jarama',
          nombre: 'Karting Circuito del Jarama',
          descripcion: 'Trazado homologado con tandas cronometradas y monitores profesionales.',
          imagen: 'assets/ocio-jarama-3.svg',
          etiquetas: ['aventura'],
          enlace: 'https://turismo.sanmartindelavega.es/karting',
          direccion: 'Camino del Río Jarama',
          coordenadas: [40.2124, -3.5733]
        },
        {
          id: 'bunker-guerra',
          nombre: 'Búnker de la Guerra Civil',
          descripcion: 'Centro de interpretación al aire libre con visitas teatralizadas.',
          imagen: 'assets/ocio-bunker-3.svg',
          etiquetas: ['cultural'],
          enlace: 'https://turismo.sanmartindelavega.es/bunker',
          direccion: 'Camino de Ciempozuelos km 1',
          coordenadas: [40.2268, -3.5752]
        },
        {
          id: 'piraguas-jarama',
          nombre: 'Piraguas en el Jarama',
          descripcion: 'Recorridos guiados por el río con seguros incluidos y material adaptado.',
          imagen: 'assets/ocio-jarama-2.svg',
          etiquetas: ['agua', 'familia'],
          enlace: 'https://turismo.sanmartindelavega.es/piraguas',
          direccion: 'Embarcadero municipal del Jarama',
          coordenadas: [40.1995, -3.5691]
        }
      ],
      historia: [
        {
          id: 'hist-1574',
          anio: 1574,
          nombre: 'Otorgamiento del título de villa',
          titulo: 'Otorgamiento del título de villa',
          descripcion: 'Felipe II concede a San Martín de la Vega el privilegio de villazgo con jurisdicción propia.',
          imagen: 'assets/lugar-iglesia.svg',
          galeria: ['assets/lugar-iglesia-2.svg'],
          etiquetas: ['fundacional', 'patrimonio']
        },
        {
          id: 'hist-1939',
          anio: 1939,
          nombre: 'Reconstrucción del casco urbano',
          titulo: 'Reconstrucción del casco urbano',
          descripcion: 'Tras la Guerra Civil se impulsa un plan de reconstrucción y mejora de servicios públicos.',
          imagen: 'assets/lugar-maranosa.svg',
          galeria: ['assets/lugar-maranosa-2.svg'],
          etiquetas: ['urbanismo', 'memoria']
        },
        {
          id: 'hist-2002',
          anio: 2002,
          nombre: 'Inauguración del Parque Warner',
          titulo: 'Inauguración del Parque Warner',
          descripcion: 'Se abre el mayor parque temático de la Comunidad de Madrid, dinamizando la economía local.',
          imagen: 'assets/lugar-warner.svg',
          galeria: ['assets/lugar-warner-2.svg'],
          etiquetas: ['economía', 'turismo']
        }
      ],
      eventos: [
        { id: 'romeria', titulo: 'Romería de la Virgen', descripcion: 'Procesión hasta la ermita con actuaciones folclóricas.', fecha: { seconds: Math.floor(new Date().setMonth(new Date().getMonth(), 15) / 1000) }, tipo: 'fiesta_local', enlace: 'https://turismo.sanmartindelavega.es/romeria' },
        { id: 'feria-gastronomia', titulo: 'Feria Gastronómica', descripcion: 'Degustaciones de productores locales en la Plaza de la Constitución.', fecha: { seconds: Math.floor(new Date().setMonth(new Date().getMonth() + 1, 7) / 1000) }, tipo: 'gastronomia', enlace: 'https://turismo.sanmartindelavega.es/feria' },
        { id: 'carrera-noche', titulo: 'Carrera Nocturna Vega Night', descripcion: 'Recorrido popular de 5 km con inscripción solidaria.', fecha: { seconds: Math.floor(new Date().setMonth(new Date().getMonth() + 2, 21) / 1000) }, tipo: 'deporte' },
        { id: 'fiestas-patronales', titulo: 'Fiestas patronales de San Martín', descripcion: 'Conciertos, encierros y fuegos artificiales durante todo el fin de semana.', fecha: { seconds: Math.floor(new Date().setMonth(new Date().getMonth() + 3, 3) / 1000) }, tipo: 'no_laborable', enlace: 'https://turismo.sanmartindelavega.es/fiestas' },
        { id: 'jornada-puertas', titulo: 'Jornada sin clases en colegios', descripcion: 'Actividades culturales para escolares y familias.', fecha: { seconds: Math.floor(new Date().setMonth(new Date().getMonth() + 1, 25) / 1000) }, tipo: 'no_lectivo' }
      ],
      resenas: [
        { id: 'rese-1', itemId: 'iglesia-natividad', titulo: 'Visita obligada', texto: 'La iglesia mudéjar es preciosa y las visitas guiadas son muy amenas.', rating: 5, autor: 'María G.', tipoSeccion: 'lugares', creado: { seconds: Math.floor(Date.now() / 1000) - 86400 }, usuarioId: 'offline-visitante-1' },
        { id: 'rese-2', itemId: 'parque-warner', titulo: 'Ideal con peques', texto: 'Pasamos el día en el parque Warner y todo está muy bien organizado.', rating: 4, autor: 'Javier P.', tipoSeccion: 'lugares', creado: { seconds: Math.floor(Date.now() / 1000) - 172800 }, usuarioId: 'offline-visitante-2' },
        { id: 'rese-3', itemId: 'el-lindero', titulo: 'Cocido espectacular', texto: 'El menú de fin de semana es abundante y con producto local.', rating: 5, autor: 'Lucía R.', tipoSeccion: 'restaurantes', creado: { seconds: Math.floor(Date.now() / 1000) - 432000 }, usuarioId: 'offline-visitante-3' },
        { id: 'rese-4', itemId: 'piraguas-jarama', titulo: 'Experiencia tranquila', texto: 'Ideal para desconectar y disfrutar del río con monitores atentos.', rating: 4, autor: 'Diego L.', tipoSeccion: 'ocio', creado: { seconds: Math.floor(Date.now() / 1000) - 259200 }, usuarioId: 'offline-visitante-4' }
      ],
      clima: {
        temperatura: 24,
        descripcion: 'Cielo despejado sobre San Martín de la Vega',
        pronostico: [
          { fecha: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(), max: 27, min: 15, descripcion: 'Intervalos nubosos' },
          { fecha: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(), max: 26, min: 14, descripcion: 'Cielo despejado' },
          { fecha: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString(), max: 25, min: 13, descripcion: 'Posibles chubascos' }
        ]
      },
      configuracion: {
        gpx: 'https://turismo.sanmartindelavega.es/rutas/ruta-humedales.gpx',
        mapa: [40.20732, -3.57013]
      }
    };

    const obtenerAliasDesdeCorreo = (correo = '') => {
      if (!correo) return generarAliasPublico();
      return generarAliasPublico(correo.toLowerCase());
    };

    const escapeHTML = (s = '') => s.toString()
      .replace(/&/g, '&amp;').replace(/</g, '&lt;')
      .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');

    const isSafeHttpUrl = (u = '') => {
      try {
        const x = new URL(u, location.origin);
        return /^https?:$/.test(x.protocol);
      } catch {
        return false;
      }
    };

    const isSafeImageURL = (u = '') => {
      if (!u) return false;
      if (/^data:image\/(png|jpe?g|webp|svg\+xml);/i.test(u)) return true;
      try {
        const parsed = new URL(u, location.origin);
        if (!/^https?:$/.test(parsed.protocol) && parsed.origin !== location.origin) return false;
        return /\.(png|jpe?g|webp|svg)$/i.test(parsed.pathname);
      } catch {
        return /^assets\//.test(u) && /\.(png|jpe?g|webp|svg)$/i.test(u);
      }
    };

    const obtenerImagenPrincipal = (item) => {
      if (!item) return null;
      if (item.imagenUrl && isSafeImageURL(item.imagenUrl)) return item.imagenUrl;
      if (item.imagen && isSafeImageURL(item.imagen)) return item.imagen;
      return null;
    };

    const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/i;
    const PASSWORD_REGEXP = {
      longitud: /.{8,}/,
      mayuscula: /[A-ZÁÉÍÓÚÜÑ]/,
      numero: /\d/,
      especial: /[@$!%*?&]/
    };

    const esEmailValido = (email = '') => EMAIL_REGEX.test(email.trim());

    const cumplePasswordSegura = (password = '') =>
      PASSWORD_REGEXP.longitud.test(password) &&
      PASSWORD_REGEXP.mayuscula.test(password) &&
      PASSWORD_REGEXP.numero.test(password) &&
      PASSWORD_REGEXP.especial.test(password);

    const evaluarFortalezaPassword = (password = '') => {
      let puntos = 0;
      if (PASSWORD_REGEXP.longitud.test(password)) puntos += 1;
      if (PASSWORD_REGEXP.mayuscula.test(password)) puntos += 1;
      if (PASSWORD_REGEXP.numero.test(password)) puntos += 1;
      if (PASSWORD_REGEXP.especial.test(password)) puntos += 1;
      if (password.length >= 12) puntos += 1;
      const porcentaje = Math.min(100, (puntos / 5) * 100);
      const nivel = porcentaje >= 80 ? 'fuerte' : porcentaje >= 50 ? 'medio' : 'debil';
      return { porcentaje, nivel };
    };

    const actualizarBarraFortaleza = (barra, password = '') => {
      if (!barra) return;
      const span = barra.querySelector('span');
      if (!span) return;
      const { porcentaje, nivel } = evaluarFortalezaPassword(password);
      barra.dataset.nivel = nivel;
      span.style.width = `${porcentaje}%`;
    };

    const setIndicadorValidacion = (indicador, estado = 'neutral') => {
      if (!indicador) return;
      const mapa = { ok: '✓', error: '✗', neutral: '•' };
      const clave = estado === 'ok' ? 'ok' : estado === 'error' ? 'error' : 'neutral';
      indicador.textContent = mapa[clave];
      indicador.dataset.estado = clave;
    };

    const setBotonCargando = (boton, cargando, texto = 'Procesando…') => {
      if (!boton) return;
      boton.setAttribute('aria-busy', cargando ? 'true' : 'false');
      boton.disabled = Boolean(cargando);
      if (cargando) {
        if (!boton.dataset.originalLabel) {
          boton.dataset.originalLabel = boton.innerHTML;
        }
        boton.classList.add('btn-cargando');
        boton.innerHTML = `<span class="spinner" aria-hidden="true"></span><span>${texto}</span>`;
      } else {
        if (boton.dataset.originalLabel) {
          boton.innerHTML = boton.dataset.originalLabel;
          delete boton.dataset.originalLabel;
        }
        boton.classList.remove('btn-cargando');
      }
    };

    const RATE_LIMIT_STORAGE_KEY = 'smv-rate-limits';

    const obtenerIntentosRateLimit = () => {
      try {
        return JSON.parse(localStorage.getItem(RATE_LIMIT_STORAGE_KEY) || '{}');
      } catch (error) {
        console.warn('rate-limit-storage', error);
        return {};
      }
    };

    const guardarIntentosRateLimit = (datos) => {
      localStorage.setItem(RATE_LIMIT_STORAGE_KEY, JSON.stringify(datos));
    };

    const limpiarIntentosCaducos = (lista = [], ventana = 0) => {
      const ahora = Date.now();
      return lista.filter((timestamp) => ahora - timestamp < ventana);
    };

    const puedeIntentarAccion = (clave, maxIntentos, ventana) => {
      const datos = obtenerIntentosRateLimit();
      const intentos = limpiarIntentosCaducos(datos[clave]?.intentos || [], ventana);
      datos[clave] = { intentos };
      guardarIntentosRateLimit(datos);
      const disponible = intentos.length < maxIntentos;
      const restanteMs = disponible ? 0 : ventana - (Date.now() - intentos[0]);
      return { disponible, restanteMs, intentos: intentos.length, max: maxIntentos };
    };

    const registrarIntentoAccion = (clave, ventana) => {
      const datos = obtenerIntentosRateLimit();
      const intentos = limpiarIntentosCaducos(datos[clave]?.intentos || [], ventana);
      intentos.push(Date.now());
      datos[clave] = { intentos };
      guardarIntentosRateLimit(datos);
    };

    const resetIntentosAccion = (clave) => {
      const datos = obtenerIntentosRateLimit();
      if (datos[clave]) {
        datos[clave].intentos = [];
        guardarIntentosRateLimit(datos);
      }
    };

    const formatearTiempoRestante = (ms) => {
      if (ms <= 0) return '';
      const minutos = Math.ceil(ms / 60000);
      if (minutos <= 1) return '1 minuto';
      return `${minutos} minutos`;
    };

    const cuentaExisteCache = new Map();

    const asegurarSesionActivaParaStorage = () => {
      if (!auth) {
        throw new Error('Firebase Auth no está disponible.');
      }
      if (!auth.currentUser) {
        console.error('[storage-upload] Usuario no autenticado');
        mostrarToast('Debes iniciar sesión');
        throw new Error('storage/unauthenticated');
      }
      return auth.currentUser;
    };

    const RATE_LIMITS = {
      login: { clave: 'login', max: 5, ventana: 15 * 60 * 1000 },
      recovery: { clave: 'recovery', max: 3, ventana: 15 * 60 * 1000 },
      verify: { clave: 'verify-email', max: 1, ventana: 5 * 60 * 1000 }
    };

    const USER_ROLES = {
      ADMIN: 'admin',
      USER: 'user',
      VISITANTE: 'visitante',
      INVITADO: 'invitado'
    };

    const verificarCuentaExiste = async (email) => {
      const normalizado = sanitizeEmail(email).toLowerCase();
      if (!normalizado || !firebaseDisponible || !auth) return null;
      if (cuentaExisteCache.has(normalizado)) {
        return cuentaExisteCache.get(normalizado);
      }
      try {
        const metodos = await fetchSignInMethodsForEmail(auth, normalizado);
        const existe = Array.isArray(metodos) && metodos.length > 0;
        cuentaExisteCache.set(normalizado, existe);
        return existe;
      } catch (error) {
        console.warn('verificar-cuenta', error);
        return null;
      }
    };

    // === INICIO: BLOQUE TEMPORAL SEMILLA FIREBASE ===
    const SEMILLA_STORAGE_FOLDER = 'semilla';

    const normalizarUrlAbsoluta = (ruta) => {
      if (!ruta) return null;
      try {
        return new URL(ruta, location.origin).href;
      } catch (error) {
        console.warn('semilla-url-invalida', ruta, error);
        return null;
      }
    };

    const obtenerExtensionArchivo = (url = '') => {
      try {
        const parsed = new URL(url);
        const limpio = parsed.pathname.split('/').pop() || '';
        const [nombre, query] = limpio.split('?');
        const base = query ? nombre : limpio;
        const partes = base.split('.');
        return partes.length > 1 ? partes.pop().toLowerCase() : '';
      } catch {
        return '';
      }
    };

    const subirImagenSemilla = async (ruta, coleccion, nombreBase) => {
      if (!firebaseDisponible || !storage) return normalizarUrlAbsoluta(ruta) || ruta;
      const absoluta = normalizarUrlAbsoluta(ruta);
      if (!absoluta) return null;
      const extension = obtenerExtensionArchivo(absoluta) || 'jpg';
      const nombreSeguro = `${nombreBase}.${extension}`
        .replace(/[^a-z0-9._-]/gi, '-')
        .replace(/-+/g, '-')
        .toLowerCase();
      const referencia = ref(storage, `${SEMILLA_STORAGE_FOLDER}/${coleccion}/${nombreSeguro}`);
      try {
        return await getDownloadURL(referencia);
      } catch (error) {
        // Si no existe, continuamos para subirlo.
      }
      try {
        asegurarSesionActivaParaStorage();
        const respuesta = await fetch(absoluta, { mode: 'cors', credentials: 'omit' });
        if (!respuesta.ok) throw new Error(`fetch-status-${respuesta.status}`);
        const blob = await respuesta.blob();
        await uploadBytes(referencia, blob, { contentType: blob.type || `image/${extension}` });
        return await getDownloadURL(referencia);
      } catch (error) {
        console.warn('semilla-imagen', absoluta, error);
        return absoluta;
      }
    };

    const convertirFechaSemilla = (valor, usarServidor = true) => {
      if (!valor) return usarServidor ? serverTimestamp() : null;
      if (valor instanceof Date) return valor;
      if (typeof valor === 'object' && typeof valor.seconds === 'number') {
        return new Date(valor.seconds * 1000);
      }
      const fecha = new Date(valor);
      if (!Number.isNaN(fecha.getTime())) return fecha;
      return usarServidor ? serverTimestamp() : null;
    };

    const prepararDocSemilla = async (coleccion, item) => {
      const base = { ...item };
      if (base.imagen) {
        const url = await subirImagenSemilla(base.imagen, coleccion, `${base.id}-principal`);
        if (url) {
          base.imagenUrl = url;
        }
        delete base.imagen;
      }
      if (Array.isArray(base.galeria)) {
        const nuevas = [];
        for (let i = 0; i < base.galeria.length; i += 1) {
          const url = await subirImagenSemilla(base.galeria[i], coleccion, `${base.id}-galeria-${i}`);
          if (url) nuevas.push(url);
        }
        base.galeria = nuevas;
      }
      if (coleccion === 'resenas') {
        base.creado = convertirFechaSemilla(base.creado);
        if (base.fechaVisita) base.fechaVisita = convertirFechaSemilla(base.fechaVisita, false);
      } else if (coleccion === 'eventos') {
        base.fecha = convertirFechaSemilla(base.fecha, false);
        base.creado = convertirFechaSemilla(base.creado);
      } else if (coleccion === 'historia') {
        base.creado = convertirFechaSemilla(base.creado);
      } else {
        base.creado = convertirFechaSemilla(base.creado);
        base.actualizado = convertirFechaSemilla(base.actualizado);
      }
      if (base.enlace && !isSafeHttpUrl(base.enlace)) {
        delete base.enlace;
      }
      return base;
    };

    const registrarLogSemilla = (mensaje, tipo = 'info') => {
      if (!logSemilla) return;
      logSemilla.hidden = false;
      logSemilla.style.display = 'grid';
      const linea = document.createElement('p');
      linea.textContent = mensaje;
      linea.dataset.tipo = tipo;
      logSemilla.appendChild(linea);
    };

    const limpiarLogSemilla = () => {
      if (!logSemilla) return;
      logSemilla.textContent = '';
      logSemilla.hidden = true;
      logSemilla.style.display = 'none';
    };

    const inicializarDatosSemilla = async () => {
      if (!puedeUsarPanelAdmin() || !(await isUserAdmin())) {
        mostrarToast('Solo el equipo administrador puede ejecutar la semilla.');
        return;
      }
      if (!firebaseDisponible || !db) {
        mostrarToast('Firebase no está disponible. Inténtalo más tarde.');
        return;
      }
      if (btnInicializarSemilla) btnInicializarSemilla.disabled = true;
      limpiarLogSemilla();
      registrarLogSemilla('Iniciando carga de datos de semilla…');
      try {
        const colecciones = [
          { nombre: 'lugares', lista: Array.isArray(DATOS_SEMILLA.lugares) ? DATOS_SEMILLA.lugares : [] },
          { nombre: 'restaurantes', lista: Array.isArray(DATOS_SEMILLA.restaurantes) ? DATOS_SEMILLA.restaurantes : [] },
          { nombre: 'ocio', lista: Array.isArray(DATOS_SEMILLA.ocio) ? DATOS_SEMILLA.ocio : [] },
          { nombre: 'eventos', lista: Array.isArray(DATOS_SEMILLA.eventos) ? DATOS_SEMILLA.eventos : [] },
          { nombre: 'historia', lista: Array.isArray(DATOS_SEMILLA.historia) ? DATOS_SEMILLA.historia : [] }
        ];
        for (const { nombre, lista } of colecciones) {
          registrarLogSemilla(`Comprobando colección ${nombre}…`);
          const existentes = await getDocs(query(collection(db, nombre), limit(1)));
          if (!existentes.empty) {
            registrarLogSemilla(`Colección ${nombre} ya contiene datos. Se omite.`, 'aviso');
            continue;
          }
          registrarLogSemilla(`Subiendo ${lista.length} elementos a ${nombre}…`);
          for (const item of lista) {
            if (!item?.id) continue;
            const data = await prepararDocSemilla(nombre, item);
            await setDoc(doc(db, nombre, item.id), data, { merge: true });
          }
          registrarLogSemilla(`Colección ${nombre} completada.`, 'ok');
        }
        if (DATOS_SEMILLA.configuracion) {
          registrarLogSemilla('Comprobando configuración…');
          const configuracionExistente = await getDocs(query(collection(db, 'configuracion'), limit(1)));
          if (configuracionExistente.empty) {
            const dataCfg = { ...DATOS_SEMILLA.configuracion };
            if (Array.isArray(dataCfg.mapa)) {
              dataCfg.mapa = { q: dataCfg.mapa };
            }
            await setDoc(doc(db, 'configuracion', 'global'), {
              ...dataCfg,
              actualizado: serverTimestamp()
            }, { merge: true });
            registrarLogSemilla('Configuración creada.', 'ok');
          } else {
            registrarLogSemilla('La configuración ya existe. Se omite.', 'aviso');
          }
        }
        registrarLogSemilla('Datos de semilla cargados correctamente.', 'ok');
        mostrarToast('Datos de semilla inicializados en Firebase.');
        await cargarDatosIniciales();
        await renderAdminLista();
      } catch (error) {
        registrarLogSemilla('Error al cargar los datos de semilla.', 'error');
        logError(error, 'semilla-manual');
        mostrarToast('No se pudieron cargar los datos de semilla.');
      } finally {
        if (btnInicializarSemilla) btnInicializarSemilla.disabled = false;
      }
    };
    // === FIN: BLOQUE TEMPORAL SEMILLA FIREBASE ===

    const clampRating = (n) => Math.min(5, Math.max(1, Number.isFinite(+n) ? +n : 5));

    const sanitizeText = (valor = '') =>
      valor
        .toString()
        .replace(/[<>]/g, '')
        .replace(/script/gi, '')
        .trim();

    const sanitizeEmail = (valor = '') => valor.toString().replace(/[^a-zA-Z0-9@._+\-]/g, '').trim();

    const safeLink = (a, href) => {
      if (!isSafeHttpUrl(href)) return false;
      a.href = href;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      return true;
    };

    const obtenerCoordenadas = (item) => {
      if (!item) return null;
      const coords = Array.isArray(item.coordenadas)
        ? item.coordenadas
        : Array.isArray(item.coordenadas?.q)
          ? item.coordenadas.q
          : null;
      if (Array.isArray(coords) && coords.length === 2) {
        const lat = Number(coords[0]);
        const lng = Number(coords[1]);
        if (Number.isFinite(lat) && Number.isFinite(lng)) {
          return { lat, lng };
        }
      }
      if (item.ubicacion?.lat != null && item.ubicacion?.lng != null) {
        const lat = Number(item.ubicacion.lat);
        const lng = Number(item.ubicacion.lng);
        if (Number.isFinite(lat) && Number.isFinite(lng)) {
          return { lat, lng };
        }
      }
      return null;
    };

    const construirUrlMapa = (item) => {
      if (!item) return null;
      if (item.mapa && isSafeHttpUrl(item.mapa)) return item.mapa;
      if (item.maps && isSafeHttpUrl(item.maps)) return item.maps;
      const coords = obtenerCoordenadas(item);
      if (coords) {
        return `https://maps.google.com/?q=${coords.lat},${coords.lng}`;
      }
      if (item.direccion) {
        return `https://maps.google.com/?q=${encodeURIComponent(item.direccion)}`;
      }
      return null;
    };

    const construirMapaEmbed = (item) => {
      const coords = obtenerCoordenadas(item);
      if (coords) {
        return `https://maps.google.com/maps?q=${coords.lat},${coords.lng}&z=15&output=embed`;
      }
      if (item?.direccion) {
        return `https://maps.google.com/maps?q=${encodeURIComponent(item.direccion)}&output=embed`;
      }
      return null;
    };

    const solicitarUbicacion = () =>
      new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('geolocalizacion-no-disponible'));
          return;
        }
        navigator.geolocation.getCurrentPosition(
          (position) => {
            resolve({
              lat: Number(position.coords.latitude),
              lng: Number(position.coords.longitude)
            });
          },
          (error) => reject(error),
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 600000 }
        );
      });

    const calcularDistanciaKm = (origen, destino) => {
      if (!origen || !destino) return null;
      const toRad = (grados) => (Number(grados) * Math.PI) / 180;
      const radioTierra = 6371;
      const dLat = toRad(destino.lat - origen.lat);
      const dLng = toRad(destino.lng - origen.lng);
      const lat1 = toRad(origen.lat);
      const lat2 = toRad(destino.lat);
      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.sin(dLng / 2) ** 2 * Math.cos(lat1) * Math.cos(lat2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(Math.max(0, 1 - a)));
      return radioTierra * c;
    };

    const obtenerDistanciaAUsuario = (item) => {
      if (!item || !state.ubicacionUsuario) return null;
      const coords = obtenerCoordenadas(item);
      if (!coords) return null;
      const clave = item.id;
      if (clave && state.distancias.has(clave)) return state.distancias.get(clave);
      const distancia = calcularDistanciaKm(state.ubicacionUsuario, coords);
      if (Number.isFinite(distancia) && clave) {
        state.distancias.set(clave, distancia);
      }
      return Number.isFinite(distancia) ? distancia : null;
    };

    const formatearDistancia = (distanciaKm) => {
      if (!Number.isFinite(distanciaKm)) return null;
      if (distanciaKm < 1) {
        return `${Math.round(distanciaKm * 1000)} m`;
      }
      return `${distanciaKm.toFixed(distanciaKm < 10 ? 1 : 0)} km`;
    };

    const NAV_PREFERENCIAS_KEY = 'smv-nav-preferencia';
    const NAV_OPCIONES = [
      { value: 'auto', label: 'Auto' },
      { value: 'google', label: 'Google' },
      { value: 'apple', label: 'Apple' },
      { value: 'waze', label: 'Waze' },
      { value: 'bing', label: 'Bing' }
    ];

    const detectarPreferenciaNavegacion = () => {
      const agente = navigator.userAgent || '';
      if (/iPad|iPhone|iPod/i.test(agente)) return 'apple';
      if (/Macintosh/i.test(agente) && 'ontouchend' in document) return 'apple';
      if (/Android/i.test(agente)) return 'google';
      return 'auto';
    };

    const obtenerPreferenciaNavegacion = () => {
      const actual = state.navegacionPreferencias.get('global');
      if (actual && NAV_OPCIONES.some((op) => op.value === actual)) {
        return actual;
      }
      let almacenada = null;
      try {
        almacenada = localStorage.getItem(NAV_PREFERENCIAS_KEY);
      } catch (error) {
        console.warn('No se pudo leer la preferencia de navegación almacenada', error);
      }
      const valida = NAV_OPCIONES.some((op) => op.value === almacenada) ? almacenada : 'auto';
      state.navegacionPreferencias.set('global', valida);
      return valida;
    };

    const actualizarNavVisual = (contenedor, preferencia = obtenerPreferenciaNavegacion()) => {
      if (!contenedor) return;
      const actual = NAV_OPCIONES.some((op) => op.value === preferencia) ? preferencia : 'auto';
      contenedor.querySelectorAll('button').forEach((btn) => {
        const valor = btn.dataset.navValor || 'auto';
        const activo = valor === actual;
        btn.classList.toggle('activo', activo);
        btn.setAttribute('aria-pressed', String(activo));
      });
    };

    const establecerPreferenciaNavegacion = (valor) => {
      const preferencia = NAV_OPCIONES.some((op) => op.value === valor) ? valor : 'auto';
      state.navegacionPreferencias.set('global', preferencia);
      try {
        localStorage.setItem(NAV_PREFERENCIAS_KEY, preferencia);
      } catch (error) {
        console.warn('No se pudo guardar la preferencia de navegación', error);
      }
      document.querySelectorAll('[data-nav-opciones]').forEach((contenedor) => {
        actualizarNavVisual(contenedor, preferencia);
      });
    };

    const construirDestinoNavegacion = (item, preferencia = obtenerPreferenciaNavegacion()) => {
      if (!item) return null;
      const coords = obtenerCoordenadas(item);
      const tieneCoords = coords && Number.isFinite(coords.lat) && Number.isFinite(coords.lng);
      const lat = tieneCoords ? coords.lat : null;
      const lng = tieneCoords ? coords.lng : null;
      const direccion = item.direccion ? encodeURIComponent(item.direccion) : '';
      const preferida = preferencia === 'auto' ? detectarPreferenciaNavegacion() : preferencia;
      if (preferida === 'google') {
        if (tieneCoords) {
          return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
        }
        if (direccion) {
          return `https://www.google.com/maps/dir/?api=1&destination=${direccion}`;
        }
      } else if (preferida === 'apple') {
        if (tieneCoords) {
          return `https://maps.apple.com/?daddr=${lat},${lng}`;
        }
        if (direccion) {
          return `https://maps.apple.com/?daddr=${direccion}`;
        }
      } else if (preferida === 'waze') {
        if (tieneCoords) {
          return `https://www.waze.com/ul?ll=${lat},${lng}&navigate=yes`;
        }
        if (direccion) {
          return `https://www.waze.com/ul?q=${direccion}&navigate=yes`;
        }
      } else if (preferida === 'bing') {
        if (tieneCoords) {
          return `https://www.bing.com/maps?rtp=~pos.${lat}_${lng}`;
        }
        if (direccion) {
          return `https://www.bing.com/maps?q=${direccion}`;
        }
      }
      return construirUrlMapa(item);
    };

    const mostrarToast = (mensaje) => {
      toastEl.textContent = mensaje;
      toastEl.classList.add('visible');
      clearTimeout(mostrarToast.timer);
      mostrarToast.timer = setTimeout(() => {
        toastEl.classList.remove('visible');
      }, 4000);
    };


    let modeloModeracion = null;
    let cargaModeracion = null;

    const obtenerModeloModeracion = async () => {
      if (modeloModeracion) return modeloModeracion;
      if (!cargaModeracion) {
        cargaModeracion = (async () => {
          const tf = await import('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.16.0/dist/tf.min.js');
          if (tf?.default && !globalThis.tf) {
            globalThis.tf = tf.default;
          }
          const nsfw = await import('https://cdn.jsdelivr.net/npm/nsfwjs@2.4.1/dist/browser.esm.js');
          modeloModeracion = await nsfw.load();
          return modeloModeracion;
        })();
      }
      return cargaModeracion;
    };

    const leerArchivoComoDataURL = (file) => new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = () => reject(reader.error);
      reader.readAsDataURL(file);
    });

    const esImagenSegura = async (dataUrl) => {
      try {
        const modelo = await obtenerModeloModeracion();
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.src = dataUrl;
        await new Promise((resolve, reject) => {
          img.onload = () => resolve();
          img.onerror = () => reject(new Error('error-carga-imagen'));
        });
        const predicciones = await modelo.classify(img);
        img.remove();
        const prohibida = predicciones.some((pred) => {
          const clase = String(pred.className || '').toLowerCase();
          if (['porn', 'hentai', 'sexy', 'explicit'].some((clave) => clase.includes(clave))) {
            return pred.probability >= 0.5;
          }
          if (['violence', 'gore'].some((clave) => clase.includes(clave))) {
            return pred.probability >= 0.4;
          }
          return false;
        });
        return !prohibida;
      } catch (error) {
        console.warn('moderacion-imagen', error);
        return false;
      }
    };

    const logError = (error, context = 'app') => {
      console.error(`[${context}]`, error);
      const code = String(error?.code || '').toLowerCase();
      const message = String(error?.message || '').toLowerCase();
      if (
        error?.name === 'AbortError' ||
        code.includes('permission-denied') ||
        code.includes('unauth') ||
        code.includes('unavailable') ||
        message.includes('missing or insufficient permissions')
      ) {
        return;
      }
      mostrarToast('Ha ocurrido un error. Inténtalo de nuevo.');
    };

    let app;
    let auth;
    let db;
    let storage;
    let analyticsInstance = null;
    let analyticsImportPromise = null;
    let firebaseDisponible = false;
    let ultimoUidSincronizado = null;

    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      if (auth) auth.languageCode = 'es';
      if (typeof window !== 'undefined') {
        window.__auth = auth || null;
      }

      // ===== PROTECCIÓN FIRESTORE =====
      db = null;

      try {
        db = getFirestore(app);
        console.log('✅ Firestore inicializado correctamente');
      } catch (error) {
        console.error('❌ Error inicializando Firestore:', error);
        db = null;
      }

      storage = getStorage(app, 'gs://interfaces-4bc20.firebasestorage.app');
      // ✅ CORREGIDO: Detector de bloqueo de Firestore (sintaxis modular v9+)
      async function verificarConexionFirebase() {
        try {
          // Usar sintaxis modular en lugar de db.collection()
          const testQuery = query(collection(db, '_test_'), limit(1));
          await getDocs(testQuery);
          return true;
        } catch (error) {
          if (
            error.code === 'unavailable' ||
            error.message.includes('ERR_BLOCKED_BY_CLIENT') ||
            error.message.includes('Failed to fetch')
          ) {
            console.error('⚠️ Firestore bloqueado por extensión o ad blocker');

            mostrarToast(
              'Tu navegador o una extensión está bloqueando la conexión a la base de datos. ' +
                'Por favor, desactiva bloqueadores de anuncios para este sitio.',
              'error',
              10000
            );

            return false;
          }
          throw error;
        }
      }

      // Ejecutar verificación al cargar
      verificarConexionFirebase().catch((error) => {
        console.error('Error verificando conexión Firebase:', error);
      });

      setPersistence(auth, browserLocalPersistence).catch(() => {
        /* Ignorar si el entorno no permite persistencia */
      });
      firebaseDisponible = true;
    } catch (error) {
      firebaseDisponible = false;
      logError(error, 'firebase-init');
      mostrarToast('No se pudo conectar con Firebase. Algunas funciones pueden no estar disponibles.');
    }

    /**
     * Wrapper seguro para operaciones Firestore
     */
    async function safeFirestoreOp(operation, fallbackValue = null) {
      if (!db) {
        console.warn('⚠️ Firestore no disponible - operación omitida');
        return fallbackValue;
      }

      try {
        return await operation();
      } catch (error) {
        const errorStr = error.toString();
        if (errorStr.includes('ERR_BLOCKED_BY_CLIENT') || errorStr.includes('ERR_BLOCKED_BY_RESPONSE')) {
          console.warn('⚠️ Operación Firestore bloqueada por extensión del navegador');
        } else {
          console.error('❌ Error en operación Firestore:', error);
        }
        return fallbackValue;
      }
    }

    const googleProvider = firebaseDisponible ? new GoogleAuthProvider() : null;
    const facebookProvider = firebaseDisponible ? new FacebookAuthProvider() : null;
    if (googleProvider) googleProvider.setCustomParameters({ prompt: 'select_account' });
    if (facebookProvider) facebookProvider.setCustomParameters({ display: 'popup' });

    const toastEl = document.getElementById('toast');
    const bannerVerificacion = document.getElementById('bannerVerificacion');
    const btnReenviarVerificacionBanner = document.getElementById('btnReenviarVerificacionBanner');
    const overlayMenu = document.getElementById('overlayMenu');
    const menu = document.getElementById('menuLateral');
    const btnToggleMenu = document.getElementById('btnToggleMenu');
    const listaMenu = document.getElementById('listaMenu');
    const secciones = Array.from(document.querySelectorAll('[data-seccion]'));
    const contenidoPrincipal = document.getElementById('contenidoPrincipal');
    const bannerConsent = document.getElementById('bannerConsentimiento');
    const btnAceptarConsent = document.getElementById('btnAceptarConsent');
    const btnRechazarConsent = document.getElementById('btnRechazarConsent');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const btnLoginAjustes = document.getElementById('btnLoginAjustes');
    const indicadorActividad = document.getElementById('indicadorActividad');
    const textoActividad = document.getElementById('textoActividad');
    const btnMenuAdmin = document.getElementById('btnMenuAdmin');
    const itemMenuAdmin = btnMenuAdmin?.closest('li') || null;
    const seccionAdmin = document.getElementById('seccionAdmin');
    const btnDescargarGPX = document.getElementById('btnDescargarGPX');
    const iframeMapa = document.getElementById('iframeMapa');
    const widgetClimaHero = document.getElementById('widgetClimaHero');
    const widgetClimaDetalle = document.getElementById('widgetClimaDetalle');
    const climaContenido = document.getElementById('climaContenido');
    const climaPronostico = document.getElementById('climaPronostico');
    const climaContenidoDetalle = document.getElementById('climaContenidoDetalle');
    const climaPronosticoDetalle = document.getElementById('climaPronosticoDetalle');
    const btnActualizarClima = document.getElementById('btnActualizarClima');
    const btnActualizarClimaDetalle = document.getElementById('btnActualizarClimaDetalle');
    const widgetDestacado = document.getElementById('widgetDestacado');
    const selectMes = document.getElementById('selectMes');
    const selectAnio = document.getElementById('selectAnio');
    const gridCalendario = document.getElementById('gridCalendario');
    const detalleEventos = document.getElementById('detalleEventos');
    const formResena = document.getElementById('formResena');
    const listaResenas = document.getElementById('listaResenas');
    const estadoResenas = document.getElementById('estadoResenas');
    const ratingSelector = document.getElementById('ratingSelector');
    const inputRating = document.getElementById('inputRating');
    const inputFotos = document.getElementById('inputFotos');
    const previewFotos = document.getElementById('previewFotos');
    const ayudaFotos = document.getElementById('ayudaFotos');
    const avisoResenaInvitado = document.getElementById('avisoResenaInvitado');
    const btnLoginResena = document.getElementById('btnLoginResena');
    const textoResenaProtegida = document.getElementById('textoResenaProtegida');
    const ordenResenasGrupo = document.getElementById('ordenResenas');
    const filtroEstrellasGlobal = document.getElementById('filtroEstrellasGlobal');
    const toggleSoloImagenes = document.getElementById('toggleSoloImagenes');
    const resumenResenasGlobal = document.getElementById('resumenResenasGlobal');
    const captchaLogin = document.getElementById('captchaLogin');
    const checkCaptchaLogin = document.getElementById('checkCaptchaLogin');
    const panelFiltrosMap = {
      lugares: document.querySelector('[data-filtros-panel="lugares"]'),
      restaurantes: document.querySelector('[data-filtros-panel="restaurantes"]'),
      ocio: document.querySelector('[data-filtros-panel="ocio"]')
    };
    const panelFiltrosAcciones = document.querySelectorAll('[data-filtro-toggle]');
    const panelFiltrosCerrar = document.querySelectorAll('[data-filtro-close]');
    const gruposFiltroRating = {
      lugares: document.querySelector('[data-filtro-rating="lugares"]'),
      restaurantes: document.querySelector('[data-filtro-rating="restaurantes"]'),
      ocio: document.querySelector('[data-filtro-rating="ocio"]')
    };
    const gruposFiltroOrden = {
      lugares: document.querySelector('[data-filtro-orden="lugares"]'),
      restaurantes: document.querySelector('[data-filtro-orden="restaurantes"]'),
      ocio: document.querySelector('[data-filtro-orden="ocio"]')
    };
    const botonesFiltroCercania = {
      lugares: document.querySelector('[data-filtro-cercania="lugares"]'),
      restaurantes: document.querySelector('[data-filtro-cercania="restaurantes"]'),
      ocio: document.querySelector('[data-filtro-cercania="ocio"]')
    };
    const botonesFiltroCercaniaOff = {
      lugares: document.querySelector('[data-filtro-cercania-off="lugares"]'),
      restaurantes: document.querySelector('[data-filtro-cercania-off="restaurantes"]'),
      ocio: document.querySelector('[data-filtro-cercania-off="ocio"]')
    };
    const estadoCercania = {
      lugares: document.querySelector('[data-estado-cercania="lugares"]'),
      restaurantes: document.querySelector('[data-estado-cercania="restaurantes"]'),
      ocio: document.querySelector('[data-estado-cercania="ocio"]')
    };
    const btnAutoCoordenadas = document.getElementById('btnAutoCoordenadas');
    const inputDireccion = document.getElementById('inputDireccion');
    const inputLatitud = document.getElementById('inputLatitud');
    const inputLongitud = document.getElementById('inputLongitud');
    const inputGaleria = document.getElementById('inputGaleria');
    const inputArchivosGaleria = document.getElementById('inputArchivosGaleria');
    const modalLogin = document.getElementById('modalLogin');
    const formLogin = document.getElementById('formLogin');
    const indicadorLoginEmail = document.getElementById('indicadorLoginEmail');
    const indicadorLoginPassword = document.getElementById('indicadorLoginPassword');
    const errorLoginEmail = document.getElementById('errorLoginEmail');
    const errorLoginPassword = document.getElementById('errorLoginPassword');
    const alertaCuentaInexistente = document.getElementById('alertaCuentaInexistente');
    const btnSubmitLogin = document.getElementById('btnSubmitLogin');
    const btnOlvidoPassword = document.getElementById('btnOlvidoPassword');
    const btnIrRegistroDesdeLogin = document.getElementById('btnIrRegistroDesdeLogin');
    const btnAbrirRegistroDesdeLogin = document.getElementById('btnAbrirRegistroDesdeLogin');
    const modalRegistro = document.getElementById('modalRegistro');
    const btnCerrarModalRegistro = document.getElementById('btnCerrarModalRegistro');
    const formRegistro = document.getElementById('formRegistro');
    const btnSubmitRegistro = document.getElementById('btnSubmitRegistro');
    const inputRegistroEmail = document.getElementById('inputRegistroEmail');
    const inputRegistroPassword = document.getElementById('inputRegistroPassword');
    const inputRegistroPasswordConfirm = document.getElementById('inputRegistroPasswordConfirm');
    const indicadorRegistroEmail = document.getElementById('indicadorRegistroEmail');
    const errorRegistroEmail = document.getElementById('errorRegistroEmail');
    const errorRegistroPassword = document.getElementById('errorRegistroPassword');
    const errorRegistroConfirm = document.getElementById('errorRegistroConfirm');
    const errorRegistroTerminos = document.getElementById('errorRegistroTerminos');
    const mensajeRegistroExito = document.getElementById('mensajeRegistroExito');
    const checkTerminos = document.getElementById('checkTerminos');
    const barraFuerzaRegistro = document.getElementById('barraFuerzaRegistro');
    const inputRegistroDisplayName = document.getElementById('inputRegistroDisplayName');
    const modalRecuperacion = document.getElementById('modalRecuperacion');
    const btnCerrarModalRecuperacion = document.getElementById('btnCerrarModalRecuperacion');
    const formRecuperacion = document.getElementById('formRecuperacion');
    const inputRecuperacionEmail = document.getElementById('inputRecuperacionEmail');
    const errorRecuperacion = document.getElementById('errorRecuperacion');
    const exitoRecuperacion = document.getElementById('exitoRecuperacion');
    const btnEnviarRecuperacion = document.getElementById('btnEnviarRecuperacion');
    const modalCambioEmail = document.getElementById('modalCambioEmail');
    const modalCambioPassword = document.getElementById('modalCambioPassword');
    const btnCerrarModalCambioEmail = document.getElementById('btnCerrarModalCambioEmail');
    const btnCerrarModalCambioPassword = document.getElementById('btnCerrarModalCambioPassword');
    const formCambioEmail = document.getElementById('formCambioEmail');
    const inputNuevoEmail = document.getElementById('inputNuevoEmail');
    const indicadorNuevoEmail = document.getElementById('indicadorNuevoEmail');
    const inputPasswordEmail = document.getElementById('inputPasswordEmail');
    const errorCambioEmail = document.getElementById('errorCambioEmail');
    const btnSubmitCambioEmail = document.getElementById('btnSubmitCambioEmail');
    const modalCerrarSesiones = document.getElementById('modalCerrarSesiones');
    const btnCerrarModalCerrarSesiones = document.getElementById('btnCerrarModalCerrarSesiones');
    const btnConfirmarCerrarSesiones = document.getElementById('btnConfirmarCerrarSesiones');
    const btnCancelarCerrarSesiones = document.getElementById('btnCancelarCerrarSesiones');
    const modalEliminarCuenta = document.getElementById('modalEliminarCuenta');
    const btnCerrarModalEliminar = document.getElementById('btnCerrarModalEliminar');
    const btnContinuarEliminar = document.getElementById('btnContinuarEliminar');
    const btnCancelarEliminarCuenta = document.getElementById('btnCancelarEliminarCuenta');
    const btnVolverPasoEliminar = document.getElementById('btnVolverPasoEliminar');
    const formEliminarCuenta = document.getElementById('formEliminarCuenta');
    const btnConfirmarEliminarCuenta = document.getElementById('btnConfirmarEliminarCuenta');
    const inputPasswordEliminar = document.getElementById('inputPasswordEliminar');
    const inputConfirmacionEliminar = document.getElementById('inputConfirmacionEliminar');
    const errorPasswordEliminar = document.getElementById('errorPasswordEliminar');
    const errorConfirmacionEliminar = document.getElementById('errorConfirmacionEliminar');
    const errorEliminarCuenta = document.getElementById('errorEliminarCuenta');
    const modalInactividad = document.getElementById('modalInactividad');
    const btnMantenerSesion = document.getElementById('btnMantenerSesion');
    const btnCerrarModalInactividad = document.getElementById('btnCerrarModalInactividad');
    const tiempoRestanteInactividad = document.getElementById('tiempoRestanteInactividad');
    const textoEmailActual = document.getElementById('textoEmailActual');
    const btnAbrirCambioEmail = document.getElementById('btnAbrirCambioEmail');
    const btnAbrirCambioPassword = document.getElementById('btnAbrirCambioPassword');
    const inputPasswordActual = document.getElementById('inputPasswordActual');
    const inputNuevaPassword = document.getElementById('inputNuevaPassword');
    const inputConfirmarPassword = document.getElementById('inputConfirmarPassword');
    const barraFuerzaPassword = document.getElementById('barraFuerzaPassword');
    const errorPasswordActual = document.getElementById('errorPasswordActual');
    const errorNuevaPassword = document.getElementById('errorNuevaPassword');
    const errorConfirmarPassword = document.getElementById('errorConfirmarPassword');

    const eliminarDatosAsociados = async (uid) => {
      if (!uid || !firebaseDisponible || !db) return;
      const eliminarResenas = async (campo) => {
        try {
          const consulta = query(collection(db, 'resenas'), where(campo, '==', uid), limit(20));
          let snapshot = await getDocs(consulta);
          while (!snapshot.empty) {
            await Promise.all(snapshot.docs.map((docSnap) => deleteDoc(doc(db, 'resenas', docSnap.id))));
            snapshot = await getDocs(consulta);
          }
        } catch (error) {
          logError(error, `eliminar-resenas-${campo}`);
        }
      };
      await eliminarResenas('usuarioId');
      await eliminarResenas('usuario');
      try {
        await deleteDoc(doc(db, 'usuarios', uid));
      } catch (error) {
        console.warn('usuarios-delete', error);
      }
    };

    const eliminarCuentaSegura = async (password) => {
      if (!auth?.currentUser) {
        const error = new Error('Sin sesión activa');
        error.code = 'auth/no-current-user';
        throw error;
      }
      const correoActual = auth.currentUser.email;
      if (!correoActual) {
        const error = new Error('Cuenta sin email');
        error.code = 'auth/no-email';
        throw error;
      }
      const credencial = EmailAuthProvider.credential(correoActual, password);
      await reauthenticateWithCredential(auth.currentUser, credencial);
      await eliminarDatosAsociados(auth.currentUser.uid);
      await deleteUser(auth.currentUser);
    };

    async function crearDocumentoUsuario(user, datosExtra = {}) {
      if (!user?.uid || !firebaseDisponible || !db) return null;
      const nombrePreferido = typeof datosExtra.nombre === 'string' && datosExtra.nombre.trim()
        ? datosExtra.nombre.trim()
        : (user.displayName || '').trim();
      const payload = {
        email: (datosExtra.email || user.email || '').toLowerCase(),
        role: datosExtra.role === USER_ROLES.ADMIN ? USER_ROLES.ADMIN : USER_ROLES.USER,
        nombre: nombrePreferido || undefined,
        fotoPerfil: datosExtra.fotoPerfil || user.photoURL || undefined,
        fechaRegistro: datosExtra.fechaRegistro || serverTimestamp(),
        resenasCount: typeof datosExtra.resenasCount === 'number' ? datosExtra.resenasCount : 0
      };
      if (!payload.nombre) delete payload.nombre;
      if (!payload.fotoPerfil) delete payload.fotoPerfil;
      try {
        await setDoc(doc(db, 'usuarios', user.uid), payload, { merge: true });
        return payload;
      } catch (error) {
        logError(error, 'usuarios-create');
        throw error;
      }
    }

    async function obtenerDocumentoUsuario(uid) {
      if (!uid || !firebaseDisponible || !db) return null;
      try {
        const snap = await getDoc(doc(db, 'usuarios', uid));
        return snap.exists() ? { id: snap.id, ...snap.data() } : null;
      } catch (error) {
        logError(error, 'usuarios-get');
        return null;
      }
    }

    async function asegurarDocumentoUsuario(user, datosExtra = {}) {
      if (!user?.uid || !firebaseDisponible || !db) return null;
      const existente = await obtenerDocumentoUsuario(user.uid);
      if (existente) return existente;
      try {
        await crearDocumentoUsuario(user, datosExtra);
        return await obtenerDocumentoUsuario(user.uid);
      } catch (error) {
        logError(error, 'usuarios-asegurar');
        return null;
      }
    }

    const authFunctions = {
      login: async (email, password) => {
        if (!firebaseDisponible || !auth) throw new Error('auth/unavailable');
        return signInWithEmailAndPassword(auth, email, password);
      },
      register: async (email, password, displayName) => {
        if (!firebaseDisponible || !auth) throw new Error('auth/unavailable');
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const nombreSeguro = (displayName || '').slice(0, 60).trim();
        if (nombreSeguro) {
          await updateProfile(cred.user, { displayName: nombreSeguro });
        }
        try {
          await crearDocumentoUsuario(cred.user, {
            nombre: nombreSeguro,
            email: cred.user.email || email,
            role: USER_ROLES.USER
          });
        } catch (error) {
          console.warn('No se pudo crear el documento de usuario en Firestore.', error);
        }
        await sendEmailVerification(cred.user, emailActionSettings);
        return cred.user;
      },
      resetPassword: async (email) => {
        if (!firebaseDisponible || !auth) throw new Error('auth/unavailable');
        await sendPasswordResetEmail(auth, email);
      },
      verifyEmail: async () => {
        if (!auth?.currentUser) {
          const error = new Error('Sin sesión activa');
          error.code = 'auth/no-current-user';
          throw error;
        }
        await sendEmailVerification(auth.currentUser, emailActionSettings);
      },
      changePassword: async (currentPassword, newPassword) => {
        if (!auth?.currentUser) {
          const error = new Error('Sin sesión activa');
          error.code = 'auth/no-current-user';
          throw error;
        }
        const correoActual = auth.currentUser.email;
        if (!correoActual) {
          const error = new Error('Cuenta sin email');
          error.code = 'auth/no-email';
          throw error;
        }
        const credencial = EmailAuthProvider.credential(correoActual, currentPassword);
        await reauthenticateWithCredential(auth.currentUser, credencial);
        await updatePassword(auth.currentUser, newPassword);
      },
      changeEmail: async (newEmail, password) => {
        if (!auth?.currentUser) {
          const error = new Error('Sin sesión activa');
          error.code = 'auth/no-current-user';
          throw error;
        }
        const correoActual = auth.currentUser.email;
        if (!correoActual) {
          const error = new Error('Cuenta sin email');
          error.code = 'auth/no-email';
          throw error;
        }
        const credencial = EmailAuthProvider.credential(correoActual, password);
        await reauthenticateWithCredential(auth.currentUser, credencial);
        await updateEmail(auth.currentUser, newEmail);
      },
      deleteAccount: async (password) => eliminarCuentaSegura(password)
    };

    const state = {
      user: null,
      claims: { role: USER_ROLES.VISITANTE },
      usuarioPerfil: null,
      paginadores: {
        lugares: { tag: 'todos', pagina: 0, ultimo: null, hayMas: true, historial: [null] },
        restaurantes: { tag: 'todos', pagina: 0, ultimo: null, hayMas: true, historial: [null] },
        ocio: { tag: 'todos', pagina: 0, ultimo: null, hayMas: true, historial: [null] },
        resenas: { pagina: 0, ultimo: null, hayMas: true, historial: [null] }
      },
      resenas: [],
      filtrosResenas: { orden: 'recomendadas', estrellas: 0, soloImagenes: false },
      detalleResenas: new Map(),
      imagenesResena: [],
      consentimiento: localStorage.getItem('smv-consentimiento'),
      climaCache: JSON.parse(localStorage.getItem('smv-clima-cache') || 'null'),
      climaTimeout: null,
      eventos: [],
      items: new Map(),
      valoraciones: new Map(),
      resenasPorItem: new Map(),
      gpxUrl: null,
      filtrosExploracion: {
        lugares: { rating: 0, orden: 'nombre', cercania: false },
        restaurantes: { rating: 0, orden: 'nombre', cercania: false },
        ocio: { rating: 0, orden: 'nombre', cercania: false }
      },
      colecciones: { lugares: [], restaurantes: [], ocio: [] },
      ubicacionUsuario: null,
      distancias: new Map(),
      navegacionPreferencias: new Map(),
      tarjetaAbierta: null,
      historia: [],
      destacado: { lista: [], indice: 0, animFrame: null, inicio: 0, barra: null },
      panelFiltrosActivo: null,
      baneados: new Set(JSON.parse(localStorage.getItem('smv-baneados') || '[]')),
      ip: null,
      configuracion: {},
      firebaseDisponible,
      baneado: false
    };

    const normalizarRolUsuario = (rol) => {
      if (rol === USER_ROLES.ADMIN) return USER_ROLES.ADMIN;
      if (rol === USER_ROLES.USER) return USER_ROLES.USER;
      if (rol === USER_ROLES.INVITADO) return USER_ROLES.INVITADO;
      return USER_ROLES.VISITANTE;
    };

    const setUserRole = (rol = USER_ROLES.VISITANTE, perfil = null) => {
      state.claims = { role: normalizarRolUsuario(rol) };
      state.usuarioPerfil = perfil || null;
      if (document?.body) {
        document.body.dataset.rolUsuario = state.claims.role;
      }
    };

    const obtenerRolDesdePerfil = (perfil) => (perfil?.role === USER_ROLES.ADMIN ? USER_ROLES.ADMIN : USER_ROLES.USER);

    async function sincronizarUsuarioDesdeFirestore(user, { crearSiNoExiste = false } = {}) {
      if (!user) {
        setUserRole(USER_ROLES.VISITANTE, null);
        return { role: USER_ROLES.VISITANTE, perfil: null };
      }
      if (!firebaseDisponible || !db) {
        setUserRole(USER_ROLES.USER, null);
        return { role: USER_ROLES.USER, perfil: null };
      }
      let perfil = await obtenerDocumentoUsuario(user.uid);
      if (!perfil && crearSiNoExiste) {
        perfil = await asegurarDocumentoUsuario(user, { nombre: user.displayName || '' });
      }
      if (!perfil) {
        setUserRole(USER_ROLES.USER, null);
        return { role: USER_ROLES.USER, perfil: null };
      }
      const rol = obtenerRolDesdePerfil(perfil);
      setUserRole(rol, perfil);
      return { role: rol, perfil };
    }

    async function isUserAdmin() {
      if (!auth?.currentUser || !firebaseDisponible || !db) return false;
      const perfil = await asegurarDocumentoUsuario(auth.currentUser, { nombre: auth.currentUser.displayName || '' });
      if (!perfil) return false;
      return obtenerRolDesdePerfil(perfil) === USER_ROLES.ADMIN;
    }

    setUserRole(state.claims.role);

    const ALIAS_SUGERIDOS = [
      'Viajero Aventurero',
      'Exploradora Jarama',
      'Ruta Nocturna',
      'Senderista Vega',
      'Caminante del Río',
      'Cazador de Atardeceres',
      'Curiosa Cultural',
      'Rastreador Serrano',
      'Buscadora de Sabores',
      'Turista Discreto'
    ];

    const generarAliasPublico = (semilla = '') => {
      const base = ALIAS_SUGERIDOS.length ? ALIAS_SUGERIDOS : ['Visitante'];
      const fuente = (semilla || `${Date.now()}-${Math.random()}`).toString();
      let hash = 0;
      for (let i = 0; i < fuente.length; i += 1) {
        hash = (hash << 5) - hash + fuente.charCodeAt(i);
        hash |= 0;
      }
      const indice = Math.abs(hash) % base.length;
      const sufijo = Math.abs(hash % 1000).toString().padStart(3, '0');
      return `${base[indice]} ${sufijo}`;
    };

    const puedeUsarPanelAdmin = () =>
      Boolean(
        auth?.currentUser &&
          state.claims.role === USER_ROLES.ADMIN &&
          state.user?.emailVerificado
      );

    const DESTACADO_CONFIG = { duracion: 10000 };
    const RADIO_CERCANIA_KM = 15;
    const INACTIVIDAD_MAX_MS = 30 * 60 * 1000;
    const ADVERTENCIA_INACTIVIDAD_MS = 2 * 60 * 1000;
    let ultimaActividad = Date.now();
    let advertenciaTimeout = null;
    let cierreTimeout = null;
    let cuentaRegresivaInterval = null;
    let finCuentaRegresiva = null;
    let monitoreoInactividadActivo = false;

    const actualizarIndicadorActividad = () => {
      if (!indicadorActividad) return;
      if (!monitoreoInactividadActivo || !state.user) {
        indicadorActividad.hidden = true;
        return;
      }
      const diferencia = Date.now() - ultimaActividad;
      const minutos = Math.floor(diferencia / 60000);
      let texto = 'hace menos de 1 minuto';
      if (minutos === 1) texto = 'hace 1 minuto';
      else if (minutos > 1) texto = `hace ${minutos} minutos`;
      if (textoActividad) {
        textoActividad.textContent = `Última actividad: ${texto}`;
      } else {
        indicadorActividad.textContent = `⏳ Última actividad: ${texto}`;
      }
      indicadorActividad.hidden = false;
    };

    if (indicadorActividad) {
      setInterval(() => {
        if (monitoreoInactividadActivo) {
          actualizarIndicadorActividad();
        }
      }, 60000);
    }

    const limpiarTimersInactividad = () => {
      clearTimeout(advertenciaTimeout);
      clearTimeout(cierreTimeout);
      clearInterval(cuentaRegresivaInterval);
      advertenciaTimeout = null;
      cierreTimeout = null;
      cuentaRegresivaInterval = null;
      finCuentaRegresiva = null;
    };

    const actualizarCuentaRegresiva = () => {
      if (!tiempoRestanteInactividad || !finCuentaRegresiva) return;
      const restante = Math.max(0, finCuentaRegresiva - Date.now());
      const segundos = Math.ceil(restante / 1000);
      tiempoRestanteInactividad.textContent =
        segundos >= 60 ? `${Math.ceil(segundos / 60)} minutos` : `${segundos} segundos`;
    };

    const cerrarModalInactividad = () => {
      if (modalInactividad) {
        cerrarModalGenerico(modalInactividad);
      }
    };

    const cerrarSesionPorInactividad = () => {
      cerrarModalInactividad();
      if (auth) {
        signOut(auth).catch((error) => logError(error, 'logout-inactividad'));
      }
      mostrarToast('Tu sesión se cerró por inactividad.');
    };

    const mostrarAdvertenciaInactividad = () => {
      if (!state.user) return;
      finCuentaRegresiva = Date.now() + ADVERTENCIA_INACTIVIDAD_MS;
      actualizarCuentaRegresiva();
      if (modalInactividad) {
        abrirModalGenerico(modalInactividad, '#btnMantenerSesion');
      }
      cuentaRegresivaInterval = setInterval(actualizarCuentaRegresiva, 1000);
      cierreTimeout = setTimeout(cerrarSesionPorInactividad, ADVERTENCIA_INACTIVIDAD_MS);
    };

    const programarInactividad = () => {
      limpiarTimersInactividad();
      if (!monitoreoInactividadActivo) return;
      const restante = Math.max(0, INACTIVIDAD_MAX_MS - (Date.now() - ultimaActividad));
      advertenciaTimeout = setTimeout(mostrarAdvertenciaInactividad, restante);
    };

    const registrarActividad = (forzada = false) => {
      if (!monitoreoInactividadActivo && !forzada) return;
      ultimaActividad = Date.now();
      actualizarIndicadorActividad();
      cerrarModalInactividad();
      programarInactividad();
    };

    const iniciarMonitoreoInactividad = () => {
      monitoreoInactividadActivo = true;
      ultimaActividad = Date.now();
      actualizarIndicadorActividad();
      programarInactividad();
    };

    const detenerMonitoreoInactividad = () => {
      monitoreoInactividadActivo = false;
      limpiarTimersInactividad();
      cerrarModalInactividad();
      if (indicadorActividad) indicadorActividad.hidden = true;
    };

    const modalesRegistrados = new Map();
    function registrarModalAccesible(modal, cerrarFn) {
      if (!modal || typeof cerrarFn !== 'function') return;
      modalesRegistrados.set(modal, cerrarFn);
    }

    const abrirModalGenerico = (modal, focusSelector = null) => {
      if (!modal) return;
      modal.classList.add('visible');
      modal.setAttribute('aria-hidden', 'false');
      const focusable =
        (focusSelector && modal.querySelector(focusSelector)) ||
        modal.querySelector('[data-focus-inicial]') ||
        modal.querySelector(
          'input, button, select, textarea, [tabindex]:not([tabindex="-1"])'
        );
      if (focusable) focusable.focus();
    };

    const cerrarModalGenerico = (modal) => {
      if (!modal) return;
      modal.classList.remove('visible');
      modal.setAttribute('aria-hidden', 'true');
    };

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      const visibles = [...modalesRegistrados.entries()].filter(
        ([modal]) => modal.classList.contains('visible') && modal.dataset.escape !== 'false'
      );
      if (!visibles.length) return;
      event.preventDefault();
      const [, cerrarFn] = visibles[visibles.length - 1];
      cerrarFn();
    });

    if (btnMantenerSesion) {
      btnMantenerSesion.addEventListener('click', () => registrarActividad(true));
    }
    if (btnCerrarModalInactividad) {
      btnCerrarModalInactividad.addEventListener('click', () => registrarActividad(true));
    }
    if (modalInactividad) {
      modalInactividad.addEventListener('click', (event) => {
        if (event.target === modalInactividad) {
          registrarActividad(true);
        }
      });
      registrarModalAccesible(modalInactividad, () => registrarActividad(true));
    }

    const registrarEventosActividadGlobal = () => {
      const eventos = ['pointerdown', 'keydown', 'touchstart'];
      eventos.forEach((nombre) => {
        document.addEventListener(nombre, () => registrarActividad(), { passive: true });
      });
      let ultimoScroll = 0;
      document.addEventListener(
        'scroll',
        () => {
          const ahora = Date.now();
          if (ahora - ultimoScroll > 10000) {
            ultimoScroll = ahora;
            registrarActividad();
          }
        },
        { passive: true }
      );
      window.addEventListener('focus', () => registrarActividad());
      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) registrarActividad();
      });
    };

    registrarEventosActividadGlobal();


    const actualizarSelectorRating = (valor) => {
      if (!ratingSelector) return;
      const activo = Number(valor) || 0;
      ratingSelector.querySelectorAll('button').forEach((btn) => {
        const v = Number(btn.dataset.valor);
        btn.classList.toggle('activo', v <= activo);
      });
    };

    if (ratingSelector && inputRating) {
      actualizarSelectorRating(Number(inputRating.value));
      ratingSelector.querySelectorAll('button').forEach((btn) => {
        const valor = Number(btn.dataset.valor);
        btn.addEventListener('mouseenter', () => actualizarSelectorRating(valor));
        btn.addEventListener('focus', () => actualizarSelectorRating(valor));
        btn.addEventListener('mouseleave', () => actualizarSelectorRating(Number(inputRating.value)));
        btn.addEventListener('blur', () => actualizarSelectorRating(Number(inputRating.value)));
        btn.addEventListener('click', () => {
          inputRating.value = String(valor);
          actualizarSelectorRating(valor);
        });
      });
    }

    if (inputFotos && previewFotos) {
      inputFotos.addEventListener('change', async () => {
        ayudaFotos.hidden = true;
        previewFotos.textContent = '';
        state.imagenesResena = [];
        const archivos = Array.from(inputFotos.files || []).filter((file) => file.type.startsWith('image/')).slice(0, 3);
        if (!archivos.length) return;
        try {
          const procesadas = [];
          for (const archivo of archivos) {
            const dataUrl = await leerArchivoComoDataURL(archivo);
            const segura = await esImagenSegura(dataUrl);
            if (!segura) {
              throw new Error('imagen-no-segura');
            }
            procesadas.push({ file: archivo, dataUrl });
          }
          procesadas.forEach(({ dataUrl }, index) => {
            const img = document.createElement('img');
            img.src = dataUrl;
            img.alt = `Vista previa ${index + 1}`;
            img.loading = 'lazy';
            previewFotos.appendChild(img);
          });
          state.imagenesResena = procesadas;
        } catch (error) {
          console.warn('resena-imagen', error);
          ayudaFotos.hidden = false;
          previewFotos.textContent = '';
          inputFotos.value = '';
          state.imagenesResena = [];
          mostrarToast('Alguna imagen incumple las normas de contenido.');
        }
      });
    }

    const renderResenasFiltradas = () => {
      renderResenas(state.resenas || [], state.paginadores.resenas?.pagina || 0);
    };

    const actualizarOrdenResenasGlobal = () => {
      if (!ordenResenasGrupo) return;
      const actual = state.filtrosResenas.orden;
      ordenResenasGrupo.querySelectorAll('button').forEach((btn) => {
        btn.classList.toggle('activo', btn.dataset.orden === actual);
      });
    };

    if (ordenResenasGrupo) {
      ordenResenasGrupo.addEventListener('click', (event) => {
        const btn = event.target.closest('button[data-orden]');
        if (!btn) return;
        const valor = btn.dataset.orden;
        state.filtrosResenas.orden = valor;
        if (valor === 'imagenes') {
          state.filtrosResenas.soloImagenes = true;
          if (toggleSoloImagenes) toggleSoloImagenes.checked = true;
        } else if (!toggleSoloImagenes || !toggleSoloImagenes.checked) {
          state.filtrosResenas.soloImagenes = false;
        }
        actualizarOrdenResenasGlobal();
        renderResenasFiltradas();
      });
      actualizarOrdenResenasGlobal();
    }

    if (toggleSoloImagenes) {
      toggleSoloImagenes.addEventListener('change', (event) => {
        state.filtrosResenas.soloImagenes = event.target.checked;
        if (!event.target.checked && state.filtrosResenas.orden === 'imagenes') {
          state.filtrosResenas.orden = 'recomendadas';
          actualizarOrdenResenasGlobal();
        }
        renderResenasFiltradas();
      });
    }

    if (filtroEstrellasGlobal) {
      actualizarEstrellasVisual(filtroEstrellasGlobal, state.filtrosResenas.estrellas || 0);
      filtroEstrellasGlobal.addEventListener('mouseleave', () => {
        actualizarEstrellasVisual(filtroEstrellasGlobal, state.filtrosResenas.estrellas || 0);
      });
      filtroEstrellasGlobal.querySelectorAll('button').forEach((btn) => {
        const valor = Number(btn.dataset.valor);
        btn.addEventListener('mouseenter', () => actualizarEstrellasVisual(filtroEstrellasGlobal, state.filtrosResenas.estrellas || 0, valor));
        btn.addEventListener('focus', () => actualizarEstrellasVisual(filtroEstrellasGlobal, state.filtrosResenas.estrellas || 0, valor));
        btn.addEventListener('mouseleave', () => actualizarEstrellasVisual(filtroEstrellasGlobal, state.filtrosResenas.estrellas || 0));
        btn.addEventListener('blur', () => actualizarEstrellasVisual(filtroEstrellasGlobal, state.filtrosResenas.estrellas || 0));
        btn.addEventListener('click', () => {
          state.filtrosResenas.estrellas = state.filtrosResenas.estrellas === valor ? 0 : valor;
          renderResenasFiltradas();
        });
      });
    }
    const modalAdmin = document.getElementById('modalAdmin');
    const btnAbrirModalAdmin = document.getElementById('btnAbrirModalAdmin');
    const btnCerrarModalAdmin = document.getElementById('btnCerrarModalAdmin');
    const tituloModalAdmin = document.getElementById('tituloModalAdmin');
    const btnInicializarSemilla = document.getElementById('btnInicializarSemilla');
    const formAdmin = document.getElementById('formAdmin');
    const listaAdmin = document.getElementById('listaAdmin');
    const logSemilla = document.getElementById('logSemilla');
    const modalBienvenida = document.getElementById('modalBienvenida');
    const btnCerrarModalBienvenida = document.getElementById('btnCerrarModalBienvenida');
    const btnLoginCorreo = document.getElementById('btnLoginCorreo');
    const btnLoginGoogle = document.getElementById('btnLoginGoogle');
    const btnLoginFacebook = document.getElementById('btnLoginFacebook');
    const btnInvitado = document.getElementById('btnInvitado');
    const initContraste = document.getElementById('initContraste');
    const initTexto = document.getElementById('initTexto');
    const initEspaciado = document.getElementById('initEspaciado');
    const initLinks = document.getElementById('initLinks');
    const panelCuenta = document.getElementById('panelCuenta');
    const avisoCuentaInvitado = document.getElementById('avisoCuentaInvitado');
    const formPerfil = document.getElementById('formPerfil');
    const formPassword = document.getElementById('formPassword');
    const btnActualizarPassword = formPassword ? formPassword.querySelector('button[type="submit"]') : null;
    const btnVerificarCorreo = document.getElementById('btnVerificarCorreo');
    const btnCerrarSesiones = document.getElementById('btnCerrarSesiones');
    const btnEliminarCuenta = document.getElementById('btnEliminarCuenta');
    const estadoCuenta = document.getElementById('estadoCuenta');
    const toggleModoOscuro = document.getElementById('toggleModoOscuro');
    const toggleModoSenior = document.getElementById('toggleModoSenior');
    const toggleBotones = document.getElementById('toggleBotones');
    const toggleFuente = document.getElementById('toggleFuente');
    const toggleReducir = document.getElementById('toggleReducir');
    const toggleContraste = document.getElementById('toggleContraste');
    const toggleTexto = document.getElementById('toggleTexto');
    const toggleEspaciado = document.getElementById('toggleEspaciado');
    const toggleLinks = document.getElementById('toggleLinks');
    const toggleLecturaFacil = document.getElementById('toggleLecturaFacil');
    const toggleVisibilidad = document.getElementById('toggleVisibilidad');
    const formBan = document.getElementById('formBan');
    const listaBaneados = document.getElementById('listaBaneados');
    const inputBanIp = document.getElementById('inputBanIp');
    const modalBaneado = document.getElementById('modalBaneado');
    const inputAnioHistoria = document.getElementById('inputAnioHistoria');
    const gruposAdminHistoria = document.querySelectorAll('[data-admin-historia]');
    const gruposAdminUbicacion = document.querySelectorAll('[data-admin-ubicacion]');

    const modalesSoloBoton = [
      modalBienvenida,
      modalLogin,
      modalRegistro,
      modalRecuperacion,
      modalCambioEmail,
      modalCambioPassword,
      modalCerrarSesiones,
      modalEliminarCuenta,
      modalAdmin,
      modalBaneado
    ].filter(Boolean);
    modalesSoloBoton.forEach((modal) => {
      modal.dataset.escape = 'false';
    });

    const aliasEjemplo = generarAliasPublico(Math.random().toString());
    if (inputRegistroDisplayName) inputRegistroDisplayName.placeholder = aliasEjemplo;
    if (formPerfil?.displayName) {
      formPerfil.displayName.placeholder = aliasEjemplo;
      formPerfil.displayName.disabled = true;
    }

    if (menu) menu.setAttribute('aria-hidden', 'true');
    if (overlayMenu) overlayMenu.setAttribute('aria-hidden', 'true');

    const chipsPorSeccion = {
      lugares: document.getElementById('chipsLugares'),
      restaurantes: document.getElementById('chipsRestaurantes'),
      ocio: document.getElementById('chipsOcio')
    };

    const listasPorSeccion = {
      lugares: document.getElementById('listaLugares'),
      restaurantes: document.getElementById('listaRestaurantes'),
      ocio: document.getElementById('listaOcio')
    };

    const TAGS_PREDEFINIDOS = {
      lugares: ['naturaleza', 'cultural', 'familia'],
      restaurantes: ['tradicional', 'tapas', 'asador', 'terraza', 'veg-friendly', 'sin-gluten', 'km0'],
      ocio: ['aventura', 'agua']
    };

    const estadoPorSeccion = {
      lugares: document.getElementById('estadoLugares'),
      restaurantes: document.getElementById('estadoRestaurantes'),
      ocio: document.getElementById('estadoOcio'),
      resenas: estadoResenas
    };

    const obtenerFiltrosColeccion = (coleccion) => {
      if (!state.filtrosExploracion[coleccion]) {
        state.filtrosExploracion[coleccion] = { rating: 0, orden: 'nombre', cercania: false };
      }
      return state.filtrosExploracion[coleccion];
    };

    const actualizarEstadoCercaniaUI = () => {
      Object.entries(estadoCercania).forEach(([coleccion, nodo]) => {
        if (!nodo) return;
        const filtros = obtenerFiltrosColeccion(coleccion);
        if (!state.ubicacionUsuario) {
          nodo.textContent = 'Ubicación no solicitada.';
        } else if (filtros.cercania) {
          nodo.textContent = `Mostrando resultados a menos de ${RADIO_CERCANIA_KM} km.`;
        } else {
          nodo.textContent = 'Ubicación guardada. Activa la cercanía para priorizar resultados próximos.';
        }
      });
      Object.entries(botonesFiltroCercania).forEach(([coleccion, boton]) => {
        if (!boton) return;
        const filtros = obtenerFiltrosColeccion(coleccion);
        boton.classList.toggle('activo', Boolean(filtros.cercania));
      });
    };

    const aplicarFiltrosColeccion = (coleccion, docs) => {
      const lista = Array.isArray(docs) ? docs : [];
      const filtros = obtenerFiltrosColeccion(coleccion);
      const conMetadatos = lista.map((item) => {
        const valoracion = state.valoraciones.get(item.id)?.promedio || 0;
        const distancia = obtenerDistanciaAUsuario(item);
        return { item, valoracion, distancia };
      });
      const filtrados = conMetadatos.filter(({ valoracion, distancia }) => {
        if (filtros.rating && valoracion + 1e-6 < filtros.rating) return false;
        if (filtros.cercania && state.ubicacionUsuario) {
          if (distancia == null || distancia > RADIO_CERCANIA_KM) return false;
        }
        return true;
      });
      const compararNombre = (a, b) => a.item.nombre.localeCompare(b.item.nombre);
      const compararValoracion = (a, b) => b.valoracion - a.valoracion || compararNombre(a, b);
      const compararDistancia = (a, b) => {
        if (a.distancia == null && b.distancia == null) return compararValoracion(a, b);
        if (a.distancia == null) return 1;
        if (b.distancia == null) return -1;
        return a.distancia - b.distancia || compararValoracion(a, b);
      };
      switch (filtros.orden) {
        case 'valoracion':
          filtrados.sort(compararValoracion);
          break;
        case 'cercania':
          filtrados.sort(compararDistancia);
          break;
        case 'nombre':
        default:
          filtrados.sort(compararNombre);
          break;
      }
      return filtrados.map(({ item }) => item);
    };

    const actualizarColeccionView = (coleccion) => {
      const contenedor = listasPorSeccion[coleccion];
      if (!contenedor) return;
      contenedor.textContent = '';
      const docs = Array.isArray(state.colecciones[coleccion]) ? [...state.colecciones[coleccion]] : [];
      docs.forEach((docItem) => {
        state.items.set(docItem.id, { ...docItem, coleccion });
      });
      const filtrados = aplicarFiltrosColeccion(coleccion, docs);
      if (!filtrados.length) {
        const vacio = document.createElement('p');
        vacio.className = 'lista-vacia';
        vacio.textContent = 'No hay resultados para este filtro.';
        contenedor.appendChild(vacio);
      } else {
        filtrados.forEach((docItem) => {
          contenedor.appendChild(crearTarjeta(docItem, coleccion));
        });
      }
      const estado = estadoPorSeccion[coleccion];
      if (estado) {
        const paginaActual = state.paginadores[coleccion]?.pagina ?? 0;
        estado.textContent = `Página ${paginaActual + 1} · ${filtrados.length} resultado${filtrados.length === 1 ? '' : 's'}`;
      }
    };

    const togglePanelFiltros = (coleccion, abrir = false) => {
      const panel = panelFiltrosMap[coleccion];
      if (!panel) return;
      if (window.matchMedia('(min-width: 900px)').matches) {
        panel.dataset.abierto = 'true';
        document.body.classList.remove('panel-filtros-abierto');
        return;
      }
      if (abrir) {
        panel.dataset.abierto = 'true';
        document.body.classList.add('panel-filtros-abierto');
        state.panelFiltrosActivo = coleccion;
      } else {
        panel.dataset.abierto = 'false';
        document.body.classList.remove('panel-filtros-abierto');
        if (state.panelFiltrosActivo === coleccion) {
          state.panelFiltrosActivo = null;
        }
      }
    };

    panelFiltrosAcciones.forEach((boton) => {
      boton.addEventListener('click', () => {
        const coleccion = boton.dataset.filtroToggle;
        if (!coleccion) return;
        const panel = panelFiltrosMap[coleccion];
        const abierto = panel?.dataset.abierto === 'true';
        togglePanelFiltros(coleccion, !abierto);
      });
    });

    panelFiltrosCerrar.forEach((boton) => {
      boton.addEventListener('click', () => {
        const coleccion = boton.dataset.filtroClose;
        if (!coleccion) return;
        togglePanelFiltros(coleccion, false);
      });
    });

    Object.entries(gruposFiltroRating).forEach(([coleccion, grupo]) => {
      if (!grupo) return;
      grupo.addEventListener('click', (event) => {
        const boton = event.target.closest('button[data-valor]');
        if (!boton) return;
        const filtros = obtenerFiltrosColeccion(coleccion);
        filtros.rating = Number(boton.dataset.valor) || 0;
        grupo.querySelectorAll('button').forEach((btn) => {
          btn.classList.toggle('activo', btn === boton);
        });
        actualizarColeccionView(coleccion);
      });
    });

    Object.entries(gruposFiltroOrden).forEach(([coleccion, grupo]) => {
      if (!grupo) return;
      grupo.addEventListener('click', (event) => {
        const boton = event.target.closest('button[data-orden]');
        if (!boton) return;
        const filtros = obtenerFiltrosColeccion(coleccion);
        filtros.orden = boton.dataset.orden || 'nombre';
        grupo.querySelectorAll('button').forEach((btn) => {
          btn.classList.toggle('activo', btn === boton);
        });
        actualizarColeccionView(coleccion);
      });
    });

    Object.entries(botonesFiltroCercania).forEach(([coleccion, boton]) => {
      if (!boton) return;
      boton.addEventListener('click', async () => {
        boton.disabled = true;
        try {
          const ubicacion = await solicitarUbicacion();
          if (ubicacion) {
            state.ubicacionUsuario = ubicacion;
            state.distancias.clear();
            const filtros = obtenerFiltrosColeccion(coleccion);
            filtros.cercania = true;
            actualizarEstadoCercaniaUI();
            actualizarColeccionView(coleccion);
            ['lugares', 'restaurantes', 'ocio'].forEach((col) => {
              if (col !== coleccion && obtenerFiltrosColeccion(col).cercania) {
                actualizarColeccionView(col);
              }
            });
            togglePanelFiltros(coleccion, false);
          }
        } catch (error) {
          mostrarToast('No pudimos obtener tu ubicación.');
          logError(error, 'filtro-cercania');
        } finally {
          boton.disabled = false;
        }
      });
    });

    Object.entries(botonesFiltroCercaniaOff).forEach(([coleccion, boton]) => {
      if (!boton) return;
      boton.addEventListener('click', () => {
        const filtros = obtenerFiltrosColeccion(coleccion);
        filtros.cercania = false;
        actualizarEstadoCercaniaUI();
        actualizarColeccionView(coleccion);
      });
    });

    if (btnAutoCoordenadas) {
      btnAutoCoordenadas.addEventListener('click', async () => {
        const textoOriginal = btnAutoCoordenadas.textContent;
        btnAutoCoordenadas.disabled = true;
        btnAutoCoordenadas.textContent = 'Obteniendo…';
        try {
          const ubicacion = await solicitarUbicacion();
          if (ubicacion && Number.isFinite(ubicacion.lat) && Number.isFinite(ubicacion.lng)) {
            if (inputLatitud) inputLatitud.value = Number(ubicacion.lat).toFixed(6);
            if (inputLongitud) inputLongitud.value = Number(ubicacion.lng).toFixed(6);
            mostrarToast('Coordenadas sugeridas a partir de tu ubicación.');
          } else {
            throw new Error('ubicacion-no-disponible');
          }
        } catch (error) {
          mostrarToast('No pudimos obtener tu ubicación automáticamente.');
          logError(error, 'admin-auto-coordenadas');
        } finally {
          btnAutoCoordenadas.disabled = false;
          btnAutoCoordenadas.textContent = textoOriginal;
        }
      });
    }

    const esErrorFirebaseCritico = (error) => {
      if (!error) return false;
      const code = String(error.code || '').toLowerCase();
      const message = String(error.message || '').toLowerCase();
      return (
        code.includes('permission-denied') ||
        code.includes('unauth') ||
        code.includes('unavailable') ||
        message.includes('missing or insufficient permissions')
      );
    };

    const manejarErrorFirebase = (error, contexto) => {
      logError(error, contexto);
      if (esErrorFirebaseCritico(error)) {
        firebaseDisponible = false;
        if (state) state.firebaseDisponible = false;
        mostrarToast('No se pudo acceder a los datos remotos. Verifica los permisos de Firebase.');
      }
    };

    const LIMITES = {
      pagina: 20,
      resenas: 10
    };

    const mesActual = new Date();

    document.body.dataset.baneado = 'false';

    const toggleMenu = (mostrar, { skipFocus = false } = {}) => {
      if (!menu || !overlayMenu || !btnToggleMenu) return;
      const isOpen = mostrar ?? !menu.classList.contains('abierto');
      menu.classList.toggle('abierto', isOpen);
      overlayMenu.classList.toggle('visible', isOpen);
      document.body.classList.toggle('menu-abierto', isOpen);
      btnToggleMenu.setAttribute('aria-expanded', String(isOpen));
      menu.setAttribute('aria-hidden', String(!isOpen));
      overlayMenu.setAttribute('aria-hidden', String(!isOpen));
      if (isOpen) {
        menu.focus();
      } else if (!skipFocus) {
        btnToggleMenu.focus();
      }
    };

    if (btnToggleMenu) btnToggleMenu.addEventListener('click', () => toggleMenu());
    if (overlayMenu) overlayMenu.addEventListener('click', () => toggleMenu(false));

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && menu?.classList.contains('abierto')) {
        toggleMenu(false);
      }
    });

    window.addEventListener('resize', () => {
      if (window.innerWidth > 960 && menu?.classList.contains('abierto')) {
        toggleMenu(false, { skipFocus: true });
      }
    });

    const cambiarSeccion = (id) => {
      secciones.forEach((seccion) => {
        const visible = seccion.dataset.seccion === id;
        seccion.toggleAttribute('hidden', !visible);
      });
      document.querySelectorAll('.sub-lista').forEach((lista) => {
        lista.classList.toggle('visible', lista.dataset.parent === id);
      });
      if (listaMenu) {
        listaMenu.querySelectorAll('button[data-seccion]').forEach((btn) => {
          const activo = btn.dataset.seccion === id;
          btn.classList.toggle('activo', activo);
          btn.setAttribute('aria-expanded', String(activo));
        });
      }
      toggleMenu(false);
    };

    if (listaMenu) {
      listaMenu.addEventListener('click', (event) => {
        const target = event.target.closest('button');
        if (!target) return;
        if (target.dataset.seccion) {
          event.preventDefault();
          cambiarSeccion(target.dataset.seccion);
        }
        if (target.dataset.tag) {
          const parent = target.closest('.sub-lista');
          if (parent?.dataset.parent) {
            aplicarFiltro(parent.dataset.parent, target.dataset.tag);
          }
        }
      });
    }

    if (contenidoPrincipal) {
      contenidoPrincipal.addEventListener('click', (event) => {
        const ir = event.target.closest('[data-ir]');
        if (ir) {
          cambiarSeccion(ir.dataset.ir.replace('seccion', '').toLowerCase());
          const destino = document.getElementById(ir.dataset.ir);
          if (destino) destino.scrollIntoView({ behavior: 'smooth' });
        }
      });
    }

    widgetDestacado?.addEventListener('click', (event) => {
      const destino = event.target.closest('button[data-destacado-seccion]');
      if (!destino) return;
      const { destacadoSeccion: seccion, destacadoId: itemId } = destino.dataset;
      if (!seccion) return;
      cambiarSeccion(seccion);
      requestAnimationFrame(() => {
        const tarjeta = document.querySelector(`[data-id="${itemId}"]`);
        if (tarjeta) tarjeta.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
    });

    const obtenerEtiquetasDisponibles = (coleccion) => {
      const conjunto = new Set(TAGS_PREDEFINIDOS[coleccion] || []);
      const actuales = Array.isArray(state.colecciones[coleccion]) ? state.colecciones[coleccion] : [];
      actuales.forEach((item) => {
        if (Array.isArray(item.etiquetas)) {
          item.etiquetas.forEach((etiqueta) => conjunto.add(etiqueta));
        }
      });
      state.items.forEach((item) => {
        if (item?.coleccion === coleccion && Array.isArray(item.etiquetas)) {
          item.etiquetas.forEach((etiqueta) => conjunto.add(etiqueta));
        }
      });
      return Array.from(conjunto).filter(Boolean).sort((a, b) => a.localeCompare(b));
    };

    const construirChips = (coleccion, tagActual) => {
      const contenedor = chipsPorSeccion[coleccion];
      if (!contenedor) return;
      contenedor.textContent = '';
      const tags = ['todos', ...obtenerEtiquetasDisponibles(coleccion)];
      tags.forEach((tag) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = `chip${tag === tagActual ? ' activo' : ''}`;
        btn.dataset.tag = tag;
        btn.textContent = tag === 'todos' ? 'Todos' : tag.charAt(0).toUpperCase() + tag.slice(1);
        btn.setAttribute('aria-pressed', tag === tagActual ? 'true' : 'false');
        contenedor.appendChild(btn);
      });
    };

    Object.entries(chipsPorSeccion).forEach(([coleccion, contenedor]) => {
      contenedor.addEventListener('click', (event) => {
        const btn = event.target.closest('button');
        if (!btn) return;
        aplicarFiltro(coleccion, btn.dataset.tag);
      });
    });

    ['lugares', 'restaurantes', 'ocio'].forEach((coleccion) => construirChips(coleccion, 'todos'));

    const aplicarFiltro = (coleccion, tag) => {
      const paginador = state.paginadores[coleccion];
      if (!paginador) return;
      paginador.tag = tag;
      paginador.pagina = 0;
      paginador.ultimo = null;
      paginador.hayMas = true;
      paginador.historial = [null];
      construirChips(coleccion, tag);
      cargarColeccion(coleccion, { reiniciar: true }).catch((error) => logError(error, 'filtro'));
    };

    const obtenerFechaResena = (resena) => {
      if (!resena) return new Date(0);
      if (resena.creado?.seconds) return new Date(resena.creado.seconds * 1000);
      if (resena.fechaCreacion) return new Date(resena.fechaCreacion);
      if (resena.creado instanceof Date) return resena.creado;
      return new Date(0);
    };

    const buscarItemPorId = (id) => {
      if (!id) return null;
      if (state.items.has(id)) return state.items.get(id);
      const colecciones = ['lugares', 'restaurantes', 'ocio'];
      for (const coleccion of colecciones) {
        const lista = Array.isArray(state.colecciones[coleccion]) ? state.colecciones[coleccion] : [];
        const encontrado = lista.find((elemento) => elemento.id === id);
        if (encontrado) return { ...encontrado, coleccion };
      }
      return null;
    };

    const actualizarTarjetaConResenas = (itemId, lista) => {
      const entradas = Array.isArray(lista) ? lista : [];
      const valoracion = state.valoraciones.get(itemId);
      document.querySelectorAll(`[data-valoracion-id="${itemId}"]`).forEach((nodo) => {
        const span = nodo.querySelector('span') || nodo;
        const small = nodo.querySelector('small');
        if (!valoracion || !valoracion.total) {
          if (span) span.textContent = '⭐ —';
          if (small) small.textContent = 'Sin resenas todavía';
        } else {
          if (span) span.textContent = `⭐ ${valoracion.promedio.toFixed(1)}`;
          if (small) small.textContent = `${valoracion.total} resena${valoracion.total === 1 ? '' : 's'}`;
        }
      });
      document.querySelectorAll(`[data-resena-preview="${itemId}"]`).forEach((nodo) => {
        if (!entradas.length) {
          nodo.textContent = 'Aún no hay resenas para este lugar.';
          return;
        }
        const ordenadas = [...entradas].sort((a, b) => obtenerFechaResena(b) - obtenerFechaResena(a));
        const destacada = ordenadas[0];
        const texto = (destacada.texto || '').trim();
        const fragmento = texto.length > 140 ? `${texto.slice(0, 137)}…` : texto;
        nodo.textContent = '';
        const cita = document.createElement('span');
        cita.textContent = fragmento ? `“${fragmento}”` : '“Sin comentarios disponibles.”';
        nodo.appendChild(cita);
        const autor = document.createElement('strong');
        autor.textContent = `— ${destacada.autor || 'Visitante'}`;
        nodo.appendChild(autor);
      });
      document.querySelectorAll(`[data-resenas-item="${itemId}"]`).forEach((seccion) => {
        const filtros = obtenerFiltrosDetalle(itemId);
        actualizarListaDetalleResenas(seccion, entradas, filtros);
      });
    };

    const detenerIdeasAuto = () => {
      if (state.destacado.animFrame) {
        cancelAnimationFrame(state.destacado.animFrame);
        state.destacado.animFrame = null;
      }
      state.destacado.inicio = 0;
      if (state.destacado.barra) {
        state.destacado.barra.style.width = '0%';
      }
    };

    const iniciarIdeasAuto = () => {
      detenerIdeasAuto();
      if (!widgetDestacado || state.destacado.lista.length <= 1) return;
      const animar = (timestamp) => {
        if (!state.destacado.inicio) state.destacado.inicio = timestamp;
        const progreso = Math.min(1, (timestamp - state.destacado.inicio) / DESTACADO_CONFIG.duracion);
        if (state.destacado.barra) {
          state.destacado.barra.style.width = `${(progreso * 100).toFixed(2)}%`;
        }
        if (progreso >= 1) {
          cambiarIdea(1);
          return;
        }
        state.destacado.animFrame = requestAnimationFrame(animar);
      };
      state.destacado.animFrame = requestAnimationFrame(animar);
    };

    const obtenerIdeasCandidatas = () => {
      const candidatos = [];
      state.valoraciones.forEach((info, itemId) => {
        if (info.promedio > 4) {
          const item = buscarItemPorId(itemId);
          if (item) {
            candidatos.push({ itemId, item, info });
          }
        }
      });
      candidatos.sort((a, b) => {
        const diff = b.info.promedio - a.info.promedio;
        if (Math.abs(diff) > 1e-3) return diff;
        const total = (b.info.total || 0) - (a.info.total || 0);
        if (total !== 0) return total;
        return a.item.nombre.localeCompare(b.item.nombre);
      });
      return candidatos.slice(0, 10);
    };

    const renderIdeasWidget = () => {
      if (!widgetDestacado) return;
      detenerIdeasAuto();
      widgetDestacado.textContent = '';
      const cabecera = document.createElement('div');
      cabecera.className = 'ideas-header';
      const titulo = document.createElement('strong');
      titulo.textContent = 'Ideas';
      cabecera.appendChild(titulo);
      const controles = document.createElement('div');
      controles.className = 'ideas-controles';
      const btnPrev = document.createElement('button');
      btnPrev.type = 'button';
      btnPrev.setAttribute('aria-label', 'Idea anterior');
      btnPrev.textContent = '◀';
      const btnNext = document.createElement('button');
      btnNext.type = 'button';
      btnNext.setAttribute('aria-label', 'Idea siguiente');
      btnNext.textContent = '▶';
      controles.append(btnPrev, btnNext);
      cabecera.appendChild(controles);
      widgetDestacado.appendChild(cabecera);

      if (!state.destacado.lista.length) {
        btnPrev.disabled = true;
        btnNext.disabled = true;
        const mensaje = document.createElement('p');
        mensaje.textContent = 'Reuniremos aquí las mejores propuestas en cuanto tengamos suficientes valoraciones.';
        widgetDestacado.appendChild(mensaje);
        const progreso = document.createElement('div');
        progreso.className = 'ideas-progreso';
        const barra = document.createElement('span');
        progreso.appendChild(barra);
        widgetDestacado.appendChild(progreso);
        state.destacado.barra = barra;
        return;
      }

      btnPrev.disabled = state.destacado.lista.length <= 1;
      btnNext.disabled = state.destacado.lista.length <= 1;
      const actual = state.destacado.lista[state.destacado.indice];

      const contenido = document.createElement('div');
      contenido.className = 'ideas-contenido';
      const figura = document.createElement('div');
      figura.className = 'ideas-imagen';
      const imagenDestacada = obtenerImagenPrincipal(actual.item);
      if (imagenDestacada) {
        figura.style.backgroundImage = `url(${imagenDestacada})`;
      }
      contenido.appendChild(figura);

      const texto = document.createElement('div');
      texto.className = 'ideas-texto';
      const nombre = document.createElement('h3');
      nombre.textContent = actual.item.nombre;
      texto.appendChild(nombre);
      const descripcion = document.createElement('p');
      descripcion.textContent = actual.item.descripcion || 'Descubre este plan muy bien valorado por la comunidad.';
      texto.appendChild(descripcion);
      const meta = document.createElement('div');
      meta.className = 'ideas-meta';
      const nota = document.createElement('div');
      nota.className = 'tarjeta-valoracion';
      const spanNota = document.createElement('span');
      spanNota.textContent = `⭐ ${actual.info.promedio.toFixed(1)}`;
      const detalle = document.createElement('small');
      detalle.textContent = `${actual.info.total} resena${actual.info.total === 1 ? '' : 's'}`;
      nota.append(spanNota, detalle);
      meta.appendChild(nota);
      const distancia = obtenerDistanciaAUsuario(actual.item);
      if (Number.isFinite(distancia)) {
        const badgeDistancia = document.createElement('div');
        badgeDistancia.className = 'tarjeta-valoracion';
        badgeDistancia.textContent = `🧭 ${formatearDistancia(distancia)} de ti`;
        meta.appendChild(badgeDistancia);
      }
      texto.appendChild(meta);
      if (actual.item.coleccion) {
        const boton = document.createElement('button');
        boton.type = 'button';
        boton.className = 'btn btn-ghost btn-sm';
        boton.dataset.destacadoSeccion = actual.item.coleccion;
        boton.dataset.destacadoId = actual.itemId;
        const nombreSeccion = actual.item.coleccion.charAt(0).toUpperCase() + actual.item.coleccion.slice(1);
        boton.textContent = `Ver en ${nombreSeccion}`;
        texto.appendChild(boton);
      }
      contenido.appendChild(texto);
      widgetDestacado.appendChild(contenido);

      const progreso = document.createElement('div');
      progreso.className = 'ideas-progreso';
      const barra = document.createElement('span');
      progreso.appendChild(barra);
      widgetDestacado.appendChild(progreso);
      state.destacado.barra = barra;

      btnPrev.addEventListener('click', (event) => {
        event.stopPropagation();
        cambiarIdea(-1);
      });
      btnNext.addEventListener('click', (event) => {
        event.stopPropagation();
        cambiarIdea(1);
      });
    };

    const actualizarIdeas = () => {
      state.destacado.lista = obtenerIdeasCandidatas();
      if (state.destacado.indice >= state.destacado.lista.length) {
        state.destacado.indice = 0;
      }
      renderIdeasWidget();
      iniciarIdeasAuto();
    };

    const cambiarIdea = (incremento) => {
      if (!state.destacado.lista.length) {
        renderIdeasWidget();
        return;
      }
      const total = state.destacado.lista.length;
      state.destacado.indice = (state.destacado.indice + incremento + total) % total;
      renderIdeasWidget();
      iniciarIdeasAuto();
    };

    const refrescarValoracionesGlobales = () => {
      const todas = [];
      const registro = new Set();
      const agregar = (resena) => {
        if (!resena || !resena.itemId) return;
        const autorId = resena.usuarioId || resena.usuario || '';
        const key = resena.id || `${resena.itemId}-${autorId}-${resena.titulo || ''}`;
        if (registro.has(key)) return;
        registro.add(key);
        todas.push(resena);
      };
      (Array.isArray(state.resenas) ? state.resenas : []).forEach(agregar);
      const agrupadas = new Map();
      todas.forEach((resena) => {
        const lista = agrupadas.get(resena.itemId) || [];
        lista.push(resena);
        agrupadas.set(resena.itemId, lista);
      });
      state.resenasPorItem = agrupadas;
      state.valoraciones = new Map();
      agrupadas.forEach((lista, itemId) => {
        const total = lista.length;
        const suma = lista.reduce((acc, res) => acc + clampRating(res.rating), 0);
        state.valoraciones.set(itemId, { total, promedio: total ? suma / total : 0 });
      });
      agrupadas.forEach((lista, itemId) => actualizarTarjetaConResenas(itemId, lista));
      document.querySelectorAll('[data-valoracion-id]').forEach((nodo) => {
        const itemId = nodo.dataset.valoracionId;
        if (!agrupadas.has(itemId)) {
          actualizarTarjetaConResenas(itemId, []);
        }
      });
      ['lugares', 'restaurantes', 'ocio'].forEach((coleccion) => {
        if (state.colecciones[coleccion]) {
          actualizarColeccionView(coleccion);
        }
      });
      actualizarIdeas();
      actualizarEstadoCercaniaUI();
    };

    const crearTarjeta = (item, coleccion) => {
      const tarjeta = document.createElement('article');
      tarjeta.className = 'tarjeta';
      tarjeta.dataset.id = item.id;
      tarjeta.dataset.coleccion = coleccion;

      if (puedeUsarPanelAdmin()) {
        const btnEditarOverlay = document.createElement('button');
        btnEditarOverlay.type = 'button';
        btnEditarOverlay.className = 'tarjeta-boton-editar';
        btnEditarOverlay.setAttribute('aria-label', `Editar ${item.nombre}`);
        btnEditarOverlay.textContent = '✏️';
        btnEditarOverlay.addEventListener('click', (event) => {
          event.stopPropagation();
          abrirModalAdmin(item, coleccion);
        });
        tarjeta.appendChild(btnEditarOverlay);
      }

      const resumen = document.createElement('button');
      resumen.type = 'button';
      resumen.className = 'tarjeta-resumen';
      resumen.setAttribute('aria-expanded', 'false');

      const contenedorImagen = document.createElement('div');
      contenedorImagen.className = 'tarjeta-resumen-imagen';
      const imagen = document.createElement('img');
      const imagenPrincipal = obtenerImagenPrincipal(item);
      if (imagenPrincipal) {
        imagen.src = imagenPrincipal;
      } else {
        imagen.src = 'assets/placeholder.svg';
      }
      imagen.alt = `Imagen de ${item.nombre}`;
      imagen.loading = 'lazy';
      contenedorImagen.appendChild(imagen);

      const overlay = document.createElement('div');
      overlay.className = 'tarjeta-overlay';
      const tituloOverlay = document.createElement('h3');
      tituloOverlay.textContent = item.nombre;
      overlay.appendChild(tituloOverlay);
      const valoracionOverlay = document.createElement('div');
      valoracionOverlay.className = 'tarjeta-valoracion';
      valoracionOverlay.dataset.valoracionId = item.id;
      const notaOverlay = document.createElement('span');
      notaOverlay.textContent = '⭐ —';
      const detalleOverlay = document.createElement('small');
      detalleOverlay.textContent = 'Sin resenas todavía';
      valoracionOverlay.append(notaOverlay, detalleOverlay);
      overlay.appendChild(valoracionOverlay);
      contenedorImagen.appendChild(overlay);
      resumen.appendChild(contenedorImagen);
      tarjeta.appendChild(resumen);

      const detalle = document.createElement('div');
      detalle.className = 'tarjeta-detalle';
      detalle.hidden = true;
      detalle.dataset.itemId = item.id;
      const detalleId = `detalle-${item.id}`;
      detalle.id = detalleId;
      resumen.setAttribute('aria-controls', detalleId);
      const btnCerrarDetalle = document.createElement('button');
      btnCerrarDetalle.type = 'button';
      btnCerrarDetalle.className = 'tarjeta-cerrar';
      btnCerrarDetalle.setAttribute('aria-label', `Cerrar detalle de ${item.nombre}`);
      btnCerrarDetalle.textContent = '×';
      detalle.appendChild(btnCerrarDetalle);

      const cabecera = document.createElement('header');
      const tituloDetalle = document.createElement('h3');
      tituloDetalle.textContent = item.nombre;
      cabecera.appendChild(tituloDetalle);
      const meta = document.createElement('div');
      meta.className = 'tarjeta-meta';
      if (item.direccion) {
        const direccion = document.createElement('span');
        direccion.className = 'tarjeta-meta-direccion';
        direccion.textContent = `📍 ${item.direccion}`;
        meta.appendChild(direccion);
      }
      const distanciaUsuario = obtenerDistanciaAUsuario(item);
      if (Number.isFinite(distanciaUsuario)) {
        const badge = document.createElement('span');
        badge.className = 'tarjeta-meta-badge';
        badge.textContent = `🧭 ${formatearDistancia(distanciaUsuario)} de ti`;
        meta.appendChild(badge);
      }
      if (meta.childElementCount) {
        cabecera.appendChild(meta);
      }
      detalle.appendChild(cabecera);

      if (item.descripcion) {
        const descripcion = document.createElement('p');
        descripcion.className = 'tarjeta-descripcion';
        descripcion.textContent = item.descripcion;
        detalle.appendChild(descripcion);
      }

      if (Array.isArray(item.etiquetas) && item.etiquetas.length) {
        const etiquetas = document.createElement('div');
        etiquetas.className = 'etiquetas';
        item.etiquetas.forEach((tag) => {
          const span = document.createElement('span');
          span.className = 'etiqueta';
          span.textContent = tag;
          etiquetas.appendChild(span);
        });
        detalle.appendChild(etiquetas);
      }

      const fuentesGaleria = Array.isArray(item.galeria) ? item.galeria.filter((url) => isSafeImageURL(url)) : [];
      if (!fuentesGaleria.length && imagenPrincipal) {
        fuentesGaleria.push(imagenPrincipal);
      }
      if (fuentesGaleria.length) {
        const galeria = document.createElement('div');
        galeria.className = 'tarjeta-galeria';
        fuentesGaleria.forEach((src, indice) => {
          const img = document.createElement('img');
          img.src = src;
          img.alt = `Galería de ${item.nombre} (${indice + 1})`;
          img.loading = 'lazy';
          galeria.appendChild(img);
        });
        detalle.appendChild(galeria);
      }

      const acciones = document.createElement('div');
      acciones.className = 'tarjeta-acciones';
      let tieneAcciones = false;
      if (item.enlace && isSafeHttpUrl(item.enlace)) {
        const enlace = document.createElement('a');
        enlace.className = 'btn btn-ghost';
        enlace.textContent = 'Sitio oficial';
        if (safeLink(enlace, item.enlace)) {
          acciones.appendChild(enlace);
          tieneAcciones = true;
        }
      }
      const mapaUrl = construirUrlMapa(item);
      if (mapaUrl && isSafeHttpUrl(mapaUrl)) {
        const mapaBtn = document.createElement('a');
        mapaBtn.className = 'btn btn-ghost';
        mapaBtn.textContent = 'Ver en Google Maps';
        if (safeLink(mapaBtn, mapaUrl)) {
          acciones.appendChild(mapaBtn);
          tieneAcciones = true;
        }
      }
      if (tieneAcciones) {
        detalle.appendChild(acciones);
      }

      const mapaEmbed = construirMapaEmbed(item);
      if (mapaEmbed) {
        const mapaContenedor = document.createElement('div');
        mapaContenedor.className = 'tarjeta-mapa';
        const iframe = document.createElement('iframe');
        iframe.title = `Mapa de ${item.nombre}`;
        iframe.loading = 'lazy';
        iframe.referrerPolicy = 'no-referrer-when-downgrade';
        iframe.dataset.mapSrc = mapaEmbed;
        mapaContenedor.appendChild(iframe);
        detalle.appendChild(mapaContenedor);
      }

      if (mapaUrl) {
        const navegacion = document.createElement('div');
        navegacion.className = 'tarjeta-navegacion';
        navegacion.dataset.navegacionId = item.id;
        const labelNav = document.createElement('span');
        labelNav.className = 'sr-only';
        labelNav.textContent = 'Elige la aplicación de navegación';
        navegacion.appendChild(labelNav);
        const opcionesNav = document.createElement('div');
        opcionesNav.className = 'navegacion-opciones';
        opcionesNav.dataset.navOpciones = item.id;
        NAV_OPCIONES.forEach((opcion) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.dataset.navValor = opcion.value;
          btn.textContent = opcion.label;
          btn.setAttribute('aria-pressed', 'false');
          opcionesNav.appendChild(btn);
        });
        actualizarNavVisual(opcionesNav, obtenerPreferenciaNavegacion());
        navegacion.appendChild(opcionesNav);
        const boton = document.createElement('button');
        boton.type = 'button';
        boton.className = 'btn btn-primario';
        boton.dataset.abrirNavegador = item.id;
        boton.textContent = 'Abrir navegador';
        navegacion.appendChild(boton);
        detalle.appendChild(navegacion);
      }

      const seccionResenas = document.createElement('section');
      seccionResenas.className = 'tarjeta-resenas';
      seccionResenas.dataset.resenasItem = item.id;
      const controles = document.createElement('div');
      controles.className = 'detalle-reviews-controles';
      const filtros = document.createElement('div');
      filtros.className = 'filtros';
      const ordenId = `orden-${item.id}`;
      const labelOrden = document.createElement('label');
      labelOrden.textContent = 'Ordenar por';
      labelOrden.setAttribute('for', ordenId);
      filtros.appendChild(labelOrden);
      const selectOrden = document.createElement('select');
      selectOrden.id = ordenId;
      selectOrden.dataset.ordenResenas = item.id;
      [
        { value: 'recomendadas', label: 'Recomendadas' },
        { value: 'recientes', label: 'Más recientes' },
        { value: 'mejores', label: 'Mejor valoradas' },
        { value: 'peores', label: 'Peor valoradas' },
        { value: 'imagenes', label: 'Solo con imágenes' }
      ].forEach((opcion) => {
        const option = document.createElement('option');
        option.value = opcion.value;
        option.textContent = opcion.label;
        selectOrden.appendChild(option);
      });
      filtros.appendChild(selectOrden);
      const filtroEstrellas = document.createElement('div');
      const textoFiltro = document.createElement('span');
      textoFiltro.textContent = 'Filtrar por estrellas:';
      filtroEstrellas.appendChild(textoFiltro);
      const selectorEstrellas = document.createElement('div');
      selectorEstrellas.className = 'stars-selector';
      selectorEstrellas.dataset.selectorEstrellas = item.id;
      for (let i = 1; i <= 5; i += 1) {
        const estrella = document.createElement('button');
        estrella.type = 'button';
        estrella.dataset.valor = String(i);
        estrella.setAttribute('aria-label', `${i} estrella${i === 1 ? '' : 's'}`);
        estrella.textContent = '★';
        selectorEstrellas.appendChild(estrella);
      }
      filtroEstrellas.appendChild(selectorEstrellas);
      filtros.appendChild(filtroEstrellas);
      controles.appendChild(filtros);
      const resumenResenas = document.createElement('span');
      resumenResenas.dataset.detalleResumen = item.id;
      resumenResenas.textContent = 'Sin resenas todavía';
      controles.appendChild(resumenResenas);
      seccionResenas.appendChild(controles);
      const estadoDetalle = document.createElement('p');
      estadoDetalle.className = 'lista-vacia';
      estadoDetalle.dataset.detalleEstado = item.id;
      estadoDetalle.textContent = 'Aún no hay resenas para este lugar.';
      seccionResenas.appendChild(estadoDetalle);
      const listaDetalle = document.createElement('div');
      listaDetalle.className = 'detalle-reviews-lista';
      listaDetalle.dataset.detalleLista = item.id;
      seccionResenas.appendChild(listaDetalle);
      detalle.appendChild(seccionResenas);

      if (puedeUsarPanelAdmin()) {
        const accionesAdmin = document.createElement('div');
        accionesAdmin.className = 'tarjeta-acciones';
        const btnEliminar = document.createElement('button');
        btnEliminar.type = 'button';
        btnEliminar.className = 'btn btn-ghost';
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.addEventListener('click', () => eliminarDocumento(coleccion, item.id));
        accionesAdmin.appendChild(btnEliminar);
        detalle.appendChild(accionesAdmin);
      }

      tarjeta.appendChild(detalle);

      const cerrarTarjetaAbierta = (nodo) => {
        if (!nodo) return;
        nodo.classList.remove('expanded');
        const detalleNodo = nodo.querySelector('.tarjeta-detalle');
        if (detalleNodo) detalleNodo.hidden = true;
        const resumenNodo = nodo.querySelector('.tarjeta-resumen');
        if (resumenNodo) resumenNodo.setAttribute('aria-expanded', 'false');
      };

      const alternarDetalle = (mostrar) => {
        const abiertoActual = !detalle.hidden;
        const objetivo = typeof mostrar === 'boolean' ? mostrar : !abiertoActual;
        if (objetivo && state.tarjetaAbierta && state.tarjetaAbierta !== tarjeta) {
          cerrarTarjetaAbierta(state.tarjetaAbierta);
        }
        tarjeta.classList.toggle('expanded', objetivo);
        detalle.hidden = !objetivo;
        resumen.setAttribute('aria-expanded', String(objetivo));
        if (objetivo) {
          state.tarjetaAbierta = tarjeta;
          prepararDetalleTarjeta(tarjeta, item, detalle);
        } else if (state.tarjetaAbierta === tarjeta) {
          state.tarjetaAbierta = null;
        }
      };

      btnCerrarDetalle.addEventListener('click', (event) => {
        event.stopPropagation();
        alternarDetalle(false);
      });

      resumen.addEventListener('click', () => alternarDetalle());

      return tarjeta;
    };


    const obtenerResenasDeItem = (itemId) => {
      if (!itemId) return [];
      const lista = state.resenasPorItem.get(itemId);
      return Array.isArray(lista) ? [...lista] : [];
    };

    const tieneImagenAdjunta = (resena = {}) => {
      if (Array.isArray(resena.imagenes) && resena.imagenes.length) return true;
      return Boolean(resena.imagenUrl);
    };

    const obtenerFiltrosDetalle = (itemId) => {
      if (!state.detalleResenas.has(itemId)) {
        state.detalleResenas.set(itemId, { orden: 'recomendadas', estrellas: 0 });
      }
      return state.detalleResenas.get(itemId);
    };

    const filtrarYOrdenarResenas = (lista, filtros = {}) => {
      const { orden = 'recomendadas', estrellas = 0 } = filtros;
      const soloImagenes = orden === 'imagenes' || Boolean(filtros.soloImagenes);
      const base = Array.isArray(lista) ? [...lista] : [];
      const filtradas = base.filter((entrada) => {
        if (!entrada) return false;
        if (estrellas > 0 && Math.round(clampRating(entrada.rating)) !== estrellas) {
          return false;
        }
        if (soloImagenes && !tieneImagenAdjunta(entrada)) {
          return false;
        }
        return true;
      });
      const compararRecientes = (a, b) => obtenerFechaResena(b) - obtenerFechaResena(a);
      const compararMejores = (a, b) => clampRating(b.rating) - clampRating(a.rating) || compararRecientes(a, b);
      const compararPeores = (a, b) => clampRating(a.rating) - clampRating(b.rating) || compararRecientes(a, b);
      switch (orden) {
        case 'recientes':
          filtradas.sort(compararRecientes);
          break;
        case 'mejores':
          filtradas.sort(compararMejores);
          break;
        case 'peores':
          filtradas.sort(compararPeores);
          break;
        case 'imagenes':
          filtradas.sort(compararRecientes);
          break;
        case 'recomendadas':
        default:
          filtradas.sort(compararMejores);
          break;
      }
      return filtradas;
    };

    function actualizarEstrellasVisual(contenedor, activa = 0, hover = 0) {
      if (!contenedor) return;
      const objetivo = hover || activa;
      contenedor.querySelectorAll('button').forEach((btn) => {
        const valor = Number(btn.dataset.valor);
        btn.classList.toggle('activo', objetivo > 0 && valor <= objetivo);
      });
    }

    const actualizarListaDetalleResenas = (seccion, lista, filtros = {}) => {
      if (!seccion) return;
      const listaNodo = seccion.querySelector('.detalle-reviews-lista');
      const estadoNodo = seccion.querySelector('[data-detalle-estado]');
      const resumenNodo = seccion.querySelector('[data-detalle-resumen]');
      const selectOrden = seccion.querySelector('select[data-orden-resenas]');
      const selectorEstrellas = seccion.querySelector('.stars-selector');
      if (selectOrden && selectOrden.value !== filtros.orden) {
        selectOrden.value = filtros.orden;
      }
      if (selectorEstrellas) {
        actualizarEstrellasVisual(selectorEstrellas, filtros.estrellas || 0);
      }
      if (resumenNodo) {
        const total = Array.isArray(lista) ? lista.length : 0;
        resumenNodo.textContent = total
          ? `${total} resena${total === 1 ? '' : 's'}`
          : 'Sin resenas todavía';
      }
      if (!listaNodo || !estadoNodo) return;
      const preparadas = filtrarYOrdenarResenas(lista, filtros);
      listaNodo.textContent = '';
      if (!preparadas.length) {
        estadoNodo.textContent = filtros.estrellas
          ? `No hay resenas con ${filtros.estrellas} estrella${filtros.estrellas === 1 ? '' : 's'}.`
          : 'Aún no hay resenas que coincidan con los filtros seleccionados.';
        estadoNodo.hidden = false;
        return;
      }
      estadoNodo.hidden = true;
      preparadas.forEach((resena) => {
        const articulo = document.createElement('article');
        articulo.className = 'detalle-resena';
        articulo.dataset.id = resena.id;
        const titulo = document.createElement('strong');
        titulo.textContent = resena.titulo || 'Resena';
        articulo.appendChild(titulo);
        const rating = document.createElement('div');
        rating.className = 'rating';
        const nota = clampRating(resena.rating);
        const estrellas = Math.round(nota);
        const estrellasTexto = `${'★'.repeat(estrellas)}${'☆'.repeat(Math.max(0, 5 - estrellas))}`;
        rating.textContent = `${estrellasTexto} (${nota.toFixed(1)})`;
        articulo.appendChild(rating);
        if (resena.texto) {
          const texto = document.createElement('p');
          texto.textContent = resena.texto;
          articulo.appendChild(texto);
        }
        if (tieneImagenAdjunta(resena)) {
          const figure = document.createElement('figure');
          const imagenes = Array.isArray(resena.imagenes) ? resena.imagenes : [resena.imagenUrl].filter(Boolean);
          imagenes.slice(0, 3).forEach((url, indice) => {
            if (!isSafeImageURL(url)) return;
            const img = document.createElement('img');
            img.src = url;
            img.alt = `Imagen ${indice + 1} de la resena ${resena.titulo || ''}`.trim();
            img.loading = 'lazy';
            figure.appendChild(img);
          });
          if (figure.childElementCount) {
            articulo.appendChild(figure);
          }
        }
        const autor = document.createElement('small');
        const fecha = obtenerFechaResena(resena);
        const autorNombre = resena.autor || 'Visitante';
        autor.textContent = `${autorNombre} · ${fecha.toLocaleDateString()}`;
        articulo.appendChild(autor);
        listaNodo.appendChild(articulo);
      });
    };

    const prepararDetalleTarjeta = (tarjeta, item, detalle) => {
      if (!detalle || detalle.dataset.preparado === 'true') return;
      detalle.dataset.preparado = 'true';
      const seccionResenas = detalle.querySelector('.tarjeta-resenas');
      const filtros = obtenerFiltrosDetalle(item.id);
      const selectOrden = seccionResenas?.querySelector('select[data-orden-resenas]');
      if (selectOrden) {
        selectOrden.value = filtros.orden;
        selectOrden.addEventListener('change', (event) => {
          const datos = obtenerFiltrosDetalle(item.id);
          datos.orden = event.target.value;
          actualizarListaDetalleResenas(seccionResenas, obtenerResenasDeItem(item.id), datos);
        });
      }
      const selectorEstrellas = seccionResenas?.querySelector('.stars-selector');
      if (selectorEstrellas) {
        selectorEstrellas.addEventListener('mouseleave', () => {
          const datos = obtenerFiltrosDetalle(item.id);
          actualizarEstrellasVisual(selectorEstrellas, datos.estrellas);
        });
        selectorEstrellas.querySelectorAll('button').forEach((btn) => {
          const valor = Number(btn.dataset.valor);
          btn.addEventListener('mouseenter', () => {
            const datos = obtenerFiltrosDetalle(item.id);
            actualizarEstrellasVisual(selectorEstrellas, datos.estrellas, valor);
          });
          btn.addEventListener('focus', () => {
            const datos = obtenerFiltrosDetalle(item.id);
            actualizarEstrellasVisual(selectorEstrellas, datos.estrellas, valor);
          });
          btn.addEventListener('mouseleave', () => {
            const datos = obtenerFiltrosDetalle(item.id);
            actualizarEstrellasVisual(selectorEstrellas, datos.estrellas);
          });
          btn.addEventListener('blur', () => {
            const datos = obtenerFiltrosDetalle(item.id);
            actualizarEstrellasVisual(selectorEstrellas, datos.estrellas);
          });
          btn.addEventListener('click', () => {
            const datos = obtenerFiltrosDetalle(item.id);
            datos.estrellas = datos.estrellas === valor ? 0 : valor;
            actualizarEstrellasVisual(selectorEstrellas, datos.estrellas);
            actualizarListaDetalleResenas(seccionResenas, obtenerResenasDeItem(item.id), datos);
          });
        });
      }
      const mapaIframe = detalle.querySelector('.tarjeta-mapa iframe');
      if (mapaIframe && !mapaIframe.src && mapaIframe.dataset.mapSrc) {
        mapaIframe.src = mapaIframe.dataset.mapSrc;
      }
      const navOpciones = detalle.querySelector('[data-nav-opciones]');
      if (navOpciones) {
        actualizarNavVisual(navOpciones, obtenerPreferenciaNavegacion());
        navOpciones.querySelectorAll('button').forEach((btn) => {
          btn.addEventListener('click', () => {
            establecerPreferenciaNavegacion(btn.dataset.navValor || 'auto');
          });
        });
      }
      const botonNavegar = detalle.querySelector('[data-abrir-navegador]');
      if (botonNavegar) {
        botonNavegar.addEventListener('click', () => {
          const destino = construirDestinoNavegacion(item, obtenerPreferenciaNavegacion());
          if (destino && isSafeHttpUrl(destino)) {
            window.open(destino, '_blank', 'noopener');
          } else {
            mostrarToast('No fue posible abrir la ubicación seleccionada.');
          }
        });
      }
      actualizarListaDetalleResenas(seccionResenas, obtenerResenasDeItem(item.id), filtros);
    };

    const renderLista = (coleccion, docs, pagina) => {
      state.colecciones[coleccion] = Array.isArray(docs) ? docs : [];
      if (state.paginadores[coleccion]) {
        state.paginadores[coleccion].pagina = pagina;
      }
      state.tarjetaAbierta = null;
      actualizarColeccionView(coleccion);
      actualizarEstadoCercaniaUI();
    };

    const renderResenas = (items, pagina) => {
      const base = Array.isArray(items) ? items : [];
      const filtros = state.filtrosResenas || { orden: 'recomendadas', estrellas: 0, soloImagenes: false };
      const filtradas = filtrarYOrdenarResenas(base, filtros);
      listaResenas.textContent = '';
      if (resumenResenasGlobal) {
        const total = base.length;
        const visibles = filtradas.length;
        const detalles = [];
        if (filtros.estrellas) detalles.push(`${filtros.estrellas}★`);
        if (filtros.soloImagenes || filtros.orden === 'imagenes') detalles.push('con fotos');
        resumenResenasGlobal.textContent = detalles.length
          ? `Mostrando ${visibles} de ${total} resenas · ${detalles.join(' · ')}`
          : `Mostrando ${visibles} de ${total} resenas`;
      }
      if (!filtradas.length) {
        const vacio = document.createElement('p');
        vacio.className = 'lista-vacia';
        vacio.textContent = 'Sé la primera persona en dejar una resena.';
        listaResenas.appendChild(vacio);
      } else {
        filtradas.forEach((resena) => {
          const item = document.createElement('article');
          item.className = 'resena';
          item.dataset.id = resena.id;
          const titulo = document.createElement('strong');
          titulo.textContent = resena.titulo;
          item.appendChild(titulo);
          const rating = document.createElement('div');
          rating.className = 'rating';
          const nota = clampRating(resena.rating);
          const estrellas = Math.round(nota);
          rating.textContent = `${'★'.repeat(estrellas)}${'☆'.repeat(Math.max(0, 5 - estrellas))} (${nota.toFixed(1)})`;
          item.appendChild(rating);
          if (resena.itemId) {
            const destino = buscarItemPorId(resena.itemId);
            if (destino?.nombre) {
              const referencia = document.createElement('small');
              referencia.textContent = `Destino: ${destino.nombre}`;
              item.appendChild(referencia);
            }
          }
          if (resena.texto) {
            const texto = document.createElement('p');
            texto.textContent = resena.texto;
            item.appendChild(texto);
          }
          if (tieneImagenAdjunta(resena)) {
            const galeria = document.createElement('div');
            galeria.className = 'resena-imagenes';
            const imagenes = Array.isArray(resena.imagenes) ? resena.imagenes : [resena.imagenUrl].filter(Boolean);
            imagenes.slice(0, 3).forEach((url, index) => {
              if (!isSafeImageURL(url)) return;
              const img = document.createElement('img');
              img.src = url;
              img.alt = `Imagen ${index + 1} de la resena ${resena.titulo || ''}`.trim();
              img.loading = 'lazy';
              galeria.appendChild(img);
            });
            if (galeria.childElementCount) {
              item.appendChild(galeria);
            }
          }
          const pie = document.createElement('small');
          const fecha = resena.creado?.seconds ? new Date(resena.creado.seconds * 1000) : new Date();
          pie.textContent = `Publicado el ${fecha.toLocaleDateString()}`;
          item.appendChild(pie);
          const autorId = resena?.usuarioId || resena?.usuario;
          const esPropietario = autorId && state.user && state.user.uid === autorId;
          const esAdmin = puedeUsarPanelAdmin();
          if (esPropietario || esAdmin) {
            const acciones = document.createElement('div');
            acciones.className = 'resena-acciones';
            const btnEditar = document.createElement('button');
            btnEditar.type = 'button';
            btnEditar.className = 'btn btn-ghost';
            btnEditar.textContent = 'Editar';
            btnEditar.addEventListener('click', () => editarResena(resena));
            acciones.appendChild(btnEditar);
            const btnEliminar = document.createElement('button');
            btnEliminar.type = 'button';
            btnEliminar.className = 'btn btn-ghost';
            btnEliminar.textContent = 'Eliminar';
            btnEliminar.addEventListener('click', () => eliminarResena(resena));
            acciones.appendChild(btnEliminar);
            item.appendChild(acciones);
          }
          listaResenas.appendChild(item);
        });
      }
      estadoResenas.textContent = `Página ${pagina + 1} · ${filtradas.length}/${base.length} resenas`;
      refrescarValoracionesGlobales();
    };

    const LIMITES_ETIQUETAS = { maxEtiquetas: 8, maxLongitud: 20 };

    const limpiarEtiquetas = (texto) => {
      if (!texto) return [];
      return texto.split(',').map((t) => t.trim()).filter((t) => t.length && t.length <= LIMITES_ETIQUETAS.maxLongitud).slice(0, LIMITES_ETIQUETAS.maxEtiquetas);
    };

    const cargarColeccion = async (coleccion, { reiniciar = false, siguiente = false, anterior = false } = {}) => {
      const paginador = state.paginadores[coleccion];
      if (!paginador) return;
      if (siguiente && !paginador.hayMas) return;

      if (!firebaseDisponible || !db) {
        state.firebaseDisponible = false;
        paginador.pagina = 0;
        paginador.hayMas = false;
        paginador.ultimo = null;
        paginador.historial = [null];
        renderLista(coleccion, [], 0);
        refrescarValoracionesGlobales();
        return;
      }

      if (!Array.isArray(paginador.historial)) paginador.historial = [null];

      let destinoPagina = paginador.pagina;
      let cursor = null;
      if (reiniciar) {
        destinoPagina = 0;
        paginador.historial = [null];
      } else if (siguiente) {
        cursor = paginador.ultimo;
        destinoPagina = paginador.pagina + 1;
      } else if (anterior && paginador.pagina > 0) {
        destinoPagina = paginador.pagina - 1;
        cursor = paginador.historial[destinoPagina] || null;
      }

      let q = query(collection(db, coleccion), orderBy('nombre', 'asc'), limit(LIMITES.pagina));
      if (paginador.tag && paginador.tag !== 'todos') {
        q = query(q, where('etiquetas', 'array-contains', paginador.tag));
      }
      if (cursor) {
        q = query(q, startAfter(cursor));
      }

      let snap;
      try {
        snap = await getDocs(q);
      } catch (error) {
        manejarErrorFirebase(error, `${coleccion}-query`);
        paginador.pagina = 0;
        paginador.hayMas = false;
        paginador.ultimo = null;
        paginador.historial = [null];
        renderLista(coleccion, [], 0);
        refrescarValoracionesGlobales();
        return;
      }
      if (siguiente && snap.empty) {
        paginador.hayMas = false;
        return;
      }
      const docs = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      paginador.hayMas = snap.docs.length === LIMITES.pagina;
      paginador.ultimo = snap.docs[snap.docs.length - 1] || cursor || null;
      paginador.pagina = destinoPagina;
      paginador.historial[destinoPagina] = cursor || null;
      renderLista(coleccion, docs, paginador.pagina);
      refrescarValoracionesGlobales();
    };

    document.querySelectorAll('.paginacion button').forEach((btn) => {
      btn.addEventListener('click', (event) => {
        const { prev, next } = event.currentTarget.dataset;
        const coleccion = prev || next;
        if (!coleccion) return;
        const opciones = { reiniciar: false, siguiente: Boolean(next), anterior: Boolean(prev) };
        cargarColeccion(coleccion, opciones).catch((error) => logError(error, 'paginacion'));
      });
    });

    const cargarResenas = async ({ reiniciar = false, siguiente = false, anterior = false } = {}) => {
      const paginador = state.paginadores.resenas;
      if (siguiente && !paginador.hayMas) return;

      if (!firebaseDisponible || !db) {
        state.firebaseDisponible = false;
        state.resenas = [];
        paginador.pagina = 0;
        paginador.hayMas = false;
        paginador.ultimo = null;
        paginador.historial = [null];
        renderResenas([], 0);
        return;
      }

      if (!Array.isArray(paginador.historial)) paginador.historial = [null];

      let destinoPagina = paginador.pagina;
      let cursor = null;
      if (reiniciar) {
        destinoPagina = 0;
        paginador.historial = [null];
        paginador.ultimo = null;
      } else if (siguiente) {
        cursor = paginador.ultimo;
        destinoPagina = paginador.pagina + 1;
      } else if (anterior && paginador.pagina > 0) {
        destinoPagina = paginador.pagina - 1;
        cursor = paginador.historial[destinoPagina] || null;
      }

      let q = query(collection(db, 'resenas'), orderBy('creado', 'desc'), limit(LIMITES.resenas));
      if (cursor) {
        q = query(q, startAfter(cursor));
      }

      let snap;
      try {
        snap = await getDocs(q);
      } catch (error) {
        manejarErrorFirebase(error, 'resenas-query');
        state.resenas = [];
        paginador.pagina = 0;
        paginador.hayMas = false;
        paginador.ultimo = null;
        paginador.historial = [null];
        renderResenas([], 0);
        return;
      }
      if (siguiente && snap.empty) {
        paginador.hayMas = false;
        return;
      }
      const docs = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
      paginador.hayMas = snap.docs.length === LIMITES.resenas;
      paginador.ultimo = snap.docs[snap.docs.length - 1] || cursor || null;
      paginador.pagina = destinoPagina;
      paginador.historial[destinoPagina] = cursor || null;
      state.resenas = docs;
      renderResenas(docs, paginador.pagina);
    };

    document.querySelectorAll('[data-next="resenas"], [data-prev="resenas"]').forEach((btn) => {
      btn.addEventListener('click', (event) => {
        const siguiente = Boolean(event.currentTarget.dataset.next);
        const anterior = Boolean(event.currentTarget.dataset.prev);
        cargarResenas({ siguiente, anterior }).catch((error) => logError(error, 'resenas'));
      });
    });

    const validarResena = (formData) => {
      const titulo = sanitizeText(formData.get('titulo'));
      const texto = sanitizeText(formData.get('texto'));
      const rating = clampRating(formData.get('rating'));
      const errores = [];
      if (!titulo || titulo.length > 60) errores.push('titulo');
      if (!texto || texto.length > 2000) errores.push('texto');
      if (rating < 1 || rating > 5) errores.push('rating');
      document.getElementById('ayudaTitulo').hidden = !errores.includes('titulo');
      document.getElementById('ayudaTexto').hidden = !errores.includes('texto');
      document.getElementById('ayudaRating').hidden = !errores.includes('rating');
      return errores.length === 0 ? { titulo, texto, rating } : null;
    };

    formResena.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (state.baneado) {
        mostrarToast('Tu acceso está bloqueado. Contacta con soporte.');
        return;
      }
      if (!state.user || state.claims.role === USER_ROLES.INVITADO) {
        mostrarToast('Inicia sesión para dejar una resena.');
        return;
      }
      if (!state.user.emailVerificado) {
        mostrarToast('Verifica tu email para publicar resenas.');
        return;
      }
      const datos = new FormData(formResena);
      const resena = validarResena(datos);
      if (!resena) return;
      const imagenesSeleccionadas = Array.isArray(state.imagenesResena) ? state.imagenesResena.slice(0, 3) : [];
      try {
        if (!firebaseDisponible || !db) {
          mostrarToast('No se pudo enviar la resena. Intenta de nuevo más tarde.');
          return;
        }
        let imagenesSubidas = [];
        if (imagenesSeleccionadas.length) {
          if (!auth?.currentUser) {
            mostrarToast('Debes iniciar sesión');
            return;
          }
          if (!storage || !puedeUsarFirebaseStorage) {
            mostrarToast('No es posible subir tus fotos en este momento. Inténtalo de nuevo más tarde.');
            return;
          }
          asegurarSesionActivaParaStorage();
          for (let i = 0; i < imagenesSeleccionadas.length; i += 1) {
            const elemento = imagenesSeleccionadas[i];
            const extension = (elemento.file?.type || '').toLowerCase().includes('png') ? 'png' : 'jpg';
            const referencia = ref(storage, `resenas/${state.user.uid}/${Date.now()}-${i}.${extension}`);
            await uploadBytes(referencia, elemento.file, { contentType: elemento.file?.type || 'image/jpeg' });
            const url = await getDownloadURL(referencia);
            imagenesSubidas.push(url);
          }
        }
        const editarId = formResena.dataset.editarId;
        const imagenesPrevias = editarId
          ? JSON.parse(formResena.dataset.imagenesOriginales || '[]')
          : [];
        const imagenesFinales = imagenesSubidas.length ? imagenesSubidas : imagenesPrevias;
        if (editarId) {
          await updateDoc(doc(db, 'resenas', editarId), {
            ...resena,
            imagenes: imagenesFinales,
            actualizado: serverTimestamp()
          });
          mostrarToast('Resena actualizada.');
        } else {
          await addDoc(collection(db, 'resenas'), {
            ...resena,
            imagenes: imagenesFinales,
            creado: serverTimestamp(),
            usuarioId: state.user.uid
          });
          mostrarToast('Resena enviada. ¡Gracias!');
        }
        formResena.reset();
        delete formResena.dataset.editarId;
        delete formResena.dataset.imagenesOriginales;
        state.imagenesResena = [];
        if (inputFotos) inputFotos.value = '';
        if (previewFotos) previewFotos.textContent = '';
        if (inputRating) {
          inputRating.value = '5';
          actualizarSelectorRating(5);
        }
        state.paginadores.resenas = { pagina: 0, ultimo: null, hayMas: true, historial: [null] };
        await cargarResenas({ reiniciar: true });
      } catch (error) {
        logError(error, 'crear-resena');
      }
    });
    const eliminarResena = async (resena) => {
      if (!state.user || !resena?.id) return;
      const autorId = resena?.usuarioId || resena?.usuario;
      const esPropietario = autorId && state.user && state.user.uid === autorId;
      const esAdmin = puedeUsarPanelAdmin();
      if (!esPropietario && !esAdmin) {
        mostrarToast('Solo puedes gestionar tus propias resenas.');
        return;
      }
      try {
        if (!firebaseDisponible || !db) {
          mostrarToast('No se pudo eliminar la resena. Inténtalo más tarde.');
          return;
        }
        await deleteDoc(doc(db, 'resenas', resena.id));
        mostrarToast('Resena eliminada');
        state.paginadores.resenas = { pagina: 0, ultimo: null, hayMas: true, historial: [null] };
        await cargarResenas({ reiniciar: true });
      } catch (error) {
        logError(error, 'eliminar-resena');
      }
    };

    const editarResena = (resena) => {
      if (!resena) return;
      const autorId = resena?.usuarioId || resena?.usuario;
      const esPropietario = autorId && state.user && state.user.uid === autorId;
      const esAdmin = puedeUsarPanelAdmin();
      if (!esPropietario && !esAdmin) {
        mostrarToast('Solo puedes gestionar tus propias resenas.');
        return;
      }
      formResena.titulo.value = resena.titulo || '';
      formResena.texto.value = resena.texto || '';
      const rating = clampRating(resena.rating);
      inputRating.value = String(rating);
      actualizarSelectorRating(rating);
      delete formResena.dataset.editarId;
      formResena.dataset.editarId = resena.id;
      if (resena.imagenes) {
        formResena.dataset.imagenesOriginales = JSON.stringify(resena.imagenes);
      } else {
        delete formResena.dataset.imagenesOriginales;
      }
      if (inputFotos) inputFotos.value = '';
      if (previewFotos) previewFotos.textContent = '';
      state.imagenesResena = [];
      document.getElementById('seccionResenas')?.scrollIntoView({ behavior: 'smooth' });
      mostrarToast('Edita la resena y guarda los cambios.');
    };

    const mostrarConsentimiento = () => {
      if (!puedeEjecutarAnalyticsEnDominio || !bannerConsent) return;
      if (!state.consentimiento) {
        bannerConsent.classList.add('visible');
      }
    };

    const activarAnalytics = async () => {
      if (!puedeEjecutarAnalyticsEnDominio) return null;
      if (state.consentimiento !== 'aceptado' || analyticsInstance || !app) return analyticsInstance;
      try {
        if (!analyticsImportPromise) {
          analyticsImportPromise = import('https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js');
        }
        const modulo = await analyticsImportPromise;
        if (!modulo || typeof modulo.getAnalytics !== 'function') return null;
        analyticsInstance = modulo.getAnalytics(app);
        if (typeof modulo.setAnalyticsCollectionEnabled === 'function') {
          modulo.setAnalyticsCollectionEnabled(analyticsInstance, true);
        }
      } catch (error) {
        logError(error, 'analytics');
      }
      return analyticsInstance;
    };

    if (!puedeEjecutarAnalyticsEnDominio && bannerConsent) {
      bannerConsent.classList.remove('visible');
      bannerConsent.setAttribute('hidden', 'hidden');
    }

    if (btnAceptarConsent) {
      btnAceptarConsent.addEventListener('click', () => {
        localStorage.setItem('smv-consentimiento', 'aceptado');
        state.consentimiento = 'aceptado';
        bannerConsent?.classList.remove('visible');
        if (puedeEjecutarAnalyticsEnDominio) activarAnalytics();
      });
    }

    if (btnRechazarConsent) {
      btnRechazarConsent.addEventListener('click', async () => {
        localStorage.setItem('smv-consentimiento', 'rechazado');
        state.consentimiento = 'rechazado';
        bannerConsent?.classList.remove('visible');
        if (!analyticsInstance) return;
        try {
          const modulo = analyticsImportPromise ? await analyticsImportPromise : null;
          if (modulo && typeof modulo.setAnalyticsCollectionEnabled === 'function') {
            modulo.setAnalyticsCollectionEnabled(analyticsInstance, false);
          }
        } catch (error) {
          logError(error, 'analytics-consent');
        }
      });
    }

    const setClimaBusy = (isBusy) => {
      const widgets = [widgetClimaHero, widgetClimaDetalle];
      widgets.forEach((widget) => {
        if (!widget) return;
        if (isBusy) {
          widget.setAttribute('aria-busy', 'true');
        } else {
          widget.removeAttribute('aria-busy');
        }
      });
    };

    const renderClimaWidget = (contenedor, listaPronostico, data) => {
      if (!contenedor) return;
      contenedor.textContent = '';
      const tarjeta = document.createElement('div');
      tarjeta.className = 'clima-visual';
      const icono = document.createElement('div');
      icono.className = 'clima-icono';
      const codigoClima = Number(data?.codigo);
      const recursoClima = obtenerRecursoClima(codigoClima);
      if (recursoClima?.imagen) {
        const imagenClima = document.createElement('img');
        imagenClima.src = recursoClima.imagen;
        imagenClima.alt = data?.descripcion || recursoClima?.descripcion || 'Condiciones meteorológicas';
        imagenClima.loading = 'lazy';
        icono.appendChild(imagenClima);
      } else {
        icono.textContent = recursoClima?.emoji || '🌦️';
      }
      icono.setAttribute('role', 'img');
      icono.setAttribute('aria-label', data?.descripcion || recursoClima?.descripcion || 'Condiciones no disponibles');
      const datos = document.createElement('div');
      datos.className = 'clima-datos';
      const temp = document.createElement('strong');
      temp.textContent = `${Math.round(data?.temperatura ?? 0)}°C`;
      const descripcion = document.createElement('p');
      descripcion.textContent = data?.descripcion || 'Condiciones no disponibles';
      datos.append(temp, descripcion);
      tarjeta.append(icono, datos);
      const actualizacion = document.createElement('small');
      actualizacion.textContent = `Actualizado: ${new Date().toLocaleTimeString()}`;
      contenedor.append(tarjeta, actualizacion);
      if (listaPronostico) {
        listaPronostico.textContent = '';
        if (Array.isArray(data?.pronostico) && data.pronostico.length) {
          data.pronostico.slice(0, 4).forEach((dia) => {
            const li = document.createElement('li');
            const fecha = dia?.fecha ? new Date(dia.fecha) : null;
            const etiqueta = fecha
              ? fecha.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric' })
              : 'Próx.';
            const max = Number.isFinite(Number(dia?.max)) ? Math.round(dia.max) : null;
            const min = Number.isFinite(Number(dia?.min)) ? Math.round(dia.min) : null;
            const partes = [etiqueta];
            if (min !== null && max !== null) partes.push(`${min}° / ${max}°`);
            if (dia?.descripcion) partes.push(dia.descripcion);
            li.textContent = partes.join(' · ');
            listaPronostico.appendChild(li);
          });
        } else {
          const li = document.createElement('li');
          li.textContent = 'Sin pronóstico ampliado disponible.';
          listaPronostico.appendChild(li);
        }
      }
    };

    const renderClima = (data) => {
      renderClimaWidget(climaContenido, climaPronostico, data);
      renderClimaWidget(climaContenidoDetalle, climaPronosticoDetalle, data);
      setClimaBusy(false);
    };

    const CODIGOS_METEO_DESCRIPCION = {
      0: 'Cielo despejado',
      1: 'Mayormente despejado',
      2: 'Parcialmente nublado',
      3: 'Nublado',
      45: 'Niebla',
      48: 'Niebla con escarcha',
      51: 'Llovizna ligera',
      53: 'Llovizna moderada',
      55: 'Llovizna densa',
      61: 'Lluvia débil',
      63: 'Lluvia moderada',
      65: 'Lluvia intensa',
      66: 'Lluvia helada débil',
      67: 'Lluvia helada intensa',
      71: 'Nieve ligera',
      73: 'Nieve moderada',
      75: 'Fuertes nevadas',
      80: 'Chubascos ligeros',
      81: 'Chubascos moderados',
      82: 'Chubascos intensos',
      95: 'Tormenta',
      96: 'Tormenta con granizo leve',
      99: 'Tormenta con granizo fuerte'
    };

    const obtenerDescripcionClima = (codigo) => CODIGOS_METEO_DESCRIPCION[codigo] || 'Condiciones no disponibles';

    const CLIMA_IMAGENES = {
      despejado: 'assets/clima-despejado.svg',
      parcial: 'assets/clima-parcial.svg',
      nublado: 'assets/clima-nublado.svg',
      lluvia: 'assets/clima-lluvia.svg',
      tormenta: 'assets/clima-tormenta.svg',
      nieve: 'assets/clima-nieve.svg',
      niebla: 'assets/clima-niebla.svg'
    };

    const CLIMA_RECURSOS = {
      despejado: { emoji: '☀️', imagen: CLIMA_IMAGENES.despejado, descripcion: 'Cielo despejado' },
      parcial: { emoji: '🌤️', imagen: CLIMA_IMAGENES.parcial, descripcion: 'Parcialmente nublado' },
      nublado: { emoji: '☁️', imagen: CLIMA_IMAGENES.nublado, descripcion: 'Nublado' },
      niebla: { emoji: '🌫️', imagen: CLIMA_IMAGENES.niebla, descripcion: 'Niebla' },
      lluvia: { emoji: '🌧️', imagen: CLIMA_IMAGENES.lluvia, descripcion: 'Lluvia' },
      tormenta: { emoji: '⛈️', imagen: CLIMA_IMAGENES.tormenta, descripcion: 'Tormenta' },
      nieve: { emoji: '❄️', imagen: CLIMA_IMAGENES.nieve, descripcion: 'Nieve' }
    };

    const ICONOS_CLIMA = {
      0: CLIMA_RECURSOS.despejado,
      1: CLIMA_RECURSOS.parcial,
      2: CLIMA_RECURSOS.parcial,
      3: CLIMA_RECURSOS.nublado,
      45: CLIMA_RECURSOS.niebla,
      48: CLIMA_RECURSOS.niebla,
      51: CLIMA_RECURSOS.lluvia,
      53: CLIMA_RECURSOS.lluvia,
      55: CLIMA_RECURSOS.lluvia,
      61: CLIMA_RECURSOS.lluvia,
      63: CLIMA_RECURSOS.lluvia,
      65: CLIMA_RECURSOS.lluvia,
      66: CLIMA_RECURSOS.lluvia,
      67: CLIMA_RECURSOS.lluvia,
      71: CLIMA_RECURSOS.nieve,
      73: CLIMA_RECURSOS.nieve,
      75: CLIMA_RECURSOS.nieve,
      80: CLIMA_RECURSOS.lluvia,
      81: CLIMA_RECURSOS.lluvia,
      82: CLIMA_RECURSOS.tormenta,
      95: CLIMA_RECURSOS.tormenta,
      96: CLIMA_RECURSOS.tormenta,
      99: CLIMA_RECURSOS.tormenta
    };

    const obtenerRecursoClima = (codigo) => ICONOS_CLIMA[codigo] || CLIMA_RECURSOS.lluvia;

    const construirClimaDesdeMeteo = (payload) => {
      const actual = payload?.current_weather;
      if (!actual) return null;
      const temperatura = Number(actual.temperature);
      const pronostico = [];
      const daily = payload?.daily;
      if (daily?.time && Array.isArray(daily.time)) {
        for (let i = 1; i < Math.min(daily.time.length, 5); i += 1) {
          pronostico.push({
            fecha: daily.time[i],
            max: daily.temperature_2m_max?.[i],
            min: daily.temperature_2m_min?.[i],
            descripcion: obtenerDescripcionClima(daily.weathercode?.[i])
          });
        }
      }
      return {
        temperatura: Number.isFinite(temperatura) ? temperatura : 0,
        descripcion: obtenerDescripcionClima(actual.weathercode),
        codigo: actual.weathercode,
        pronostico
      };
    };

    const METEO_COORDENADAS = { lat: 40.20732, lng: -3.57013 };

    const TIPOS_EVENTO_TEXTO = {
      fiesta_local: 'Festivo local',
      no_laborable: 'No laborable',
      no_lectivo: 'No lectivo',
      gastronomia: 'Gastronomía',
      deporte: 'Deporte',
      cultura: 'Cultura',
      general: 'Agenda'
    };

    const obtenerEtiquetaTipo = (tipo) => {
      const clave = tipo || 'general';
      const texto = TIPOS_EVENTO_TEXTO[clave] || clave.replace(/_/g, ' ');
      return { texto, tipo: clave };
    };

    const inicializarClima = async () => {
      if (state.climaCache && Date.now() - state.climaCache.timestamp < 10 * 60 * 1000) {
        renderClima(state.climaCache.data);
        return;
      }
      setClimaBusy(true);
      const controlador = new AbortController();
      state.climaTimeout = setTimeout(() => controlador.abort(), 8000);
      let datosClima = null;
      try {
        const params = new URLSearchParams({
          latitude: String(METEO_COORDENADAS.lat),
          longitude: String(METEO_COORDENADAS.lng),
          current_weather: 'true',
          timezone: 'Europe/Madrid'
        });
        const respuesta = await fetch(`https://api.open-meteo.com/v1/forecast?${params.toString()}`, {
          signal: controlador.signal
        });
        if (!respuesta.ok) throw new Error('Error meteorológico');
        const payload = await respuesta.json();
        datosClima = construirClimaDesdeMeteo(payload);
        if (datosClima) {
          state.climaCache = { timestamp: Date.now(), data: datosClima };
          localStorage.setItem('smv-clima-cache', JSON.stringify(state.climaCache));
        }
      } catch (error) {
        if (error.name !== 'AbortError') {
          logError(error, 'clima');
        }
      } finally {
        clearTimeout(state.climaTimeout);
      }
      if (datosClima) {
        renderClima(datosClima);
      } else {
        if (climaContenido) climaContenido.textContent = 'No se pudo obtener el clima. Intenta más tarde.';
        if (climaPronostico) climaPronostico.textContent = '';
        if (climaContenidoDetalle) climaContenidoDetalle.textContent = 'No se pudo obtener el clima. Intenta más tarde.';
        if (climaPronosticoDetalle) climaPronosticoDetalle.textContent = '';
      }
      setClimaBusy(false);
    };

    const solicitarActualizacionClima = () => {
      state.climaCache = null;
      inicializarClima();
    };

    if (btnActualizarClima) {
      btnActualizarClima.addEventListener('click', solicitarActualizacionClima);
    }

    if (btnActualizarClimaDetalle) {
      btnActualizarClimaDetalle.addEventListener('click', solicitarActualizacionClima);
    }

    const renderEventosResumen = (eventos, { mes, anio, seleccion = null, eventosDelDia = [] } = {}) => {
      if (!detalleEventos) return;
      const fechaBase = new Date(typeof anio === 'number' ? anio : new Date().getFullYear(), typeof mes === 'number' ? mes : new Date().getMonth(), 1);
      detalleEventos.textContent = '';
      const titulo = document.createElement('h3');
      titulo.textContent = `Agenda de ${fechaBase.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}`;
      detalleEventos.appendChild(titulo);
      if (seleccion && eventosDelDia.length) {
        const destacado = document.createElement('p');
        destacado.textContent = `Eventos del ${seleccion.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' })}`;
        detalleEventos.appendChild(destacado);
      }
      if (!eventos.length) {
        const vacio = document.createElement('p');
        vacio.textContent = 'No hay eventos para el mes seleccionado.';
        detalleEventos.appendChild(vacio);
        return;
      }
      const lista = document.createElement('ul');
      lista.className = 'eventos-lista';
      eventos
        .slice()
        .sort((a, b) => {
          const fechaA = a.fecha?.seconds ? new Date(a.fecha.seconds * 1000) : new Date(a.fecha);
          const fechaB = b.fecha?.seconds ? new Date(b.fecha.seconds * 1000) : new Date(b.fecha);
          return fechaA - fechaB;
        })
        .forEach((evento) => {
          const item = document.createElement('li');
          item.className = 'evento-item';
          const fechaEvento = evento.fecha?.seconds ? new Date(evento.fecha.seconds * 1000) : new Date(evento.fecha);
          if (seleccion && fechaEvento.toDateString() === seleccion.toDateString()) {
            item.classList.add('destacado');
          }
          const cabecera = document.createElement('strong');
          const tituloEvento = document.createElement('span');
          tituloEvento.textContent = evento.titulo;
          const badge = document.createElement('span');
          const infoTipo = obtenerEtiquetaTipo(evento.tipo);
          badge.className = 'evento-badge';
          badge.dataset.tipo = infoTipo.tipo;
          badge.textContent = infoTipo.texto;
          cabecera.append(tituloEvento, badge);
          const descripcion = document.createElement('p');
          descripcion.textContent = evento.descripcion || 'Sin descripción disponible.';
          const fechaTexto = document.createElement('small');
          fechaTexto.textContent = fechaEvento.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' });
          item.append(cabecera, descripcion, fechaTexto);
          if (evento.enlace && isSafeHttpUrl(evento.enlace)) {
            const enlace = document.createElement('a');
            enlace.className = 'btn btn-ghost btn-sm';
            enlace.textContent = 'Más información';
            if (safeLink(enlace, evento.enlace)) item.appendChild(enlace);
          }
          lista.appendChild(item);
        });
      detalleEventos.appendChild(lista);
    };

    const prepararCalendario = (eventos) => {
      state.eventos = eventos;
      const anios = new Set();
      const mesActualNum = mesActual.getMonth();
      const anioActual = mesActual.getFullYear();
      eventos.forEach((evento) => {
        const fecha = evento.fecha?.seconds ? new Date(evento.fecha.seconds * 1000) : new Date();
        anios.add(fecha.getFullYear());
      });
      [anioActual - 1, anioActual, anioActual + 1].forEach((anio) => anios.add(anio));
      selectAnio.textContent = '';
      Array.from(anios).sort((a, b) => a - b).forEach((anio) => {
        const option = document.createElement('option');
        option.value = String(anio);
        option.textContent = String(anio);
        if (anio === anioActual) option.selected = true;
        selectAnio.appendChild(option);
      });
      selectMes.textContent = '';
      const formatoMes = new Intl.DateTimeFormat('es', { month: 'long' });
      for (let m = 0; m < 12; m += 1) {
        const opcion = document.createElement('option');
        opcion.value = String(m);
        opcion.textContent = formatoMes.format(new Date(2024, m, 1));
        if (m === mesActualNum) opcion.selected = true;
        selectMes.appendChild(opcion);
      }
      renderCalendario();
    };

    const renderCalendario = () => {
      const mes = Number.parseInt(selectMes.value, 10);
      const anio = Number.parseInt(selectAnio.value, 10);
      const primerDia = new Date(anio, mes, 1);
      const ultimoDia = new Date(anio, mes + 1, 0);
      const dias = [];
      const offset = primerDia.getDay() === 0 ? 6 : primerDia.getDay() - 1;
      for (let i = 0; i < offset; i += 1) dias.push(null);
      for (let d = 1; d <= ultimoDia.getDate(); d += 1) dias.push(new Date(anio, mes, d));
      gridCalendario.textContent = '';
      const eventosMes = state.eventos.filter((evento) => {
        const fecha = evento.fecha?.seconds ? new Date(evento.fecha.seconds * 1000) : new Date();
        return fecha.getMonth() === mes && fecha.getFullYear() === anio;
      });
      dias.forEach((fecha) => {
        const celda = document.createElement('div');
        celda.className = 'dia-calendario';
        if (fecha) {
          const numero = document.createElement('strong');
          numero.textContent = String(fecha.getDate());
          celda.appendChild(numero);
          const delDia = eventosMes.filter((evento) => {
            const f = evento.fecha?.seconds ? new Date(evento.fecha.seconds * 1000) : new Date();
            return f.getDate() === fecha.getDate();
          });
          if (delDia.length) {
            celda.classList.add('evento');
            celda.dataset.tipo = delDia[0].tipo || 'general';
            const texto = document.createElement('span');
            texto.textContent = delDia[0].titulo;
            celda.appendChild(texto);
            celda.tabIndex = 0;
            celda.setAttribute('role', 'button');
            const abrir = () => mostrarEventosDia(fecha, delDia, eventosMes, mes, anio);
            celda.addEventListener('click', abrir);
            celda.addEventListener('keydown', (event) => {
              if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                abrir();
              }
            });
          }
        }
        gridCalendario.appendChild(celda);
      });
      renderEventosResumen(eventosMes, { mes, anio });
    };

    const mostrarEventosDia = (fecha, eventos, eventosMes, mes, anio) => {
      renderEventosResumen(eventosMes, { mes, anio, seleccion: fecha, eventosDelDia: eventos });
    };

    selectMes.addEventListener('change', renderCalendario);
    selectAnio.addEventListener('change', renderCalendario);

    const obtenerOrdenHistoria = (evento = {}) => {
      if (!evento) return Number.MAX_SAFE_INTEGER;
      const anio = Number(evento.anio ?? evento.year);
      if (Number.isFinite(anio)) return anio;
      if (evento.fecha?.seconds) {
        const fecha = new Date(evento.fecha.seconds * 1000);
        if (!Number.isNaN(fecha.getTime())) return fecha.getFullYear();
      }
      return Number.MAX_SAFE_INTEGER;
    };

    const formatearPeriodoHistoria = (evento = {}) => {
      if (typeof evento.periodo === 'string' && evento.periodo.trim()) return evento.periodo.trim();
      const anio = Number(evento.anio ?? evento.year);
      if (Number.isFinite(anio)) return anio.toString();
      if (evento.anio) return evento.anio.toString();
      if (evento.fecha?.seconds) {
        const fecha = new Date(evento.fecha.seconds * 1000);
        if (!Number.isNaN(fecha.getTime())) return fecha.getFullYear().toString();
      }
      return 'Sin fecha';
    };

    const obtenerImagenesHistoria = (evento = {}) => {
      const imagenes = [];
      if (isSafeImageURL(evento.imagen)) imagenes.push(evento.imagen);
      if (Array.isArray(evento.galeria)) {
        evento.galeria.forEach((url) => {
          if (isSafeImageURL(url) && !imagenes.includes(url)) {
            imagenes.push(url);
          }
        });
      }
      return imagenes;
    };

    const renderHistoria = (items = []) => {
      const contenedor = document.getElementById('listaHistoria');
      if (!contenedor) return;
      contenedor.textContent = '';
      const lista = Array.isArray(items) ? [...items] : [];
      if (!lista.length) {
        const vacio = document.createElement('p');
        vacio.className = 'lista-vacia';
        vacio.textContent = 'Aún no hay hitos históricos registrados. Usa el panel administrativo para añadir el primero.';
        contenedor.appendChild(vacio);
        return;
      }
      lista.sort((a, b) => obtenerOrdenHistoria(a) - obtenerOrdenHistoria(b));
      const timeline = document.createElement('ol');
      timeline.className = 'historia-timeline';
      timeline.setAttribute('role', 'list');
      timeline.setAttribute('aria-label', 'Línea de tiempo histórica de la localidad');
      lista.forEach((evento) => {
        const nodo = document.createElement('li');
        nodo.className = 'historia-item';
        if (evento?.id) nodo.dataset.id = evento.id;
        const tarjeta = document.createElement('article');
        tarjeta.className = 'historia-card';
        const header = document.createElement('header');
        const periodo = document.createElement('time');
        const periodoTexto = formatearPeriodoHistoria(evento);
        periodo.className = 'historia-periodo';
        periodo.textContent = periodoTexto;
        const anioNumero = Number(evento.anio ?? evento.year);
        if (Number.isFinite(anioNumero)) {
          periodo.dateTime = anioNumero.toString();
        }
        header.appendChild(periodo);
        const titulo = document.createElement('h3');
        titulo.textContent = evento.nombre || evento.titulo || 'Hito histórico';
        header.appendChild(titulo);
        tarjeta.appendChild(header);
        const descripcion = document.createElement('p');
        descripcion.textContent = evento.descripcion || 'Pronto añadiremos más detalles de este momento clave.';
        tarjeta.appendChild(descripcion);
        const imagenes = obtenerImagenesHistoria(evento);
        if (imagenes.length) {
          const media = document.createElement('div');
          media.className = 'historia-media';
          const principal = document.createElement('img');
          principal.src = imagenes[0];
          principal.alt = `Imagen histórica de ${titulo.textContent}`;
          principal.loading = 'lazy';
          media.appendChild(principal);
          tarjeta.appendChild(media);
          if (imagenes.length > 1) {
            const galeria = document.createElement('div');
            galeria.className = 'historia-galeria';
            imagenes.slice(1).forEach((src, indice) => {
              const foto = document.createElement('img');
              foto.src = src;
              foto.alt = `Detalle histórico ${titulo.textContent} (${indice + 2})`;
              foto.loading = 'lazy';
              galeria.appendChild(foto);
            });
            tarjeta.appendChild(galeria);
          }
        }
        if (Array.isArray(evento.etiquetas) && evento.etiquetas.length) {
          const etiquetas = document.createElement('div');
          etiquetas.className = 'historia-etiquetas';
          evento.etiquetas.forEach((tag) => {
            const span = document.createElement('span');
            span.textContent = tag;
            etiquetas.appendChild(span);
          });
          tarjeta.appendChild(etiquetas);
        }
        if (evento.enlace && isSafeHttpUrl(evento.enlace)) {
          const acciones = document.createElement('div');
          acciones.className = 'historia-acciones';
          const enlace = document.createElement('a');
          enlace.className = 'btn btn-ghost btn-sm';
          enlace.textContent = 'Ampliar información';
          if (safeLink(enlace, evento.enlace)) {
            acciones.appendChild(enlace);
            tarjeta.appendChild(acciones);
          }
        }
        nodo.appendChild(tarjeta);
        timeline.appendChild(nodo);
      });
      contenedor.appendChild(timeline);
    };

    const recargarHistoria = async () => {
      if (!firebaseDisponible || !db) {
        renderHistoria(state.historia || []);
        return;
      }
      try {
        const snap = await getDocs(query(collection(db, 'historia'), orderBy('anio', 'asc'), limit(100)));
        state.historia = snap.docs.map((d) => ({ id: d.id, ...d.data() }));
        renderHistoria(state.historia);
      } catch (error) {
        manejarErrorFirebase(error, 'historia');
        renderHistoria(state.historia || []);
      }
    };

    const actualizarCamposAdmin = () => {
      if (!formAdmin?.coleccion) return;
      const coleccionActual = formAdmin.coleccion.value;
      const esHistoria = coleccionActual === 'historia';
      gruposAdminUbicacion.forEach((grupo) => {
        if (!grupo) return;
        grupo.hidden = esHistoria;
        grupo.querySelectorAll('input, textarea, select, button').forEach((campo) => {
          campo.disabled = esHistoria;
        });
      });
      gruposAdminHistoria.forEach((grupo) => {
        if (!grupo) return;
        grupo.hidden = !esHistoria;
        grupo.querySelectorAll('input, textarea, select, button').forEach((campo) => {
          campo.disabled = !esHistoria;
        });
      });
    };
    if (formAdmin?.coleccion) {
      formAdmin.coleccion.addEventListener('change', actualizarCamposAdmin);
      actualizarCamposAdmin();
    }
    const abrirModalAdmin = (item = null, coleccion = 'lugares') => {
      if (!auth?.currentUser) {
        mostrarToast('Debes iniciar sesión');
        return;
      }
      if (!formAdmin) return;
      formAdmin.reset();
      const esEdicion = Boolean(item);
      formAdmin.dataset.id = esEdicion && item?.id ? item.id : '';
      const coleccionActual = item?.coleccion || coleccion;
      formAdmin.dataset.coleccion = coleccionActual;
      formAdmin.dataset.imagenActual = '';
      formAdmin.dataset.imagenPath = '';
      formAdmin.dataset.galeriaMeta = '[]';
      if (tituloModalAdmin) {
        tituloModalAdmin.textContent = esEdicion ? 'Editar contenido' : 'Nuevo contenido';
      }
      if (formAdmin.coleccion) formAdmin.coleccion.value = coleccionActual;
      if (item) {
        if (formAdmin.nombre) formAdmin.nombre.value = item.nombre || '';
        if (formAdmin.descripcion) formAdmin.descripcion.value = item.descripcion || '';
        const imagenInicial = obtenerImagenPrincipal(item) || '';
        if (formAdmin.imagen) formAdmin.imagen.value = imagenInicial;
        formAdmin.dataset.imagenActual = imagenInicial;
        if (item?.imagenPath) formAdmin.dataset.imagenPath = item.imagenPath;
        if (formAdmin.etiquetas) {
          formAdmin.etiquetas.value = Array.isArray(item.etiquetas) ? item.etiquetas.join(', ') : '';
        }
        if (formAdmin.enlace) formAdmin.enlace.value = item.enlace || '';
        const metaGaleria = Array.isArray(item?.galeria)
          ? item.galeria.map((url, index) => ({
              url,
              path: Array.isArray(item?.galeriaPaths) ? item.galeriaPaths[index] || '' : ''
            }))
          : [];
        formAdmin.dataset.galeriaMeta = JSON.stringify(metaGaleria);
      } else if (formAdmin.imagen) {
        formAdmin.imagen.value = '';
      }
      if (inputDireccion) inputDireccion.value = item?.direccion || '';
      if (inputLatitud) inputLatitud.value = '';
      if (inputLongitud) inputLongitud.value = '';
      const coordsExistentes = item ? obtenerCoordenadas(item) : null;
      if (coordsExistentes) {
        if (inputLatitud) inputLatitud.value = Number(coordsExistentes.lat).toFixed(6);
        if (inputLongitud) inputLongitud.value = Number(coordsExistentes.lng).toFixed(6);
      }
      if (inputAnioHistoria) {
        inputAnioHistoria.value = item?.anio != null ? Number(item.anio) : '';
      }
      if (inputGaleria) {
        const urlsGaleria = Array.isArray(item?.galeria) ? item.galeria.filter((url) => typeof url === 'string') : [];
        inputGaleria.value = urlsGaleria.join('\n');
      }
      if (inputArchivosGaleria) inputArchivosGaleria.value = '';
      actualizarCamposAdmin();
      modalAdmin.classList.add('visible');
      modalAdmin.setAttribute('aria-hidden', 'false');
      formAdmin.querySelector('input, select, textarea').focus();
    };

    const cerrarModalAdmin = () => {
      modalAdmin.classList.remove('visible');
      modalAdmin.setAttribute('aria-hidden', 'true');
      formAdmin.removeAttribute('data-id');
      formAdmin.removeAttribute('data-coleccion');
      delete formAdmin.dataset.imagenActual;
      delete formAdmin.dataset.imagenPath;
      delete formAdmin.dataset.galeriaMeta;
      if (inputAnioHistoria) inputAnioHistoria.value = '';
    };

    const obtenerMetaGaleriaFormulario = () => {
      if (!formAdmin) return [];
      const crudo = formAdmin.dataset.galeriaMeta;
      if (!crudo) return [];
      try {
        const parsed = JSON.parse(crudo);
        if (!Array.isArray(parsed)) return [];
        return parsed
          .map((entrada) => ({
            url: typeof entrada?.url === 'string' ? entrada.url : '',
            path: typeof entrada?.path === 'string' ? entrada.path : ''
          }))
          .filter((entrada) => entrada.url && entrada.path);
      } catch (error) {
        console.warn('galeria-meta-parse', error);
        return [];
      }
    };

    const inicializarTogglesPassword = () => {
      document.querySelectorAll('.toggle-password').forEach((btn) => {
        const targetId = btn.dataset.target;
        const input = targetId ? document.getElementById(targetId) : null;
        if (!input) return;
        btn.addEventListener('click', () => {
          const esVisible = input.type === 'text';
          input.type = esVisible ? 'password' : 'text';
          btn.textContent = esVisible ? '👁' : '🙈';
          btn.setAttribute('aria-label', esVisible ? 'Mostrar contraseña' : 'Ocultar contraseña');
        });
      });
    };

    if (btnAbrirModalAdmin) {
      btnAbrirModalAdmin.addEventListener('click', () => {
        if (!auth?.currentUser) {
          mostrarToast('Debes iniciar sesión');
          return;
        }
        if (!puedeUsarPanelAdmin()) {
          mostrarToast('Necesitas un correo verificado y rol de administrador.');
          return;
        }
        abrirModalAdmin();
      });
    }
    btnCerrarModalAdmin.addEventListener('click', cerrarModalAdmin);
    registrarModalAccesible(modalAdmin, cerrarModalAdmin);
    if (btnInicializarSemilla) {
      btnInicializarSemilla.addEventListener('click', inicializarDatosSemilla);
    }
    let bienvenidaAutoMostrada = false;
    let bienvenidaProgramada = null;

    const cancelarBienvenidaProgramada = () => {
      if (bienvenidaProgramada) {
        clearTimeout(bienvenidaProgramada);
        bienvenidaProgramada = null;
      }
    };

    const abrirBienvenida = () => {
      if (!modalBienvenida) return;
      abrirModalGenerico(modalBienvenida);
    };

    const programarBienvenidaInvitado = () => {
      if (bienvenidaAutoMostrada || bienvenidaProgramada) return;
      bienvenidaProgramada = setTimeout(() => {
        if (!state.user) {
          abrirBienvenida();
          bienvenidaAutoMostrada = true;
        }
        bienvenidaProgramada = null;
      }, 700);
    };

    const abrirBienvenidaManual = () => {
      cancelarBienvenidaProgramada();
      bienvenidaAutoMostrada = true;
      abrirBienvenida();
    };

    const mostrarBienvenidaInvitado = () => {
      programarBienvenidaInvitado();
    };

    const cerrarModalBienvenida = (param) => {
      const opciones = param && typeof param.preventDefault === 'function' ? {} : param || {};
      if (param && typeof param.preventDefault === 'function') param.preventDefault();
      cancelarBienvenidaProgramada();
      cerrarModalGenerico(modalBienvenida);
      bienvenidaAutoMostrada = true;
      if (opciones.mantenerEstado) return;
      setUserRole(USER_ROLES.INVITADO);
      panelCuenta.disabled = true;
      actualizarPanelCuentaProtegido();
      actualizarProteccionesResena();
    };

    if (btnLogin) btnLogin.addEventListener('click', abrirBienvenidaManual);
    if (btnLoginResena) btnLoginResena.addEventListener('click', abrirBienvenidaManual);
    if (btnLoginAjustes) btnLoginAjustes.addEventListener('click', abrirBienvenidaManual);
    btnCerrarModalBienvenida.addEventListener('click', cerrarModalBienvenida);
    registrarModalAccesible(modalBienvenida, cerrarModalBienvenida);

    const mostrarCaptchaSiNecesario = (intentos = 0) => {
      if (!captchaLogin) return;
      const activar = intentos >= 3;
      captchaLogin.hidden = !activar;
      if (!activar && checkCaptchaLogin) {
        checkCaptchaLogin.checked = false;
      }
    };

    const limpiarFormularioLogin = () => {
      if (formLogin) formLogin.reset();
      mostrarMensajeCampo(errorLoginEmail, '');
      mostrarMensajeCampo(errorLoginPassword, '');
      setIndicadorValidacion(indicadorLoginEmail, 'neutral');
      setIndicadorValidacion(indicadorLoginPassword, 'neutral');
      toggleAlertaCuenta(false);
      setBotonCargando(btnSubmitLogin, false);
      mostrarCaptchaSiNecesario(0);
    };

    const abrirLoginModal = () => {
      cerrarModalGenerico(modalBienvenida);
      limpiarFormularioLogin();
      abrirModalGenerico(modalLogin);
    };

    const cerrarLogin = () => {
      limpiarFormularioLogin();
      cerrarModalGenerico(modalLogin);
    };

    btnLoginCorreo.addEventListener('click', abrirLoginModal);
    if (btnCerrarModalLogin) btnCerrarModalLogin.addEventListener('click', cerrarLogin);
    registrarModalAccesible(modalLogin, cerrarLogin);

    const limpiarFormularioRegistro = () => {
      if (formRegistro) formRegistro.reset();
      mostrarMensajeCampo(errorRegistroEmail, '');
      mostrarMensajeCampo(errorRegistroPassword, '');
      mostrarMensajeCampo(errorRegistroConfirm, '');
      mostrarMensajeCampo(errorRegistroTerminos, '');
      if (mensajeRegistroExito) mensajeRegistroExito.hidden = true;
      setIndicadorValidacion(indicadorRegistroEmail, 'neutral');
      actualizarBarraFortaleza(barraFuerzaRegistro, '');
      setBotonCargando(btnSubmitRegistro, false);
    };

    const abrirRegistroModal = () => {
      cerrarModalGenerico(modalBienvenida);
      cerrarLogin();
      limpiarFormularioRegistro();
      abrirModalGenerico(modalRegistro);
    };

    const cerrarRegistro = () => {
      limpiarFormularioRegistro();
      cerrarModalGenerico(modalRegistro);
    };

    if (btnCerrarModalRegistro) btnCerrarModalRegistro.addEventListener('click', cerrarRegistro);
    registrarModalAccesible(modalRegistro, cerrarRegistro);

    if (btnAbrirRegistroDesdeLogin) btnAbrirRegistroDesdeLogin.addEventListener('click', abrirRegistroModal);
    if (btnIrRegistroDesdeLogin) btnIrRegistroDesdeLogin.addEventListener('click', abrirRegistroModal);

    const limpiarFormularioRecuperacion = () => {
      if (formRecuperacion) formRecuperacion.reset();
      mostrarMensajeCampo(errorRecuperacion, '');
      mostrarMensajeCampo(exitoRecuperacion, '');
      setBotonCargando(btnEnviarRecuperacion, false);
    };

    const abrirRecuperacion = () => {
      cerrarLogin();
      limpiarFormularioRecuperacion();
      abrirModalGenerico(modalRecuperacion);
    };

    const cerrarRecuperacion = () => {
      limpiarFormularioRecuperacion();
      cerrarModalGenerico(modalRecuperacion);
    };

    if (btnOlvidoPassword) btnOlvidoPassword.addEventListener('click', abrirRecuperacion);
    if (btnCerrarModalRecuperacion) btnCerrarModalRecuperacion.addEventListener('click', cerrarRecuperacion);
    registrarModalAccesible(modalRecuperacion, cerrarRecuperacion);

    const limpiarFormularioCambioEmail = () => {
      if (formCambioEmail) formCambioEmail.reset();
      mostrarMensajeCampo(errorCambioEmail, '');
      setIndicadorValidacion(indicadorNuevoEmail, 'neutral');
      setBotonCargando(btnSubmitCambioEmail, false);
    };

    const cerrarCambioEmail = () => {
      limpiarFormularioCambioEmail();
      cerrarModalGenerico(modalCambioEmail);
    };

    const abrirCambioEmail = () => {
      if (!state.user) {
        mostrarEstadoCuenta('Inicia sesión para cambiar tu email.', true);
        return;
      }
      limpiarFormularioCambioEmail();
      abrirModalGenerico(modalCambioEmail);
    };

    if (btnAbrirCambioEmail) btnAbrirCambioEmail.addEventListener('click', abrirCambioEmail);
    if (btnCerrarModalCambioEmail) btnCerrarModalCambioEmail.addEventListener('click', cerrarCambioEmail);
    registrarModalAccesible(modalCambioEmail, cerrarCambioEmail);

    const limpiarFormularioPassword = () => {
      if (!formPassword) return;
      formPassword.reset();
      mostrarMensajeCampo(errorPasswordActual, '');
      mostrarMensajeCampo(errorNuevaPassword, '');
      mostrarMensajeCampo(errorConfirmarPassword, '');
      actualizarBarraFortaleza(barraFuerzaPassword, '');
      setBotonCargando(btnActualizarPassword, false);
    };

    const cerrarCambioPassword = () => {
      limpiarFormularioPassword();
      cerrarModalGenerico(modalCambioPassword);
    };

    const abrirCambioPassword = () => {
      if (!state.user) {
        mostrarEstadoCuenta('Inicia sesión para cambiar la contraseña.', true);
        return;
      }
      limpiarFormularioPassword();
      abrirModalGenerico(modalCambioPassword);
    };

    if (btnAbrirCambioPassword) btnAbrirCambioPassword.addEventListener('click', abrirCambioPassword);
    if (btnCerrarModalCambioPassword) btnCerrarModalCambioPassword.addEventListener('click', cerrarCambioPassword);
    registrarModalAccesible(modalCambioPassword, cerrarCambioPassword);

    const pasosEliminarCuenta = modalEliminarCuenta
      ? Array.from(modalEliminarCuenta.querySelectorAll('.paso-eliminar'))
      : [];

    const mostrarPasoEliminar = (paso = 'aviso') => {
      pasosEliminarCuenta.forEach((elemento) => {
        const activo = elemento.dataset.paso === paso;
        if (activo) {
          elemento.removeAttribute('hidden');
        } else {
          elemento.setAttribute('hidden', '');
        }
      });
    };

    const limpiarFormularioEliminar = () => {
      if (formEliminarCuenta) formEliminarCuenta.reset();
      mostrarMensajeCampo(errorPasswordEliminar, '');
      mostrarMensajeCampo(errorConfirmacionEliminar, '');
      mostrarMensajeCampo(errorEliminarCuenta, '');
      setBotonCargando(btnConfirmarEliminarCuenta, false);
      if (btnConfirmarEliminarCuenta) btnConfirmarEliminarCuenta.disabled = true;
    };

    const cerrarModalEliminar = () => {
      limpiarFormularioEliminar();
      mostrarPasoEliminar('aviso');
      cerrarModalGenerico(modalEliminarCuenta);
    };

    const abrirModalEliminar = () => {
      if (!firebaseDisponible || !auth || !auth.currentUser) {
        mostrarEstadoCuenta('Inicia sesión para solicitar la eliminación de tu cuenta.', true);
        return;
      }
      limpiarFormularioEliminar();
      mostrarPasoEliminar('aviso');
      abrirModalGenerico(modalEliminarCuenta);
    };

    const actualizarEstadoConfirmacionEliminar = () => {
      if (!btnConfirmarEliminarCuenta) return;
      const confirmacion = inputConfirmacionEliminar
        ? sanitizeText(inputConfirmacionEliminar.value || '').toUpperCase().trim()
        : '';
      if (inputConfirmacionEliminar) inputConfirmacionEliminar.value = confirmacion;
      const password = inputPasswordEliminar?.value || '';
      const coincide = confirmacion === 'ELIMINAR';
      btnConfirmarEliminarCuenta.disabled = !(coincide && password.length > 0);
      if (confirmacion && !coincide) {
        mostrarMensajeCampo(errorConfirmacionEliminar, 'Debes escribir ELIMINAR con mayúsculas.');
      } else {
        mostrarMensajeCampo(errorConfirmacionEliminar, '');
      }
    };

    const registrarEventosEliminarCuenta = () => {
      if (btnEliminarCuenta) btnEliminarCuenta.addEventListener('click', abrirModalEliminar);
      if (btnCerrarModalEliminar) btnCerrarModalEliminar.addEventListener('click', cerrarModalEliminar);
      if (btnCancelarEliminarCuenta) btnCancelarEliminarCuenta.addEventListener('click', cerrarModalEliminar);
      if (btnVolverPasoEliminar) {
        btnVolverPasoEliminar.addEventListener('click', () => {
          mostrarPasoEliminar('aviso');
          btnContinuarEliminar?.focus();
        });
      }
      if (btnContinuarEliminar) {
        btnContinuarEliminar.addEventListener('click', () => {
          mostrarPasoEliminar('confirmacion');
          inputPasswordEliminar?.focus();
        });
      }
      if (inputPasswordEliminar) {
        inputPasswordEliminar.addEventListener('input', () => {
          mostrarMensajeCampo(errorPasswordEliminar, '');
          actualizarEstadoConfirmacionEliminar();
        });
      }
      if (inputConfirmacionEliminar) {
        inputConfirmacionEliminar.addEventListener('input', actualizarEstadoConfirmacionEliminar);
      }
      if (formEliminarCuenta) {
        formEliminarCuenta.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!state.user) {
            mostrarEstadoCuenta('Inicia sesión para eliminar tu cuenta.', true);
            return;
          }
          const password = inputPasswordEliminar?.value || '';
          const confirmacion = sanitizeText(inputConfirmacionEliminar?.value || '').toUpperCase().trim();
          let valido = true;
          if (!password) {
            mostrarMensajeCampo(errorPasswordEliminar, 'Introduce tu contraseña actual.');
            valido = false;
          }
          if (confirmacion !== 'ELIMINAR') {
            mostrarMensajeCampo(errorConfirmacionEliminar, 'Debes escribir ELIMINAR para continuar.');
            valido = false;
          }
          if (!valido) return;
          setBotonCargando(btnConfirmarEliminarCuenta, true, 'Eliminando…');
          try {
            await authFunctions.deleteAccount(password);
            cerrarModalEliminar();
            mostrarToast('Tu cuenta y datos asociados se eliminaron correctamente.');
          } catch (error) {
            if (error.code === 'auth/wrong-password') {
              mostrarMensajeCampo(errorPasswordEliminar, 'Contraseña incorrecta.');
            } else if (error.code === 'auth/requires-recent-login') {
              mostrarMensajeCampo(
                errorEliminarCuenta,
                'Tu sesión caducó. Vuelve a iniciar sesión y repite el proceso.'
              );
            } else if (error.code === 'auth/no-current-user') {
              mostrarMensajeCampo(errorEliminarCuenta, 'No hay una sesión activa.');
            } else if (error.code === 'auth/no-email') {
              mostrarMensajeCampo(errorEliminarCuenta, 'Tu cuenta no tiene un email asociado.');
            } else {
              mostrarMensajeCampo(errorEliminarCuenta, 'No se pudo eliminar la cuenta. Intenta más tarde.');
            }
            logError(error, 'eliminar-cuenta');
          } finally {
            setBotonCargando(btnConfirmarEliminarCuenta, false);
          }
        });
      }
      registrarModalAccesible(modalEliminarCuenta, cerrarModalEliminar);
      limpiarFormularioEliminar();
      mostrarPasoEliminar('aviso');
    };

    registrarEventosEliminarCuenta();

    const cerrarModalCerrarSesiones = () => {
      setBotonCargando(btnConfirmarCerrarSesiones, false);
      cerrarModalGenerico(modalCerrarSesiones);
    };

    const abrirModalCerrarSesiones = () => {
      if (!state.user) {
        mostrarEstadoCuenta('Inicia sesión para administrar tus sesiones.', true);
        return;
      }
      abrirModalGenerico(modalCerrarSesiones);
    };

    const cerrarSesionesGlobales = async () => {
      if (!firebaseDisponible || !auth || !auth.currentUser) {
        mostrarEstadoCuenta('Conéctate para cerrar tus sesiones.', true);
        cerrarModalCerrarSesiones();
        return;
      }
      setBotonCargando(btnConfirmarCerrarSesiones, true);
      try {
        await getIdToken(auth.currentUser, true);
        await signOut(auth);
        mostrarToast('Sesiones cerradas. Inicia sesión de nuevo en este dispositivo.');
      } catch (error) {
        mostrarEstadoCuenta('No se pudieron cerrar las sesiones. Intenta más tarde.', true);
        logError(error, 'cerrar-sesiones');
      } finally {
        cerrarModalCerrarSesiones();
      }
    };

    if (btnCerrarModalCerrarSesiones) btnCerrarModalCerrarSesiones.addEventListener('click', cerrarModalCerrarSesiones);
    if (btnCancelarCerrarSesiones) btnCancelarCerrarSesiones.addEventListener('click', cerrarModalCerrarSesiones);
    registrarModalAccesible(modalCerrarSesiones, cerrarModalCerrarSesiones);
    if (btnCerrarSesiones) btnCerrarSesiones.addEventListener('click', abrirModalCerrarSesiones);
    if (btnConfirmarCerrarSesiones) btnConfirmarCerrarSesiones.addEventListener('click', cerrarSesionesGlobales);

    let consultaLoginEmailId = 0;
    let consultaRegistroEmailId = 0;
    let consultaCambioEmailId = 0;

    const comprobarEmailLogin = async () => {
      if (!formLogin?.email) return;
      const email = formLogin.email.value.trim();
      if (!esEmailValido(email)) {
        setIndicadorValidacion(indicadorLoginEmail, 'neutral');
        toggleAlertaCuenta(false);
        return;
      }
      const id = ++consultaLoginEmailId;
      const existe = await verificarCuentaExiste(email);
      if (consultaLoginEmailId !== id) return;
      if (existe === false) {
        setIndicadorValidacion(indicadorLoginEmail, 'error');
        toggleAlertaCuenta(true);
      } else if (existe === true) {
        setIndicadorValidacion(indicadorLoginEmail, 'ok');
        toggleAlertaCuenta(false);
      }
    };

    const comprobarEmailRegistro = async () => {
      if (!inputRegistroEmail) return;
      const email = inputRegistroEmail.value.trim();
      if (!esEmailValido(email)) {
        setIndicadorValidacion(indicadorRegistroEmail, 'neutral');
        return;
      }
      const id = ++consultaRegistroEmailId;
      const existe = await verificarCuentaExiste(email);
      if (consultaRegistroEmailId !== id) return;
      if (existe) {
        mostrarMensajeCampo(errorRegistroEmail, 'Ya existe una cuenta con este email.');
        setIndicadorValidacion(indicadorRegistroEmail, 'error');
      } else if (existe === false) {
        mostrarMensajeCampo(errorRegistroEmail, '');
        setIndicadorValidacion(indicadorRegistroEmail, 'ok');
      }
    };

    const comprobarNuevoEmail = async () => {
      if (!inputNuevoEmail) return;
      const email = inputNuevoEmail.value.trim();
      if (!esEmailValido(email)) {
        setIndicadorValidacion(indicadorNuevoEmail, 'neutral');
        return;
      }
      if (state.user?.email && state.user.email.toLowerCase() === email.toLowerCase()) {
        mostrarMensajeCampo(errorCambioEmail, 'Introduce un email distinto al actual.');
        setIndicadorValidacion(indicadorNuevoEmail, 'error');
        return;
      }
      const id = ++consultaCambioEmailId;
      const existe = await verificarCuentaExiste(email);
      if (consultaCambioEmailId !== id) return;
      if (existe) {
        mostrarMensajeCampo(errorCambioEmail, 'Ya existe una cuenta con ese email.');
        setIndicadorValidacion(indicadorNuevoEmail, 'error');
      } else if (existe === false) {
        mostrarMensajeCampo(errorCambioEmail, '');
        setIndicadorValidacion(indicadorNuevoEmail, 'ok');
      }
    };

    const solicitarEmailVerificacion = async (boton = btnVerificarCorreo) => {
      if (!firebaseDisponible || !auth || !auth.currentUser) {
        mostrarEstadoCuenta('Conéctate para solicitar un correo de verificación.', true);
        return;
      }

      // Rate limiting
      const ahora = Date.now();
      if (ahora - ultimoEnvioEmail < COOLDOWN_EMAIL) {
        const segundosRestantes = Math.ceil((COOLDOWN_EMAIL - (ahora - ultimoEnvioEmail)) / 1000);
        const mensaje = `⏱️ Espera ${segundosRestantes} segundos antes de solicitar otro email`;

        if (boton === btnVerificarCorreo) {
          mostrarEstadoCuenta(mensaje, true);
        } else {
          mostrarToast(mensaje);
        }
        return;
      }

      setBotonCargando(boton, true);

      try {
        await sendEmailVerification(auth.currentUser);
        ultimoEnvioEmail = Date.now();

        const mensaje = `✅ Email enviado correctamente

📧 Revisa tu bandeja de entrada

⚠️ IMPORTANTE para Gmail:
• Revisa SPAM/Correo no deseado
• Revisa pestaña "Promociones"
• Remitente: Turismo San Martín de la Vega

Si no llega en 5 minutos, vuelve a intentar.`;

        if (boton === btnVerificarCorreo) {
          mostrarEstadoCuenta('Email de verificación enviado. Revisa tu bandeja de entrada.');
        } else {
          alert(mensaje);
        }
        iniciarMonitoreoVerificacion();
      } catch (error) {
        let mensaje = 'No se pudo enviar el correo. Intenta más tarde.';
        if (error.code === 'auth/too-many-requests') {
          mensaje = '⚠️ Demasiados intentos. Espera 5-10 minutos.';
        }

        if (boton === btnVerificarCorreo) {
          mostrarEstadoCuenta(mensaje, true);
        } else {
          alert(mensaje);
        }

        logError(error, 'verificacion');
      } finally {
        setBotonCargando(boton, false);
      }
    };

    const detenerMonitoreoVerificacion = () => {
      if (monitoreoVerificacionInterval) {
        clearInterval(monitoreoVerificacionInterval);
        monitoreoVerificacionInterval = null;
      }
      intentosVerificacion = 0;
      verificacionEnCurso = false;
    };

    const verificarEstadoEmail = async () => {
      const usuarioActual = auth?.currentUser;
      if (!usuarioActual) {
        detenerMonitoreoVerificacion();
        return false;
      }
      if (usuarioActual.emailVerified) {
        if (state.user && !state.user.emailVerificado) {
          state.user.emailVerificado = true;
          actualizarBannerVerificacion(false);
          actualizarBotonVerificacion();
          actualizarProteccionesResena();
          mostrarToast('¡Email verificado correctamente! Ya puedes escribir resenas.');
        }
        detenerMonitoreoVerificacion();
        return true;
      }
      if (verificacionEnCurso) return false;
      verificacionEnCurso = true;
      try {
        await usuarioActual.reload();
        const verificado = Boolean(usuarioActual.emailVerified);
        if (verificado && state.user && !state.user.emailVerificado) {
          state.user.emailVerificado = true;
          actualizarBannerVerificacion(false);
          actualizarBotonVerificacion();
          actualizarProteccionesResena();
          mostrarToast('¡Email verificado correctamente! Ya puedes escribir resenas.');
        }
        if (verificado) {
          detenerMonitoreoVerificacion();
        }
        return verificado;
      } catch (error) {
        logError(error, 'verificar-estado-email');
        return false;
      } finally {
        verificacionEnCurso = false;
      }
    };

    const iniciarMonitoreoVerificacion = () => {
      if (monitoreoVerificacionInterval) return;
      if (!auth?.currentUser) return;
      if (auth.currentUser.emailVerified || state.user?.emailVerificado) return;
      intentosVerificacion = 0;
      monitoreoVerificacionInterval = setInterval(async () => {
        if (!auth?.currentUser) {
          detenerMonitoreoVerificacion();
          return;
        }
        intentosVerificacion += 1;
        const verificado = await verificarEstadoEmail();
        if (verificado || intentosVerificacion >= MAX_INTENTOS_VERIFICACION) {
          detenerMonitoreoVerificacion();
        }
      }, INTERVALO_VERIFICACION_MS);
    };

    const iniciarSesionInvitado = () => {
      cerrarModalBienvenida();
      state.user = null;
      if (estadoCuenta) estadoCuenta.hidden = true;
      actualizarBotonVerificacion();
      mostrarToast('Estás navegando como invitado. Inicia sesión para publicar resenas.');
    };

    if (formLogin?.email) {
      formLogin.email.addEventListener('input', () => {
        mostrarMensajeCampo(errorLoginEmail, '');
        toggleAlertaCuenta(false);
        const valido = esEmailValido(formLogin.email.value);
        setIndicadorValidacion(indicadorLoginEmail, valido ? 'ok' : 'neutral');
      });
      formLogin.email.addEventListener('blur', comprobarEmailLogin);
    }

    if (formLogin?.password) {
      formLogin.password.addEventListener('input', () => {
        mostrarMensajeCampo(errorLoginPassword, '');
        const valido = formLogin.password.value.length >= 8;
        setIndicadorValidacion(indicadorLoginPassword, valido ? 'ok' : 'neutral');
      });
    }

    if (inputRegistroEmail) {
      inputRegistroEmail.addEventListener('input', () => {
        mostrarMensajeCampo(errorRegistroEmail, '');
        setIndicadorValidacion(indicadorRegistroEmail, esEmailValido(inputRegistroEmail.value) ? 'ok' : 'neutral');
      });
      inputRegistroEmail.addEventListener('blur', comprobarEmailRegistro);
    }

    if (inputRegistroPassword) {
      inputRegistroPassword.addEventListener('input', () => {
        mostrarMensajeCampo(errorRegistroPassword, '');
        actualizarBarraFortaleza(barraFuerzaRegistro, inputRegistroPassword.value);
      });
    }

    if (inputRegistroPasswordConfirm) {
      inputRegistroPasswordConfirm.addEventListener('input', () => {
        if (inputRegistroPasswordConfirm.value === inputRegistroPassword.value) {
          mostrarMensajeCampo(errorRegistroConfirm, '');
        }
      });
    }

    if (inputRecuperacionEmail) {
      inputRecuperacionEmail.addEventListener('input', () => {
        mostrarMensajeCampo(errorRecuperacion, '');
        mostrarMensajeCampo(exitoRecuperacion, '');
      });
    }

    if (inputNuevoEmail) {
      inputNuevoEmail.addEventListener('input', () => {
        mostrarMensajeCampo(errorCambioEmail, '');
        comprobarNuevoEmail();
      });
      inputNuevoEmail.addEventListener('blur', comprobarNuevoEmail);
    }

    if (inputPasswordEmail) {
      inputPasswordEmail.addEventListener('input', () => mostrarMensajeCampo(errorCambioEmail, ''));
    }

    if (inputPasswordActual) {
      inputPasswordActual.addEventListener('input', () => mostrarMensajeCampo(errorPasswordActual, ''));
    }

    if (inputNuevaPassword) {
      inputNuevaPassword.addEventListener('input', () => {
        mostrarMensajeCampo(errorNuevaPassword, '');
        actualizarBarraFortaleza(barraFuerzaPassword, inputNuevaPassword.value);
      });
    }

    if (inputConfirmarPassword) {
      inputConfirmarPassword.addEventListener('input', () => {
        if (inputConfirmarPassword.value === inputNuevaPassword?.value) {
          mostrarMensajeCampo(errorConfirmarPassword, '');
        }
      });
    }

    const iniciarConProveedor = async (provider, nombre, opciones = {}) => {
      if (!provider || !firebaseDisponible || !auth) {
        mostrarToast(`Conéctate para usar el acceso con ${nombre}.`);
        return;
      }
      const { metodo = 'popup', boton = null } = opciones;
      if (boton) {
        const mensaje = metodo === 'redirect' ? 'Redirigiendo…' : 'Conectando…';
        setBotonCargando(boton, true, mensaje);
      }
      try {
        if (metodo === 'redirect') {
          await signInWithRedirect(auth, provider);
        } else {
          await signInWithPopup(auth, provider);
          cerrarModalGenerico(modalBienvenida);
          mostrarToast(`Sesión iniciada con ${nombre}.`);
        }
      } catch (error) {
        if (metodo === 'popup' && error.code === 'auth/popup-closed-by-user') return;
        logError(error, `${nombre.toLowerCase()}-login`);
      } finally {
        if (boton && metodo !== 'redirect') {
          setBotonCargando(boton, false);
        }
      }
    };

    const procesarResultadoRedirect = async () => {
      if (!firebaseDisponible || !auth) return;
      try {
        const result = await getRedirectResult(auth);
        if (result?.user) {
          cerrarModalGenerico(modalBienvenida);
          cerrarLogin();
          mostrarToast('Sesión iniciada con Google.');
          if (!state.user || state.user.uid !== result.user.uid) {
            await actualizarUIAuth(result.user);
          }
        }
      } catch (error) {
        logError(error, 'google-redirect');
      }
    };

    btnInvitado.addEventListener('click', iniciarSesionInvitado);
    btnLoginGoogle.addEventListener('click', () => iniciarConProveedor(googleProvider, 'Google', { metodo: 'redirect', boton: btnLoginGoogle }));
    btnLoginFacebook.addEventListener('click', () => iniciarConProveedor(facebookProvider, 'Facebook', { boton: btnLoginFacebook }));
    procesarResultadoRedirect();
    inicializarTogglesPassword();

    const validarContenido = (datos) => {
      const coleccion = (datos.get('coleccion') || '').toString().trim();
      if (!coleccion) throw new Error('Colección inválida');
      const esHistoria = coleccion === 'historia';
      const nombre = (datos.get('nombre') || '').toString().trim();
      const descripcion = (datos.get('descripcion') || '').toString().trim();
      const imagen = (datos.get('imagen') || '').toString().trim();
      const archivo = datos.get('archivoImagen');
      const enlace = (datos.get('enlace') || '').toString().trim();
      const etiquetas = limpiarEtiquetas(datos.get('etiquetas'));
      const direccion = esHistoria ? '' : (datos.get('direccion') || '').toString().trim();
      const latitudTexto = esHistoria ? '' : (datos.get('latitud') || '').toString().trim();
      const longitudTexto = esHistoria ? '' : (datos.get('longitud') || '').toString().trim();
      const galeriaTexto = (datos.get('galeria') || '').toString();
      const galeria = galeriaTexto
        .split(/\r?\n/)
        .map((linea) => linea.trim())
        .filter((linea) => linea.length);
      const archivosGaleria = (datos.getAll('archivosGaleria') || []).filter(
        (file) => file instanceof File && file.size > 0
      );
      if (!nombre || nombre.length > 60) throw new Error('Nombre inválido');
      if (!descripcion || descripcion.length > 2000) throw new Error('Descripción inválida');
      const tieneArchivo = archivo && archivo.size > 0;
      if (tieneArchivo && !archivo.type.startsWith('image/')) throw new Error('El archivo debe ser una imagen.');
      if (!imagen && !tieneArchivo) throw new Error('Proporciona una imagen o sube un archivo.');
      if (imagen && !isSafeImageURL(imagen)) throw new Error('URL de imagen no segura');
      if (enlace && !isSafeHttpUrl(enlace)) throw new Error('Enlace no válido');
      if (!esHistoria && direccion.length > 160) throw new Error('La dirección es demasiado larga.');
      galeria.forEach((url) => {
        if (!isSafeImageURL(url)) throw new Error('Una URL de la galería no es segura.');
      });
      archivosGaleria.forEach((file) => {
        if (!file.type.startsWith('image/')) throw new Error('Los archivos de la galería deben ser imágenes.');
      });
      if (galeria.length + archivosGaleria.length > 10) {
        throw new Error('La galería admite como máximo 10 imágenes.');
      }
      const latitud = latitudTexto ? Number(latitudTexto) : null;
      const longitud = longitudTexto ? Number(longitudTexto) : null;
      if (!esHistoria) {
        if (latitud != null && (!Number.isFinite(latitud) || latitud < -90 || latitud > 90)) {
          throw new Error('Latitud inválida');
        }
        if (longitud != null && (!Number.isFinite(longitud) || longitud < -180 || longitud > 180)) {
          throw new Error('Longitud inválida');
        }
        if ((latitud != null) !== (longitud != null)) {
          throw new Error('Indica latitud y longitud para fijar la ubicación.');
        }
      } else if (latitudTexto || longitudTexto) {
        throw new Error('Los apartados de historia no requieren coordenadas.');
      }
      const anioTexto = (datos.get('anioHistoria') || '').toString().trim();
      let anioHistoria = null;
      if (esHistoria) {
        if (!anioTexto) throw new Error('Indica el año del hito histórico.');
        const numero = Number(anioTexto);
        if (!Number.isFinite(numero) || numero < 0 || numero > 9999) {
          throw new Error('El año histórico debe estar entre 0 y 9999.');
        }
        anioHistoria = Math.round(numero);
      }
      return {
        coleccion,
        nombre,
        descripcion,
        imagen,
        archivo: tieneArchivo ? archivo : null,
        enlace: enlace || null,
        etiquetas,
        direccion,
        coordenadas: latitud != null && longitud != null ? [latitud, longitud] : null,
        galeria,
        archivosGaleria,
        anio: anioHistoria
      };
    };

    const esErrorCorsStorage = (error) => {
      const texto = `${error?.code || ''} ${error?.message || ''}`.toLowerCase();
      return (
        texto.includes('cors') ||
        texto.includes('http ok status') ||
        texto.includes('net::err_failed') ||
        texto.includes('failed to fetch')
      );
    };

    let avisoRestriccionStorageMostrado = false;
    const avisarRestriccionStorage = (mensaje) => {
      if (avisoRestriccionStorageMostrado) return;
      avisoRestriccionStorageMostrado = true;
      mostrarToast(mensaje, 'aviso', 10000);
    };

    const asegurarStorageDisponible = () => {
      if (!firebaseDisponible || !storage) {
        throw new Error('Firebase Storage no está disponible en este momento.');
      }
      if (!puedeUsarFirebaseStorage) {
        avisarRestriccionStorage(
          'Las subidas a Firebase Storage solo están habilitadas en el dominio oficial de la guía.'
        );
        throw new Error('Dominio no autorizado para subidas.');
      }
    };

    const subirImagenContenido = async (archivo, coleccion, nombre) => {
      if (!archivo) return null;
      try {
        asegurarSesionActivaParaStorage();
        asegurarStorageDisponible();
        const slug = nombre.toLowerCase().replace(/[^a-z0-9]+/g, '-').slice(0, 40) || 'imagen';
        const ruta = `contenido/${coleccion}/${Date.now()}-${slug}`;
        const referencia = ref(storage, ruta);
        await uploadBytes(referencia, archivo, { contentType: archivo.type || 'image/jpeg' });
        return await getDownloadURL(referencia);
      } catch (error) {
        logError(error, 'storage-upload');
        if (esErrorCorsStorage(error)) {
          avisarRestriccionStorage(
            'No se pudo subir la imagen al almacenamiento en la nube desde este dominio. Ajusta la configuración de CORS.'
          );
        }
        throw error;
      }
    };

    const procesarArchivosGaleria = async (archivos, coleccion, nombre) => {
      if (!Array.isArray(archivos) || !archivos.length) return [];
      const resultados = [];
      for (let i = 0; i < archivos.length; i += 1) {
        const archivo = archivos[i];
        try {
          const url = await subirImagenContenido(archivo, coleccion, `${nombre}-galeria-${i + 1}`);
          if (url && isSafeImageURL(url)) {
            resultados.push(url);
          }
        } catch (error) {
          logError(error, 'admin-galeria');
        }
      }
      return resultados;
    };

    const limpiarNombreArchivoStorage = (nombre = 'archivo') => {
      const limpio = nombre
        .toLowerCase()
        .replace(/[^a-z0-9._-]+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-+|-+$/g, '')
        .slice(-80);
      return limpio || 'archivo';
    };

    const subirImagenAStorage = async (archivo, idLugar) => {
      if (!(archivo instanceof Blob)) return { url: null, path: null };
      asegurarSesionActivaParaStorage();
      asegurarStorageDisponible();
      const timestamp = Date.now();
      const nombreSeguro = limpiarNombreArchivoStorage(archivo.name || `imagen-${timestamp}`);
      const rutaStorage = `lugares/${idLugar}/${timestamp}-${nombreSeguro}`;
      const referencia = ref(storage, rutaStorage);
      await uploadBytes(referencia, archivo, { contentType: archivo.type || 'image/jpeg' });
      const url = await getDownloadURL(referencia);
      return { url, path: rutaStorage };
    };

    const subirGaleriaLugar = async (archivos, idLugar) => {
      const urls = [];
      const paths = [];
      if (!Array.isArray(archivos) || !archivos.length) return { urls, paths };
      for (let i = 0; i < archivos.length; i += 1) {
        const archivo = archivos[i];
        const { url, path } = await subirImagenAStorage(archivo, idLugar);
        if (url) {
          urls.push(url);
          if (path) paths.push(path);
        }
      }
      return { urls, paths };
    };

    const construirGaleriaPathsDesdeMeta = (urls, meta) => {
      if (!Array.isArray(urls) || !urls.length) return [];
      if (!Array.isArray(meta) || !meta.length) return [];
      const restante = meta.map((entrada) => ({ ...entrada }));
      return urls.reduce((acumulado, url) => {
        const indice = restante.findIndex((entrada) => entrada.url === url && entrada.path);
        if (indice >= 0) {
          acumulado.push(restante[indice].path);
          restante.splice(indice, 1);
        }
        return acumulado;
      }, []);
    };

    const guardarLugar = async (
      idLugar,
      datosLugar,
      imagenPrincipalFile,
      imagenesGaleriaFiles,
      esEdicion = false
    ) => {
      if (!firebaseDisponible || !db) {
        throw new Error('No se pudo conectar con Firestore.');
      }
      const lugaresRef = collection(db, 'lugares');
      const docRef = esEdicion && idLugar ? doc(db, 'lugares', idLugar) : doc(lugaresRef);
      const lugarId = docRef.id;
      const payload = {
        nombre: datosLugar.nombre,
        descripcion: datosLugar.descripcion,
        direccion: datosLugar.direccion || null,
        enlace: datosLugar.enlace || null,
        coordenadas: datosLugar.coordenadas || null,
        etiquetas: datosLugar.etiquetas,
        galeria: [],
        anio: datosLugar.anio ?? null,
        actualizado: serverTimestamp()
      };

      const imagenTexto = (datosLugar.imagen || '').trim();
      let debeEliminarImagenPath = false;
      let imagenPathValor = null;
      if (imagenPrincipalFile) {
        const { url, path } = await subirImagenAStorage(imagenPrincipalFile, lugarId);
        payload.imagenUrl = url;
        if (path) imagenPathValor = path;
      } else if (imagenTexto) {
        payload.imagenUrl = imagenTexto;
        if (datosLugar.imagenActual === imagenTexto && datosLugar.imagenPath) {
          imagenPathValor = datosLugar.imagenPath;
        } else {
          debeEliminarImagenPath = true;
        }
      } else {
        payload.imagenUrl = null;
        debeEliminarImagenPath = true;
      }
      if (imagenPathValor) {
        payload.imagenPath = imagenPathValor;
      }

      const galeriaBase = Array.isArray(datosLugar.galeria)
        ? datosLugar.galeria.filter((url) => typeof url === 'string' && url.length)
        : [];
      const galeriaMeta = Array.isArray(datosLugar.galeriaMeta) ? datosLugar.galeriaMeta : [];
      const pathsExistentes = construirGaleriaPathsDesdeMeta(galeriaBase, galeriaMeta);
      const archivosGaleria = Array.isArray(imagenesGaleriaFiles) ? imagenesGaleriaFiles : [];
      const { urls: nuevasGalerias, paths: nuevosPaths } = await subirGaleriaLugar(archivosGaleria, lugarId);
      const galeriaFinal = [...galeriaBase, ...nuevasGalerias].filter(
        (url, indice, arr) => url && arr.indexOf(url) === indice
      );
      payload.galeria = galeriaFinal;
      const galeriaPathsFinal = [...pathsExistentes, ...nuevosPaths].filter(Boolean);
      let debeEliminarGaleriaPaths = false;
      if (galeriaPathsFinal.length) {
        payload.galeriaPaths = galeriaPathsFinal.slice(0, galeriaFinal.length);
      } else if (esEdicion) {
        debeEliminarGaleriaPaths = true;
      }

      if (!esEdicion) {
        payload.creado = serverTimestamp();
      }

      if (esEdicion) {
        const updateData = { ...payload, imagen: deleteField() };
        if (!payload.imagenPath && debeEliminarImagenPath) {
          updateData.imagenPath = deleteField();
        }
        if (!payload.galeriaPaths && debeEliminarGaleriaPaths) {
          updateData.galeriaPaths = deleteField();
        }
        await updateDoc(docRef, updateData);
      } else {
        if (!payload.galeriaPaths) delete payload.galeriaPaths;
        await setDoc(docRef, payload);
      }
      return { id: docRef.id, accion: esEdicion ? 'actualizado' : 'creado' };
    };

    formAdmin.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!puedeUsarPanelAdmin()) {
        mostrarToast('Verifica tu email y permisos de administrador.');
        return;
      }
      if (!(await isUserAdmin())) {
        mostrarToast('No tienes permisos de administrador.');
        return;
      }
      if (!auth?.currentUser) {
        mostrarToast('Debes iniciar sesión para administrar el contenido.');
        return;
      }
      try {
        const datos = new FormData(formAdmin);
        const contenido = validarContenido(datos);
        contenido.imagenActual = formAdmin.dataset.imagenActual || '';
        contenido.imagenPath = formAdmin.dataset.imagenPath || '';
        contenido.galeriaMeta = obtenerMetaGaleriaFormulario();
        const existente = formAdmin.dataset.id || '';
        const esEdicion = Boolean(existente);
        let resultado = null;

        if (contenido.coleccion === 'lugares') {
          resultado = await guardarLugar(
            esEdicion ? existente : null,
            contenido,
            contenido.archivo,
            contenido.archivosGaleria,
            esEdicion
          );
        } else {
          const imagenFinal = contenido.archivo
            ? await subirImagenContenido(contenido.archivo, contenido.coleccion, contenido.nombre)
            : contenido.imagen;
          if (!imagenFinal || !isSafeImageURL(imagenFinal)) throw new Error('No fue posible procesar la imagen.');
          const nuevasGalerias = await procesarArchivosGaleria(
            contenido.archivosGaleria,
            contenido.coleccion,
            contenido.nombre
          );
          const galeriaFinal = [...contenido.galeria, ...nuevasGalerias]
            .filter((url, indice, arr) => url && arr.indexOf(url) === indice);
          const actualizado = serverTimestamp();
          const docData = {
            nombre: contenido.nombre,
            descripcion: contenido.descripcion,
            imagen: imagenFinal,
            etiquetas: contenido.etiquetas,
            enlace: contenido.enlace,
            direccion: contenido.direccion || null,
            coordenadas: contenido.coordenadas || null,
            galeria: galeriaFinal,
            actualizado,
            anio: contenido.anio ?? null
          };
          if (!firebaseDisponible || !db) {
            mostrarToast('No se pudo guardar el contenido. Revisa la conexión con Firebase.');
            return;
          }
          if (esEdicion) {
            await updateDoc(doc(db, contenido.coleccion, existente), docData);
            resultado = { accion: 'actualizado', id: existente };
          } else {
            const nuevoDoc = await addDoc(collection(db, contenido.coleccion), {
              ...docData,
              creado: serverTimestamp()
            });
            resultado = { accion: 'creado', id: nuevoDoc.id };
          }
        }

        const accionTexto = resultado?.accion === 'actualizado' ? 'actualizado' : 'creado';
        const etiqueta = contenido.coleccion === 'lugares' ? 'Lugar' : 'Contenido';
        mostrarToast(`${etiqueta} ${accionTexto}`);
        cerrarModalAdmin();
        if (['lugares', 'restaurantes', 'ocio'].includes(contenido.coleccion)) {
          await cargarColeccion(contenido.coleccion, { reiniciar: true });
        }
        if (contenido.coleccion === 'historia') {
          await recargarHistoria();
        }
        await renderAdminLista();
      } catch (error) {
        logError(error, 'admin-guardar');
        mostrarToast('No se pudo guardar el contenido. Inténtalo de nuevo más tarde.');
      }
    });

    const eliminarDocumento = async (coleccion, id) => {
      if (!puedeUsarPanelAdmin() || !(await isUserAdmin())) {
        mostrarToast('No tienes permisos de administrador.');
        return;
      }
      try {
        if (!firebaseDisponible || !db) {
          mostrarToast('No se pudo eliminar el elemento. Revisa la conexión con Firebase.');
          return;
        }
        await deleteDoc(doc(db, coleccion, id));
        mostrarToast('Elemento eliminado');
        if (['lugares', 'restaurantes', 'ocio'].includes(coleccion)) {
          await cargarColeccion(coleccion, { reiniciar: true });
        }
        if (coleccion === 'historia') {
          await recargarHistoria();
        }
        await renderAdminLista();
      } catch (error) {
        logError(error, 'admin-eliminar');
      }
    };

    const renderAdminLista = async () => {
      if (!puedeUsarPanelAdmin() || !listaAdmin) return;
      listaAdmin.textContent = '';
      if (!firebaseDisponible || !db) {
        const aviso = document.createElement('li');
        aviso.className = 'lista-vacia';
        aviso.textContent = 'No se pudo cargar la lista desde Firebase.';
        listaAdmin.appendChild(aviso);
        return;
      }
      const bloques = [
        { clave: 'lugares', titulo: 'Lugares', orden: { campo: 'nombre', direccion: 'asc' } },
        { clave: 'restaurantes', titulo: 'Gastronomía', orden: { campo: 'nombre', direccion: 'asc' } },
        { clave: 'ocio', titulo: 'Ocio activo', orden: { campo: 'nombre', direccion: 'asc' } },
        { clave: 'historia', titulo: 'Historia', orden: { campo: 'anio', direccion: 'asc' } }
      ];
      try {
        for (const bloque of bloques) {
          const li = document.createElement('li');
          li.className = 'admin-coleccion';
          const cabecera = document.createElement('div');
          cabecera.className = 'admin-coleccion-header';
          const titulo = document.createElement('strong');
          titulo.textContent = bloque.titulo;
          cabecera.appendChild(titulo);
          const btnNuevo = document.createElement('button');
          btnNuevo.type = 'button';
          btnNuevo.className = 'btn btn-ghost btn-sm';
          btnNuevo.textContent = 'Añadir';
          btnNuevo.addEventListener('click', () => abrirModalAdmin(null, bloque.clave));
          cabecera.appendChild(btnNuevo);
          li.appendChild(cabecera);
          const contenedor = document.createElement('div');
          contenedor.className = 'admin-items';
          let consulta = query(
            collection(db, bloque.clave),
            orderBy(bloque.orden.campo, bloque.orden.direccion),
            limit(20)
          );
          const snap = await getDocs(consulta);
          if (snap.empty) {
            const vacio = document.createElement('p');
            vacio.className = 'lista-vacia';
            vacio.textContent = 'Sin elementos por ahora.';
            li.appendChild(vacio);
          } else {
            snap.docs.forEach((docSnap) => {
              const data = { id: docSnap.id, ...docSnap.data(), coleccion: bloque.clave };
              const item = document.createElement('div');
              item.className = 'admin-item';
              const info = document.createElement('div');
              const nombre = document.createElement('strong');
              nombre.textContent = data.nombre || data.titulo || data.id;
              info.appendChild(nombre);
              if (bloque.clave === 'historia') {
                const detalle = document.createElement('small');
                detalle.textContent = `Año ${formatearPeriodoHistoria(data)}`;
                info.appendChild(detalle);
              } else if (data.direccion) {
                const detalle = document.createElement('small');
                detalle.textContent = data.direccion;
                info.appendChild(detalle);
              }
              item.appendChild(info);
              const acciones = document.createElement('div');
              acciones.className = 'admin-item-acciones';
              const btnEditar = document.createElement('button');
              btnEditar.type = 'button';
              btnEditar.className = 'btn btn-ghost btn-sm';
              btnEditar.textContent = 'Editar';
              btnEditar.addEventListener('click', () => abrirModalAdmin(data, bloque.clave));
              acciones.appendChild(btnEditar);
              const btnEliminar = document.createElement('button');
              btnEliminar.type = 'button';
              btnEliminar.className = 'btn btn-ghost btn-sm';
              btnEliminar.textContent = 'Eliminar';
              btnEliminar.addEventListener('click', () => {
                if (confirm('¿Seguro que deseas eliminar este elemento?')) {
                  eliminarDocumento(bloque.clave, data.id);
                }
              });
              acciones.appendChild(btnEliminar);
              item.appendChild(acciones);
              contenedor.appendChild(item);
            });
            li.appendChild(contenedor);
          }
          listaAdmin.appendChild(li);
        }
      } catch (error) {
        manejarErrorFirebase(error, 'admin-lista');
        renderLocal();
      }
    };

    const safeSetGPX = (url) => {
      if (url && isSafeHttpUrl(url) && !/REEMPLAZAR/i.test(url)) {
        btnDescargarGPX.hidden = false;
        btnDescargarGPX.dataset.href = url;
      } else {
        btnDescargarGPX.hidden = true;
        delete btnDescargarGPX.dataset.href;
      }
    };

    btnDescargarGPX.addEventListener('click', () => {
      const href = btnDescargarGPX.dataset.href;
      if (href && isSafeHttpUrl(href)) {
        window.open(href, '_blank', 'noopener');
      }
    });

    const PREFERENCIAS = {
      modoOscuro: { key: 'smv-oscuro', checkbox: toggleModoOscuro, className: 'modo-oscuro' },
      modoSenior: { key: 'smv-senior', checkbox: toggleModoSenior, className: 'modo-senior' },
      fuente: { key: 'smv-fuente', checkbox: toggleFuente, className: 'fuente-dyslexia' },
      reducir: { key: 'smv-reducir', checkbox: toggleReducir, className: 'reducir-animaciones' },
      contraste: { key: 'smv-contraste', checkbox: toggleContraste, className: 'alto-contraste', quick: initContraste },
      texto: { key: 'smv-texto', checkbox: toggleTexto, className: 'texto-grande', quick: initTexto },
      espaciado: { key: 'smv-espaciado', checkbox: toggleEspaciado, className: 'espaciado-amplio', quick: initEspaciado },
      botones: { key: 'smv-botones', checkbox: toggleBotones, className: 'botones-amplios' },
      links: { key: 'smv-links', checkbox: toggleLinks, className: 'links-subrayados', quick: initLinks },
      lectura: { key: 'smv-lectura', checkbox: toggleLecturaFacil, className: 'lectura-facil' },
      visibilidad: { key: 'smv-visibilidad', checkbox: toggleVisibilidad, className: 'modo-visibilidad' }
    };

    const actualizarOpcionesSenior = () => {
      const activo = Boolean(toggleModoSenior?.checked);
      document.querySelectorAll('[data-senior-control]').forEach((input) => {
        input.disabled = !activo;
        const etiqueta = input.closest('.toggle');
        if (etiqueta) etiqueta.classList.toggle('is-disabled', !activo);
      });
    };

    const aplicarPreferencias = () => {
      Object.values(PREFERENCIAS).forEach((pref) => {
        const activo = localStorage.getItem(pref.key) === 'on';
        if (pref.checkbox) pref.checkbox.checked = activo;
        if (pref.quick) pref.quick.checked = activo;
        if (pref.className) document.body.classList.toggle(pref.className, activo);
      });
      actualizarOpcionesSenior();
    };

    const actualizarPreferencia = (pref, value) => {
      localStorage.setItem(pref.key, value ? 'on' : 'off');
      aplicarPreferencias();
    };

    Object.values(PREFERENCIAS).forEach((pref) => {
      if (pref.checkbox) {
        pref.checkbox.addEventListener('change', (event) => {
          actualizarPreferencia(pref, event.target.checked);
          if (pref.checkbox === toggleModoSenior) {
            actualizarOpcionesSenior();
            if (event.target.checked) {
              ['texto', 'espaciado', 'botones'].forEach((clave) => {
                const objetivo = PREFERENCIAS[clave];
                if (objetivo?.checkbox && !objetivo.checkbox.checked) {
                  objetivo.checkbox.checked = true;
                  actualizarPreferencia(objetivo, true);
                }
              });
            }
          }
        });
      }
      if (pref.quick) {
        pref.quick.addEventListener('change', (event) => {
          actualizarPreferencia(pref, event.target.checked);
        });
      }
    });

    formLogin.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!formLogin) return;
      const email = sanitizeEmail(formLogin.email.value);
      formLogin.email.value = email;
      const password = formLogin.password.value;
      let valido = true;
      if (!esEmailValido(email)) {
        mostrarMensajeCampo(errorLoginEmail, 'Email inválido');
        setIndicadorValidacion(indicadorLoginEmail, 'error');
        valido = false;
      }
      if (!password || password.length < 8) {
        mostrarMensajeCampo(errorLoginPassword, 'La contraseña debe tener al menos 8 caracteres.');
        setIndicadorValidacion(indicadorLoginPassword, 'error');
        valido = false;
      }
      if (!valido) return;
      const limite = puedeIntentarAccion(RATE_LIMITS.login.clave, RATE_LIMITS.login.max, RATE_LIMITS.login.ventana);
      mostrarCaptchaSiNecesario(limite.intentos);
      if (!limite.disponible) {
        mostrarMensajeCampo(
          errorLoginPassword,
          `Demasiados intentos. Intenta en ${formatearTiempoRestante(limite.restanteMs)}.`
        );
        setIndicadorValidacion(indicadorLoginPassword, 'error');
        return;
      }
      if (!captchaLogin?.hidden && !checkCaptchaLogin?.checked) {
        mostrarMensajeCampo(errorLoginPassword, 'Completa la verificación de seguridad.');
        return;
      }
      if (!firebaseDisponible || !auth) {
        mostrarMensajeCampo(errorLoginPassword, 'Conéctate para iniciar sesión.');
        return;
      }
      setBotonCargando(btnSubmitLogin, true, 'Ingresando…');
      try {
        await authFunctions.login(email, password);
        resetIntentosAccion(RATE_LIMITS.login.clave);
        mostrarCaptchaSiNecesario(0);
        cerrarLogin();
        registrarActividad(true);
        mostrarToast('Sesión iniciada correctamente');
      } catch (error) {
        registrarIntentoAccion(RATE_LIMITS.login.clave, RATE_LIMITS.login.ventana);
        const intentosTrasFallo = limite.intentos + 1;
        switch (error.code) {
          case 'auth/invalid-email':
            mostrarMensajeCampo(errorLoginEmail, 'Email inválido');
            setIndicadorValidacion(indicadorLoginEmail, 'error');
            break;
          case 'auth/user-not-found':
            mostrarMensajeCampo(errorLoginEmail, 'Cuenta no encontrada');
            setIndicadorValidacion(indicadorLoginEmail, 'error');
            toggleAlertaCuenta(true);
            break;
          case 'auth/wrong-password':
            mostrarMensajeCampo(errorLoginPassword, 'Contraseña incorrecta');
            setIndicadorValidacion(indicadorLoginPassword, 'error');
            break;
          case 'auth/invalid-credential':
          case 'auth/invalid-login-credentials':
          case 'auth/missing-password':
            mostrarMensajeCampo(errorLoginPassword, 'Correo o contraseña incorrectos.');
            setIndicadorValidacion(indicadorLoginPassword, 'error');
            break;
          case 'auth/too-many-requests':
            mostrarMensajeCampo(errorLoginPassword, 'Demasiados intentos, intenta más tarde.');
            setIndicadorValidacion(indicadorLoginPassword, 'error');
            break;
          default:
            mostrarMensajeCampo(errorLoginPassword, 'No fue posible iniciar sesión. Intenta nuevamente.');
            break;
        }
        mostrarCaptchaSiNecesario(intentosTrasFallo);
        if (intentosTrasFallo >= 3) {
          mostrarToast('Detectamos varios intentos fallidos. Si no fuiste tú, cambia tu contraseña desde Ajustes.');
        }
        logError(error, 'login');
      } finally {
        setBotonCargando(btnSubmitLogin, false);
      }
    });

    if (formRegistro) formRegistro.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!formRegistro) return;
      const email = sanitizeEmail(inputRegistroEmail.value);
      inputRegistroEmail.value = email;
      const password = inputRegistroPassword.value;
      const confirm = inputRegistroPasswordConfirm.value;
      const displayName = sanitizeText(inputRegistroDisplayName.value);
      const acepto = checkTerminos?.checked;
      let valido = true;
      if (!esEmailValido(email)) {
        mostrarMensajeCampo(errorRegistroEmail, 'Introduce un email válido.');
        setIndicadorValidacion(indicadorRegistroEmail, 'error');
        valido = false;
      }
      const existe = esEmailValido(email) ? await verificarCuentaExiste(email) : null;
      if (existe) {
        mostrarMensajeCampo(errorRegistroEmail, 'Ya existe una cuenta con este email.');
        setIndicadorValidacion(indicadorRegistroEmail, 'error');
        valido = false;
      }
      if (!cumplePasswordSegura(password)) {
        mostrarMensajeCampo(
          errorRegistroPassword,
          'La contraseña debe tener 8 caracteres, una mayúscula, un número y un símbolo.'
        );
        valido = false;
      }
      if (password !== confirm) {
        mostrarMensajeCampo(errorRegistroConfirm, 'Las contraseñas no coinciden.');
        valido = false;
      }
      if (!acepto) {
        mostrarMensajeCampo(errorRegistroTerminos, 'Debes aceptar los términos y condiciones.');
        valido = false;
      } else {
        mostrarMensajeCampo(errorRegistroTerminos, '');
      }
      if (!valido) return;
      if (!firebaseDisponible || !auth) {
        mostrarMensajeCampo(errorRegistroEmail, 'Conéctate para completar el registro.');
        return;
      }
      setBotonCargando(btnSubmitRegistro, true, 'Creando cuenta…');
      try {
        await authFunctions.register(email, password, displayName);
        cuentaExisteCache.set(email.toLowerCase(), true);
        if (mensajeRegistroExito) {
          mensajeRegistroExito.textContent = 'Cuenta creada. Revisa tu email para verificar tu cuenta.';
          mensajeRegistroExito.hidden = false;
        }
        mostrarToast('Cuenta creada. Revisa tu email para verificar tu cuenta.');
        setTimeout(() => {
          cerrarRegistro();
          abrirLoginModal();
        }, 800);
      } catch (error) {
        if (error.code === 'auth/email-already-in-use') {
          mostrarMensajeCampo(errorRegistroEmail, 'Este email ya está registrado.');
          setIndicadorValidacion(indicadorRegistroEmail, 'error');
        } else if (error.code === 'auth/weak-password') {
          mostrarMensajeCampo(errorRegistroPassword, 'La contraseña es demasiado débil.');
        } else {
          mostrarMensajeCampo(errorRegistroEmail, 'No pudimos crear la cuenta. Intenta de nuevo.');
        }
        logError(error, 'registro');
      } finally {
        setBotonCargando(btnSubmitRegistro, false);
      }
    });

    if (formRecuperacion) formRecuperacion.addEventListener('submit', async (event) => {
      event.preventDefault();
      const email = sanitizeEmail(inputRecuperacionEmail.value);
      inputRecuperacionEmail.value = email;
      if (!esEmailValido(email)) {
        mostrarMensajeCampo(errorRecuperacion, 'Email inválido');
        return;
      }
      const limite = puedeIntentarAccion(
        RATE_LIMITS.recovery.clave,
        RATE_LIMITS.recovery.max,
        RATE_LIMITS.recovery.ventana
      );
      if (!limite.disponible) {
        mostrarMensajeCampo(
          errorRecuperacion,
          `Demasiados intentos. Espera ${formatearTiempoRestante(limite.restanteMs)}.`
        );
        return;
      }
      if (!firebaseDisponible || !auth) {
        mostrarMensajeCampo(errorRecuperacion, 'Conéctate para solicitar la recuperación.');
        return;
      }
      setBotonCargando(btnEnviarRecuperacion, true, 'Enviando…');
      try {
        await authFunctions.resetPassword(email);
        registrarIntentoAccion(RATE_LIMITS.recovery.clave, RATE_LIMITS.recovery.ventana);
        mostrarMensajeCampo(errorRecuperacion, '');
        mostrarMensajeCampo(exitoRecuperacion, 'Te hemos enviado un email para restablecer tu contraseña.');
      } catch (error) {
        registrarIntentoAccion(RATE_LIMITS.recovery.clave, RATE_LIMITS.recovery.ventana);
        if (error.code === 'auth/user-not-found') {
          mostrarMensajeCampo(errorRecuperacion, 'No encontramos una cuenta con ese email.');
        } else if (error.code === 'auth/too-many-requests') {
          mostrarMensajeCampo(errorRecuperacion, 'Demasiados intentos, intenta más tarde.');
        } else {
          mostrarMensajeCampo(errorRecuperacion, 'No se pudo enviar el email. Intenta más tarde.');
        }
        logError(error, 'recuperacion');
      } finally {
        setBotonCargando(btnEnviarRecuperacion, false);
      }
    });

    if (formCambioEmail) formCambioEmail.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!state.user) {
        mostrarEstadoCuenta('Inicia sesión para cambiar tu email.', true);
        return;
      }
      const nuevoEmail = sanitizeEmail(inputNuevoEmail.value);
      inputNuevoEmail.value = nuevoEmail;
      const password = inputPasswordEmail.value;
      let valido = true;
      if (!esEmailValido(nuevoEmail)) {
        mostrarMensajeCampo(errorCambioEmail, 'Introduce un email válido.');
        setIndicadorValidacion(indicadorNuevoEmail, 'error');
        valido = false;
      }
      if (state.user.email && nuevoEmail.toLowerCase() === state.user.email.toLowerCase()) {
        mostrarMensajeCampo(errorCambioEmail, 'El nuevo email debe ser distinto al actual.');
        setIndicadorValidacion(indicadorNuevoEmail, 'error');
        valido = false;
      }
      const existe = esEmailValido(nuevoEmail) ? await verificarCuentaExiste(nuevoEmail) : null;
      if (existe) {
        mostrarMensajeCampo(errorCambioEmail, 'Ya existe una cuenta con ese email.');
        setIndicadorValidacion(indicadorNuevoEmail, 'error');
        valido = false;
      }
      if (!password) {
        mostrarMensajeCampo(errorCambioEmail, 'Introduce tu contraseña actual.');
        valido = false;
      }
      if (!valido) return;
      if (!firebaseDisponible || !auth || !auth.currentUser) {
        mostrarMensajeCampo(errorCambioEmail, 'Conéctate para actualizar tu email.');
        return;
      }
      setBotonCargando(btnSubmitCambioEmail, true, 'Actualizando…');
      try {
        await authFunctions.changeEmail(nuevoEmail, password);
        await sendEmailVerification(auth.currentUser, emailActionSettings);
        cuentaExisteCache.set(nuevoEmail.toLowerCase(), true);
        mostrarEstadoCuenta('Email actualizado. Verifica tu nuevo email.');
        cerrarCambioEmail();
      } catch (error) {
        if (error.code === 'auth/wrong-password') {
          mostrarMensajeCampo(errorCambioEmail, 'Contraseña incorrecta.');
        } else if (error.code === 'auth/email-already-in-use') {
          mostrarMensajeCampo(errorCambioEmail, 'Ya existe una cuenta con ese email.');
        } else if (error.code === 'auth/requires-recent-login') {
          mostrarEstadoCuenta('Vuelve a iniciar sesión y repite la operación.', true);
        } else if (error.code === 'auth/no-email') {
          mostrarEstadoCuenta('Tu cuenta no tiene un email asignado.', true);
        } else {
          mostrarMensajeCampo(errorCambioEmail, 'No se pudo actualizar el email.');
        }
        logError(error, 'cambio-email');
      } finally {
        setBotonCargando(btnSubmitCambioEmail, false);
      }
    });

    btnLogout.addEventListener('click', () => {
      detenerMonitoreoInactividad();
      if (auth) {
        signOut(auth).catch((error) => logError(error, 'logout'));
      }
    });

    const guardarBaneados = () => {
      localStorage.setItem('smv-baneados', JSON.stringify([...state.baneados]));
    };

    const aplicarBaneo = () => {
      state.baneado = true;
      document.body.dataset.baneado = 'true';
      abrirModalGenerico(modalBaneado);
    };

    const levantarBaneo = () => {
      state.baneado = false;
      document.body.dataset.baneado = 'false';
      cerrarModalGenerico(modalBaneado);
    };
    registrarModalAccesible(modalBaneado, levantarBaneo);

    const actualizarListaBaneados = () => {
      listaBaneados.textContent = '';
      if (!state.baneados.size) {
        const vacio = document.createElement('li');
        vacio.textContent = 'Sin IPs bloqueadas.';
        listaBaneados.appendChild(vacio);
        return;
      }
      for (const ip of state.baneados) {
        const item = document.createElement('li');
        item.style.display = 'flex';
        item.style.justifyContent = 'space-between';
        item.style.alignItems = 'center';
        item.textContent = ip;
        if (puedeUsarPanelAdmin()) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-ghost';
          btn.textContent = 'Desbloquear';
          btn.addEventListener('click', () => {
            state.baneados.delete(ip);
            guardarBaneados();
            actualizarListaBaneados();
            if (state.ip === ip) levantarBaneo();
          });
          item.appendChild(btn);
        }
        listaBaneados.appendChild(item);
      }
    };

    const verificarBaneoActual = () => {
      if (state.ip && state.baneados.has(state.ip)) {
        aplicarBaneo();
      } else {
        levantarBaneo();
      }
    };

    formBan.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!puedeUsarPanelAdmin() || !(await isUserAdmin())) {
        mostrarToast('Solo el equipo administrador puede gestionar bloqueos.');
        return;
      }
      const ip = inputBanIp.value.trim();
      const patron = /^(?:\d{1,3}\.){3}\d{1,3}$/;
      if (!patron.test(ip)) {
        mostrarToast('Introduce una IP válida.');
        return;
      }
      state.baneados.add(ip);
      guardarBaneados();
      actualizarListaBaneados();
      formBan.reset();
      mostrarToast(`IP ${ip} bloqueada.`);
      if (state.ip === ip) {
        aplicarBaneo();
      }
    });

    const obtenerIPPublica = async () => {
      // Lista de APIs públicas confiables (en orden de prioridad)
      const ENDPOINTS_IP = [
        'https://api.ipify.org?format=json', // Más confiable
        'https://api.bigdatacloud.net/data/client-ip', // Alternativa
        'https://ipapi.co/json/' // Backup
      ];

      const extraerIp = (data) => {
        if (typeof data === 'string') return data.trim();
        return data?.ip || data?.ipString || data?.IPv4 || null;
      };

      for (const endpoint of ENDPOINTS_IP) {
        try {
          const respuesta = await fetch(endpoint, {
            headers: { Accept: 'application/json' },
            mode: 'cors',
            credentials: 'omit'
          });

          if (!respuesta.ok) continue;

          const tipo = respuesta.headers.get('content-type');
          let ip = null;

          if (tipo?.includes('application/json')) {
            const data = await respuesta.json();
            ip = extraerIp(data);
          } else {
            const texto = await respuesta.text();
            ip = extraerIp(texto);
          }

          if (ip) {
            state.ip = ip;
            console.log('IP obtenida:', ip); // Para debugging
            break;
          }
        } catch (error) {
          console.warn('Fallo al consultar IP en', endpoint, error);
        }
      }

      verificarBaneoActual();
    };

    actualizarListaBaneados();

    const mostrarEstadoCuenta = (mensaje, esError = false) => {
      if (!estadoCuenta) return;
      estadoCuenta.textContent = mensaje;
      estadoCuenta.hidden = false;
      estadoCuenta.style.color = esError ? '#d32f2f' : '#0b3d91';
    };

    const actualizarPanelCuentaProtegido = () => {
      const haySesion = Boolean(state.user);
      if (panelCuenta) {
        panelCuenta.hidden = !haySesion;
        panelCuenta.disabled = !haySesion;
      }
      if (avisoCuentaInvitado) avisoCuentaInvitado.hidden = haySesion;
      if (btnLoginAjustes) btnLoginAjustes.hidden = haySesion;
    };

    const actualizarProteccionesResena = () => {
      if (!formResena || !avisoResenaInvitado) return;
      const puedePublicar = Boolean(state.user?.emailVerificado);
      formResena.hidden = !puedePublicar;
      avisoResenaInvitado.hidden = puedePublicar;
      if (!puedePublicar) {
        if (textoResenaProtegida) {
          textoResenaProtegida.textContent = state.user
            ? 'Verifica tu correo para escribir reseñas.'
            : 'Inicia sesión para escribir una reseña y compartir tu experiencia.';
        }
        if (btnLoginResena) btnLoginResena.hidden = Boolean(state.user);
      }
    };

    const actualizarBotonVerificacion = () => {
      if (!btnVerificarCorreo) return;
      if (!state.user) {
        btnVerificarCorreo.disabled = true;
        btnVerificarCorreo.textContent = 'Reenviar email de verificación';
        return;
      }
      const verificado = Boolean(state.user.emailVerificado);
      btnVerificarCorreo.disabled = verificado;
      btnVerificarCorreo.textContent = verificado
        ? 'Correo verificado'
        : 'Reenviar email de verificación';
    };

    actualizarPanelCuentaProtegido();
    actualizarProteccionesResena();
    actualizarBotonVerificacion();

    function mostrarMensajeCampo(elemento, mensaje = '') {
      if (!elemento) return;
      elemento.textContent = mensaje;
      elemento.hidden = !mensaje;
    }

    const toggleAlertaCuenta = (visible) => {
      if (!alertaCuentaInexistente) return;
      alertaCuentaInexistente.hidden = !visible;
    };

    const actualizarBannerVerificacion = (visible) => {
      if (!bannerVerificacion) return;
      bannerVerificacion.hidden = !visible;
      bannerVerificacion.classList.toggle('visible', visible);
    };

    formPerfil.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!state.user) {
        mostrarEstadoCuenta('Inicia sesión para actualizar tu nombre.', true);
        return;
      }
      const displayName = sanitizeText(formPerfil.displayName.value);
      if (!displayName) {
        mostrarEstadoCuenta('El nombre no puede estar vacío.', true);
        return;
      }
      try {
        if (!firebaseDisponible || !auth || !auth.currentUser) {
          mostrarEstadoCuenta('No se pudo actualizar el nombre. Verifica tu conexión.', true);
          return;
        }
        await updateProfile(auth.currentUser, { displayName });
        state.user.displayName = displayName;
        formPerfil.displayName.value = displayName;
        mostrarEstadoCuenta('Nombre actualizado correctamente.');
      } catch (error) {
        mostrarEstadoCuenta('No se pudo actualizar el nombre. Intenta de nuevo.', true);
        logError(error, 'perfil');
      }
    });

    if (formPassword) formPassword.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!state.user) {
        mostrarEstadoCuenta('Inicia sesión para cambiar la contraseña.', true);
        return;
      }
      const actual = inputPasswordActual.value;
      const nueva = inputNuevaPassword.value;
      const confirmar = inputConfirmarPassword.value;
      let valido = true;
      if (!actual) {
        mostrarMensajeCampo(errorPasswordActual, 'Introduce tu contraseña actual.');
        valido = false;
      }
      if (!cumplePasswordSegura(nueva)) {
        mostrarMensajeCampo(
          errorNuevaPassword,
          'La nueva contraseña debe cumplir todos los requisitos de seguridad.'
        );
        valido = false;
      }
      if (nueva && nueva === actual) {
        mostrarMensajeCampo(errorNuevaPassword, 'La nueva contraseña debe ser distinta a la actual.');
        valido = false;
      }
      if (nueva !== confirmar) {
        mostrarMensajeCampo(errorConfirmarPassword, 'Las contraseñas no coinciden.');
        valido = false;
      }
      if (!valido) return;
      if (!firebaseDisponible || !auth || !auth.currentUser) {
        mostrarEstadoCuenta('No se pudo actualizar la contraseña. Verifica tu conexión.', true);
        return;
      }
      setBotonCargando(btnActualizarPassword, true, 'Actualizando…');
      try {
        await authFunctions.changePassword(actual, nueva);
        mostrarEstadoCuenta('Contraseña actualizada.');
        cerrarCambioPassword();
      } catch (error) {
        if (error.code === 'auth/wrong-password') {
          mostrarMensajeCampo(errorPasswordActual, 'Contraseña actual incorrecta.');
        } else if (error.code === 'auth/too-many-requests') {
          mostrarMensajeCampo(errorPasswordActual, 'Demasiados intentos, intenta más tarde.');
        } else if (error.code === 'auth/requires-recent-login') {
          mostrarEstadoCuenta('Vuelve a iniciar sesión para confirmar el cambio de contraseña.', true);
        } else if (error.code === 'auth/no-email') {
          mostrarEstadoCuenta('Tu cuenta no tiene un email válido.', true);
        } else {
          mostrarEstadoCuenta('No se pudo actualizar la contraseña.', true);
        }
        logError(error, 'password');
      } finally {
        setBotonCargando(btnActualizarPassword, false);
      }
    });

    if (btnVerificarCorreo) {
      btnVerificarCorreo.addEventListener('click', () => solicitarEmailVerificacion(btnVerificarCorreo));
    }
    if (btnReenviarVerificacionBanner) {
      btnReenviarVerificacionBanner.addEventListener('click', () => solicitarEmailVerificacion(btnReenviarVerificacionBanner));
    }

    async function actualizarUIAuth(user) {
      const habiaSesionActiva = Boolean(state.user);
      if (!user) {
        detenerMonitoreoInactividad();
        detenerMonitoreoVerificacion();
        state.user = null;
        setUserRole(USER_ROLES.VISITANTE);
        ultimoUidSincronizado = null;
        btnLogin.hidden = false;
        btnLogout.hidden = true;
        if (btnMenuAdmin) btnMenuAdmin.hidden = true;
        if (itemMenuAdmin) itemMenuAdmin.hidden = true;
        if (seccionAdmin) seccionAdmin.hidden = true;
        panelCuenta.disabled = true;
        cerrarModalAdmin();
        cerrarLogin();
        if (estadoCuenta) estadoCuenta.hidden = true;
        if (btnInicializarSemilla) {
          btnInicializarSemilla.hidden = true;
          btnInicializarSemilla.disabled = false;
        }
        limpiarLogSemilla();
        if (formPerfil?.displayName) {
          formPerfil.displayName.value = '';
          formPerfil.displayName.disabled = true;
        }
        actualizarListaBaneados();
        actualizarBannerVerificacion(false);
        if (textoEmailActual) textoEmailActual.textContent = '—';
        actualizarPanelCuentaProtegido();
        actualizarProteccionesResena();
        actualizarBotonVerificacion();
        if (habiaSesionActiva) {
          bienvenidaAutoMostrada = false;
        }
        mostrarBienvenidaInvitado();
        return;
      }
      btnLogin.hidden = true;
      btnLogout.hidden = false;
      cancelarBienvenidaProgramada();
      cerrarModalBienvenida({ mantenerEstado: true });
      panelCuenta.disabled = false;
      iniciarMonitoreoInactividad();
      if (estadoCuenta) estadoCuenta.hidden = true;
      try {
        await user.reload();
      } catch (error) {
        console.warn('No se pudo actualizar el usuario', error);
      }
      const nombrePreferido = (user.displayName || '').trim();
      const alias = obtenerAliasDesdeCorreo(user.email || user.uid || '');
      const emailVerificado = Boolean(user.emailVerified);
      const displayNameSeguro = (nombrePreferido || alias).slice(0, 60);
      state.user = {
        uid: user.uid,
        email: user.email || '',
        displayName: displayNameSeguro,
        photoURL: user.photoURL || null,
        emailVerificado
      };
      ultimoUidSincronizado = state.user.uid;
      if (textoEmailActual) textoEmailActual.textContent = state.user.email || '—';
      if (formPerfil?.displayName) {
        formPerfil.displayName.disabled = false;
        formPerfil.displayName.value = state.user.displayName;
      }
      actualizarPanelCuentaProtegido();
      actualizarProteccionesResena();
      actualizarBotonVerificacion();
      await safeFirestoreOp(async () => {
        await sincronizarUsuarioDesdeFirestore(user, { crearSiNoExiste: true });
      });
      // Los roles se obtienen desde la colección /usuarios y se reflejan en la
      // interfaz para decidir qué acciones están disponibles en el cliente.
      actualizarBannerVerificacion(!emailVerificado);
      const esAdmin = state.claims.role === USER_ROLES.ADMIN && emailVerificado;
      if (btnMenuAdmin) btnMenuAdmin.hidden = !esAdmin;
      if (itemMenuAdmin) itemMenuAdmin.hidden = !esAdmin;
      if (seccionAdmin && !esAdmin) seccionAdmin.hidden = true;
      if (btnInicializarSemilla) {
        btnInicializarSemilla.hidden = !esAdmin;
        btnInicializarSemilla.disabled = false;
      }
      if (!esAdmin) limpiarLogSemilla();
      if (!esAdmin) cerrarModalAdmin();
      if (esAdmin) {
        await safeFirestoreOp(async () => {
          await renderAdminLista();
        });
        actualizarListaBaneados();
      }
    }

    const cargarDatosIniciales = async () => {
      try {
        await Promise.all([
          cargarColeccion('lugares', { reiniciar: true }),
          cargarColeccion('restaurantes', { reiniciar: true }),
          cargarColeccion('ocio', { reiniciar: true }),
          cargarResenas({ reiniciar: true })
        ]);
        actualizarIdeas();
        if (!firebaseDisponible || !db) {
          prepararCalendario([]);
          state.historia = [];
          renderHistoria([]);
          safeSetGPX(null);
          iframeMapa.src = 'about:blank';
          state.configuracion = {};
          await obtenerIPPublica();
          return;
        }
        let eventosDocs = [];
        try {
          eventosDocs = await safeFirestoreOp(
            async () => {
              const eventosSnap = await getDocs(
                query(collection(db, 'eventos'), orderBy('fecha', 'asc'), limit(200))
              );
              return eventosSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            },
            []
          );
        } catch (error) {
          manejarErrorFirebase(error, 'eventos');
        }
        prepararCalendario(eventosDocs);

        let historiaDocs = [];
        try {
          historiaDocs = await safeFirestoreOp(
            async () => {
              const historiaSnap = await getDocs(
                query(collection(db, 'historia'), orderBy('anio', 'asc'), limit(50))
              );
              return historiaSnap.docs.map(d => ({ id: d.id, ...d.data() }));
            },
            []
          );
        } catch (error) {
          manejarErrorFirebase(error, 'historia');
        }
        state.historia = Array.isArray(historiaDocs) ? historiaDocs : [];
        renderHistoria(state.historia);

        // Solo cargar configuración si el usuario está autenticado como admin
        if (puedeUsarPanelAdmin()) {
          try {
            const configuracionSnap = await getDocs(query(collection(db, "configuracion"), limit(5)));
            if (!configuracionSnap.empty) {
              configuracionSnap.docs.forEach(docCfg => {
                const data = docCfg.data();
                if (data.gpx) {
                  safeSetGPX(data.gpx);
                }
                if (data.mapa?.q && Array.isArray(data.mapa.q) && data.mapa.q.length === 2) {
                  const [lat, lng] = data.mapa.q;
                  iframeMapa.src = `https://www.google.com/maps?q=${lat},${lng}&output=embed`;
                }
                if (typeof data.proxyIp === 'string') {
                  try {
                    const proxyUrl = new URL(data.proxyIp, location.origin);
                    if (/^https?:$/.test(proxyUrl.protocol)) {
                      state.configuracion.proxyIp = proxyUrl.toString();
                    }
                  } catch (error) {
                    console.warn('Proxy de IP inválido en configuración remota', error);
                  }
                }
              });
            }
          } catch (error) {
            console.warn('[configuracion] No se pudo cargar:', error);
          }
        } else {
          // Usuario no autenticado o sin permisos: valores por defecto
          safeSetGPX(null);
          iframeMapa.src = 'about:blank';
        }

        await obtenerIPPublica();
      } catch (error) {
        manejarErrorFirebase(error, 'datos-iniciales');
        prepararCalendario([]);
        state.historia = [];
        renderHistoria([]);
        safeSetGPX(null);
        iframeMapa.src = 'about:blank';
        await obtenerIPPublica();
      }
    };

        // Configuración inicial y listeners de limpieza
    const limpiarAlDesactivar = () => {
      if (state.climaTimeout) {
        clearTimeout(state.climaTimeout);
        state.climaTimeout = null;
      }
    };

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        limpiarAlDesactivar();
      } else if (!state.climaCache || Date.now() - state.climaCache.timestamp >= 10 * 60 * 1000) {
        inicializarClima();
      }
    });

    window.addEventListener('beforeunload', () => {
      limpiarAlDesactivar();
    });

    // Inicializar configuraciones base
    aplicarPreferencias();
    mostrarConsentimiento();
    if (state.consentimiento === 'aceptado' && puedeEjecutarAnalyticsEnDominio) activarAnalytics();
    inicializarClima();

    // Configurar autenticación y cargar datos
    if (firebaseDisponible && auth) {
      onAuthStateChanged(auth, async (user) => {
        const debeActualizar = !user || user.uid !== ultimoUidSincronizado;
        if (debeActualizar) {
          await actualizarUIAuth(user);
        }
        await cargarDatosIniciales();
      });
    } else {
      actualizarUIAuth(null);
      cargarDatosIniciales();
    }



    
  </script>

  <footer>
    <strong>Hecho por Daniel Terroba Alcala</strong>
    <p style="margin:0.5rem 0 0;">Guía turística oficial de San Martín de la Vega · Datos no verificados por el equipo municipal.</p>
  </footer>
</body>
</html>
