<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Turismo San Mart√≠n de la Vega</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=OpenDyslexic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-fondo: #ffffff;
      --color-superficie: #f5f7fb;
      --color-primario: #0b3d91;
      --color-primario-suave: #174aa8;
      --color-secundario: #4caf50;
      --color-aviso: #ffc107;
      --color-texto: #17202a;
      --color-texto-suave: #424b57;
      --color-borde: rgba(11, 61, 145, 0.1);
      --color-alerta: #d32f2f;
      --sombra: 0 12px 24px rgba(11, 61, 145, 0.08);
      --radio: 18px;
      --font-base: "Open Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --font-dyslexia: "OpenDyslexic", "Open Sans", sans-serif;
      --tamano-base: 16px;
      --line-height: 1.55;
      --espaciado-letras: 0;
      --espaciado-palabras: 0;
      --alto-cta: 48px;
      --fondo-gradiente: linear-gradient(180deg, #eef2ff 0%, #ffffff 45%, #f4f9ff 100%);
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-base);
      font-size: var(--tamano-base);
      line-height: var(--line-height);
      letter-spacing: var(--espaciado-letras);
      word-spacing: var(--espaciado-palabras);
      background: var(--color-fondo);
      background-image: var(--fondo-gradiente);
      background-attachment: fixed;
      color: var(--color-texto);
      transition: background 0.3s ease, color 0.3s ease;
    }

    h1, h2, h3, h4 {
      font-weight: 700;
      margin: 0;
    }

    p {
      margin: 0 0 1rem;
      text-align: left;
    }

    img {
      max-width: 100%;
      display: block;
    }

    a {
      color: inherit;
    }

    button, input, select, textarea {
      font-family: inherit;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--color-primario);
      color: #fff;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 8px 18px rgba(11, 61, 145, 0.18);
    }

    header img {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }

    .titulo-app {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .titulo-app small {
      font-size: 0.75rem;
      opacity: 0.85;
    }

    .menu-toggle {
      background: rgba(255, 255, 255, 0.12);
      border: none;
      color: #fff;
      width: 48px;
      height: 48px;
      border-radius: 12px;
      font-size: 1.4rem;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .menu-toggle:active,
    .menu-toggle:focus-visible {
      outline: none;
      background: rgba(255, 255, 255, 0.24);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      max-width: 1440px;
      margin: 0 auto;
      width: 100%;
    }

    nav {
      position: fixed;
      inset: 0 auto 0 -310px;
      width: 280px;
      background: linear-gradient(180deg, var(--color-primario-suave) 0%, #0a2f70 100%);
      box-shadow: 12px 0 32px rgba(11, 61, 145, 0.08);
      padding: 1.5rem 1.25rem 4rem;
      overflow-y: auto;
      transition: transform 0.28s ease;
      z-index: 120;
    }

    nav,
    nav p,
    nav strong,
    nav small {
      color: #f2f6ff;
    }

    nav.abierto {
      transform: translateX(310px);
    }

    .overlay-menu {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.24s ease;
      z-index: 110;
    }

    .overlay-menu.visible {
      opacity: 1;
      visibility: visible;
    }

    .nav-logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .nav-logo img {
      width: 48px;
    }

    .nav-links {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .nav-links li button {
      width: 100%;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 12px;
      padding: 0.9rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      color: #f0f4ff;
      cursor: pointer;
      transition: background 0.2s ease, border 0.2s ease, transform 0.2s ease;
    }

    .nav-links li button:hover,
    .nav-links li button:focus-visible,
    .nav-links li button.activo {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.45);
      transform: translateX(2px);
      outline: none;
    }

    .sub-lista {
      list-style: none;
      margin: 0.2rem 0 0.5rem 0;
      padding: 0.4rem 1rem 0.6rem 1.75rem;
      display: none;
      flex-direction: column;
      gap: 0.55rem;
      background: rgba(18, 74, 168, 0.88);
      border-radius: 12px;
    }

    .sub-lista.visible {
      display: flex;
    }

    .sub-lista button {
      justify-content: flex-start;
      gap: 0.75rem;
      font-weight: 500;
      font-size: 0.9rem;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: #e8efff;
    }

    main {
      padding: 1.5rem 1rem 4rem;
      width: min(1100px, calc(100% - 2rem));
      margin: 0 auto;
      display: grid;
      gap: 2rem;
    }

    .panel-hero {
      background: linear-gradient(135deg, rgba(11, 61, 145, 0.95), rgba(76, 175, 80, 0.88));
      color: #fff;
      border-radius: var(--radio);
      padding: 1.75rem;
      display: grid;
      gap: 1.5rem;
      box-shadow: var(--sombra);
      margin-bottom: 2rem;
    }

    .panel-hero.oculto {
      display: none;
    }

    .panel-hero .botones {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .btn-primario,
    .btn-secundario {
      border-radius: 14px;
      border: none;
      padding: 0 1.6rem;
      height: var(--alto-cta);
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    .btn-primario {
      background: var(--color-secundario);
      color: #fff;
      box-shadow: 0 12px 30px rgba(76, 175, 80, 0.25);
    }

    .btn-secundario {
      background: #fff;
      color: var(--color-primario);
      border: 2px solid rgba(11, 61, 145, 0.18);
      box-shadow: 0 10px 20px rgba(11, 61, 145, 0.08);
    }

    .panel-hero .btn-secundario {
      background: rgba(255, 255, 255, 0.14);
      color: #fff;
      border-color: rgba(255, 255, 255, 0.35);
      box-shadow: none;
    }

    .btn-primario:active,
    .btn-secundario:active {
      transform: scale(0.98);
    }

    .btn-primario:hover,
    .btn-secundario:hover {
      transform: translateY(-1px);
    }

    .seccion {
      margin-bottom: 2.5rem;
    }

    .seccion-encabezado {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .buscador {
      flex: 1;
      min-width: 220px;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: var(--color-superficie);
      border-radius: 999px;
      padding: 0.55rem 1.2rem;
      box-shadow: inset 0 0 0 1px var(--color-borde);
    }

    .buscador input {
      border: none;
      background: transparent;
      width: 100%;
      color: inherit;
      font-size: 1rem;
    }

    .buscador input:focus {
      outline: none;
    }

    .chips-filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid var(--color-primario);
      background: transparent;
      color: var(--color-primario);
      padding: 0.35rem 0.85rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }

    .chip.activo {
      background: var(--color-primario);
      color: #fff;
      transform: translateY(-1px);
    }

    .rejilla-tarjetas {
      display: grid;
      gap: 1.5rem;
    }

    @media (min-width: 700px) {
      .rejilla-tarjetas {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }

      .sos-contenido li > .btn-secundario {
        width: auto;
      }

      #farmaciaGuardia .btn-secundario {
        width: auto;
      }
    }

    .tarjeta {
      border-radius: var(--radio);
      background: var(--color-superficie);
      box-shadow: var(--sombra);
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }

    .tarjeta.cerrada .tarjeta-detalle {
      max-height: 0;
      padding: 0 1.5rem;
      opacity: 0;
      pointer-events: none;
    }

    .tarjeta.abierta {
      transform: translateY(-4px);
    }

    .tarjeta-portada {
      position: relative;
      height: 240px;
      overflow: hidden;
      border-bottom: 1px solid rgba(11, 61, 145, 0.08);
    }

    .tarjeta-slider {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .tarjeta-slider img,
    .tarjeta-portada iframe {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .tarjeta-slider img.activa {
      opacity: 1;
    }

    .slider-control {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.45);
      border: none;
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      cursor: pointer;
      backdrop-filter: blur(4px);
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .slider-control:hover {
      background: rgba(0, 0, 0, 0.65);
      transform: translateY(-50%) scale(1.05);
    }

    .slider-control[data-control="prev"] {
      left: 14px;
    }

    .slider-control[data-control="next"] {
      right: 14px;
    }

    .slider-indicadores {
      position: absolute;
      bottom: 12px;
      left: 50%;
      transform: translateX(-50%);
      display: inline-flex;
      gap: 0.4rem;
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.35);
    }

    .slider-indicadores button {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.45);
      cursor: pointer;
      padding: 0;
    }

    .slider-indicadores button.activo {
      background: #fff;
      transform: scale(1.1);
    }

    .tarjeta-contenido {
      padding: 1.5rem;
      display: grid;
      gap: 1rem;
    }

    .tarjeta-valoracion {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      font-weight: 700;
      color: var(--color-aviso);
    }

    .tarjeta-valoracion small {
      font-weight: 600;
      color: var(--color-texto-suave);
    }

    .tarjeta-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .tarjeta-tag {
      background: rgba(11, 61, 145, 0.1);
      color: var(--color-primario);
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .tarjeta-acciones {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: stretch;
    }

    .tarjeta-acciones > * {
      flex: 1 1 140px;
      text-align: center;
    }

    .tarjeta-detalle {
      padding: 0 1.5rem 1.5rem;
      display: grid;
      gap: 1rem;
      transition: all 0.28s ease;
      max-height: 1200px;
    }

    .aviso-invitado {
      background: rgba(11, 61, 145, 0.08);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
      color: var(--color-texto);
      margin: 0 0 1.5rem;
    }

    .mapa-contenedor {
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
    }

    .mapa-contenedor iframe {
      border: 0;
      width: 100%;
      height: 260px;
    }

    .btn-favorito {
      margin-left: auto;
      background: transparent;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .btn-favorito.favorito {
      color: #ff5a5f;
      transform: scale(1.1);
    }

    .rese√±as-lista {
      display: grid;
      gap: 1rem;
    }

    .rese√±a {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      padding: 1rem 1.2rem;
      box-shadow: inset 0 0 0 1px rgba(11, 61, 145, 0.08);
    }

    .rese√±a-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .estrellas {
      color: #ffb400;
      font-size: 1rem;
    }

    .rese√±a-acciones {
      display: flex;
      gap: 0.5rem;
    }

    .rese√±a-acciones button {
      border: none;
      border-radius: 8px;
      padding: 0.35rem 0.6rem;
      cursor: pointer;
      background: rgba(11, 61, 145, 0.08);
    }

    form.rese√±a-form {
      display: grid;
      gap: 0.75rem;
      background: rgba(11, 61, 145, 0.07);
      border-radius: 16px;
      padding: 1rem 1.2rem;
    }

    .rating-input {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .rating-input input[type="radio"] {
      display: none;
    }

    .rating-input label {
      font-size: 1.5rem;
      color: #ccc;
      cursor: pointer;
    }

    .rating-input input:checked ~ label,
    .rating-input label:hover,
    .rating-input label:hover ~ label {
      color: #ffb400;
    }

    textarea {
      min-height: 110px;
      border-radius: 12px;
      border: 1px solid rgba(11, 61, 145, 0.15);
      padding: 0.75rem;
      resize: vertical;
    }

    .chips-emocion {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .chip-emocion {
      padding: 0.35rem 0.75rem;
      border-radius: 10px;
      border: 1px solid rgba(11, 61, 145, 0.22);
      background: rgba(255, 255, 255, 0.7);
      cursor: pointer;
    }

    .chip-emocion.activo {
      background: rgba(11, 61, 145, 0.15);
      border-color: rgba(11, 61, 145, 0.45);
    }

    .historia-linea {
      display: grid;
      gap: 1.5rem;
    }

    .evento-historia {
      border-left: 4px solid var(--color-primario);
      padding: 0.75rem 1rem;
      background: var(--color-superficie);
      border-radius: 12px;
      box-shadow: var(--sombra);
    }

    .evento-historia h3 {
      margin-bottom: 0.4rem;
    }

    .eventos-grid {
      display: grid;
      gap: 1rem;
    }

    .calendario {
      background: var(--color-superficie);
      border-radius: var(--radio);
      padding: 1.25rem;
      box-shadow: var(--sombra);
      overflow: hidden;
    }

    .calendario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .calendario-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.4rem;
    }

    .calendario-dia {
      aspect-ratio: 1;
      border-radius: 12px;
      display: grid;
      place-items: center;
      background: rgba(11, 61, 145, 0.04);
      cursor: default;
      font-weight: 600;
    }

    .calendario-dia .calendario-numero {
      font-size: 1rem;
    }

    .calendario-dia small {
      font-size: 0.7rem;
      font-weight: 700;
      margin-top: 0.15rem;
    }

    .calendario-dia.evento {
      background: rgba(76, 175, 80, 0.2);
      cursor: pointer;
    }

    .calendario-dia.evento[data-tipodia="lectivo"] {
      background: rgba(76, 175, 80, 0.28);
    }

    .calendario-dia.evento[data-tipodia="no_lectivo"] {
      background: rgba(255, 193, 7, 0.32);
    }

    .calendario-dia.evento[data-tipodia="no_laborable"] {
      background: rgba(244, 67, 54, 0.32);
      color: #fff;
    }

    .widget-clima {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      padding: 1rem;
      border-radius: 18px;
      background: rgba(11, 61, 145, 0.08);
      max-width: 280px;
    }

    .ajustes-panel {
      display: grid;
      gap: 1.2rem;
    }

    .ajuste-card {
      background: var(--color-superficie);
      padding: 1.2rem;
      border-radius: 16px;
      box-shadow: var(--sombra);
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .toggle input {
      width: 48px;
      height: 24px;
    }

    .opciones-senior {
      display: grid;
      gap: 0.35rem;
      margin-top: 0.75rem;
      padding-left: 1.5rem;
    }

    .perfil {
      display: grid;
      gap: 1rem;
    }

    .perfil header {
      background: var(--color-superficie);
      color: inherit;
      box-shadow: none;
      padding: 1.5rem;
      border-radius: 16px;
    }

    .admin-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(255, 193, 7, 0.25);
      color: #6a4c00;
      padding: 0.35rem 0.65rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 700;
    }

    .panel-admin {
      display: grid;
      gap: 1.25rem;
    }

    .panel-admin form,
    .panel-admin .tabla-simple,
    .panel-admin .nota-informativa {
      background: var(--color-superficie);
      padding: 1.25rem;
      border-radius: 16px;
      box-shadow: var(--sombra);
      display: grid;
      gap: 0.75rem;
    }

    .panel-admin form label {
      font-weight: 600;
      display: block;
    }

    .panel-admin input,
    .panel-admin textarea,
    .panel-admin select {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      border: 1px solid var(--color-borde);
      font: inherit;
      width: 100%;
    }

    .panel-admin textarea {
      min-height: 140px;
      resize: vertical;
    }

    .panel-admin .tabla-simple table {
      width: 100%;
      border-collapse: collapse;
    }

    .panel-admin .tabla-simple th,
    .panel-admin .tabla-simple td {
      padding: 0.5rem 0.75rem;
      text-align: left;
      border-bottom: 1px solid rgba(11, 61, 145, 0.1);
    }

    .panel-admin .acciones-admin {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .panel-admin .acciones-admin button {
      flex: 1 1 120px;
    }

    .favoritos-grid {
      display: grid;
      gap: 1rem;
    }

    .boton-sos {
      position: fixed;
      bottom: 1.25rem;
      right: 1.25rem;
      background: var(--color-alerta);
      color: #fff;
      border-radius: 999px;
      border: none;
      width: 60px;
      height: 60px;
      font-size: 1.6rem;
      box-shadow: 0 16px 32px rgba(211, 47, 47, 0.35);
      cursor: pointer;
      z-index: 150;
    }

    .sos-panel {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 140;
    }

    .sos-panel.visible {
      display: flex;
    }

    .sos-contenido {
      background: var(--color-fondo);
      color: var(--color-texto);
      padding: 2rem 1.5rem;
      border-radius: 20px;
      width: min(92vw, 420px);
      display: grid;
      gap: 1rem;
      box-shadow: var(--sombra);
    }

    .sos-contenido ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.75rem;
    }

    .sos-contenido li {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      background: var(--color-superficie);
      padding: 0.75rem;
      border-radius: 14px;
    }

    .sos-contenido li > .btn-secundario {
      width: 100%;
      justify-content: center;
    }

    #farmaciaGuardia .btn-secundario {
      margin-top: 0.5rem;
      width: 100%;
      justify-content: center;
    }

    .sos-contenido li .tarjeta-acciones {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .sos-contenido li .tarjeta-acciones a {
      flex: 1 1 120px;
      text-align: center;
    }

    .voz-boton {
      position: fixed;
      bottom: 1.25rem;
      left: 1.25rem;
      width: 58px;
      height: 58px;
      border-radius: 50%;
      border: none;
      background: var(--color-primario);
      color: #fff;
      font-size: 1.4rem;
      box-shadow: 0 18px 30px rgba(11, 61, 145, 0.28);
      display: none;
      z-index: 150;
    }

    .voz-boton.visible {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .modo-oscuro {
      --color-fondo: #121212;
      --color-superficie: #1f2633;
      --color-texto: #e6ecf5;
      --color-texto-suave: #c8d1e0;
      --color-borde: rgba(230, 236, 245, 0.18);
      --sombra: 0 12px 28px rgba(0, 0, 0, 0.45);
      --fondo-gradiente: none;
    }

    .modo-senior {
      --alto-cta: 56px;
    }

    .modo-senior-texto {
      --tamano-base: 19px;
    }

    .modo-senior-contraste {
      --color-superficie: #f2f6ff;
      --color-borde: rgba(11, 61, 145, 0.2);
      --color-texto: #0a2d6c;
      --color-texto-suave: #274f93;
    }

    .modo-senior-botones .btn-primario,
    .modo-senior-botones .btn-secundario,
    .modo-senior-botones .menu-toggle,
    .modo-senior-botones .sub-lista button,
    .modo-senior-botones .chip,
    .modo-senior-botones .chip-emocion {
      font-size: 1.05rem;
      padding-top: 0.9rem;
      padding-bottom: 0.9rem;
    }

    .modo-dislexia {
      --font-base: var(--font-dyslexia);
      --line-height: 1.8;
      --espaciado-letras: 0.04em;
      --espaciado-palabras: 0.08em;
    }

    .modo-lectura-facil {
      --line-height: 1.9;
    }

    .modo-alto-contraste {
      --color-fondo: #050505;
      --color-superficie: #101010;
      --color-texto: #fefefe;
      --color-texto-suave: #f5f5f5;
      --color-borde: rgba(255, 255, 255, 0.35);
    }

    .modo-reducir-movimiento * {
      transition-duration: 0.01s !important;
      animation: none !important;
    }

    .modo-visibilidad {
      --color-fondo: #000000;
      --color-superficie: #0d111a;
      --color-texto: #ffffff;
      --color-texto-suave: #e0e5ee;
      --color-borde: rgba(255, 255, 255, 0.2);
    }

    .sin-datos {
      padding: 2rem;
      text-align: center;
      border-radius: 16px;
      background: var(--color-superficie);
    }

    footer {
      margin-top: 2rem;
      background: linear-gradient(90deg, #0a2f70 0%, #123d94 100%);
      color: #f2f6ff;
      text-align: center;
      padding: 1.75rem 1rem;
    }

    footer p {
      margin: 0.35rem 0;
      font-size: 0.9rem;
    }

    @media (min-width: 900px) {
      .layout {
        grid-template-columns: 280px 1fr;
        gap: 2rem;
      }

      nav {
        position: sticky;
        inset: unset;
        transform: none !important;
        height: calc(100vh - 1.5rem);
        border-radius: 24px;
        margin: 1rem 0 1rem 1.5rem;
        background: rgba(245, 247, 251, 0.92);
        backdrop-filter: blur(12px);
      }

      .overlay-menu {
        display: none;
      }

      main {
        padding: 3rem 2rem 5rem 0;
      }

      header {
        border-radius: 24px;
        margin: 1rem 1.5rem 0;
        padding: 1rem 2rem;
      }

      .rejilla-tarjetas {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      }

      .panel-hero {
        grid-template-columns: 2fr 1fr;
        align-items: center;
      }
    }

    @media (max-width: 520px) {
      .panel-hero .botones {
        flex-direction: column;
        align-items: stretch;
      }

      .btn-primario,
      .btn-secundario {
        width: 100%;
      }

      .tarjeta-portada {
        height: 190px;
      }
    }

    .modal-inicio {
      position: fixed;
      inset: 0;
      background: rgba(9, 23, 64, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 300;
    }

    .modal-inicio.visible {
      opacity: 1;
      pointer-events: all;
    }

    .modal-dialogo {
      background: var(--color-fondo);
      color: var(--color-texto);
      border-radius: 24px;
      width: min(540px, 100%);
      box-shadow: 0 24px 48px rgba(11, 61, 145, 0.18);
      padding: 2rem;
      position: relative;
      display: grid;
      gap: 1.5rem;
    }

    .modal-cerrar {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: transparent;
      border: none;
      font-size: 1.5rem;
      color: inherit;
      cursor: pointer;
    }

    .modal-pasos {
      display: grid;
      gap: 1rem;
    }

    .modal-paso {
      display: none;
      gap: 1rem;
    }

    .modal-paso.visible {
      display: grid;
    }

    .modal-opciones {
      display: grid;
      gap: 0.75rem;
    }

    .form-login {
      display: grid;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .form-login label {
      font-weight: 600;
    }

    .form-login input {
      padding: 0.75rem 1rem;
      border-radius: 12px;
      border: 1px solid var(--color-borde);
      background: var(--color-superficie);
      font-size: 1rem;
    }

    .texto-aviso {
      font-size: 0.85rem;
      color: var(--color-texto-suave);
      margin: 0;
    }
  </style>
</head>
<body>
  <header aria-label="Barra superior">
    <button class="menu-toggle" aria-label="Abrir men√∫" id="btnToggleMenu">‚ò∞</button>
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Escudo_de_San_Mart%C3%ADn_de_la_Vega.svg/240px-Escudo_de_San_Mart%C3%ADn_de_la_Vega.svg.png" alt="Escudo de San Mart√≠n de la Vega" width="40" height="40">
    <div class="titulo-app">
      <h1>Turismo San Mart√≠n de la Vega</h1>
      <small>Gu√≠a interactiva ¬∑ Lugares ¬∑ Gastronom√≠a ¬∑ Historia</small>
    </div>
  </header>

  <div class="overlay-menu" id="overlayMenu" role="presentation"></div>

  <div class="layout">
    <nav id="menuLateral" aria-label="Men√∫ principal">
      <div class="nav-logo">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Escudo_de_San_Mart%C3%ADn_de_la_Vega.svg/240px-Escudo_de_San_Mart%C3%ADn_de_la_Vega.svg.png" alt="Escudo San Mart√≠n de la Vega">
        <div>
          <strong>Explora San Mart√≠n</strong>
          <p style="margin:0;font-size:0.85rem;color:var(--color-texto-suave);">Men√∫ de navegaci√≥n</p>
        </div>
      </div>
      <ul class="nav-links">
        <li>
          <button data-seccion="inicio" class="activo">üè† Inicio</button>
        </li>
        <li>
          <button data-seccion="lugares">üìç Lugares de inter√©s</button>
          <ul class="sub-lista" data-parent="lugares">
            <li><button data-tag="naturaleza">üåø Naturaleza</button></li>
            <li><button data-tag="cultural">üèõÔ∏è Patrimonio</button></li>
            <li><button data-tag="aventura">üé¢ Aventura</button></li>
            <li><button data-tag="familia">üë®‚Äçüë©‚Äçüëß En familia</button></li>
          </ul>
        </li>
        <li>
          <button data-seccion="restaurantes">üçΩÔ∏è Restaurantes</button>
          <ul class="sub-lista" data-parent="restaurantes">
            <li><button data-tag="tradicional">ü•ò Cocina tradicional</button></li>
            <li><button data-tag="tapas">üçª Tapas y Bares</button></li>
            <li><button data-tag="familiar">üç¥ Familiar</button></li>
          </ul>
        </li>
        <li>
          <button data-seccion="ocio">üö¥ Deportes &amp; Ocio</button>
          <ul class="sub-lista" data-parent="ocio">
            <li><button data-tag="senderismo">ü•æ Rutas</button></li>
            <li><button data-tag="agua">üö£ Actividades acu√°ticas</button></li>
          </ul>
        </li>
        <li>
          <button data-seccion="historia">üìú Historia</button>
          <ul class="sub-lista" data-parent="historia">
            <li><button data-epoca="cronologico">üï∞Ô∏è L√≠nea temporal</button></li>
            <li><button data-epoca="topografia">üó∫Ô∏è Topograf√≠a</button></li>
            <li><button data-epoca="conflictos">‚öîÔ∏è Conflictos b√©licos</button></li>
          </ul>
        </li>
        <li>
          <button data-seccion="eventos">üìÜ Festividades</button>
        </li>
        <li>
          <button data-seccion="perfil">üë§ Mi perfil</button>
        </li>
        <li>
          <button data-seccion="ajustes">‚öôÔ∏è Ajustes &amp; Accesibilidad</button>
        </li>
        <li class="solo-admin" hidden>
          <button data-seccion="admin">üõ†Ô∏è Panel de administraci√≥n</button>
        </li>
      </ul>
    </nav>

    <main id="contenido" tabindex="-1">
      <section class="panel-hero" id="panelHero">
        <div>
          <h2>Descubre la esencia de San Mart√≠n de la Vega</h2>
          <p>Planifica tu visita, guarda tus lugares favoritos y vive experiencias √∫nicas en el coraz√≥n del valle del Jarama. Informaci√≥n siempre actualizada gracias a Firebase.</p>
          <div class="botones">
            <button class="btn-primario" data-seccion-go="lugares">Explorar lugares</button>
            <button class="btn-secundario" data-seccion-go="historia">Conocer su historia</button>
          </div>
        </div>
        <aside class="widget-clima" aria-live="polite" id="widgetClima">
          <strong>Clima local</strong>
          <span id="climaResumen">Obteniendo clima...</span>
          <small id="climaDetalle">Actualizando datos meteorol√≥gicos.</small>
          <button class="btn-secundario" id="btnActualizarClima" style="width:max-content;">Actualizar</button>
        </aside>
      </section>

      <section class="seccion" id="seccionContenido">
        <div class="sin-datos">
          Selecciona una categor√≠a del men√∫ para comenzar.
        </div>
      </section>
    </main>
  </div>

  <footer>
    <p>Hecho por Daniel Terroba Alcal√° ¬∑ Todos los derechos reservados.</p>
    <p>Uso abierto para la ciudadan√≠a ¬∑ Prohibida su reproducci√≥n con fines comerciales sin autorizaci√≥n.</p>
  </footer>

  <div class="modal-inicio" id="modalInicio" aria-hidden="true">
    <div class="modal-dialogo" role="dialog" aria-modal="true" aria-labelledby="modalInicioTitulo">
      <button class="modal-cerrar" id="cerrarModalInicio" aria-label="Cerrar ventana de inicio">√ó</button>
      <div class="modal-pasos">
        <section class="modal-paso visible" data-paso="adaptacion">
          <h2 id="modalInicioTitulo">¬øNecesitas la adaptaci√≥n para tercera edad?</h2>
          <p>Podemos aumentar el tama√±o del texto y mejorar el contraste para que la experiencia sea m√°s c√≥moda.</p>
          <div class="modal-opciones">
            <button class="btn-primario" data-accion-adaptacion="si">S√≠, activar modo tercera edad</button>
            <button class="btn-secundario" data-accion-adaptacion="no">No, continuar con el modo est√°ndar</button>
          </div>
        </section>
        <section class="modal-paso" data-paso="sesion">
          <h2 id="modalSesionTitulo">Inicia sesi√≥n o contin√∫a como invitado</h2>
          <p class="texto-aviso">Elige c√≥mo deseas acceder para sincronizar tus favoritos y rese√±as.</p>
          <form class="form-login" id="formLoginCorreo">
            <div>
              <label for="loginCorreo">Correo electr√≥nico</label>
              <input type="email" id="loginCorreo" name="correo" autocomplete="email" required>
            </div>
            <div>
              <label for="loginPassword">Contrase√±a</label>
              <input type="password" id="loginPassword" name="password" autocomplete="current-password" required>
            </div>
            <button type="submit" class="btn-primario">Entrar con correo</button>
            <small class="texto-aviso">Si no tienes cuenta la crearemos autom√°ticamente.</small>
          </form>
          <div class="modal-opciones">
            <button class="btn-secundario" data-login="google" id="btnModalGoogle">Continuar con Google</button>
            <button class="btn-secundario" data-login="facebook" id="btnModalFacebook">Continuar con Facebook</button>
            <button class="btn-secundario" id="btnModalInvitado">Seguir como invitado</button>
            <p class="texto-aviso">Los invitados pueden explorar la gu√≠a pero no publicar rese√±as.</p>
          </div>
        </section>
      </div>
    </div>
  </div>

  <button class="boton-sos" id="btnSOS" aria-haspopup="dialog" aria-controls="sosPanel" aria-expanded="false">‚öïÔ∏è</button>
  <div class="sos-panel" id="sosPanel" role="dialog" aria-modal="true" aria-labelledby="sosTitulo">
    <div class="sos-contenido">
      <header>
        <h2 id="sosTitulo">Informaci√≥n √∫til y emergencias</h2>
        <p>Contactos disponibles 24/7 en San Mart√≠n de la Vega.</p>
      </header>
      <ul>
        <li>
          <strong>Emergencias generales</strong>
          <span>112</span>
          <a class="btn-secundario" href="tel:112">Llamar</a>
        </li>
        <li>
          <strong>Polic√≠a Local</strong>
          <span>918 949 016</span>
          <div class="tarjeta-acciones">
            <a class="btn-secundario" href="tel:918949016">Llamar</a>
            <a class="btn-secundario" href="https://maps.google.com/?q=Polic%C3%ADa+Local+San+Mart%C3%ADn+de+la+Vega" target="_blank" rel="noopener">Ver mapa</a>
          </div>
        </li>
        <li>
          <strong>Centro de Salud</strong>
          <span>918 949 019 ¬∑ C/ Maestro Rodrigo, 2</span>
          <div class="tarjeta-acciones">
            <a class="btn-secundario" href="tel:918949019">Llamar</a>
            <a class="btn-secundario" href="https://maps.google.com/?q=Centro+de+Salud+San+Mart%C3%ADn+de+la+Vega" target="_blank" rel="noopener">Ver mapa</a>
          </div>
        </li>
        <li>
          <strong>Farmacia de Guardia</strong>
          <span id="farmaciaGuardia">Consultar Ayuntamiento ¬∑ Actualizado diariamente</span>
        </li>
      </ul>
      <button class="btn-primario" id="btnCerrarSOS">Cerrar</button>
    </div>
  </div>

  <button class="voz-boton" id="btnVoz" aria-label="Activar comandos por voz">üéôÔ∏è</button>

  <script type="module">
    'use strict';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
    import { getAnalytics, logEvent } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-analytics.js';
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      where,
      orderBy,
      addDoc,
      serverTimestamp,
      updateDoc,
      deleteDoc,
      doc
    } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
    import {
      getAuth,
      onAuthStateChanged,
      GoogleAuthProvider,
      FacebookAuthProvider,
      signInWithPopup,
      signOut,
      deleteUser,
      signInWithRedirect,
      getRedirectResult,
      reauthenticateWithPopup,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword
    } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js';
    import {
      getStorage,
      ref as storageRef,
      getDownloadURL
    } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js';

    const firebaseConfig = {
      apiKey: window.FIREBASE_API_KEY || 'REEMPLAZAR_API_KEY',
      authDomain: window.FIREBASE_AUTH_DOMAIN || 'REEMPLAZAR_AUTH_DOMAIN',
      projectId: window.FIREBASE_PROJECT_ID || 'REEMPLAZAR_PROJECT_ID',
      storageBucket: window.FIREBASE_STORAGE_BUCKET || 'REEMPLAZAR_STORAGE_BUCKET',
      messagingSenderId: window.FIREBASE_MESSAGING_ID || 'REEMPLAZAR_SENDER_ID',
      appId: window.FIREBASE_APP_ID || 'REEMPLAZAR_APP_ID',
      measurementId: window.FIREBASE_MEASUREMENT_ID || 'REEMPLAZAR_MEASUREMENT_ID'
    };

    let app;
    let analytics;
    let db;
    let auth;
    let storage;

    try {
      app = initializeApp(firebaseConfig);
      analytics = getAnalytics(app);
      db = getFirestore(app);
      auth = getAuth(app);
      storage = getStorage(app);
    } catch (error) {
      console.warn('Firebase no se inicializ√≥ correctamente. Se usar√° modo offline.', error);
    }

    const estado = {
      usuario: null,
      usuarioInvitado: false,
      esAdmin: false,
      seccionActual: 'inicio',
      filtros: {
        texto: '',
        etiquetas: new Set(),
        epocaHistoria: 'cronologico'
      },
      datos: {
        lugares: [],
        restaurantes: [],
        ocio: [],
        historia: [],
        eventos: [],
        rese√±as: [],
        favoritos: new Set()
      },
      modoOscuro: false,
      modoSenior: false,
      modoDislexia: false,
      modoVisibilidad: false,
      modoLecturaFacil: false,
      modoAltoContraste: false,
      modoReducirMovimiento: false,
      preferenciasSenior: {
        textoAmpliado: true,
        contraste: true,
        botonesAmplios: true
      },
      valoraciones: new Map(),
      reconocimientoActivo: false,
      intervaloClima: null,
      autenticacionOffline: false
    };

    const climaPredeterminado = {
      resumen: '18¬∞C ¬∑ Despejado',
      detalle: 'Sensaci√≥n: 17¬∞C ¬∑ Humedad: 42%'
    };

    const restablecerClima = () => {
      const resumen = qs('#climaResumen');
      const detalle = qs('#climaDetalle');
      if (!resumen || !detalle) return;
      resumen.textContent = 'Obteniendo clima...';
      detalle.textContent = 'Actualizando datos meteorol√≥gicos.';
    };

    const programarRefrescoClima = () => {
      if (estado.intervaloClima) clearInterval(estado.intervaloClima);
      estado.intervaloClima = setInterval(() => inicializarClima({ silencioso: true }), 5 * 60 * 1000);
    };

    const actualizarFarmaciaGuardia = () => {
      const contenedor = qs('#farmaciaGuardia');
      if (!contenedor) return;
      const hoy = new Date();
      const info = farmaciasGuardia.find((farmacia) => farmacia.dia === hoy.getDay());
      const enlaceFallback = farmaciasGuardia[0]?.enlace || 'https://www.cofm.es/farmacias-de-guardia';
      if (info) {
        contenedor.innerHTML = `${info.nombre} ¬∑ ${info.direccion} ¬∑ <a href="tel:${info.telefono}">${info.telefono}</a><br><a class="btn-secundario" href="${info.enlace}" target="_blank" rel="noopener">Consultar turnos</a>`;
      } else {
        contenedor.innerHTML = `Consulta la farmacia de guardia en <a href="${enlaceFallback}" target="_blank" rel="noopener">la web del Colegio de Farmac√©uticos</a>.`;
      }
    };

    const imagenGenerica = 'assets/lugar-warner.svg';

    const datosFallback = {
      lugares: [
        {
          id: 'warner',
          nombre: 'Parque Warner Madrid',
          descripcion: 'Parque tem√°tico con atracciones para toda la familia y espect√°culos diarios.',
          tipo: 'aventura',
          etiquetas: ['familia', 'aventura', 'amigos', 'fin de semana'],
          direccion: 'Carretera M-506, San Mart√≠n de la Vega',
          coords: { lat: 40.2296, lng: -3.5954 },
          portada: 'assets/lugar-warner.svg',
          multimedia: ['assets/lugar-warner.svg'],
          galeria: [
            'assets/lugar-warner.svg',
            'assets/lugar-warner-2.svg',
            'assets/lugar-warner-3.svg'
          ]
        },
        {
          id: 'iglesia',
          nombre: 'Iglesia de la Natividad de Nuestra Se√±ora',
          descripcion: 'Templo del siglo XVII con una destacada torre mud√©jar, epicentro del casco hist√≥rico.',
          tipo: 'cultural',
          etiquetas: ['cultural', 'patrimonio', 'familia'],
          direccion: 'Plaza de la Iglesia, 1',
          coords: { lat: 40.2086, lng: -3.5657 },
          portada: 'assets/lugar-iglesia.svg',
          galeria: [
            'assets/lugar-iglesia.svg',
            'assets/lugar-iglesia-2.svg',
            'assets/lugar-iglesia-3.svg'
          ]
        },
        {
          id: 'mara√±osa',
          nombre: 'Cerros de la Mara√±osa',
          descripcion: 'Paraje natural ligado a la batalla del Jarama. Ideal para rutas interpretativas.',
          tipo: 'naturaleza',
          etiquetas: ['naturaleza', 'historia', 'senderismo'],
          direccion: 'Carretera de la Mara√±osa',
          coords: { lat: 40.3223, lng: -3.5611 },
          portada: 'assets/lugar-maranosa.svg',
          galeria: [
            'assets/lugar-maranosa.svg',
            'assets/lugar-maranosa-2.svg',
            'assets/lugar-maranosa-3.svg'
          ]
        }
      ],
      restaurantes: [
        {
          id: 'zatara',
          nombre: 'Restaurante Cervecer√≠a Zatara',
          descripcion: 'Cocina casera espa√±ola con especialidad en mariscos, carnes y tapas abundantes.',
          tipo: 'tradicional',
          etiquetas: ['familia', 'tapas', 'tradicional'],
          direccion: 'Calle Mayor, 18',
          coords: { lat: 40.2081, lng: -3.5652 },
          portada: 'assets/restaurante-zatara.svg',
          galeria: [
            'assets/restaurante-zatara.svg',
            'assets/restaurante-zatara-2.svg',
            'assets/restaurante-zatara-3.svg'
          ]
        },
        {
          id: 'lindero',
          nombre: 'Mes√≥n El Lindero',
          descripcion: 'Asador castellano con horno de le√±a, carnes selectas y postres caseros.',
          tipo: 'tradicional',
          etiquetas: ['familia', 'tradicional'],
          direccion: 'Av. Nuestra Se√±ora de la Vega, 45',
          coords: { lat: 40.2052, lng: -3.5622 },
          portada: 'assets/restaurante-lindero.svg',
          galeria: [
            'assets/restaurante-lindero.svg',
            'assets/restaurante-lindero-2.svg',
            'assets/restaurante-lindero-3.svg'
          ]
        }
      ],
      ocio: [
        {
          id: 'sendero-jarama',
          nombre: 'Ruta fluvial del Jarama',
          descripcion: 'Recorrido llano junto al r√≠o, ideal para bicicleta o paseo en familia.',
          tipo: 'senderismo',
          etiquetas: ['naturaleza', 'familia', 'senderismo'],
          distancia: '8 km (ida y vuelta)',
          dificultad: 'Baja',
          portada: 'assets/ocio-jarama.svg',
          galeria: [
            'assets/ocio-jarama.svg',
            'assets/ocio-jarama-2.svg',
            'assets/ocio-jarama-3.svg'
          ],
          descargaGPX: 'https://firebasestorage.googleapis.com/v0/b/REEMPLAZAR/o/ruta-jarama.gpx?alt=media'
        },
        {
          id: 'bunker',
          nombre: 'Ruta posiciones de la Mara√±osa',
          descripcion: 'Itinerario hist√≥rico por los bunkers de la Guerra Civil con vistas panor√°micas.',
          tipo: 'senderismo',
          etiquetas: ['historia', 'aventura'],
          distancia: '5 km',
          dificultad: 'Media',
          portada: 'assets/ocio-bunker.svg',
          galeria: [
            'assets/ocio-bunker.svg',
            'assets/ocio-bunker-2.svg',
            'assets/ocio-bunker-3.svg'
          ],
          descargaGPX: 'https://firebasestorage.googleapis.com/v0/b/REEMPLAZAR/o/maranosa.gpx?alt=media'
        }
      ],
      historia: [
        {
          id: 'hist-pre',
          titulo: 'Prehistoria y Edad Antigua',
          epoca: 'cronologico',
          tags: ['cronologico', 'topografia'],
          texto: 'Hallazgos paleol√≠ticos evidencian ocupaci√≥n temprana. En √©poca romana, el paso de calzadas facilit√≥ el asentamiento agr√≠cola gracias a la fertilidad de la vega.'
        },
        {
          id: 'hist-medieval',
          titulo: 'Siglos X-XV: Repoblaci√≥n y disputas',
          epoca: 'cronologico',
          tags: ['cronologico', 'conflictos'],
          texto: 'El enclave fortificado de Albende defend√≠a Toledo. En 1440 la repoblaci√≥n castellana origin√≥ conflictos con Valdemoro por el control de las vegas.'
        },
        {
          id: 'hist-jarama',
          titulo: '1937: Batalla del Jarama',
          epoca: 'conflictos',
          tags: ['conflictos', 'cronologico'],
          texto: 'Uno de los episodios m√°s duros de la Guerra Civil. Los cerros de la Mara√±osa fueron escenario de combates que marcaron la memoria del municipio.'
        },
        {
          id: 'hist-topografia',
          titulo: 'Topograf√≠a y entorno',
          epoca: 'topografia',
          tags: ['topografia'],
          texto: 'La vega del Jarama ofrece suelos f√©rtiles y humedales de alto valor ecol√≥gico, con vegas dedicadas hist√≥ricamente a la agricultura de regad√≠o.'
        }
      ],
      eventos: [
        {
          id: 'romeria',
          fecha: '2024-04-25',
          nombre: 'Romer√≠a de San Marcos',
          descripcion: 'Tradicional romer√≠a hasta la ermita con degustaci√≥n de rosquillas y m√∫sica popular.',
          lugar: 'Ermita de San Marcos',
          tipoDia: 'no_laborable'
        },
        {
          id: 'fiestas',
          fecha: '2024-08-15',
          nombre: 'Fiestas Patronales',
          descripcion: 'Encierros, conciertos nocturnos y actividades infantiles durante toda la semana.',
          lugar: 'Casco urbano',
          tipoDia: 'no_laborable'
        },
        {
          id: 'semana-cultural',
          fecha: '2024-03-12',
          nombre: 'Semana Cultural del Jarama',
          descripcion: 'Talleres escolares, charlas hist√≥ricas y exposiciones fotogr√°ficas abiertas al p√∫blico.',
          lugar: 'Casa de la Cultura',
          tipoDia: 'lectivo'
        },
        {
          id: 'mercadillo-artesano',
          fecha: '2024-10-05',
          nombre: 'Mercadillo Artesano de Oto√±o',
          descripcion: 'Productores locales presentan mieles, aceite y artesan√≠a con talleres familiares.',
          lugar: 'Plaza de la Constituci√≥n',
          tipoDia: 'no_lectivo'
        }
      ],
      rese√±as: [
        {
          id: 'demo-warner',
          itemId: 'warner',
          tipoSeccion: 'lugares',
          rating: 5,
          titulo: 'Diversi√≥n asegurada',
          texto: 'Atracciones para todas las edades y espect√°culos tematizados durante todo el d√≠a.',
          emocion: 'Aventura ü§∏',
          autor: 'Ana Visitante',
          usuario: 'demo-warner',
          fechaCreacion: '2023-12-10T10:00:00.000Z'
        },
        {
          id: 'demo-iglesia',
          itemId: 'iglesia',
          tipoSeccion: 'lugares',
          rating: 4,
          titulo: 'Historia viva',
          texto: 'La visita guiada aporta muchos datos curiosos. La torre mud√©jar es impresionante.',
          emocion: 'Cultura üé®',
          autor: 'Luis Historia',
          usuario: 'demo-iglesia',
          fechaCreacion: '2024-01-05T12:30:00.000Z'
        },
        {
          id: 'demo-zatara',
          itemId: 'zatara',
          tipoSeccion: 'restaurantes',
          rating: 5,
          titulo: 'Tapas de diez',
          texto: 'Raciones generosas y trato cercano. Ideal para cenar despu√©s de un d√≠a de visita.',
          emocion: 'Gastronom√≠a üòã',
          autor: 'Mar√≠a Foodie',
          usuario: 'demo-zatara',
          fechaCreacion: '2024-02-20T20:15:00.000Z'
        }
      ]
    };

    const farmaciasGuardia = [
      { dia: 0, nombre: 'Farmacia Plaza de la Iglesia', direccion: 'Plaza de la Iglesia, 3', telefono: '918 948 120', enlace: 'https://www.cofm.es/farmacias-de-guardia' },
      { dia: 1, nombre: 'Farmacia Parque Europa', direccion: 'Av. Nuestra Se√±ora de la Vega, 12', telefono: '918 947 221', enlace: 'https://www.cofm.es/farmacias-de-guardia' },
      { dia: 2, nombre: 'Farmacia Estrella Polar', direccion: 'Calle Estrella Polar, 8', telefono: '918 945 778', enlace: 'https://www.cofm.es/farmacias-de-guardia' },
      { dia: 3, nombre: 'Farmacia Doctor Mara√±√≥n', direccion: 'Calle Doctor Mara√±√≥n, 5', telefono: '918 946 332', enlace: 'https://www.cofm.es/farmacias-de-guardia' },
      { dia: 4, nombre: 'Farmacia San Marcos', direccion: 'Paseo de la Ermita, 10', telefono: '918 943 220', enlace: 'https://www.cofm.es/farmacias-de-guardia' },
      { dia: 5, nombre: 'Farmacia Vega Alta', direccion: 'Carretera M-841, km 2', telefono: '918 940 550', enlace: 'https://www.cofm.es/farmacias-de-guardia' },
      { dia: 6, nombre: 'Farmacia Jardines del Jarama', direccion: 'Avenida del Jarama, 21', telefono: '918 941 876', enlace: 'https://www.cofm.es/farmacias-de-guardia' }
    ];

    const ADMIN_EMAILS = ['danieltrigre7@gmail.com'];
    const ADMIN_CREDENTIALS = { 'danieltrigre7@gmail.com': 'rafadani77' };

    const palabrasProhibidas = [
      'idiota', 'imb√©cil', 'est√∫pido', 'tonto', 'tarado', 'gilipollas', 'capullo', 'baboso', 'cretino', 'pat√°n',
      'payaso', 'pendejo', 'cabron', 'cabr√≥n', 'cabrona', 'carajo', 'mierda', 'joder', 'cojones', 'co√±o', 'hijo de puta',
      'zorra', 'puta', 'mierdoso', 'est√∫pida', 'imb√©cila', 'bastardo', 'malnacido', 'cag√≥n', 'cagona', 'sarnoso',
      'bobo', 'bobota', 'babosa', 'culero', 'culera', 'mam√≥n', 'mamona', 'perra', 'asqueroso', 'asquerosa', 'maric√≥n',
      'maricona', 'pendeja', 'petardo', 'petarda', 'z√°ngano', 'lagarta', 'huev√≥n', 'huevona', 'menso', 'mensa',
      'idioteces', 'imbecilidades', 'soplapollas', 'cacho', 'chupacabras', 'chupasangre', 'desgraciado', 'desgraciada',
      'infeliz', 'maldito', 'maldita', 'pataner√≠a', 'burro', 'burra'
    ];

    const etiquetasTipoDia = {
      lectivo: 'Lectivo',
      no_lectivo: 'No lectivo',
      no_laborable: 'No laborable'
    };

    const slugify = (texto = '') => texto
      .toString()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, '-')
      .replace(/(^-|-$)/g, '')
      .substring(0, 60);

    const obtenerColeccionPorTipo = (tipo) => estado.datos[tipo] || [];

    const actualizarVisibilidadAdmin = () => {
      qsa('.solo-admin').forEach((item) => {
        item.hidden = !estado.esAdmin;
      });
    };

    const actualizarBadgeValoracion = (itemId) => {
      const datos = estado.valoraciones.get(itemId);
      qsa(`[data-valoracion="${itemId}"]`).forEach((nodo) => {
        if (!datos) {
          nodo.innerHTML = '<span>‚≠ê 0.0</span><small>(sin rese√±as)</small>';
          return;
        }
        nodo.innerHTML = `<span>‚≠ê ${datos.promedio.toFixed(1)}</span><small>(${datos.total} rese√±as)</small>`;
      });
    };

    const recomputarValoraciones = () => {
      const acumulado = new Map();
      const base = Array.isArray(estado.datos.rese√±as) ? estado.datos.rese√±as : [];
      const locales = obtenerResenasLocal();
      [...base, ...locales].forEach((resena) => {
        if (!resena?.itemId) return;
        const actual = acumulado.get(resena.itemId) || { total: 0, suma: 0 };
        actual.total += 1;
        actual.suma += Number(resena.rating) || 0;
        acumulado.set(resena.itemId, actual);
      });
      estado.valoraciones = new Map();
      acumulado.forEach((valor, id) => {
        const promedio = valor.total ? valor.suma / valor.total : 0;
        estado.valoraciones.set(id, { total: valor.total, promedio });
      });
      estado.valoraciones.forEach((_, id) => actualizarBadgeValoracion(id));
    };

    const buscarItem = (tipo, itemId) => obtenerColeccionPorTipo(tipo).find((elemento) => elemento.id === itemId);

    const gestionarGaleria = (tipo, itemId, indiceSeleccionado = null) => {
      if (!estado.esAdmin) return;
      const item = buscarItem(tipo, itemId);
      if (!item) return;
      item.galeria = Array.isArray(item.galeria) ? item.galeria : (item.portada ? [item.portada] : []);
      const accionRaw = prompt(`Galer√≠a de ${item.nombre}. Escribe A√ëADIR, REEMPLAZAR o ELIMINAR para gestionar las im√°genes.`);
      if (!accionRaw) return;
      const accion = accionRaw.trim().toLowerCase();
      if (!accion) return;
      if (accion.startsWith('a√±') || accion.startsWith('an') || accion.startsWith('ag')) {
        const url = prompt('Introduce la ruta o URL de la nueva imagen (ej. assets/nueva-imagen.svg)');
        if (!url) return;
        item.galeria.push(url.trim());
      } else if (accion.startsWith('re')) {
        let indice = indiceSeleccionado;
        if (indice === null) {
          const respuesta = prompt(`¬øQu√© posici√≥n deseas reemplazar? (1-${item.galeria.length})`);
          indice = Number(respuesta) - 1;
        }
        if (Number.isNaN(indice) || indice < 0 || indice >= item.galeria.length) {
          alert('√çndice no v√°lido.');
          return;
        }
        const nuevaUrl = prompt('Introduce la nueva imagen para reemplazar la seleccionada');
        if (!nuevaUrl) return;
        item.galeria[indice] = nuevaUrl.trim();
      } else if (accion.startsWith('el')) {
        let indice = indiceSeleccionado;
        if (indice === null) {
          const respuesta = prompt(`¬øQu√© posici√≥n deseas eliminar? (1-${item.galeria.length})`);
          indice = Number(respuesta) - 1;
        }
        if (Number.isNaN(indice) || indice < 0 || indice >= item.galeria.length) {
          alert('√çndice no v√°lido.');
          return;
        }
        item.galeria.splice(indice, 1);
      } else {
        alert('Acci√≥n no reconocida. Usa A√ëADIR, REEMPLAZAR o ELIMINAR.');
        return;
      }
      if (!item.galeria.length && item.portada) item.galeria = [item.portada];
      if (item.galeria.length) item.portada = item.galeria[0];
      anunciar(`Galer√≠a actualizada para ${item.nombre}`);
      mostrarSeccion(estado.seccionActual);
    };

    const gestionarEdicionItem = (tipo, itemId) => {
      if (!estado.esAdmin) return;
      const item = buscarItem(tipo, itemId);
      if (!item) return;
      const nuevoNombre = prompt('Nombre del recurso', item.nombre || '')?.trim();
      if (!nuevoNombre) return;
      const nuevaDescripcion = prompt('Descripci√≥n', item.descripcion || '')?.trim() || '';
      const nuevaDireccion = prompt('Direcci√≥n', item.direccion || '')?.trim();
      const nuevasEtiquetas = prompt('Etiquetas separadas por comas', (item.etiquetas || []).join(', '))?.split(',').map((et) => et.trim()).filter(Boolean) || [];
      const nuevaLat = prompt('Latitud (opcional)', item.coords?.lat ?? '');
      const nuevaLng = prompt('Longitud (opcional)', item.coords?.lng ?? '');
      item.nombre = sanitizarTexto(nuevoNombre);
      item.descripcion = sanitizarTexto(nuevaDescripcion);
      item.direccion = nuevaDireccion ? sanitizarTexto(nuevaDireccion) : '';
      item.etiquetas = nuevasEtiquetas.map((etiqueta) => sanitizarTexto(etiqueta));
      const lat = parseFloat(nuevaLat);
      const lng = parseFloat(nuevaLng);
      if (!Number.isNaN(lat) && !Number.isNaN(lng)) {
        item.coords = { lat, lng };
      }
      anunciar(`Contenido actualizado para ${item.nombre}`);
      mostrarSeccion(estado.seccionActual);
    };

    const crearResenaAdmin = async (tipo, itemId) => {
      if (!estado.esAdmin) return;
      const item = buscarItem(tipo, itemId);
      if (!item) return;
      const rating = Number(prompt('Puntuaci√≥n de la rese√±a (1-5)', '5')) || 5;
      const titulo = prompt('T√≠tulo de la rese√±a', `Rese√±a de ${item.nombre}`) || `Rese√±a de ${item.nombre}`;
      const texto = prompt('Texto de la rese√±a', 'A√±ade aqu√≠ los aspectos destacados que quieras mostrar.') || '';
      const emocion = prompt('Etiqueta de sentimiento', 'Inspirador ‚ú®') || 'Inspirador ‚ú®';
      const autor = prompt('Nombre o correo del autor (puede ser ficticio)', 'Equipo de turismo') || 'Equipo de turismo';
      const rese√±a = {
        id: `admin-${Date.now()}`,
        itemId,
        tipoSeccion: tipo,
        rating,
        titulo: sanitizarTexto(titulo),
        texto: sanitizarTexto(texto),
        emocion: sanitizarTexto(emocion),
        usuario: autor,
        autor,
        fechaCreacion: new Date().toISOString()
      };
      try {
        if (db) {
          await addDoc(collection(db, 'rese√±as'), rese√±a);
        } else {
          guardarResenaLocal(rese√±a);
          estado.datos.rese√±as.push(rese√±a);
        }
        cargarResenas(itemId);
        anunciar('Rese√±a de prueba creada');
      } catch (error) {
        console.error(error);
        alert('No se pudo crear la rese√±a de prueba.');
      }
    };

    const qs = (selector, parent = document) => parent.querySelector(selector);
    const qsa = (selector, parent = document) => Array.from(parent.querySelectorAll(selector));

    const sanitizarTexto = (texto) => {
      if (!texto) return '';
      const expresion = new RegExp(palabrasProhibidas.join('|'), 'gi');
      return texto.replace(expresion, (coincidencia) => '*'.repeat(coincidencia.length));
    };

    const formatearFecha = (fecha) => {
      return new Intl.DateTimeFormat('es-ES', { dateStyle: 'long' }).format(fecha instanceof Date ? fecha : new Date(fecha));
    };

    const anunciar = (mensaje) => {
      if (!estado.modoVisibilidad) return;
      const utterance = new SpeechSynthesisUtterance(mensaje);
      utterance.lang = 'es-ES';
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utterance);
    };

    const obtenerMesNombre = (indiceMes) => {
      const formatter = new Intl.DateTimeFormat('es-ES', { month: 'long' });
      return formatter.format(new Date(new Date().getFullYear(), indiceMes, 1));
    };

    const guardarPreferencias = () => {
      const prefs = {
        modoOscuro: estado.modoOscuro,
        modoSenior: estado.modoSenior,
        modoDislexia: estado.modoDislexia,
        modoVisibilidad: estado.modoVisibilidad,
        modoLecturaFacil: estado.modoLecturaFacil,
        modoAltoContraste: estado.modoAltoContraste,
        modoReducirMovimiento: estado.modoReducirMovimiento,
        preferenciasSenior: estado.preferenciasSenior
      };
      localStorage.setItem('turismo_sm_preferences', JSON.stringify(prefs));
    };

    const cargarPreferencias = () => {
      try {
        const prefs = JSON.parse(localStorage.getItem('turismo_sm_preferences'));
        if (!prefs) return;
        estado.modoOscuro = Boolean(prefs.modoOscuro);
        estado.modoSenior = Boolean(prefs.modoSenior);
        estado.modoDislexia = Boolean(prefs.modoDislexia);
        estado.modoVisibilidad = Boolean(prefs.modoVisibilidad);
        estado.modoLecturaFacil = Boolean(prefs.modoLecturaFacil);
        estado.modoAltoContraste = Boolean(prefs.modoAltoContraste);
        estado.modoReducirMovimiento = Boolean(prefs.modoReducirMovimiento);
        if (prefs.preferenciasSenior) {
          estado.preferenciasSenior = {
            textoAmpliado: prefs.preferenciasSenior.textoAmpliado !== false,
            contraste: prefs.preferenciasSenior.contraste !== false,
            botonesAmplios: prefs.preferenciasSenior.botonesAmplios !== false
          };
        }
      } catch (error) {
        console.warn('No se pudieron cargar preferencias', error);
      }
    };

    const aplicarClasesAccesibilidad = () => {
      document.body.classList.toggle('modo-oscuro', estado.modoOscuro);
      document.body.classList.toggle('modo-senior', estado.modoSenior);
      document.body.classList.toggle('modo-senior-texto', estado.modoSenior && estado.preferenciasSenior.textoAmpliado);
      document.body.classList.toggle('modo-senior-contraste', estado.modoSenior && estado.preferenciasSenior.contraste);
      document.body.classList.toggle('modo-senior-botones', estado.modoSenior && estado.preferenciasSenior.botonesAmplios);
      document.body.classList.toggle('modo-dislexia', estado.modoDislexia);
      document.body.classList.toggle('modo-visibilidad', estado.modoVisibilidad);
      document.body.classList.toggle('modo-lectura-facil', estado.modoLecturaFacil);
      document.body.classList.toggle('modo-alto-contraste', estado.modoAltoContraste);
      document.body.classList.toggle('modo-reducir-movimiento', estado.modoReducirMovimiento);
      qs('#btnVoz').classList.toggle('visible', estado.modoVisibilidad);
      guardarPreferencias();
    };

    const actualizarMensajeHero = () => {
      const parrafoHero = qs('#panelHero p');
      if (!parrafoHero) return;
      if (estado.usuario) {
        if (estado.esAdmin) {
          parrafoHero.textContent = `Bienvenido, ${estado.usuario.displayName || estado.usuario.email}. Tienes acceso de administrador para gestionar contenidos.`;
          return;
        }
        parrafoHero.textContent = `Bienvenido, ${estado.usuario.displayName || estado.usuario.email}. Explora las experiencias personalizadas.`;
        return;
      }
      if (estado.usuarioInvitado) {
        parrafoHero.textContent = 'Est√°s navegando como invitado. Podr√°s explorar todo el contenido pero no publicar rese√±as.';
        return;
      }
      parrafoHero.textContent = 'Planifica tu visita, guarda tus lugares favoritos y vive experiencias √∫nicas en el coraz√≥n del valle del Jarama. Informaci√≥n siempre actualizada gracias a Firebase.';
    };

    const menuLateral = qs('#menuLateral');
    const overlayMenu = qs('#overlayMenu');
    const modalInicio = qs('#modalInicio');
    const modalDialogo = modalInicio?.querySelector('.modal-dialogo');
    const pasosModal = modalInicio ? qsa('.modal-paso', modalInicio) : [];
    let pasoModalActual = 'adaptacion';

    const actualizarPasoModal = (paso) => {
      pasoModalActual = paso;
      pasosModal.forEach((seccion) => {
        seccion.classList.toggle('visible', seccion.dataset.paso === paso);
      });
      const tituloId = paso === 'adaptacion' ? 'modalInicioTitulo' : 'modalSesionTitulo';
      modalDialogo?.setAttribute('aria-labelledby', tituloId);
    };

    const abrirModalInicio = () => {
      if (!modalInicio) return;
      actualizarPasoModal('adaptacion');
      modalInicio.classList.add('visible');
      modalInicio.setAttribute('aria-hidden', 'false');
      anunciar('¬øNecesitas activar la adaptaci√≥n para tercera edad?');
    };

    const cerrarModalInicio = () => {
      if (!modalInicio) return;
      modalInicio.classList.remove('visible');
      modalInicio.setAttribute('aria-hidden', 'true');
      if (!estado.usuario && !estado.usuarioInvitado) {
        estado.usuarioInvitado = true;
        estado.esAdmin = false;
        estado.autenticacionOffline = false;
        actualizarVisibilidadAdmin();
        actualizarMensajeHero();
        mostrarSeccion(estado.seccionActual);
      }
    };

    qs('#cerrarModalInicio')?.addEventListener('click', cerrarModalInicio);
    modalInicio?.addEventListener('click', (evento) => {
      if (evento.target === modalInicio) cerrarModalInicio();
    });

    qsa('[data-accion-adaptacion]').forEach((boton) => {
      boton.addEventListener('click', () => {
        const activar = boton.dataset.accionAdaptacion === 'si';
        estado.modoSenior = activar;
        aplicarClasesAccesibilidad();
        actualizarPasoModal('sesion');
        anunciar(activar ? 'Modo tercera edad activado' : 'Modo est√°ndar seleccionado');
      });
    });

    qs('#btnModalInvitado')?.addEventListener('click', () => {
      estado.usuarioInvitado = true;
      estado.usuario = null;
      estado.esAdmin = false;
      estado.autenticacionOffline = false;
      actualizarMensajeHero();
      actualizarVisibilidadAdmin();
      cerrarModalInicio();
      mostrarSeccion(estado.seccionActual);
      alert('Est√°s navegando como invitado. Podr√°s leer rese√±as pero no publicar nuevas.');
    });

    const abrirMenu = () => {
      menuLateral.classList.add('abierto');
      overlayMenu.classList.add('visible');
      anunciar('Men√∫ abierto. Selecciona una secci√≥n.');
    };

    const cerrarMenu = () => {
      menuLateral.classList.remove('abierto');
      overlayMenu.classList.remove('visible');
    };

    qs('#btnToggleMenu').addEventListener('click', () => {
      const abierto = menuLateral.classList.contains('abierto');
      abierto ? cerrarMenu() : abrirMenu();
    });

    overlayMenu.addEventListener('click', cerrarMenu);

    const actualizarMenuActivo = (seccion) => {
      qsa('nav button[data-seccion]').forEach((btn) => {
        btn.classList.toggle('activo', btn.dataset.seccion === seccion);
      });
      estado.seccionActual = seccion;
      if (window.innerWidth < 900) cerrarMenu();
    };

    qsa('nav button[data-seccion]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const seccion = btn.dataset.seccion;
        actualizarMenuActivo(seccion);
        mostrarSeccion(seccion);
        if (analytics) logEvent(analytics, 'navegacion_seccion', { seccion });
        anunciar(`Secci√≥n ${btn.textContent} activada`);
      });
    });

    qsa('nav button[data-tag]').forEach((btn) => {
      btn.addEventListener('click', (evento) => {
        evento.stopPropagation();
        const etiqueta = btn.dataset.tag;
        estado.filtros.etiquetas = new Set([etiqueta]);
        mostrarSeccion(estado.seccionActual);
        anunciar(`Filtro por etiqueta ${btn.textContent}`);
      });
    });

    qsa('nav button[data-epoca]').forEach((btn) => {
      btn.addEventListener('click', (evento) => {
        evento.stopPropagation();
        estado.filtros.epocaHistoria = btn.dataset.epoca;
        mostrarSeccion('historia');
      });
    });

    qsa('[data-seccion-go]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const seccion = btn.dataset.seccionGo;
        actualizarMenuActivo(seccion);
        mostrarSeccion(seccion);
        qs('#contenido').scrollIntoView({ behavior: 'smooth' });
      });
    });

    const cargarColeccion = async (nombreColeccion, fallback) => {
      if (!db) return fallback;
      try {
        const ref = collection(db, nombreColeccion);
        const snapshot = await getDocs(ref);
        const resultados = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
        if (!resultados.length) return fallback;
        return resultados;
      } catch (error) {
        console.warn(`No se pudo obtener ${nombreColeccion}`, error);
        return fallback;
      }
    };

    const inicializarDatos = async () => {
      estado.datos.lugares = await cargarColeccion('lugares', datosFallback.lugares);
      estado.datos.restaurantes = await cargarColeccion('restaurantes', datosFallback.restaurantes);
      estado.datos.ocio = await cargarColeccion('ocio', datosFallback.ocio);
      estado.datos.historia = await cargarColeccion('historia', datosFallback.historia);
      estado.datos.eventos = await cargarColeccion('eventos', datosFallback.eventos);
      estado.datos.rese√±as = await cargarColeccion('rese√±as', datosFallback.rese√±as);
      cargarFavoritosLocal();
      recomputarValoraciones();
    };

    const cargarFavoritosLocal = () => {
      try {
        const favoritosGuardados = JSON.parse(localStorage.getItem('turismo_sm_favoritos')) || [];
        estado.datos.favoritos = new Set(favoritosGuardados);
      } catch (error) {
        estado.datos.favoritos = new Set();
      }
    };

    const guardarFavoritosLocal = () => {
      localStorage.setItem('turismo_sm_favoritos', JSON.stringify(Array.from(estado.datos.favoritos)));
    };

    const seccionContenido = qs('#seccionContenido');

    const crearTarjeta = (item, tipoSeccion) => {
      const tarjeta = document.createElement('article');
      tarjeta.className = 'tarjeta cerrada';
      const imagenes = (item.galeria && item.galeria.length)
        ? item.galeria
        : (item.multimedia && item.multimedia.length)
          ? item.multimedia
          : [item.portada || imagenGenerica];
      const sliderId = `${tipoSeccion}-${item.id}-galeria`;
      const valoracion = estado.valoraciones.get(item.id);
      const resumenValoracion = `<div class="tarjeta-valoracion" data-valoracion="${item.id}"><span>‚≠ê ${(valoracion?.promedio || 0).toFixed(1)}</span><small>${valoracion ? `(${valoracion.total} rese√±as)` : '(sin rese√±as)'}</small></div>`;
      const formularioMarkup = tipoSeccion !== 'historia' && !estado.usuarioInvitado
        ? crearFormularioResenaMarkup(item.id, tipoSeccion)
        : '';
      const avisoInvitado = tipoSeccion !== 'historia' && estado.usuarioInvitado
        ? '<p class="aviso-invitado">Est√°s navegando como invitado. Inicia sesi√≥n para publicar tus rese√±as.</p>'
        : '';
      const rese√±asMarkup = tipoSeccion !== 'historia'
        ? `<div class="rese√±as-lista" data-resenas="${item.id}"></div>`
        : '';
      const adminControles = estado.esAdmin
        ? `<div class="acciones-admin" data-admin-controles="${item.id}" data-tipo="${tipoSeccion}">
            <button class="btn-secundario" data-admin-editar="${item.id}" data-tipo="${tipoSeccion}">Editar ficha</button>
            <button class="btn-secundario" data-admin-imagen="${item.id}" data-tipo="${tipoSeccion}">Gestionar im√°genes</button>
            <button class="btn-secundario" data-admin-resena="${item.id}" data-tipo="${tipoSeccion}">Rese√±a de prueba</button>
          </div>`
        : '';
      tarjeta.innerHTML = `
        <div class="tarjeta-portada" aria-hidden="true">
          <div class="tarjeta-slider" data-slider="${sliderId}">
            ${imagenes.map((imagen, indice) => `
              <img src="${imagen}" alt="${item.nombre} - vista ${indice + 1}" class="${indice === 0 ? 'activa' : ''}" loading="lazy">
            `).join('')}
            ${imagenes.length > 1 ? `
              <button class="slider-control" data-control="prev" aria-label="Imagen anterior">‚Äπ</button>
              <button class="slider-control" data-control="next" aria-label="Imagen siguiente">‚Ä∫</button>
              <div class="slider-indicadores">
                ${imagenes.map((_, idx) => `<button type="button" data-indicador="${idx}" aria-label="Ver imagen ${idx + 1}" class="${idx === 0 ? 'activo' : ''}"></button>`).join('')}
              </div>
            ` : ''}
          </div>
        </div>
        <div class="tarjeta-contenido">
          <div style="display:flex; align-items:flex-start; gap:1rem;">
            <div>
              <h3>${item.nombre}</h3>
              ${item.direccion ? `<p style="color:var(--color-texto-suave);">${item.direccion}</p>` : ''}
              ${resumenValoracion}
            </div>
            <button class="btn-favorito" aria-label="Agregar a favoritos">‚ô°</button>
          </div>
          <p>${item.descripcion}</p>
          <div class="tarjeta-tags">${(item.etiquetas || []).map((tag) => `<span class="tarjeta-tag">${tag}</span>`).join('')}</div>
          <div class="tarjeta-acciones">
            <button class="btn-secundario" data-accion="toggle">Ver detalles</button>
            ${item.coords ? `<a class="btn-secundario" target="_blank" rel="noopener" href="https://maps.google.com/?q=${encodeURIComponent(item.nombre)}">Abrir en Maps</a>` : ''}
            ${item.descargaGPX ? `<a class="btn-secundario" href="${item.descargaGPX}" download>Descargar ruta</a>` : ''}
          </div>
        </div>
        <div class="tarjeta-detalle" hidden>
          <section class="mapa-contenedor" data-map="${item.coords ? `${item.coords.lat},${item.coords.lng}` : ''}"></section>
          ${formularioMarkup}
          ${avisoInvitado}
          ${rese√±asMarkup}
          ${adminControles}
        </div>
      `;

      const btnFavorito = qs('.btn-favorito', tarjeta);
      const esFavorito = estado.datos.favoritos.has(`${tipoSeccion}:${item.id}`);
      if (esFavorito) btnFavorito.classList.add('favorito');
      btnFavorito.addEventListener('click', (evento) => {
        evento.stopPropagation();
        alternarFavorito(tipoSeccion, item.id, btnFavorito);
      });

      inicializarSlider(tarjeta, sliderId, imagenes.length);

      qs('[data-accion="toggle"]', tarjeta).addEventListener('click', (evento) => {
        evento.stopPropagation();
        const abierto = tarjeta.classList.toggle('abierta');
        tarjeta.classList.toggle('cerrada', !abierto);
        const detalle = qs('.tarjeta-detalle', tarjeta);
        if (abierto) {
          detalle.hidden = false;
          inicializarMapa(detalle, item);
          cargarResenas(item.id);
          anunciar(`Mostrando detalles de ${item.nombre}`);
        } else {
          detalle.hidden = true;
          anunciar(`Ocultando detalles de ${item.nombre}`);
        }
      });

      inicializarFormularioResena(tarjeta, item.id, tipoSeccion);
      if (estado.esAdmin) {
        qsa('.tarjeta-slider img', tarjeta).forEach((img, indice) => {
          img.style.cursor = 'pointer';
          img.title = 'Gestionar imagen';
          img.addEventListener('click', (evento) => {
            evento.preventDefault();
            gestionarGaleria(tipoSeccion, item.id, indice);
          });
        });
      }
      return tarjeta;
    };

    const inicializarSlider = (tarjeta, sliderId, totalImagenes) => {
      const slider = qs(`[data-slider="${sliderId}"]`, tarjeta);
      if (!slider) return;
      if (totalImagenes <= 1) return;
      const imagenes = qsa('img', slider);
      const indicadores = qsa('[data-indicador]', slider);
      let indiceActual = 0;

      const mostrarImagen = (nuevoIndice) => {
        indiceActual = nuevoIndice;
        imagenes.forEach((img, idx) => {
          img.classList.toggle('activa', idx === indiceActual);
        });
        indicadores.forEach((boton, idx) => {
          boton.classList.toggle('activo', idx === indiceActual);
        });
      };

      qsa('.slider-control', slider).forEach((boton) => {
        boton.addEventListener('click', (evento) => {
          evento.stopPropagation();
          const direccion = boton.dataset.control === 'next' ? 1 : -1;
          const nuevoIndice = (indiceActual + direccion + totalImagenes) % totalImagenes;
          mostrarImagen(nuevoIndice);
        });
      });

      indicadores.forEach((boton) => {
        boton.addEventListener('click', (evento) => {
          evento.stopPropagation();
          const destino = Number(boton.dataset.indicador);
          mostrarImagen(destino);
        });
      });
    };

    const crearFormularioResenaMarkup = (itemId) => {
      const emociones = [
        'Alegr√≠a üòÑ',
        'Aventura ü§∏',
        'Relax üòå',
        'Gastronom√≠a üòã',
        'Cultura üé®',
        'Naturaleza üåø',
        'Rom√°ntico üíû',
        'Inspirador ‚ú®',
        'Fotograf√≠a üì∏',
        'En familia üë®‚Äçüë©‚Äçüëß'
      ];
      return `
        <form class="rese√±a-form" data-form-resena="${itemId}">
          <h4>Comparte tu rese√±a</h4>
          <div class="rating-input" role="radiogroup" aria-label="Valoraci√≥n en estrellas">
            ${[5,4,3,2,1].map((valor) => `
              <input type="radio" id="${itemId}-estrella-${valor}" name="rating" value="${valor}" ${valor === 5 ? 'checked' : ''}>
              <label for="${itemId}-estrella-${valor}">‚òÖ</label>
            `).join('')}
          </div>
          <div>
            <label for="${itemId}-titulo">T√≠tulo</label>
            <input id="${itemId}-titulo" name="titulo" type="text" required maxlength="60" placeholder="Ej. Un d√≠a inolvidable">
          </div>
          <div>
            <label for="${itemId}-texto">Descripci√≥n</label>
            <textarea id="${itemId}-texto" name="texto" required placeholder="Cu√©ntanos tu experiencia"></textarea>
          </div>
          <div>
            <span>¬øC√≥mo te sentiste?</span>
            <div class="chips-emocion">
              ${emociones.map((emo) => `<button type="button" class="chip-emocion" data-emocion="${emo}">${emo}</button>`).join('')}
            </div>
          </div>
          <button type="submit" class="btn-primario">Publicar rese√±a</button>
          <p style="font-size:0.8rem; color:var(--color-texto-suave);">Las rese√±as se moderan autom√°ticamente para un lenguaje respetuoso.</p>
        </form>
      `;
    };

    const inicializarMapa = (contenedor, item) => {
      if (!item.coords) return;
      if (contenedor.dataset.loaded) return;
      const iframe = document.createElement('iframe');
      iframe.loading = 'lazy';
      iframe.title = `Mapa de ${item.nombre}`;
      const base = 'https://www.google.com/maps/embed/v1/place';
      const apiKey = window.GOOGLE_MAPS_API_KEY;
      if (apiKey) {
        iframe.src = `${base}?key=${apiKey}&q=${encodeURIComponent(item.nombre)}&center=${item.coords.lat},${item.coords.lng}&zoom=16`;
      } else {
        iframe.src = `https://maps.google.com/maps?q=${item.coords.lat},${item.coords.lng}&z=16&hl=es&output=embed`;
      }
      contenedor.appendChild(iframe);
      contenedor.dataset.loaded = 'true';
    };

    const renderizarLista = (items, tipoSeccion) => {
      seccionContenido.innerHTML = '';
      if (!items.length) {
        seccionContenido.innerHTML = '<div class="sin-datos">No encontramos resultados con los filtros actuales.</div>';
        return;
      }
      const buscador = document.createElement('div');
      buscador.className = 'seccion-encabezado';
      buscador.innerHTML = `
        <div class="buscador">
          <span aria-hidden="true">üîç</span>
          <input type="search" placeholder="Buscar por nombre" aria-label="Buscar" value="${estado.filtros.texto}">
        </div>
        <div class="chips-filtros" aria-label="Filtros activos"></div>
      `;
      seccionContenido.appendChild(buscador);

      qs('input', buscador).addEventListener('input', (evento) => {
        estado.filtros.texto = evento.target.value.toLowerCase();
        mostrarSeccion(tipoSeccion);
      });

      const chipsFiltros = qs('.chips-filtros', buscador);
      const etiquetasDisponibles = new Set(items.flatMap((item) => item.etiquetas || []));
      etiquetasDisponibles.forEach((etiqueta) => {
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.textContent = etiqueta;
        chip.dataset.etiqueta = etiqueta;
        if (estado.filtros.etiquetas.has(etiqueta)) chip.classList.add('activo');
        chip.addEventListener('click', () => {
          if (estado.filtros.etiquetas.has(etiqueta)) {
            estado.filtros.etiquetas.delete(etiqueta);
          } else {
            estado.filtros.etiquetas.add(etiqueta);
          }
          mostrarSeccion(tipoSeccion);
        });
        chipsFiltros.appendChild(chip);
      });

      const rejilla = document.createElement('div');
      rejilla.className = 'rejilla-tarjetas';
      items.forEach((item) => {
        const tarjeta = crearTarjeta(item, tipoSeccion);
        rejilla.appendChild(tarjeta);
        actualizarBadgeValoracion(item.id);
      });
      seccionContenido.appendChild(rejilla);
    };

    const filtrarItems = (items) => {
      return items.filter((item) => {
        const coincideTexto = !estado.filtros.texto || item.nombre.toLowerCase().includes(estado.filtros.texto);
        const coincideEtiqueta = !estado.filtros.etiquetas.size || (item.etiquetas || []).some((tag) => estado.filtros.etiquetas.has(tag));
        return coincideTexto && coincideEtiqueta;
      });
    };

    const renderizarInicio = () => {
      seccionContenido.innerHTML = '';
      if (estado.usuarioInvitado) {
        const aviso = document.createElement('p');
        aviso.className = 'aviso-invitado';
        aviso.textContent = 'Est√°s explorando como invitado. Inicia sesi√≥n para publicar rese√±as y sincronizar tus favoritos.';
        seccionContenido.appendChild(aviso);
      }
      const destacados = document.createElement('section');
      destacados.className = 'seccion';
      destacados.innerHTML = `
        <div class="seccion-encabezado">
          <h2>Primeros pasos en San Mart√≠n de la Vega</h2>
          <p class="texto-aviso">Tres propuestas imprescindibles para organizar tu visita.</p>
        </div>
      `;
      const rejilla = document.createElement('div');
      rejilla.className = 'rejilla-tarjetas';
      estado.datos.lugares.slice(0, 3).forEach((item) => {
        const tarjeta = crearTarjeta(item, 'lugares');
        rejilla.appendChild(tarjeta);
        actualizarBadgeValoracion(item.id);
      });
      destacados.appendChild(rejilla);

      const gastronomia = document.createElement('section');
      gastronomia.className = 'seccion';
      gastronomia.innerHTML = `
        <div class="seccion-encabezado">
          <h2>Sabores locales</h2>
          <p class="texto-aviso">Descubre d√≥nde comer como la gente del pueblo.</p>
        </div>
      `;
      const rejillaGastro = document.createElement('div');
      rejillaGastro.className = 'rejilla-tarjetas';
      estado.datos.restaurantes.slice(0, 2).forEach((item) => {
        const tarjeta = crearTarjeta(item, 'restaurantes');
        rejillaGastro.appendChild(tarjeta);
        actualizarBadgeValoracion(item.id);
      });
      gastronomia.appendChild(rejillaGastro);

      seccionContenido.appendChild(destacados);
      seccionContenido.appendChild(gastronomia);
    };

    const renderizarHistoria = () => {
      seccionContenido.innerHTML = '';
      const filtros = document.createElement('div');
      filtros.className = 'chips-filtros';
      const etiquetasDisponibles = new Set(estado.datos.historia.flatMap((item) => item.tags || []));
      etiquetasDisponibles.forEach((tag) => {
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.textContent = tag;
        if (tag === estado.filtros.epocaHistoria) chip.classList.add('activo');
        chip.addEventListener('click', () => {
          estado.filtros.epocaHistoria = tag;
          renderizarHistoria();
        });
        filtros.appendChild(chip);
      });
      seccionContenido.appendChild(filtros);

      const contenedor = document.createElement('div');
      contenedor.className = 'historia-linea';
      const items = estado.datos.historia.filter((item) => item.tags?.includes(estado.filtros.epocaHistoria));
      if (!items.length) {
        seccionContenido.innerHTML += '<div class="sin-datos">No hay contenido hist√≥rico para esta categor√≠a.</div>';
        return;
      }
      items.forEach((evento) => {
        const tarjeta = document.createElement('article');
        tarjeta.className = 'evento-historia';
        tarjeta.innerHTML = `
          <h3>${evento.titulo}</h3>
          <p>${evento.texto}</p>
          <div class="tarjeta-tags">${(evento.tags || []).map((tag) => `<span class="tarjeta-tag">${tag}</span>`).join('')}</div>
        `;
        contenedor.appendChild(tarjeta);
      });
      seccionContenido.appendChild(contenedor);
    };

    const renderizarEventos = () => {
      seccionContenido.innerHTML = '';
      const contenedor = document.createElement('div');
      contenedor.className = 'eventos-grid';
      const eventosOrdenados = estado.datos.eventos.slice().sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
      if (!eventosOrdenados.length) {
        seccionContenido.innerHTML = '<div class="sin-datos">No hay festividades cargadas.</div>';
        return;
      }
      const fechaReferencia = new Date(eventosOrdenados[0].fecha);
      const mes = fechaReferencia.getMonth();
      const anio = fechaReferencia.getFullYear();
      const primerDiaMes = new Date(anio, mes, 1);
      const offset = primerDiaMes.getDay() === 0 ? 6 : primerDiaMes.getDay() - 1;
      const diasMes = new Date(anio, mes + 1, 0).getDate();

      const calendario = document.createElement('section');
      calendario.className = 'calendario';
      calendario.innerHTML = `
        <div class="calendario-header">
          <h3>${obtenerMesNombre(mes)} ${anio}</h3>
          <span>${eventosOrdenados.length} eventos</span>
        </div>
        <div class="calendario-grid" role="grid">
          ${['L', 'M', 'X', 'J', 'V', 'S', 'D'].map((dia) => `<div class="calendario-dia" role="columnheader">${dia}</div>`).join('')}
          ${Array.from({ length: offset }).map(() => '<div></div>').join('')}
          ${Array.from({ length: diasMes }).map((_, idx) => {
            const dia = idx + 1;
            const fecha = new Date(anio, mes, dia);
            const eventoDelDia = eventosOrdenados.find((evento) => new Date(evento.fecha).getDate() === dia);
            const tipoDia = eventoDelDia?.tipoDia || '';
            const etiqueta = tipoDia ? (etiquetasTipoDia[tipoDia] || 'Especial') : '';
            const aria = `${dia} de ${obtenerMesNombre(mes)}${etiqueta ? ` ¬∑ ${etiqueta}` : ''}`;
            return `<div class="calendario-dia ${eventoDelDia ? 'evento' : ''}" data-fecha="${fecha.toISOString()}" data-tipodia="${tipoDia}" aria-label="${aria}">
              <span class="calendario-numero">${dia}</span>
              ${etiqueta ? `<small>${etiqueta}</small>` : ''}
            </div>`;
          }).join('')}
        </div>
      `;
      seccionContenido.appendChild(calendario);

      const detalleEvento = document.createElement('div');
      detalleEvento.className = 'ajuste-card';
      detalleEvento.setAttribute('aria-live', 'polite');
      detalleEvento.innerHTML = '<p>Selecciona un d√≠a resaltado para ver detalles del evento.</p>';
      seccionContenido.appendChild(detalleEvento);

      calendario.addEventListener('click', (evento) => {
        const celda = evento.target.closest('.calendario-dia.evento');
        if (!celda) return;
        const fechaISO = celda.dataset.fecha;
        const eventoSeleccionado = eventosOrdenados.find((ev) => new Date(ev.fecha).toDateString() === new Date(fechaISO).toDateString());
        if (!eventoSeleccionado) return;
        detalleEvento.innerHTML = `
          <h3>${eventoSeleccionado.nombre}</h3>
          <p><strong>Fecha:</strong> ${formatearFecha(eventoSeleccionado.fecha)}</p>
          <p><strong>Lugar:</strong> ${eventoSeleccionado.lugar}</p>
          <p><strong>Tipo de d√≠a:</strong> ${etiquetasTipoDia[eventoSeleccionado.tipoDia] || 'Especial'}</p>
          <p>${eventoSeleccionado.descripcion}</p>
          <div class="tarjeta-acciones">
            <a class="btn-secundario" href="https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(eventoSeleccionado.nombre)}&dates=${eventoSeleccionado.fecha.replace(/-/g, '')}T090000Z/${eventoSeleccionado.fecha.replace(/-/g, '')}T110000Z&details=${encodeURIComponent(eventoSeleccionado.descripcion)}&location=${encodeURIComponent(eventoSeleccionado.lugar)}" target="_blank" rel="noopener">A√±adir a Google Calendar</a>
          </div>
        `;
        anunciar(`Evento ${eventoSeleccionado.nombre} el ${formatearFecha(eventoSeleccionado.fecha)}`);
      });

      eventosOrdenados.forEach((evento) => {
        const tarjeta = document.createElement('article');
        tarjeta.className = 'ajuste-card';
        tarjeta.innerHTML = `
          <h3>${evento.nombre}</h3>
          <p><strong>Fecha:</strong> ${formatearFecha(evento.fecha)}</p>
          <p><strong>Lugar:</strong> ${evento.lugar}</p>
          <p><strong>Tipo de d√≠a:</strong> ${etiquetasTipoDia[evento.tipoDia] || 'Especial'}</p>
          <p>${evento.descripcion}</p>
        `;
        contenedor.appendChild(tarjeta);
      });
      seccionContenido.appendChild(contenedor);
    };

    const alternarFavorito = (tipo, id, boton) => {
      const clave = `${tipo}:${id}`;
      if (estado.datos.favoritos.has(clave)) {
        estado.datos.favoritos.delete(clave);
        boton.classList.remove('favorito');
      } else {
        estado.datos.favoritos.add(clave);
        boton.classList.add('favorito');
      }
      guardarFavoritosLocal();
      anunciar(`Favorito ${boton.classList.contains('favorito') ? 'a√±adido' : 'eliminado'}`);
    };

    const inicializarFormularioResena = (tarjeta, itemId, tipoSeccion) => {
      const form = qs(`[data-form-resena="${itemId}"]`, tarjeta);
      if (!form) return;
      const chips = qsa('.chip-emocion', form);
      let emocionSeleccionada = '';
      chips.forEach((chip) => {
        chip.addEventListener('click', () => {
          chips.forEach((c) => c.classList.remove('activo'));
          chip.classList.add('activo');
          emocionSeleccionada = chip.dataset.emocion;
        });
      });

      form.addEventListener('submit', async (evento) => {
        evento.preventDefault();
        if (!estado.usuario) {
          alert('Inicia sesi√≥n para publicar rese√±as.');
          return;
        }
        const datos = new FormData(form);
        const rating = Number(datos.get('rating')) || 5;
        const titulo = sanitizarTexto(datos.get('titulo'));
        const texto = sanitizarTexto(datos.get('texto'));
        const rese√±a = {
          itemId,
          tipoSeccion,
          rating,
          titulo,
          texto,
          emocion: emocionSeleccionada,
          usuario: estado.usuario.uid,
          autor: estado.usuario.displayName || 'Usuario',
          fechaCreacion: new Date().toISOString()
        };

        try {
          if (db) {
            await addDoc(collection(db, 'rese√±as'), {
              ...rese√±a,
              fechaCreacion: serverTimestamp()
            });
            if (analytics) logEvent(analytics, 'crear_resena', { tipoSeccion });
          } else {
            rese√±a.id = (crypto?.randomUUID?.() || Date.now().toString());
            guardarResenaLocal(rese√±a);
            estado.datos.rese√±as.push(rese√±a);
          }
          form.reset();
          emocionSeleccionada = '';
          chips.forEach((c) => c.classList.remove('activo'));
          cargarResenas(itemId);
          anunciar('Rese√±a publicada');
        } catch (error) {
          alert('Ocurri√≥ un error al publicar la rese√±a. Intenta nuevamente.');
          console.error(error);
        }
      });
    };

    const obtenerResenasLocal = (itemId) => {
      const rese√±asLocal = JSON.parse(localStorage.getItem('turismo_sm_resenas') || '[]');
      if (!itemId) return rese√±asLocal;
      return rese√±asLocal.filter((resena) => resena.itemId === itemId);
    };

    const guardarResenaLocal = (resena) => {
      const rese√±asLocal = JSON.parse(localStorage.getItem('turismo_sm_resenas') || '[]');
      rese√±asLocal.push(resena);
      localStorage.setItem('turismo_sm_resenas', JSON.stringify(rese√±asLocal));
    };

    const cargarResenas = async (itemId) => {
      const contenedor = qs(`[data-resenas="${itemId}"]`);
      if (!contenedor) return;
      contenedor.innerHTML = '<p>Cargando rese√±as...</p>';
      let rese√±as = [];
      try {
        if (db) {
          const ref = collection(db, 'rese√±as');
          const consulta = query(ref, where('itemId', '==', itemId), orderBy('fechaCreacion', 'desc'));
          const snapshot = await getDocs(consulta);
          rese√±as = snapshot.docs.map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }));
        } else {
          const base = estado.datos.rese√±as.filter((resena) => resena.itemId === itemId);
          rese√±as = [...base, ...obtenerResenasLocal(itemId)];
        }
      } catch (error) {
        console.error('Error al cargar rese√±as', error);
      }

      if (rese√±as.length) {
        const total = rese√±as.length;
        const promedio = rese√±as.reduce((suma, resena) => suma + (Number(resena.rating) || 0), 0) / total;
        estado.valoraciones.set(itemId, { total, promedio });
      } else {
        estado.valoraciones.delete(itemId);
      }
      actualizarBadgeValoracion(itemId);

      if (!rese√±as.length) {
        contenedor.innerHTML = '<p>No hay rese√±as a√∫n. ¬°S√© la primera persona en opinar!</p>';
        return;
      }

      contenedor.innerHTML = '';
      rese√±as.forEach((resena) => {
        const tarjeta = document.createElement('article');
        tarjeta.className = 'rese√±a';
        const esAutor = estado.usuario && (resena.usuario === estado.usuario.uid);
        const fecha = resena.fechaCreacion?.toDate ? resena.fechaCreacion.toDate() : new Date(resena.fechaCreacion);
        tarjeta.innerHTML = `
          <div class="rese√±a-header">
            <div>
              <strong>${resena.autor}</strong>
              <p style="margin:0;font-size:0.85rem;color:var(--color-texto-suave);">${formatearFecha(fecha)}</p>
            </div>
            <div class="estrellas">${'‚òÖ'.repeat(resena.rating || 0)}</div>
          </div>
          <h4 style="margin:0.5rem 0;">${resena.titulo}</h4>
          <p>${resena.texto}</p>
          ${resena.emocion ? `<span class="tarjeta-tag">${resena.emocion}</span>` : ''}
          ${esAutor ? `<div class="rese√±a-acciones"><button data-editar="${resena.id}">Editar</button><button data-borrar="${resena.id}">Eliminar</button></div>` : ''}
        `;
        if (esAutor) {
          qs('[data-borrar]', tarjeta)?.addEventListener('click', () => eliminarResena(resena.id, itemId));
          qs('[data-editar]', tarjeta)?.addEventListener('click', () => editarResena(resena, itemId));
        }
        contenedor.appendChild(tarjeta);
      });
    };

    const eliminarResena = async (idResena, itemId) => {
      if (!confirm('¬øDeseas eliminar esta rese√±a?')) return;
      try {
        if (db) {
          await deleteDoc(doc(db, 'rese√±as', idResena));
        } else {
          const rese√±asLocal = JSON.parse(localStorage.getItem('turismo_sm_resenas') || '[]');
          const filtradas = rese√±asLocal.filter((resena) => resena.id !== idResena);
          localStorage.setItem('turismo_sm_resenas', JSON.stringify(filtradas));
          estado.datos.rese√±as = estado.datos.rese√±as.filter((resena) => resena.id !== idResena);
        }
        cargarResenas(itemId);
        anunciar('Rese√±a eliminada');
      } catch (error) {
        console.error('No se pudo eliminar rese√±a', error);
        alert('No fue posible eliminar la rese√±a.');
      }
    };

    const editarResena = async (resena, itemId) => {
      const nuevoTexto = prompt('Edita tu rese√±a:', resena.texto);
      if (nuevoTexto === null) return;
      const limpio = sanitizarTexto(nuevoTexto);
      try {
        if (db) {
          await updateDoc(doc(db, 'rese√±as', resena.id), {
            texto: limpio,
            fechaEdicion: serverTimestamp()
          });
        } else {
          const rese√±asLocal = JSON.parse(localStorage.getItem('turismo_sm_resenas') || '[]');
          const actualizadas = rese√±asLocal.map((r) => r.id === resena.id ? { ...r, texto: limpio, fechaEdicion: new Date().toISOString() } : r);
          localStorage.setItem('turismo_sm_resenas', JSON.stringify(actualizadas));
          estado.datos.rese√±as = estado.datos.rese√±as.map((r) => r.id === resena.id ? { ...r, texto: limpio, fechaEdicion: new Date().toISOString() } : r);
        }
        cargarResenas(itemId);
        anunciar('Rese√±a editada');
      } catch (error) {
        console.error('No se pudo editar rese√±a', error);
      }
    };

    const mostrarSeccion = (seccion) => {
      estado.seccionActual = seccion;
      qs('#panelHero')?.classList.toggle('oculto', seccion !== 'inicio');
      if (seccion === 'inicio') {
        renderizarInicio();
        return;
      }
      let items = [];
      if (seccion === 'lugares') items = filtrarItems(estado.datos.lugares);
      if (seccion === 'restaurantes') items = filtrarItems(estado.datos.restaurantes);
      if (seccion === 'ocio') items = filtrarItems(estado.datos.ocio);
      if (['lugares', 'restaurantes', 'ocio'].includes(seccion)) {
        renderizarLista(items, seccion);
        return;
      }
      if (seccion === 'historia') {
        renderizarHistoria();
        return;
      }
      if (seccion === 'eventos') {
        renderizarEventos();
        return;
      }
      if (seccion === 'ajustes') {
        renderizarAjustes();
        return;
      }
      if (seccion === 'admin') {
        if (!estado.esAdmin) {
          seccionContenido.innerHTML = '<div class="sin-datos">Necesitas permisos de administrador.</div>';
        } else {
          renderizarAdmin();
        }
        return;
      }
      if (seccion === 'perfil') {
        renderizarPerfil();
        return;
      }
    };

    const renderizarAjustes = () => {
      seccionContenido.innerHTML = '';
      const panel = document.createElement('section');
      panel.className = 'ajustes-panel';
      panel.innerHTML = `
        <article class="ajuste-card">
          <h3>Temas y animaciones</h3>
          <p>Ajusta la apariencia general de la aplicaci√≥n para adaptarla a distintos contextos de iluminaci√≥n.</p>
          <label class="toggle"><input type="checkbox" id="toggleOscuro"> Activar modo oscuro</label>
          <label class="toggle"><input type="checkbox" id="toggleAltoContraste"> Activar alto contraste</label>
          <label class="toggle"><input type="checkbox" id="toggleReducirMovimiento"> Reducir animaciones</label>
        </article>
        <article class="ajuste-card">
          <h3>Modo tercera edad</h3>
          <p>Incrementa fuentes, contraste y tama√±o de botones. Puedes activar o desactivar cada ajuste de manera individual.</p>
          <label class="toggle"><input type="checkbox" id="toggleSenior"> Activar modo tercera edad</label>
          <div class="opciones-senior" id="opcionesSenior">
            <label class="toggle"><input type="checkbox" data-senior="textoAmpliado"> Texto ampliado</label>
            <label class="toggle"><input type="checkbox" data-senior="contraste"> Contraste reforzado</label>
            <label class="toggle"><input type="checkbox" data-senior="botonesAmplios"> Botones m√°s grandes</label>
          </div>
        </article>
        <article class="ajuste-card">
          <h3>Accesibilidad lectora</h3>
          <p>Personaliza la experiencia para personas con dislexia o que prefieren textos simplificados.</p>
          <label class="toggle"><input type="checkbox" id="toggleDislexia"> Tipograf√≠a amigable para dislexia</label>
          <label class="toggle"><input type="checkbox" id="toggleLecturaFacil"> Activar modo lectura f√°cil</label>
        </article>
        <article class="ajuste-card">
          <h3>Apoyos de visibilidad</h3>
          <p>Habilita los comandos por voz y mensajes hablados para usuarios con visi√≥n reducida.</p>
          <label class="toggle"><input type="checkbox" id="toggleVisibilidad"> Activar modo visibilidad reducida</label>
        </article>
      `;
      seccionContenido.appendChild(panel);

      const asignarValor = (selector, valor) => {
        const input = panel.querySelector(selector);
        if (input) input.checked = valor;
      };

      asignarValor('#toggleOscuro', estado.modoOscuro);
      asignarValor('#toggleAltoContraste', estado.modoAltoContraste);
      asignarValor('#toggleReducirMovimiento', estado.modoReducirMovimiento);
      asignarValor('#toggleSenior', estado.modoSenior);
      asignarValor('#toggleDislexia', estado.modoDislexia);
      asignarValor('#toggleLecturaFacil', estado.modoLecturaFacil);
      asignarValor('#toggleVisibilidad', estado.modoVisibilidad);

      panel.querySelectorAll('[data-senior]').forEach((input) => {
        input.checked = estado.preferenciasSenior[input.dataset.senior];
        input.disabled = !estado.modoSenior;
      });

      const actualizarOpcionesSenior = () => {
        panel.querySelectorAll('[data-senior]').forEach((input) => {
          input.disabled = !estado.modoSenior;
        });
      };

      panel.addEventListener('change', (evento) => {
        const objetivo = evento.target;
        if (objetivo.dataset?.senior) {
          estado.preferenciasSenior[objetivo.dataset.senior] = objetivo.checked;
          aplicarClasesAccesibilidad();
          return;
        }
        const { id, checked } = objetivo;
        if (id === 'toggleOscuro') estado.modoOscuro = checked;
        if (id === 'toggleAltoContraste') estado.modoAltoContraste = checked;
        if (id === 'toggleReducirMovimiento') estado.modoReducirMovimiento = checked;
        if (id === 'toggleSenior') {
          estado.modoSenior = checked;
          actualizarOpcionesSenior();
        }
        if (id === 'toggleDislexia') estado.modoDislexia = checked;
        if (id === 'toggleLecturaFacil') estado.modoLecturaFacil = checked;
        if (id === 'toggleVisibilidad') estado.modoVisibilidad = checked;
        aplicarClasesAccesibilidad();
        if (id && analytics) logEvent(analytics, 'cambiar_accesibilidad', { id, checked });
      });
    };

    const renderizarPerfil = () => {
      seccionContenido.innerHTML = '';
      const contenedor = document.createElement('section');
      contenedor.className = 'perfil';
      contenedor.innerHTML = `
        <header>
          <h2>Mi cuenta</h2>
          <p>${estado.usuario
            ? `Conectado como <strong>${estado.usuario.displayName || estado.usuario.email}</strong>`
            : estado.usuarioInvitado
              ? 'Est√°s navegando como invitado. Inicia sesi√≥n para guardar favoritos y compartir tus rese√±as.'
              : 'Inicia sesi√≥n para guardar favoritos y rese√±as.'}</p>
          <div class="tarjeta-acciones">
            ${estado.usuario ? '<button class="btn-secundario" id="btnLogout">Cerrar sesi√≥n</button>' : '<button class="btn-primario" id="btnAbrirModalInicio">Gestionar acceso</button>'}
            ${estado.usuario ? '<button class="btn-secundario" id="btnEliminarCuenta">Eliminar cuenta</button>' : ''}
            ${estado.usuarioInvitado ? '<button class="btn-secundario" id="btnSalirInvitado">Cambiar a cuenta con inicio de sesi√≥n</button>' : ''}
          </div>
        </header>
        <section class="ajuste-card">
          <h3>Mis favoritos</h3>
          <div class="favoritos-grid" id="listaFavoritos"></div>
        </section>
        <section class="ajuste-card">
          <h3>Mis rese√±as</h3>
          <div id="listaResenasUsuario"></div>
        </section>
      `;
      seccionContenido.appendChild(contenedor);

      qs('#btnAbrirModalInicio')?.addEventListener('click', abrirModalInicio);
      qs('#btnSalirInvitado')?.addEventListener('click', abrirModalInicio);

      if (!estado.usuario) {
        qs('#listaFavoritos').innerHTML = '<p>Inicia sesi√≥n para ver tus favoritos guardados.</p>';
        qs('#listaResenasUsuario').innerHTML = estado.usuarioInvitado
          ? '<p>Los invitados no pueden publicar rese√±as, pero s√≠ leer las existentes.</p>'
          : '<p>A√∫n no has iniciado sesi√≥n.</p>';
        return;
      }

      qs('#btnLogout')?.addEventListener('click', async () => {
        if (auth && !estado.autenticacionOffline) {
          await signOut(auth);
          return;
        }
        estado.usuario = null;
        estado.esAdmin = false;
        estado.autenticacionOffline = false;
        estado.usuarioInvitado = true;
        actualizarVisibilidadAdmin();
        actualizarMensajeHero();
        mostrarSeccion('inicio');
      });

      qs('#btnEliminarCuenta')?.addEventListener('click', async () => {
        if (!auth || estado.autenticacionOffline) {
          alert('Solo las cuentas conectadas a Firebase pueden eliminarse desde aqu√≠.');
          return;
        }
        const confirmacion = prompt('Escribe ELIMINAR para confirmar la eliminaci√≥n de tu cuenta');
        if (confirmacion !== 'ELIMINAR') return;
        try {
          await deleteUser(auth.currentUser);
          alert('Tu cuenta ha sido eliminada.');
        } catch (error) {
          if (error.code === 'auth/requires-recent-login') {
            alert('Por seguridad, vuelve a iniciar sesi√≥n antes de eliminar tu cuenta.');
          } else {
            alert('No fue posible eliminar la cuenta.');
          }
        }
      });

      const favoritos = Array.from(estado.datos.favoritos).map((clave) => {
        const [tipo, id] = clave.split(':');
        const coleccion = estado.datos[tipo];
        return coleccion?.find((item) => item.id === id);
      }).filter(Boolean);

      const listaFavoritos = qs('#listaFavoritos');
      if (!favoritos.length) {
        listaFavoritos.innerHTML = '<p>No has guardado favoritos todav√≠a.</p>';
      } else {
        favoritos.forEach((item) => {
          const card = document.createElement('article');
          card.className = 'rese√±a';
          card.innerHTML = `
            <strong>${item.nombre}</strong>
            <p>${item.descripcion}</p>
          `;
          listaFavoritos.appendChild(card);
        });
      }

      const listadoResenas = qs('#listaResenasUsuario');
      listadoResenas.innerHTML = '<p>Cargando rese√±as...</p>';
      if (!db) {
        const rese√±as = obtenerResenasLocal().filter((r) => r.usuario === estado.usuario.uid);
        renderizarResenasUsuario(rese√±as, listadoResenas);
      } else {
        (async () => {
          const ref = collection(db, 'rese√±as');
          const consulta = query(ref, where('usuario', '==', estado.usuario.uid), orderBy('fechaCreacion', 'desc'));
          const snapshot = await getDocs(consulta);
          const rese√±as = snapshot.docs.map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }));
          renderizarResenasUsuario(rese√±as, listadoResenas);
        })();
      }
    };

    const renderizarResenasUsuario = (rese√±as, contenedor) => {
      if (!rese√±as.length) {
        contenedor.innerHTML = '<p>No has publicado rese√±as todav√≠a.</p>';
        return;
      }
      contenedor.innerHTML = '';
      rese√±as.forEach((resena) => {
        const card = document.createElement('article');
        card.className = 'rese√±a';
        const fecha = resena.fechaCreacion?.toDate ? resena.fechaCreacion.toDate() : new Date(resena.fechaCreacion);
        card.innerHTML = `
          <h4>${resena.titulo}</h4>
          <p>${resena.texto}</p>
          <small>${formatearFecha(fecha)}</small>
        `;
        contenedor.appendChild(card);
      });
    };

    const renderizarAdmin = () => {
      seccionContenido.innerHTML = '';
      if (!estado.esAdmin) {
        seccionContenido.innerHTML = '<div class="sin-datos">Necesitas permisos de administrador para acceder.</div>';
        return;
      }
      const panel = document.createElement('section');
      panel.className = 'panel-admin';
      panel.innerHTML = `
          <article class="nota-informativa">
            <h3>Centro de control</h3>
            <p>Desde aqu√≠ puedes a√±adir nuevos puntos de inter√©s, actualizar fichas existentes y generar rese√±as de prueba.</p>
            <p>Tambi√©n puedes pulsar sobre cualquier imagen de una tarjeta para sustituirla o eliminarla r√°pidamente.</p>
            <p class="texto-aviso">Los datos que ves sin conexi√≥n se guardan dentro del repositorio (index.html y la carpeta <code>assets/</code>). Si conectas Firebase, las altas y cambios se sincronizar√°n con la base de datos que configures.</p>
          </article>
        <form id="formAdminContenido">
          <h3>Agregar o actualizar contenido</h3>
          <label for="adminSeccion">Secci√≥n destino</label>
          <select id="adminSeccion" name="seccion" required>
            <option value="lugares">Lugares de inter√©s</option>
            <option value="restaurantes">Restaurantes</option>
            <option value="ocio">Deportes &amp; ocio</option>
          </select>
          <label for="adminNombre">Nombre</label>
          <input id="adminNombre" name="nombre" required placeholder="Ej. Mirador de la Vega">
          <label for="adminTipo">Tipo o categor√≠a interna</label>
          <input id="adminTipo" name="tipo" placeholder="Ej. naturaleza, cultural">
          <label for="adminDescripcion">Descripci√≥n</label>
          <textarea id="adminDescripcion" name="descripcion" required placeholder="Describe brevemente el lugar."></textarea>
          <label for="adminDireccion">Direcci√≥n o referencia</label>
          <input id="adminDireccion" name="direccion" placeholder="Ej. Calle Mayor, 12">
          <label for="adminEtiquetas">Etiquetas (separadas por comas)</label>
          <input id="adminEtiquetas" name="etiquetas" placeholder="familia, cultural, rom√°ntico">
          <div style="display:grid; gap:0.5rem; grid-template-columns:repeat(auto-fit,minmax(150px,1fr));">
            <div>
              <label for="adminLatitud">Latitud</label>
              <input id="adminLatitud" name="latitud" placeholder="40.2">
            </div>
            <div>
              <label for="adminLongitud">Longitud</label>
              <input id="adminLongitud" name="longitud" placeholder="-3.5">
            </div>
          </div>
          <label for="adminPortada">Imagen principal o portada</label>
          <input id="adminPortada" name="portada" placeholder="assets/nueva-imagen.svg">
          <button type="submit" class="btn-primario">Guardar contenido</button>
        </form>
        <article class="tabla-simple">
          <h3>Contenido publicado</h3>
          <p class="texto-aviso">Revisa r√°pidamente los registros actuales. Utiliza los botones de cada tarjeta para editar con m√°s detalle.</p>
          <div id="listadoAdminContenido"></div>
        </article>
        <form id="formAdminResena" class="nota-informativa">
          <h3>Generar rese√±a de prueba</h3>
          <p>Selecciona una secci√≥n y un elemento para publicar una rese√±a autom√°tica con datos ficticios.</p>
          <label for="adminSeccionResena">Secci√≥n</label>
          <select id="adminSeccionResena" name="seccion">
            <option value="lugares">Lugares</option>
            <option value="restaurantes">Restaurantes</option>
            <option value="ocio">Ocio</option>
          </select>
          <label for="adminItemResena">Elemento</label>
          <select id="adminItemResena" name="item"></select>
          <button type="submit" class="btn-secundario">Crear rese√±a de prueba</button>
        </form>
      `;
      seccionContenido.appendChild(panel);

      const listado = panel.querySelector('#listadoAdminContenido');
      const secciones = [
        { tipo: 'lugares', titulo: 'Lugares de inter√©s' },
        { tipo: 'restaurantes', titulo: 'Restaurantes' },
        { tipo: 'ocio', titulo: 'Deportes y ocio' }
      ];
      listado.innerHTML = secciones.map(({ tipo, titulo }) => {
        const items = obtenerColeccionPorTipo(tipo);
        if (!items.length) {
          return `<div><strong>${titulo}</strong><p>No hay elementos registrados.</p></div>`;
        }
        const filas = items.map((item) => `
          <tr>
            <td><strong>${item.nombre}</strong><br><small>${item.tipo || ''}</small></td>
            <td>${(item.etiquetas || []).join(', ') || 'Sin etiquetas'}</td>
            <td>${item.direccion || 'Sin direcci√≥n'}</td>
          </tr>
        `).join('');
        return `
          <section>
            <h4>${titulo} (${items.length})</h4>
            <table>
              <thead><tr><th>Nombre</th><th>Etiquetas</th><th>Direcci√≥n</th></tr></thead>
              <tbody>${filas}</tbody>
            </table>
          </section>
        `;
      }).join('');

      const formContenido = panel.querySelector('#formAdminContenido');
      formContenido.addEventListener('submit', (evento) => {
        evento.preventDefault();
        const datos = new FormData(formContenido);
        const seccion = datos.get('seccion');
        const nombre = datos.get('nombre')?.trim();
        if (!seccion || !nombre) {
          alert('Indica un nombre y la secci√≥n destino.');
          return;
        }
        const coleccion = obtenerColeccionPorTipo(seccion);
        const id = slugify(nombre);
        if (!id) {
          alert('El nombre proporcionado no es v√°lido.');
          return;
        }
        let item = coleccion.find((elemento) => elemento.id === id);
        const etiquetas = (datos.get('etiquetas') || '').split(',').map((tag) => sanitizarTexto(tag.trim())).filter(Boolean);
        const descripcion = sanitizarTexto(datos.get('descripcion') || '');
        const direccion = sanitizarTexto(datos.get('direccion') || '');
        const tipo = datos.get('tipo')?.trim() || '';
        const portada = datos.get('portada')?.trim();
        const lat = parseFloat(datos.get('latitud'));
        const lng = parseFloat(datos.get('longitud'));
        if (!item) {
          item = { id, nombre: sanitizarTexto(nombre), descripcion, tipo, etiquetas, direccion, galeria: [], coords: null };
          coleccion.push(item);
        }
        item.nombre = sanitizarTexto(nombre);
        item.descripcion = descripcion;
        item.tipo = tipo;
        item.etiquetas = etiquetas;
        item.direccion = direccion;
        if (!Number.isNaN(lat) && !Number.isNaN(lng)) {
          item.coords = { lat, lng };
        }
        if (portada) {
          item.portada = portada;
          item.galeria = item.galeria?.length ? item.galeria : [];
          if (!item.galeria.includes(portada)) {
            item.galeria.unshift(portada);
          }
        }
        formContenido.reset();
        anunciar('Contenido guardado correctamente.');
        mostrarSeccion('admin');
      });

      const selectSeccion = panel.querySelector('#adminSeccionResena');
      const selectItem = panel.querySelector('#adminItemResena');
      const poblarItemsResena = () => {
        const tipo = selectSeccion.value;
        const items = obtenerColeccionPorTipo(tipo);
        selectItem.innerHTML = items.length
          ? items.map((item) => `<option value="${item.id}">${item.nombre}</option>`).join('')
          : '<option value="" disabled>No hay elementos disponibles</option>';
      };
      selectSeccion.addEventListener('change', poblarItemsResena);
      poblarItemsResena();

      panel.querySelector('#formAdminResena').addEventListener('submit', (evento) => {
        evento.preventDefault();
        const tipo = selectSeccion.value;
        const itemId = selectItem.value;
        if (!itemId) {
          alert('Selecciona un elemento para generar la rese√±a.');
          return;
        }
        crearResenaAdmin(tipo, itemId);
      });
    };

    const inicializarClima = async ({ silencioso } = {}) => {
      const resumen = qs('#climaResumen');
      const detalle = qs('#climaDetalle');
      if (!resumen || !detalle) return;
      if (!silencioso) restablecerClima();
      const apiKey = window.OPENWEATHER_KEY;
      if (!apiKey) {
        resumen.textContent = climaPredeterminado.resumen;
        detalle.textContent = `${climaPredeterminado.detalle}. Datos estimados seg√∫n registros locales.`;
        programarRefrescoClima();
        return;
      }
      try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=40.205&lon=-3.567&units=metric&lang=es&appid=${apiKey}`;
        const respuesta = await fetch(url);
        if (!respuesta.ok) throw new Error('Respuesta no v√°lida');
        const data = await respuesta.json();
        resumen.textContent = `${Math.round(data.main.temp)}¬∞C ¬∑ ${data.weather[0].description}`;
        detalle.textContent = `Sensaci√≥n: ${Math.round(data.main.feels_like)}¬∞C ¬∑ Humedad: ${data.main.humidity}%`;
      } catch (error) {
        resumen.textContent = 'No fue posible obtener el clima actual.';
        detalle.textContent = 'Revisa tu conexi√≥n e intenta de nuevo.';
      } finally {
        programarRefrescoClima();
      }
    };

    const inicializarSOS = () => {
      const btnSOS = qs('#btnSOS');
      const panel = qs('#sosPanel');
      const cerrar = qs('#btnCerrarSOS');
      btnSOS.addEventListener('click', () => {
        panel.classList.add('visible');
        btnSOS.setAttribute('aria-expanded', 'true');
        anunciar('Panel de emergencias abierto.');
      });
      cerrar.addEventListener('click', () => {
        panel.classList.remove('visible');
        btnSOS.setAttribute('aria-expanded', 'false');
      });
      panel.addEventListener('click', (evento) => {
        if (evento.target === panel) {
          panel.classList.remove('visible');
          btnSOS.setAttribute('aria-expanded', 'false');
        }
      });
      actualizarFarmaciaGuardia();
      setInterval(actualizarFarmaciaGuardia, 60 * 60 * 1000);
    };

    const inicializarVoz = () => {
      const boton = qs('#btnVoz');
      let reconocimiento;
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        boton.style.display = 'none';
        return;
      }

      const crearReconocimiento = () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognizer = new SpeechRecognition();
        recognizer.lang = 'es-ES';
        recognizer.continuous = false;
        recognizer.interimResults = false;
        recognizer.onresult = (evento) => {
          const comando = evento.results[0][0].transcript.toLowerCase();
          procesarComandoVoz(comando);
        };
        recognizer.onend = () => {
          estado.reconocimientoActivo = false;
          boton.textContent = 'üéôÔ∏è';
        };
        recognizer.onerror = () => {
          estado.reconocimientoActivo = false;
          boton.textContent = 'üéôÔ∏è';
        };
        return recognizer;
      };

      boton.addEventListener('click', () => {
        if (estado.reconocimientoActivo) {
          reconocimiento?.stop();
          estado.reconocimientoActivo = false;
          boton.textContent = 'üéôÔ∏è';
          return;
        }
        reconocimiento = reconocimiento || crearReconocimiento();
        reconocimiento.start();
        estado.reconocimientoActivo = true;
        boton.textContent = '‚èπÔ∏è';
        anunciar('Escuchando comandos.');
      });
    };

    const procesarComandoVoz = (texto) => {
      if (texto.includes('lugares')) {
        actualizarMenuActivo('lugares');
        mostrarSeccion('lugares');
        return;
      }
      if (texto.includes('restaurante')) {
        actualizarMenuActivo('restaurantes');
        mostrarSeccion('restaurantes');
        return;
      }
      if (texto.includes('historia')) {
        actualizarMenuActivo('historia');
        mostrarSeccion('historia');
        return;
      }
      if (texto.includes('eventos') || texto.includes('calendario')) {
        actualizarMenuActivo('eventos');
        mostrarSeccion('eventos');
        return;
      }
      if (texto.includes('modo oscuro')) {
        estado.modoOscuro = !estado.modoOscuro;
        aplicarClasesAccesibilidad();
        anunciar(`Modo oscuro ${estado.modoOscuro ? 'activado' : 'desactivado'}`);
        return;
      }
      if (texto.startsWith('buscar')) {
        const termino = texto.replace('buscar', '').trim();
        estado.filtros.texto = termino.toLowerCase();
        mostrarSeccion(estado.seccionActual);
        anunciar(`Buscando ${termino}`);
        return;
      }
      anunciar('No entend√≠ el comando.');
    };

    const inicializarAuth = () => {
      const manejarLoginCorreo = async (evento) => {
        evento.preventDefault();
        const datos = new FormData(evento.target);
        const correo = datos.get('correo');
        const password = datos.get('password');
        if (!correo || !password) return;
        if (!auth) {
          if (ADMIN_CREDENTIALS[correo] && ADMIN_CREDENTIALS[correo] === password) {
            estado.usuario = { uid: `offline-${correo}`, email: correo, displayName: 'Administrador local' };
            estado.esAdmin = ADMIN_EMAILS.includes(correo);
            estado.usuarioInvitado = false;
            estado.autenticacionOffline = true;
            actualizarVisibilidadAdmin();
            actualizarMensajeHero();
            cerrarModalInicio();
            mostrarSeccion(estado.seccionActual);
            alert('Sesi√≥n iniciada como administrador local.');
            return;
          }
          alert('Configura Firebase para activar el inicio de sesi√≥n con correo.');
          return;
        }
        try {
          await signInWithEmailAndPassword(auth, correo, password);
          cerrarModalInicio();
        } catch (error) {
          if (error.code === 'auth/user-not-found') {
            await createUserWithEmailAndPassword(auth, correo, password);
            cerrarModalInicio();
          } else {
            console.error(error);
            alert('No se pudo iniciar sesi√≥n con correo. Revisa los datos e int√©ntalo de nuevo.');
          }
        }
      };

      qs('#formLoginCorreo')?.addEventListener('submit', manejarLoginCorreo);

      if (!auth) return;

      const proveedorGoogle = new GoogleAuthProvider();
      const proveedorFacebook = new FacebookAuthProvider();

      const iniciarConProveedor = async (proveedor, plataforma) => {
        try {
          if (window.innerWidth < 768) {
            await signInWithRedirect(auth, proveedor);
            return;
          }
          await signInWithPopup(auth, proveedor);
        } catch (error) {
          console.error(error);
          alert(`No se pudo completar el inicio de sesi√≥n con ${plataforma}.`);
        }
      };

      const ejecutarAccionLogin = async (tipo) => {
        if (tipo === 'google') {
          await iniciarConProveedor(proveedorGoogle, 'Google');
          return;
        }
        if (tipo === 'facebook') {
          await iniciarConProveedor(proveedorFacebook, 'Facebook');
        }
      };

      document.addEventListener('click', async (evento) => {
        const boton = evento.target.closest('[data-login]');
        if (!boton) return;
        evento.preventDefault();
        await ejecutarAccionLogin(boton.dataset.login);
      });

      onAuthStateChanged(auth, async (usuario) => {
        estado.usuario = usuario;
        estado.autenticacionOffline = false;
        if (usuario) {
          estado.usuarioInvitado = false;
          estado.esAdmin = ADMIN_EMAILS.includes(usuario.email);
          cerrarModalInicio();
          if (analytics) logEvent(analytics, 'login_usuario');
        } else {
          estado.esAdmin = false;
          estado.usuarioInvitado = true;
        }
        actualizarVisibilidadAdmin();
        actualizarMensajeHero();
        if (estado.seccionActual === 'perfil') {
          renderizarPerfil();
        }
        mostrarSeccion(estado.seccionActual);
      });

      getRedirectResult(auth).catch((error) => console.error(error));
    };

    document.addEventListener('click', (evento) => {
      const botonImagen = evento.target.closest('[data-admin-imagen]');
      if (botonImagen) {
        evento.preventDefault();
        gestionarGaleria(botonImagen.dataset.tipo, botonImagen.dataset.adminImagen);
        return;
      }
      const botonEditar = evento.target.closest('[data-admin-editar]');
      if (botonEditar) {
        evento.preventDefault();
        gestionarEdicionItem(botonEditar.dataset.tipo, botonEditar.dataset.adminEditar);
        return;
      }
      const botonResena = evento.target.closest('[data-admin-resena]');
      if (botonResena) {
        evento.preventDefault();
        crearResenaAdmin(botonResena.dataset.tipo, botonResena.dataset.adminResena);
      }
    });

    const iniciarApp = async () => {
      cargarPreferencias();
      aplicarClasesAccesibilidad();
      actualizarVisibilidadAdmin();
      actualizarMensajeHero();
      await inicializarDatos();
      inicializarSOS();
      inicializarVoz();
      inicializarAuth();
      await inicializarClima();
      qs('#btnActualizarClima').addEventListener('click', () => inicializarClima());
      mostrarSeccion('inicio');
      abrirModalInicio();
    };

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') {
        if (estado.intervaloClima) {
          clearInterval(estado.intervaloClima);
          estado.intervaloClima = null;
        }
        restablecerClima();
      } else if (document.visibilityState === 'visible') {
        inicializarClima();
      }
    });

    document.addEventListener('DOMContentLoaded', iniciarApp);
  </script>
</body>
</html>
