<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Turismo San Mart√≠n de la Vega</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&family=OpenDyslexic:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-fondo: #ffffff;
      --color-superficie: #f5f7fb;
      --color-primario: #0b3d91;
      --color-secundario: #4caf50;
      --color-texto: #17202a;
      --color-texto-suave: #424b57;
      --color-borde: rgba(11, 61, 145, 0.1);
      --color-alerta: #d32f2f;
      --sombra: 0 12px 24px rgba(11, 61, 145, 0.08);
      --radio: 18px;
      --font-base: "Open Sans", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --font-dyslexia: "OpenDyslexic", "Open Sans", sans-serif;
      --tamano-base: 16px;
      --line-height: 1.55;
      --espaciado-letras: 0;
      --espaciado-palabras: 0;
      --alto-cta: 48px;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: var(--font-base);
      font-size: var(--tamano-base);
      line-height: var(--line-height);
      letter-spacing: var(--espaciado-letras);
      word-spacing: var(--espaciado-palabras);
      background: var(--color-fondo);
      color: var(--color-texto);
      transition: background 0.3s ease, color 0.3s ease;
    }

    h1, h2, h3, h4 {
      font-weight: 700;
      margin: 0;
    }

    p {
      margin: 0 0 1rem;
      text-align: left;
    }

    img {
      max-width: 100%;
      display: block;
    }

    a {
      color: inherit;
    }

    button, input, select, textarea {
      font-family: inherit;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--color-primario);
      color: #fff;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 8px 18px rgba(11, 61, 145, 0.18);
    }

    header img {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }

    .titulo-app {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .titulo-app small {
      font-size: 0.75rem;
      opacity: 0.85;
    }

    .menu-toggle {
      background: rgba(255, 255, 255, 0.12);
      border: none;
      color: #fff;
      width: 48px;
      height: 48px;
      border-radius: 12px;
      font-size: 1.4rem;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .menu-toggle:active,
    .menu-toggle:focus-visible {
      outline: none;
      background: rgba(255, 255, 255, 0.24);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      max-width: 1440px;
      margin: 0 auto;
      width: 100%;
    }

    nav {
      position: fixed;
      inset: 0 auto 0 -310px;
      width: 280px;
      background: var(--color-superficie);
      box-shadow: 12px 0 32px rgba(11, 61, 145, 0.08);
      padding: 1.5rem 1.25rem 4rem;
      overflow-y: auto;
      transition: transform 0.28s ease;
      z-index: 120;
    }

    nav.abierto {
      transform: translateX(310px);
    }

    .overlay-menu {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.24s ease;
      z-index: 110;
    }

    .overlay-menu.visible {
      opacity: 1;
      visibility: visible;
    }

    .nav-logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .nav-logo img {
      width: 48px;
    }

    .nav-links {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .nav-links li button {
      width: 100%;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 12px;
      padding: 0.9rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      color: var(--color-texto);
      cursor: pointer;
      transition: background 0.2s ease, border 0.2s ease, transform 0.2s ease;
    }

    .nav-links li button:hover,
    .nav-links li button:focus-visible,
    .nav-links li button.activo {
      background: rgba(11, 61, 145, 0.08);
      border-color: rgba(11, 61, 145, 0.12);
      transform: translateX(2px);
      outline: none;
    }

    .sub-lista {
      list-style: none;
      margin: 0.2rem 0 0.5rem 0;
      padding-left: 1.75rem;
      display: none;
      flex-direction: column;
      gap: 0.55rem;
    }

    .sub-lista.visible {
      display: flex;
    }

    .sub-lista button {
      justify-content: flex-start;
      gap: 0.75rem;
      font-weight: 500;
      font-size: 0.9rem;
    }

    main {
      padding: 1.5rem 1rem 4rem;
    }

    .panel-hero {
      background: linear-gradient(135deg, rgba(11, 61, 145, 0.95), rgba(76, 175, 80, 0.88));
      color: #fff;
      border-radius: var(--radio);
      padding: 1.75rem;
      display: grid;
      gap: 0.75rem;
      box-shadow: var(--sombra);
      margin-bottom: 2rem;
    }

    .panel-hero .botones {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .btn-primario,
    .btn-secundario {
      border-radius: 14px;
      border: none;
      padding: 0 1.6rem;
      height: var(--alto-cta);
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    .btn-primario {
      background: #fff;
      color: var(--color-primario);
      box-shadow: 0 12px 30px rgba(255, 255, 255, 0.28);
    }

    .btn-secundario {
      background: rgba(255, 255, 255, 0.18);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.4);
    }

    .btn-primario:active,
    .btn-secundario:active {
      transform: scale(0.98);
    }

    .seccion {
      margin-bottom: 2.5rem;
    }

    .seccion-encabezado {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .buscador {
      flex: 1;
      min-width: 220px;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: var(--color-superficie);
      border-radius: 999px;
      padding: 0.55rem 1.2rem;
      box-shadow: inset 0 0 0 1px var(--color-borde);
    }

    .buscador input {
      border: none;
      background: transparent;
      width: 100%;
      color: inherit;
      font-size: 1rem;
    }

    .buscador input:focus {
      outline: none;
    }

    .chips-filtros {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid var(--color-primario);
      background: transparent;
      color: var(--color-primario);
      padding: 0.35rem 0.85rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }

    .chip.activo {
      background: var(--color-primario);
      color: #fff;
      transform: translateY(-1px);
    }

    .rejilla-tarjetas {
      display: grid;
      gap: 1.5rem;
    }

    .tarjeta {
      border-radius: var(--radio);
      background: var(--color-superficie);
      box-shadow: var(--sombra);
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      position: relative;
    }

    .tarjeta.cerrada .tarjeta-detalle {
      max-height: 0;
      padding: 0 1.5rem;
      opacity: 0;
      pointer-events: none;
    }

    .tarjeta.abierta {
      transform: translateY(-4px);
    }

    .tarjeta-portada {
      position: relative;
      height: 220px;
      overflow: hidden;
    }

    .tarjeta-portada img,
    .tarjeta-portada iframe {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .tarjeta-contenido {
      padding: 1.5rem;
      display: grid;
      gap: 1rem;
    }

    .tarjeta-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .tarjeta-tag {
      background: rgba(11, 61, 145, 0.1);
      color: var(--color-primario);
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .tarjeta-acciones {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .tarjeta-detalle {
      padding: 0 1.5rem 1.5rem;
      display: grid;
      gap: 1rem;
      transition: all 0.28s ease;
      max-height: 1200px;
    }

    .mapa-contenedor {
      width: 100%;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
    }

    .mapa-contenedor iframe {
      border: 0;
      width: 100%;
      height: 260px;
    }

    .btn-favorito {
      margin-left: auto;
      background: transparent;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .btn-favorito.favorito {
      color: #ff5a5f;
      transform: scale(1.1);
    }

    .rese√±as-lista {
      display: grid;
      gap: 1rem;
    }

    .rese√±a {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 16px;
      padding: 1rem 1.2rem;
      box-shadow: inset 0 0 0 1px rgba(11, 61, 145, 0.08);
    }

    .rese√±a-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .estrellas {
      color: #ffb400;
      font-size: 1rem;
    }

    .rese√±a-acciones {
      display: flex;
      gap: 0.5rem;
    }

    .rese√±a-acciones button {
      border: none;
      border-radius: 8px;
      padding: 0.35rem 0.6rem;
      cursor: pointer;
      background: rgba(11, 61, 145, 0.08);
    }

    form.rese√±a-form {
      display: grid;
      gap: 0.75rem;
      background: rgba(11, 61, 145, 0.07);
      border-radius: 16px;
      padding: 1rem 1.2rem;
    }

    .rating-input {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .rating-input input[type="radio"] {
      display: none;
    }

    .rating-input label {
      font-size: 1.5rem;
      color: #ccc;
      cursor: pointer;
    }

    .rating-input input:checked ~ label,
    .rating-input label:hover,
    .rating-input label:hover ~ label {
      color: #ffb400;
    }

    textarea {
      min-height: 110px;
      border-radius: 12px;
      border: 1px solid rgba(11, 61, 145, 0.15);
      padding: 0.75rem;
      resize: vertical;
    }

    .chips-emocion {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .chip-emocion {
      padding: 0.35rem 0.75rem;
      border-radius: 10px;
      border: 1px solid rgba(11, 61, 145, 0.22);
      background: rgba(255, 255, 255, 0.7);
      cursor: pointer;
    }

    .chip-emocion.activo {
      background: rgba(11, 61, 145, 0.15);
      border-color: rgba(11, 61, 145, 0.45);
    }

    .historia-linea {
      display: grid;
      gap: 1.5rem;
    }

    .evento-historia {
      border-left: 4px solid var(--color-primario);
      padding: 0.75rem 1rem;
      background: var(--color-superficie);
      border-radius: 12px;
      box-shadow: var(--sombra);
    }

    .evento-historia h3 {
      margin-bottom: 0.4rem;
    }

    .eventos-grid {
      display: grid;
      gap: 1rem;
    }

    .calendario {
      background: var(--color-superficie);
      border-radius: var(--radio);
      padding: 1.25rem;
      box-shadow: var(--sombra);
      overflow: hidden;
    }

    .calendario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .calendario-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.4rem;
    }

    .calendario-dia {
      aspect-ratio: 1;
      border-radius: 12px;
      display: grid;
      place-items: center;
      background: rgba(11, 61, 145, 0.04);
      cursor: default;
      font-weight: 600;
    }

    .calendario-dia.evento {
      background: rgba(76, 175, 80, 0.2);
      cursor: pointer;
    }

    .widget-clima {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      padding: 1rem;
      border-radius: 18px;
      background: rgba(11, 61, 145, 0.08);
      max-width: 280px;
    }

    .ajustes-panel {
      display: grid;
      gap: 1.2rem;
    }

    .ajuste-card {
      background: var(--color-superficie);
      padding: 1.2rem;
      border-radius: 16px;
      box-shadow: var(--sombra);
    }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .toggle input {
      width: 48px;
      height: 24px;
    }

    .perfil {
      display: grid;
      gap: 1rem;
    }

    .perfil header {
      background: var(--color-superficie);
      color: inherit;
      box-shadow: none;
      padding: 1.5rem;
      border-radius: 16px;
    }

    .favoritos-grid {
      display: grid;
      gap: 1rem;
    }

    .boton-sos {
      position: fixed;
      bottom: 1.25rem;
      right: 1.25rem;
      background: var(--color-alerta);
      color: #fff;
      border-radius: 999px;
      border: none;
      width: 60px;
      height: 60px;
      font-size: 1.6rem;
      box-shadow: 0 16px 32px rgba(211, 47, 47, 0.35);
      cursor: pointer;
      z-index: 150;
    }

    .sos-panel {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 140;
    }

    .sos-panel.visible {
      display: flex;
    }

    .sos-contenido {
      background: var(--color-fondo);
      color: var(--color-texto);
      padding: 2rem 1.5rem;
      border-radius: 20px;
      width: min(92vw, 420px);
      display: grid;
      gap: 1rem;
      box-shadow: var(--sombra);
    }

    .sos-contenido ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.75rem;
    }

    .sos-contenido li {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      background: var(--color-superficie);
      padding: 0.75rem;
      border-radius: 14px;
    }

    .voz-boton {
      position: fixed;
      bottom: 1.25rem;
      left: 1.25rem;
      width: 58px;
      height: 58px;
      border-radius: 50%;
      border: none;
      background: var(--color-primario);
      color: #fff;
      font-size: 1.4rem;
      box-shadow: 0 18px 30px rgba(11, 61, 145, 0.28);
      display: none;
      z-index: 150;
    }

    .voz-boton.visible {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .modo-oscuro {
      --color-fondo: #121212;
      --color-superficie: #1f2633;
      --color-texto: #e6ecf5;
      --color-texto-suave: #c8d1e0;
      --color-borde: rgba(230, 236, 245, 0.18);
      --sombra: 0 12px 28px rgba(0, 0, 0, 0.45);
    }

    .modo-senior {
      --tamano-base: 19px;
      --alto-cta: 56px;
    }

    .modo-dislexia {
      --font-base: var(--font-dyslexia);
      --line-height: 1.8;
      --espaciado-letras: 0.04em;
      --espaciado-palabras: 0.08em;
    }

    .modo-visibilidad {
      --color-fondo: #000000;
      --color-superficie: #0d111a;
      --color-texto: #ffffff;
      --color-texto-suave: #e0e5ee;
      --color-borde: rgba(255, 255, 255, 0.2);
    }

    .sin-datos {
      padding: 2rem;
      text-align: center;
      border-radius: 16px;
      background: var(--color-superficie);
    }

    @media (min-width: 900px) {
      .layout {
        grid-template-columns: 280px 1fr;
        gap: 2rem;
      }

      nav {
        position: sticky;
        inset: unset;
        transform: none !important;
        height: calc(100vh - 2rem);
        border-radius: 24px;
        margin: 1rem 0 1rem 1rem;
      }

      .overlay-menu {
        display: none;
      }

      main {
        padding: 2.5rem 2rem 5rem 0;
      }

      header {
        border-radius: 24px;
        margin: 1rem;
      }

      .rejilla-tarjetas {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      }

      .panel-hero {
        grid-template-columns: 1.4fr 1fr;
        align-items: center;
      }
    }

    @media (max-width: 520px) {
      .panel-hero .botones {
        flex-direction: column;
        align-items: stretch;
      }

      .btn-primario,
      .btn-secundario {
        width: 100%;
      }

      .tarjeta-portada {
        height: 190px;
      }
    }
  </style>
</head>
<body>
  <header aria-label="Barra superior">
    <button class="menu-toggle" aria-label="Abrir men√∫" id="btnToggleMenu">‚ò∞</button>
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Escudo_de_San_Mart%C3%ADn_de_la_Vega.svg/240px-Escudo_de_San_Mart%C3%ADn_de_la_Vega.svg.png" alt="Escudo de San Mart√≠n de la Vega" width="40" height="40">
    <div class="titulo-app">
      <h1>Turismo San Mart√≠n de la Vega</h1>
      <small>Gu√≠a interactiva ¬∑ Lugares ¬∑ Gastronom√≠a ¬∑ Historia</small>
    </div>
  </header>

  <div class="overlay-menu" id="overlayMenu" role="presentation"></div>

  <div class="layout">
    <nav id="menuLateral" aria-label="Men√∫ principal">
      <div class="nav-logo">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/02/Escudo_de_San_Mart%C3%ADn_de_la_Vega.svg/240px-Escudo_de_San_Mart%C3%ADn_de_la_Vega.svg.png" alt="Escudo San Mart√≠n de la Vega">
        <div>
          <strong>Explora San Mart√≠n</strong>
          <p style="margin:0;font-size:0.85rem;color:var(--color-texto-suave);">Men√∫ de navegaci√≥n</p>
        </div>
      </div>
      <ul class="nav-links">
        <li>
          <button data-seccion="inicio" class="activo">üè† Inicio</button>
        </li>
        <li>
          <button data-seccion="lugares">üìç Lugares de inter√©s</button>
          <ul class="sub-lista" data-parent="lugares">
            <li><button data-tag="naturaleza">üåø Naturaleza</button></li>
            <li><button data-tag="cultural">üèõÔ∏è Patrimonio</button></li>
            <li><button data-tag="aventura">üé¢ Aventura</button></li>
            <li><button data-tag="familia">üë®‚Äçüë©‚Äçüëß En familia</button></li>
          </ul>
        </li>
        <li>
          <button data-seccion="restaurantes">üçΩÔ∏è Restaurantes</button>
          <ul class="sub-lista" data-parent="restaurantes">
            <li><button data-tag="tradicional">ü•ò Cocina tradicional</button></li>
            <li><button data-tag="tapas">üçª Tapas y Bares</button></li>
            <li><button data-tag="familiar">üç¥ Familiar</button></li>
          </ul>
        </li>
        <li>
          <button data-seccion="ocio">üö¥ Deportes &amp; Ocio</button>
          <ul class="sub-lista" data-parent="ocio">
            <li><button data-tag="senderismo">ü•æ Rutas</button></li>
            <li><button data-tag="agua">üö£ Actividades acu√°ticas</button></li>
          </ul>
        </li>
        <li>
          <button data-seccion="historia">üìú Historia</button>
          <ul class="sub-lista" data-parent="historia">
            <li><button data-epoca="cronologico">üï∞Ô∏è L√≠nea temporal</button></li>
            <li><button data-epoca="topografia">üó∫Ô∏è Topograf√≠a</button></li>
            <li><button data-epoca="conflictos">‚öîÔ∏è Conflictos b√©licos</button></li>
          </ul>
        </li>
        <li>
          <button data-seccion="eventos">üìÜ Festividades</button>
        </li>
        <li>
          <button data-seccion="perfil">üë§ Mi perfil</button>
        </li>
        <li>
          <button data-seccion="ajustes">‚öôÔ∏è Ajustes &amp; Accesibilidad</button>
        </li>
      </ul>
    </nav>

    <main id="contenido" tabindex="-1">
      <section class="panel-hero" id="panelHero">
        <div>
          <h2>Descubre la esencia de San Mart√≠n de la Vega</h2>
          <p>Planifica tu visita, guarda tus lugares favoritos y vive experiencias √∫nicas en el coraz√≥n del valle del Jarama. Informaci√≥n siempre actualizada gracias a Firebase.</p>
          <div class="botones">
            <button class="btn-primario" data-seccion-go="lugares">Explorar lugares</button>
            <button class="btn-secundario" data-seccion-go="historia">Conocer su historia</button>
          </div>
        </div>
        <aside class="widget-clima" aria-live="polite" id="widgetClima">
          <strong>Clima local</strong>
          <span id="climaResumen">Obteniendo clima...</span>
          <small id="climaDetalle">Actualizando datos meteorol√≥gicos.</small>
          <button class="btn-secundario" id="btnActualizarClima" style="width:max-content;">Actualizar</button>
        </aside>
      </section>

      <section class="seccion" id="seccionContenido">
        <div class="sin-datos">
          Selecciona una categor√≠a del men√∫ para comenzar.
        </div>
      </section>
    </main>
  </div>

  <button class="boton-sos" id="btnSOS" aria-haspopup="dialog" aria-controls="sosPanel" aria-expanded="false">‚öïÔ∏è</button>
  <div class="sos-panel" id="sosPanel" role="dialog" aria-modal="true" aria-labelledby="sosTitulo">
    <div class="sos-contenido">
      <header>
        <h2 id="sosTitulo">Informaci√≥n √∫til y emergencias</h2>
        <p>Contactos disponibles 24/7 en San Mart√≠n de la Vega.</p>
      </header>
      <ul>
        <li>
          <strong>Emergencias generales</strong>
          <span>112</span>
          <a class="btn-secundario" href="tel:112">Llamar</a>
        </li>
        <li>
          <strong>Polic√≠a Local</strong>
          <span>918 949 016</span>
          <div class="tarjeta-acciones">
            <a class="btn-secundario" href="tel:918949016">Llamar</a>
            <a class="btn-secundario" href="https://maps.google.com/?q=Polic%C3%ADa+Local+San+Mart%C3%ADn+de+la+Vega" target="_blank" rel="noopener">Ver mapa</a>
          </div>
        </li>
        <li>
          <strong>Centro de Salud</strong>
          <span>918 949 019 ¬∑ C/ Maestro Rodrigo, 2</span>
          <div class="tarjeta-acciones">
            <a class="btn-secundario" href="tel:918949019">Llamar</a>
            <a class="btn-secundario" href="https://maps.google.com/?q=Centro+de+Salud+San+Mart%C3%ADn+de+la+Vega" target="_blank" rel="noopener">Ver mapa</a>
          </div>
        </li>
        <li>
          <strong>Farmacia de Guardia</strong>
          <span id="farmaciaGuardia">Consultar Ayuntamiento ¬∑ Actualizado diariamente</span>
        </li>
      </ul>
      <button class="btn-primario" id="btnCerrarSOS">Cerrar</button>
    </div>
  </div>

  <button class="voz-boton" id="btnVoz" aria-label="Activar comandos por voz">üéôÔ∏è</button>

  <script type="module">
    'use strict';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
    import { getAnalytics, logEvent } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-analytics.js';
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      where,
      orderBy,
      addDoc,
      serverTimestamp,
      updateDoc,
      deleteDoc,
      doc
    } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';
    import {
      getAuth,
      onAuthStateChanged,
      GoogleAuthProvider,
      FacebookAuthProvider,
      signInWithPopup,
      signOut,
      deleteUser,
      signInWithRedirect,
      getRedirectResult,
      reauthenticateWithPopup
    } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js';
    import {
      getStorage,
      ref as storageRef,
      getDownloadURL
    } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js';

    const firebaseConfig = {
      apiKey: window.FIREBASE_API_KEY || 'REEMPLAZAR_API_KEY',
      authDomain: window.FIREBASE_AUTH_DOMAIN || 'REEMPLAZAR_AUTH_DOMAIN',
      projectId: window.FIREBASE_PROJECT_ID || 'REEMPLAZAR_PROJECT_ID',
      storageBucket: window.FIREBASE_STORAGE_BUCKET || 'REEMPLAZAR_STORAGE_BUCKET',
      messagingSenderId: window.FIREBASE_MESSAGING_ID || 'REEMPLAZAR_SENDER_ID',
      appId: window.FIREBASE_APP_ID || 'REEMPLAZAR_APP_ID',
      measurementId: window.FIREBASE_MEASUREMENT_ID || 'REEMPLAZAR_MEASUREMENT_ID'
    };

    let app;
    let analytics;
    let db;
    let auth;
    let storage;

    try {
      app = initializeApp(firebaseConfig);
      analytics = getAnalytics(app);
      db = getFirestore(app);
      auth = getAuth(app);
      storage = getStorage(app);
    } catch (error) {
      console.warn('Firebase no se inicializ√≥ correctamente. Se usar√° modo offline.', error);
    }

    const estado = {
      usuario: null,
      seccionActual: 'inicio',
      filtros: {
        texto: '',
        etiquetas: new Set(),
        epocaHistoria: 'cronologico'
      },
      datos: {
        lugares: [],
        restaurantes: [],
        ocio: [],
        historia: [],
        eventos: [],
        favoritos: new Set()
      },
      modoOscuro: false,
      modoSenior: false,
      modoDislexia: false,
      modoVisibilidad: false,
      reconocimientoActivo: false
    };

    const datosFallback = {
      lugares: [
        {
          id: 'warner',
          nombre: 'Parque Warner Madrid',
          descripcion: 'Parque tem√°tico con atracciones para toda la familia y espect√°culos diarios.',
          tipo: 'aventura',
          etiquetas: ['familia', 'aventura', 'amigos', 'fin de semana'],
          direccion: 'Carretera M-506, San Mart√≠n de la Vega',
          coords: { lat: 40.2296, lng: -3.5954 },
          portada: 'https://upload.wikimedia.org/wikipedia/commons/f/fe/Parque_Warner_Madrid_%28cropped%29.JPG',
          multimedia: ['https://upload.wikimedia.org/wikipedia/commons/f/fe/Parque_Warner_Madrid_%28cropped%29.JPG']
        },
        {
          id: 'iglesia',
          nombre: 'Iglesia de la Natividad de Nuestra Se√±ora',
          descripcion: 'Templo del siglo XVII con una destacada torre mud√©jar, epicentro del casco hist√≥rico.',
          tipo: 'cultural',
          etiquetas: ['cultural', 'patrimonio', 'familia'],
          direccion: 'Plaza de la Iglesia, 1',
          coords: { lat: 40.2086, lng: -3.5657 },
          portada: 'https://upload.wikimedia.org/wikipedia/commons/7/76/Iglesia_de_San_Mart%C3%ADn_de_la_Vega.jpg'
        },
        {
          id: 'mara√±osa',
          nombre: 'Cerros de la Mara√±osa',
          descripcion: 'Paraje natural ligado a la batalla del Jarama. Ideal para rutas interpretativas.',
          tipo: 'naturaleza',
          etiquetas: ['naturaleza', 'historia', 'senderismo'],
          direccion: 'Carretera de la Mara√±osa',
          coords: { lat: 40.3223, lng: -3.5611 },
          portada: 'https://upload.wikimedia.org/wikipedia/commons/d/de/Cerro_de_La_Mara%C3%B1osa.jpg'
        }
      ],
      restaurantes: [
        {
          id: 'zatara',
          nombre: 'Restaurante Cervecer√≠a Zatara',
          descripcion: 'Cocina casera espa√±ola con especialidad en mariscos, carnes y tapas abundantes.',
          tipo: 'tradicional',
          etiquetas: ['familia', 'tapas', 'tradicional'],
          direccion: 'Calle Mayor, 18',
          coords: { lat: 40.2081, lng: -3.5652 },
          portada: 'https://images.unsplash.com/photo-1559339352-11d035aa65de?auto=format&fit=crop&w=1200&q=80'
        },
        {
          id: 'lindero',
          nombre: 'Mes√≥n El Lindero',
          descripcion: 'Asador castellano con horno de le√±a, carnes selectas y postres caseros.',
          tipo: 'tradicional',
          etiquetas: ['familia', 'tradicional'],
          direccion: 'Av. Nuestra Se√±ora de la Vega, 45',
          coords: { lat: 40.2052, lng: -3.5622 },
          portada: 'https://images.unsplash.com/photo-1529692236671-f1dc28d31130?auto=format&fit=crop&w=1200&q=80'
        }
      ],
      ocio: [
        {
          id: 'sendero-jarama',
          nombre: 'Ruta fluvial del Jarama',
          descripcion: 'Recorrido llano junto al r√≠o, ideal para bicicleta o paseo en familia.',
          tipo: 'senderismo',
          etiquetas: ['naturaleza', 'familia', 'senderismo'],
          distancia: '8 km (ida y vuelta)',
          dificultad: 'Baja',
          portada: 'https://upload.wikimedia.org/wikipedia/commons/2/2d/Rio_Jarama.JPG',
          descargaGPX: 'https://firebasestorage.googleapis.com/v0/b/REEMPLAZAR/o/ruta-jarama.gpx?alt=media'
        },
        {
          id: 'bunker',
          nombre: 'Ruta posiciones de la Mara√±osa',
          descripcion: 'Itinerario hist√≥rico por los bunkers de la Guerra Civil con vistas panor√°micas.',
          tipo: 'senderismo',
          etiquetas: ['historia', 'aventura'],
          distancia: '5 km',
          dificultad: 'Media',
          portada: 'https://upload.wikimedia.org/wikipedia/commons/3/39/Bunker_mara%C3%B1osa.jpg',
          descargaGPX: 'https://firebasestorage.googleapis.com/v0/b/REEMPLAZAR/o/maranosa.gpx?alt=media'
        }
      ],
      historia: [
        {
          id: 'hist-pre',
          titulo: 'Prehistoria y Edad Antigua',
          epoca: 'cronologico',
          tags: ['cronologico', 'topografia'],
          texto: 'Hallazgos paleol√≠ticos evidencian ocupaci√≥n temprana. En √©poca romana, el paso de calzadas facilit√≥ el asentamiento agr√≠cola gracias a la fertilidad de la vega.'
        },
        {
          id: 'hist-medieval',
          titulo: 'Siglos X-XV: Repoblaci√≥n y disputas',
          epoca: 'cronologico',
          tags: ['cronologico', 'conflictos'],
          texto: 'El enclave fortificado de Albende defend√≠a Toledo. En 1440 la repoblaci√≥n castellana origin√≥ conflictos con Valdemoro por el control de las vegas.'
        },
        {
          id: 'hist-jarama',
          titulo: '1937: Batalla del Jarama',
          epoca: 'conflictos',
          tags: ['conflictos', 'cronologico'],
          texto: 'Uno de los episodios m√°s duros de la Guerra Civil. Los cerros de la Mara√±osa fueron escenario de combates que marcaron la memoria del municipio.'
        },
        {
          id: 'hist-topografia',
          titulo: 'Topograf√≠a y entorno',
          epoca: 'topografia',
          tags: ['topografia'],
          texto: 'La vega del Jarama ofrece suelos f√©rtiles y humedales de alto valor ecol√≥gico, con vegas dedicadas hist√≥ricamente a la agricultura de regad√≠o.'
        }
      ],
      eventos: [
        {
          id: 'romeria',
          fecha: '2024-04-25',
          nombre: 'Romer√≠a de San Marcos',
          descripcion: 'Tradicional romer√≠a hasta la ermita con degustaci√≥n de rosquillas y m√∫sica popular.',
          lugar: 'Ermita de San Marcos'
        },
        {
          id: 'fiestas',
          fecha: '2024-08-15',
          nombre: 'Fiestas Patronales',
          descripcion: 'Encierros, conciertos nocturnos y actividades infantiles durante toda la semana.',
          lugar: 'Casco urbano'
        }
      ]
    };

    const palabrasProhibidas = [
      'idiota', 'imb√©cil', 'est√∫pido', 'tonto', 'tarado', 'gilipollas', 'capullo', 'baboso', 'cretino', 'pat√°n',
      'payaso', 'pendejo', 'cabron', 'cabr√≥n', 'cabrona', 'carajo', 'mierda', 'joder', 'cojones', 'co√±o', 'hijo de puta',
      'zorra', 'puta', 'mierdoso', 'est√∫pida', 'imb√©cila', 'bastardo', 'malnacido', 'cag√≥n', 'cagona', 'sarnoso',
      'bobo', 'bobota', 'babosa', 'culero', 'culera', 'mam√≥n', 'mamona', 'perra', 'asqueroso', 'asquerosa', 'maric√≥n',
      'maricona', 'pendeja', 'petardo', 'petarda', 'z√°ngano', 'lagarta', 'huev√≥n', 'huevona', 'menso', 'mensa',
      'idioteces', 'imbecilidades', 'soplapollas', 'cacho', 'chupacabras', 'chupasangre', 'desgraciado', 'desgraciada',
      'infeliz', 'maldito', 'maldita', 'pataner√≠a', 'burro', 'burra'
    ];

    const qs = (selector, parent = document) => parent.querySelector(selector);
    const qsa = (selector, parent = document) => Array.from(parent.querySelectorAll(selector));

    const sanitizarTexto = (texto) => {
      if (!texto) return '';
      const expresion = new RegExp(palabrasProhibidas.join('|'), 'gi');
      return texto.replace(expresion, (coincidencia) => '*'.repeat(coincidencia.length));
    };

    const formatearFecha = (fecha) => {
      return new Intl.DateTimeFormat('es-ES', { dateStyle: 'long' }).format(fecha instanceof Date ? fecha : new Date(fecha));
    };

    const anunciar = (mensaje) => {
      if (!estado.modoVisibilidad) return;
      const utterance = new SpeechSynthesisUtterance(mensaje);
      utterance.lang = 'es-ES';
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utterance);
    };

    const obtenerMesNombre = (indiceMes) => {
      const formatter = new Intl.DateTimeFormat('es-ES', { month: 'long' });
      return formatter.format(new Date(new Date().getFullYear(), indiceMes, 1));
    };

    const guardarPreferencias = () => {
      const prefs = {
        modoOscuro: estado.modoOscuro,
        modoSenior: estado.modoSenior,
        modoDislexia: estado.modoDislexia,
        modoVisibilidad: estado.modoVisibilidad
      };
      localStorage.setItem('turismo_sm_preferences', JSON.stringify(prefs));
    };

    const cargarPreferencias = () => {
      try {
        const prefs = JSON.parse(localStorage.getItem('turismo_sm_preferences'));
        if (!prefs) return;
        estado.modoOscuro = prefs.modoOscuro;
        estado.modoSenior = prefs.modoSenior;
        estado.modoDislexia = prefs.modoDislexia;
        estado.modoVisibilidad = prefs.modoVisibilidad;
      } catch (error) {
        console.warn('No se pudieron cargar preferencias', error);
      }
    };

    const aplicarClasesAccesibilidad = () => {
      document.body.classList.toggle('modo-oscuro', estado.modoOscuro);
      document.body.classList.toggle('modo-senior', estado.modoSenior);
      document.body.classList.toggle('modo-dislexia', estado.modoDislexia);
      document.body.classList.toggle('modo-visibilidad', estado.modoVisibilidad);
      qs('#btnVoz').classList.toggle('visible', estado.modoVisibilidad);
      guardarPreferencias();
    };

    const menuLateral = qs('#menuLateral');
    const overlayMenu = qs('#overlayMenu');

    const abrirMenu = () => {
      menuLateral.classList.add('abierto');
      overlayMenu.classList.add('visible');
      anunciar('Men√∫ abierto. Selecciona una secci√≥n.');
    };

    const cerrarMenu = () => {
      menuLateral.classList.remove('abierto');
      overlayMenu.classList.remove('visible');
    };

    qs('#btnToggleMenu').addEventListener('click', () => {
      const abierto = menuLateral.classList.contains('abierto');
      abierto ? cerrarMenu() : abrirMenu();
    });

    overlayMenu.addEventListener('click', cerrarMenu);

    const actualizarMenuActivo = (seccion) => {
      qsa('nav button[data-seccion]').forEach((btn) => {
        btn.classList.toggle('activo', btn.dataset.seccion === seccion);
      });
      estado.seccionActual = seccion;
      if (window.innerWidth < 900) cerrarMenu();
    };

    qsa('nav button[data-seccion]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const seccion = btn.dataset.seccion;
        actualizarMenuActivo(seccion);
        mostrarSeccion(seccion);
        if (analytics) logEvent(analytics, 'navegacion_seccion', { seccion });
        anunciar(`Secci√≥n ${btn.textContent} activada`);
      });
    });

    qsa('nav button[data-tag]').forEach((btn) => {
      btn.addEventListener('click', (evento) => {
        evento.stopPropagation();
        const etiqueta = btn.dataset.tag;
        estado.filtros.etiquetas = new Set([etiqueta]);
        mostrarSeccion(estado.seccionActual);
        anunciar(`Filtro por etiqueta ${btn.textContent}`);
      });
    });

    qsa('nav button[data-epoca]').forEach((btn) => {
      btn.addEventListener('click', (evento) => {
        evento.stopPropagation();
        estado.filtros.epocaHistoria = btn.dataset.epoca;
        mostrarSeccion('historia');
      });
    });

    qsa('[data-seccion-go]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const seccion = btn.dataset.seccionGo;
        actualizarMenuActivo(seccion);
        mostrarSeccion(seccion);
        qs('#contenido').scrollIntoView({ behavior: 'smooth' });
      });
    });

    const cargarColeccion = async (nombreColeccion, fallback) => {
      if (!db) return fallback;
      try {
        const ref = collection(db, nombreColeccion);
        const snapshot = await getDocs(ref);
        const resultados = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
        if (!resultados.length) return fallback;
        return resultados;
      } catch (error) {
        console.warn(`No se pudo obtener ${nombreColeccion}`, error);
        return fallback;
      }
    };

    const inicializarDatos = async () => {
      estado.datos.lugares = await cargarColeccion('lugares', datosFallback.lugares);
      estado.datos.restaurantes = await cargarColeccion('restaurantes', datosFallback.restaurantes);
      estado.datos.ocio = await cargarColeccion('ocio', datosFallback.ocio);
      estado.datos.historia = await cargarColeccion('historia', datosFallback.historia);
      estado.datos.eventos = await cargarColeccion('eventos', datosFallback.eventos);
      cargarFavoritosLocal();
    };

    const cargarFavoritosLocal = () => {
      try {
        const favoritosGuardados = JSON.parse(localStorage.getItem('turismo_sm_favoritos')) || [];
        estado.datos.favoritos = new Set(favoritosGuardados);
      } catch (error) {
        estado.datos.favoritos = new Set();
      }
    };

    const guardarFavoritosLocal = () => {
      localStorage.setItem('turismo_sm_favoritos', JSON.stringify(Array.from(estado.datos.favoritos)));
    };

    const seccionContenido = qs('#seccionContenido');

    const crearTarjeta = (item, tipoSeccion) => {
      const tarjeta = document.createElement('article');
      tarjeta.className = 'tarjeta cerrada';
      tarjeta.innerHTML = `
        <div class="tarjeta-portada" aria-hidden="true">
          <img src="${item.portada || 'https://images.unsplash.com/photo-1522708323590-d24dbb6b0267?auto=format&fit=crop&w=1200&q=80'}" alt="${item.nombre}">
        </div>
        <div class="tarjeta-contenido">
          <div style="display:flex; align-items:flex-start; gap:1rem;">
            <div>
              <h3>${item.nombre}</h3>
              ${item.direccion ? `<p style="color:var(--color-texto-suave);">${item.direccion}</p>` : ''}
            </div>
            <button class="btn-favorito" aria-label="Agregar a favoritos">‚ô°</button>
          </div>
          <p>${item.descripcion}</p>
          <div class="tarjeta-tags">${(item.etiquetas || []).map((tag) => `<span class="tarjeta-tag">${tag}</span>`).join('')}</div>
          <div class="tarjeta-acciones">
            <button class="btn-secundario" data-accion="toggle">Ver detalles</button>
            ${item.coords ? `<a class="btn-secundario" target="_blank" rel="noopener" href="https://maps.google.com/?q=${encodeURIComponent(item.nombre)}">Abrir en Maps</a>` : ''}
            ${item.descargaGPX ? `<a class="btn-secundario" href="${item.descargaGPX}" download>Descargar ruta</a>` : ''}
          </div>
        </div>
        <div class="tarjeta-detalle" hidden>
          <section class="mapa-contenedor" data-map="${item.coords ? `${item.coords.lat},${item.coords.lng}` : ''}"></section>
          ${tipoSeccion !== 'historia' ? crearFormularioResenaMarkup(item.id, tipoSeccion) : ''}
          ${tipoSeccion !== 'historia' ? `<div class="rese√±as-lista" data-resenas="${item.id}"></div>` : ''}
        </div>
      `;

      const btnFavorito = qs('.btn-favorito', tarjeta);
      const esFavorito = estado.datos.favoritos.has(`${tipoSeccion}:${item.id}`);
      if (esFavorito) btnFavorito.classList.add('favorito');
      btnFavorito.addEventListener('click', (evento) => {
        evento.stopPropagation();
        alternarFavorito(tipoSeccion, item.id, btnFavorito);
      });

      qs('[data-accion="toggle"]', tarjeta).addEventListener('click', (evento) => {
        evento.stopPropagation();
        const abierto = tarjeta.classList.toggle('abierta');
        tarjeta.classList.toggle('cerrada', !abierto);
        const detalle = qs('.tarjeta-detalle', tarjeta);
        if (abierto) {
          detalle.hidden = false;
          inicializarMapa(detalle, item);
          cargarResenas(item.id);
          anunciar(`Mostrando detalles de ${item.nombre}`);
        } else {
          detalle.hidden = true;
          anunciar(`Ocultando detalles de ${item.nombre}`);
        }
      });

      inicializarFormularioResena(tarjeta, item.id, tipoSeccion);
      return tarjeta;
    };

    const crearFormularioResenaMarkup = (itemId) => {
      const emociones = ['Alegr√≠a üòÑ', 'Aventura ü§∏', 'Relax üòå', 'Gastronom√≠a üòã', 'Cultura üé®', 'Naturaleza üåø'];
      return `
        <form class="rese√±a-form" data-form-resena="${itemId}">
          <h4>Comparte tu rese√±a</h4>
          <div class="rating-input" role="radiogroup" aria-label="Valoraci√≥n en estrellas">
            ${[5,4,3,2,1].map((valor) => `
              <input type="radio" id="${itemId}-estrella-${valor}" name="rating" value="${valor}" ${valor === 5 ? 'checked' : ''}>
              <label for="${itemId}-estrella-${valor}">‚òÖ</label>
            `).join('')}
          </div>
          <div>
            <label for="${itemId}-titulo">T√≠tulo</label>
            <input id="${itemId}-titulo" name="titulo" type="text" required maxlength="60" placeholder="Ej. Un d√≠a inolvidable">
          </div>
          <div>
            <label for="${itemId}-texto">Descripci√≥n</label>
            <textarea id="${itemId}-texto" name="texto" required placeholder="Cu√©ntanos tu experiencia"></textarea>
          </div>
          <div>
            <span>¬øC√≥mo te sentiste?</span>
            <div class="chips-emocion">
              ${emociones.map((emo) => `<button type="button" class="chip-emocion" data-emocion="${emo}">${emo}</button>`).join('')}
            </div>
          </div>
          <button type="submit" class="btn-primario">Publicar rese√±a</button>
          <p style="font-size:0.8rem; color:var(--color-texto-suave);">Las rese√±as se moderan autom√°ticamente para un lenguaje respetuoso.</p>
        </form>
      `;
    };

    const inicializarMapa = (contenedor, item) => {
      if (!item.coords) return;
      if (contenedor.dataset.loaded) return;
      const iframe = document.createElement('iframe');
      iframe.loading = 'lazy';
      iframe.title = `Mapa de ${item.nombre}`;
      const base = 'https://www.google.com/maps/embed/v1/place';
      const apiKey = window.GOOGLE_MAPS_API_KEY;
      if (apiKey) {
        iframe.src = `${base}?key=${apiKey}&q=${encodeURIComponent(item.nombre)}&center=${item.coords.lat},${item.coords.lng}`;
      } else {
        iframe.src = `https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d0!2d${item.coords.lng}!3d${item.coords.lat}!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0:0x0!2z${item.coords.lat},${item.coords.lng}!5e0!3m2!1ses!2ses!4v${Date.now()}`;
      }
      contenedor.appendChild(iframe);
      contenedor.dataset.loaded = 'true';
    };

    const renderizarLista = (items, tipoSeccion) => {
      seccionContenido.innerHTML = '';
      if (!items.length) {
        seccionContenido.innerHTML = '<div class="sin-datos">No encontramos resultados con los filtros actuales.</div>';
        return;
      }
      const buscador = document.createElement('div');
      buscador.className = 'seccion-encabezado';
      buscador.innerHTML = `
        <div class="buscador">
          <span aria-hidden="true">üîç</span>
          <input type="search" placeholder="Buscar por nombre" aria-label="Buscar" value="${estado.filtros.texto}">
        </div>
        <div class="chips-filtros" aria-label="Filtros activos"></div>
      `;
      seccionContenido.appendChild(buscador);

      qs('input', buscador).addEventListener('input', (evento) => {
        estado.filtros.texto = evento.target.value.toLowerCase();
        mostrarSeccion(tipoSeccion);
      });

      const chipsFiltros = qs('.chips-filtros', buscador);
      const etiquetasDisponibles = new Set(items.flatMap((item) => item.etiquetas || []));
      etiquetasDisponibles.forEach((etiqueta) => {
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.textContent = etiqueta;
        chip.dataset.etiqueta = etiqueta;
        if (estado.filtros.etiquetas.has(etiqueta)) chip.classList.add('activo');
        chip.addEventListener('click', () => {
          if (estado.filtros.etiquetas.has(etiqueta)) {
            estado.filtros.etiquetas.delete(etiqueta);
          } else {
            estado.filtros.etiquetas.add(etiqueta);
          }
          mostrarSeccion(tipoSeccion);
        });
        chipsFiltros.appendChild(chip);
      });

      const rejilla = document.createElement('div');
      rejilla.className = 'rejilla-tarjetas';
      items.forEach((item) => {
        rejilla.appendChild(crearTarjeta(item, tipoSeccion));
      });
      seccionContenido.appendChild(rejilla);
    };

    const filtrarItems = (items) => {
      return items.filter((item) => {
        const coincideTexto = !estado.filtros.texto || item.nombre.toLowerCase().includes(estado.filtros.texto);
        const coincideEtiqueta = !estado.filtros.etiquetas.size || (item.etiquetas || []).some((tag) => estado.filtros.etiquetas.has(tag));
        return coincideTexto && coincideEtiqueta;
      });
    };

    const renderizarHistoria = () => {
      seccionContenido.innerHTML = '';
      const filtros = document.createElement('div');
      filtros.className = 'chips-filtros';
      const etiquetasDisponibles = new Set(estado.datos.historia.flatMap((item) => item.tags || []));
      etiquetasDisponibles.forEach((tag) => {
        const chip = document.createElement('button');
        chip.className = 'chip';
        chip.textContent = tag;
        if (tag === estado.filtros.epocaHistoria) chip.classList.add('activo');
        chip.addEventListener('click', () => {
          estado.filtros.epocaHistoria = tag;
          renderizarHistoria();
        });
        filtros.appendChild(chip);
      });
      seccionContenido.appendChild(filtros);

      const contenedor = document.createElement('div');
      contenedor.className = 'historia-linea';
      const items = estado.datos.historia.filter((item) => item.tags?.includes(estado.filtros.epocaHistoria));
      if (!items.length) {
        seccionContenido.innerHTML += '<div class="sin-datos">No hay contenido hist√≥rico para esta categor√≠a.</div>';
        return;
      }
      items.forEach((evento) => {
        const tarjeta = document.createElement('article');
        tarjeta.className = 'evento-historia';
        tarjeta.innerHTML = `
          <h3>${evento.titulo}</h3>
          <p>${evento.texto}</p>
          <div class="tarjeta-tags">${(evento.tags || []).map((tag) => `<span class="tarjeta-tag">${tag}</span>`).join('')}</div>
        `;
        contenedor.appendChild(tarjeta);
      });
      seccionContenido.appendChild(contenedor);
    };

    const renderizarEventos = () => {
      seccionContenido.innerHTML = '';
      const contenedor = document.createElement('div');
      contenedor.className = 'eventos-grid';
      const eventosOrdenados = estado.datos.eventos.slice().sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
      if (!eventosOrdenados.length) {
        seccionContenido.innerHTML = '<div class="sin-datos">No hay festividades cargadas.</div>';
        return;
      }
      const fechaReferencia = new Date(eventosOrdenados[0].fecha);
      const mes = fechaReferencia.getMonth();
      const anio = fechaReferencia.getFullYear();
      const primerDiaMes = new Date(anio, mes, 1);
      const offset = primerDiaMes.getDay() === 0 ? 6 : primerDiaMes.getDay() - 1;
      const diasMes = new Date(anio, mes + 1, 0).getDate();

      const calendario = document.createElement('section');
      calendario.className = 'calendario';
      calendario.innerHTML = `
        <div class="calendario-header">
          <h3>${obtenerMesNombre(mes)} ${anio}</h3>
          <span>${eventosOrdenados.length} eventos</span>
        </div>
        <div class="calendario-grid" role="grid">
          ${['L', 'M', 'X', 'J', 'V', 'S', 'D'].map((dia) => `<div class="calendario-dia" role="columnheader">${dia}</div>`).join('')}
          ${Array.from({ length: offset }).map(() => '<div></div>').join('')}
          ${Array.from({ length: diasMes }).map((_, idx) => {
            const dia = idx + 1;
            const fecha = new Date(anio, mes, dia);
            const eventoDelDia = eventosOrdenados.find((evento) => new Date(evento.fecha).getDate() === dia);
            return `<div class="calendario-dia ${eventoDelDia ? 'evento' : ''}" data-fecha="${fecha.toISOString()}" aria-label="${dia} de ${obtenerMesNombre(mes)}">${dia}</div>`;
          }).join('')}
        </div>
      `;
      seccionContenido.appendChild(calendario);

      const detalleEvento = document.createElement('div');
      detalleEvento.className = 'ajuste-card';
      detalleEvento.setAttribute('aria-live', 'polite');
      detalleEvento.innerHTML = '<p>Selecciona un d√≠a resaltado para ver detalles del evento.</p>';
      seccionContenido.appendChild(detalleEvento);

      calendario.addEventListener('click', (evento) => {
        const celda = evento.target.closest('.calendario-dia.evento');
        if (!celda) return;
        const fechaISO = celda.dataset.fecha;
        const eventoSeleccionado = eventosOrdenados.find((ev) => new Date(ev.fecha).toDateString() === new Date(fechaISO).toDateString());
        if (!eventoSeleccionado) return;
        detalleEvento.innerHTML = `
          <h3>${eventoSeleccionado.nombre}</h3>
          <p><strong>Fecha:</strong> ${formatearFecha(eventoSeleccionado.fecha)}</p>
          <p><strong>Lugar:</strong> ${eventoSeleccionado.lugar}</p>
          <p>${eventoSeleccionado.descripcion}</p>
          <div class="tarjeta-acciones">
            <a class="btn-secundario" href="https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(eventoSeleccionado.nombre)}&dates=${eventoSeleccionado.fecha.replace(/-/g, '')}T090000Z/${eventoSeleccionado.fecha.replace(/-/g, '')}T110000Z&details=${encodeURIComponent(eventoSeleccionado.descripcion)}&location=${encodeURIComponent(eventoSeleccionado.lugar)}" target="_blank" rel="noopener">A√±adir a Google Calendar</a>
          </div>
        `;
        anunciar(`Evento ${eventoSeleccionado.nombre} el ${formatearFecha(eventoSeleccionado.fecha)}`);
      });

      eventosOrdenados.forEach((evento) => {
        const tarjeta = document.createElement('article');
        tarjeta.className = 'ajuste-card';
        tarjeta.innerHTML = `
          <h3>${evento.nombre}</h3>
          <p><strong>Fecha:</strong> ${formatearFecha(evento.fecha)}</p>
          <p><strong>Lugar:</strong> ${evento.lugar}</p>
          <p>${evento.descripcion}</p>
        `;
        contenedor.appendChild(tarjeta);
      });
      seccionContenido.appendChild(contenedor);
    };

    const alternarFavorito = (tipo, id, boton) => {
      const clave = `${tipo}:${id}`;
      if (estado.datos.favoritos.has(clave)) {
        estado.datos.favoritos.delete(clave);
        boton.classList.remove('favorito');
      } else {
        estado.datos.favoritos.add(clave);
        boton.classList.add('favorito');
      }
      guardarFavoritosLocal();
      anunciar(`Favorito ${boton.classList.contains('favorito') ? 'a√±adido' : 'eliminado'}`);
    };

    const inicializarFormularioResena = (tarjeta, itemId, tipoSeccion) => {
      const form = qs(`[data-form-resena="${itemId}"]`, tarjeta);
      if (!form) return;
      const chips = qsa('.chip-emocion', form);
      let emocionSeleccionada = '';
      chips.forEach((chip) => {
        chip.addEventListener('click', () => {
          chips.forEach((c) => c.classList.remove('activo'));
          chip.classList.add('activo');
          emocionSeleccionada = chip.dataset.emocion;
        });
      });

      form.addEventListener('submit', async (evento) => {
        evento.preventDefault();
        if (!estado.usuario) {
          alert('Inicia sesi√≥n para publicar rese√±as.');
          return;
        }
        const datos = new FormData(form);
        const rating = Number(datos.get('rating')) || 5;
        const titulo = sanitizarTexto(datos.get('titulo'));
        const texto = sanitizarTexto(datos.get('texto'));
        const rese√±a = {
          itemId,
          tipoSeccion,
          rating,
          titulo,
          texto,
          emocion: emocionSeleccionada,
          usuario: estado.usuario.uid,
          autor: estado.usuario.displayName || 'Usuario',
          fechaCreacion: new Date().toISOString()
        };

        try {
          if (db) {
            await addDoc(collection(db, 'rese√±as'), {
              ...rese√±a,
              fechaCreacion: serverTimestamp()
            });
            if (analytics) logEvent(analytics, 'crear_resena', { tipoSeccion });
          } else {
            const rese√±asLocal = JSON.parse(localStorage.getItem('turismo_sm_resenas') || '[]');
            rese√±a.id = (crypto?.randomUUID?.() || Date.now().toString());
            rese√±asLocal.push(rese√±a);
            localStorage.setItem('turismo_sm_resenas', JSON.stringify(rese√±asLocal));
          }
          form.reset();
          emocionSeleccionada = '';
          chips.forEach((c) => c.classList.remove('activo'));
          cargarResenas(itemId);
          anunciar('Rese√±a publicada');
        } catch (error) {
          alert('Ocurri√≥ un error al publicar la rese√±a. Intenta nuevamente.');
          console.error(error);
        }
      });
    };

    const obtenerResenasLocal = (itemId) => {
      const rese√±asLocal = JSON.parse(localStorage.getItem('turismo_sm_resenas') || '[]');
      if (!itemId) return rese√±asLocal;
      return rese√±asLocal.filter((resena) => resena.itemId === itemId);
    };

    const cargarResenas = async (itemId) => {
      const contenedor = qs(`[data-resenas="${itemId}"]`);
      if (!contenedor) return;
      contenedor.innerHTML = '<p>Cargando rese√±as...</p>';
      let rese√±as = [];
      try {
        if (db) {
          const ref = collection(db, 'rese√±as');
          const consulta = query(ref, where('itemId', '==', itemId), orderBy('fechaCreacion', 'desc'));
          const snapshot = await getDocs(consulta);
          rese√±as = snapshot.docs.map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }));
        } else {
          rese√±as = obtenerResenasLocal(itemId);
        }
      } catch (error) {
        console.error('Error al cargar rese√±as', error);
      }

      if (!rese√±as.length) {
        contenedor.innerHTML = '<p>No hay rese√±as a√∫n. ¬°S√© la primera persona en opinar!</p>';
        return;
      }

      contenedor.innerHTML = '';
      rese√±as.forEach((resena) => {
        const tarjeta = document.createElement('article');
        tarjeta.className = 'rese√±a';
        const esAutor = estado.usuario && (resena.usuario === estado.usuario.uid);
        const fecha = resena.fechaCreacion?.toDate ? resena.fechaCreacion.toDate() : new Date(resena.fechaCreacion);
        tarjeta.innerHTML = `
          <div class="rese√±a-header">
            <div>
              <strong>${resena.autor}</strong>
              <p style="margin:0;font-size:0.85rem;color:var(--color-texto-suave);">${formatearFecha(fecha)}</p>
            </div>
            <div class="estrellas">${'‚òÖ'.repeat(resena.rating || 0)}</div>
          </div>
          <h4 style="margin:0.5rem 0;">${resena.titulo}</h4>
          <p>${resena.texto}</p>
          ${resena.emocion ? `<span class="tarjeta-tag">${resena.emocion}</span>` : ''}
          ${esAutor ? `<div class="rese√±a-acciones"><button data-editar="${resena.id}">Editar</button><button data-borrar="${resena.id}">Eliminar</button></div>` : ''}
        `;
        if (esAutor) {
          qs('[data-borrar]', tarjeta)?.addEventListener('click', () => eliminarResena(resena.id, itemId));
          qs('[data-editar]', tarjeta)?.addEventListener('click', () => editarResena(resena, itemId));
        }
        contenedor.appendChild(tarjeta);
      });
    };

    const eliminarResena = async (idResena, itemId) => {
      if (!confirm('¬øDeseas eliminar esta rese√±a?')) return;
      try {
        if (db) {
          await deleteDoc(doc(db, 'rese√±as', idResena));
        } else {
          const rese√±asLocal = JSON.parse(localStorage.getItem('turismo_sm_resenas') || '[]');
          const filtradas = rese√±asLocal.filter((resena) => resena.id !== idResena);
          localStorage.setItem('turismo_sm_resenas', JSON.stringify(filtradas));
        }
        cargarResenas(itemId);
        anunciar('Rese√±a eliminada');
      } catch (error) {
        console.error('No se pudo eliminar rese√±a', error);
        alert('No fue posible eliminar la rese√±a.');
      }
    };

    const editarResena = async (resena, itemId) => {
      const nuevoTexto = prompt('Edita tu rese√±a:', resena.texto);
      if (nuevoTexto === null) return;
      const limpio = sanitizarTexto(nuevoTexto);
      try {
        if (db) {
          await updateDoc(doc(db, 'rese√±as', resena.id), {
            texto: limpio,
            fechaEdicion: serverTimestamp()
          });
        } else {
          const rese√±asLocal = JSON.parse(localStorage.getItem('turismo_sm_resenas') || '[]');
          const actualizadas = rese√±asLocal.map((r) => r.id === resena.id ? { ...r, texto: limpio, fechaEdicion: new Date().toISOString() } : r);
          localStorage.setItem('turismo_sm_resenas', JSON.stringify(actualizadas));
        }
        cargarResenas(itemId);
        anunciar('Rese√±a editada');
      } catch (error) {
        console.error('No se pudo editar rese√±a', error);
      }
    };

    const mostrarSeccion = (seccion) => {
      estado.seccionActual = seccion;
      if (seccion === 'inicio') {
        seccionContenido.innerHTML = '<div class="sin-datos">Utiliza el men√∫ para explorar las secciones.</div>';
        return;
      }
      let items = [];
      if (seccion === 'lugares') items = filtrarItems(estado.datos.lugares);
      if (seccion === 'restaurantes') items = filtrarItems(estado.datos.restaurantes);
      if (seccion === 'ocio') items = filtrarItems(estado.datos.ocio);
      if (['lugares', 'restaurantes', 'ocio'].includes(seccion)) {
        renderizarLista(items, seccion);
        return;
      }
      if (seccion === 'historia') {
        renderizarHistoria();
        return;
      }
      if (seccion === 'eventos') {
        renderizarEventos();
        return;
      }
      if (seccion === 'ajustes') {
        renderizarAjustes();
        return;
      }
      if (seccion === 'perfil') {
        renderizarPerfil();
        return;
      }
    };

    const renderizarAjustes = () => {
      seccionContenido.innerHTML = '';
      const panel = document.createElement('section');
      panel.className = 'ajustes-panel';
      panel.innerHTML = `
        <article class="ajuste-card">
          <h3>Temas y modo oscuro</h3>
          <label class="toggle"><input type="checkbox" id="toggleOscuro"> Activar modo oscuro</label>
        </article>
        <article class="ajuste-card">
          <h3>Modo tercera edad</h3>
          <p>Incrementa fuentes, contrastes y √°reas t√°ctiles seg√∫n recomendaciones de usabilidad para adultos mayores.</p>
          <label class="toggle"><input type="checkbox" id="toggleSenior"> Activar modo tercera edad</label>
        </article>
        <article class="ajuste-card">
          <h3>Modo dislexia</h3>
          <p>Aplica tipograf√≠a OpenDyslexic, mayor interlineado y espaciado entre palabras.</p>
          <label class="toggle"><input type="checkbox" id="toggleDislexia"> Activar modo dislexia</label>
        </article>
        <article class="ajuste-card">
          <h3>Modo visibilidad reducida</h3>
          <p>Activa narraci√≥n por voz, alto contraste y comandos mediante voz.</p>
          <label class="toggle"><input type="checkbox" id="toggleVisibilidad"> Activar modo visibilidad reducida</label>
        </article>
      `;
      seccionContenido.appendChild(panel);

      qs('#toggleOscuro').checked = estado.modoOscuro;
      qs('#toggleSenior').checked = estado.modoSenior;
      qs('#toggleDislexia').checked = estado.modoDislexia;
      qs('#toggleVisibilidad').checked = estado.modoVisibilidad;

      panel.addEventListener('change', (evento) => {
        const { id, checked } = evento.target;
        if (id === 'toggleOscuro') estado.modoOscuro = checked;
        if (id === 'toggleSenior') estado.modoSenior = checked;
        if (id === 'toggleDislexia') estado.modoDislexia = checked;
        if (id === 'toggleVisibilidad') estado.modoVisibilidad = checked;
        aplicarClasesAccesibilidad();
        if (analytics) logEvent(analytics, 'cambiar_accesibilidad', { id, checked });
      });
    };

    const renderizarPerfil = () => {
      seccionContenido.innerHTML = '';
      const contenedor = document.createElement('section');
      contenedor.className = 'perfil';
      contenedor.innerHTML = `
        <header>
          <h2>Mi cuenta</h2>
          <p>${estado.usuario ? `Conectado como <strong>${estado.usuario.displayName || estado.usuario.email}</strong>` : 'Inicia sesi√≥n para guardar favoritos y rese√±as.'}</p>
          <div class="tarjeta-acciones">
            ${estado.usuario ? '' : '<button class="btn-primario" id="btnLoginGoogle">Ingresar con Google</button>'}
            ${estado.usuario ? '' : '<button class="btn-secundario" id="btnLoginFacebook">Ingresar con Facebook</button>'}
            ${estado.usuario ? '<button class="btn-secundario" id="btnLogout">Cerrar sesi√≥n</button>' : ''}
            ${estado.usuario ? '<button class="btn-secundario" id="btnEliminarCuenta">Eliminar cuenta</button>' : ''}
          </div>
        </header>
        <section class="ajuste-card">
          <h3>Mis favoritos</h3>
          <div class="favoritos-grid" id="listaFavoritos"></div>
        </section>
        <section class="ajuste-card">
          <h3>Mis rese√±as</h3>
          <div id="listaResenasUsuario"></div>
        </section>
      `;
      seccionContenido.appendChild(contenedor);

      if (!estado.usuario) {
        return;
      }

      qs('#btnLogout')?.addEventListener('click', async () => {
        await signOut(auth);
      });

      qs('#btnEliminarCuenta')?.addEventListener('click', async () => {
        const confirmacion = prompt('Escribe ELIMINAR para confirmar la eliminaci√≥n de tu cuenta');
        if (confirmacion !== 'ELIMINAR') return;
        try {
          await deleteUser(auth.currentUser);
          alert('Tu cuenta ha sido eliminada.');
        } catch (error) {
          if (error.code === 'auth/requires-recent-login') {
            alert('Por seguridad, vuelve a iniciar sesi√≥n antes de eliminar tu cuenta.');
          } else {
            alert('No fue posible eliminar la cuenta.');
          }
        }
      });

      const favoritos = Array.from(estado.datos.favoritos).map((clave) => {
        const [tipo, id] = clave.split(':');
        const coleccion = estado.datos[tipo];
        return coleccion?.find((item) => item.id === id);
      }).filter(Boolean);

      const listaFavoritos = qs('#listaFavoritos');
      if (!favoritos.length) {
        listaFavoritos.innerHTML = '<p>No has guardado favoritos todav√≠a.</p>';
      } else {
        favoritos.forEach((item) => {
          const card = document.createElement('article');
          card.className = 'rese√±a';
          card.innerHTML = `
            <strong>${item.nombre}</strong>
            <p>${item.descripcion}</p>
          `;
          listaFavoritos.appendChild(card);
        });
      }

      const listadoResenas = qs('#listaResenasUsuario');
      listadoResenas.innerHTML = '<p>Cargando rese√±as...</p>';
      if (!db) {
        const rese√±as = obtenerResenasLocal().filter((r) => r.usuario === estado.usuario.uid);
        renderizarResenasUsuario(rese√±as, listadoResenas);
      } else {
        (async () => {
          const ref = collection(db, 'rese√±as');
          const consulta = query(ref, where('usuario', '==', estado.usuario.uid), orderBy('fechaCreacion', 'desc'));
          const snapshot = await getDocs(consulta);
          const rese√±as = snapshot.docs.map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }));
          renderizarResenasUsuario(rese√±as, listadoResenas);
        })();
      }
    };

    const renderizarResenasUsuario = (rese√±as, contenedor) => {
      if (!rese√±as.length) {
        contenedor.innerHTML = '<p>No has publicado rese√±as todav√≠a.</p>';
        return;
      }
      contenedor.innerHTML = '';
      rese√±as.forEach((resena) => {
        const card = document.createElement('article');
        card.className = 'rese√±a';
        const fecha = resena.fechaCreacion?.toDate ? resena.fechaCreacion.toDate() : new Date(resena.fechaCreacion);
        card.innerHTML = `
          <h4>${resena.titulo}</h4>
          <p>${resena.texto}</p>
          <small>${formatearFecha(fecha)}</small>
        `;
        contenedor.appendChild(card);
      });
    };

    const inicializarClima = async () => {
      const resumen = qs('#climaResumen');
      const detalle = qs('#climaDetalle');
      const apiKey = window.OPENWEATHER_KEY;
      if (!apiKey) {
        resumen.textContent = 'Configura la API de clima para ver datos en vivo.';
        detalle.textContent = '';
        return;
      }
      try {
        const url = `https://api.openweathermap.org/data/2.5/weather?lat=40.205&lon=-3.567&units=metric&lang=es&appid=${apiKey}`;
        const respuesta = await fetch(url);
        if (!respuesta.ok) throw new Error('Respuesta no v√°lida');
        const data = await respuesta.json();
        resumen.textContent = `${Math.round(data.main.temp)}¬∞C ¬∑ ${data.weather[0].description}`;
        detalle.textContent = `Sensaci√≥n: ${Math.round(data.main.feels_like)}¬∞C ¬∑ Humedad: ${data.main.humidity}%`;
      } catch (error) {
        resumen.textContent = 'No fue posible obtener el clima actual.';
        detalle.textContent = 'Revisa tu conexi√≥n e intenta de nuevo.';
      }
    };

    const inicializarSOS = () => {
      const btnSOS = qs('#btnSOS');
      const panel = qs('#sosPanel');
      const cerrar = qs('#btnCerrarSOS');
      btnSOS.addEventListener('click', () => {
        panel.classList.add('visible');
        btnSOS.setAttribute('aria-expanded', 'true');
        anunciar('Panel de emergencias abierto.');
      });
      cerrar.addEventListener('click', () => {
        panel.classList.remove('visible');
        btnSOS.setAttribute('aria-expanded', 'false');
      });
      panel.addEventListener('click', (evento) => {
        if (evento.target === panel) {
          panel.classList.remove('visible');
          btnSOS.setAttribute('aria-expanded', 'false');
        }
      });
    };

    const inicializarVoz = () => {
      const boton = qs('#btnVoz');
      let reconocimiento;
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        boton.style.display = 'none';
        return;
      }

      const crearReconocimiento = () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognizer = new SpeechRecognition();
        recognizer.lang = 'es-ES';
        recognizer.continuous = false;
        recognizer.interimResults = false;
        recognizer.onresult = (evento) => {
          const comando = evento.results[0][0].transcript.toLowerCase();
          procesarComandoVoz(comando);
        };
        recognizer.onend = () => {
          estado.reconocimientoActivo = false;
          boton.textContent = 'üéôÔ∏è';
        };
        recognizer.onerror = () => {
          estado.reconocimientoActivo = false;
          boton.textContent = 'üéôÔ∏è';
        };
        return recognizer;
      };

      boton.addEventListener('click', () => {
        if (estado.reconocimientoActivo) {
          reconocimiento?.stop();
          estado.reconocimientoActivo = false;
          boton.textContent = 'üéôÔ∏è';
          return;
        }
        reconocimiento = reconocimiento || crearReconocimiento();
        reconocimiento.start();
        estado.reconocimientoActivo = true;
        boton.textContent = '‚èπÔ∏è';
        anunciar('Escuchando comandos.');
      });
    };

    const procesarComandoVoz = (texto) => {
      if (texto.includes('lugares')) {
        actualizarMenuActivo('lugares');
        mostrarSeccion('lugares');
        return;
      }
      if (texto.includes('restaurante')) {
        actualizarMenuActivo('restaurantes');
        mostrarSeccion('restaurantes');
        return;
      }
      if (texto.includes('historia')) {
        actualizarMenuActivo('historia');
        mostrarSeccion('historia');
        return;
      }
      if (texto.includes('eventos') || texto.includes('calendario')) {
        actualizarMenuActivo('eventos');
        mostrarSeccion('eventos');
        return;
      }
      if (texto.includes('modo oscuro')) {
        estado.modoOscuro = !estado.modoOscuro;
        aplicarClasesAccesibilidad();
        anunciar(`Modo oscuro ${estado.modoOscuro ? 'activado' : 'desactivado'}`);
        return;
      }
      if (texto.startsWith('buscar')) {
        const termino = texto.replace('buscar', '').trim();
        estado.filtros.texto = termino.toLowerCase();
        mostrarSeccion(estado.seccionActual);
        anunciar(`Buscando ${termino}`);
        return;
      }
      anunciar('No entend√≠ el comando.');
    };

    const inicializarAuth = () => {
      if (!auth) return;
      const proveedorGoogle = new GoogleAuthProvider();
      const proveedorFacebook = new FacebookAuthProvider();

      const loginGoogle = async () => {
        try {
          if (window.innerWidth < 768) {
            await signInWithRedirect(auth, proveedorGoogle);
            return;
          }
          await signInWithPopup(auth, proveedorGoogle);
        } catch (error) {
          alert('No se pudo completar el inicio de sesi√≥n con Google.');
          console.error(error);
        }
      };

      const loginFacebook = async () => {
        try {
          if (window.innerWidth < 768) {
            await signInWithRedirect(auth, proveedorFacebook);
            return;
          }
          await signInWithPopup(auth, proveedorFacebook);
        } catch (error) {
          alert('No se pudo completar el inicio de sesi√≥n con Facebook.');
          console.error(error);
        }
      };

      const delegarBotones = () => {
        qsa('#btnLoginGoogle').forEach((btn) => btn.addEventListener('click', loginGoogle));
        qsa('#btnLoginFacebook').forEach((btn) => btn.addEventListener('click', loginFacebook));
      };

      onAuthStateChanged(auth, async (usuario) => {
        estado.usuario = usuario;
        if (usuario) {
          qs('#panelHero').querySelector('p').textContent = `Bienvenido, ${usuario.displayName || usuario.email}. Explora las experiencias personalizadas.`;
          if (analytics) logEvent(analytics, 'login_usuario');
        } else {
          qs('#panelHero').querySelector('p').textContent = 'Planifica tu visita, guarda tus lugares favoritos y vive experiencias √∫nicas en el coraz√≥n del valle del Jarama. Informaci√≥n siempre actualizada gracias a Firebase.';
        }
        if (estado.seccionActual === 'perfil') {
          renderizarPerfil();
        }
        delegarBotones();
      });

      getRedirectResult(auth).then(() => {}).catch((error) => console.error(error));
      delegarBotones();
    };

    const iniciarApp = async () => {
      cargarPreferencias();
      aplicarClasesAccesibilidad();
      await inicializarDatos();
      inicializarSOS();
      inicializarVoz();
      inicializarAuth();
      await inicializarClima();
      qs('#btnActualizarClima').addEventListener('click', inicializarClima);
      mostrarSeccion('inicio');
    };

    document.addEventListener('DOMContentLoaded', iniciarApp);
  </script>
</body>
</html>
